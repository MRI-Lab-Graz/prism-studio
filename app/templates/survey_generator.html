{% extends "base.html" %}

{% block title %}PRISM Studio - Survey & Boilerplate{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/survey-generator.css') }}">
{% endblock %}
{% block content %}
<div class="container">
    <div class="row mb-3">
        <div class="col-12">
            <h2><i class="fas fa-file-export text-info me-2"></i>Survey & Boilerplate</h2>
            <p class="text-muted mb-0">Select questionnaires from the library to export for a survey tool or generate a methods boilerplate.</p>
        </div>
    </div>

    {% include 'includes/project_banner.html' %}

    <!-- Source Info -->
    <div class="d-flex align-items-center mb-2">
        <i class="fas fa-book-open text-info me-1"></i>
        <span id="sourceInfoText" class="text-muted small">Loading...</span>
        <button class="btn btn-sm btn-link text-secondary p-0 ms-1" id="reloadLibraryBtn" title="Reload">
            <i class="fas fa-sync-alt"></i>
        </button>
    </div>

    <div id="libraryError" class="alert alert-danger d-none"></div>

    <!-- Toolbar: Target Tool + Language + Tool-specific settings -->
    <div id="toolbarCard" class="card mb-3 d-none">
        <div class="card-body py-2">
            <div class="row align-items-center g-2">
                <div class="col-auto">
                    <label class="form-label mb-0 small fw-bold">Target Tool</label>
                </div>
                <div class="col-auto">
                    <select class="form-select form-select-sm" id="targetToolSelect" style="width:auto;">
                        <option value="limesurvey">LimeSurvey</option>
                        <!-- Future: <option value="redcap">REDCap</option> -->
                        <!-- Future: <option value="qualtrics">Qualtrics</option> -->
                    </select>
                </div>
                <div class="col-auto border-start ps-2">
                    <label class="form-label mb-0 small fw-bold">Base Language</label>
                </div>
                <div class="col-auto">
                    <select class="form-select form-select-sm" id="baseLanguageSelect" style="width:auto;"></select>
                </div>
                <div class="col-auto">
                    <label class="form-label mb-0 small fw-bold ms-2">Export Languages</label>
                </div>
                <div class="col-auto" id="exportLanguageCheckboxes"></div>
                <!-- LimeSurvey-specific options -->
                <div class="col-auto ms-auto tool-options-limesurvey">
                    <label class="form-label mb-0 small fw-bold">LS Version</label>
                </div>
                <div class="col-auto tool-options-limesurvey">
                    <select class="form-select form-select-sm" id="lsVersionSelect" style="width:auto;">
                        <option value="6">5.x / 6.x</option>
                        <option value="3" selected>3.x / 4.x</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Language Warnings -->
    <div id="languageWarnings" class="alert alert-warning py-2 d-none">
        <i class="fas fa-exclamation-triangle me-1"></i><strong>Translation warnings:</strong>
        <ul id="languageWarningList" class="mb-0 mt-1 small"></ul>
    </div>

    <div id="libraryContent" class="d-none">
        <!-- Search bar above templates -->
        <div class="search-container mb-3">
            <i class="fas fa-search"></i>
            <input type="text" class="form-control" id="templateSearch"
                   placeholder="Search templates by name, description, or filename...">
        </div>

        <!-- Sections: Survey, Biometrics, Participants, Other -->
        <div id="surveySection" class="d-none mb-3">
            <div class="d-flex align-items-center mb-1">
                <h6 class="mb-0"><i class="fas fa-poll-h text-success me-1"></i>Survey Questionnaires <span class="section-count text-muted" id="surveyCount"></span></h6>
                <div class="ms-auto">
                    <button class="btn btn-sm btn-link text-secondary select-all-section p-0 me-2" data-target="surveyList">Select all</button>
                    <button class="btn btn-sm btn-link text-secondary deselect-all-section p-0" data-target="surveyList">Clear</button>
                </div>
            </div>
            <div id="surveyList" class="tpl-scroll-list"></div>
        </div>

        <div id="biometricsSection" class="d-none mb-3">
            <div class="d-flex align-items-center mb-1">
                <h6 class="mb-0"><i class="fas fa-heartbeat text-danger me-1"></i>Biometrics & Physio <span class="section-count text-muted" id="biometricsCount"></span></h6>
                <div class="ms-auto">
                    <button class="btn btn-sm btn-link text-secondary select-all-section p-0 me-2" data-target="biometricsList">Select all</button>
                    <button class="btn btn-sm btn-link text-secondary deselect-all-section p-0" data-target="biometricsList">Clear</button>
                </div>
            </div>
            <div id="biometricsList" class="tpl-scroll-list"></div>
        </div>

        <div id="participantsSection" class="d-none mb-3">
            <div class="d-flex align-items-center mb-1">
                <h6 class="mb-0"><i class="fas fa-users text-primary me-1"></i>Participants <span class="section-count text-muted" id="participantsCount"></span></h6>
            </div>
            <div id="participantsList" class="tpl-scroll-list"></div>
        </div>

        <div id="otherSection" class="d-none mb-3">
            <div class="d-flex align-items-center mb-1">
                <h6 class="mb-0"><i class="fas fa-file-alt text-secondary me-1"></i>Other Templates <span class="section-count text-muted" id="otherCount"></span></h6>
                <div class="ms-auto">
                    <button class="btn btn-sm btn-link text-secondary select-all-section p-0 me-2" data-target="otherList">Select all</button>
                    <button class="btn btn-sm btn-link text-secondary deselect-all-section p-0" data-target="otherList">Clear</button>
                </div>
            </div>
            <div id="otherList" class="tpl-scroll-list"></div>
        </div>

        <div class="d-flex justify-content-end mb-5 gap-2">
            <button class="btn btn-outline-info" id="generateBoilerplateBtn" disabled>
                <i class="fas fa-file-alt me-1"></i>Boilerplate
            </button>
            <button class="btn btn-outline-secondary" id="generateLssBtn" disabled>
                <i class="fas fa-file-export me-1"></i>Quick Export (.lss)
            </button>
            <button class="btn btn-info text-white" id="customizeExportBtn" disabled>
                <i class="fas fa-sliders-h me-1"></i>Customize & Export
            </button>
        </div>
    </div>

    <div id="libraryEmpty" class="text-center py-5 d-none">
        <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
        <p class="text-muted">No JSON files found in the library.</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/survey-generator.js') }}"></script>
{% endblock %}
