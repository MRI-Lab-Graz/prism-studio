{% extends "base.html" %}

{% block title %}PRISM Studio - Survey Customizer{% endblock %}

{% block styles %}
{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/survey-customizer.css') }}">
{% endblock %}
{% block content %}
<div class="container-fluid px-4">
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <div>
                <h2><i class="fas fa-sliders-h text-info me-2"></i>Survey Customizer</h2>
                <p class="text-muted mb-0">Organize questions, create groups, set mandatory fields, then export.</p>
            </div>
            <a href="{{ url_for('tools.survey_generator') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Library
            </a>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay d-none">
        <div class="text-center">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-muted">Loading survey data...</p>
        </div>
    </div>

    <!-- No Data Warning -->
    <div id="noDataWarning" class="alert alert-warning d-none">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <strong>No survey data found.</strong> Please go back to the Survey & Boilerplate page and select questionnaires first.
        <a href="{{ url_for('tools.survey_generator') }}" class="alert-link ms-2">Go to Survey Library</a>
    </div>

    <!-- Main Customizer Layout -->
    <div id="customizerMain" class="d-none">
        <div class="customizer-container">
            <!-- Groups Panel (Left) -->
            <div class="groups-panel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="fas fa-layer-group me-2"></i>Groups</h5>
                    <button class="btn btn-sm btn-outline-primary" id="addGroupBtn" title="Add new group">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <div id="groupsList" class="groups-list">
                    <!-- Groups will be rendered here -->
                </div>
                <small class="text-muted d-block mt-2">
                    <i class="fas fa-info-circle me-1"></i>Drag to reorder groups
                </small>
            </div>

            <!-- Questions Panel (Right) -->
            <div class="questions-panel">
                <div id="previewLangSwitcher" class="mb-2 d-none"></div>
                <div id="questionsContainer">
                    <!-- Question groups will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Export Settings -->
        <div class="export-settings">
            <h5 class="mb-3"><i class="fas fa-cog me-2"></i>Export Settings</h5>
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="export-option">
                        <label class="form-label fw-bold">Survey Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="surveyName" placeholder="Enter survey name" required>
                        <small class="text-muted">This name will appear as the survey title in LimeSurvey</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="export-option">
                        <label class="form-label fw-bold">Target Tool</label>
                        <select class="form-select" id="targetTool">
                            <option value="limesurvey" selected>LimeSurvey</option>
                            <!-- Future: <option value="redcap">REDCap</option> -->
                            <!-- Future: <option value="qualtrics">Qualtrics</option> -->
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="export-option">
                        <label class="form-label fw-bold">Languages</label>
                        <div id="exportLanguageTags" class="mt-1">
                            <span class="lang-tag base">EN</span>
                        </div>
                        <small class="text-muted">Set from Survey Generator</small>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-4">
                    <div class="export-option">
                        <label class="form-label">Export Format</label>
                        <select class="form-select" id="exportFormat">
                            <option value="limesurvey" selected>LimeSurvey (.lss)</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="export-option">
                        <label class="form-label">LimeSurvey Version
                            <a href="#" data-bs-toggle="tooltip" data-bs-placement="top"
                               title="Check your version in LimeSurvey: Admin → Settings → Overview (bottom of page)">
                                <i class="bi bi-question-circle text-muted"></i>
                            </a>
                        </label>
                        <select class="form-select" id="lsVersionSelect">
                            <option value="6">LimeSurvey 5.x / 6.x (v5.0+)</option>
                            <option value="3" selected>LimeSurvey 3.x / 4.x (v3.0 - v4.x)</option>
                        </select>
                        <small class="text-muted">Select the version matching your LimeSurvey installation</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="export-option">
                        <label class="form-label">Base Language</label>
                        <select class="form-select" id="languageSelect">
                            <option value="en" selected>English</option>
                            <option value="de">German</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-6">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="matrixMode" checked>
                        <label class="form-check-label" for="matrixMode">
                            Group questions with identical options into matrices
                        </label>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="globalMatrix" checked>
                        <label class="form-check-label" for="globalMatrix">
                            Global matrix grouping (all identical options, not just consecutive)
                        </label>
                    </div>
                </div>
            </div>
            <div class="row mt-2" id="saveToProjectRow" style="display:none;">
                <div class="col-md-12">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="saveToProject">
                        <label class="form-check-label" for="saveToProject">
                            Save templates to project library
                            <small class="text-muted ms-1">
                                (copies PRISM templates to <code>code/library/survey/</code>)
                            </small>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- LimeSurvey Survey Settings -->
        <div class="ls-settings-section" id="lsSettingsSection">
            <div class="accordion" id="lsSettingsAccordion">
                <!-- Header -->
                <h5 class="mb-2 mt-3">
                    <i class="fas fa-cogs text-info me-2"></i>LimeSurvey Survey Settings
                    <small class="text-muted fw-normal ms-2">(optional)</small>
                </h5>

                <!-- Section 1: Text & Messages -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="lsTextHeading">
                        <button class="accordion-button collapsed" type="button"
                                data-bs-toggle="collapse" data-bs-target="#lsTextCollapse"
                                aria-expanded="false" aria-controls="lsTextCollapse">
                            <i class="fas fa-comment-alt me-2 text-muted"></i>Text &amp; Messages
                        </button>
                    </h2>
                    <div id="lsTextCollapse" class="accordion-collapse collapse"
                         aria-labelledby="lsTextHeading" data-bs-parent="#lsSettingsAccordion">
                        <div class="accordion-body">
                            <div class="row mb-3">
                                <div class="col-md-9">
                                    <label class="form-label">Welcome Message <span class="html-hint">(HTML)</span></label>
                                    <textarea class="form-control" id="lsWelcomeText" rows="3"
                                              placeholder="Shown on the first page before questions begin"></textarea>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Template</label>
                                    <select class="form-select" id="lsWelcomeTemplate">
                                        <option value="">Empty</option>
                                        <option value="standard">Standard Welcome</option>
                                        <option value="academic">Academic Study</option>
                                        <option value="brief">Brief Welcome</option>
                                    </select>
                                    <div class="form-text">Populates the textarea</div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-9">
                                    <label class="form-label">End Message <span class="html-hint">(HTML)</span></label>
                                    <textarea class="form-control" id="lsEndText" rows="3"
                                              placeholder="Shown after the last question is submitted"></textarea>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Template</label>
                                    <select class="form-select" id="lsEndTemplate">
                                        <option value="">Empty</option>
                                        <option value="standard">Standard Thank-You</option>
                                        <option value="academic">Academic Debrief</option>
                                        <option value="brief">Brief Thank-You</option>
                                        <option value="redirect">Redirect Notice</option>
                                    </select>
                                    <div class="form-text">Populates the textarea</div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">End URL</label>
                                    <input type="text" class="form-control" id="lsEndUrl"
                                           placeholder="https://example.com/thank-you">
                                    <div class="form-text">Redirect participants after completion</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">End URL Description</label>
                                    <input type="text" class="form-control" id="lsEndUrlDescription"
                                           placeholder="Click here to return to the study page">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 2: Data Policy / Ethics -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="lsPolicyHeading">
                        <button class="accordion-button collapsed" type="button"
                                data-bs-toggle="collapse" data-bs-target="#lsPolicyCollapse"
                                aria-expanded="false" aria-controls="lsPolicyCollapse">
                            <i class="fas fa-shield-alt me-2 text-muted"></i>Data Policy / Ethics
                        </button>
                    </h2>
                    <div id="lsPolicyCollapse" class="accordion-collapse collapse"
                         aria-labelledby="lsPolicyHeading" data-bs-parent="#lsSettingsAccordion">
                        <div class="accordion-body">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label">Enable Data Policy</label>
                                    <select class="form-select" id="lsShowDataPolicy">
                                        <option value="0" selected>Off</option>
                                        <option value="1">Show with checkbox</option>
                                        <option value="2">Show inline (no checkbox)</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Template</label>
                                    <select class="form-select" id="lsConsentTemplate">
                                        <option value="">Empty</option>
                                        <option value="standard">Standard Ethics Consent</option>
                                        <option value="gdpr">GDPR Data Protection</option>
                                        <option value="anonymous">Anonymous Survey</option>
                                        <option value="longitudinal">Longitudinal Study</option>
                                        <option value="minimal">Minimal Consent</option>
                                    </select>
                                    <div class="form-text">Populates the Policy Notice below</div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Policy Checkbox Label</label>
                                    <input type="text" class="form-control" id="lsPolicyCheckboxLabel"
                                           placeholder="I have read and agree to the data policy">
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-12">
                                    <label class="form-label">Policy Notice <span class="html-hint">(HTML)</span></label>
                                    <textarea class="form-control" id="lsPolicyNotice" rows="4"
                                              placeholder="Your data policy / ethics consent text"></textarea>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-12">
                                    <label class="form-label">Policy Error Message <span class="html-hint">(HTML)</span></label>
                                    <textarea class="form-control" id="lsPolicyError" rows="2"
                                              placeholder="Shown if participant does not agree (leave empty for default)"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 3: Presentation & Navigation -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="lsPresentationHeading">
                        <button class="accordion-button collapsed" type="button"
                                data-bs-toggle="collapse" data-bs-target="#lsPresentationCollapse"
                                aria-expanded="false" aria-controls="lsPresentationCollapse">
                            <i class="fas fa-tv me-2 text-muted"></i>Presentation &amp; Navigation
                        </button>
                    </h2>
                    <div id="lsPresentationCollapse" class="accordion-collapse collapse"
                         aria-labelledby="lsPresentationHeading" data-bs-parent="#lsSettingsAccordion">
                        <div class="accordion-body">
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <label class="form-label">Show Welcome Screen</label>
                                    <select class="form-select" id="lsShowWelcome">
                                        <option value="Y" selected>Yes</option>
                                        <option value="N">No</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Show Progress Bar</label>
                                    <select class="form-select" id="lsShowProgress">
                                        <option value="Y" selected>Yes</option>
                                        <option value="N">No</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Allow Backward Nav</label>
                                    <select class="form-select" id="lsAllowPrev">
                                        <option value="N" selected>No</option>
                                        <option value="Y">Yes</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Navigation Delay (s)</label>
                                    <input type="number" class="form-control" id="lsNavigationDelay"
                                           value="0" min="0" max="60">
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <label class="form-label">Question Index</label>
                                    <select class="form-select" id="lsQuestionIndex">
                                        <option value="0" selected>Disabled</option>
                                        <option value="1">Incremental</option>
                                        <option value="2">Full</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Show Group Info</label>
                                    <select class="form-select" id="lsShowGroupInfo">
                                        <option value="B" selected>Name &amp; Description</option>
                                        <option value="N">Name only</option>
                                        <option value="D">Description only</option>
                                        <option value="X">Hide</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Show Q Number/Code</label>
                                    <select class="form-select" id="lsShowQnumCode">
                                        <option value="X" selected>Hide</option>
                                        <option value="B">Both</option>
                                        <option value="N">Number</option>
                                        <option value="C">Code</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Show "No Answer"</label>
                                    <select class="form-select" id="lsShowNoAnswer">
                                        <option value="Y" selected>Yes</option>
                                        <option value="N">No</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <label class="form-label">Show Question Count</label>
                                    <select class="form-select" id="lsShowXQuestions">
                                        <option value="Y" selected>Yes</option>
                                        <option value="N">No</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">On-Screen Keyboard</label>
                                    <select class="form-select" id="lsNoKeyboard">
                                        <option value="N" selected>No</option>
                                        <option value="Y">Yes</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Print Answers</label>
                                    <select class="form-select" id="lsPrintAnswers">
                                        <option value="N" selected>No</option>
                                        <option value="Y">Yes</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Auto-load End URL</label>
                                    <select class="form-select" id="lsAutoRedirect">
                                        <option value="N" selected>No</option>
                                        <option value="Y">Yes</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <label class="form-label">Public Statistics</label>
                                    <select class="form-select" id="lsPublicStatistics">
                                        <option value="N" selected>No</option>
                                        <option value="Y">Yes</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Public Graphs</label>
                                    <select class="form-select" id="lsPublicGraphs">
                                        <option value="N" selected>No</option>
                                        <option value="Y">Yes</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Bar -->
        <div class="d-flex justify-content-end gap-2 mt-4 mb-5">
            <button class="btn btn-outline-secondary" id="resetBtn">
                <i class="fas fa-undo me-2"></i>Reset Changes
            </button>
            <button class="btn btn-info btn-lg text-white" id="exportBtn">
                <i class="fas fa-file-export me-2"></i>Export Survey
            </button>
        </div>
    </div>
</div>

<!-- Add Group Modal -->
<div class="modal fade" id="addGroupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Group</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Group Name</label>
                    <input type="text" class="form-control" id="newGroupName" placeholder="e.g., Demographics">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmAddGroup">Add Group</button>
            </div>
        </div>
    </div>
</div>

<!-- Rename Group Modal -->
<div class="modal fade" id="renameGroupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Rename Group</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Group Name</label>
                    <input type="text" class="form-control" id="renameGroupName">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmRenameGroup">Rename</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/survey-customizer.js') }}"></script>
{% endblock %}
