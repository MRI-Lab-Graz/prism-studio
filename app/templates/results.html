{% extends "base.html" %}

{% block title %}Validation Results - {{ filename }}{% endblock %}

{% block styles %}
<style>
    .status-badge {
        font-size: 1rem;
        padding: 0.5rem 1.5rem;
        border-radius: 50px;
    }
    .summary-card {
        transition: all 0.3s ease;
    }
    .summary-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
    }
    .error-group-header {
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .error-group-header:hover {
        background-color: #fff5f5;
    }
    .file-path {
        font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
        font-size: 0.85rem;
    }
    .modality-icon {
        width: 24px;
        text-align: center;
    }
    .progress-thin {
        height: 6px;
    }
    .bg-danger-soft {
        background-color: rgba(220, 53, 69, 0.1);
    }
    .bg-success-soft {
        background-color: rgba(25, 135, 84, 0.1);
    }
    .bg-warning-soft {
        background-color: rgba(255, 193, 7, 0.1);
    }
    .bg-info-soft {
        background-color: rgba(13, 202, 240, 0.1);
    }
    .x-small {
        font-size: 0.75rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-12">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2>
                    <i class="fas fa-chart-line text-primary me-2"></i>
                    Validation Results
                </h2>
                <p class="text-muted mb-0">
                    <i class="fas fa-folder me-1"></i>{{ results.dataset_name if results and results.dataset_name else filename }}
                </p>
                {% if results and results.get('schema_version') %}
                <p class="text-muted mb-0">
                    <i class="fas fa-code-branch me-1"></i>Schema Version: <strong>{{ results.schema_version }}</strong>
                </p>
                {% endif %}
            </div>
            <div>
                <a href="{{ url_for('validation.download_report', result_id=result_id) }}" class="btn btn-outline-primary me-2">
                    <i class="fas fa-download me-2"></i>Download Report
                </a>
                <a href="{{ url_for('validation.cleanup', result_id=result_id) }}" class="btn btn-outline-secondary me-2">
                    <i class="fas fa-trash me-2"></i>Cleanup
                </a>
                <a href="{{ url_for('validation.validate_dataset') }}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Validate Another
                </a>
            </div>
        </div>

        <!-- Summary Dashboard -->
        <div class="card mb-4 border-0 shadow-sm overflow-hidden">
            <div class="card-body p-0">
                <div class="row g-0 text-center">
                    <div class="col-6 col-md-3 border-end py-4 summary-card">
                        <div class="text-muted small text-uppercase fw-bold mb-1">Total Files</div>
                        <div class="h2 mb-0 fw-bold">{{ results.summary.total_files if results.summary else total_files }}</div>
                    </div>
                    <div class="col-6 col-md-3 border-end py-4 summary-card">
                        <div class="text-muted small text-uppercase fw-bold mb-1">Valid</div>
                        <div class="h2 mb-0 fw-bold text-success">{{ results.summary.valid_files if results.summary else valid_files }}</div>
                    </div>
                    <div class="col-6 col-md-3 border-end py-4 summary-card">
                        <div class="text-muted small text-uppercase fw-bold mb-1">Errors</div>
                        <div class="h2 mb-0 fw-bold text-danger">{{ results.summary.total_errors if results.summary else results.errors|length }}</div>
                    </div>
                    <div class="col-6 col-md-3 py-4 summary-card">
                        <div class="text-muted small text-uppercase fw-bold mb-1">Warnings</div>
                        <div class="h2 mb-0 fw-bold text-warning">{{ results.summary.total_warnings if results.summary else results.warnings|length }}</div>
                    </div>
                </div>
                {% if results.summary %}
                {% set pass_rate = (results.summary.valid_files / results.summary.total_files * 100)|round(1) if results.summary.total_files > 0 else 0 %}
                <div class="progress rounded-0 progress-thin">
                    <div class="progress-bar bg-success" role="progressbar" style="width: {{ pass_rate }}%" aria-valuenow="{{ pass_rate }}" aria-valuemin="0" aria-valuemax="100"></div>
                    <div class="progress-bar bg-danger" role="progressbar" style="width: {{ 100 - pass_rate }}%" aria-valuenow="{{ 100 - pass_rate }}" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="row">
            <!-- Left Column: Issues and Details -->
            <div class="col-lg-8">
                <!-- Overall Status -->
                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                {% if results.summary and results.summary.total_errors == 0 %}
                                    <div class="bg-success text-white rounded-circle p-3 me-3">
                                        <i class="fas fa-check fa-lg"></i>
                                    </div>
                                    <div>
                                        <h4 class="mb-1 fw-bold text-success">Dataset is Valid!</h4>
                                        <p class="text-muted mb-0">Passed all PRISM validation checks.</p>
                                    </div>
                                {% else %}
                                    <div class="bg-danger text-white rounded-circle p-3 me-3">
                                        <i class="fas fa-times fa-lg"></i>
                                    </div>
                                    <div>
                                        {% set error_count = results.summary.total_errors if results.summary else results.errors|length %}
                                        <h4 class="mb-1 fw-bold text-danger">Dataset has {{ error_count }} Error(s)</h4>
                                        <p class="text-muted mb-0">Compliance issues were found that need attention.</p>
                                    </div>
                                {% endif %}
                            </div>
                            <div>
                                {% if results.summary and results.summary.total_errors == 0 %}
                                    <span class="badge bg-success status-badge">VALID</span>
                                {% else %}
                                    <span class="badge bg-danger status-badge">INVALID</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

        <!-- Errors Section -->
        {% if results.error_groups %}
        <div class="card mb-4 border-0 shadow-sm">
            <div class="card-header bg-danger text-white py-3">
                <h5 class="mb-0 fw-bold">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Errors ({{ results.summary.total_errors if results.summary else results.errors|length }})
                </h5>
            </div>
            <div class="card-body p-0">
                {% for error_code, error_group in results.error_groups.items() %}
                <div class="border-bottom p-4">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="{% if error_code.startswith('BIDS') %}text-info{% else %}text-danger{% endif %} fw-bold mb-0">
                            {% if error_code.startswith('BIDS') %}
                            <i class="fas fa-brain me-2"></i>
                            <span class="badge bg-info me-2">BIDS</span>
                            {% else %}
                            <i class="fas fa-gem me-2"></i>
                            <span class="badge bg-danger me-2">PRISM</span>
                            {% endif %}
                            {{ error_code }}
                        </h6>
                        <span class="badge {% if error_code.startswith('BIDS') %}bg-info-soft text-info border-info{% else %}bg-danger-soft text-danger border-danger{% endif %} border">{{ error_group.count }} occurrences</span>
                    </div>
                    <p class="text-muted small mb-3">{{ error_group.description }}</p>

                    {% if error_group.fix_hint %}
                    <div class="alert alert-info py-2 px-3 small border-0 mb-3">
                        <i class="fas fa-lightbulb me-2 text-warning"></i>
                        <strong>Fix Hint:</strong> {{ error_group.fix_hint }}
                    </div>
                    {% endif %}
                    
                    <div class="bg-light rounded p-3">
                        {% if error_group.messages %}
                            {% for message, files in error_group.messages.items() %}
                            <div class="mb-3 {% if not loop.last %}border-bottom pb-2{% endif %}">
                                <div class="small fw-bold mb-2 text-dark">
                                    <i class="fas fa-exclamation-triangle {% if error_code.startswith('BIDS') %}text-info{% else %}text-danger{% endif %} me-1"></i>
                                    {{ message }}
                                </div>
                                <div class="ms-3 ps-2 border-start border-2">
                                    {% for file in files[:10] %}
                                    <div class="d-flex align-items-center mb-1">
                                        <i class="fas fa-file text-muted me-2 x-small"></i>
                                        <span class="file-path x-small text-break">{{ file if file else 'General' }}</span>
                                    </div>
                                    {% endfor %}
                                    
                                    {% if files|length > 10 %}
                                    <div class="text-muted x-small mt-1">
                                        <i class="fas fa-ellipsis-h me-1"></i>
                                        and {{ files|length - 10 }} more files with this issue
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            {% set shown_files = error_group.files[:5] %}
                            {% set remaining_count = error_group.count - shown_files|length %}
                            
                            {% for error in shown_files %}
                            <div class="mb-2 pb-2 {% if not loop.last or remaining_count > 0 %}border-bottom{% endif %}">
                                <div class="d-flex justify-content-between">
                                    <div class="file-path text-break fw-bold">{{ get_filename_from_path(error.file) }}</div>
                                    <span class="badge bg-white text-danger border small">{{ error.level }}</span>
                                </div>
                                <div class="text-muted x-small file-path mb-1">{{ shorten_path(error.file, 3) }}</div>
                                <div class="small mt-1">{{ error.message }}</div>
                            </div>
                            {% endfor %}
                            
                            {% if remaining_count > 0 %}
                            <div class="text-center mt-2">
                                <small class="text-muted">
                                    <i class="fas fa-ellipsis-h me-1"></i>
                                    and {{ remaining_count }} more files
                                </small>
                            </div>
                            {% endif %}
                        {% endif %}
                    </div>
                    
                    <div class="mt-3">
                        <a href="{{ get_error_documentation_url(error_code) }}" target="_blank" class="btn btn-sm btn-link text-decoration-none p-0">
                            <i class="fas fa-question-circle me-1"></i>
                            Documentation for {{ error_code }} <i class="fas fa-external-link-alt ms-1 small"></i>
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% elif results.errors %}
        <div class="card mb-4 border-0 shadow-sm">
            <div class="card-header bg-danger text-white py-3">
                <h5 class="mb-0 fw-bold">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Errors ({{ results.errors|length }})
                </h5>
            </div>
            <div class="card-body">
                {% for error in results.errors %}
                <div class="error-item mb-3 p-3 bg-light rounded border-start border-danger border-4">
                    <div class="fw-bold file-path mb-1">{{ error.file if error.file else 'General' }}</div>
                    <div class="small">{{ error.message if error.message else error }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Warnings Section -->
        {% if results.warning_groups %}
        <div class="card mb-4 border-0 shadow-sm">
            <div class="card-header bg-warning text-dark py-3">
                <h5 class="mb-0 fw-bold">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Warnings ({{ results.warnings|length }})
                </h5>
            </div>
            <div class="card-body p-0">
                {% for warning_code, warning_group in results.warning_groups.items() %}
                <div class="border-bottom p-4">
                    <h6 class="{% if warning_code.startswith('BIDS') %}text-info{% else %}text-warning{% endif %} fw-bold mb-3">
                        {% if warning_code.startswith('BIDS') %}
                        <i class="fas fa-brain me-2"></i>
                        <span class="badge bg-info me-2">BIDS</span>
                        {% else %}
                        <i class="fas fa-gem me-2"></i>
                        <span class="badge bg-warning text-dark me-2">PRISM</span>
                        {% endif %}
                        {{ warning_code }} ({{ warning_group.count }})
                    </h6>

                    {% if warning_group.description %}
                    <p class="text-muted small mb-3">{{ warning_group.description }}</p>
                    {% endif %}

                    {% if warning_group.fix_hint %}
                    <div class="alert alert-info py-2 px-3 small border-0 mb-3">
                        <i class="fas fa-lightbulb me-2 text-warning"></i>
                        <strong>Fix Hint:</strong> {{ warning_group.fix_hint }}
                    </div>
                    {% endif %}

                    <div class="bg-light rounded p-3">
                        {% if warning_group.messages %}
                            {% for message, files in warning_group.messages.items() %}
                            <div class="mb-3 {% if not loop.last %}border-bottom pb-2{% endif %}">
                                <div class="small mb-2 text-dark {% if warning_code == 'PRISM601' %}fst-italic{% else %}fw-bold{% endif %}">{{ message }}</div>
                                <div class="ms-3 ps-2 border-start border-2">
                                    {% for file in files[:5] %}
                                    <div class="d-flex align-items-center mb-1">
                                        {% if warning_code == 'PRISM601' %}
                                        <i class="fas fa-users text-muted me-2 x-small"></i>
                                        {% else %}
                                        <i class="fas fa-file text-muted me-2 x-small"></i>
                                        {% endif %}
                                        <span class="file-path x-small text-break">{{ file if file else 'General' }}</span>
                                    </div>
                                    {% endfor %}
                                    {% if files|length > 5 %}
                                    <div class="text-muted x-small mt-1">
                                        <i class="fas fa-ellipsis-h me-1"></i>
                                        and {{ files|length - 5 }} more files
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            {% for warning in warning_group.files %}
                            <div class="mb-2 pb-2 {% if not loop.last %}border-bottom{% endif %}">
                                <div class="fw-bold file-path small">{{ warning.file if warning.file else 'General' }}</div>
                                <div class="small">{{ warning.message }}</div>
                                {% if warning.details %}
                                <div class="x-small text-muted mt-1">{{ warning.details }}</div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Valid Files Section -->
        {% if results.summary.valid_files > 0 %}
        <div class="card mb-4 border-0 shadow-sm">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0 fw-bold">
                    <i class="fas fa-check-circle text-success me-2"></i>
                    Valid Files ({{ results.summary.valid_files }})
                    <button class="btn btn-sm btn-outline-secondary float-end" type="button" data-bs-toggle="collapse" data-bs-target="#validFiles">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </h5>
            </div>
            <div class="collapse" id="validFiles">
                <div class="card-body">
                    {% if results.valid_files %}
                    <div class="row">
                        {% for file in results.valid_files %}
                        <div class="col-md-6 mb-2">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-check text-success me-2 small"></i>
                                <span class="file-path small text-truncate">{{ file.path if file.path else file }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted small mb-0">All {{ results.summary.valid_files }} files passed validation with no warnings.</p>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Invalid Files Section -->
        {% if results.summary.invalid_files > 0 %}
        <div class="card mb-4 border-0 shadow-sm">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0 fw-bold">
                    <i class="fas fa-times-circle text-danger me-2"></i>
                    Invalid Files ({{ results.summary.invalid_files }})
                    <button class="btn btn-sm btn-outline-secondary float-end" type="button" data-bs-toggle="collapse" data-bs-target="#invalidFiles">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </h5>
            </div>
            <div class="collapse show" id="invalidFiles">
                <div class="card-body p-0">
                    {% if results.invalid_files %}
                    {% for file in results.invalid_files %}
                    <div class="p-3 border-bottom">
                        <h6 class="text-danger mb-2 fw-bold small">
                            <i class="fas fa-file-excel me-2"></i>
                            {{ file.path if file.path else file }}
                        </h6>
                        {% if file.errors %}
                        <div class="bg-light rounded p-2">
                            <ul class="list-unstyled mb-0">
                                {% for error in file.errors %}
                                <li class="text-danger x-small mb-1">
                                    <i class="fas fa-exclamation-circle me-1"></i>
                                    {{ error }}
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                    {% else %}
                    <p class="p-3 text-muted small mb-0">Dataset has {{ results.summary.invalid_files }} invalid files (see error groups above for details).</p>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div> <!-- End of col-lg-8 -->

    <!-- Right Column: Dataset Overview -->
    <div class="col-lg-4">
        {% if dataset_stats %}
        <div class="card mb-4 border-0 shadow-sm">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0 fw-bold">
                    <i class="fas fa-database text-primary me-2"></i>
                    Dataset Overview
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted"><i class="fas fa-users me-2"></i>Subjects</span>
                    <span class="fw-bold">{{ dataset_stats.total_subjects }}</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted"><i class="fas fa-calendar me-2"></i>Sessions</span>
                    <span class="fw-bold">{{ dataset_stats.total_sessions }}</span>
                </div>
                <hr>
                <div class="mb-3">
                    <div class="small text-muted mb-2 text-uppercase fw-bold">Modalities & Content</div>
                    {% for modality, count in dataset_stats.modalities.items() %}
                    <div class="mb-2">
                        <div class="d-flex justify-content-between mb-1">
                            <span>
                                <i class="fas fa-{{ 'clipboard-list' if modality == 'survey' else 'heartbeat' if modality == 'biometrics' else 'wave-square' if modality in ['physio', 'physiological'] else 'eye' if modality in ['eyetracking', 'eyetrack'] else 'brain' }} me-2 text-secondary modality-icon"></i>
                                {{ modality|capitalize }}
                            </span>
                            <span class="badge bg-light text-dark border">{{ count }}</span>
                        </div>
                        
                        {# Show modality-specific tasks nested under the modality name #}
                        <div class="ms-4 d-flex flex-wrap gap-1 mb-2">
                            {% if modality == 'survey' and dataset_stats.surveys %}
                                {% for s in dataset_stats.surveys %}
                                <span class="badge bg-secondary x-small">{{ s }}</span>
                                {% endfor %}
                            {% elif modality in ['eyetracking', 'eyetrack'] and dataset_stats.eyetracking %}
                                {% for e in dataset_stats.eyetracking %}
                                <span class="badge bg-primary x-small">{{ e }}</span>
                                {% endfor %}
                            {% elif modality in ['physio', 'physiological'] and dataset_stats.physio %}
                                {% for p in dataset_stats.physio %}
                                <span class="badge bg-warning text-dark x-small">{{ p }}</span>
                                {% endfor %}
                            {% elif modality == 'biometrics' and dataset_stats.biometrics %}
                                {% for b in dataset_stats.biometrics %}
                                <span class="badge bg-dark x-small">{{ b }}</span>
                                {% endfor %}
                            {% elif modality == 'func' and dataset_stats.func_tasks %}
                                {% for t in dataset_stats.func_tasks %}
                                <span class="badge bg-info text-dark x-small">{{ t }}</span>
                                {% endfor %}
                            {% elif modality == 'eeg' and dataset_stats.eeg_tasks %}
                                {% for t in dataset_stats.eeg_tasks %}
                                <span class="badge bg-info text-dark x-small">{{ t }}</span>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% if dataset_stats.tasks %}
                <hr>
                <div class="mb-0">
                    <div class="small text-muted mb-2 text-uppercase fw-bold">Behavioral / Other Tasks</div>
                    <div class="d-flex flex-wrap gap-1 mt-1">
                        {% for task in dataset_stats.tasks %}
                        <span class="badge bg-info text-dark">{{ task }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- Quick Actions Card -->
        <div class="card mb-4 border-0 shadow-sm">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0 fw-bold">
                    <i class="fas fa-bolt text-warning me-2"></i>
                    Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('validation.download_report', result_id=result_id) }}" class="btn btn-outline-primary text-start">
                        <i class="fas fa-download me-2"></i>Download JSON Report
                    </a>
                    <a href="{{ url_for('validation.validate_dataset') }}" class="btn btn-primary text-start">
                        <i class="fas fa-plus me-2"></i>Validate Another
                    </a>
                </div>
            </div>
        </div>
    </div> <!-- End of col-lg-4 -->
</div> <!-- End of inner row -->

        <!-- Back to Top -->
        <div class="text-center">
            <a href="#" class="btn btn-outline-secondary" onclick="window.scrollTo(0,0); return false;">
                <i class="fas fa-arrow-up me-2"></i>Back to Top
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Auto-expand error sections if there are errors
document.addEventListener('DOMContentLoaded', function() {
    const errorCount = Number('{{ results.summary.total_errors if results.summary else (results.errors|length if results.errors else 0) }}');
    if (errorCount > 0) {
        // Keep invalid files section expanded by default (already has 'show' class)
    }
});
</script>
{% endblock %}