{% extends "base.html" %}

{% block title %}PRISM Studio - Recipes & Scoring{% endblock %}

{% block content %}
<div class="container" id="recipesRoot" data-current-project-path="{{ current_project.path or '' }}">
  <div class="row mb-4">
    <div class="col-12">
      <h2><i class="fas fa-calculator text-primary me-2"></i>Recipes & Scoring</h2>
      <div class="card border-info mb-3" data-help-panel data-help-expanded="true">
        <div class="card-header bg-info bg-opacity-10 py-2 d-flex align-items-center justify-content-between">
          <div class="fw-semibold text-info-emphasis">
            <i class="fas fa-circle-info me-2"></i>About Recipes
          </div>
          <button type="button" data-help-toggle aria-expanded="true" title="Hide help">
            <i class="fas fa-circle-xmark"></i>
          </button>
        </div>
        <div class="card-body py-3" data-help-content>
          <strong>What are recipes?</strong> Recipes are JSON files that define how to score and process your survey data automatically.
          They extract computed scales/subscales from raw survey responses and export them in analysis-ready formats (SPSS, R, CSV, Excel).
          <br><br>
          <strong>How it works:</strong>
          <ul class="mb-0">
            <li>Recipes are automatically discovered from <code>code/recipes/{modality}/</code> (project-local)</li>
            <li>Falls back to global <code>official/recipes/{modality}/</code> if no project recipes are found</li>
            <li>Processing runs on your current project's dataset</li>
            <li>Scored outputs are saved to <code>derivatives/{modality}/</code></li>
          </ul>
        </div>
      </div>
      {% if not current_project.path %}
      <div class="alert alert-warning mb-3">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <strong>No project loaded.</strong> Please select or create a project from the Projects page to use recipes.
      </div>
      {% endif %}
    </div>
  </div>

  <div class="card">
    <div class="card-header bg-light">
      <h5 class="mb-0">Process & Export</h5>
    </div>
    <div class="card-body">
      <div class="row g-3 align-items-start">
        <div class="col-md-12">
          <label for="derivModality" class="form-label">Modality</label>
          <select class="form-select" id="derivModality">
            {% for modality in (available_modalities or [{"value": "survey", "label": "Survey"}]) %}
            <option value="{{ modality.value }}" {% if modality.value == (default_modality or 'survey') %}selected{% endif %}>{{ modality.label }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-6">
          <label for="derivFormat" class="form-label">Output Format</label>
          <select class="form-select" id="derivFormat">
            <option value="save">SPSS (.save - contains Levels/Labels)</option>
            <option value="r">R (feather/.feather if r writer missing)</option>
            <option value="csv" selected>CSV (includes metadata & Jamovi R-Helper)</option>
            <option value="xlsx">Excel (.xlsx)</option>
          </select>
        </div>

        <div class="col-md-6">
          <label class="form-label">File Output</label>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="derivMerge" id="derivMergeSeparate" value="separate" checked>
            <label class="form-check-label" for="derivMergeSeparate">
              Separate file per survey
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="derivMerge" id="derivMergeCombined" value="combined">
            <label class="form-check-label" for="derivMergeCombined">
              One combined file (all surveys)
            </label>
          </div>
        </div>

        <div class="col-md-6">
          <label class="form-label">Sessions</label>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="derivSessionsAll" checked>
            <label class="form-check-label" for="derivSessionsAll">
              All sessions (default)
            </label>
          </div>
          <select class="form-select mt-2" id="derivSessions" multiple size="4" disabled></select>
          <div class="form-text">Uncheck “All sessions” to pick specific sessions.</div>
        </div>

        <div class="col-md-6">
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="derivIncludeRaw">
            <label class="form-check-label" for="derivIncludeRaw">
              Include Raw Data Columns
            </label>
          </div>
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="derivBoilerplate">
            <label class="form-check-label" for="derivBoilerplate">
              Generate Methods Boilerplate
            </label>
          </div>
        </div>

        <div class="col-12">
          <div class="border rounded p-3 bg-light-subtle">
            <h6 class="mb-3">Advanced (optional)</h6>
            <div class="row g-3">
              <div class="col-md-4">
                <label for="derivSurvey" class="form-label">Recipe Filter</label>
                <input type="text" class="form-control" id="derivSurvey" placeholder="e.g. ads,psqi">
                <div class="form-text">Leave empty to run all matching recipes.</div>
              </div>
              <div class="col-md-4">
                <label for="derivLang" class="form-label">Language</label>
                <select class="form-select" id="derivLang">
                  <option value="en" selected>English</option>
                  <option value="de">German</option>
                </select>
                <div class="form-text">For metadata labels in exports.</div>
              </div>
              <div class="col-md-4">
                <label for="derivLayout" class="form-label">Layout</label>
                <select class="form-select" id="derivLayout">
                  <option value="long" selected>Long (one row per session)</option>
                  <option value="wide">Wide (one row per participant)</option>
                </select>
                <div class="form-text">For repeated measures.</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Anonymization Options -->
        <div class="col-12">
          <hr class="my-3">
          <h6 class="mb-3"><i class="fas fa-user-secret me-2"></i>Data Sharing & Anonymization</h6>
        </div>

        <div class="col-md-6">
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="derivAnonymize" checked>
            <label class="form-check-label" for="derivAnonymize">
              <strong>Anonymize for Sharing</strong>
            </label>
          </div>
          <div class="form-text ms-4">
            Randomize participant IDs (e.g., sub-001 → sub-R7X2K9) and create secure mapping file.
            <strong>Recommended for public data sharing.</strong>
          </div>
        </div>

        <div class="col-md-6">
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="derivMaskQuestions">
            <label class="form-check-label" for="derivMaskQuestions">
              Mask Copyrighted Questions
            </label>
          </div>
          <div class="form-text ms-4">
            Replace copyrighted survey text with generic labels (e.g., "ADS Question 1").
          </div>
        </div>

        <div class="col-md-6">
          <div class="row g-2 align-items-center">
            <div class="col-auto">
              <label for="derivIdLength" class="form-label mb-0">ID Length:</label>
            </div>
            <div class="col-auto">
              <input type="number" class="form-control form-control-sm" id="derivIdLength" value="8" min="4" max="12" style="width: 70px;">
            </div>
            <div class="col">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="derivRandomIds">
                <label class="form-check-label" for="derivRandomIds">
                  Truly Random
                </label>
              </div>
            </div>
          </div>
          <div class="form-text">
            Code length (4-12 chars). Uncheck for deterministic/reproducible IDs.
          </div>
        </div>

        <!-- Run Button -->
        <div class="col-12 mt-3">
          <button class="btn btn-primary w-100" type="button" id="derivRunBtn" {% if not current_project.path %}disabled{% endif %}>
            <i class="fas fa-play me-2"></i>Run Processing
          </button>
        </div>
      </div>

      <div id="derivError" class="alert alert-danger d-none mt-3"></div>
      <div id="derivInfo" class="alert alert-info d-none mt-3"></div>

      <!-- Terminal Output -->
      <div id="derivTerminalContainer" class="mt-4 d-none">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <label class="form-label mb-0"><i class="fas fa-terminal me-1"></i> Output Log</label>
          <button class="btn btn-sm btn-outline-secondary" type="button" id="derivClearLog">
            <i class="fas fa-trash-alt me-1"></i>Clear
          </button>
        </div>
        <pre id="derivTerminal" class="bg-dark text-light p-3 rounded" style="max-height: 400px; overflow-y: auto; font-size: 0.85rem; white-space: pre-wrap;"></pre>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  window.currentProjectPath = {{ (current_project.path or '') | tojson }};
</script>
<script src="{{ url_for('static', filename='js/recipes.js', v='20260301-1') }}"></script>
{% endblock %}
