{% extends "base.html" %}

{% block title %}PRISM Studio - Converter{% endblock %}

{% block styles %}
<style>
    /* Converter Tabs Styling */
    #converterTabs {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 4px;
        background-color: #f8f9fa;
    }
    
    #converterTabs .nav-item {
        border-right: 1px solid #dee2e6;
    }
    
    #converterTabs .nav-item:last-child {
        border-right: none;
    }
    
    #converterTabs .nav-link {
        border-radius: 6px;
        margin: 2px;
        color: #495057;
        transition: all 0.2s ease;
    }
    
    #converterTabs .nav-link:hover:not(.active) {
        background-color: #e9ecef;
    }
    
    #converterTabs .nav-link.active {
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    /* Survey tab - Yellow */
    #survey-tab.active {
        background-color: #ffc107;
        color: #212529;
    }
    #survey-tab.active small {
        color: rgba(0,0,0,0.6) !important;
    }
    
    /* Biometrics tab - Yellow */
    #biometrics-tab.active {
        background-color: #ffc107;
        color: #212529;
    }
    #biometrics-tab.active small {
        color: rgba(0,0,0,0.6) !important;
    }
    
    /* Physio tab - Yellow */
    #physio-tab.active {
        background-color: #ffc107;
        color: #212529;
    }
    #physio-tab.active small {
        color: rgba(0,0,0,0.6) !important;
    }
    
    /* Eyetracking tab - Yellow */
    #eyetracking-tab.active {
        background-color: #ffc107;
        color: #212529;
    }
    #eyetracking-tab.active small {
        color: rgba(0,0,0,0.6) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="fas fa-exchange-alt text-warning me-2"></i>Prism Converter</h2>
            <p class="text-muted">Convert Survey, Biometrics, Physio, and Eyetracking inputs to PRISM/BIDS-style outputs.</p>
        </div>
    </div>

    <!-- Project Context Banner -->
    {% include 'includes/project_banner.html' %}

    <!-- LimeSurvey Quick Import Card (Legacy - now integrated into Survey tab) -->
    <div class="card border-success mb-4 shadow-sm d-none" id="legacyLimeSurveyCard">
        <div class="card-header bg-success bg-opacity-10 d-flex align-items-center">
            <i class="fas fa-file-import fa-lg text-success me-2"></i>
            <h5 class="mb-0">LimeSurvey â†’ PRISM JSON</h5>
            <span class="badge bg-success ms-2">Quick Import</span>
            <span class="badge bg-secondary ms-2">Moved to Survey Tab</span>
        </div>
        <div class="card-body">
            <p class="text-muted mb-3">
                Convert a LimeSurvey structure file (.lss or .lsa) into PRISM-compatible JSON template(s).
            </p>
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label for="lssFile" class="form-label">LimeSurvey File</label>
                    <input class="form-control" type="file" id="lssFile" accept=".lss,.lsa">
                </div>
                <div class="col-md-3">
                    <label for="lssTaskName" class="form-label">Survey Name (optional)</label>
                    <input type="text" class="form-control" id="lssTaskName" placeholder="e.g. phq9">
                    <div class="form-text">For combined mode</div>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Export Mode</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="lssMode" id="lssModeGroups" value="groups" checked>
                        <label class="form-check-label" for="lssModeGroups">By questionnaire group</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="lssMode" id="lssModeQuestions" value="questions">
                        <label class="form-check-label" for="lssModeQuestions">Individual questions</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="lssMode" id="lssModeCombined" value="combined">
                        <label class="form-check-label" for="lssModeCombined">Combined (single file)</label>
                    </div>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-success w-100" type="button" id="lssConvertBtn" disabled>
                        <i class="fas fa-wand-magic-sparkles me-2"></i>Convert
                    </button>
                </div>
            </div>
            <div id="lssError" class="alert alert-danger d-none mt-3"></div>

            <!-- Single file result (combined mode) -->
            <div id="lssResultSingle" class="mt-3 d-none">
                <div class="alert alert-success">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Conversion successful!</strong>
                            <span id="lssQuestionCount" class="ms-2 badge bg-secondary"></span>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-success me-2" id="lssPreviewBtn">
                                <i class="fas fa-eye me-1"></i>Preview
                            </button>
                            <button class="btn btn-sm btn-success" id="lssDownloadBtn">
                                <i class="fas fa-download me-1"></i>Download JSON
                            </button>
                        </div>
                    </div>
                </div>
                <div id="lssPreview" class="d-none mt-2">
                    <pre class="bg-light p-3 rounded border" style="max-height: 400px; overflow-y: auto;"><code id="lssPreviewContent"></code></pre>
                </div>
            </div>

            <!-- Multiple files result (groups mode) -->
            <div id="lssResultMultiple" class="mt-3 d-none">
                <div class="alert alert-success mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Conversion successful!</strong>
                            <span id="lssGroupCount" class="ms-2 badge bg-primary"></span>
                            <span id="lssTotalQuestions" class="ms-1 badge bg-secondary"></span>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-success" id="lssDownloadAllBtn">
                                <i class="fas fa-download me-1"></i>Download ZIP
                            </button>
                            {% if current_project.path %}
                            <button class="btn btn-sm btn-primary" id="lssSaveGroupsToProjectBtn">
                                <i class="fas fa-folder-plus me-1"></i>Save to Project
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div id="lssQuestionnaireList" class="row g-2"></div>
            </div>

            <!-- Individual questions result (questions mode) -->
            <div id="lssResultQuestions" class="mt-3 d-none">
                <div class="alert alert-success mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Question templates extracted!</strong>
                            <span id="lssIndividualCount" class="ms-2 badge bg-info"></span>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-success" id="lssDownloadAllQuestionsBtn">
                                <i class="fas fa-download me-1"></i>Download ZIP
                            </button>
                            {% if current_project.path %}
                            <button class="btn btn-sm btn-primary" id="lssSaveQuestionsToProjectBtn">
                                <i class="fas fa-folder-plus me-1"></i>Save to Project
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <p class="text-muted small mb-2">
                    <i class="fas fa-info-circle me-1"></i>
                    Each question is a reusable template. Array questions include all their subquestions.
                </p>
                <div id="lssQuestionsList" class="row g-2"></div>
            </div>

            <!-- Save to Project Success Message -->
            <div id="lssSaveSuccess" class="alert alert-success d-none mt-3">
                <i class="fas fa-check-circle me-2"></i>
                <span id="lssSaveSuccessMessage"></span>
                <div class="mt-2">
                    <a href="{{ url_for('tools.survey_generator') }}" class="btn btn-sm btn-info">
                        <i class="fas fa-arrow-right me-1"></i>Go to Survey & Boilerplate
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <!-- Ribbon Navigation -->
            <ul class="nav nav-pills nav-fill mb-4" id="converterTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="survey-tab" data-bs-toggle="pill" data-bs-target="#survey-panel" type="button" role="tab" aria-controls="survey-panel" aria-selected="true">
                        <i class="fas fa-clipboard-list fa-lg mb-1 d-block"></i>
                        <span class="fw-bold">Survey</span>
                        <small class="d-block text-muted" style="font-size: 0.7rem;">Questionnaires</small>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="biometrics-tab" data-bs-toggle="pill" data-bs-target="#biometrics-panel" type="button" role="tab" aria-controls="biometrics-panel" aria-selected="false">
                        <i class="fas fa-weight fa-lg mb-1 d-block"></i>
                        <span class="fw-bold">Biometrics</span>
                        <small class="d-block text-muted" style="font-size: 0.7rem;">Physical measures</small>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="physio-tab" data-bs-toggle="pill" data-bs-target="#physio-panel" type="button" role="tab" aria-controls="physio-panel" aria-selected="false">
                        <i class="fas fa-heartbeat fa-lg mb-1 d-block"></i>
                        <span class="fw-bold">Physio</span>
                        <small class="d-block text-muted" style="font-size: 0.7rem;">ECG, Respiration</small>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="eyetracking-tab" data-bs-toggle="pill" data-bs-target="#eyetracking-panel" type="button" role="tab" aria-controls="eyetracking-panel" aria-selected="false">
                        <i class="fas fa-eye fa-lg mb-1 d-block"></i>
                        <span class="fw-bold">Eyetracking</span>
                        <small class="d-block text-muted" style="font-size: 0.7rem;">Gaze data</small>
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="converterTabContent">
                
                <!-- Survey Panel -->
                <div class="tab-pane fade show active" id="survey-panel" role="tabpanel" aria-labelledby="survey-tab">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <div class="bg-warning bg-opacity-10 rounded-circle p-3 me-3">
                                    <i class="fas fa-clipboard-list fa-2x text-warning"></i>
                                </div>
                                <div>
                                    <h5 class="mb-1">Survey Data Conversion</h5>
                                    <p class="text-muted mb-0">Convert questionnaire responses from Excel or LimeSurvey archives</p>
                                </div>
                            </div>

                            <!-- Conversion Mode Toggle -->
                            <div class="row g-3 mb-3">
                                <div class="col-12">
                                    <label class="form-label fw-bold">Conversion Mode</label>
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="convertMode" id="convertModeData" value="data" checked>
                                        <label class="btn btn-outline-warning" for="convertModeData">
                                            <i class="fas fa-table me-1"></i>Data Conversion
                                            <small class="d-block text-muted">Convert responses to BIDS format</small>
                                        </label>
                                        <input type="radio" class="btn-check" name="convertMode" id="convertModeTemplate" value="template">
                                        <label class="btn btn-outline-success" for="convertModeTemplate">
                                            <i class="fas fa-file-code me-1"></i>Template Generation
                                            <small class="d-block text-muted">Extract structure only (no data)</small>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Row 1: File upload -->
                            <div class="row g-3 mb-3">
                                <div class="col-12">
                                    <label for="convertExcelFile" class="form-label">Survey File (.xlsx, .csv, .tsv, .lsa, .lss)</label>
                                    <input class="form-control" type="file" id="convertExcelFile" accept=".xlsx,.lsa,.csv,.tsv,.lss">
                                    <div class="form-text" id="convertFileHint">
                                        <span class="text-info"><i class="fas fa-info-circle me-1"></i>LimeSurvey (.lss/.lsa) or Data Dictionary (.xlsx/.csv/.tsv)</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Row 2: Dataset name and language -->
                            <div class="row g-3 mb-3">
                                <div class="col-12" id="convertDatasetNameGroup">
                                    <label for="convertDatasetName" class="form-label">Dataset/Survey Name (optional)</label>
                                    <input type="text" class="form-control" id="convertDatasetName" placeholder="e.g. phq9">
                                </div>
                                <div class="col-md-6" id="convertLanguageGroup">
                                    <label for="convertLanguage" class="form-label">Language</label>
                                    <select class="form-select" id="convertLanguage">
                                        <option value="auto" selected>Auto (template default)</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Row 3: Participant ID (data conversion) or Template export (template generation) -->
                            <div class="row g-3 mb-3">
                                <!-- Participant ID selector (for data conversion) -->
                                <div class="col-12" id="convertIdColumnGroup">
                                    <label for="convertIdColumn" class="form-label">
                                        Participant ID Column
                                        <span id="idColumnStatus" class="ms-2 small"></span>
                                    </label>
                                    <select class="form-select" id="convertIdColumn">
                                        <option value="auto" selected>Auto-detect</option>
                                    </select>
                                    <div class="form-text" id="idColumnHelp">
                                        <i class="fas fa-info-circle me-1"></i>Upload a file to detect available columns
                                    </div>
                                </div>

                                <!-- Template export mode (for template generation) -->
                                <div class="col-12 d-none" id="convertTemplateExportGroup">
                                    <label class="form-label">Template Export</label>
                                    <select class="form-select" id="convertTemplateExport">
                                        <option value="groups" selected>By questionnaire group</option>
                                        <option value="questions">Individual questions</option>
                                        <option value="combined">Combined (single file)</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Row 4: ID Mapping, Session, Unknown Items, Strict Levels (conversion settings) -->
                            <div class="row g-3 mb-3">
                                <div class="col-md-3" id="convertAliasGroup">
                                    <label for="convertIdMapFile" class="form-label">ID Mapping File (optional)</label>
                                    <input class="form-control" type="file" id="convertIdMapFile" accept=".tsv,.txt,.csv">
                                    <div class="form-text">Map source IDs to participant_id (two-column TSV/CSV).</div>
                                </div>
                                <div class="col-md-3" id="convertSessionGroup">
                                    <label for="convertSession" class="form-label fw-bold text-danger">Session ID <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control border-warning" id="convertSession" placeholder="e.g. 1, 2, 3..." required>
                                    <div class="form-text text-warning">Creates 'ses-1', 'ses-2', etc.</div>
                                </div>
                                <div class="col-md-3" id="convertUnknownGroup">
                                    <label for="convertUnknown" class="form-label">Unknown Items</label>
                                    <select class="form-select" id="convertUnknown">
                                        <option value="warn" selected>Show warnings</option>
                                        <option value="ignore">Skip silently</option>
                                        <option value="error">Stop on unknown</option>
                                    </select>
                                </div>
                                <div class="col-md-3 d-flex align-items-end" id="convertStrictGroup">
                                    <div class="w-100">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="convertStrictLevels">
                                            <label class="form-check-label" for="convertStrictLevels">Strict Levels Validation</label>
                                        </div>
                                        <div class="form-text">Require defined levels for categorical responses.</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Row 5: Duplicate ID Handling and Sourcedata Archiving -->
                            <div class="row g-3 mb-3" id="convertAdvancedRow">
                                <div class="col-md-4" id="convertDuplicateGroup">
                                    <label for="convertDuplicateHandling" class="form-label">Duplicate ID Handling</label>
                                    <select class="form-select" id="convertDuplicateHandling">
                                        <option value="error" selected>Stop and report</option>
                                        <option value="keep_first">Keep first occurrence</option>
                                        <option value="keep_last">Keep last occurrence</option>
                                        <option value="sessions">Create multiple sessions</option>
                                    </select>
                                    <div class="form-text">How to handle participants with duplicate IDs</div>
                                </div>
                                <div class="col-md-4" id="convertArchiveGroup">
                                    <label class="form-label">Sourcedata Archive</label>
                                    <div class="form-check form-switch mt-2">
                                        <input class="form-check-input" type="checkbox" id="convertArchiveSourcedata">
                                        <label class="form-check-label" for="convertArchiveSourcedata">Archive original file to sourcedata/</label>
                                    </div>
                                    <div class="form-text">Preserves the raw input file alongside converted data</div>
                                </div>
                            </div>

                            <!-- Row 6: Convert button -->
                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <button class="btn btn-info text-white w-100" type="button" id="previewBtn" disabled>
                                        <i class="fas fa-eye me-2"></i>Preview (Dry-Run)
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <button class="btn btn-warning text-white w-100" type="button" id="convertBtn" disabled>
                                        <i class="fas fa-wand-magic-sparkles me-2"></i>Convert
                                    </button>
                                </div>
                            </div>

                            <!-- Row 7: Participant Mapping button -->
                            <div class="row g-3 mb-3">
                                <div class="col-md-12">
                                    <button class="btn btn-outline-success w-100" type="button" id="createParticipantMappingBtn" disabled title="Creates a participants_mapping.json file to map unused survey columns to participants.tsv">
                                        <i class="fas fa-list-check me-2"></i>Create Participant Mapping
                                        <span class="badge bg-info ms-2" data-bs-toggle="tooltip" title="Map demographic/unused columns to participants.tsv (different from ID mapping)">?</span>
                                    </button>
                                </div>
                            </div>

                            <div id="convertError" class="alert alert-danger d-none mt-3"></div>
                            <div id="convertInfo" class="alert alert-info d-none mt-3"></div>

                            <!-- Conversion Log Output -->
                            <div id="conversionLogContainer" class="d-none mt-3">
                                <div class="card border-secondary">
                                    <div class="card-header bg-dark text-white py-2 d-flex justify-content-between align-items-center">
                                        <span><i class="fas fa-terminal me-2"></i>Conversion Log</span>
                                        <button type="button" class="btn btn-sm btn-outline-light" id="toggleLogBtn" title="Toggle log">
                                            <i class="fas fa-chevron-down"></i>
                                        </button>
                                    </div>
                                    <div class="card-body p-0" id="conversionLogBody">
                                        <pre id="conversionLog" class="m-0 p-3 bg-dark text-light" style="max-height: 300px; overflow-y: auto; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; font-size: 12px; white-space: pre-wrap;"></pre>
                                    </div>
                                </div>
                            </div>

                            <!-- Validation Results -->
                            <div id="validationResultsContainer" class="d-none mt-3">
                                <div class="card" id="validationResultsCard">
                                    <div class="card-header py-2 d-flex justify-content-between align-items-center" id="validationResultsHeader">
                                        <span><i class="fas fa-clipboard-check me-2"></i>Validation Results</span>
                                        <span id="validationBadge" class="badge"></span>
                                    </div>
                                    <div class="card-body">
                                        <div id="validationSummary" class="mb-3"></div>
                                        <div id="validationDetails"></div>
                                        <div id="downloadSection" class="d-none mt-3 text-center">
                                            <button class="btn btn-warning btn-lg text-white" id="downloadZipBtn">
                                                <i class="fas fa-download me-2"></i>Download Validated Dataset
                                            </button>
                                            <p class="text-muted small mt-2">
                                                <i class="fas fa-check-circle me-1"></i>Dataset passed validation
                                            </p>
                                        </div>
                                        <div id="downloadWarningSection" class="d-none mt-3 text-center">
                                            <button class="btn btn-warning btn-lg" id="downloadZipWarningBtn">
                                                <i class="fas fa-download me-2"></i>Download Dataset (with warnings)
                                            </button>
                                            <p class="text-muted small mt-2">
                                                <i class="fas fa-exclamation-triangle me-1"></i>Dataset has warnings but can still be used
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Template Generation Results -->
                            <div id="templateResultsContainer" class="d-none mt-3">
                                <!-- Single template result -->
                                <div id="templateResultSingle" class="d-none">
                                    <div class="alert alert-success">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <i class="fas fa-check-circle me-2"></i>
                                                <strong>Template generated!</strong>
                                                <span id="templateQuestionCount" class="ms-2 badge bg-secondary"></span>
                                            </div>
                                            <div>
                                                <button class="btn btn-sm btn-outline-success me-2" id="templatePreviewBtn">
                                                    <i class="fas fa-eye me-1"></i>Preview
                                                </button>
                                                <button class="btn btn-sm btn-success" id="templateDownloadBtn">
                                                    <i class="fas fa-download me-1"></i>Download JSON
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="templatePreview" class="d-none mt-2">
                                        <pre class="bg-light p-3 rounded border" style="max-height: 400px; overflow-y: auto;"><code id="templatePreviewContent"></code></pre>
                                    </div>
                                </div>

                                <!-- Multiple templates result (groups mode) -->
                                <div id="templateResultGroups" class="d-none">
                                    <div class="alert alert-success mb-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <i class="fas fa-check-circle me-2"></i>
                                                <strong>Templates generated!</strong>
                                                <span id="templateGroupCount" class="ms-2 badge bg-primary"></span>
                                                <span id="templateTotalQuestions" class="ms-1 badge bg-secondary"></span>
                                            </div>
                                            <div class="btn-group">
                                                <button class="btn btn-sm btn-success" id="templateDownloadAllBtn">
                                                    <i class="fas fa-download me-1"></i>Download ZIP
                                                </button>
                                                {% if current_project.path %}
                                                <button class="btn btn-sm btn-primary" id="templateSaveToProjectBtn">
                                                    <i class="fas fa-folder-plus me-1"></i>Save to Project
                                                </button>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    <div id="templateGroupList" class="row g-2"></div>
                                </div>

                                <!-- Individual questions result -->
                                <div id="templateResultQuestions" class="d-none">
                                    <div class="alert alert-success mb-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <i class="fas fa-check-circle me-2"></i>
                                                <strong>Question templates extracted!</strong>
                                                <span id="templateIndividualCount" class="ms-2 badge bg-info"></span>
                                            </div>
                                            <div class="btn-group">
                                                <button class="btn btn-sm btn-success" id="templateDownloadQuestionsBtn">
                                                    <i class="fas fa-download me-1"></i>Download ZIP
                                                </button>
                                                {% if current_project.path %}
                                                <button class="btn btn-sm btn-primary" id="templateSaveQuestionsToProjectBtn">
                                                    <i class="fas fa-folder-plus me-1"></i>Save to Project
                                                </button>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    <div id="templateQuestionsList" class="row g-2"></div>
                                </div>

                                <!-- Save to Project Success -->
                                <div id="templateSaveSuccess" class="alert alert-success d-none mt-3">
                                    <i class="fas fa-check-circle me-2"></i>
                                    <span id="templateSaveSuccessMessage"></span>
                                </div>

                                <!-- Participant Metadata Section -->
                                <div id="participantMetadataSection" class="d-none mt-4 border-top pt-3">
                                    <h6 class="mb-3">
                                        <i class="fas fa-users text-info me-2"></i>
                                        Mark Participant Metadata Fields
                                        <small class="text-muted ms-2">(fields that go into participants.tsv)</small>
                                    </h6>

                                    <div class="alert alert-info py-2 mb-3">
                                        <small>
                                            <i class="fas fa-lightbulb me-1"></i>
                                            <strong>BIDS Tip:</strong> Mark demographic questions (age, sex, ID) as participant metadata.
                                            These will be saved to <code>participants.json</code> instead of per-subject survey files.
                                        </small>
                                    </div>

                                    <!-- Question list with checkboxes -->
                                    <div id="participantFieldsList" class="mb-3" style="max-height: 300px; overflow-y: auto;">
                                        <div class="text-muted">Loading extracted fields...</div>
                                    </div>

                                    <!-- BIDS field mapping suggestions -->
                                    <div id="bidsFieldSuggestions" class="mb-3 d-none">
                                        <h6 class="small text-muted mb-2">Suggested BIDS Mappings</h6>
                                        <div id="bidsFieldSuggestionsList" class="d-flex flex-wrap gap-2"></div>
                                    </div>

                                    <!-- Actions -->
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <span class="text-muted me-2">
                                                <span id="selectedParticipantFieldsCount">0</span> fields selected
                                            </span>
                                        </div>
                                        <div>
                                            {% if current_project.path %}
                                            <button type="button" class="btn btn-primary btn-sm" id="saveParticipantsJsonBtn" disabled>
                                                <i class="fas fa-save me-1"></i>Save to participants.json
                                            </button>
                                            {% else %}
                                            <button type="button" class="btn btn-outline-secondary btn-sm" id="downloadParticipantsJsonBtn" disabled>
                                                <i class="fas fa-download me-1"></i>Download participants.json
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <!-- Save status -->
                                    <div id="participantsSaveStatus" class="mt-2"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Biometrics Panel -->
                <div class="tab-pane fade" id="biometrics-panel" role="tabpanel" aria-labelledby="biometrics-tab">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <div class="bg-warning bg-opacity-10 rounded-circle p-3 me-3">
                                    <i class="fas fa-weight fa-2x text-warning"></i>
                                </div>
                                <div>
                                    <h5 class="mb-1">Biometrics Data Conversion</h5>
                                    <p class="text-muted mb-0">Convert physical measurements like grip strength, balance tests</p>
                                </div>
                            </div>

                            <!-- Structure Warning (missing folders/files) -->
                            <div id="biometricsStructureWarning" class="alert alert-danger d-none mb-3">
                                <i class="fas fa-folder-minus me-2"></i>
                                <strong>Missing Structure:</strong> <span id="biometricsStructureMessage">The selected folder is missing required items.</span>
                            </div>

                            <div class="row g-3 align-items-end">
                                <div class="col-md-8">
                                    <label for="biometricsDataFile" class="form-label">Biometrics File (.xlsx, .csv, .tsv)</label>
                                    <input class="form-control" type="file" id="biometricsDataFile" accept=".xlsx,.csv,.tsv">
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-info text-white w-100" type="button" id="biometricsPreviewBtn" disabled>
                                        <i class="fas fa-eye me-2"></i>Preview
                                    </button>
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-warning text-white w-100" type="button" id="biometricsConvertBtn" disabled>
                                        <i class="fas fa-wand-magic-sparkles me-2"></i>Convert
                                    </button>
                                </div>

                                <div class="col-12 mt-3">
                                    <div class="row g-3 align-items-end">
                                        <div class="col-md-4">
                                            <label for="biometricsSheet" class="form-label">Excel Sheet (name or index)</label>
                                            <input type="text" class="form-control" id="biometricsSheet" placeholder="0" value="0">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="biometricsSession" class="form-label fw-bold text-danger">Session ID <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control border-warning" id="biometricsSession" placeholder="e.g. 1 (creates ses-1)" required>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="biometricsUnknown" class="form-label">Unknown Columns</label>
                                            <select class="form-select" id="biometricsUnknown">
                                                <option value="warn" selected>Warn (default)</option>
                                                <option value="ignore">Ignore</option>
                                                <option value="error">Error</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="biometricsError" class="alert alert-danger d-none mt-3"></div>
                            <div id="biometricsInfo" class="alert alert-info d-none mt-3"></div>

                            <!-- Detected Biometrics List -->
                            <div id="biometricsDetectedContainer" class="d-none mt-3">
                                <div class="card border-warning">
                                    <div class="card-header bg-warning bg-opacity-10 fw-bold">
                                        <i class="fas fa-search me-2 text-warning"></i>Detected Biometrics
                                    </div>
                                    <div class="card-body">
                                        <p class="small text-muted mb-2">The following biometrics tasks were detected in your file. Select which ones to export:</p>
                                        <div id="biometricsDetectedList" class="row g-2">
                                            <!-- Dynamic checkboxes here -->
                                        </div>
                                        <div class="mt-3 pt-2 border-top d-flex justify-content-between align-items-center">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="biometricsSelectAll" checked>
                                                <label class="form-check-label small" for="biometricsSelectAll">Select All</label>
                                            </div>
                                            <button class="btn btn-sm btn-warning text-white" id="biometricsConfirmBtn">
                                                <i class="fas fa-check me-1"></i>Confirm & Convert
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Conversion Log Output -->
                            <div id="biometricsLogContainer" class="d-none mt-3">
                                <div class="card border-secondary">
                                    <div class="card-header bg-dark text-white py-2 d-flex justify-content-between align-items-center">
                                        <span><i class="fas fa-terminal me-2"></i>Conversion Log</span>
                                        <button type="button" class="btn btn-sm btn-outline-light" id="toggleBiometricsLogBtn" title="Toggle log">
                                            <i class="fas fa-chevron-down"></i>
                                        </button>
                                    </div>
                                    <div class="card-body p-0" id="biometricsLogBody">
                                        <pre id="biometricsLog" class="m-0 p-3 bg-dark text-light" style="max-height: 300px; overflow-y: auto; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; font-size: 12px; white-space: pre-wrap;"></pre>
                                    </div>
                                </div>
                            </div>

                            <!-- Validation Results -->
                            <div id="biometricsValidationResultsContainer" class="d-none mt-3">
                                <div class="card" id="biometricsValidationResultsCard">
                                    <div class="card-header py-2 d-flex justify-content-between align-items-center" id="biometricsValidationResultsHeader">
                                        <span><i class="fas fa-clipboard-check me-2"></i>Validation Results</span>
                                        <span id="biometricsValidationBadge" class="badge"></span>
                                    </div>
                                    <div class="card-body">
                                        <div id="biometricsValidationSummary" class="mb-3"></div>
                                        <div id="biometricsValidationDetails"></div>
                                        <div id="biometricsDownloadSection" class="d-none mt-3 text-center">
                                            <button class="btn btn-warning btn-lg text-white" id="biometricsDownloadZipBtn">
                                                <i class="fas fa-download me-2"></i>Download Validated Dataset
                                            </button>
                                            <p class="text-muted small mt-2">
                                                <i class="fas fa-check-circle me-1"></i>Dataset passed validation
                                            </p>
                                        </div>
                                        <div id="biometricsDownloadWarningSection" class="d-none mt-3 text-center">
                                            <button class="btn btn-warning btn-lg" id="biometricsDownloadZipWarningBtn">
                                                <i class="fas fa-download me-2"></i>Download Dataset (with warnings)
                                            </button>
                                            <p class="text-muted small mt-2">
                                                <i class="fas fa-exclamation-triangle me-1"></i>Dataset has warnings but can still be used
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Physio Panel -->
                <div class="tab-pane fade" id="physio-panel" role="tabpanel" aria-labelledby="physio-tab">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <div class="bg-warning bg-opacity-10 rounded-circle p-3 me-3">
                                    <i class="fas fa-heartbeat fa-2x text-warning"></i>
                                </div>
                                <div>
                                    <h5 class="mb-1">Physiological Data Conversion</h5>
                                    <p class="text-muted mb-0">Convert Varioport recordings (ECG, respiration) to PRISM format</p>
                                </div>
                            </div>

                            <!-- Sub-tabs for single vs batch -->
                            <ul class="nav nav-tabs nav-sm mb-3" id="physioSubTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="physio-single-tab" data-bs-toggle="tab" data-bs-target="#physio-single" type="button" role="tab">
                                        <i class="fas fa-file me-1"></i>Single File
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="physio-batch-tab" data-bs-toggle="tab" data-bs-target="#physio-batch" type="button" role="tab">
                                        <i class="fas fa-folder-open me-1"></i>Batch (Multiple Files)
                                    </button>
                                </li>
                            </ul>

                            <div class="tab-content" id="physioSubTabContent">
                                <!-- Single File -->
                                <div class="tab-pane fade show active" id="physio-single" role="tabpanel">
                                    <div class="row g-3 align-items-end">
                                        <div class="col-md-4">
                                            <label for="physioRawFile" class="form-label">Varioport Recording (.raw or .vpd)</label>
                                            <input class="form-control" type="file" id="physioRawFile" accept=".raw,.vpd">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="physioTask" class="form-label">Task Name</label>
                                            <input type="text" class="form-control" id="physioTask" value="rest">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="physioSamplingRate" class="form-label">Sampling Rate (optional)</label>
                                            <input type="number" class="form-control" id="physioSamplingRate" placeholder="e.g. 256" step="any">
                                        </div>
                                        <div class="col-md-4">
                                            <button class="btn btn-warning text-white w-100" type="button" id="physioConvertBtn" disabled>
                                                <i class="fas fa-wand-magic-sparkles me-2"></i>Convert
                                            </button>
                                        </div>
                                    </div>
                                    <div id="physioError" class="alert alert-danger d-none mt-3"></div>
                                    <div id="physioInfo" class="alert alert-info d-none mt-3"></div>
                                </div>

                                <!-- Batch -->
                                <div class="tab-pane fade" id="physio-batch" role="tabpanel">
                                    <div class="alert alert-light border mb-3">
                                        <i class="fas fa-info-circle me-2 text-info"></i>
                                        <strong>File naming required:</strong> <code>sub-XXX_ses-YYY_task-ZZZ.raw</code> or <code>.vpd</code>
                                        <br><small class="text-muted">Example: <code>sub-003_ses-1_task-rest.raw</code> Â· Session is optional</small>
                                    </div>
                                    <div class="row g-3 align-items-end">
                                        <div class="col-md-6">
                                            <label for="physioBatchFiles" class="form-label">Select Physio Files</label>
                                            <input class="form-control" type="file" id="physioBatchFiles" accept=".raw,.vpd" multiple>
                                            <small class="text-muted">Select all files (Ctrl+A / Cmd+A)</small>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="physioBatchDatasetName" class="form-label">Dataset Name</label>
                                            <input type="text" class="form-control" id="physioBatchDatasetName" value="Physio Dataset">
                                        </div>
                                        <div class="col-md-3">
                                            <label for="physioBatchSamplingRate" class="form-label">Sampling Rate (optional)</label>
                                            <input type="number" class="form-control" id="physioBatchSamplingRate" placeholder="e.g. 256" step="any">
                                        </div>
                                        <div class="col-md-4">
                                            <button class="btn btn-warning text-white w-100" type="button" id="physioBatchConvertBtn" disabled>
                                                <i class="fas fa-wand-magic-sparkles me-2"></i>Convert All & Download
                                            </button>
                                        </div>
                                    </div>
                                    <div id="physioBatchError" class="alert alert-danger d-none mt-3"></div>
                                    <div id="physioBatchInfo" class="alert alert-info d-none mt-3"></div>
                                    <div id="physioBatchProgress" class="progress d-none mt-3" style="height: 25px;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-warning text-dark" style="width: 100%">Converting...</div>
                                    </div>
                                    <!-- Log Window -->
                                    <div id="physioBatchLogContainer" class="d-none mt-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <label class="form-label mb-0"><i class="fas fa-terminal me-2"></i>Conversion Log</label>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" id="physioBatchLogClearBtn">
                                                <i class="fas fa-trash-alt me-1"></i>Clear
                                            </button>
                                        </div>
                                        <div id="physioBatchLog" class="bg-dark text-light p-3 rounded font-monospace" 
                                             style="height: 200px; overflow-y: auto; font-size: 0.85rem; white-space: pre-wrap;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Eyetracking Panel -->
                <div class="tab-pane fade" id="eyetracking-panel" role="tabpanel" aria-labelledby="eyetracking-tab">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <div class="bg-warning bg-opacity-10 rounded-circle p-3 me-3">
                                    <i class="fas fa-eye fa-2x text-warning"></i>
                                </div>
                                <div>
                                    <h5 class="mb-1">Eyetracking Data Conversion</h5>
                                    <p class="text-muted mb-0">Convert SR Research EyeLink recordings (.edf) to PRISM format</p>
                                </div>
                            </div>

                            <!-- Sub-tabs for single vs batch -->
                            <ul class="nav nav-tabs nav-sm mb-3" id="eyetrackingSubTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="eyetracking-single-tab" data-bs-toggle="tab" data-bs-target="#eyetracking-single" type="button" role="tab">
                                        <i class="fas fa-file me-1"></i>Single File
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="eyetracking-batch-tab" data-bs-toggle="tab" data-bs-target="#eyetracking-batch" type="button" role="tab">
                                        <i class="fas fa-folder-open me-1"></i>Batch (Multiple Files)
                                    </button>
                                </li>
                            </ul>

                            <div class="tab-content" id="eyetrackingSubTabContent">
                                <!-- Single File -->
                                <div class="tab-pane fade show active" id="eyetracking-single" role="tabpanel">
                                    <div class="row g-3 align-items-end">
                                        <div class="col-md-4">
                                            <label for="eyetrackingSingleFile" class="form-label">EyeLink Recording (.edf)</label>
                                            <input class="form-control" type="file" id="eyetrackingSingleFile" accept=".edf">
                                        </div>
                                        <div class="col-md-2">
                                            <label for="eyetrackingSubject" class="form-label">Subject ID</label>
                                            <input type="text" class="form-control" id="eyetrackingSubject" placeholder="e.g. 001">
                                        </div>
                                        <div class="col-md-2">
                                            <label for="eyetrackingSession" class="form-label">Session (optional)</label>
                                            <input type="text" class="form-control" id="eyetrackingSession" placeholder="e.g. 1">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="eyetrackingTask" class="form-label">Task Name</label>
                                            <input type="text" class="form-control" id="eyetrackingTask" value="gaze" placeholder="e.g. antisaccade">
                                        </div>
                                        <div class="col-md-4">
                                            <button class="btn btn-warning w-100" type="button" id="eyetrackingSingleConvertBtn" disabled>
                                                <i class="fas fa-wand-magic-sparkles me-2"></i>Convert
                                            </button>
                                        </div>
                                    </div>
                                    <div id="eyetrackingSingleError" class="alert alert-danger d-none mt-3"></div>
                                    <div id="eyetrackingSingleInfo" class="alert alert-info d-none mt-3"></div>
                                </div>

                                <!-- Batch -->
                                <div class="tab-pane fade" id="eyetracking-batch" role="tabpanel">
                                    <div class="alert alert-light border mb-3">
                                        <i class="fas fa-info-circle me-2 text-info"></i>
                                        <strong>File naming required:</strong> <code>sub-XXX_ses-YYY_task-ZZZ.edf</code>
                                        <br><small class="text-muted">Example: <code>sub-003_ses-1_task-antisaccade.edf</code> Â· Session is optional</small>
                                    </div>
                                    <div class="row g-3 align-items-end">
                                        <div class="col-md-6">
                                            <label for="eyetrackingBatchFiles" class="form-label">Select EDF Files</label>
                                            <input class="form-control" type="file" id="eyetrackingBatchFiles" accept=".edf" multiple>
                                            <small class="text-muted">Select all files (Ctrl+A / Cmd+A)</small>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="eyetrackingBatchDatasetName" class="form-label">Dataset Name</label>
                                            <input type="text" class="form-control" id="eyetrackingBatchDatasetName" value="Eyetracking Dataset">
                                        </div>
                                        <div class="col-md-3">
                                            <button class="btn btn-warning w-100" type="button" id="eyetrackingBatchConvertBtn" disabled>
                                                <i class="fas fa-wand-magic-sparkles me-2"></i>Convert All & Download
                                            </button>
                                        </div>
                                    </div>
                                    <div id="eyetrackingBatchError" class="alert alert-danger d-none mt-3"></div>
                                    <div id="eyetrackingBatchInfo" class="alert alert-info d-none mt-3"></div>
                                    <div id="eyetrackingBatchProgress" class="progress d-none mt-3" style="height: 25px;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-warning" style="width: 100%">Converting...</div>
                                    </div>
                                    <!-- Log Window -->
                                    <div id="eyetrackingBatchLogContainer" class="d-none mt-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <label class="form-label mb-0"><i class="fas fa-terminal me-2"></i>Conversion Log</label>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" id="eyetrackingBatchLogClearBtn">
                                                <i class="fas fa-trash-alt me-1"></i>Clear
                                            </button>
                                        </div>
                                        <div id="eyetrackingBatchLog" class="bg-dark text-light p-3 rounded font-monospace" 
                                             style="height: 200px; overflow-y: auto; font-size: 0.85rem; white-space: pre-wrap;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- Modal: Create Participant Mapping -->
<div class="modal fade" id="participantMappingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-map me-2"></i>Create Participant Mapping
                    <small class="d-block mt-1" style="font-size: 0.7em; font-weight: normal;">
                        Map unused survey columns to participants.tsv
                        <span class="badge bg-warning text-dark ms-2">Different from ID Mapping</span>
                    </small>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <strong>â„¹ï¸ What is this?</strong><br>
                    <small>
                        <strong>Participant Mapping:</strong> Maps demographic/unused columns from your survey to participants.tsv (saved to PROJECT library)<br>
                        <strong>ID Mapping:</strong> Maps participant IDs between different systems<br>
                        <br>
                        <i class="fas fa-check-circle text-success me-1"></i> File will be saved to your <strong>project</strong> library survey directory<br>
                        <i class="fas fa-book text-info me-1"></i> References participant.json template from <strong>global</strong> library<br>
                        <i class="fas fa-circle-info text-secondary me-1"></i> Variables without NeuroBagel template definitions will be added as custom fields
                    </small>
                </div>

                <div id="mappingColumnsContainer">
                    <p class="text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Loading unused columns...</p>
                </div>

                <div id="mappingSuccess" class="alert alert-success d-none mt-3">
                    <i class="fas fa-check-circle me-2"></i>Mapping file created successfully!
                    <div id="mappingFilePath" class="mt-2 small"></div>
                </div>

                <div id="mappingError" class="alert alert-danger d-none mt-3">
                    <i class="fas fa-exclamation-circle me-2"></i><span id="mappingErrorText"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancelMappingBtn">Cancel</button>
                <button type="button" class="btn btn-success" id="saveMappingBtn" disabled>
                    <i class="fas fa-save me-2"></i>Save Mapping
                </button>
                <button type="button" class="btn btn-primary d-none" id="downloadMappingBtn">
                    <i class="fas fa-download me-2"></i>Download JSON
                </button>
                <button type="button" class="btn btn-primary d-none" data-bs-dismiss="modal" id="closeMappingBtn">
                    <i class="fas fa-check me-2"></i>Close
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- LimeSurvey Quick Import ---
    const lssFile = document.getElementById('lssFile');
    const lssTaskName = document.getElementById('lssTaskName');
    const lssConvertBtn = document.getElementById('lssConvertBtn');
    const lssError = document.getElementById('lssError');

    // Single mode elements (combined)
    const lssResultSingle = document.getElementById('lssResultSingle');
    const lssQuestionCount = document.getElementById('lssQuestionCount');
    const lssPreviewBtn = document.getElementById('lssPreviewBtn');
    const lssDownloadBtn = document.getElementById('lssDownloadBtn');
    const lssPreview = document.getElementById('lssPreview');
    const lssPreviewContent = document.getElementById('lssPreviewContent');

    // Groups mode elements
    const lssResultMultiple = document.getElementById('lssResultMultiple');
    const lssGroupCount = document.getElementById('lssGroupCount');
    const lssTotalQuestions = document.getElementById('lssTotalQuestions');
    const lssDownloadAllBtn = document.getElementById('lssDownloadAllBtn');
    const lssQuestionnaireList = document.getElementById('lssQuestionnaireList');

    // Questions mode elements
    const lssResultQuestions = document.getElementById('lssResultQuestions');
    const lssIndividualCount = document.getElementById('lssIndividualCount');
    const lssDownloadAllQuestionsBtn = document.getElementById('lssDownloadAllQuestionsBtn');
    const lssQuestionsList = document.getElementById('lssQuestionsList');

    // Save to project elements
    const lssSaveGroupsToProjectBtn = document.getElementById('lssSaveGroupsToProjectBtn');
    const lssSaveQuestionsToProjectBtn = document.getElementById('lssSaveQuestionsToProjectBtn');
    const lssSaveSuccess = document.getElementById('lssSaveSuccess');
    const lssSaveSuccessMessage = document.getElementById('lssSaveSuccessMessage');

    let lssConvertedData = null;
    let lssSuggestedFilename = 'survey.json';
    let lssQuestionnaires = null; // For groups mode
    let lssIndividualQuestions = null; // For questions mode

    function getSelectedLssMode() {
        const checked = document.querySelector('input[name="lssMode"]:checked');
        return checked ? checked.value : 'groups';
    }

    lssFile.addEventListener('change', function() {
        lssConvertBtn.disabled = !lssFile.files.length;
        // Reset all results
        lssResultSingle.classList.add('d-none');
        lssResultMultiple.classList.add('d-none');
        lssResultQuestions.classList.add('d-none');
        lssError.classList.add('d-none');
        lssPreview.classList.add('d-none');
    });

    lssConvertBtn.addEventListener('click', async function() {
        if (!lssFile.files.length) return;

        const originalText = lssConvertBtn.innerHTML;
        lssConvertBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Converting...';
        lssConvertBtn.disabled = true;
        lssError.classList.add('d-none');
        lssResultSingle.classList.add('d-none');
        lssResultMultiple.classList.add('d-none');
        lssResultQuestions.classList.add('d-none');

        const formData = new FormData();
        formData.append('file', lssFile.files[0]);
        formData.append('task_name', lssTaskName.value || '');
        formData.append('mode', getSelectedLssMode());

        try {
            const response = await fetch('/api/limesurvey-to-prism', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.success) {
                if (data.mode === 'questions') {
                    // Individual questions mode
                    lssIndividualQuestions = data.questions;
                    lssIndividualCount.textContent = `${data.question_count} question templates`;

                    // Build question cards grouped by questionnaire
                    lssQuestionsList.innerHTML = '';

                    // Group questions by their group_name
                    const grouped = {};
                    for (const [code, qData] of Object.entries(data.questions)) {
                        const groupName = qData.group_name || 'Ungrouped';
                        if (!grouped[groupName]) grouped[groupName] = [];
                        grouped[groupName].push({code, ...qData});
                    }

                    // Sort groups by group_order
                    const sortedGroups = Object.entries(grouped).sort((a, b) => {
                        const orderA = a[1][0]?.group_order || 0;
                        const orderB = b[1][0]?.group_order || 0;
                        return orderA - orderB;
                    });

                    for (const [groupName, questions] of sortedGroups) {
                        // Group header
                        const groupHeader = document.createElement('div');
                        groupHeader.className = 'col-12 mt-2';
                        groupHeader.innerHTML = `<h6 class="text-muted border-bottom pb-1"><i class="fas fa-folder me-1"></i>${groupName}</h6>`;
                        lssQuestionsList.appendChild(groupHeader);

                        // Sort questions by question_order
                        questions.sort((a, b) => (a.question_order || 0) - (b.question_order || 0));

                        for (const q of questions) {
                            const card = document.createElement('div');
                            card.className = 'col-md-3';
                            const questionType = q.question_type || '';
                            const itemCount = q.item_count || 1;
                            const itemBadge = itemCount > 1 ? `<span class="badge bg-secondary ms-1">${itemCount} items</span>` : '';
                            // Get description from prism_json if available
                            const questionText = q.prism_json?.Study?.Description || '';
                            card.innerHTML = `
                                <div class="card h-100 card-hover">
                                    <div class="card-body py-2">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="small fw-bold text-truncate" title="${q.code}">${q.code}</div>
                                            <span class="badge bg-info small">${questionType}</span>
                                        </div>
                                        <div class="text-muted x-small text-truncate" title="${questionText}">${questionText}</div>
                                        ${itemBadge}
                                        <div class="mt-1">
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-secondary btn-sm lss-preview-question" data-code="${q.code}" title="Preview">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-outline-success btn-sm lss-download-question" data-code="${q.code}" data-filename="${q.suggested_filename}" title="Download">
                                                    <i class="fas fa-download"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                            lssQuestionsList.appendChild(card);
                        }
                    }
                    lssResultQuestions.classList.remove('d-none');

                } else if (data.mode === 'groups') {
                    // Multiple questionnaires (groups mode)
                    lssQuestionnaires = data.questionnaires;
                    lssGroupCount.textContent = `${data.questionnaire_count} questionnaires`;
                    lssTotalQuestions.textContent = `${data.total_questions} total questions`;

                    // Build questionnaire cards
                    lssQuestionnaireList.innerHTML = '';
                    for (const [name, qData] of Object.entries(data.questionnaires)) {
                        const card = document.createElement('div');
                        card.className = 'col-md-4';
                        card.innerHTML = `
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title"><i class="fas fa-file-alt me-1 text-success"></i>${name}</h6>
                                    <p class="card-text small text-muted">${qData.question_count} questions</p>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-secondary lss-preview-single" data-name="${name}">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-success lss-download-single" data-name="${name}" data-filename="${qData.suggested_filename}">
                                            <i class="fas fa-download"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        lssQuestionnaireList.appendChild(card);
                    }
                    lssResultMultiple.classList.remove('d-none');
                } else {
                    // Single combined JSON
                    lssConvertedData = data.prism_json;
                    lssSuggestedFilename = data.suggested_filename;
                    lssQuestionCount.textContent = `${data.question_count} questions`;
                    lssPreviewContent.textContent = JSON.stringify(lssConvertedData, null, 2);
                    lssResultSingle.classList.remove('d-none');
                }
            } else {
                lssError.textContent = data.error || 'Conversion failed';
                lssError.classList.remove('d-none');
            }
        } catch (err) {
            lssError.textContent = 'Error: ' + err.message;
            lssError.classList.remove('d-none');
        } finally {
            lssConvertBtn.innerHTML = originalText;
            lssConvertBtn.disabled = false;
        }
    });

    // Event delegation for dynamic questionnaire buttons
    lssQuestionnaireList.addEventListener('click', function(e) {
        const previewBtn = e.target.closest('.lss-preview-single');
        const downloadBtn = e.target.closest('.lss-download-single');

        if (previewBtn) {
            const name = previewBtn.dataset.name;
            if (lssQuestionnaires && lssQuestionnaires[name]) {
                alert(JSON.stringify(lssQuestionnaires[name].prism_json, null, 2).substring(0, 2000) + '...');
            }
        }

        if (downloadBtn) {
            const name = downloadBtn.dataset.name;
            const filename = downloadBtn.dataset.filename;
            if (lssQuestionnaires && lssQuestionnaires[name]) {
                downloadJson(lssQuestionnaires[name].prism_json, filename);
            }
        }
    });

    lssPreviewBtn.addEventListener('click', function() {
        lssPreview.classList.toggle('d-none');
        const icon = lssPreviewBtn.querySelector('i');
        icon.className = lssPreview.classList.contains('d-none') ? 'fas fa-eye me-1' : 'fas fa-eye-slash me-1';
    });

    lssDownloadBtn.addEventListener('click', function() {
        if (lssConvertedData) downloadJson(lssConvertedData, lssSuggestedFilename);
    });

    lssDownloadAllBtn.addEventListener('click', function() {
        if (!lssQuestionnaires) return;
        downloadAllAsZip(lssQuestionnaires);
    });

    // Event delegation for individual question buttons
    lssQuestionsList.addEventListener('click', function(e) {
        const previewBtn = e.target.closest('.lss-preview-question');
        const downloadBtn = e.target.closest('.lss-download-question');

        if (previewBtn) {
            const code = previewBtn.dataset.code;
            if (lssIndividualQuestions && lssIndividualQuestions[code]) {
                const json = JSON.stringify(lssIndividualQuestions[code].prism_json, null, 2);
                // Use a modal or better preview in the future
                alert(json.substring(0, 3000) + (json.length > 3000 ? '\n...(truncated)' : ''));
            }
        }

        if (downloadBtn) {
            const code = downloadBtn.dataset.code;
            const filename = downloadBtn.dataset.filename;
            if (lssIndividualQuestions && lssIndividualQuestions[code]) {
                downloadJson(lssIndividualQuestions[code].prism_json, filename);
            }
        }
    });

    lssDownloadAllQuestionsBtn.addEventListener('click', function() {
        if (!lssIndividualQuestions) return;
        downloadAllQuestionsAsZip(lssIndividualQuestions);
    });

    function downloadJson(data, filename) {
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    async function downloadAllAsZip(questionnaires) {
        // Use JSZip if available, otherwise download individually
        if (typeof JSZip !== 'undefined') {
            const zip = new JSZip();
            for (const [name, qData] of Object.entries(questionnaires)) {
                zip.file(qData.suggested_filename, JSON.stringify(qData.prism_json, null, 2));
            }
            const blob = await zip.generateAsync({type: 'blob'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'limesurvey_questionnaires.zip';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        } else {
            // Fallback: download each file individually
            for (const [name, qData] of Object.entries(questionnaires)) {
                downloadJson(qData.prism_json, qData.suggested_filename);
                await new Promise(r => setTimeout(r, 300)); // Small delay between downloads
            }
        }
    }

    async function downloadAllQuestionsAsZip(questions) {
        // Use JSZip if available, otherwise download individually
        if (typeof JSZip !== 'undefined') {
            const zip = new JSZip();
            for (const [code, qData] of Object.entries(questions)) {
                zip.file(qData.suggested_filename, JSON.stringify(qData.prism_json, null, 2));
            }
            const blob = await zip.generateAsync({type: 'blob'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'limesurvey_question_templates.zip';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        } else {
            // Fallback: download each file individually
            for (const [code, qData] of Object.entries(questions)) {
                downloadJson(qData.prism_json, qData.suggested_filename);
                await new Promise(r => setTimeout(r, 300)); // Small delay between downloads
            }
        }
    }

    // --- Save to Project handlers ---
    async function saveTemplatesToProject(templates) {
        try {
            const response = await fetch('/api/limesurvey-save-to-project', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ templates })
            });
            const data = await response.json();

            if (data.success) {
                lssSaveSuccessMessage.textContent = `Saved ${data.saved_count} template(s) to ${data.library_path}`;
                lssSaveSuccess.classList.remove('d-none');
                return true;
            } else {
                alert('Error: ' + (data.error || 'Failed to save templates'));
                return false;
            }
        } catch (err) {
            alert('Error saving to project: ' + err.message);
            return false;
        }
    }

    // Save groups to project
    if (lssSaveGroupsToProjectBtn) {
        lssSaveGroupsToProjectBtn.addEventListener('click', async function() {
            if (!lssQuestionnaires) return;

            const templates = Object.entries(lssQuestionnaires).map(([name, qData]) => ({
                filename: qData.suggested_filename,
                content: qData.prism_json
            }));

            lssSaveGroupsToProjectBtn.disabled = true;
            lssSaveGroupsToProjectBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';

            await saveTemplatesToProject(templates);

            lssSaveGroupsToProjectBtn.disabled = false;
            lssSaveGroupsToProjectBtn.innerHTML = '<i class="fas fa-folder-plus me-1"></i>Save to Project';
        });
    }

    // Save individual questions to project
    if (lssSaveQuestionsToProjectBtn) {
        lssSaveQuestionsToProjectBtn.addEventListener('click', async function() {
            if (!lssIndividualQuestions) return;

            const templates = Object.entries(lssIndividualQuestions).map(([code, qData]) => ({
                filename: qData.suggested_filename,
                content: qData.prism_json
            }));

            lssSaveQuestionsToProjectBtn.disabled = true;
            lssSaveQuestionsToProjectBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';

            await saveTemplatesToProject(templates);

            lssSaveQuestionsToProjectBtn.disabled = false;
            lssSaveQuestionsToProjectBtn.innerHTML = '<i class="fas fa-folder-plus me-1"></i>Save to Project';
        });
    }

    // --- Landgig: Survey Convert ---
    const convertLibraryPathInput = document.getElementById('convertLibraryPath');
    const convertBrowseLibraryBtn = document.getElementById('convertBrowseLibraryBtn');
    const convertExcelFile = document.getElementById('convertExcelFile');
    const convertIdMapFile = document.getElementById('convertIdMapFile');
    const convertBtn = document.getElementById('convertBtn');
    const previewBtn = document.getElementById('previewBtn');
    const convertDatasetName = document.getElementById('convertDatasetName');
    const convertUnknown = document.getElementById('convertUnknown');
    const convertLanguage = document.getElementById('convertLanguage');
    const convertError = document.getElementById('convertError');
    const convertInfo = document.getElementById('convertInfo');

    // Validate ID map immediately on selection (basic sanity: 2 columns, some rows)
    // Use FileReader instead of file.text() to avoid consuming the file stream
    async function validateIdMapFile(file) {
        if (!file) return true;
        try {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const text = e.target.result;
                        const first = (text || '').split(/\r?\n/).filter(Boolean).slice(0, 5);
                        if (!first.length) throw new Error('File is empty');
                        const detectSep = (line) => (line.includes('\t') ? '\t' : (line.includes(',') ? ',' : null));
                        let sep = detectSep(first[0]);
                        if (!sep && first[1]) sep = detectSep(first[1]);
                        if (!sep) throw new Error('Could not detect delimiter (expected tab or comma)');
                        const cols = first[0].split(sep);
                        if (cols.length < 2) throw new Error('Need at least two columns (source, participant_id)');
                        if (first.length < 2) throw new Error('File has header only; add mapping rows');
                        convertError.classList.add('d-none');
                        convertError.textContent = '';
                        resolve(true);
                    } catch (err) {
                        convertError.classList.remove('d-none');
                        convertError.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>ID map error: ${err.message}`;
                        resolve(false);
                    }
                };
                reader.onerror = () => {
                    convertError.classList.remove('d-none');
                    convertError.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>Could not read ID map file`;
                    resolve(false);
                };
                reader.readAsText(file);
            });
        } catch (e) {
            convertError.classList.remove('d-none');
            convertError.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>ID map error: ${e.message}`;
            return false;
        }
    }

    if (convertIdMapFile) {
        convertIdMapFile.addEventListener('change', () => {
            const f = convertIdMapFile.files && convertIdMapFile.files[0];
            if (f) {
                // Just log selection, don't validate (avoids stream issues)
                console.log(`ID map file selected: ${f.name} (${f.size} bytes)`);
            }
        });
    }

    // --- Biometrics Convert ---
    const biometricsDataFile = document.getElementById('biometricsDataFile');
    const biometricsUnknown = document.getElementById('biometricsUnknown');
    const biometricsPreviewBtn = document.getElementById('biometricsPreviewBtn');
    const biometricsConvertBtn = document.getElementById('biometricsConvertBtn');
    const biometricsError = document.getElementById('biometricsError');
    const biometricsInfo = document.getElementById('biometricsInfo');

    // --- Physio Convert (Single) ---
    const physioRawFile = document.getElementById('physioRawFile');
    const physioTask = document.getElementById('physioTask');
    const physioSamplingRate = document.getElementById('physioSamplingRate');
    const physioConvertBtn = document.getElementById('physioConvertBtn');
    const physioError = document.getElementById('physioError');
    const physioInfo = document.getElementById('physioInfo');

    // --- Physio Convert (Batch) ---
    const physioBatchFiles = document.getElementById('physioBatchFiles');
    const physioBatchDatasetName = document.getElementById('physioBatchDatasetName');
    const physioBatchSamplingRate = document.getElementById('physioBatchSamplingRate');
    const physioBatchConvertBtn = document.getElementById('physioBatchConvertBtn');
    const physioBatchError = document.getElementById('physioBatchError');
    const physioBatchInfo = document.getElementById('physioBatchInfo');
    const physioBatchProgress = document.getElementById('physioBatchProgress');
    const physioBatchLogContainer = document.getElementById('physioBatchLogContainer');
    const physioBatchLog = document.getElementById('physioBatchLog');
    const physioBatchLogClearBtn = document.getElementById('physioBatchLogClearBtn');

    // --- Eyetracking Convert (Single) ---
    const eyetrackingSingleFile = document.getElementById('eyetrackingSingleFile');
    const eyetrackingSubject = document.getElementById('eyetrackingSubject');
    const eyetrackingSession = document.getElementById('eyetrackingSession');
    const eyetrackingTask = document.getElementById('eyetrackingTask');
    const eyetrackingSingleConvertBtn = document.getElementById('eyetrackingSingleConvertBtn');
    const eyetrackingSingleError = document.getElementById('eyetrackingSingleError');
    const eyetrackingSingleInfo = document.getElementById('eyetrackingSingleInfo');

    // --- Eyetracking Convert (Batch) ---
    const eyetrackingBatchFiles = document.getElementById('eyetrackingBatchFiles');
    const eyetrackingBatchDatasetName = document.getElementById('eyetrackingBatchDatasetName');
    const eyetrackingBatchConvertBtn = document.getElementById('eyetrackingBatchConvertBtn');
    const eyetrackingBatchError = document.getElementById('eyetrackingBatchError');
    const eyetrackingBatchInfo = document.getElementById('eyetrackingBatchInfo');
    const eyetrackingBatchProgress = document.getElementById('eyetrackingBatchProgress');
    const eyetrackingBatchLogContainer = document.getElementById('eyetrackingBatchLogContainer');
    const eyetrackingBatchLog = document.getElementById('eyetrackingBatchLog');
    const eyetrackingBatchLogClearBtn = document.getElementById('eyetrackingBatchLogClearBtn');

    // --- Organize (Batch) ---
    const organizeFiles = document.getElementById('organizeFiles');
    const organizeDatasetName = document.getElementById('organizeDatasetName');
    const organizeModality = document.getElementById('organizeModality');
    const organizeBtn = document.getElementById('organizeBtn');
    const organizeError = document.getElementById('organizeError');
    const organizeInfo = document.getElementById('organizeInfo');
    const organizeProgress = document.getElementById('organizeProgress');
    const organizeLogContainer = document.getElementById('organizeLogContainer');
    const organizeLog = document.getElementById('organizeLog');
    const organizeLogClearBtn = document.getElementById('organizeLogClearBtn');

    // --- Physio Renamer ---
    const renamerFiles = document.getElementById('renamerFiles');
    const renamerPattern = document.getElementById('renamerPattern');
    const renamerReplacement = document.getElementById('renamerReplacement');
    const renamerTask = document.getElementById('renamerTask');
    const renamerDryRunBtn = document.getElementById('renamerDryRunBtn');
    const renamerDownloadBtn = document.getElementById('renamerDownloadBtn');
    const renamerResetBtn = document.getElementById('renamerResetBtn');
    const renamerPreview = document.getElementById('renamerPreview');
    const renamerPreviewBody = document.getElementById('renamerPreviewBody');
    const renamerFilterAll = document.getElementById('renamerFilterAll');
    const renamerFilterUnmatched = document.getElementById('renamerFilterUnmatched');
    const renamerError = document.getElementById('renamerError');
    const renamerInfo = document.getElementById('renamerInfo');

    if (convertBrowseLibraryBtn && convertLibraryPathInput) {
        convertBrowseLibraryBtn.addEventListener('click', function() {
            fetch('/api/browse-folder')
                .then(r => r.json())
                .then(data => {
                    if (data.path) {
                        convertLibraryPathInput.value = data.path;
                        refreshConvertLanguages();
                    } else if (data.error) {
                        alert('Folder picker unavailable: ' + data.error);
                    }
                })
                .catch(err => {
                    console.error('Browse error:', err);
                    alert('Failed to open folder picker. Please enter path manually.');
                });
        });
    }

    function downloadBase64Zip(base64Data, filename) {
        const binaryString = window.atob(base64Data);
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
        }
        const blob = new Blob([bytes], {type: 'application/zip'});
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
    }

    function refreshConvertLanguages() {
        const libraryPath = convertLibraryPathInput ? convertLibraryPathInput.value.trim() : '';
        const surveyI18nWarning = document.getElementById('surveyI18nWarning');
        const surveyI18nMessage = document.getElementById('surveyI18nMessage');
        const surveyStructureWarning = document.getElementById('surveyStructureWarning');
        const surveyStructureMessage = document.getElementById('surveyStructureMessage');
        
        if (!libraryPath) {
            // Hide warnings and reset languages if no path
            if (surveyI18nWarning) surveyI18nWarning.classList.add('d-none');
            if (surveyStructureWarning) surveyStructureWarning.classList.add('d-none');
            return;
        }
        
        const url = `/api/survey-languages?library_path=${encodeURIComponent(libraryPath)}`;
        fetch(url)
            .then(r => r.json())
            .then(data => {
                if (!convertLanguage) return;
                const current = convertLanguage.value || 'auto';

                // Reset options (keep Auto)
                convertLanguage.innerHTML = '';
                const autoOpt = document.createElement('option');
                autoOpt.value = 'auto';
                autoOpt.textContent = 'Auto (template default)';
                convertLanguage.appendChild(autoOpt);

                const langs = (data && data.languages) ? data.languages : [];
                langs.forEach(lang => {
                    const opt = document.createElement('option');
                    opt.value = lang;
                    opt.textContent = lang;
                    convertLanguage.appendChild(opt);
                });

                const preferred = (data && data.default) ? data.default : null;
                if (preferred && langs.includes(preferred)) {
                    convertLanguage.value = preferred;
                } else if (langs.includes(current)) {
                    convertLanguage.value = current;
                } else {
                    convertLanguage.value = 'auto';
                }
                
                // Show structure warning if missing folders/files
                if (surveyStructureWarning && surveyStructureMessage && data.structure) {
                    const missing = data.structure.missing_items || [];
                    if (missing.length > 0) {
                        surveyStructureMessage.textContent = `The selected folder is missing: ${missing.join(', ')}. Expected library structure: survey/, biometrics/, participants.json`;
                        surveyStructureWarning.classList.remove('d-none');
                    } else {
                        surveyStructureWarning.classList.add('d-none');
                    }
                } else if (surveyStructureWarning) {
                    surveyStructureWarning.classList.add('d-none');
                }
                
                // Show I18n warning if templates don't have multilanguage support
                if (surveyI18nWarning && surveyI18nMessage) {
                    const hasI18n = langs.length > 0;
                    const templateCount = data.template_count || 0;
                    const i18nCount = data.i18n_count || 0;
                    
                    if (!hasI18n || (templateCount > 0 && i18nCount < templateCount)) {
                        const missing = templateCount - i18nCount;
                        if (!hasI18n) {
                            surveyI18nMessage.textContent = 'No templates with multilanguage (I18n) configuration found. Consider adding I18n block with Languages array to your templates.';
                        } else if (missing > 0) {
                            surveyI18nMessage.textContent = `${missing} of ${templateCount} templates lack multilanguage (I18n) configuration. Available languages: ${langs.join(', ')}`;
                        }
                        surveyI18nWarning.classList.remove('d-none');
                    } else {
                        surveyI18nWarning.classList.add('d-none');
                    }
                }
            })
            .catch(() => {
                // If this fails, keep the dropdown as-is (Auto only)
                if (surveyI18nWarning) surveyI18nWarning.classList.add('d-none');
                if (surveyStructureWarning) surveyStructureWarning.classList.add('d-none');
            });
    }

    if (convertLibraryPathInput) {
        convertLibraryPathInput.addEventListener('change', function() {
            refreshConvertLanguages();
            updateConvertBtn();
        });
        convertLibraryPathInput.addEventListener('blur', function() {
            refreshConvertLanguages();
            updateConvertBtn();
        });
    }

    // --- Conversion Mode Elements ---
    const convertModeData = document.getElementById('convertModeData');
    const convertModeTemplate = document.getElementById('convertModeTemplate');
    const convertIdColumnGroup = document.getElementById('convertIdColumnGroup');
    const convertIdColumn = document.getElementById('convertIdColumn');
    const convertTemplateExportGroup = document.getElementById('convertTemplateExportGroup');
    const convertTemplateExport = document.getElementById('convertTemplateExport');
    const convertLanguageGroup = document.getElementById('convertLanguageGroup');
    const convertAliasGroup = document.getElementById('convertAliasGroup');
    const convertSessionGroup = document.getElementById('convertSessionGroup');
    const convertUnknownGroup = document.getElementById('convertUnknownGroup');
    const convertStrictGroup = document.getElementById('convertStrictGroup');
    const templateResultsContainer = document.getElementById('templateResultsContainer');

    // Get current conversion mode
    function getConvertMode() {
        return document.querySelector('input[name="convertMode"]:checked')?.value || 'data';
    }

    // Handle mode switching
    function handleModeSwitch() {
        const mode = getConvertMode();
        const filename = convertExcelFile.files?.[0]?.name?.toLowerCase() || '';
        const isLimeSurvey = filename.endsWith('.lss') || filename.endsWith('.lsa');

        if (mode === 'template') {
            // Template generation mode
            convertIdColumnGroup?.classList.add('d-none');
            convertTemplateExportGroup?.classList.remove('d-none');
            convertLanguageGroup?.classList.add('d-none');
            
            // Hide conversion-specific settings (not needed for templates)
            convertAliasGroup?.classList.add('d-none');
            convertSessionGroup?.classList.add('d-none');
            convertUnknownGroup?.classList.add('d-none');
            convertStrictGroup?.classList.add('d-none');

            // Hide library path requirement for template mode (not needed for structure)
            const libPathLabel = convertLibraryPathInput?.closest('.col-12')?.querySelector('.form-label');
            if (libPathLabel) {
                libPathLabel.innerHTML = 'Template Library Root <span class="text-muted">(optional)</span>';
            }
        } else {
            // Data conversion mode
            convertIdColumnGroup?.classList.remove('d-none');
            convertTemplateExportGroup?.classList.add('d-none');
            convertLanguageGroup?.classList.remove('d-none');
            
            // Show conversion-specific settings
            convertAliasGroup?.classList.remove('d-none');
            convertSessionGroup?.classList.remove('d-none');
            convertUnknownGroup?.classList.remove('d-none');
            convertStrictGroup?.classList.remove('d-none');

            // Show library path as required
            const libPathLabel = convertLibraryPathInput?.closest('.col-12')?.querySelector('.form-label');
            if (libPathLabel) {
                libPathLabel.innerHTML = 'Template Library Root <span class="text-danger">*</span>';
            }
        }

        updateConvertBtn();
    }

    // Mode switch listeners
    if (convertModeData) {
        convertModeData.addEventListener('change', handleModeSwitch);
    }
    if (convertModeTemplate) {
        convertModeTemplate.addEventListener('change', handleModeSwitch);
    }

    // Detect columns from file for ID column selector
    async function detectFileColumns(file) {
        const filename = file.name.toLowerCase();
        const idColumnSelect = document.getElementById('convertIdColumn');
        const idColumnStatus = document.getElementById('idColumnStatus');
        const idColumnHelp = document.getElementById('idColumnHelp');
        if (!idColumnSelect) return;

        // Reset to auto-detect
        idColumnSelect.innerHTML = '<option value="auto" selected>Auto-detect</option>';

        // For .lss files, no columns to detect (structure only)
        if (filename.endsWith('.lss')) {
            if (idColumnStatus) idColumnStatus.innerHTML = '<span class="text-muted">(structure only)</span>';
            if (idColumnHelp) idColumnHelp.innerHTML = '<i class="fas fa-info-circle me-1"></i>.lss files have no response data';
            return;
        }

        // Show loading status
        if (idColumnStatus) idColumnStatus.innerHTML = '<span class="text-info"><i class="fas fa-spinner fa-spin me-1"></i>Loading...</span>';

        // For .lsa and other files, try to detect columns
        if (filename.endsWith('.lsa') || filename.endsWith('.xlsx') || filename.endsWith('.csv') || filename.endsWith('.tsv')) {
            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/api/detect-columns', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.columns && data.columns.length > 0) {
                        // Add detected columns
                        data.columns.forEach(col => {
                            const opt = document.createElement('option');
                            opt.value = col;
                            opt.textContent = col;
                            // Pre-select likely ID columns
                            if (['participant_id', 'id', 'code', 'token', 'subject'].includes(col.toLowerCase())) {
                                opt.textContent += ' â˜…';
                            }
                            idColumnSelect.appendChild(opt);
                        });

                        // If suggested column exists, pre-select it
                        if (data.suggested_id_column) {
                            idColumnSelect.value = data.suggested_id_column;
                        }

                        // Update status
                        if (idColumnStatus) {
                            idColumnStatus.innerHTML = `<span class="text-success"><i class="fas fa-check me-1"></i>${data.columns.length} columns</span>`;
                        }
                        if (idColumnHelp) {
                            idColumnHelp.innerHTML = data.suggested_id_column
                                ? `<i class="fas fa-lightbulb me-1 text-warning"></i>Suggested: <strong>${data.suggested_id_column}</strong> (â˜… = likely ID columns)`
                                : '<i class="fas fa-exclamation-triangle me-1 text-warning"></i>No common ID column found. Please select manually.';
                        }
                    } else {
                        if (idColumnStatus) idColumnStatus.innerHTML = '<span class="text-warning">No columns found</span>';
                    }
                } else {
                    try {
                        const err = await response.json();
                        console.error('Server returned error:', response.status, err);
                        if (idColumnStatus) idColumnStatus.innerHTML = `<span class="text-danger">${err.error || 'Error'}</span>`;
                    } catch (jsonError) {
                        console.error('Failed to parse error response:', response.status, jsonError);
                        if (idColumnStatus) idColumnStatus.innerHTML = `<span class="text-danger">Server error (${response.status})</span>`;
                    }
                }
            } catch (e) {
                console.error('Failed to detect columns:', e.message, e.stack);
                if (idColumnStatus) idColumnStatus.innerHTML = '<span class="text-danger">Failed to load</span>';
            }
        }
    }

    function updateConvertBtn() {
        const hasFile = convertExcelFile.files && convertExcelFile.files.length === 1;
        const mode = getConvertMode();

        // Both modes only need a file now (library path is resolved automatically)
        convertBtn.disabled = !hasFile;
        
        // Preview button is only available in data conversion mode
        if (previewBtn) {
            if (mode === 'template') {
                previewBtn.disabled = true;
                previewBtn.style.display = 'none';
                // Make convert button full width in template mode
                convertBtn.parentElement.classList.remove('col-md-6');
                convertBtn.parentElement.classList.add('col-12');
            } else {
                previewBtn.disabled = !hasFile;
                previewBtn.style.display = '';
                // Restore split layout in data conversion mode
                convertBtn.parentElement.classList.remove('col-12');
                convertBtn.parentElement.classList.add('col-md-6');
            }
        }

        // Update button text based on mode
        if (convertBtn) {
            if (mode === 'template') {
                convertBtn.innerHTML = '<i class="fas fa-file-code me-2"></i>Generate Template';
                convertBtn.classList.remove('btn-warning');
                convertBtn.classList.add('btn-success');
            } else {
                convertBtn.innerHTML = '<i class="fas fa-wand-magic-sparkles me-2"></i>Convert';
                convertBtn.classList.remove('btn-success');
                convertBtn.classList.add('btn-warning');
            }
        }
    }

    convertExcelFile.addEventListener('change', async function() {
        const file = this.files?.[0];
        if (file) {
            const filename = file.name.toLowerCase();

            // Auto-switch to template mode for .lss files (structure only, no data)
            if (filename.endsWith('.lss')) {
                if (convertModeTemplate) {
                    convertModeTemplate.checked = true;
                    handleModeSwitch();
                }
                // Show info message
                convertInfo.innerHTML = '<i class="fas fa-info-circle me-1"></i>.lss files contain structure only (no response data). Using Template Generation mode.';
                convertInfo.classList.remove('d-none');
            } else {
                convertInfo.classList.add('d-none');
            }

            // Detect columns for ID selection
            await detectFileColumns(file);
        }
        updateConvertBtn();
    });

    // Initialize mode on page load
    handleModeSwitch();
    updateConvertBtn();

    // Terminal log elements
    const conversionLogContainer = document.getElementById('conversionLogContainer');
    const conversionLog = document.getElementById('conversionLog');
    const conversionLogBody = document.getElementById('conversionLogBody');
    const toggleLogBtn = document.getElementById('toggleLogBtn');
    const validationResultsContainer = document.getElementById('validationResultsContainer');
    const validationResultsCard = document.getElementById('validationResultsCard');
    const validationResultsHeader = document.getElementById('validationResultsHeader');
    const validationBadge = document.getElementById('validationBadge');
    const validationSummary = document.getElementById('validationSummary');
    const validationDetails = document.getElementById('validationDetails');
    const downloadSection = document.getElementById('downloadSection');
    const downloadWarningSection = document.getElementById('downloadWarningSection');
    const downloadZipBtn = document.getElementById('downloadZipBtn');
    const downloadZipWarningBtn = document.getElementById('downloadZipWarningBtn');

    // Biometrics elements
    const biometricsLogContainer = document.getElementById('biometricsLogContainer');
    const biometricsLog = document.getElementById('biometricsLog');
    const biometricsLogBody = document.getElementById('biometricsLogBody');
    const toggleBiometricsLogBtn = document.getElementById('toggleBiometricsLogBtn');
    const biometricsValidationResultsContainer = document.getElementById('biometricsValidationResultsContainer');
    const biometricsValidationResultsCard = document.getElementById('biometricsValidationResultsCard');
    const biometricsValidationResultsHeader = document.getElementById('biometricsValidationResultsHeader');
    const biometricsValidationBadge = document.getElementById('biometricsValidationBadge');
    const biometricsValidationSummary = document.getElementById('biometricsValidationSummary');
    const biometricsValidationDetails = document.getElementById('biometricsValidationDetails');
    const biometricsDownloadSection = document.getElementById('biometricsDownloadSection');
    const biometricsDownloadWarningSection = document.getElementById('biometricsDownloadWarningSection');
    const biometricsDownloadZipBtn = document.getElementById('biometricsDownloadZipBtn');
    const biometricsDownloadZipWarningBtn = document.getElementById('biometricsDownloadZipWarningBtn');
    const biometricsDetectedContainer = document.getElementById('biometricsDetectedContainer');
    const biometricsDetectedList = document.getElementById('biometricsDetectedList');
    const biometricsConfirmBtn = document.getElementById('biometricsConfirmBtn');
    const biometricsSelectAll = document.getElementById('biometricsSelectAll');

    let currentZipBlob = null;
    let currentBiometricsZipBlob = null;

    // Toggle log visibility
    if (toggleLogBtn) {
        toggleLogBtn.addEventListener('click', function() {
            conversionLogBody.classList.toggle('d-none');
            const icon = toggleLogBtn.querySelector('i');
            if (conversionLogBody.classList.contains('d-none')) {
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-right');
            } else {
                icon.classList.remove('fa-chevron-right');
                icon.classList.add('fa-chevron-down');
            }
        });
    }

    if (toggleBiometricsLogBtn) {
        toggleBiometricsLogBtn.addEventListener('click', function() {
            biometricsLogBody.classList.toggle('d-none');
            const icon = toggleBiometricsLogBtn.querySelector('i');
            if (biometricsLogBody.classList.contains('d-none')) {
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-right');
            } else {
                icon.classList.remove('fa-chevron-right');
                icon.classList.add('fa-chevron-down');
            }
        });
    }

    function appendLog(message, type = 'info', logElement = null) {
        const colors = {
            'info': '#17a2b8',
            'success': '#28a745',
            'warning': '#ffc107',
            'error': '#dc3545',
            'step': '#6c757d'
        };
        const targetLog = logElement || conversionLog;
        if (!targetLog) return;

        const timestamp = new Date().toLocaleTimeString();
        const color = colors[type] || colors.info;
        targetLog.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
        targetLog.scrollTop = targetLog.scrollHeight;
    }

    function resetConversionUI() {
        conversionLogContainer.classList.add('d-none');
        validationResultsContainer.classList.add('d-none');
        downloadSection.classList.add('d-none');
        downloadWarningSection.classList.add('d-none');
        conversionLog.innerHTML = '';
        validationSummary.innerHTML = '';
        validationDetails.innerHTML = '';
        currentZipBlob = null;
    }

    function resetBiometricsUI() {
        biometricsLogContainer.classList.add('d-none');
        biometricsValidationResultsContainer.classList.add('d-none');
        biometricsDownloadSection.classList.add('d-none');
        biometricsDownloadWarningSection.classList.add('d-none');
        biometricsDetectedContainer.classList.add('d-none');
        biometricsLog.innerHTML = '';
        biometricsValidationSummary.innerHTML = '';
        biometricsValidationDetails.innerHTML = '';
        biometricsDetectedList.innerHTML = '';
        currentBiometricsZipBlob = null;
    }

    function displayValidationResults(validation, prefix = '') {
        const getEl = (id) => document.getElementById(prefix ? prefix + id.charAt(0).toUpperCase() + id.slice(1) : id);
        
        const container = getEl('validationResultsContainer');
        const card = getEl('validationResultsCard');
        const header = getEl('validationResultsHeader');
        const badge = getEl('validationBadge');
        const summaryEl = getEl('validationSummary');
        const detailsEl = getEl('validationDetails');
        const dlSection = getEl('downloadSection');
        const dlWarningSection = getEl('downloadWarningSection');

        if (!container) return;
        container.classList.remove('d-none');
        
        const errors = validation.errors || [];
        const warnings = validation.warnings || [];
        const isValid = errors.length === 0;
        
        // Update card styling based on result
        card.classList.remove('border-success', 'border-warning', 'border-danger');
        header.classList.remove('bg-success', 'bg-warning', 'bg-danger', 'text-white', 'text-dark');
        
        if (isValid && warnings.length === 0) {
            card.classList.add('border-success');
            header.classList.add('bg-success', 'text-white');
            badge.className = 'badge bg-light text-success';
            badge.textContent = 'âœ“ Valid';
        } else if (isValid) {
            card.classList.add('border-warning');
            header.classList.add('bg-warning', 'text-dark');
            badge.className = 'badge bg-light text-warning';
            badge.textContent = `âš  ${warnings.length} Warning(s)`;
        } else {
            card.classList.add('border-danger');
            header.classList.add('bg-danger', 'text-white');
            badge.className = 'badge bg-light text-danger';
            badge.textContent = `âœ— ${errors.length} Error(s)`;
        }
        
        // Summary
        const summary = validation.summary || {};
        summaryEl.innerHTML = `
            <div class="row text-center">
                <div class="col-4">
                    <div class="h4 mb-0 ${errors.length > 0 ? 'text-danger' : 'text-success'}">${errors.length}</div>
                    <small class="text-muted">Errors</small>
                </div>
                <div class="col-4">
                    <div class="h4 mb-0 ${warnings.length > 0 ? 'text-warning' : 'text-success'}">${warnings.length}</div>
                    <small class="text-muted">Warnings</small>
                </div>
                <div class="col-4">
                    <div class="h4 mb-0 text-info">${summary.total_files || summary.files_created || 'n/a'}</div>
                    <small class="text-muted">Files</small>
                </div>
            </div>
        `;
        
        // Details
        let detailsHtml = '';
        
        if (validation.formatted) {
            const f = validation.formatted;
            
            if (f.errors && f.errors.length > 0) {
                detailsHtml += '<h6 class="text-danger mt-3"><i class="fas fa-times-circle me-1"></i>Errors</h6>';
                f.errors.forEach(group => {
                    detailsHtml += `
                        <div class="validation-group mb-3 p-3 border rounded bg-light shadow-sm">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="fw-bold text-danger">
                                    <span class="badge bg-danger me-2">${group.code}</span>
                                    ${escapeHtml(group.message)}
                                </div>
                                ${group.documentation_url ? `
                                    <a href="${group.documentation_url}" target="_blank" class="btn btn-sm btn-outline-primary py-0 px-2" style="font-size: 0.75rem;">
                                        <i class="fas fa-book me-1"></i>Docs
                                    </a>
                                ` : ''}
                            </div>
                            
                            ${group.fix_hint ? `
                                <div class="alert alert-info py-2 px-3 mb-2 smaller">
                                    <i class="fas fa-lightbulb me-2 text-warning"></i>
                                    <strong>Fix Hint:</strong> ${escapeHtml(group.fix_hint)}
                                </div>
                            ` : ''}

                            <ul class="list-unstyled ms-2 mb-0 smaller">
                                ${(group.files || []).map(file => `
                                    <li class="mb-1 border-bottom pb-1 last-child-no-border">
                                        <div class="d-flex justify-content-between">
                                            <code class="text-dark fw-bold">${escapeHtml(file.file || 'unknown')}</code>
                                            ${file.line ? `<span class="badge bg-secondary">Line ${file.line}</span>` : ''}
                                        </div>
                                        ${file.message && file.message !== group.message ? `<div class="text-muted mt-1">${escapeHtml(file.message)}</div>` : ''}
                                        ${file.evidence ? `<div class="text-muted italic ms-2 mt-1 p-1 bg-white border rounded" style="font-size: 0.85em; font-family: monospace;">${escapeHtml(file.evidence)}</div>` : ''}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    `;
                });
            }
            
            if (f.warnings && f.warnings.length > 0) {
                detailsHtml += '<h6 class="text-warning mt-3"><i class="fas fa-exclamation-triangle me-1"></i>Warnings</h6>';
                f.warnings.forEach(group => {
                    detailsHtml += `
                        <div class="validation-group mb-3 p-3 border rounded bg-light shadow-sm">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="fw-bold text-warning">
                                    <span class="badge bg-warning text-dark me-2">${group.code}</span>
                                    ${escapeHtml(group.message)}
                                </div>
                                ${group.documentation_url ? `
                                    <a href="${group.documentation_url}" target="_blank" class="btn btn-sm btn-outline-primary py-0 px-2" style="font-size: 0.75rem;">
                                        <i class="fas fa-book me-1"></i>Docs
                                    </a>
                                ` : ''}
                            </div>

                            ${group.fix_hint ? `
                                <div class="alert alert-info py-2 px-3 mb-2 smaller">
                                    <i class="fas fa-lightbulb me-2 text-warning"></i>
                                    <strong>Fix Hint:</strong> ${escapeHtml(group.fix_hint)}
                                </div>
                            ` : ''}

                            <ul class="list-unstyled ms-2 mb-0 smaller">
                                ${(group.files || []).map(file => `
                                    <li class="mb-1 border-bottom pb-1 last-child-no-border">
                                        <div class="d-flex justify-content-between">
                                            <code class="text-dark fw-bold">${escapeHtml(file.file || 'unknown')}</code>
                                            ${file.line ? `<span class="badge bg-secondary">Line ${file.line}</span>` : ''}
                                        </div>
                                        ${file.message && file.message !== group.message ? `<div class="text-muted mt-1">${escapeHtml(file.message)}</div>` : ''}
                                        ${file.evidence ? `<div class="text-muted italic ms-2 mt-1 p-1 bg-white border rounded" style="font-size: 0.85em; font-family: monospace;">${escapeHtml(file.evidence)}</div>` : ''}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    `;
                });
            }
        } else {
            // Fallback to old list
            if (errors.length > 0) {
                detailsHtml += '<h6 class="text-danger mt-3"><i class="fas fa-times-circle me-1"></i>Errors</h6><ul class="list-unstyled">';
                errors.forEach(e => {
                    detailsHtml += `<li class="text-danger small"><i class="fas fa-times me-1"></i>${escapeHtml(e)}</li>`;
                });
                detailsHtml += '</ul>';
            }
            if (warnings.length > 0) {
                detailsHtml += '<h6 class="text-warning mt-3"><i class="fas fa-exclamation-triangle me-1"></i>Warnings</h6><ul class="list-unstyled">';
                warnings.forEach(w => {
                    detailsHtml += `<li class="text-warning small"><i class="fas fa-exclamation me-1"></i>${escapeHtml(w)}</li>`;
                });
                detailsHtml += '</ul>';
            }
        }
        
        detailsEl.innerHTML = detailsHtml;
        
        // Show appropriate download button
        if (isValid && warnings.length === 0) {
            dlSection.classList.remove('d-none');
            dlWarningSection.classList.add('d-none');
        } else if (isValid) {
            dlSection.classList.add('d-none');
            dlWarningSection.classList.remove('d-none');
        } else {
            dlSection.classList.add('d-none');
            dlWarningSection.classList.add('d-none');
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function downloadCurrentZip() {
        if (!currentZipBlob) return;
        const url = window.URL.createObjectURL(currentZipBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'prism_survey_dataset.zip';
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
    }

    if (downloadZipBtn) {
        downloadZipBtn.addEventListener('click', downloadCurrentZip);
    }
    if (downloadZipWarningBtn) {
        downloadZipWarningBtn.addEventListener('click', downloadCurrentZip);
    }

    // Store template results for download
    let currentTemplateData = null;

    // Handle template generation (structure only, no data)
    async function handleTemplateGeneration(file) {
        const exportMode = document.getElementById('convertTemplateExport')?.value || 'groups';
        const taskName = document.getElementById('convertDatasetName')?.value.trim() || '';

        convertBtn.disabled = true;
        convertError.classList.add('d-none');
        convertInfo.classList.add('d-none');

        // Show and clear logs
        if (conversionLogContainer) {
            conversionLogContainer.classList.remove('d-none');
        }
        if (conversionLog) {
            conversionLog.innerHTML = '';
        }

        try {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('mode', exportMode);
            if (taskName) {
                formData.append('task_name', taskName);
            }

            const response = await fetch('/api/limesurvey-to-prism', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            // Process logs if returned
            if (data.log && Array.isArray(data.log)) {
                data.log.forEach(entry => {
                    appendLog(entry.message, entry.type, conversionLog);
                });
            }

            if (!response.ok || data.error) {
                throw new Error(data.error || 'Template generation failed');
            }

            currentTemplateData = data;

            // Show results container
            if (templateResultsContainer) {
                templateResultsContainer.classList.remove('d-none');
            }

            // Display results based on mode
            if (data.mode === 'combined') {
                displayTemplateSingle(data);
            } else if (data.mode === 'groups') {
                displayTemplateGroups(data);
            } else if (data.mode === 'questions') {
                displayTemplateQuestions(data);
            }

            // Show participant metadata section for marking fields
            displayParticipantMetadataSection(data);

            convertInfo.textContent = 'Template generation complete!';
            convertInfo.classList.remove('d-none');

        } catch (err) {
            convertError.textContent = err.message;
            convertError.classList.remove('d-none');
            appendLog(`Error: ${err.message}`, 'error', conversionLog);
        } finally {
            updateConvertBtn();
        }
    }

    function displayTemplateSingle(data) {
        const container = document.getElementById('templateResultSingle');
        if (!container) return;

        container.classList.remove('d-none');
        document.getElementById('templateQuestionCount').textContent = `${data.question_count} questions`;

        // Setup preview button
        const previewBtn = document.getElementById('templatePreviewBtn');
        const previewDiv = document.getElementById('templatePreview');
        const previewContent = document.getElementById('templatePreviewContent');

        if (previewBtn && previewDiv && previewContent) {
            previewBtn.onclick = () => {
                previewDiv.classList.toggle('d-none');
                previewContent.textContent = JSON.stringify(data.prism_json, null, 2);
            };
        }

        // Setup download button
        const downloadBtn = document.getElementById('templateDownloadBtn');
        if (downloadBtn) {
            downloadBtn.onclick = () => {
                const blob = new Blob([JSON.stringify(data.prism_json, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = data.suggested_filename || 'survey-template.json';
                a.click();
                URL.revokeObjectURL(url);
            };
        }
    }

    function displayTemplateGroups(data) {
        const container = document.getElementById('templateResultGroups');
        if (!container) return;

        container.classList.remove('d-none');
        document.getElementById('templateGroupCount').textContent = `${data.questionnaire_count} groups`;
        document.getElementById('templateTotalQuestions').textContent = `${data.total_questions} questions`;

        const listEl = document.getElementById('templateGroupList');
        if (listEl) {
            listEl.innerHTML = '';
            for (const [name, info] of Object.entries(data.questionnaires || {})) {
                const card = document.createElement('div');
                card.className = 'col-md-4';
                card.innerHTML = `
                    <div class="card h-100">
                        <div class="card-body py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${name}</strong>
                                    <small class="d-block text-muted">${info.question_count} questions</small>
                                </div>
                                <button class="btn btn-sm btn-outline-success download-template-btn" data-name="${name}">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                listEl.appendChild(card);
            }

            // Add download handlers
            listEl.querySelectorAll('.download-template-btn').forEach(btn => {
                btn.onclick = () => {
                    const name = btn.dataset.name;
                    const info = data.questionnaires[name];
                    if (info) {
                        const blob = new Blob([JSON.stringify(info.prism_json, null, 2)], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = info.suggested_filename || `survey-${name}.json`;
                        a.click();
                        URL.revokeObjectURL(url);
                    }
                };
            });
        }

        // Download all as ZIP
        const downloadAllBtn = document.getElementById('templateDownloadAllBtn');
        if (downloadAllBtn) {
            downloadAllBtn.onclick = async () => {
                const JSZip = window.JSZip;
                if (!JSZip) {
                    alert('JSZip not loaded');
                    return;
                }
                const zip = new JSZip();
                for (const [name, info] of Object.entries(data.questionnaires || {})) {
                    zip.file(info.suggested_filename || `survey-${name}.json`, JSON.stringify(info.prism_json, null, 2));
                }
                const blob = await zip.generateAsync({ type: 'blob' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'survey-templates.zip';
                a.click();
                URL.revokeObjectURL(url);
            };
        }

        // Save to project button
        setupTemplateSaveToProject(data, 'groups');
    }

    function displayTemplateQuestions(data) {
        const container = document.getElementById('templateResultQuestions');
        if (!container) return;

        container.classList.remove('d-none');
        document.getElementById('templateIndividualCount').textContent = `${data.question_count} templates`;

        const listEl = document.getElementById('templateQuestionsList');
        if (listEl) {
            listEl.innerHTML = '';
            for (const [groupName, groupInfo] of Object.entries(data.by_group || {})) {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'col-12 mb-2';
                groupDiv.innerHTML = `<h6 class="text-muted">${groupName}</h6>`;
                listEl.appendChild(groupDiv);

                for (const q of groupInfo.questions || []) {
                    const qData = data.questions[q.code];
                    if (!qData) continue;

                    const card = document.createElement('div');
                    card.className = 'col-md-3';
                    card.innerHTML = `
                        <div class="card h-100">
                            <div class="card-body py-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>${q.code}</strong>
                                        <small class="d-block text-muted">${q.type} (${q.item_count} items)</small>
                                    </div>
                                    <button class="btn btn-sm btn-outline-success download-q-btn" data-code="${q.code}">
                                        <i class="fas fa-download"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    listEl.appendChild(card);
                }
            }

            // Add download handlers
            listEl.querySelectorAll('.download-q-btn').forEach(btn => {
                btn.onclick = () => {
                    const code = btn.dataset.code;
                    const qData = data.questions[code];
                    if (qData && qData.prism_json) {
                        const blob = new Blob([JSON.stringify(qData.prism_json, null, 2)], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = qData.suggested_filename || `survey-${code}.json`;
                        a.click();
                        URL.revokeObjectURL(url);
                    }
                };
            });
        }

        // Download all as ZIP
        const downloadBtn = document.getElementById('templateDownloadQuestionsBtn');
        if (downloadBtn) {
            downloadBtn.onclick = async () => {
                const JSZip = window.JSZip;
                if (!JSZip) {
                    alert('JSZip not loaded');
                    return;
                }
                const zip = new JSZip();
                for (const [code, qData] of Object.entries(data.questions || {})) {
                    if (qData.prism_json) {
                        zip.file(qData.suggested_filename || `survey-${code}.json`, JSON.stringify(qData.prism_json, null, 2));
                    }
                }
                const blob = await zip.generateAsync({ type: 'blob' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'survey-question-templates.zip';
                a.click();
                URL.revokeObjectURL(url);
            };
        }

        // Save to project button
        setupTemplateSaveToProject(data, 'questions');
    }

    function setupTemplateSaveToProject(data, mode) {
        const saveBtn = mode === 'groups'
            ? document.getElementById('templateSaveToProjectBtn')
            : document.getElementById('templateSaveQuestionsToProjectBtn');

        if (!saveBtn) return;

        saveBtn.onclick = async () => {
            const templates = [];

            if (mode === 'groups') {
                for (const [name, info] of Object.entries(data.questionnaires || {})) {
                    templates.push({
                        filename: info.suggested_filename || `survey-${name}.json`,
                        content: info.prism_json
                    });
                }
            } else {
                for (const [code, qData] of Object.entries(data.questions || {})) {
                    if (qData.prism_json) {
                        templates.push({
                            filename: qData.suggested_filename || `survey-${code}.json`,
                            content: qData.prism_json
                        });
                    }
                }
            }

            try {
                const response = await fetch('/api/limesurvey-save-to-project', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ templates })
                });
                const result = await response.json();

                const successDiv = document.getElementById('templateSaveSuccess');
                const msgSpan = document.getElementById('templateSaveSuccessMessage');
                if (result.success) {
                    successDiv?.classList.remove('d-none');
                    msgSpan.textContent = `Saved ${result.saved_files?.length || templates.length} templates to project library!`;
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Error saving: ' + e.message);
            }
        };
    }

    // ===== PARTICIPANT METADATA MARKING =====

    // Store selected participant fields
    let selectedParticipantFields = {};

    // BIDS standard field suggestions for auto-mapping
    const bidsFieldMappings = {
        // Common patterns -> BIDS field names
        'participant_id': ['token', 'id', 'participant', 'subject', 'subj', 'respondent'],
        'age': ['age', 'alter', 'years_old'],
        'sex': ['sex', 'gender', 'geschlecht', 'm_f', 'male_female'],
        'handedness': ['hand', 'handed', 'handedness', 'dominant_hand'],
        'education_years': ['education', 'school', 'study_years', 'ausbildung'],
        'native_language': ['language', 'native', 'mother_tongue', 'muttersprache']
    };

    // Display participant metadata section with extracted fields
    function displayParticipantMetadataSection(data) {
        const section = document.getElementById('participantMetadataSection');
        const fieldsList = document.getElementById('participantFieldsList');
        if (!section || !fieldsList) return;

        // Extract all question codes/fields from the template data
        const allFields = extractAllFields(data);

        if (allFields.length === 0) {
            section.classList.add('d-none');
            return;
        }

        section.classList.remove('d-none');
        selectedParticipantFields = {};

        // Render field checkboxes
        let html = '<div class="list-group list-group-flush">';
        for (const field of allFields) {
            const suggestedMapping = suggestBidsMapping(field.code);
            html += `
                <label class="list-group-item list-group-item-action py-2 d-flex align-items-center">
                    <input type="checkbox" class="form-check-input me-2 participant-field-checkbox"
                           data-code="${field.code}" data-description="${field.description || ''}"
                           data-type="${field.type || 'text'}">
                    <div class="flex-grow-1">
                        <code class="me-2">${field.code}</code>
                        <small class="text-muted">${field.description || field.type || ''}</small>
                        ${field.group ? `<span class="badge bg-light text-dark ms-2">${field.group}</span>` : ''}
                    </div>
                    ${suggestedMapping ? `
                        <select class="form-select form-select-sm bids-mapping-select" style="width: 140px;" data-code="${field.code}">
                            <option value="">Map to...</option>
                            <option value="${suggestedMapping}" selected>${suggestedMapping}</option>
                            <option value="participant_id">participant_id</option>
                            <option value="age">age</option>
                            <option value="sex">sex</option>
                            <option value="handedness">handedness</option>
                            <option value="custom">Custom name</option>
                        </select>
                    ` : `
                        <select class="form-select form-select-sm bids-mapping-select" style="width: 140px;" data-code="${field.code}">
                            <option value="">Map to...</option>
                            <option value="participant_id">participant_id</option>
                            <option value="age">age</option>
                            <option value="sex">sex</option>
                            <option value="handedness">handedness</option>
                            <option value="education_years">education_years</option>
                            <option value="custom">Custom name</option>
                        </select>
                    `}
                </label>
            `;
        }
        html += '</div>';
        fieldsList.innerHTML = html;

        // Add event listeners
        fieldsList.querySelectorAll('.participant-field-checkbox').forEach(cb => {
            cb.addEventListener('change', updateParticipantFieldSelection);
        });

        fieldsList.querySelectorAll('.bids-mapping-select').forEach(sel => {
            sel.addEventListener('change', function() {
                const code = this.dataset.code;
                const checkbox = fieldsList.querySelector(`.participant-field-checkbox[data-code="${code}"]`);
                if (this.value && checkbox && !checkbox.checked) {
                    checkbox.checked = true;
                    updateParticipantFieldSelection();
                }
            });
        });

        // Setup save/download button
        setupParticipantsSaveButton();
    }

    // Extract all fields from template data (works for all modes)
    function extractAllFields(data) {
        const fields = [];

        if (data.mode === 'combined' || data.mode === 'groups') {
            // Extract from prism_json Items
            const sources = data.mode === 'combined'
                ? [{ json: data.prism_json, group: null }]
                : Object.entries(data.questionnaires || {}).map(([name, info]) => ({ json: info.prism_json, group: name }));

            for (const source of sources) {
                const items = source.json?.Items || [];
                for (const item of items) {
                    if (item.SurveyItemID) {
                        fields.push({
                            code: item.SurveyItemID,
                            description: item.Prompt || item.Description || '',
                            type: item.ResponseType || 'text',
                            group: source.group
                        });
                    }
                }
            }
        } else if (data.mode === 'questions') {
            // Extract from by_group structure
            for (const [groupName, groupInfo] of Object.entries(data.by_group || {})) {
                for (const q of groupInfo.questions || []) {
                    fields.push({
                        code: q.code,
                        description: q.title || '',
                        type: q.type || 'text',
                        group: groupName
                    });
                }
            }
        }

        return fields;
    }

    // Suggest BIDS field mapping based on field code
    function suggestBidsMapping(code) {
        const lowerCode = code.toLowerCase();
        for (const [bidsField, patterns] of Object.entries(bidsFieldMappings)) {
            for (const pattern of patterns) {
                if (lowerCode.includes(pattern)) {
                    return bidsField;
                }
            }
        }
        return null;
    }

    // Update selection state and count
    function updateParticipantFieldSelection() {
        selectedParticipantFields = {};
        const checkboxes = document.querySelectorAll('.participant-field-checkbox:checked');

        checkboxes.forEach(cb => {
            const code = cb.dataset.code;
            const description = cb.dataset.description;
            const mappingSelect = document.querySelector(`.bids-mapping-select[data-code="${code}"]`);
            const bidsName = mappingSelect?.value || code;

            selectedParticipantFields[code] = {
                originalCode: code,
                bidsFieldName: bidsName || code,
                description: description
            };
        });

        // Update count
        const countEl = document.getElementById('selectedParticipantFieldsCount');
        if (countEl) {
            countEl.textContent = Object.keys(selectedParticipantFields).length;
        }

        // Enable/disable save button
        const saveBtn = document.getElementById('saveParticipantsJsonBtn') || document.getElementById('downloadParticipantsJsonBtn');
        if (saveBtn) {
            saveBtn.disabled = Object.keys(selectedParticipantFields).length === 0;
        }
    }

    // Build participants.json schema from selections
    function buildParticipantsJsonSchema() {
        const schema = {};

        for (const [code, info] of Object.entries(selectedParticipantFields)) {
            const fieldName = info.bidsFieldName || code;

            // Get description from original data
            schema[fieldName] = {
                Description: info.description || `Extracted from survey field: ${code}`
            };

            // Add standard properties for known BIDS fields
            if (fieldName === 'age') {
                schema[fieldName].Unit = 'years';
            } else if (fieldName === 'sex') {
                schema[fieldName].Levels = {
                    'M': 'Male',
                    'F': 'Female',
                    'O': 'Other'
                };
            } else if (fieldName === 'handedness') {
                schema[fieldName].Levels = {
                    'R': 'Right',
                    'L': 'Left',
                    'A': 'Ambidextrous'
                };
            }

            // Store source info for data conversion
            if (code !== fieldName) {
                schema[fieldName]._sourceField = code;
            }
        }

        return schema;
    }

    // Setup save/download button
    function setupParticipantsSaveButton() {
        const saveBtn = document.getElementById('saveParticipantsJsonBtn');
        const downloadBtn = document.getElementById('downloadParticipantsJsonBtn');
        const statusDiv = document.getElementById('participantsSaveStatus');

        if (saveBtn) {
            saveBtn.onclick = async () => {
                const schema = buildParticipantsJsonSchema();
                if (Object.keys(schema).length === 0) {
                    alert('No fields selected');
                    return;
                }

                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';

                try {
                    // First get existing schema to merge
                    const existingRes = await fetch('/api/projects/participants');
                    const existingData = await existingRes.json();
                    const existingSchema = existingData.success ? (existingData.schema || {}) : {};

                    // Merge new fields into existing schema
                    const mergedSchema = { ...existingSchema, ...schema };

                    // Ensure participant_id is present
                    if (!mergedSchema.participant_id) {
                        mergedSchema.participant_id = { Description: 'Unique participant identifier' };
                    }

                    // Save merged schema
                    const response = await fetch('/api/projects/participants', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ schema: mergedSchema })
                    });
                    const result = await response.json();

                    if (result.success) {
                        statusDiv.innerHTML = `<span class="text-success"><i class="fas fa-check-circle me-1"></i>Saved ${Object.keys(schema).length} fields to participants.json!</span>`;
                    } else {
                        statusDiv.innerHTML = `<span class="text-danger"><i class="fas fa-exclamation-circle me-1"></i>${result.error}</span>`;
                    }
                } catch (e) {
                    statusDiv.innerHTML = `<span class="text-danger"><i class="fas fa-exclamation-circle me-1"></i>${e.message}</span>`;
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="fas fa-save me-1"></i>Save to participants.json';
                }
            };
        }

        if (downloadBtn) {
            downloadBtn.onclick = () => {
                const schema = buildParticipantsJsonSchema();
                if (Object.keys(schema).length === 0) {
                    alert('No fields selected');
                    return;
                }

                // Ensure participant_id is present
                if (!schema.participant_id) {
                    schema.participant_id = { Description: 'Unique participant identifier' };
                }

                const blob = new Blob([JSON.stringify(schema, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'participants.json';
                a.click();
                URL.revokeObjectURL(url);
            };
        }
    }

    convertBtn.addEventListener('click', async function() {
        convertError.classList.add('d-none');
        convertInfo.classList.add('d-none');
        convertError.textContent = '';
        convertInfo.textContent = '';
        resetConversionUI();

        const sessionVal = document.getElementById('convertSession') ? document.getElementById('convertSession').value.trim() : '';

        if (!sessionVal) {
            convertError.textContent = 'Please enter a session ID (e.g., 1, 2, 3).';
            convertError.classList.remove('d-none');
            document.getElementById('convertSession')?.focus();
            return;
        }

        // Hide template results and participant metadata section
        if (templateResultsContainer) {
            templateResultsContainer.classList.add('d-none');
            document.getElementById('templateResultSingle')?.classList.add('d-none');
            document.getElementById('templateResultGroups')?.classList.add('d-none');
            document.getElementById('templateResultQuestions')?.classList.add('d-none');
            document.getElementById('participantMetadataSection')?.classList.add('d-none');
        }

        const file = convertExcelFile.files && convertExcelFile.files[0];
        if (!file) {
            return;
        }

        const mode = getConvertMode();
        const filename = file.name.toLowerCase();
        const isLssFile = filename.endsWith('.lss');
        const isLimeSurveyFile = filename.endsWith('.lss') || filename.endsWith('.lsa');

        // TEMPLATE GENERATION MODE
        if (mode === 'template') {
            handleTemplateGeneration(file);
            return;
        }

        // DATA CONVERSION MODE

        // Prevent .lss files in data mode (they don't contain response data)
        if (isLssFile) {
            convertError.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i><strong>.lss files contain structure only</strong> (no response data). Please use <strong>Template Generation</strong> mode, or upload a <strong>.lsa</strong> file (archive with responses).';
            convertError.classList.remove('d-none');
            return;
        }

        // Validate ID map before sending
        const idMap = convertIdMapFile && convertIdMapFile.files && convertIdMapFile.files[0];
        if (idMap) {
            if (idMap.size === 0) {
                convertError.classList.remove('d-none');
                convertError.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>ID map file is empty`;
                return;
            }
        }

        const formData = new FormData();
        formData.append('excel', file);
        console.log(`[CLIENT DEBUG] Excel file: ${file.name}, size: ${file.size}`);

        if (idMap) {
            console.log(`[CLIENT DEBUG] ID map file before append: ${idMap.name}, size: ${idMap.size}, type: ${idMap.type}`);
            formData.append('id_map', idMap);
            console.log(`[CLIENT DEBUG] ID map appended to FormData`);
            appendLog(`Using ID map file: ${idMap.name} (${idMap.size} bytes)`, 'step');
        }

        // Library path is now resolved automatically (project first, then global)
        formData.append('dataset_name', convertDatasetName.value.trim());
        
        // Show log container
        conversionLogContainer.classList.remove('d-none');
        conversionLogBody.classList.remove('d-none');
        const icon = toggleLogBtn.querySelector('i');
        icon.classList.remove('fa-chevron-right');
        icon.classList.add('fa-chevron-down');

        appendLog(`Starting conversion of: ${file.name}`, 'info');
        appendLog(`Using library: Project library first, then global`, 'step');
        formData.append('unknown', convertUnknown.value);

        // Always save to project's rawdata folder when a project is loaded
        formData.append('save_to_project', 'true');
        appendLog('Output will be saved to project rawdata folder', 'step');

        // Add ID column if selected
        const idColumn = document.getElementById('convertIdColumn')?.value;
        if (idColumn && idColumn !== 'auto') {
            formData.append('id_column', idColumn);
            appendLog(`Using ID column: ${idColumn}`, 'step');
        }

        formData.append('session', sessionVal);
        appendLog(`Forcing session ID: ${sessionVal}`, 'step');

        formData.append('language', convertLanguage ? convertLanguage.value : 'auto');
        formData.append('validate', 'true');  // Request validation

        const strictLevelsEl = document.getElementById('convertStrictLevels');
        if (strictLevelsEl && strictLevelsEl.checked) {
            formData.append('strict_levels', 'true');
            appendLog('Strict Levels Validation: enabled', 'step');
        }

        // Add duplicate handling option
        const duplicateHandlingEl = document.getElementById('convertDuplicateHandling');
        if (duplicateHandlingEl) {
            const dupHandling = duplicateHandlingEl.value;
            formData.append('duplicate_handling', dupHandling);
            if (dupHandling !== 'error') {
                const dupLabels = {
                    'keep_first': 'Keep first occurrence',
                    'keep_last': 'Keep last occurrence',
                    'sessions': 'Create multiple sessions'
                };
                appendLog(`Duplicate ID handling: ${dupLabels[dupHandling] || dupHandling}`, 'step');
            }
        }

        // Add sourcedata archiving option
        const archiveSourcedataEl = document.getElementById('convertArchiveSourcedata');
        if (archiveSourcedataEl && archiveSourcedataEl.checked) {
            formData.append('archive_sourcedata', 'true');
            appendLog('Will archive original file to sourcedata/', 'step');
        }

        convertBtn.disabled = true;
        appendLog('Uploading file and starting conversion...', 'info');

        fetch('/api/survey-convert-validate', {
            method: 'POST',
            body: formData,
        })
        .then(async response => {
            const contentType = response.headers.get('content-type') || '';
            let data = null;
            
            if (contentType.includes('application/json')) {
                data = await response.json();
                // Process logs even if response is not ok
                if (data.log && Array.isArray(data.log)) {
                    data.log.forEach(entry => {
                        appendLog(entry.message, entry.type || entry.level || 'info');
                    });
                }
                
                if (!response.ok) {
                    throw new Error(data.error || 'Conversion failed');
                }
                return data;
            } else {
                // Fallback: direct ZIP download (old API)
                if (!response.ok) {
                    throw new Error('Conversion failed');
                }
                const blob = await response.blob();
                return { blob, validation: null };
            }
        })
        .then(data => {
            // Logs already processed above for JSON responses
            if (data.validation) {
                const v = data.validation;
                const errorCount = (v.errors || []).length;
                const warningCount = (v.warnings || []).length;
                
                if (errorCount === 0 && warningCount === 0) {
                    appendLog('âœ“ Validation passed - dataset is valid!', 'success');
                } else if (errorCount === 0) {
                    appendLog(`âš  Validation passed with ${warningCount} warning(s)`, 'warning');
                } else {
                    appendLog(`âœ— Validation failed with ${errorCount} error(s)`, 'error');
                }
                
                displayValidationResults(data.validation);
            }

            if (data.zip_base64) {
                // Decode base64 ZIP
                const byteCharacters = atob(data.zip_base64);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                currentZipBlob = new Blob([byteArray], { type: 'application/zip' });
                appendLog('âœ“ Data saved to project rawdata folder', 'success');
            } else if (data.blob) {
                currentZipBlob = data.blob;
                appendLog('âœ“ Data saved to project rawdata folder', 'success');
            }

            // Final completion message
            appendLog('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
            appendLog('âœ“ CONVERSION COMPLETED SUCCESSFULLY', 'success');
            appendLog('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');

            convertInfo.textContent = 'Conversion complete. See results below.';
            convertInfo.classList.remove('d-none');
        })
        .catch(err => {
            appendLog(`Error: ${err.message}`, 'error');
            convertError.textContent = err.message;
            convertError.classList.remove('d-none');
        })
        .finally(() => {
            updateConvertBtn();
        });
    });

    // Participant Mapping button handler
    const createParticipantMappingBtn = document.getElementById('createParticipantMappingBtn');
    if (createParticipantMappingBtn) {
        createParticipantMappingBtn.addEventListener('click', function() {
            // Check if project is loaded using template variable
            const currentProjectPath = "{{ current_project.path or '' }}";
            if (!currentProjectPath) {
                alert('Please load a project first to create participant mapping. Projects are managed in the Projects page.');
                return;
            }

            // Reset the modal to initial state
            document.getElementById('mappingColumnsContainer').classList.remove('d-none');
            document.getElementById('mappingSuccess').classList.add('d-none');
            document.getElementById('mappingError').classList.add('d-none');
            document.getElementById('saveMappingBtn').classList.remove('d-none');
            document.getElementById('cancelMappingBtn').classList.remove('d-none');
            document.getElementById('closeMappingBtn').classList.add('d-none');

            // Show the modal and prepare the mapping interface
            const modal = new bootstrap.Modal(document.getElementById('participantMappingModal'));
            
            // Get the current preview to extract unused columns
            if (window.lastPreviewData && window.lastPreviewData.participants_tsv) {
                const tsv = window.lastPreviewData.participants_tsv;
                const unusedCols = tsv.unused_columns || [];
                
                renderParticipantMappingForm(unusedCols);
            } else {
                document.getElementById('mappingColumnsContainer').innerHTML = 
                    '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>No preview data available. Please run a preview first.</div>';
            }
            
            modal.show();
        });
    }

    // Helper function to render the participant mapping form
    function renderParticipantMappingForm(unusedCols) {
        const container = document.getElementById('mappingColumnsContainer');
        
        if (!unusedCols || unusedCols.length === 0) {
            container.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>No unused columns available to map.</div>';
            document.getElementById('saveMappingBtn').disabled = true;
            return;
        }

        let html = `
            <div class="mb-3">
                <h6>Select columns to include in participants.tsv:</h6>
                <div class="form-check-list" style="max-height: 300px; overflow-y: auto;">
        `;

        unusedCols.forEach((item, idx) => {
            const fieldCode = typeof item === 'object' ? item.field_code : item;
            const description = typeof item === 'object' ? (item.description || '') : '';
            const safeName = fieldCode.replace(/[^a-zA-Z0-9_]/g, '_');
            
            html += `
                <div class="form-check mb-2">
                    <input class="form-check-input col-selector" type="checkbox" id="col_${idx}" value="${fieldCode}" data-description="${description}">
                    <label class="form-check-label" for="col_${idx}">
                        <strong>${fieldCode}</strong>
                        ${description ? `<br><small class="text-muted">â†’ ${description}</small>` : ''}
                    </label>
                </div>
            `;
        });

        html += `
                </div>
            </div>
            <div class="alert alert-info small">
                <i class="fas fa-lightbulb me-2"></i>
                <strong>Tip:</strong> Columns with descriptive text are likely demographic fields that should be included.
            </div>
        `;

        container.innerHTML = html;

        // Enable save button when selections are made
        const checkboxes = document.querySelectorAll('.col-selector');
        const updateSaveBtn = () => {
            const hasSelection = Array.from(checkboxes).some(cb => cb.checked);
            document.getElementById('saveMappingBtn').disabled = !hasSelection;
        };

        checkboxes.forEach(cb => {
            cb.addEventListener('change', updateSaveBtn);
        });
    }

    // Save Mapping button handler
    const saveMappingBtn = document.getElementById('saveMappingBtn');
    if (saveMappingBtn) {
        saveMappingBtn.addEventListener('click', async function() {
            const selected = Array.from(document.querySelectorAll('.col-selector:checked'));
            
            if (selected.length === 0) {
                alert('Please select at least one column');
                return;
            }

            // Build mapping object
            const mapping = {};
            selected.forEach(checkbox => {
                const fieldCode = checkbox.value;
                const description = checkbox.getAttribute('data-description');
                // Use the description as target column name if available, otherwise use field code
                const targetCol = description ? description.toLowerCase().replace(/\s+/g, '_') : fieldCode;
                mapping[fieldCode] = targetCol;
            });

            // Get the library path from the form (will use project library by preference in backend)
            const libraryPath = document.getElementById('convertLibraryPath')?.value || '';

            try {
                // Send mapping to backend to save
                const response = await fetch('/api/save-participant-mapping', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        mapping: mapping,
                        library_path: libraryPath
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Failed to save mapping');
                }

                showMappingSuccess(result.file_path);
            } catch (err) {
                showMappingError(err.message);
            }
        });
    }

    function showMappingSuccess(filePath) {
        document.getElementById('mappingColumnsContainer').classList.add('d-none');
        document.getElementById('mappingSuccess').classList.remove('d-none');
        document.getElementById('mappingError').classList.add('d-none');
        document.getElementById('mappingFilePath').innerHTML = `
            <strong>File created:</strong> <code>${filePath}</code>
        `;
        
        // Hide the Save and Cancel buttons, show the Close button
        document.getElementById('saveMappingBtn').classList.add('d-none');
        document.getElementById('cancelMappingBtn').classList.add('d-none');
        document.getElementById('closeMappingBtn').classList.remove('d-none');
    }

    function showMappingError(message) {
        document.getElementById('mappingError').classList.remove('d-none');
        document.getElementById('mappingErrorText').textContent = message;
        document.getElementById('mappingSuccess').classList.add('d-none');
    }

    // Preview button (dry-run) handler
    previewBtn.addEventListener('click', async function() {
        convertError.classList.add('d-none');
        convertInfo.classList.add('d-none');
        convertError.textContent = '';
        convertInfo.textContent = '';
        resetConversionUI();

        const file = convertExcelFile.files && convertExcelFile.files[0];
        if (!file) {
            return;
        }

        // Validate ID map before sending
        const idMap = convertIdMapFile && convertIdMapFile.files && convertIdMapFile.files[0];
        if (idMap) {
            // Just check that a file is selected; don't read it (avoids stream issues)
            console.log(`[CLIENT DEBUG] ID map file selected: ${idMap.name} (size: ${idMap.size} bytes, type: ${idMap.type})`);
            if (idMap.size === 0) {
                convertError.classList.remove('d-none');
                convertError.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>ID map file is empty`;
                return;
            }
        }

        const formData = new FormData();
        formData.append('excel', file);

        if (idMap) {
            console.log(`[CLIENT DEBUG] About to append id_map to FormData: ${idMap.name} (size: ${idMap.size} bytes)`);
            formData.append('id_map', idMap);
            console.log(`[CLIENT DEBUG] Successfully appended id_map to FormData`);
        }

        // Add ID column if selected
        const idColumn = document.getElementById('convertIdColumn')?.value;
        if (idColumn && idColumn !== 'auto') {
            formData.append('id_column', idColumn);
        }

        const sessionVal = document.getElementById('convertSession') ? document.getElementById('convertSession').value.trim() : '';
        if (sessionVal) {
            formData.append('session', sessionVal);
        }

        formData.append('language', convertLanguage ? convertLanguage.value : 'auto');
        formData.append('unknown', convertUnknown.value);

        const strictLevelsEl = document.getElementById('convertStrictLevels');
        if (strictLevelsEl && strictLevelsEl.checked) {
            formData.append('strict_levels', 'true');
        }

        // Default: run validation in preview
        formData.append('validate', 'true');

        const duplicateHandlingEl = document.getElementById('convertDuplicateHandling');
        if (duplicateHandlingEl) {
            formData.append('duplicate_handling', duplicateHandlingEl.value);
        }

        // Show log container
        conversionLogContainer.classList.remove('d-none');
        conversionLogBody.classList.remove('d-none');
        const icon = toggleLogBtn.querySelector('i');
        icon.classList.remove('fa-chevron-right');
        icon.classList.add('fa-chevron-down');

        appendLog('ðŸ” PREVIEW MODE (Dry-Run)', 'info');
        appendLog('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
        appendLog(`Analyzing file: ${file.name}`, 'step');
        if (idMap) {
            appendLog(`With ID map: ${idMap.name}`, 'step');
        }
        appendLog('No files will be created.', 'info');
        appendLog('', 'info');

        console.log(`[CLIENT DEBUG] FormData ready, sending to /api/survey-convert-preview`);
        console.log(`[CLIENT DEBUG] FormData contains:`, {
            excel: file.name,
            excel_size: file.size,
            id_map: idMap ? idMap.name : null,
            id_map_size: idMap ? idMap.size : null
        });

        previewBtn.disabled = true;
        convertBtn.disabled = true;

        fetch('/api/survey-convert-preview', {
            method: 'POST',
            body: formData,
        })
        .then(async response => {
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Preview failed');
            }

            const preview = data.preview;

            if (!preview) {
                appendLog('âš  No preview data received', 'warning');
                return;
            }

            // Display summary
            appendLog('ðŸ“Š SUMMARY', 'info');
            appendLog(`   Total participants: ${preview.summary.total_participants}`, 'info');
            appendLog(`   Unique participants: ${preview.summary.unique_participants}`, 'info');
            appendLog(`   Tasks detected: ${preview.summary.tasks.join(', ')}`, 'info');
            appendLog(`   Total files to create: ${preview.summary.total_files}`, 'info');
            appendLog('', 'info');

            // Show validation results if backend ran validation during preview
            if (data.validation) {
                const v = data.validation;
                const errorCount = (v.errors || []).length;
                const warningCount = (v.warnings || []).length;

                if (errorCount === 0 && warningCount === 0) {
                    appendLog('âœ“ Validation (preview) passed - dataset is valid!', 'success');
                } else if (errorCount === 0) {
                    appendLog(`âš  Validation (preview) passed with ${warningCount} warning(s)`, 'warning');
                } else {
                    appendLog(`âœ— Validation (preview) failed with ${errorCount} error(s)`, 'error');
                }

                displayValidationResults(data.validation);
                appendLog('', 'info');
            }

            // Display data issues
            if (preview.data_issues && preview.data_issues.length > 0) {
                appendLog(`âš ï¸  DATA ISSUES FOUND (${preview.data_issues.length})`, 'warning');
                appendLog('   Fix these issues BEFORE conversion:', 'warning');
                appendLog('', 'warning');
                
                preview.data_issues.slice(0, 10).forEach(issue => {
                    const severity = issue.severity.toUpperCase();
                    appendLog(`   [${severity}] ${issue.type}`, 'warning');
                    appendLog(`   â†’ ${issue.message}`, 'warning');
                    
                    if (issue.type === 'duplicate_ids' && issue.details) {
                        const dups = Object.keys(issue.details).slice(0, 5);
                        appendLog(`   â†’ Duplicates: ${dups.join(', ')}`, 'warning');
                    } else if (issue.type === 'unexpected_values') {
                        appendLog(`   â†’ Column: ${issue.column} (task: ${issue.task}, item: ${issue.item})`, 'warning');
                        if (issue.unexpected) {
                            appendLog(`   â†’ Unexpected values: ${issue.unexpected.slice(0, 5).join(', ')}`, 'warning');
                        }
                    } else if (issue.type === 'out_of_range') {
                        appendLog(`   â†’ Column: ${issue.column} (task: ${issue.task}, item: ${issue.item})`, 'warning');
                        appendLog(`   â†’ Expected range: ${issue.range}`, 'warning');
                        appendLog(`   â†’ Out of range count: ${issue.out_of_range_count}`, 'warning');
                    }
                    appendLog('', 'warning');
                });
                
                if (preview.data_issues.length > 10) {
                    appendLog(`   ... and ${preview.data_issues.length - 10} more issues`, 'warning');
                }
                appendLog('', 'info');
            } else {
                appendLog('âœ… NO DATA ISSUES DETECTED', 'success');
                appendLog('', 'info');
            }

            // Display participants.tsv preview
            if (preview.participants_tsv) {
                const tsv = preview.participants_tsv;
                
                // Store preview data globally for the mapping button
                window.lastPreviewData = preview;
                
                // Enable the participant mapping button if there are unused columns
                if (createParticipantMappingBtn) {
                    createParticipantMappingBtn.disabled = !(tsv.unused_columns && tsv.unused_columns.length > 0);
                }
                
                appendLog('ðŸ“ PARTICIPANTS.TSV PREVIEW', 'info');
                appendLog('   This file will be created with the following structure:', 'info');
                appendLog('', 'info');
                
                // Columns
                appendLog(`   Columns (${tsv.columns.length} total):`, 'info');
                tsv.columns.forEach(col => {
                    appendLog(`     â€¢ ${col}`, 'info');
                });
                
                // Mappings
                if (Object.keys(tsv.mappings).length > 0) {
                    appendLog('', 'info');
                    appendLog('   Column Mappings:', 'info');
                    Object.entries(tsv.mappings).forEach(([outputCol, mappingInfo]) => {
                        const hasMapping = mappingInfo.has_value_mapping;
                        const indicator = hasMapping ? 'ðŸ”„' : 'âœ“';
                        appendLog(`     ${indicator} ${outputCol} â† ${mappingInfo.source_column}`, 'info');
                        if (hasMapping && Object.keys(mappingInfo.value_mapping).length > 0) {
                            appendLog(`        (has value transformation mapping)`, 'info');
                        }
                    });
                }
                
                // Sample data
                if (tsv.sample_rows.length > 0) {
                    appendLog('', 'info');
                    const sampleCount = Math.min(5, tsv.sample_rows.length);
                    appendLog(`   Sample Data (showing first ${sampleCount} of ${tsv.total_rows} participants):`, 'info');
                    appendLog(`   ${'-'.repeat(100)}`, 'info');
                    
                    // Header
                    const header = tsv.columns.map(col => col.padEnd(20)).join(' | ');
                    appendLog(`   ${header}`, 'info');
                    appendLog(`   ${'-'.repeat(100)}`, 'info');
                    
                    // Rows
                    tsv.sample_rows.slice(0, 5).forEach(rowData => {
                        const row = tsv.columns.map(col => String(rowData[col] || 'n/a').padEnd(20)).join(' | ');
                        appendLog(`   ${row}`, 'info');
                    });
                    
                    if (tsv.sample_rows.length > 5) {
                        appendLog(`   ... and ${tsv.sample_rows.length - 5} more rows shown above (total ${tsv.total_rows} participants)`, 'info');
                    }
                    appendLog(`   ${'-'.repeat(100)}`, 'info');
                }
                
                // Notes
                if (tsv.notes.length > 0) {
                    appendLog('', 'info');
                    appendLog('   ðŸ“Œ Notes:', 'info');
                    tsv.notes.forEach(note => {
                        appendLog(`     â€¢ ${note}`, 'info');
                    });
                }
                
                // Unused columns
                if (tsv.unused_columns && tsv.unused_columns.length > 0) {
                    appendLog('', 'info');
                    appendLog(`   âš ï¸  UNUSED COLUMNS (${tsv.unused_columns.length} available for participants.tsv):`, 'warning');
                    appendLog(`      These columns are not being imported as survey data and could be included`, 'warning');
                    appendLog(`      in participants.tsv if you create/update participants_mapping.json:`, 'warning');
                    tsv.unused_columns.slice(0, 10).forEach(item => {
                        // Handle both old format (string) and new format (dict with description)
                        if (typeof item === 'object') {
                            const fieldCode = item.field_code || '';
                            const description = item.description || '';
                            appendLog(`      â€¢ ${fieldCode}`, 'warning');
                            if (description) {
                                appendLog(`        â†³ ${description}`, 'warning');
                            }
                        } else {
                            appendLog(`      â€¢ ${item}`, 'warning');
                        }
                    });
                    if (tsv.unused_columns.length > 10) {
                        appendLog(`      ... and ${tsv.unused_columns.length - 10} more columns`, 'warning');
                    }
                    
                    // Add button to create participant mapping
                    appendLog('', 'info');
                    appendLog(`   ðŸ’¡ TIP: Click "Create Participant Mapping" button below to map these columns to participants.tsv`, 'info');
                }
                
                appendLog('', 'info');
            }

            // Display participant preview
            appendLog('ðŸ‘¥ PARTICIPANT PREVIEW (first 10)', 'info');
            preview.participants.slice(0, 10).forEach(p => {
                const completeness = p.completeness_percent;
                const status = completeness > 80 ? 'âœ“' : (completeness > 50 ? 'âš ' : 'âœ—');
                appendLog(`   ${status} ${p.participant_id} (${p.session_id})`, 'info');
                appendLog(`      Raw ID: ${p.raw_id}`, 'info');
                appendLog(`      Completeness: ${completeness}% (${p.total_items - p.missing_values}/${p.total_items} items)`, 'info');
            });
            
            if (preview.participants.length > 10) {
                appendLog(`   ... and ${preview.participants.length - 10} more participants`, 'info');
            }
            appendLog('', 'info');

            // Display column mapping preview
            appendLog('ðŸ“‹ COLUMN MAPPING (first 15)', 'info');
            const cols = Object.entries(preview.column_mapping).slice(0, 15);
            cols.forEach(([col, info]) => {
                const run_info = info.run ? ` (run ${info.run})` : '';
                const status = info.has_unexpected_values ? 'âš ' : 'âœ“';
                appendLog(`   ${status} ${col}`, 'info');
                appendLog(`      â†’ Task: ${info.task}${run_info}, Item: ${info.base_item}`, 'info');
                appendLog(`      â†’ Missing: ${info.missing_percent}% (${info.missing_count} values)`, 'info');
                if (info.has_unexpected_values) {
                    appendLog(`      âš  Has unexpected values!`, 'warning');
                }
            });
            
            if (Object.keys(preview.column_mapping).length > 15) {
                appendLog(`   ... and ${Object.keys(preview.column_mapping).length - 15} more columns`, 'info');
            }
            appendLog('', 'info');

            // Display file structure
            appendLog('ðŸ“ FILES TO CREATE', 'info');
            const fileTypes = {};
            preview.files_to_create.forEach(f => {
                fileTypes[f.type] = (fileTypes[f.type] || 0) + 1;
            });
            
            appendLog(`   Metadata files: ${fileTypes.metadata || 0}`, 'info');
            appendLog(`   Sidecar files: ${fileTypes.sidecar || 0}`, 'info');
            appendLog(`   Data files: ${fileTypes.data || 0}`, 'info');
            appendLog('', 'info');
            
            appendLog('   Sample files:', 'info');
            const shownByType = {metadata: 0, sidecar: 0, data: 0};
            preview.files_to_create.forEach(f => {
                if (shownByType[f.type] < 3) {
                    appendLog(`   - ${f.path}`, 'info');
                    appendLog(`     ${f.description}`, 'info');
                    shownByType[f.type]++;
                }
            });

            appendLog('', 'info');
            appendLog('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
            appendLog('âœ“ PREVIEW COMPLETED SUCCESSFULLY', 'success');
            appendLog('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
            
            convertInfo.innerHTML = '<i class="fas fa-info-circle me-2"></i>Preview complete. Review the log above, then click <strong>Convert</strong> to proceed.';
            convertInfo.classList.remove('d-none');
        })
        .catch(err => {
            appendLog(`Error: ${err.message}`, 'error');
            convertError.textContent = err.message;
            convertError.classList.remove('d-none');
        })
        .finally(() => {
            previewBtn.disabled = false;
            convertBtn.disabled = false;
        });
    });

    function updateBiometricsBtn() {
        const hasFile = biometricsDataFile && biometricsDataFile.files && biometricsDataFile.files.length === 1;
        if (biometricsPreviewBtn) biometricsPreviewBtn.disabled = !hasFile;
        if (biometricsConvertBtn) biometricsConvertBtn.disabled = !hasFile;
    }

    function checkBiometricsLibraryStructure() {
        // Library path is auto-resolved on backend (project first, then global)
        // No client-side check needed
    }

    if (biometricsDataFile) {
        biometricsDataFile.addEventListener('change', updateBiometricsBtn);
        updateBiometricsBtn();
    }

    function downloadCurrentBiometricsZip() {
        if (!currentBiometricsZipBlob) return;
        const url = window.URL.createObjectURL(currentBiometricsZipBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'prism_biometrics_dataset.zip';
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
    }

    if (biometricsDownloadZipBtn) {
        biometricsDownloadZipBtn.addEventListener('click', downloadCurrentBiometricsZip);
    }
    if (biometricsDownloadZipWarningBtn) {
        biometricsDownloadZipWarningBtn.addEventListener('click', downloadCurrentBiometricsZip);
    }

    if (biometricsPreviewBtn) {
        biometricsPreviewBtn.addEventListener('click', function() {
            biometricsError.classList.add('d-none');
            biometricsInfo.classList.add('d-none');
            biometricsError.textContent = '';
            biometricsInfo.textContent = '';
            resetBiometricsUI();

            const sessionVal = document.getElementById('biometricsSession') ? document.getElementById('biometricsSession').value.trim() : '';
            if (!sessionVal) {
                biometricsError.textContent = 'Please enter a session ID (e.g., 1, 2, 3).';
                biometricsError.classList.remove('d-none');
                document.getElementById('biometricsSession')?.focus();
                return;
            }

            const file = biometricsDataFile.files && biometricsDataFile.files[0];
            if (!file) return;

            // Show log container
            biometricsLogContainer.classList.remove('d-none');
            biometricsLogBody.classList.remove('d-none');
            const icon = toggleBiometricsLogBtn.querySelector('i');
            icon.classList.remove('fa-chevron-right');
            icon.classList.add('fa-chevron-down');

            appendLog('ðŸ” PREVIEW MODE (Dry-Run)', 'info', biometricsLog);
            appendLog('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info', biometricsLog);
            appendLog(`Analyzing file: ${file.name}`, 'step', biometricsLog);
            appendLog('No files will be created.', 'info', biometricsLog);
            appendLog('', 'info', biometricsLog);

            const formData = new FormData();
            formData.append('data', file);
            formData.append('sheet', (document.getElementById('biometricsSheet') || {value: '0'}).value);
            formData.append('session', sessionVal);
            formData.append('unknown', biometricsUnknown.value);
            formData.append('dry_run', 'true');
            formData.append('validate', 'true');

            biometricsPreviewBtn.disabled = true;
            biometricsConvertBtn.disabled = true;

            console.log('[Biometrics Preview] About to fetch /api/biometrics-convert');
            console.log('[Biometrics Preview] FormData entries:');
            for (let [key, value] of formData.entries()) {
                console.log(`  ${key}: ${value instanceof File ? value.name : value}`);
            }

            fetch('/api/biometrics-convert', {
                method: 'POST',
                body: formData,
            })
            .then(async response => {
                console.log('[Biometrics Preview] Fetch completed, status:', response.status);
                const data = await response.json();
                
                console.log('[Biometrics Preview] Response received:', data);
                console.log('[Biometrics Preview] Response OK:', response.ok);
                console.log('[Biometrics Preview] Log entries:', data.log ? data.log.length : 0);
                
                if (data.log && Array.isArray(data.log)) {
                    data.log.forEach(entry => {
                        appendLog(entry.message, entry.type || entry.level || 'info', biometricsLog);
                    });
                }

                if (!response.ok) {
                    throw new Error(data.error || 'Preview failed');
                }
                return data;
            })
            .then(data => {
                if (data.validation) {
                    const v = data.validation;
                    const errorCount = (v.errors || []).length;
                    const warningCount = (v.warnings || []).length;
                    
                    if (errorCount === 0 && warningCount === 0) {
                        appendLog('âœ“ Validation passed - dataset structure is valid!', 'success', biometricsLog);
                    } else if (errorCount === 0) {
                        appendLog(`âš  Validation passed with ${warningCount} warning(s)`, 'warning', biometricsLog);
                    } else {
                        appendLog(`âœ— Validation failed with ${errorCount} error(s)`, 'error', biometricsLog);
                    }
                    
                    displayValidationResults(data.validation, 'biometrics');
                }
                appendLog('', 'info', biometricsLog);
                appendLog('Preview complete. Check validation results above.', 'info', biometricsLog);
            })
            .catch(err => {
                appendLog(`Error: ${err.message}`, 'error', biometricsLog);
                biometricsError.textContent = err.message;
                biometricsError.classList.remove('d-none');
            })
            .finally(() => {
                biometricsPreviewBtn.disabled = false;
                biometricsConvertBtn.disabled = false;
            });
        });
    }

    if (biometricsConvertBtn) {
        biometricsConvertBtn.addEventListener('click', function() {
            biometricsError.classList.add('d-none');
            biometricsInfo.classList.add('d-none');
            biometricsError.textContent = '';
            biometricsInfo.textContent = '';
            resetBiometricsUI();

            const sessionVal = document.getElementById('biometricsSession') ? document.getElementById('biometricsSession').value.trim() : '';
            if (!sessionVal) {
                biometricsError.textContent = 'Please enter a session ID (e.g., 1, 2, 3).';
                biometricsError.classList.remove('d-none');
                document.getElementById('biometricsSession')?.focus();
                return;
            }

            const file = biometricsDataFile.files && biometricsDataFile.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('data', file);
            // Library path is now resolved automatically (project first, then global)
            formData.append('sheet', (document.getElementById('biometricsSheet') || {value: '0'}).value);

            biometricsConvertBtn.disabled = true;
            biometricsInfo.textContent = 'Analyzing file...';
            biometricsInfo.classList.remove('d-none');

            fetch('/api/biometrics-detect', {
                method: 'POST',
                body: formData,
            })
            .then(async response => {
                if (!response.ok) {
                    const data = await response.json().catch(() => null);
                    throw new Error(data && data.error ? data.error : 'Detection failed');
                }
                return response.json();
            })
            .then(data => {
                biometricsInfo.classList.add('d-none');
                if (!data.tasks || data.tasks.length === 0) {
                    biometricsError.textContent = 'No biometrics tasks detected in the file. Please check your templates and column names.';
                    biometricsError.classList.remove('d-none');
                    return;
                }

                // Show detected tasks
                biometricsDetectedContainer.classList.remove('d-none');
                biometricsDetectedList.innerHTML = '';
                data.tasks.forEach(task => {
                    const col = document.createElement('div');
                    col.className = 'col-md-4';
                    col.innerHTML = `
                        <div class="form-check">
                            <input class="form-check-input biometrics-task-check" type="checkbox" value="${task}" id="task_${task}" checked>
                            <label class="form-check-label small" for="task_${task}">
                                ${task}
                            </label>
                        </div>
                    `;
                    biometricsDetectedList.appendChild(col);
                });
            })
            .catch(err => {
                biometricsError.textContent = err.message;
                biometricsError.classList.remove('d-none');
            })
            .finally(() => {
                biometricsConvertBtn.disabled = false;
            });
        });
    }

    if (biometricsSelectAll) {
        biometricsSelectAll.addEventListener('change', function() {
            const checks = document.querySelectorAll('.biometrics-task-check');
            checks.forEach(c => c.checked = biometricsSelectAll.checked);
        });
    }

    if (biometricsConfirmBtn) {
        biometricsConfirmBtn.addEventListener('click', function() {
            const selectedTasks = Array.from(document.querySelectorAll('.biometrics-task-check:checked')).map(c => c.value);
            if (selectedTasks.length === 0) {
                alert('Please select at least one task to export.');
                return;
            }

            biometricsError.classList.add('d-none');
            biometricsInfo.classList.add('d-none');
            
            // Show log container
            biometricsLogContainer.classList.remove('d-none');
            biometricsLogBody.classList.remove('d-none');
            const icon = toggleBiometricsLogBtn.querySelector('i');
            icon.classList.remove('fa-chevron-right');
            icon.classList.add('fa-chevron-down');

            const file = biometricsDataFile.files && biometricsDataFile.files[0];

            appendLog(`Starting conversion of: ${file.name}`, 'info', biometricsLog);
            appendLog(`Using library: auto-resolved (project or global)`, 'step', biometricsLog);
            const formData = new FormData();
            formData.append('data', file);
            // Library path is now resolved automatically (project first, then global)
            formData.append('unknown', biometricsUnknown.value);
            // Always save to project structure (project/code/biometrics)

            const sessionVal = document.getElementById('biometricsSession') ? document.getElementById('biometricsSession').value.trim() : '';
            formData.append('session', sessionVal);
            appendLog(`Forcing session ID: ${sessionVal}`, 'step', biometricsLog);

            formData.append('validate', 'true');
            selectedTasks.forEach(t => formData.append('tasks[]', t));

            biometricsConfirmBtn.disabled = true;
            appendLog('Uploading file and starting conversion...', 'info', biometricsLog);

            fetch('/api/biometrics-convert', {
                method: 'POST',
                body: formData,
            })
            .then(async response => {
                const data = await response.json();
                
                // Process logs even if response is not ok
                if (data.log && Array.isArray(data.log)) {
                    data.log.forEach(entry => {
                        appendLog(entry.message, entry.type || entry.level || 'info', biometricsLog);
                    });
                }

                if (!response.ok) {
                    throw new Error(data.error || 'Conversion failed');
                }
                return data;
            })
            .then(data => {
                // Logs already processed above
                if (data.validation) {
                    const v = data.validation;
                    const errorCount = (v.errors || []).length;
                    const warningCount = (v.warnings || []).length;
                    
                    if (errorCount === 0 && warningCount === 0) {
                        appendLog('âœ“ Validation passed - dataset is valid!', 'success', biometricsLog);
                    } else if (errorCount === 0) {
                        appendLog(`âš  Validation passed with ${warningCount} warning(s)`, 'warning', biometricsLog);
                    } else {
                        appendLog(`âœ— Validation failed with ${errorCount} error(s)`, 'error', biometricsLog);
                    }
                    
                    displayValidationResults(data.validation, 'biometrics');
                }

                if (data.zip_base64) {
                    const byteCharacters = atob(data.zip_base64);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    currentBiometricsZipBlob = new Blob([byteArray], {type: 'application/zip'});
                    
                    appendLog('Conversion complete. Click the download button below.', 'success', biometricsLog);
                }
            })
            .catch(err => {
                appendLog(`Error: ${err.message}`, 'error', biometricsLog);
                biometricsError.textContent = err.message;
                biometricsError.classList.remove('d-none');
            })
            .finally(() => {
                biometricsConfirmBtn.disabled = false;
            });
        });
    }

    function updatePhysioBtn() {
        const hasFile = physioRawFile && physioRawFile.files && physioRawFile.files.length === 1;
        if (physioConvertBtn) physioConvertBtn.disabled = !hasFile;
    }

    if (physioRawFile) {
        physioRawFile.addEventListener('change', updatePhysioBtn);
        updatePhysioBtn();
    }

    if (physioConvertBtn) {
        physioConvertBtn.addEventListener('click', function() {
            physioError.classList.add('d-none');
            physioInfo.classList.add('d-none');
            physioError.textContent = '';
            physioInfo.textContent = '';

            const file = physioRawFile.files && physioRawFile.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('raw', file);
            formData.append('task', physioTask ? physioTask.value.trim() : 'rest');
            if (physioSamplingRate && physioSamplingRate.value) {
                formData.append('sampling_rate', physioSamplingRate.value);
            }

            physioConvertBtn.disabled = true;
            physioInfo.textContent = 'Converting... this may take a moment.';
            physioInfo.classList.remove('d-none');

            fetch('/api/physio-convert', {
                method: 'POST',
                body: formData,
            })
            .then(async response => {
                if (!response.ok) {
                    const data = await response.json().catch(() => null);
                    const msg = data && data.error ? data.error : 'Conversion failed';
                    throw new Error(msg);
                }
                const blob = await response.blob();
                return blob;
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'varioport_edfplus.zip';
                document.body.appendChild(a);
                a.click();
                a.remove();
                physioInfo.textContent = 'Done. Your ZIP download should start automatically.';
                physioInfo.classList.remove('d-none');
            })
            .catch(err => {
                physioError.textContent = err.message;
                physioError.classList.remove('d-none');
            })
            .finally(() => {
                updatePhysioBtn();
            });
        });
    }

    // --- Physio Batch Convert ---
    function updatePhysioBatchBtn() {
        const hasFiles = physioBatchFiles && physioBatchFiles.files && physioBatchFiles.files.length > 0;
        if (physioBatchConvertBtn) physioBatchConvertBtn.disabled = !hasFiles;
    }

    if (physioBatchFiles) {
        physioBatchFiles.addEventListener('change', updatePhysioBatchBtn);
        updatePhysioBatchBtn();
    }

    if (physioBatchLogClearBtn) {
        physioBatchLogClearBtn.addEventListener('click', () => {
            if (physioBatchLog) physioBatchLog.textContent = '';
        });
    }

    if (physioBatchConvertBtn) {
        physioBatchConvertBtn.addEventListener('click', async function() {
            physioBatchError.classList.add('d-none');
            physioBatchInfo.classList.add('d-none');
            physioBatchProgress.classList.remove('d-none');
            physioBatchLogContainer.classList.remove('d-none');
            physioBatchLog.textContent = '';
            physioBatchConvertBtn.disabled = true;

            const files = Array.from(physioBatchFiles.files);
            const datasetName = physioBatchDatasetName ? physioBatchDatasetName.value.trim() : 'Physio Dataset';
            const samplingRate = physioBatchSamplingRate ? physioBatchSamplingRate.value : '';

            const formData = new FormData();
            files.forEach(f => formData.append('files', f));
            formData.append('dataset_name', datasetName);
            formData.append('modality', 'physio');
            if (samplingRate) formData.append('sampling_rate', samplingRate);

            try {
                const response = await fetch('/api/batch-convert', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const data = await response.json().catch(() => null);
                    throw new Error(data && data.error ? data.error : 'Batch conversion failed');
                }

                const result = await response.json();
                
                // Show log
                if (result.log) {
                    physioBatchLog.textContent = result.log;
                }

                // Download the ZIP
                if (result.zip) {
                    downloadBase64Zip(result.zip, `${datasetName}_prism.zip`);
                }

                physioBatchInfo.textContent = `Converted ${result.converted || 0} files. ${result.errors || 0} errors.`;
                physioBatchInfo.classList.remove('d-none');
            } catch (err) {
                physioBatchError.textContent = err.message;
                physioBatchError.classList.remove('d-none');
            } finally {
                physioBatchProgress.classList.add('d-none');
                updatePhysioBatchBtn();
            }
        });
    }

    // --- Eyetracking Single Convert ---
    function updateEyetrackingSingleBtn() {
        const hasFile = eyetrackingSingleFile && eyetrackingSingleFile.files && eyetrackingSingleFile.files.length === 1;
        const hasSubject = eyetrackingSubject && eyetrackingSubject.value.trim().length > 0;
        if (eyetrackingSingleConvertBtn) eyetrackingSingleConvertBtn.disabled = !(hasFile && hasSubject);
    }

    if (eyetrackingSingleFile) {
        eyetrackingSingleFile.addEventListener('change', updateEyetrackingSingleBtn);
    }
    if (eyetrackingSubject) {
        eyetrackingSubject.addEventListener('input', updateEyetrackingSingleBtn);
    }
    updateEyetrackingSingleBtn();

    if (eyetrackingSingleConvertBtn) {
        eyetrackingSingleConvertBtn.addEventListener('click', async function() {
            eyetrackingSingleError.classList.add('d-none');
            eyetrackingSingleInfo.classList.add('d-none');
            eyetrackingSingleConvertBtn.disabled = true;

            const file = eyetrackingSingleFile.files[0];
            const subject = eyetrackingSubject.value.trim();
            const session = eyetrackingSession ? eyetrackingSession.value.trim() : '';
            const task = eyetrackingTask ? eyetrackingTask.value.trim() : 'gaze';

            const formData = new FormData();
            formData.append('edf', file);
            formData.append('subject', subject);
            formData.append('task', task);
            if (session) formData.append('session', session);

            eyetrackingSingleInfo.textContent = 'Converting... this may take a moment.';
            eyetrackingSingleInfo.classList.remove('d-none');

            try {
                const response = await fetch('/api/eyetracking-convert', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const data = await response.json().catch(() => null);
                    throw new Error(data && data.error ? data.error : 'Conversion failed');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'eyetracking_prism.zip';
                document.body.appendChild(a);
                a.click();
                a.remove();
                eyetrackingSingleInfo.textContent = 'Done. Your ZIP download should start automatically.';
            } catch (err) {
                eyetrackingSingleError.textContent = err.message;
                eyetrackingSingleError.classList.remove('d-none');
                eyetrackingSingleInfo.classList.add('d-none');
            } finally {
                updateEyetrackingSingleBtn();
            }
        });
    }

    // --- Eyetracking Batch Convert ---
    function updateEyetrackingBatchBtn() {
        const hasFiles = eyetrackingBatchFiles && eyetrackingBatchFiles.files && eyetrackingBatchFiles.files.length > 0;
        if (eyetrackingBatchConvertBtn) eyetrackingBatchConvertBtn.disabled = !hasFiles;
    }

    if (eyetrackingBatchFiles) {
        eyetrackingBatchFiles.addEventListener('change', updateEyetrackingBatchBtn);
        updateEyetrackingBatchBtn();
    }

    if (eyetrackingBatchLogClearBtn) {
        eyetrackingBatchLogClearBtn.addEventListener('click', () => {
            if (eyetrackingBatchLog) eyetrackingBatchLog.textContent = '';
        });
    }

    if (eyetrackingBatchConvertBtn) {
        eyetrackingBatchConvertBtn.addEventListener('click', async function() {
            eyetrackingBatchError.classList.add('d-none');
            eyetrackingBatchInfo.classList.add('d-none');
            eyetrackingBatchProgress.classList.remove('d-none');
            eyetrackingBatchLogContainer.classList.remove('d-none');
            eyetrackingBatchLog.textContent = '';
            eyetrackingBatchConvertBtn.disabled = true;

            const files = Array.from(eyetrackingBatchFiles.files);
            const datasetName = eyetrackingBatchDatasetName ? eyetrackingBatchDatasetName.value.trim() : 'Eyetracking Dataset';

            const formData = new FormData();
            files.forEach(f => formData.append('files', f));
            formData.append('dataset_name', datasetName);
            formData.append('modality', 'eyetracking');

            try {
                const response = await fetch('/api/batch-convert', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const data = await response.json().catch(() => null);
                    throw new Error(data && data.error ? data.error : 'Batch conversion failed');
                }

                const result = await response.json();
                
                // Show log
                if (result.log) {
                    eyetrackingBatchLog.textContent = result.log;
                }

                // Download the ZIP
                if (result.zip) {
                    downloadBase64Zip(result.zip, `${datasetName}_prism.zip`);
                }

                eyetrackingBatchInfo.textContent = `Converted ${result.converted || 0} files. ${result.errors || 0} errors.`;
                eyetrackingBatchInfo.classList.remove('d-none');
            } catch (err) {
                eyetrackingBatchError.textContent = err.message;
                eyetrackingBatchError.classList.remove('d-none');
            } finally {
                eyetrackingBatchProgress.classList.add('d-none');
                updateEyetrackingBatchBtn();
            }
        });
    }

    // --- Organize Batch ---
    function updateOrganizeBtn() {
        const hasFiles = organizeFiles && organizeFiles.files && organizeFiles.files.length > 0;
        if (organizeBtn) organizeBtn.disabled = !hasFiles;
    }

    if (organizeFiles) {
        organizeFiles.addEventListener('change', updateOrganizeBtn);
        updateOrganizeBtn();
    }

    if (organizeLogClearBtn) {
        organizeLogClearBtn.addEventListener('click', () => {
            if (organizeLog) organizeLog.textContent = '';
        });
    }

    if (organizeBtn) {
        organizeBtn.addEventListener('click', async function() {
            organizeError.classList.add('d-none');
            organizeInfo.classList.add('d-none');
            organizeProgress.classList.remove('d-none');
            organizeLogContainer.classList.remove('d-none');
            organizeLog.textContent = '';
            organizeBtn.disabled = true;

            const files = Array.from(organizeFiles.files);
            const datasetName = organizeDatasetName ? organizeDatasetName.value.trim() : 'Organized Dataset';
            const modality = organizeModality ? organizeModality.value : 'anat';

            const formData = new FormData();
            files.forEach(f => formData.append('files', f));
            formData.append('dataset_name', datasetName);
            formData.append('modality', modality);

            try {
                const response = await fetch('/api/batch-convert', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const data = await response.json().catch(() => null);
                    throw new Error(data && data.error ? data.error : 'Organization failed');
                }

                const result = await response.json();
                
                // Show log
                if (result.log) {
                    organizeLog.textContent = result.log;
                }

                // Download the ZIP
                if (result.zip) {
                    downloadBase64Zip(result.zip, `${datasetName}_prism.zip`);
                }

                organizeInfo.textContent = `Organized ${result.converted || 0} files. ${result.errors || 0} errors.`;
                organizeInfo.classList.remove('d-none');
            } catch (err) {
                organizeError.textContent = err.message;
                organizeError.classList.remove('d-none');
            } finally {
                organizeProgress.classList.add('d-none');
                updateOrganizeBtn();
            }
        });
    }

    // --- Physio Renamer Logic ---
    const renamerExampleContainer = document.getElementById('renamerExampleContainer');
    const renamerOriginalExample = document.getElementById('renamerOriginalExample');
    const renamerNewExample = document.getElementById('renamerNewExample');
    const renamerModality = document.getElementById('renamerModality');
    const renamerExampleHint = document.getElementById('renamerExampleHint');
    let currentExampleFile = null;

    const modalityHints = {
        'physio': 'sub-001_task-rest_physio.edf',
        'biometrics': 'sub-001_biometrics-height_biometrics.tsv',
        'events': 'sub-001_task-rest_events.tsv',
        'survey': 'sub-001_survey-phq9_survey.tsv'
    };

    const renamerRecordingContainer = document.getElementById('renamerRecordingContainer');
    const renamerRecording = document.getElementById('renamerRecording');

    function updateRecordingVisibility() {
        if (renamerModality && renamerRecordingContainer) {
            const showRecording = renamerModality.value === 'physio';
            renamerRecordingContainer.style.display = showRecording ? 'block' : 'none';
        }
    }

    if (renamerModality) {
        renamerModality.addEventListener('change', () => {
            const mod = renamerModality.value;
            let hint = modalityHints[mod] || 'sub-001_task-rest_physio.edf';
            
            // Update hint based on recording selection for physio
            if (mod === 'physio' && renamerRecording && renamerRecording.value) {
                hint = `sub-001_task-rest_recording-${renamerRecording.value}_physio.edf`;
            }
            
            if (renamerExampleHint) renamerExampleHint.innerHTML = `Example: <code>${hint}</code>`;
            if (renamerNewExample) renamerNewExample.placeholder = `e.g. ${hint}`;
            
            updateRecordingVisibility();
            inferPattern();
        });
    }

    if (renamerRecording) {
        renamerRecording.addEventListener('change', () => {
            const mod = renamerModality ? renamerModality.value : 'physio';
            let hint = modalityHints[mod] || 'sub-001_task-rest_physio.edf';
            
            if (renamerRecording.value) {
                hint = `sub-001_task-rest_recording-${renamerRecording.value}_physio.edf`;
            }
            
            if (renamerExampleHint) renamerExampleHint.innerHTML = `Example: <code>${hint}</code>`;
            if (renamerNewExample) renamerNewExample.placeholder = `e.g. ${hint}`;
            inferPattern();
        });
    }

    // Initialize visibility
    updateRecordingVisibility();

    function updateRenamerBtn() {
        const hasFiles = renamerFiles && renamerFiles.files && renamerFiles.files.length > 0;
        const hasNewName = renamerNewExample && renamerNewExample.value.trim().length > 0;
        if (renamerDownloadBtn) renamerDownloadBtn.disabled = !hasFiles || !hasNewName;
    }

    function pickExampleFile() {
        if (!renamerFiles || !renamerFiles.files || renamerFiles.files.length === 0) return;
        const files = Array.from(renamerFiles.files);
        currentExampleFile = files[Math.floor(Math.random() * files.length)];
        if (renamerOriginalExample) renamerOriginalExample.textContent = currentExampleFile.name;
        if (renamerExampleContainer) renamerExampleContainer.classList.remove('d-none');
        if (renamerNewExample) {
            renamerNewExample.value = '';
            renamerNewExample.focus();
        }
        updateRenamerBtn();
        if (renamerPreview) renamerPreview.classList.add('d-none');
    }

    if (renamerFiles) {
        renamerFiles.addEventListener('change', () => {
            pickExampleFile();
            updateRenamerBtn();
        });
    }

    if (renamerResetBtn) {
        renamerResetBtn.addEventListener('click', pickExampleFile);
    }

    function inferPattern() {
        if (!currentExampleFile || !renamerNewExample) return;
        const oldName = currentExampleFile.name;
        const newName = renamerNewExample.value.trim();
        if (!newName) {
            if (renamerPreview) renamerPreview.classList.add('d-none');
            return;
        }

        // Find all digit sequences in oldName
        const digitRegex = /\d+/g;
        const matches = [];
        let match;
        while ((match = digitRegex.exec(oldName)) !== null) {
            matches.push({ value: match[0], index: match.index });
        }

        // Create regex pattern from oldName by replacing digit sequences with (\d+)
        // and escaping other characters
        let finalPattern = "";
        let lastIndex = 0;
        matches.forEach(m => {
            finalPattern += oldName.substring(lastIndex, m.index).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            finalPattern += '(\\d+)';
            lastIndex = m.index + m.value.length;
        });
        finalPattern += oldName.substring(lastIndex).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        
        // Now create the replacement string
        let replacement = newName;
        
        if (matches.length > 0) {
            // Sort matches by length descending to avoid partial matches (e.g. matching '1' inside '014')
            const uniqueValues = [...new Set(matches.map(m => m.value))].sort((a, b) => b.length - a.length);
            
            // Create a map from value to its first group index
            const valueToGroup = {};
            matches.forEach((m, i) => {
                if (!(m.value in valueToGroup)) {
                    valueToGroup[m.value] = i + 1;
                }
            });

            const combinedRegex = new RegExp(uniqueValues.map(v => v.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('|'), 'g');
            replacement = replacement.replace(combinedRegex, (matched) => {
                return `\\${valueToGroup[matched]}`;
            });
        }

        if (renamerPattern) renamerPattern.value = finalPattern;
        if (renamerReplacement) renamerReplacement.value = replacement;
        
        // Run dry run automatically
        runRenamer(true);
    }

    if (renamerNewExample) {
        renamerNewExample.addEventListener('input', () => {
            inferPattern();
            updateRenamerBtn();
        });
    }

    const renamerOrganize = document.getElementById('renamerOrganize');
    if (renamerOrganize) {
        renamerOrganize.addEventListener('change', () => {
            runRenamer(true);
        });
    }

    function filterRenamerTable(showOnlyUnmatched) {
        if (!renamerPreviewBody) return;
        const rows = renamerPreviewBody.querySelectorAll('tr');
        rows.forEach(row => {
            const isMatch = row.getAttribute('data-match') === 'true';
            if (showOnlyUnmatched) {
                row.classList.toggle('d-none', isMatch);
            } else {
                row.classList.remove('d-none');
            }
        });
        
        if (renamerFilterAll) renamerFilterAll.classList.toggle('active', !showOnlyUnmatched);
        if (renamerFilterUnmatched) renamerFilterUnmatched.classList.toggle('active', showOnlyUnmatched);
    }

    if (renamerFilterAll) {
        renamerFilterAll.addEventListener('click', () => filterRenamerTable(false));
    }
    if (renamerFilterUnmatched) {
        renamerFilterUnmatched.addEventListener('click', () => filterRenamerTable(true));
    }

    async function runRenamer(isDryRun) {
        if (!renamerPattern || !renamerReplacement || !renamerPattern.value) return;
        
        renamerError.classList.add('d-none');
        renamerInfo.classList.add('d-none');
        
        const formData = new FormData();
        formData.append('pattern', renamerPattern.value);
        formData.append('replacement', renamerReplacement.value);
        formData.append('dry_run', isDryRun);
        
        const renamerOrganize = document.getElementById('renamerOrganize');
        if (renamerOrganize) {
            formData.append('organize', renamerOrganize.checked);
        }

        if (renamerModality) {
            formData.append('modality', renamerModality.value);
        }
        
        const files = Array.from(renamerFiles.files);
        if (files.length === 0 && !isDryRun) return;
        
        // For dry run, we only send filenames to be faster
        if (isDryRun) {
            files.forEach(f => formData.append('filenames', f.name));
        } else {
            files.forEach(f => formData.append('files', f));
        }
        
        try {
            const response = await fetch('/api/physio-rename', {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) {
                const data = await response.json().catch(() => null);
                throw new Error(data && data.error ? data.error : 'Renaming failed');
            }
            
            const result = await response.json();
            
            if (isDryRun) {
                renamerPreviewBody.innerHTML = '';
                let matchCount = 0;
                const unmatchedFiles = [];
                const selectedModality = renamerModality ? renamerModality.value : 'physio';

                result.results.forEach(res => {
                    const isMatch = res.old !== res.new;
                    
                    // Basic BIDS validation for the new name
                    let isValidBids = true;
                    let bidsError = '';
                    
                    if (isMatch) {
                        if (!res.new.startsWith('sub-')) {
                            isValidBids = false;
                            bidsError = 'Missing sub- prefix';
                        } else if (!res.new.includes('_')) {
                            isValidBids = false;
                            bidsError = 'Missing entities/suffix';
                        } else {
                            // Check suffix
                            const stem = res.new.split('.')[0];
                            const suffix = stem.split('_').pop();
                            const expectedSuffixes = {
                                'physio': 'physio',
                                'biometrics': 'biometrics',
                                'events': 'events',
                                'survey': 'survey'
                            };
                            if (expectedSuffixes[selectedModality] && suffix !== expectedSuffixes[selectedModality]) {
                                isValidBids = false;
                                bidsError = `Expected _${expectedSuffixes[selectedModality]} suffix`;
                            }
                        }
                    }

                    if (isMatch && isValidBids) {
                        matchCount++;
                    } else if (!isMatch) {
                        unmatchedFiles.push(res.old);
                    }
                    
                    const tr = document.createElement('tr');
                    tr.setAttribute('data-match', isMatch && isValidBids);
                    
                    let displayNew = res.new;
                    if (res.path && res.path !== res.new) {
                        displayNew = `<span class="text-muted">${res.path.substring(0, res.path.lastIndexOf('/') + 1)}</span>${res.new}`;
                    }

                    tr.innerHTML = `
                        <td class="font-monospace small">${res.old}</td>
                        <td><i class="fas fa-arrow-right text-muted"></i></td>
                        <td class="font-monospace small ${isMatch ? (isValidBids ? 'text-success' : 'text-danger') : 'text-muted'}">
                            ${displayNew}
                            ${!isValidBids && isMatch ? `<br><small class="text-danger"><i class="fas fa-times-circle me-1"></i>${bidsError}</small>` : ''}
                        </td>
                        <td class="text-center">
                            ${(isMatch && isValidBids) ? '<i class="fas fa-check-circle text-success"></i>' : 
                              (!isMatch ? '<i class="fas fa-exclamation-triangle text-warning" title="No match found - file will not be renamed"></i>' : 
                              '<i class="fas fa-times-circle text-danger" title="Invalid BIDS/PRISM format"></i>')}
                        </td>
                    `;
                    renamerPreviewBody.appendChild(tr);
                });
                renamerPreview.classList.remove('d-none');

                if (matchCount < result.results.length && result.results.length > 0) {
                    const unmatchedCount = result.results.length - matchCount;
                    renamerError.innerHTML = `
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-triangle me-3 fa-2x"></i>
                            <div>
                                <strong>Warning: ${unmatchedCount} files are either unmatched or invalid.</strong><br>
                                Only files with a green checkmark will be renamed correctly. Check the "New PRISM Filename" column for errors.
                                <div class="mt-2">
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="document.getElementById('renamerFilterUnmatched').click()">
                                        <i class="fas fa-search me-1"></i>Show Incompatible Files
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    renamerError.classList.remove('d-none');
                }
                
                // Reset filter to "All" on new dry run
                filterRenamerTable(false);
            } else {
                if (result.zip) {
                    downloadBase64Zip(result.zip, 'renamed_files.zip');
                    renamerInfo.textContent = `Successfully renamed ${result.results.length} files. ZIP download started.`;
                    renamerInfo.classList.remove('d-none');
                }
            }
        } catch (err) {
            if (!isDryRun) {
                renamerError.textContent = err.message;
                renamerError.classList.remove('d-none');
            }
        }
    }

    if (renamerDownloadBtn) {
        renamerDownloadBtn.addEventListener('click', () => runRenamer(false));
    }

    // Toggle chevron icon for global renamer
    const globalRenamerCollapse = document.getElementById('globalRenamerCollapse');
    if (globalRenamerCollapse) {
        globalRenamerCollapse.addEventListener('show.bs.collapse', function () {
            const icon = document.querySelector('[data-bs-target="#globalRenamerCollapse"] i.fa-chevron-down');
            if (icon) icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
        });
        globalRenamerCollapse.addEventListener('hide.bs.collapse', function () {
            const icon = document.querySelector('[data-bs-target="#globalRenamerCollapse"] i.fa-chevron-up');
            if (icon) icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
        });
    }

    // --- Auto-fill library paths from current project ---
    // Store available library paths for quick switching
    const availableConvertPaths = {
        global: null,
        project: null
    };

    // Update source badge display
    function updateConvertLibrarySourceBadge(source) {
        const badge = document.getElementById('convertLibrarySourceBadge');
        const text = document.getElementById('convertLibrarySourceText');
        if (!badge || !text) return;

        if (source) {
            badge.style.display = 'inline-block';
            if (source === 'global') {
                badge.className = 'badge bg-info ms-2';
                text.textContent = 'Global Library';
            } else if (source === 'project') {
                badge.className = 'badge bg-success ms-2';
                text.textContent = 'Project Library';
            } else {
                badge.className = 'badge bg-secondary ms-2';
                text.textContent = 'Custom Path';
            }
        } else {
            badge.style.display = 'none';
        }
    }

    // Determine current source based on path
    function detectConvertLibrarySource() {
        if (!convertLibraryPathInput) return null;
        const currentPath = convertLibraryPathInput.value.trim();
        if (!currentPath) return null;

        // Normalize paths for comparison
        const normalize = p => p.replace(/\\/g, '/').replace(/\/$/, '').toLowerCase();
        const normalizedCurrent = normalize(currentPath);

        if (availableConvertPaths.project && normalize(availableConvertPaths.project) === normalizedCurrent) {
            return 'project';
        }
        if (availableConvertPaths.global && normalize(availableConvertPaths.global) === normalizedCurrent) {
            return 'global';
        }
        return 'custom';
    }

    async function initializeLibraryPathsFromProject() {
        const globalBtn = document.getElementById('convertUseGlobalLibraryBtn');
        const projectBtn = document.getElementById('convertUseProjectLibraryBtn');

        try {
            const response = await fetch('/api/projects/library-path');
            const data = await response.json();

            // Store available paths
            availableConvertPaths.global = data.global_library_path || null;
            availableConvertPaths.project = data.project_library_path || null;

            // Enable/disable quick switch buttons based on availability
            if (globalBtn) {
                if (availableConvertPaths.global) {
                    globalBtn.disabled = false;
                    globalBtn.title = availableConvertPaths.global;
                } else {
                    globalBtn.disabled = true;
                    globalBtn.title = 'No global library configured';
                }
            }

            if (projectBtn) {
                if (availableConvertPaths.project) {
                    projectBtn.disabled = false;
                    projectBtn.title = availableConvertPaths.project;
                } else {
                    projectBtn.disabled = true;
                    projectBtn.title = data.project_path ? 'Project has no library folder' : 'No project selected';
                }
            }

            // Auto-fill with best available path (prefer global for templates)
            if (convertLibraryPathInput && !convertLibraryPathInput.value) {
                let selectedPath = null;
                let selectedSource = null;

                if (availableConvertPaths.global) {
                    selectedPath = availableConvertPaths.global;
                    selectedSource = 'global';
                } else if (availableConvertPaths.project) {
                    selectedPath = availableConvertPaths.project;
                    selectedSource = 'project';
                } else if (data.library_path) {
                    selectedPath = data.library_path;
                    selectedSource = 'custom';
                }

                if (selectedPath) {
                    convertLibraryPathInput.value = selectedPath;
                    updateConvertLibrarySourceBadge(selectedSource);
                    // Trigger language detection
                    refreshConvertLanguages();
                }
            } else {
                // Path already set, detect source
                updateConvertLibrarySourceBadge(detectConvertLibrarySource());
            }

            // Biometrics library path is auto-resolved on the backend

            console.log('Library paths initialized:', {
                global: availableConvertPaths.global,
                project: availableConvertPaths.project
            });
        } catch (err) {
            console.warn('Could not load project library path:', err);
        }

        // Set up click handlers for quick switch buttons
        if (globalBtn) {
            globalBtn.addEventListener('click', function() {
                if (availableConvertPaths.global && convertLibraryPathInput) {
                    convertLibraryPathInput.value = availableConvertPaths.global;
                    updateConvertLibrarySourceBadge('global');
                    refreshConvertLanguages();
                }
            });
        }

        if (projectBtn) {
            projectBtn.addEventListener('click', function() {
                if (availableConvertPaths.project && convertLibraryPathInput) {
                    convertLibraryPathInput.value = availableConvertPaths.project;
                    updateConvertLibrarySourceBadge('project');
                    refreshConvertLanguages();
                }
            });
        }

        // Update source badge when path changes manually
        if (convertLibraryPathInput) {
            convertLibraryPathInput.addEventListener('input', function() {
                updateConvertLibrarySourceBadge(detectConvertLibrarySource());
            });
        }
    }

    // Initial populate
    refreshConvertLanguages();

    // Auto-fill from project (async, doesn't block)
    initializeLibraryPathsFromProject();

    // Listen for library settings changes from other tabs/pages
    window.addEventListener('prism-library-settings-changed', function(event) {
        console.log('Library settings changed, refreshing paths...');
        // Re-initialize library paths to pick up new global/project settings
        initializeLibraryPathsFromProject();
    });
});
</script>
{% endblock %}
