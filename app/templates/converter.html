{% extends "base.html" %}

{% block title %}PRISM Studio - Converter{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/converter.css') }}">
{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-3">
        <div class="col-12">
            <h2><i class="fas fa-exchange-alt text-warning me-2"></i>Prism Converter</h2>
            <p class="text-muted">Convert Survey, Biometrics, Physio, and Eyetracking inputs to PRISM/BIDS-style outputs.</p>
        </div>
    </div>

    <!-- LimeSurvey Quick Import Card (Legacy - now integrated into Survey tab) -->
    <div class="card border-success mb-4 shadow-sm d-none" id="legacyLimeSurveyCard">
        <div class="card-header bg-success bg-opacity-10 d-flex align-items-center">
            <i class="fas fa-file-import fa-lg text-success me-2"></i>
            <h5 class="mb-0">LimeSurvey → PRISM JSON</h5>
            <span class="badge bg-success ms-2">Quick Import</span>
            <span class="badge bg-secondary ms-2">Moved to Survey Tab</span>
        </div>
        <div class="card-body">
            <p class="text-muted mb-3">
                Convert a LimeSurvey structure file (.lss or .lsa) into PRISM-compatible JSON template(s).
            </p>
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label for="lssFile" class="form-label">LimeSurvey File</label>
                    <input class="form-control" type="file" id="lssFile" accept=".lss,.lsa">
                </div>
                <div class="col-md-3">
                    <label for="lssTaskName" class="form-label">Survey Name (optional)</label>
                    <input type="text" class="form-control" id="lssTaskName" placeholder="e.g. phq9">
                    <div class="form-text">For combined mode</div>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Export Mode</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="lssMode" id="lssModeGroups" value="groups" checked>
                        <label class="form-check-label" for="lssModeGroups">By questionnaire group</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="lssMode" id="lssModeQuestions" value="questions">
                        <label class="form-check-label" for="lssModeQuestions">Individual questions</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="lssMode" id="lssModeCombined" value="combined">
                        <label class="form-check-label" for="lssModeCombined">Combined (single file)</label>
                    </div>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-success w-100" type="button" id="lssConvertBtn" disabled>
                        <i class="fas fa-wand-magic-sparkles me-2"></i>Convert
                    </button>
                </div>
            </div>
            <div id="lssError" class="alert alert-danger d-none mt-3"></div>

            <!-- Single file result (combined mode) -->
            <div id="lssResultSingle" class="mt-3 d-none">
                <div class="alert alert-success">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Conversion successful!</strong>
                            <span id="lssQuestionCount" class="ms-2 badge bg-secondary"></span>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-success me-2" id="lssPreviewBtn">
                                <i class="fas fa-eye me-1"></i>Preview
                            </button>
                            <button class="btn btn-sm btn-success" id="lssDownloadBtn">
                                <i class="fas fa-download me-1"></i>Download JSON
                            </button>
                        </div>
                    </div>
                </div>
                <div id="lssPreview" class="d-none mt-2">
                    <pre class="bg-light p-3 rounded border" style="max-height: 400px; overflow-y: auto;"><code id="lssPreviewContent"></code></pre>
                </div>
            </div>

            <!-- Multiple files result (groups mode) -->
            <div id="lssResultMultiple" class="mt-3 d-none">
                <div class="alert alert-success mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Conversion successful!</strong>
                            <span id="lssGroupCount" class="ms-2 badge bg-primary"></span>
                            <span id="lssTotalQuestions" class="ms-1 badge bg-secondary"></span>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-success" id="lssDownloadAllBtn">
                                <i class="fas fa-download me-1"></i>Download ZIP
                            </button>
                            {% if current_project.path %}
                            <button class="btn btn-sm btn-primary" id="lssSaveGroupsToProjectBtn">
                                <i class="fas fa-folder-plus me-1"></i>Save to Project
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div id="lssQuestionnaireList" class="row g-2"></div>
            </div>

            <!-- Individual questions result (questions mode) -->
            <div id="lssResultQuestions" class="mt-3 d-none">
                <div class="alert alert-success mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Question templates extracted!</strong>
                            <span id="lssIndividualCount" class="ms-2 badge bg-info"></span>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-success" id="lssDownloadAllQuestionsBtn">
                                <i class="fas fa-download me-1"></i>Download ZIP
                            </button>
                            {% if current_project.path %}
                            <button class="btn btn-sm btn-primary" id="lssSaveQuestionsToProjectBtn">
                                <i class="fas fa-folder-plus me-1"></i>Save to Project
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <p class="text-muted small mb-2">
                    <i class="fas fa-info-circle me-1"></i>
                    Each question is a reusable template. Array questions include all their subquestions.
                </p>
                <div id="lssQuestionsList" class="row g-2"></div>
            </div>

            <!-- Save to Project Success Message -->
            <div id="lssSaveSuccess" class="alert alert-success d-none mt-3">
                <i class="fas fa-check-circle me-2"></i>
                <span id="lssSaveSuccessMessage"></span>
                <div class="mt-2">
                    <a href="{{ url_for('tools.survey_generator') }}" class="btn btn-sm btn-info">
                        <i class="fas fa-arrow-right me-1"></i>Go to Survey & Boilerplate
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <!-- Ribbon Navigation -->
            <div id="converterTabs" class="mb-4">
                <ul class="nav nav-pills nav-fill" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="participants-tab" data-bs-toggle="pill" data-bs-target="#participants-panel" type="button" role="tab" aria-controls="participants-panel" aria-selected="true">
                            <i class="fas fa-users fa-lg mb-1 d-block"></i>
                            <span class="fw-bold">Participants</span>
                            <small class="d-block text-muted" style="font-size: 0.7rem;">Step 1</small>
                        </button>
                    </li>
                </ul>
                <div class="converter-workflow-divider"></div>
                <div class="converter-modality-header">Modality-specific imports</div>
                <ul class="nav nav-pills nav-fill mt-2" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="survey-tab" data-bs-toggle="pill" data-bs-target="#survey-panel" type="button" role="tab" aria-controls="survey-panel" aria-selected="false">
                            <i class="fas fa-clipboard-list fa-lg mb-1 d-block"></i>
                            <span class="fw-bold">Survey</span>
                            <small class="d-block text-muted" style="font-size: 0.7rem;">Step 2</small>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="biometrics-tab" data-bs-toggle="pill" data-bs-target="#biometrics-panel" type="button" role="tab" aria-controls="biometrics-panel" aria-selected="false">
                            <i class="fas fa-weight fa-lg mb-1 d-block"></i>
                            <span class="fw-bold">Biometrics</span>
                            <small class="d-block text-muted" style="font-size: 0.7rem;">Step 2</small>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="physio-tab" data-bs-toggle="pill" data-bs-target="#physio-panel" type="button" role="tab" aria-controls="physio-panel" aria-selected="false">
                            <i class="fas fa-heartbeat fa-lg mb-1 d-block"></i>
                            <span class="fw-bold">Physio</span>
                            <small class="d-block text-muted" style="font-size: 0.7rem;">Step 2</small>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="eyetracking-tab" data-bs-toggle="pill" data-bs-target="#eyetracking-panel" type="button" role="tab" aria-controls="eyetracking-panel" aria-selected="false">
                            <i class="fas fa-eye fa-lg mb-1 d-block"></i>
                            <span class="fw-bold">Eyetracking</span>
                            <small class="d-block text-muted" style="font-size: 0.7rem;">Step 2</small>
                        </button>
                    </li>
                </ul>
            </div>

            <!-- Tab Content -->
            <div class="tab-content" id="converterTabContent">
                
                {% include 'converter_survey.html' %}

                {% include 'converter_biometrics.html' %}

                {% include 'converter_physio.html' %}

                {% include 'converter_eyetracking.html' %}

                {% include 'converter_participants.html' %}

            </div>
        </div>
    </div>
</div>

<!-- Modal: Add Additional Variables -->
<div class="modal fade" id="participantMappingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-map me-2"></i>Add Additional Variables
                    <small class="d-block mt-1" style="font-size: 0.7em; font-weight: normal;">
                        Optional: include selected non-core columns in participants.tsv
                        <span class="badge bg-warning text-dark ms-2">Different from ID Mapping</span>
                    </small>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <strong>ℹ️ What is this?</strong><br>
                    <small>
                        <strong>Additional Variables:</strong> Saves your selected non-core columns as a <code>participants_mapping.json</code> in your project library.<br>
                        These columns are then included in <code>participants.tsv</code> the next time you run <strong>2. Extract &amp; Convert</strong>.<br>
                        <strong>ID Mapping:</strong> Maps participant IDs between different systems<br>
                        <br>
                        <i class="fas fa-check-circle text-success me-1"></i> File will be saved as <code>code/library/participants_mapping.json</code><br>
                        <i class="fas fa-book text-info me-1"></i> It references <code>participants.json</code> definitions from your library/global template<br>
                        <i class="fas fa-circle-info text-primary me-1"></i> This does <strong>not</strong> overwrite <code>participants.json</code> directly<br>
                        <i class="fas fa-circle-info text-secondary me-1"></i> Variables without NeuroBagel template definitions will be added as custom fields
                    </small>
                </div>

                <div id="mappingColumnsContainer">
                    <p class="text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Loading available variables...</p>
                </div>

                <div id="mappingSuccess" class="alert alert-success d-none mt-3">
                    <i class="fas fa-check-circle me-2"></i>Mapping saved successfully!
                    <div id="mappingFilePath" class="mt-2 small"></div>
                </div>

                <div id="mappingError" class="alert alert-danger d-none mt-3">
                    <i class="fas fa-exclamation-circle me-2"></i><span id="mappingErrorText"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancelMappingBtn">Cancel</button>
                <button type="button" class="btn btn-success" id="saveMappingBtn" disabled>
                    <i class="fas fa-save me-2"></i>Save Mapping
                </button>
                <button type="button" class="btn btn-primary d-none" id="downloadMappingBtn">
                    <i class="fas fa-download me-2"></i>Download JSON
                </button>
                <button type="button" class="btn btn-primary d-none" data-bs-dismiss="modal" id="closeMappingBtn">
                    <i class="fas fa-check me-2"></i>Close
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script type="module" src="{{ url_for('static', filename='js/converter-bootstrap.js') }}?v=20260227-5"></script>
{% endblock %}
