{% extends "base.html" %}

{% block title %}Template Editor - PRISM Studio{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/template-editor.css') }}">
{% endblock %}
{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-10">
    <div class="text-center mb-4">
      <h2 class="mb-2">
        <i class="fas fa-file-code text-primary me-2"></i>
        Template Editor
      </h2>
      <p class="text-muted mb-0">Create or edit PRISM JSON templates for Survey or Biometrics, validate them, then download.</p>
    </div>

    <div class="card feature-card mb-4">
      <div class="card-body p-4">
        <div class="row g-3 mb-4">
          <div class="col-md-6">
            <label class="form-label fw-bold"><i class="fas fa-folder text-success me-1"></i>Project Templates</label>
            <select id="projectTemplateSelect" class="form-select">
              <option value="">(none in project)</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-bold"><i class="fas fa-globe text-info me-1"></i>Global Templates</label>
            <select id="globalTemplateSelect" class="form-select">
              <option value="">(select one)</option>
            </select>
          </div>
        </div>

        <div class="card border-success-subtle bg-light mb-4">
          <div class="card-body py-3">
            <h6 class="mb-3"><i class="fas fa-file-import text-success me-2"></i>Template Import & Generation</h6>
            <div class="row g-3 mb-3">
              <div class="col-md-4">
                <label class="form-label fw-bold">Modality</label>
                <select id="modality" class="form-select">
                  <option value="survey" selected>survey</option>
                  <option value="biometrics">biometrics</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label fw-bold">Schema version</label>
                <select id="schemaVersion" class="form-select">
                  {% for v in schema_versions %}
                  <option value="{{ v }}" {% if v == default_schema_version %}selected{% endif %}>{{ v }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-4 d-grid">
                <label class="form-label fw-bold">Template</label>
                <button class="btn btn-primary" id="btnNew" type="button">
                  <i class="fas fa-plus me-1"></i>Create New
                </button>
                <button class="btn btn-outline-primary mt-2" id="btnLoad" type="button">
                  <i class="fas fa-folder-open me-1"></i>Load Template
                </button>
              </div>
            </div>
            <div class="d-grid gap-2 d-md-flex">
              <button class="btn btn-outline-success flex-fill" id="btnImportTemplateSource" type="button">
                <i class="fas fa-file-import me-1"></i>Import Template Source
              </button>
            </div>
            <div class="form-text mt-2 d-flex align-items-center gap-2">
              <span>Imports structure directly into the editor for review, validation, and save.</span>
              <span class="text-muted" data-bs-toggle="tooltip" data-bs-html="true" title="<strong>LimeSurvey XML</strong>: .lsq, .lsg, .lss<br><strong>LimeSurvey archive</strong>: .lsa<br><strong>Tabular dictionary</strong>: .xlsx, .csv, .tsv">
                <i class="fas fa-circle-question"></i>
              </span>
            </div>
            <div id="projectLibraryStatus" class="form-text text-muted mt-1"></div>
            <input type="file" id="templateImportInput" accept=".lsq,.lsg,.lss,.lsa,.xlsx,.csv,.tsv" style="display:none" />
          </div>
        </div>

        <div class="row g-3 align-items-end">
          <div class="col-md-12 d-flex gap-2 justify-content-end">
            <button class="btn btn-success" id="btnValidate" type="button">
              <i class="fas fa-check me-1"></i>Validate
            </button>
            <button class="btn btn-primary" id="btnSave" type="button" disabled data-bs-toggle="tooltip" title="Saves to project/code/library/{modality}/ (overwrites)">
              <i class="fas fa-save me-1"></i>Save to Project
            </button>
            <button class="btn btn-outline-secondary" id="btnDownload" type="button" disabled>
              <i class="fas fa-download me-1"></i>Download JSON
            </button>
          </div>
        </div>

        <div class="mt-3" id="alertArea"></div>
        <div class="mt-2" id="missingSummaryArea"></div>
        <div class="d-flex justify-content-end mt-2">
          <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#jsonDiffCollapse" aria-expanded="false" aria-controls="jsonDiffCollapse" id="btnToggleDiff">
            <i class="fas fa-code-branch me-1"></i>Show JSON diff
          </button>
        </div>
        <div class="collapse mt-2" id="jsonDiffCollapse">
          <div class="card card-body" id="jsonDiffContainer"></div>
        </div>

        <!-- Language Overview Bar -->
        <div class="mt-3" id="languageBar" style="display:none;">
          <div class="lang-bar" id="languageBarInner">
            <span class="fw-bold small"><i class="fas fa-globe me-1"></i>Languages:</span>
            <span id="langBadges"></span>
            <span id="langPrimaryBadge"></span>
            <span id="langWarningIndicator" class="text-warning small" style="display:none;" title="Language configuration mismatch"><i class="fas fa-exclamation-triangle"></i></span>
            <div class="ms-auto d-flex gap-1">
              <button class="btn btn-sm btn-outline-primary" id="btnAddLang" type="button" title="Add a language to all questions"><i class="fas fa-plus me-1"></i>Add Language</button>
              <button class="btn btn-sm btn-outline-danger" id="btnRemoveLang" type="button" title="Remove a language from all questions"><i class="fas fa-minus me-1"></i>Remove Language</button>
            </div>
          </div>
        </div>

        <div class="mt-4">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <ul class="nav nav-tabs mb-0" id="editorViewTabs">
              <li class="nav-item">
                <a class="nav-link active" href="#" data-view="editor" id="tabEditor"><i class="fas fa-edit me-1"></i>Editor</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#" data-view="preview" id="tabPreview"><i class="fas fa-eye me-1"></i>Preview</a>
              </li>
            </ul>
            <span class="text-muted small" id="editorHint">Keys are fixed; edit values only.</span>
          </div>

          <!-- Completion Progress Bar -->
          <div class="completion-bar-container" id="completionBarContainer" style="display:none;">
            <div class="completion-bar">
              <div class="completion-bar-fill" id="completionBarFill" style="width: 0%;">
                <span id="completionBarText">0%</span>
              </div>
            </div>
            <div class="completion-bar-label">
              <span id="completionLabel">General Information</span>
            </div>
          </div>

          <!-- Editor View -->
          <div id="editorView">
          <div class="row g-3">
            <div class="col-lg-4">
              <div class="card">
                <div class="card-header bg-light">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <strong>Items</strong>
                      <span class="text-muted">(questions / metrics)</span>
                    </div>
                    <div class="form-check mb-0">
                      <input class="form-check-input" type="checkbox" id="selectAllItems">
                      <label class="form-check-label small" for="selectAllItems">Select All</label>
                    </div>
                  </div>
                </div>
                <div class="card-body">
                  <div class="input-group mb-2">
                    <input id="newItemId" type="text" class="form-control" placeholder="e.g., pss_01" />
                    <button class="btn btn-outline-primary" id="btnAddItem" type="button">Add</button>
                  </div>
                  <div class="form-text mb-2">Item IDs become fixed once added.</div>

                  <div id="itemList" class="item-list list-group"></div>
                </div>
              </div>
            </div>

            <div class="col-lg-8">
              <div class="accordion" id="templateAccordion">
                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingTop">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTop" aria-expanded="true" aria-controls="collapseTop">
                      Top-level
                    </button>
                  </h2>
                  <div id="collapseTop" class="accordion-collapse collapse show" aria-labelledby="headingTop" data-bs-parent="#templateAccordion">
                    <div class="accordion-body" id="topLevelForm"></div>
                  </div>
                </div>

                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingItem">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseItem" aria-expanded="false" aria-controls="collapseItem">
                      Selected item
                    </button>
                  </h2>
                  <div id="collapseItem" class="accordion-collapse collapse" aria-labelledby="headingItem" data-bs-parent="#templateAccordion">
                    <div class="accordion-body">
                      <div class="mb-3">
                        <label class="form-label">Selected item ID</label>
                        <input id="selectedItemId" class="form-control mono" type="text" disabled />
                      </div>
                      <div id="itemForm"></div>
                    </div>
                  </div>
                </div>

                <div class="accordion-item" id="toolPropertiesPanel">
                  <h2 class="accordion-header" id="headingToolProps">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseToolProps" aria-expanded="false" aria-controls="collapseToolProps">
                      <i class="fas fa-cogs text-info me-2"></i>Tool Properties
                    </button>
                  </h2>
                  <div id="collapseToolProps" class="accordion-collapse collapse" aria-labelledby="headingToolProps" data-bs-parent="#templateAccordion">
                    <div class="accordion-body">
                      <ul class="nav nav-tabs nav-tabs-sm mb-3" id="toolTabs">
                        <li class="nav-item">
                          <a class="nav-link active" href="#" data-tool="LimeSurvey">
                            <i class="fas fa-poll me-1"></i>LimeSurvey
                          </a>
                        </li>
                        <!-- Future: <li class="nav-item"><a class="nav-link" href="#" data-tool="REDCap">REDCap</a></li> -->
                      </ul>
                      <div id="toolPropertiesForm"></div>
                    </div>
                  </div>
                </div>

                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingBulk">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBulk" aria-expanded="false" aria-controls="collapseBulk">
                      Bulk Edit Items
                    </button>
                  </h2>
                  <div id="collapseBulk" class="accordion-collapse collapse" aria-labelledby="headingBulk" data-bs-parent="#templateAccordion">
                    <div class="accordion-body">
                      <p class="text-muted small mb-3">Set a value here to apply it to <strong>all</strong> items in this template.</p>
                      <div id="bulkEditForm"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="form-text mt-2">Hover the â“˜ icons for additional schema details (type, allowed values, patterns).</div>
          </div><!-- /editorView -->

          <!-- Preview View (hidden by default) -->
          <div id="previewView" style="display:none;">
            <div class="d-flex align-items-center gap-2 mb-3">
              <label class="form-label mb-0 fw-bold small">Preview language:</label>
              <select id="previewLangSelect" class="form-select form-select-sm" style="width:auto;"></select>
              <span class="text-muted small" id="previewLangCount"></span>
            </div>
            <div id="previewContent"></div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/template-editor.js') }}"></script>
{% endblock %}
