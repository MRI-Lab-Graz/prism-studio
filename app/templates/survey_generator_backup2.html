{% extends "base.html" %}

{% block title %}PRISM Studio - Survey{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="fas fa-file-export text-primary me-2"></i><span id="surveyPageTitle">Survey Export</span></h2>
            <p class="text-muted" id="surveyPageSubtitle">Select questionnaires from the library and export them to LimeSurvey (.lss).</p>
        </div>
    </div>

    <div class="card" id="surveyExportCard">
        <div class="card-header bg-light">
            <h5 class="mb-0">Survey Library</h5>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-8">
                    <label for="libraryPath" class="form-label">Library Path</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="libraryPath" placeholder="/path/to/survey_library" value="{{ default_survey_library_path | default('survey_library') }}">
                        <button class="btn btn-outline-secondary" type="button" id="browseBtn" title="Browse Folder">
                            <i class="fas fa-folder-open"></i>
                        </button>
                        <button class="btn btn-primary" type="button" id="loadLibraryBtn">
                            <i class="fas fa-sync-alt me-2"></i>Load Files
                        </button>
                    </div>
                    <div class="form-text">Folder containing Prism JSON sidecars (e.g., generated by excel_to_library.py).</div>
                </div>
            </div>

            <div id="libraryContent" class="d-none">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6>Available Questionnaires</h6>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary" id="selectAllBtn">Select All</button>
                        <button class="btn btn-sm btn-outline-secondary" id="deselectAllBtn">Deselect All</button>
                    </div>
                </div>
                
                <div class="table-responsive mb-4" style="max-height: 600px; overflow-y: auto;">
                    <table class="table table-hover border align-middle">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th style="width: 40px;"></th>
                                <th style="width: 40px;"></th>
                                <th>Filename</th>
                                <th>Original Name</th>
                                <th class="text-center">Matrix</th>
                                <th>Questions</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody id="fileListBody">
                            <!-- Files will be loaded here -->
                        </tbody>
                    </table>
                </div>

                <div class="d-flex justify-content-end">
                    <button class="btn btn-success btn-lg" id="generateLssBtn" disabled>
                        <i class="fas fa-file-export me-2"></i>Export to LimeSurvey (.lss)
                    </button>
                </div>
            </div>

            <div id="libraryEmpty" class="text-center py-5 d-none">
                <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                <p class="text-muted">No JSON files found in this directory.</p>
            </div>
            
            <div id="libraryError" class="alert alert-danger d-none mt-3"></div>
        </div>
    </div>

    <div class="card mt-4" id="landgig-convert">
        <div class="card-header bg-light">
            <h5 class="mb-0">Prism Converter</h5>
        </div>
        <div class="card-body">
            <p class="text-muted">Convert your raw data files into standardized research datasets that can be validated and shared.</p>

            <div class="card mb-4 border-info">
                <div class="card-header bg-info-subtle">
                    <h6 class="mb-0 text-info">Survey</h6>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-2">Upload your survey responses (Excel export or LimeSurvey archive) and get a properly structured dataset ready for analysis.</p>

                    <div class="row g-3 align-items-end">
                        <div class="col-12">
                            <div class="form-text">Templates are selected automatically (recommended).</div>
                        </div>
                        <div class="col-md-4">
                            <label for="convertExcelFile" class="form-label">Survey File (.xlsx, .csv, .tsv, .lsa)</label>
                            <input class="form-control" type="file" id="convertExcelFile" accept=".xlsx,.lsa,.csv,.tsv">
                        </div>
                        <div class="col-md-4">
                            <label for="convertDatasetName" class="form-label">Dataset Name (optional)</label>
                            <input type="text" class="form-control" id="convertDatasetName" placeholder="PRISM Survey Dataset">
                        </div>
                        <div class="col-md-4">
                            <label for="convertLanguage" class="form-label">Language</label>
                            <select class="form-select" id="convertLanguage">
                                <option value="auto" selected>Auto (template default)</option>
                            </select>
                            <div class="form-text">Select the language of your questionnaire items.</div>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-success w-100" type="button" id="convertBtn" disabled>
                                <i class="fas fa-wand-magic-sparkles me-2"></i>Convert & Download ZIP
                            </button>
                        </div>

                        <div class="col-12">
                            <a class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" href="#surveyAdvancedOptions" role="button" aria-expanded="false" aria-controls="surveyAdvancedOptions">
                                Advanced options
                            </a>
                        </div>

                        <div class="col-12 collapse" id="surveyAdvancedOptions">
                            <div class="row g-3 align-items-end mt-1">
                                <div class="col-md-6">
                                    <label for="convertAliasFile" class="form-label">ID Mapping File (optional)</label>
                                    <input class="form-control" type="file" id="convertAliasFile" accept=".tsv,.txt">
                                    <div class="form-text">Only needed if item IDs changed over time. Ask your supervisor if unsure.</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="convertUnknown" class="form-label">Unknown Items</label>
                                    <select class="form-select" id="convertUnknown">
                                        <option value="warn" selected>Show warnings</option>
                                        <option value="ignore">Skip silently</option>
                                        <option value="error">Stop on unknown</option>
                                    </select>
                                    <div class="form-text">Controls what happens if the file contains columns the templates don’t recognize.</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="convertError" class="alert alert-danger d-none mt-3"></div>
                    <div id="convertInfo" class="alert alert-info d-none mt-3"></div>
                </div>
            </div>

            <div class="card mb-4 border-primary">
                <div class="card-header bg-primary-subtle">
                    <h6 class="mb-0 text-primary">Biometrics</h6>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-2">Upload your physical measurements (e.g., grip strength, balance tests) as Excel or CSV and get a structured dataset.</p>
                    <div class="row g-3 align-items-end">
                        <div class="col-12">
                            <div class="form-text">Templates are selected automatically (recommended).</div>
                        </div>
                        <div class="col-md-4">
                            <label for="biometricsDataFile" class="form-label">Biometrics File (.xlsx, .csv, .tsv)</label>
                            <input class="form-control" type="file" id="biometricsDataFile" accept=".xlsx,.csv,.tsv">
                        </div>
                        <div class="col-md-4">
                            <label for="biometricsDatasetName" class="form-label">Dataset Name (optional)</label>
                            <input type="text" class="form-control" id="biometricsDatasetName" placeholder="PRISM Biometrics Dataset">
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-success w-100" type="button" id="biometricsConvertBtn" disabled>
                                <i class="fas fa-wand-magic-sparkles me-2"></i>Convert & Download ZIP
                            </button>
                        </div>

                        <div class="col-12">
                            <a class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" href="#biometricsAdvancedOptions" role="button" aria-expanded="false" aria-controls="biometricsAdvancedOptions">
                                Advanced options
                            </a>
                        </div>

                        <div class="col-12 collapse" id="biometricsAdvancedOptions">
                            <div class="row g-3 align-items-end mt-1">
                                <div class="col-md-6">
                                    <label for="biometricsUnknown" class="form-label">Unknown Items</label>
                                    <select class="form-select" id="biometricsUnknown">
                                        <option value="warn" selected>Show warnings</option>
                                        <option value="ignore">Skip silently</option>
                                        <option value="error">Stop on unknown</option>
                                    </select>
                                    <div class="form-text">Controls what happens if the file contains columns the templates don’t recognize.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="biometricsError" class="alert alert-danger d-none mt-3"></div>
                    <div id="biometricsInfo" class="alert alert-info d-none mt-3"></div>
                </div>
            </div>

            <div class="card border-success">
                <div class="card-header bg-success-subtle">
                    <h6 class="mb-0 text-success">Physio</h6>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-2">Upload physiological recordings from Varioport devices (ECG, respiration, etc.) and convert to standard EDF+ format.</p>
                    <div class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label for="physioRawFile" class="form-label">Varioport Recording (.raw or .vpd)</label>
                            <input class="form-control" type="file" id="physioRawFile" accept=".raw,.vpd">
                        </div>
                        <div class="col-md-4">
                            <label for="physioTask" class="form-label">Task Name</label>
                            <input type="text" class="form-control" id="physioTask" value="rest">
                        </div>
                        <div class="col-md-4">
                            <label for="physioSamplingRate" class="form-label">Sampling Rate Override (optional)</label>
                            <input type="number" class="form-control" id="physioSamplingRate" placeholder="e.g. 256" step="any">
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-success w-100" type="button" id="physioConvertBtn" disabled>
                                <i class="fas fa-wand-magic-sparkles me-2"></i>Convert & Download ZIP
                            </button>
                        </div>
                    </div>
                    <div id="physioError" class="alert alert-danger d-none mt-3"></div>
                    <div id="physioInfo" class="alert alert-info d-none mt-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Page title switching (Export vs Convert) ---
    const pageTitleEl = document.getElementById('surveyPageTitle');
    const pageSubtitleEl = document.getElementById('surveyPageSubtitle');
    const exportCardEl = document.getElementById('surveyExportCard');

    function updateSurveyPageHeader() {
        const isConvert = window.location.hash === '#landgig-convert';
        if (isConvert) {
            if (pageTitleEl) pageTitleEl.textContent = 'Prism Converter';
            if (pageSubtitleEl) pageSubtitleEl.textContent = 'Convert Survey, Biometrics, and Physio inputs to PRISM/BIDS-style outputs.';
            document.title = 'PRISM Studio - Prism Converter';
            if (exportCardEl) exportCardEl.classList.add('d-none');
        } else {
            if (pageTitleEl) pageTitleEl.textContent = 'Survey Export';
            if (pageSubtitleEl) pageSubtitleEl.textContent = 'Select questionnaires from the library and export them to LimeSurvey (.lss).';
            document.title = 'PRISM Studio - Survey Export';
            if (exportCardEl) exportCardEl.classList.remove('d-none');
        }
    }

    updateSurveyPageHeader();
    window.addEventListener('hashchange', updateSurveyPageHeader);

    // --- Library & Export Logic ---
    const libraryPathInput = document.getElementById('libraryPath');
    const loadLibraryBtn = document.getElementById('loadLibraryBtn');
    const browseBtn = document.getElementById('browseBtn');
    const libraryContent = document.getElementById('libraryContent');
    const libraryEmpty = document.getElementById('libraryEmpty');
    const libraryError = document.getElementById('libraryError');
    const fileListBody = document.getElementById('fileListBody');
    const selectAllBtn = document.getElementById('selectAllBtn');
    const deselectAllBtn = document.getElementById('deselectAllBtn');
    const generateLssBtn = document.getElementById('generateLssBtn');

    // --- Landgig: Survey Convert ---
    const convertLibraryPathInput = document.getElementById('convertLibraryPath');
    const convertBrowseLibraryBtn = document.getElementById('convertBrowseLibraryBtn');
    const convertExcelFile = document.getElementById('convertExcelFile');
    const convertAliasFile = document.getElementById('convertAliasFile');
    const convertBtn = document.getElementById('convertBtn');
    const convertDatasetName = document.getElementById('convertDatasetName');
    const convertUnknown = document.getElementById('convertUnknown');
    const convertLanguage = document.getElementById('convertLanguage');
    const convertError = document.getElementById('convertError');
    const convertInfo = document.getElementById('convertInfo');

    // --- Biometrics Convert ---
    const biometricsLibraryPathInput = document.getElementById('biometricsLibraryPath');
    const biometricsBrowseLibraryBtn = document.getElementById('biometricsBrowseLibraryBtn');
    const biometricsDataFile = document.getElementById('biometricsDataFile');
    const biometricsDatasetName = document.getElementById('biometricsDatasetName');
    const biometricsUnknown = document.getElementById('biometricsUnknown');
    const biometricsConvertBtn = document.getElementById('biometricsConvertBtn');
    const biometricsError = document.getElementById('biometricsError');
    const biometricsInfo = document.getElementById('biometricsInfo');

    // --- Physio Convert ---
    const physioRawFile = document.getElementById('physioRawFile');
    const physioTask = document.getElementById('physioTask');
    const physioSamplingRate = document.getElementById('physioSamplingRate');
    const physioConvertBtn = document.getElementById('physioConvertBtn');
    const physioError = document.getElementById('physioError');
    const physioInfo = document.getElementById('physioInfo');

    loadLibraryBtn.addEventListener('click', function() {
        const path = libraryPathInput.value.trim();
        if (!path) return;

        // Reset UI
        libraryContent.classList.add('d-none');
        libraryEmpty.classList.add('d-none');
        libraryError.classList.add('d-none');
        fileListBody.innerHTML = '';
        generateLssBtn.disabled = true;

        fetch(`/api/list-library-files?path=${encodeURIComponent(path)}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    libraryError.textContent = data.error;
                    libraryError.classList.remove('d-none');
                    return;
                }

                if (data.files && data.files.length > 0) {
                    data.files.forEach((file, index) => {
                        const fileId = `file-${index}`;
                        const collapseId = `collapse-${index}`;
                        
                        // Main Row
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>
                                <input class="form-check-input file-checkbox" type="checkbox" value="${file.path}" data-target="${collapseId}">
                            </td>
                            <td>
                                <button class="btn btn-sm btn-link text-decoration-none p-0" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </td>
                            <td class="fw-bold">${file.filename}</td>
                            <td>${file.original_name || '-'}</td>
                            <td class="text-center">
                                <div class="form-check form-switch d-flex justify-content-center">
                                    <input class="form-check-input matrix-checkbox" type="checkbox" id="matrix-${index}" title="Group consecutive questions into a Matrix">
                                </div>
                            </td>
                            <td><span class="badge bg-secondary">${file.question_count || 0} items</span></td>
                            <td class="text-muted small">${file.description || '-'}</td>
                        `;
                        fileListBody.appendChild(tr);

                        // Details Row (Questions)
                        const trDetails = document.createElement('tr');
                        trDetails.className = 'collapse-row';
                        trDetails.innerHTML = `
                            <td colspan="7" class="p-0 border-0">
                                <div class="collapse bg-light p-3" id="${collapseId}">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div class="d-flex align-items-center">
                                            <small class="text-muted fw-bold me-3">Questions to include:</small>
                                        </div>
                                        <div>
                                            <button class="btn btn-xs btn-outline-secondary select-all-q" data-target="${collapseId}">All</button>
                                            <button class="btn btn-xs btn-outline-secondary deselect-all-q" data-target="${collapseId}">None</button>
                                        </div>
                                    </div>
                                    <ul class="list-unstyled mb-0">
                                        ${(file.questions || []).map(q => {
                                            let levelsHtml = '';
                                            if (q.levels) {
                                                levelsHtml = '<div class="small text-muted border-start ps-3 ms-3" style="min-width: 250px; max-width: 400px;">' + 
                                                    Object.entries(q.levels).map(([k, v]) => `<div><span class="fw-bold">${k}</span>: ${v}</div>`).join('') + 
                                                    '</div>';
                                            }
                                            
                                            let metaHtml = '';
                                            const metaParts = [];
                                            
                                            // Helper for badges
                                            const badge = (text, color='light', textCol='dark') => 
                                                `<span class="badge bg-${color} text-${textCol} border me-1 mb-1">${text}</span>`;

                                            if (q.units) metaParts.push(badge(`Units: ${q.units}`));
                                            if (q.type) metaParts.push(badge(`Type: ${q.type}`));
                                            
                                            // Range Group
                                            if ((q.min !== null && q.min !== undefined) || (q.max !== null && q.max !== undefined)) {
                                                let rangeText = 'Range: ';
                                                if (q.min !== null) rangeText += `[${q.min}`; else rangeText += '(-∞';
                                                rangeText += ', ';
                                                if (q.max !== null) rangeText += `${q.max}]`; else rangeText += '∞)';
                                                metaParts.push(badge(rangeText, 'info', 'dark'));
                                            }

                                            // Warning Range Group
                                            if ((q.warn_min !== null && q.warn_min !== undefined) || (q.warn_max !== null && q.warn_max !== undefined)) {
                                                let warnText = '⚠️ Normal: ';
                                                if (q.warn_min !== null) warnText += `${q.warn_min}`; else warnText += '?';
                                                warnText += ' - ';
                                                if (q.warn_max !== null) warnText += `${q.warn_max}`; else warnText += '?';
                                                metaParts.push(badge(warnText, 'warning', 'dark'));
                                            }
                                            
                                            if (metaParts.length > 0) {
                                                metaHtml = `<div class="mt-2 d-flex flex-wrap">${metaParts.join('')}</div>`;
                                            }

                                            return `
                                            <li class="mb-3 pb-2 border-bottom">
                                                <div class="form-check w-100">
                                                    <input class="form-check-input question-checkbox" type="checkbox" value="${q.id}" id="${fileId}-${q.id}" checked>
                                                    <label class="form-check-label w-100" for="${fileId}-${q.id}">
                                                        <div class="d-flex justify-content-between align-items-start">
                                                            <div class="me-3">
                                                                <div class="fw-bold">${q.id}</div>
                                                                <div class="text-muted small">${q.description || ''}</div>
                                                                ${metaHtml}
                                                            </div>
                                                            ${levelsHtml}
                                                        </div>
                                                    </label>
                                                </div>
                                            </li>
                                        `}).join('')}
                                    </ul>
                                </div>
                            </td>
                        `;
                        fileListBody.appendChild(trDetails);
                    });
                    libraryContent.classList.remove('d-none');
                } else {
                    libraryEmpty.classList.remove('d-none');
                }
            })
            .catch(err => {
                libraryError.textContent = 'Error loading files: ' + err;
                libraryError.classList.remove('d-none');
            });
    });

    // Browse Button
    browseBtn.addEventListener('click', function() {
        fetch('/api/browse-folder')
            .then(r => r.json())
            .then(data => {
                if(data.path) {
                    libraryPathInput.value = data.path;
                }
            });
    });

    if (convertBrowseLibraryBtn && convertLibraryPathInput) {
        convertBrowseLibraryBtn.addEventListener('click', function() {
            fetch('/api/browse-folder')
                .then(r => r.json())
                .then(data => {
                    if (data.path) {
                        convertLibraryPathInput.value = data.path;
                        refreshConvertLanguages();
                    }
                });
        });
    }

    if (biometricsBrowseLibraryBtn) {
        biometricsBrowseLibraryBtn.addEventListener('click', function() {
            fetch('/api/browse-folder')
                .then(r => r.json())
                .then(data => {
                    if (data.path && biometricsLibraryPathInput) {
                        biometricsLibraryPathInput.value = data.path;
                    }
                });
        });
    }

    function refreshConvertLanguages() {
        const libraryPath = convertLibraryPathInput ? convertLibraryPathInput.value.trim() : '';
        const url = libraryPath
            ? `/api/survey-languages?library_path=${encodeURIComponent(libraryPath)}`
            : `/api/survey-languages`;
        fetch(url)
            .then(r => r.json())
            .then(data => {
                if (!convertLanguage) return;
                const current = convertLanguage.value || 'auto';

                // Reset options (keep Auto)
                convertLanguage.innerHTML = '';
                const autoOpt = document.createElement('option');
                autoOpt.value = 'auto';
                autoOpt.textContent = 'Auto (template default)';
                convertLanguage.appendChild(autoOpt);

                const langs = (data && data.languages) ? data.languages : [];
                langs.forEach(lang => {
                    const opt = document.createElement('option');
                    opt.value = lang;
                    opt.textContent = lang;
                    convertLanguage.appendChild(opt);
                });

                const preferred = (data && data.default) ? data.default : null;
                if (preferred && langs.includes(preferred)) {
                    convertLanguage.value = preferred;
                } else if (langs.includes(current)) {
                    convertLanguage.value = current;
                } else {
                    convertLanguage.value = 'auto';
                }
            })
            .catch(() => {
                // If this fails, keep the dropdown as-is (Auto only)
            });
    }

    if (convertLibraryPathInput) {
        convertLibraryPathInput.addEventListener('change', refreshConvertLanguages);
        convertLibraryPathInput.addEventListener('blur', refreshConvertLanguages);
    }

    function updateConvertBtn() {
        const hasFile = convertExcelFile.files && convertExcelFile.files.length === 1;
        convertBtn.disabled = !hasFile;
    }

    convertExcelFile.addEventListener('change', updateConvertBtn);
    updateConvertBtn();

    convertBtn.addEventListener('click', function() {
        convertError.classList.add('d-none');
        convertInfo.classList.add('d-none');
        convertError.textContent = '';
        convertInfo.textContent = '';

        const file = convertExcelFile.files && convertExcelFile.files[0];
        if (!file) {
            return;
        }

        const formData = new FormData();
        // Backend accepts both field names; keep 'excel' for backwards compatibility.
        formData.append('excel', file);

        const alias = convertAliasFile && convertAliasFile.files && convertAliasFile.files[0];
        if (alias) {
            formData.append('alias', alias);
        }

        if (convertLibraryPathInput && convertLibraryPathInput.value.trim()) {
            formData.append('library_path', convertLibraryPathInput.value.trim());
        }
        formData.append('dataset_name', convertDatasetName.value.trim());
        formData.append('unknown', convertUnknown.value);
        formData.append('language', convertLanguage ? convertLanguage.value : 'auto');

        convertBtn.disabled = true;
        convertInfo.textContent = 'Converting... this may take a moment.';
        convertInfo.classList.remove('d-none');

        fetch('/api/survey-convert', {
            method: 'POST',
            body: formData,
        })
        .then(async response => {
            if (!response.ok) {
                const data = await response.json().catch(() => null);
                const msg = data && data.error ? data.error : 'Conversion failed';
                throw new Error(msg);
            }

            const detected = {
                language: response.headers.get('X-Prism-Detected-Language'),
                platform: response.headers.get('X-Prism-Detected-SoftwarePlatform'),
                version: response.headers.get('X-Prism-Detected-SoftwareVersion'),
            };

            const blob = await response.blob();
            return { blob, detected };
        })
        .then(({ blob, detected }) => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'prism_survey_dataset.zip';
            document.body.appendChild(a);
            a.click();
            a.remove();

            const parts = [];
            if (detected && detected.language) parts.push(`language=${detected.language}`);
            if (detected && detected.platform) {
                if (detected.version) parts.push(`${detected.platform} ${detected.version}`);
                else parts.push(`${detected.platform}`);
            }
            const detectedMsg = parts.length ? ` Detected: ${parts.join(', ')}.` : '';
            convertInfo.textContent = 'Done. Your ZIP download should start automatically.' + detectedMsg;
            convertInfo.classList.remove('d-none');
        })
        .catch(err => {
            convertError.textContent = err.message;
            convertError.classList.remove('d-none');
        })
        .finally(() => {
            updateConvertBtn();
        });
    });

    function updateBiometricsBtn() {
        const hasFile = biometricsDataFile && biometricsDataFile.files && biometricsDataFile.files.length === 1;
        if (biometricsConvertBtn) biometricsConvertBtn.disabled = !hasFile;
    }

    if (biometricsDataFile) {
        biometricsDataFile.addEventListener('change', updateBiometricsBtn);
        updateBiometricsBtn();
    }

    if (biometricsConvertBtn) {
        biometricsConvertBtn.addEventListener('click', function() {
            biometricsError.classList.add('d-none');
            biometricsInfo.classList.add('d-none');
            biometricsError.textContent = '';
            biometricsInfo.textContent = '';

            const file = biometricsDataFile.files && biometricsDataFile.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('data', file);
            if (biometricsLibraryPathInput && biometricsLibraryPathInput.value.trim()) {
                formData.append('library_path', biometricsLibraryPathInput.value.trim());
            }
            formData.append('dataset_name', biometricsDatasetName.value.trim());
            formData.append('unknown', biometricsUnknown.value);

            biometricsConvertBtn.disabled = true;
            biometricsInfo.textContent = 'Converting... this may take a moment.';
            biometricsInfo.classList.remove('d-none');

            fetch('/api/biometrics-convert', {
                method: 'POST',
                body: formData,
            })
            .then(async response => {
                if (!response.ok) {
                    const data = await response.json().catch(() => null);
                    const msg = data && data.error ? data.error : 'Conversion failed';
                    throw new Error(msg);
                }
                const blob = await response.blob();
                return blob;
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'prism_biometrics_dataset.zip';
                document.body.appendChild(a);
                a.click();
                a.remove();
                biometricsInfo.textContent = 'Done. Your ZIP download should start automatically.';
                biometricsInfo.classList.remove('d-none');
            })
            .catch(err => {
                biometricsError.textContent = err.message;
                biometricsError.classList.remove('d-none');
            })
            .finally(() => {
                updateBiometricsBtn();
            });
        });
    }

    function updatePhysioBtn() {
        const hasFile = physioRawFile && physioRawFile.files && physioRawFile.files.length === 1;
        if (physioConvertBtn) physioConvertBtn.disabled = !hasFile;
    }

    if (physioRawFile) {
        physioRawFile.addEventListener('change', updatePhysioBtn);
        updatePhysioBtn();
    }

    if (physioConvertBtn) {
        physioConvertBtn.addEventListener('click', function() {
            physioError.classList.add('d-none');
            physioInfo.classList.add('d-none');
            physioError.textContent = '';
            physioInfo.textContent = '';

            const file = physioRawFile.files && physioRawFile.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('raw', file);
            formData.append('task', physioTask ? physioTask.value.trim() : 'rest');
            if (physioSamplingRate && physioSamplingRate.value) {
                formData.append('sampling_rate', physioSamplingRate.value);
            }

            physioConvertBtn.disabled = true;
            physioInfo.textContent = 'Converting... this may take a moment.';
            physioInfo.classList.remove('d-none');

            fetch('/api/physio-convert', {
                method: 'POST',
                body: formData,
            })
            .then(async response => {
                if (!response.ok) {
                    const data = await response.json().catch(() => null);
                    const msg = data && data.error ? data.error : 'Conversion failed';
                    throw new Error(msg);
                }
                const blob = await response.blob();
                return blob;
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'varioport_edfplus.zip';
                document.body.appendChild(a);
                a.click();
                a.remove();
                physioInfo.textContent = 'Done. Your ZIP download should start automatically.';
                physioInfo.classList.remove('d-none');
            })
            .catch(err => {
                physioError.textContent = err.message;
                physioError.classList.remove('d-none');
            })
            .finally(() => {
                updatePhysioBtn();
            });
        });
    }

    // Initial populate
    refreshConvertLanguages();

    // Select/Deselect All Files
    selectAllBtn.addEventListener('click', () => {
        document.querySelectorAll('.file-checkbox').forEach(cb => cb.checked = true);
        updateGenerateBtn();
    });
    deselectAllBtn.addEventListener('click', () => {
        document.querySelectorAll('.file-checkbox').forEach(cb => cb.checked = false);
        updateGenerateBtn();
    });

    // Select/Deselect All Questions (within a file)
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('select-all-q')) {
            const targetId = e.target.dataset.target;
            document.querySelector(`#${targetId}`).querySelectorAll('.question-checkbox').forEach(cb => cb.checked = true);
        }
        if (e.target.classList.contains('deselect-all-q')) {
            const targetId = e.target.dataset.target;
            document.querySelector(`#${targetId}`).querySelectorAll('.question-checkbox').forEach(cb => cb.checked = false);
        }
    });

    // Enable/Disable Generate Button
    fileListBody.addEventListener('change', updateGenerateBtn);

    function updateGenerateBtn() {
        const anyChecked = document.querySelectorAll('.file-checkbox:checked').length > 0;
        generateLssBtn.disabled = !anyChecked;
    }

    // Generate LSS
    generateLssBtn.addEventListener('click', function() {
        const selectedFiles = [];
        document.querySelectorAll('.file-checkbox:checked').forEach(cb => {
            const collapseId = cb.dataset.target;
            const collapseDiv = document.getElementById(collapseId);
            const questionCheckboxes = collapseDiv.querySelectorAll('.question-checkbox:checked');
            
            // Find matrix checkbox in the main row (parent tr of the file checkbox)
            const mainRow = cb.closest('tr');
            const matrixCheckbox = mainRow.querySelector('.matrix-checkbox');
            const isMatrix = matrixCheckbox ? matrixCheckbox.checked : false;
            
            // If no questions selected for this file, skip it? Or include all?
            // Let's assume we only include selected questions.
            const selectedQuestions = Array.from(questionCheckboxes).map(qcb => qcb.value);
            
            if (selectedQuestions.length > 0) {
                selectedFiles.push({
                    path: cb.value,
                    include: selectedQuestions,
                    matrix: isMatrix
                });
            }
        });

        if (selectedFiles.length === 0) {
            alert("Please select at least one file and one question.");
            return;
        }

        // Send to backend
        fetch('/api/generate-lss', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ files: selectedFiles }),
        })
        .then(response => {
            if (response.ok) {
                return response.blob();
            }
            throw new Error('Export failed');
        })
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "survey_export.lss";
            document.body.appendChild(a);
            a.click();
            a.remove();
        })
        .catch(err => {
            alert(err.message);
        });
    });
});
</script>
{% endblock %}
