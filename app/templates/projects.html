{% extends "base.html" %}

{% block title %}PRISM Studio - Projects{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/projects.css') }}">
{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="fas fa-folder-open text-primary me-2"></i>Project Manager</h2>
            <p class="text-muted">Create new PRISM/BIDS projects or validate existing ones.</p>
        </div>
    </div>

    {% if current_project.path %}
    <!-- Current Project Banner -->
    <div class="alert alert-success d-flex align-items-center mb-4" role="alert" id="currentProjectBanner">
        <i class="fas fa-check-circle me-3 fa-lg"></i>
        <div class="flex-grow-1">
            <strong>Current Working Project:</strong> {{ current_project.name }}
            <br><code class="small">{{ current_project.path }}</code>
        </div>
        <a href="{{ url_for('validation.validate_dataset') }}" class="btn btn-sm btn-outline-success me-2">
            <i class="fas fa-check-circle me-1"></i>Validate
        </a>
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearCurrentProject()">
            <i class="fas fa-times"></i>
        </button>
    </div>
    {% endif %}

    <!-- Project Type Selection -->
    <div class="row mb-4">
        <div class="col-md-6 mb-3">
            <div class="project-card" id="card-create" onclick="selectProjectType('create')">
                <i class="fas fa-plus-circle text-success"></i>
                <h5>Create New Project</h5>
                <p>Set up a new PRISM/BIDS-compatible folder structure</p>
            </div>
        </div>
        <div class="col-md-6 mb-3">
            <div class="project-card" id="card-open" onclick="selectProjectType('open')">
                <i class="fas fa-folder-open text-primary"></i>
                <h5>Open Existing Project</h5>
                <p>Validate and repair an existing project structure</p>
            </div>
        </div>
    </div>

    <!-- Create New Project Form -->
    <div class="form-section" id="section-create">
        <div class="card shadow-sm">
            <div class="card-header bg-success bg-opacity-10">
                <h5 class="mb-0"><i class="fas fa-plus-circle text-success me-2"></i>Create New Project</h5>
            </div>
            <div class="card-body">
                <form id="createProjectForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="projectName" class="form-label fw-bold">Project Name <span class="badge bg-danger">REQUIRED</span></label>
                            <input type="text" class="form-control" id="projectName" placeholder="my_study" required
                                   pattern="[a-zA-Z0-9_-]+" title="Only letters, numbers, underscores and hyphens allowed">
                            <small class="text-muted">No spaces allowed. A folder with this name will be created.</small>
                            <div class="invalid-feedback" id="projectNameError"></div>
                        </div>
                        <div class="col-md-6">
                            <label for="projectPath" class="form-label fw-bold">Project Location <span class="badge bg-danger">REQUIRED</span></label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="projectPath" placeholder="" required>
                                <button class="btn btn-outline-secondary" type="button" id="browseProjectPath">
                                    <i class="fas fa-folder-open"></i> Browse
                                </button>
                            </div>
                            <small class="text-muted">Parent folder where the project will be created</small>
                        </div>
                        
                        <div class="col-12">
                            <div class="alert alert-info border-0 bg-info bg-opacity-10 mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>YODA Layout:</strong> This will create a project following 
                                <a href="https://handbook.datalad.org/en/latest/basics/101-127-yoda.html" target="_blank">YODA principles</a>.
                                Raw data goes into the project dataset root, code into <code>code/</code>, and results into <code>analysis/</code>.
                                <div class="mt-2 small text-muted">
                                    Includes <code>project.json</code>, <code>contributors.json</code>, <code>CITATION.cff</code>, and <code>derivatives/qc/</code> for scientific project governance.
                                </div>
                            </div>
                        </div>

                        <div class="col-12 mt-3">
                            <div class="alert alert-info border-0 bg-info bg-opacity-10 mb-0">
                                <i class="fas fa-lightbulb me-2"></i>
                                <strong>Recommended Before Creating:</strong> Fill in the fields below (marked <span class="badge bg-danger">REQUIRED</span> or <span class="badge bg-warning text-dark">RECOMMENDED</span>) to ensure your dataset is BIDS-compliant and well-documented. <strong>You can create without them</strong>, but your dataset will be incomplete.
                                <div class="row mt-2">
                                    <div class="col-md-6">
                                        <strong class="small">BIDS Basics:</strong>
                                        <ul class="mb-1 small">
                                            <li><span class="badge bg-danger">REQUIRED</span> Dataset Name</li>
                                            <li><span class="badge bg-secondary">OPTIONAL</span> Authors</li>
                                            <li><span class="badge bg-warning text-dark">RECOMMENDED</span> License</li>
                                        </ul>
                                        <strong class="small">Study Design:</strong>
                                        <ul class="mb-1 small">
                                            <li>Study Design Type</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <strong class="small">Methods Context:</strong>
                                        <ul class="mb-1 small">
                                            <li>Dataset Overview</li>
                                            <li>Recruitment Method & Locations</li>
                                            <li>Inclusion/Exclusion Criteria</li>
                                        </ul>
                                    </div>
                                </div>
                                <small class="text-muted mt-2 d-block"><i class="fas fa-info-circle me-1"></i>See badges in each field for details. Only <span class="badge bg-danger">REQUIRED</span> fields must be filled for BIDS compliance.</small>
                            </div>
                        </div>

                        <div class="col-12 mt-4">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-folder-plus me-2"></i>Create Project
                            </button>
                        </div>
                    </div>
                </form>

                <!-- Create Result -->
                <div id="createResult" class="mt-4" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Open Existing Project Form -->
    <div class="form-section" id="section-open">
        <div class="card shadow-sm">
            <div class="card-header bg-primary bg-opacity-10" data-bs-toggle="collapse" data-bs-target="#openProjectSection"
                 role="button" aria-expanded="true" aria-controls="openProjectSection">
                <h5 class="mb-0 d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-folder-open text-primary me-2"></i>Project</span>
                    <i class="fas fa-chevron-down text-muted" id="openProjectChevron"></i>
                </h5>
            </div>
            <div class="collapse show" id="openProjectSection">
            <div class="card-body">
                <form id="openProjectForm">
                    <div class="row g-3">
                        <div class="col-md-7">
                            <label for="existingPath" class="form-label fw-bold">Select project.json</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="existingPath"
                                       placeholder="/Users/YourName/MyProject/project.json" required>
                                <button class="btn btn-outline-secondary" type="button" id="browseExistingPath" title="Open file picker (or type path manually)">
                                    <i class="fas fa-file-code"></i> Browse
                                </button>
                            </div>
                            <small class="text-muted" id="pathHelp">Type the full path to your <code>project.json</code> file, or click Browse to select it.</small>
                        </div>
                        <div class="col-md-5">
                            <label class="form-label fw-bold d-none d-md-block">&nbsp;</label>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-search me-2"></i>Load Project
                            </button>
                        </div>
                    </div>

                    <div class="mt-3" id="recentProjectsBlock" style="display: none;">
                        <label class="form-label fw-bold">Recent Projects</label>
                        <div id="recentProjectsList" class="d-flex flex-wrap gap-2"></div>
                    </div>
                </form>

                <!-- Validation Result -->
                <div id="validationResult" style="display: none;"></div>
            </div>
            </div>
        </div>
    </div>

    <!-- Study Metadata Card -->
    <div class="card shadow-sm mt-4" id="studyMetadataCard" style="display: none;">
        <div class="card-header bg-info bg-opacity-10" data-bs-toggle="collapse" data-bs-target="#studyMetadataSection"
             role="button" aria-expanded="false" aria-controls="studyMetadataSection">
            <h5 class="mb-0 d-flex justify-content-between align-items-center">
                <span><i class="fas fa-flask text-info me-2"></i>Study Metadata</span>
                <div class="d-flex align-items-center gap-2">
                    <div class="progress" style="width: 120px; height: 8px;" id="smHeaderProgress">
                        <div class="progress-bar" role="progressbar" id="smHeaderProgressBar" style="width: 0%"></div>
                    </div>
                    <span class="badge bg-secondary" id="smHeaderBadge">0%</span>
                    <i class="fas fa-chevron-down text-muted" id="studyMetadataChevron"></i>
                </div>
            </h5>
        </div>
        <div class="collapse" id="studyMetadataSection">
        <div class="card-body">
            <!-- Completeness Panel -->
            <div class="mb-3 p-3 bg-light rounded" id="smCompletenessPanel">
                <div class="d-flex align-items-center gap-3 mb-2">
                    <strong class="small text-uppercase text-muted">Methods Readiness</strong>
                    <div class="progress flex-grow-1" style="height: 12px;">
                        <div class="progress-bar" role="progressbar" id="smMainProgressBar" style="width: 0%"></div>
                    </div>
                    <span class="fw-bold" id="smMainScore">0%</span>
                </div>
                <div id="smSectionDots"></div>
            </div>

            <div class="alert alert-info border-0 bg-info bg-opacity-10 py-2 mb-3">
                <i class="fas fa-info-circle me-2"></i>
                This edits study methodology in <code>project.json</code> and dataset description in <code>dataset_description.json</code> at project root. 
                Saving this form auto-generates an ANC-compliant README from this metadata.
            </div>

            <form id="studyMetadataForm" novalidate>
                <!-- Basics (BIDS) Section -->
                <div class="mb-3">
                    <button class="btn btn-sm btn-outline-secondary w-100 text-start" type="button"
                            data-bs-toggle="collapse" data-bs-target="#smBasics">
                        <i class="fas fa-tags me-1"></i> Basics (BIDS)
                        <span class="float-end" id="smBasicsBadge"></span>
                    </button>
                    <div class="collapse show" id="smBasics">
                        <div class="card card-body border-0 bg-light mt-1">
                            <!-- Metadata Validation Feedback -->
                            <div id="metadataValidationFeedback" class="mb-3" style="display: none;"></div>
                            <div class="alert alert-info border-0 bg-info bg-opacity-10">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>BIDS Compliance:</strong> This edits <code>dataset_description.json</code> (BIDS standard).
                                Syncs to <code>CITATION.cff</code>. Legend:
                                <span class="badge bg-danger">REQUIRED</span>
                                <span class="badge bg-warning text-dark">RECOMMENDED</span>
                                <span class="badge bg-secondary">OPTIONAL</span>
                            </div>
                            <div class="row g-3">
                                <div class="col-md-12">
                                    <label class="form-label fw-bold small text-muted text-uppercase mb-1">
                                        <span class="badge bg-danger">REQUIRED</span> Dataset Name
                                    </label>
                                    <input type="text" class="form-control form-control-sm" id="metadataName" required>
                                    <small class="text-muted">BIDS: Name field. Also used in CITATION.cff.</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small text-muted text-uppercase mb-1">
                                        <span class="badge bg-secondary">OPTIONAL</span> Authors
                                    </label>
                                    <div id="metadataAuthorsList" class="d-flex flex-column gap-2"></div>
                                    <button type="button" class="btn btn-outline-secondary btn-sm mt-2" id="addAuthorRow">
                                        <i class="fas fa-user-plus me-1"></i>Add Author
                                    </button>
                                    <small class="text-muted d-block">If CITATION.cff exists, omitted per BIDS spec (use CITATION.cff authors instead).</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small text-muted text-uppercase mb-1">
                                        <span class="badge bg-warning text-dark">RECOMMENDED</span> License
                                    </label>
                                    <select class="form-select form-select-sm" id="metadataLicense">
                                        <option value="">Select a license...</option>
                                        <option value="CC0">CC0 (Public Domain)</option>
                                        <option value="CC BY 4.0">CC BY 4.0</option>
                                        <option value="CC BY-SA 4.0">CC BY-SA 4.0</option>
                                        <option value="CC BY-NC 4.0">CC BY-NC 4.0</option>
                                        <option value="CC BY-NC-SA 4.0">CC BY-NC-SA 4.0</option>
                                        <option value="ODbL 1.0">Open Database License (ODbL)</option>
                                        <option value="PDDL 1.0">Public Domain Dedication and License (PDDL)</option>
                                        <option value="Other">Other/Proprietary</option>
                                    </select>
                                    <small class="text-muted">If CITATION.cff exists, omitted from dataset_description.json.</small>
                                </div>
                                <div class="col-md-12">
                                    <label class="form-label fw-bold small text-muted text-uppercase mb-1">
                                        <span class="badge bg-secondary">OPTIONAL</span> Acknowledgements
                                    </label>
                                    <textarea class="form-control form-control-sm" id="metadataAcknowledgements" rows="2" placeholder="Funding, grants, people to thank..."></textarea>
                                </div>
                                <div class="col-md-12">
                                    <div class="mt-3 pt-3 border-top">
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label class="form-label fw-bold small text-muted text-uppercase mb-1">
                                                    <span class="badge bg-secondary">OPTIONAL</span> Dataset DOI
                                                </label>
                                                <input type="text" class="form-control form-control-sm" id="metadataDOI" placeholder="Example: 10.5281/zenodo.1234567">
                                                <small class="text-muted">Example only (placeholder). Enter your DOI only if available; syncs to CITATION.cff.</small>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label fw-bold small text-muted text-uppercase mb-1">
                                                    <span class="badge bg-warning text-dark">RECOMMENDED</span> Dataset Type
                                                </label>
                                                <select class="form-select form-select-sm" id="metadataType">
                                                    <option value="raw" selected>raw</option>
                                                    <option value="derivative">derivative</option>
                                                    <option value="study">study</option>
                                                </select>
                                            </div>
                                            <div class="col-md-12">
                                                <label class="form-label fw-bold small text-muted text-uppercase mb-1">
                                                    <span class="badge bg-secondary">OPTIONAL</span> Ethics Approvals
                                                </label>
                                                <div class="mb-2">
                                                    <input type="hidden" id="metadataEthicsApproved" value="no">
                                                    <div class="btn-group btn-group-sm" role="group" aria-label="Ethics approvals">
                                                        <button type="button" class="btn btn-outline-primary" id="metadataEthicsYes" onclick="setEthicsChoice('yes')">Yes</button>
                                                        <button type="button" class="btn btn-primary" id="metadataEthicsNo" onclick="setEthicsChoice('no')">No</button>
                                                    </div>
                                                </div>
                                                <div id="ethicsDetailsSection" style="display: none; margin-top: 12px;">
                                                    <div class="row g-2">
                                                        <div class="col-md-6">
                                                            <input type="text" class="form-control form-control-sm" id="metadataEthicsCommittee" placeholder="Example: Ethics Committee Name" required>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <input type="text" class="form-control form-control-sm" id="metadataEthicsVotum" placeholder="Example: EK-2026-014" required>
                                                        </div>
                                                    </div>
                                                </div>
                                                <small class="text-muted">Example format: Committee name, Reference number. Placeholder text is not saved.</small>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label fw-bold small text-muted text-uppercase mb-1">
                                                    <span class="badge bg-warning text-dark">RECOMMENDED</span> HED Version
                                                </label>
                                                <input type="text" class="form-control form-control-sm" id="metadataHED" placeholder="Example: 8.2.0">
                                                <small class="text-muted">Example only (placeholder). Leave empty if HED is not used in your data.</small>
                                            </div>
                                            <div class="col-md-12">
                                                <label class="form-label fw-bold small text-muted text-uppercase mb-1">
                                                    <span class="badge bg-warning text-dark">RECOMMENDED</span> Keywords (comma-separated)
                                                </label>
                                                <input type="text" class="form-control form-control-sm" id="metadataKeywords" placeholder="psychology, experiment, PRISM">
                                                <small class="text-muted">PRISM recommends at least 3 keywords for FAIR compliance and discoverability.</small>
                                            </div>
                                            <div class="col-md-12">
                                                <label class="form-label fw-bold small text-muted text-uppercase mb-1">
                                                    <span class="badge bg-secondary">OPTIONAL</span> Funding
                                                </label>
                                                <input type="text" class="form-control form-control-sm" id="metadataFunding" placeholder="National Science Foundation (NSF) Grant #1234567, Other funding sources">
                                                <small class="text-muted">Grant agency and numbers separated by commas.</small>
                                            </div>
                                            <div class="col-md-12">
                                                <label class="form-label fw-bold small text-muted text-uppercase mb-1">
                                                    <span class="badge bg-secondary">OPTIONAL</span> How to Acknowledge
                                                </label>
                                                <textarea class="form-control form-control-sm" id="metadataHowToAcknowledge" rows="2" placeholder="Please cite the following paper..."></textarea>
                                                <small class="text-muted">Stored in CITATION.cff. Omitted from dataset_description.json if CITATION.cff exists (per BIDS spec).</small>
                                            </div>
                                            <div class="col-md-12">
                                                <label class="form-label fw-bold small text-muted text-uppercase mb-1">
                                                    <span class="badge bg-secondary">OPTIONAL</span> References &amp; Links
                                                </label>
                                                <textarea class="form-control form-control-sm" id="metadataReferences" rows="2" placeholder="https://doi.org/..., https://example.com/..."></textarea>
                                                <small class="text-muted">URLs or citations separated by commas. Stored in CITATION.cff. Omitted from dataset_description.json if CITATION.cff exists (per BIDS spec).</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Overview Section -->
                <div class="mb-3">
                    <button class="btn btn-sm btn-outline-secondary w-100 text-start" type="button"
                            data-bs-toggle="collapse" data-bs-target="#smOverview">
                        <i class="fas fa-file-alt me-1"></i> Overview
                        <span class="float-end" id="smOverviewBadge"></span>
                    </button>
                    <div class="collapse show" id="smOverview">
                        <div class="card card-body border-0 bg-light mt-1">
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label fw-bold small">
                                        <span class="badge bg-danger">REQUIRED</span> Dataset Overview
                                    </label>
                                    <textarea class="form-control form-control-sm" id="smOverviewMain" rows="4"
                                              placeholder="A brief paragraph describing the goals, purpose, and unique value of this dataset..."></textarea>
                                    <small class="text-muted">Include: Why was this dataset created? What makes it unique and valuable?</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">Independent Variables</label>
                                    <textarea class="form-control form-control-sm" id="smOverviewIV" rows="3"
                                              placeholder="One per line (e.g., pleasant vs. unpleasant images)"></textarea>
                                    <small class="text-muted">Condition variables that were manipulated</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">Dependent Variables</label>
                                    <textarea class="form-control form-control-sm" id="smOverviewDV" rows="3"
                                              placeholder="One per line (e.g., reaction times, BOLD signal)"></textarea>
                                    <small class="text-muted">Response variables that were measured</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">Control Variables</label>
                                    <textarea class="form-control form-control-sm" id="smOverviewCV" rows="3"
                                              placeholder="One per line (e.g., age, sex, reading performance)"></textarea>
                                    <small class="text-muted">Aspects that were explicitly controlled</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">Quality Assessment</label>
                                    <textarea class="form-control form-control-sm" id="smOverviewQA" rows="3"
                                              placeholder="Link to quality report or brief quality notes"></textarea>
                                    <small class="text-muted">Reference to quality control measures</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Study Design -->
                <div class="mb-3">
                    <button class="btn btn-sm btn-outline-secondary w-100 text-start" type="button"
                            data-bs-toggle="collapse" data-bs-target="#smStudyDesign">
                        <i class="fas fa-drafting-compass me-1"></i> Study Design
                        <span class="float-end" id="smStudyDesignBadge"></span>
                    </button>
                    <div class="collapse show" id="smStudyDesign">
                        <div class="card card-body border-0 bg-light mt-1">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label fw-bold small">
                                        <span class="badge bg-danger">REQUIRED</span> Study Design Type
                                    </label>
                                    <select class="form-select form-select-sm" id="smSDType" onchange="toggleExperimentalFields()">
                                        <option value="">-- Select --</option>
                                        <option value="cross-sectional">Cross-sectional</option>
                                        <option value="longitudinal">Longitudinal</option>
                                        <option value="randomized-controlled-trial">Randomized Controlled Trial</option>
                                        <option value="quasi-experimental">Quasi-experimental</option>
                                        <option value="case-control">Case-control</option>
                                        <option value="cohort">Cohort</option>
                                        <option value="single-case">Single-case</option>
                                        <option value="mixed-methods">Mixed methods</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold small">Condition Type</label>
                                    <select class="form-select form-select-sm" id="smSDConditionType">
                                        <option value="">-- N/A --</option>
                                        <option value="between-subjects">Between-subjects</option>
                                        <option value="within-subjects">Within-subjects</option>
                                        <option value="mixed">Mixed</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold small">Type Description</label>
                                    <input type="text" class="form-control form-control-sm" id="smSDTypeDesc"
                                           placeholder="e.g. 2x2 factorial design">
                                </div>
                                <div class="col-12" id="smExperimentalFields" style="display: none;">
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label class="form-label fw-bold small">Blinding</label>
                                            <select class="form-select form-select-sm" id="smSDBlinding">
                                                <option value="">-- None --</option>
                                                <option value="none">None</option>
                                                <option value="single-blind">Single-blind</option>
                                                <option value="double-blind">Double-blind</option>
                                                <option value="triple-blind">Triple-blind</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label fw-bold small">Randomization</label>
                                            <input type="text" class="form-control form-control-sm" id="smSDRandomization"
                                                   placeholder="Randomization procedure">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label fw-bold small">Control Condition</label>
                                            <input type="text" class="form-control form-control-sm" id="smSDControl"
                                                   placeholder="Control condition">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recruitment -->
                <div class="mb-3">
                    <button class="btn btn-sm btn-outline-secondary w-100 text-start" type="button"
                            data-bs-toggle="collapse" data-bs-target="#smRecruitment">
                        <i class="fas fa-users me-1"></i> Recruitment
                        <span class="float-end" id="smRecruitmentBadge"></span>
                    </button>
                    <div class="collapse" id="smRecruitment">
                        <div class="card card-body border-0 bg-light mt-1">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">
                                        <span class="badge bg-danger">REQUIRED</span> Method
                                    </label>
                                    <select class="form-select form-select-sm" id="smRecMethod" multiple>
                                        <option value="">-- Select --</option>
                                        <option value="online-ads">Online ads</option>
                                        <option value="email-lists">University mailing lists</option>
                                        <option value="participant-pool">Participant pool</option>
                                        <option value="clinical-referral">Clinical referral</option>
                                        <option value="community-outreach">Community outreach</option>
                                        <option value="school-recruitment">School recruitment</option>
                                        <option value="social-media">Social media</option>
                                        <option value="flyers-posters">Flyers/posters</option>
                                        <option value="snowball">Snowball sampling</option>
                                        <option value="other">Other</option>
                                    </select>
                                    <small class="text-muted">Hold Cmd/Ctrl to select multiple.</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">
                                        <span class="badge bg-danger">REQUIRED</span> Location
                                    </label>
                                    <div id="smRecLocationList" class="d-flex flex-column gap-2"></div>
                                    <div class="form-check mt-2">
                                        <input class="form-check-input" type="checkbox" id="smRecLocationOnlineOnly">
                                        <label class="form-check-label small" for="smRecLocationOnlineOnly">
                                            Online-only recruitment
                                        </label>
                                    </div>
                                    <button type="button" class="btn btn-outline-secondary btn-sm mt-2" id="addRecLocationRow">
                                        <i class="fas fa-plus me-1"></i>Add Location
                                    </button>
                                    <small class="text-muted d-block">Country is required; city is optional.</small>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold small">
                                        <span class="badge bg-danger">REQUIRED</span> Period Start
                                    </label>
                                    <div class="d-flex gap-2">
                                        <select class="form-select form-select-sm" id="smRecPeriodStartYear" required></select>
                                        <select class="form-select form-select-sm" id="smRecPeriodStartMonth" required></select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold small">
                                        <span class="badge bg-danger">REQUIRED</span> Period End
                                    </label>
                                    <div class="d-flex gap-2">
                                        <select class="form-select form-select-sm" id="smRecPeriodEndYear" required></select>
                                        <select class="form-select form-select-sm" id="smRecPeriodEndMonth" required></select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold small">
                                        <span class="badge bg-danger">REQUIRED</span> Financial Compensation
                                    </label>
                                    <select class="form-select form-select-sm" id="smRecCompensation" required>
                                        <option value="">-- Select --</option>
                                        <option value="Financial compensation">Yes</option>
                                        <option value="No financial compensation">No</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Eligibility -->
                <div class="mb-3">
                    <button class="btn btn-sm btn-outline-secondary w-100 text-start" type="button"
                            data-bs-toggle="collapse" data-bs-target="#smEligibility">
                        <i class="fas fa-user-check me-1"></i> Eligibility
                        <span class="float-end" id="smEligibilityBadge"></span>
                    </button>
                    <div class="collapse" id="smEligibility">
                        <div class="card card-body border-0 bg-light mt-1">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">
                                        <span class="badge bg-danger">REQUIRED</span> Inclusion Criteria
                                    </label>
                                    <textarea class="form-control form-control-sm" id="smEligInclusion" rows="3"
                                              placeholder="One criterion per line"></textarea>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">
                                        <span class="badge bg-danger">REQUIRED</span> Exclusion Criteria
                                    </label>
                                    <textarea class="form-control form-control-sm" id="smEligExclusion" rows="3"
                                              placeholder="One criterion per line"></textarea>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold small">Target Sample Size</label>
                                    <input type="number" class="form-control form-control-sm" id="smEligSampleSize"
                                           min="1" placeholder="N">
                                </div>
                                <div class="col-md-8">
                                    <label class="form-label fw-bold small">Power Analysis</label>
                                    <input type="text" class="form-control form-control-sm" id="smEligPower"
                                           placeholder="e.g. G*Power, medium effect size d=0.5, alpha=.05, power=.80">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Procedure -->
                <div class="mb-3">
                    <button class="btn btn-sm btn-outline-secondary w-100 text-start" type="button"
                            data-bs-toggle="collapse" data-bs-target="#smProcedure">
                        <i class="fas fa-list-ol me-1"></i> Procedure
                        <span class="float-end" id="smProcedureBadge"></span>
                    </button>
                    <div class="collapse" id="smProcedure">
                        <div class="card card-body border-0 bg-light mt-1">
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label fw-bold small">
                                        <span class="badge bg-danger">REQUIRED</span> Overview
                                    </label>
                                    <textarea class="form-control form-control-sm" id="smProcOverview" rows="3"
                                              placeholder="Narrative overview of the study procedure..."></textarea>
                                </div>
                                <div class="col-12">
                                    <button class="btn btn-link btn-sm p-0 text-decoration-none" type="button"
                                            data-bs-toggle="collapse" data-bs-target="#smProcMore">
                                        <i class="fas fa-chevron-down me-1"></i>More Fields
                                    </button>
                                    <div class="collapse mt-2" id="smProcMore">
                                        <div class="row g-3">
                                            <div class="col-md-12">
                                                <label class="form-label fw-bold small">Informed Consent</label>
                                                <textarea class="form-control form-control-sm" id="smProcConsent" rows="2"
                                                          placeholder="How was informed consent obtained?"></textarea>
                                            </div>
                                            <div class="col-md-12">
                                                <label class="form-label fw-bold small">Quality Control</label>
                                                <textarea class="form-control form-control-sm" id="smProcQC" rows="2"
                                                          placeholder="One measure per line (e.g. Attention checks)"></textarea>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label fw-bold small">Missing Data Handling</label>
                                                <input type="text" class="form-control form-control-sm" id="smProcMissing"
                                                       placeholder="How was missing data handled?">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label fw-bold small">Debriefing</label>
                                                <textarea class="form-control form-control-sm" id="smProcDebriefing" rows="2"
                                                          placeholder="Debriefing procedure"></textarea>
                                            </div>
                                            <div class="col-12">
                                                <label class="form-label fw-bold small">Additional Data Acquired</label>
                                                <textarea class="form-control form-control-sm" id="smProcAdditionalData" rows="2"
                                                          placeholder="Other data collected (questionnaires, swabs, clinical info, etc.)"></textarea>
                                                <small class="text-muted">Especially relevant if not included in dataset</small>
                                            </div>
                                            <div class="col-12">
                                                <label class="form-label fw-bold small">Notes</label>
                                                <textarea class="form-control form-control-sm" id="smProcNotes" rows="2"
                                                          placeholder="Additional information about the procedure..."></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Missing Data & Issues -->
                <div class="mb-3">
                    <button class="btn btn-sm btn-outline-secondary w-100 text-start" type="button"
                            data-bs-toggle="collapse" data-bs-target="#smMissingData">
                        <i class="fas fa-exclamation-triangle me-1"></i> Missing Data & Known Issues
                        <span class="float-end" id="smMissingDataBadge"></span>
                    </button>
                    <div class="collapse" id="smMissingData">
                        <div class="card card-body border-0 bg-light mt-1">
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="alert alert-info py-2 mb-0">
                                        <i class="fas fa-info-circle me-2"></i>
                                        Fill this section after data acquisition. Leave empty when starting a study.
                                    </div>
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-bold small">Missing Data Description</label>
                                    <textarea class="form-control form-control-sm" id="smMissingDesc" rows="3"
                                              placeholder="General description of missing or problematic data..."></textarea>
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-bold small">Missing Files (Table)</label>
                                    <textarea class="form-control form-control-sm" id="smMissingFiles" rows="3"
                                              placeholder="Format: sub-001 | T1w, task-rest&#10;sub-002 | ses-2 functional scans"></textarea>
                                    <small class="text-muted">One entry per line: SubjectID | What's missing</small>
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-bold small">Known Issues (Table)</label>
                                    <textarea class="form-control form-control-sm" id="smKnownIssues" rows="3"
                                              placeholder="Format: sub-001_task-nback_bold.nii | Shorter scan&#10;sub-002_T1w.nii | Resolution differs"></textarea>
                                    <small class="text-muted">One entry per line: Filename | Issue description</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- References -->
                <div class="mb-3">
                    <button class="btn btn-sm btn-outline-secondary w-100 text-start" type="button"
                            data-bs-toggle="collapse" data-bs-target="#smReferences">
                        <i class="fas fa-book me-1"></i> References
                        <span class="float-end" id="smReferencesBadge"></span>
                    </button>
                    <div class="collapse" id="smReferences">
                        <div class="card card-body border-0 bg-light mt-1">
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label fw-bold small">References</label>
                                    <textarea class="form-control form-control-sm" id="smReferences" rows="4"
                                              placeholder="One reference per line or formatted citations..."></textarea>
                                    <small class="text-muted">References used within the README</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-end">
                    <button type="submit" class="btn btn-info">
                        <i class="fas fa-save me-1"></i>Save Study Metadata
                    </button>
                    <small class="text-muted d-block mt-2">
                        <i class="fas fa-info-circle me-1"></i>Saving will auto-generate README.md
                    </small>
                </div>
            </form>
        </div>
        </div>
    </div>

    <!-- Generate Methods Section Card -->
    <div class="card shadow-sm mt-4" id="methodsSectionCard" style="display: none;">
        <div class="card-header bg-success bg-opacity-10" data-bs-toggle="collapse" data-bs-target="#methodsSectionBody"
             role="button" aria-expanded="false" aria-controls="methodsSectionBody">
            <h5 class="mb-0 d-flex justify-content-between align-items-center">
                <span><i class="fas fa-file-alt text-success me-2"></i>Generate Methods Section</span>
                <i class="fas fa-chevron-down text-muted" id="methodsSectionChevron"></i>
            </h5>
        </div>
        <div class="collapse" id="methodsSectionBody">
            <div class="card-body">
                <p class="text-muted mb-3">
                    Create a publication-ready methods section from your project metadata.
                    Uses data from <code>project.json</code>, <code>dataset_description.json</code>, and linked templates.
                </p>
                <div class="row align-items-end mb-3 g-2">
                    <div class="col-auto">
                        <label for="methodsLanguage" class="form-label fw-bold mb-1">Language</label>
                        <select class="form-select form-select-sm" id="methodsLanguage" style="width: 140px;">
                            <option value="en" selected>English</option>
                            <option value="de">German</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <label for="methodsDetailLevel" class="form-label fw-bold mb-1">Detail Level</label>
                        <select class="form-select form-select-sm" id="methodsDetailLevel" style="width: 150px;">
                            <option value="brief">Brief</option>
                            <option value="standard" selected>Standard</option>
                            <option value="detailed">Detailed</option>
                        </select>
                    </div>
                    <div class="col-auto d-flex align-items-end">
                        <div class="form-check mb-1">
                            <input class="form-check-input" type="checkbox" id="methodsContinuous">
                            <label class="form-check-label" for="methodsContinuous">Continuous text</label>
                        </div>
                    </div>
                    <div class="col-auto">
                        <button type="button" class="btn btn-success" id="generateMethodsBtn" onclick="generateMethodsSection()">
                            <i class="fas fa-magic me-1"></i>Generate
                        </button>
                    </div>
                </div>

                <div id="methodsResult" style="display: none;">
                    <div id="methodsSectionsBadges" class="mb-2"></div>
                    <div id="methodsPreview" class="border rounded p-3 bg-white mb-3" style="max-height: 500px; overflow-y: auto;"></div>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="downloadMethods('md')">
                            <i class="fas fa-download me-1"></i>Download .md
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="downloadMethods('html')">
                            <i class="fas fa-download me-1"></i>Download .html
                        </button>
                    </div>
                </div>

                <div id="methodsError" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Data Export/Share Card -->
    <div class="card shadow-sm mt-4" id="exportProjectCard" style="display: none;">
        <div class="card-header bg-warning bg-opacity-10" data-bs-toggle="collapse" data-bs-target="#exportSection"
             role="button" aria-expanded="false" aria-controls="exportSection">
            <h5 class="mb-0 d-flex justify-content-between align-items-center">
                <span><i class="fas fa-share-alt text-warning me-2"></i>Data Export / Share</span>
                <i class="fas fa-chevron-down text-muted" id="exportChevron"></i>
            </h5>
        </div>
        <div class="collapse" id="exportSection">
            <div class="card-body">
                <div class="alert alert-warning border-warning mb-4">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Important:</strong> Before sharing data publicly, consider copyright (survey questions) and anonymity (participant IDs).
                    This tool helps you create a shareable, anonymized version of your dataset.
                </div>

                <form id="exportProjectForm">
                    <div class="row g-3">
                        <!-- Anonymization Options -->
                        <div class="col-12">
                            <h6 class="mb-3"><i class="fas fa-user-secret me-2"></i>Anonymization</h6>
                        </div>

                        <div class="col-md-6">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="exportAnonymize" checked>
                                <label class="form-check-label fw-bold" for="exportAnonymize">
                                    Randomize Participant IDs
                                </label>
                            </div>
                            <div class="form-text ms-4">
                                Transform subject codes (e.g., sub-001  sub-R7X2K9) throughout the entire dataset.
                                A secure mapping file will be included in the export for re-identification if needed.
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label for="exportIdLength" class="form-label">Random ID Length</label>
                            <select class="form-select form-select-sm" id="exportIdLength">
                                <option value="6">6 characters (64K combinations)</option>
                                <option value="8" selected>8 characters (2.8M combinations)</option>
                                <option value="10">10 characters (100M combinations)</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="exportMaskQuestions">
                                <label class="form-check-label fw-bold" for="exportMaskQuestions">
                                    Mask Copyrighted Question Text
                                </label>
                            </div>
                            <div class="form-text ms-4">
                                Strip original question descriptions from JSON sidecars (survey/biometrics).
                                Replaces with generic labels like "Question 1", "Question 2", etc.
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="exportDeterministic" checked>
                                <label class="form-check-label" for="exportDeterministic">
                                    Deterministic Mapping
                                </label>
                            </div>
                            <div class="form-text ms-4">
                                Same input always generates same random IDs (useful for reproducibility).
                            </div>
                        </div>

                        <!-- Content Options -->
                        <div class="col-12 mt-4">
                            <hr>
                            <h6 class="mb-3"><i class="fas fa-archive me-2"></i>Export Content</h6>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold">Include in Export:</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="exportRawdata" checked disabled>
                                <label class="form-check-label" for="exportRawdata">
                                    Dataset root files and <code>sub-*/</code> folders - Raw experimental data
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="exportDerivatives" checked>
                                <label class="form-check-label" for="exportDerivatives">
                                    <code>derivatives/</code> - Processed data
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="exportCode" checked>
                                <label class="form-check-label" for="exportCode">
                                    <code>code/</code> - Analysis scripts and recipes
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="exportAnalysis">
                                <label class="form-check-label" for="exportAnalysis">
                                    <code>analysis/</code> - Results and reports
                                </label>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold">Metadata:</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="exportMetadata" checked disabled>
                                <label class="form-check-label" for="exportMetadata">
                                    Project metadata files (dataset_description.json, README, etc.)
                                </label>
                            </div>
                            <div class="form-text small text-muted ms-4">
                                Mapping file will always be included if anonymization is enabled.
                            </div>
                        </div>

                        <!-- AND Export Section -->
                        <div class="col-12 mt-4">
                            <hr>
                            <h6 class="mb-3">
                                <i class="fas fa-cloud-upload-alt me-2"></i>AND (Austrian NeuroCloud) Export
                                <span class="badge bg-info ms-2">New</span>
                            </h6>
                        </div>

                        <div class="col-12">
                            <div class="alert alert-info border-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>AND Export:</strong> Converts your PRISM dataset to AND-compatible format with required files 
                                (README, CITATION.cff, .bids-validator-config.json) for submission to Austrian NeuroCloud.
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="ancEnableExport">
                                <label class="form-check-label fw-bold" for="ancEnableExport">
                                    Enable AND Export
                                </label>
                            </div>
                            <div class="form-text ms-4">
                                Prepare dataset for AND submission with all required metadata files.
                            </div>
                        </div>

                        <div class="col-md-6" id="ancOptionsGroup" style="display: none;">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="ancConvertGitLfs">
                                <label class="form-check-label" for="ancConvertGitLfs">
                                    Convert to Git LFS
                                </label>
                            </div>
                            <div class="form-text ms-4">
                                Create .gitattributes for Git LFS (if required by AND). Default: DataLad-compatible.
                            </div>
                        </div>

                        <div class="col-md-6" id="ancOptionsGroup2" style="display: none;">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="ancIncludeCiExamples">
                                <label class="form-check-label" for="ancIncludeCiExamples">
                                    Include CI/CD Examples
                                </label>
                            </div>
                            <div class="form-text ms-4">
                                Add example GitLab CI and GitHub Actions workflows for dataset validation.
                            </div>
                        </div>

                        <div class="col-12" id="ancMetadataSection" style="display: none;">
                            <button type="button" class="btn btn-sm btn-outline-info mb-3" data-bs-toggle="collapse" 
                                    data-bs-target="#ancMetadataForm" aria-expanded="false">
                                <i class="fas fa-edit me-1"></i>Edit AND Metadata (Optional)
                            </button>
                            <div class="collapse" id="ancMetadataForm">
                                <div class="card border-info">
                                    <div class="card-body">
                                        <div class="row g-2">
                                            <div class="col-md-6">
                                                <label class="form-label small fw-bold">Dataset Title</label>
                                                <input type="text" class="form-control form-control-sm" id="ancDatasetTitle" 
                                                       placeholder="Filled from dataset_description.json">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small fw-bold">Contact Email</label>
                                                <input type="email" class="form-control form-control-sm" id="ancContactEmail" 
                                                       placeholder="contact@university.edu">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small fw-bold">Author First Name</label>
                                                <input type="text" class="form-control form-control-sm" id="ancAuthorGiven" 
                                                       placeholder="John">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small fw-bold">Author Last Name</label>
                                                <input type="text" class="form-control form-control-sm" id="ancAuthorFamily" 
                                                       placeholder="Doe">
                                            </div>
                                            <div class="col-12">
                                                <label class="form-label small fw-bold">Dataset Description</label>
                                                <textarea class="form-control form-control-sm" id="ancDatasetDescription" 
                                                          rows="2" placeholder="Brief description of your dataset..."></textarea>
                                            </div>
                                            <div class="col-12">
                                                <div class="form-text small">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    Leave fields empty to use values from dataset_description.json. 
                                                    Full metadata can be edited after export.
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Export Buttons -->
                        <div class="col-12 mt-4">
                            <button type="submit" class="btn btn-warning btn-lg me-2">
                                <i class="fas fa-download me-2"></i>Standard Export & Download
                            </button>
                            <button type="button" class="btn btn-info btn-lg" id="ancExportButton" style="display: none;">
                                <i class="fas fa-cloud-upload-alt me-2"></i>Export for AND
                            </button>
                            <div class="form-text mt-2">
                                <i class="fas fa-info-circle me-1"></i>
                                Standard export creates a shareable ZIP. AND export creates a submission-ready dataset folder.
                            </div>
                        </div>
                    </div>
                </form>

                <!-- Export Progress -->
                <div id="exportProgress" class="mt-4" style="display: none;">
                    <div class="alert alert-info">
                        <i class="fas fa-spinner fa-spin me-2"></i>
                        <span id="exportStatusText">Preparing export...</span>
                    </div>
                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" id="exportProgressBar" style="width: 0%">
                            <span id="exportProgressText">0%</span>
                        </div>
                    </div>
                </div>

                <!-- Export Result -->
                <div id="exportResult" class="mt-4" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Global Settings Card (Last Section) -->
    <div class="card shadow-sm mt-4">
        <div class="card-header bg-secondary bg-opacity-10" data-bs-toggle="collapse" data-bs-target="#settingsSection"
             role="button" aria-expanded="false" aria-controls="settingsSection">
            <h5 class="mb-0 d-flex justify-content-between align-items-center">
                <span><i class="fas fa-cog text-secondary me-2"></i>Global Settings</span>
                <i class="fas fa-chevron-down text-muted" id="settingsChevron"></i>
            </h5>
        </div>
        <div class="collapse" id="settingsSection">
            <div class="card-body">
                <form id="globalSettingsForm">
                    <div class="row g-3">
                        <div class="col-12">
                            <label for="globalLibraryPath" class="form-label fw-bold">
                                <i class="fas fa-database me-1"></i>Global Survey Template Library
                            </label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="globalLibraryPath"
                                       placeholder="Path to folder containing survey/ subfolder">
                                <button class="btn btn-outline-secondary" type="button" id="browseGlobalLibrary">
                                    <i class="fas fa-folder-open"></i> Browse
                                </button>
                            </div>
                            <small class="text-muted">
                                Root folder for survey templates. Must contain a <code>survey/</code> subfolder with JSON templates.
                                <br>Default: App's built-in <code>survey_library/</code> folder. Can be changed to a shared location (Nextcloud, GitLab, etc.).
                                <br>Projects can override this with <code>templateLibraryPath</code> in <code>.prismrc.json</code>.
                            </small>
                        </div>
                        <div class="col-12">
                            <label for="globalRecipesPath" class="form-label fw-bold">
                                <i class="fas fa-utensils me-1"></i>Global Recipe Library
                            </label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="globalRecipesPath"
                                       placeholder="Path to folder containing recipe/ subfolder">
                                <button class="btn btn-outline-secondary" type="button" id="browseGlobalRecipes">
                                    <i class="fas fa-folder-open"></i> Browse
                                </button>
                            </div>
                            <small class="text-muted">
                                Root folder for survey recipes. Must contain a <code>recipe/</code> subfolder with recipe JSON files.
                                <br>Default: <code>official/recipe/</code> folder. Can be changed to a shared location.
                                <br>Recipes are automatically used in the "Dataset Recipes & Scoring" tool.
                            </small>
                        </div>
                        <div class="col-12">
                            <div id="libraryStatusMessage"></div>
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-secondary">
                                <i class="fas fa-save me-2"></i>Save Settings
                            </button>
                            <button type="button" class="btn btn-outline-info ms-2" onclick="useDefaultLibrary()">
                                <i class="fas fa-undo me-1"></i>Use Default
                            </button>
                            <button type="button" class="btn btn-outline-danger ms-2" onclick="clearGlobalLibrary()">
                                <i class="fas fa-times me-1"></i>Clear
                            </button>
                        </div>
                    </div>
                </form>

                <!-- Library Info Panel -->
                <div id="libraryInfoPanel" class="mt-4 p-3 bg-light rounded" style="display: none;">
                    <h6 class="mb-3"><i class="fas fa-info-circle me-2"></i>Survey Template Locations</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-2">
                                <div class="card-body py-2">
                                    <small class="text-muted">Global Survey Templates (Read-only)</small>
                                    <div id="globalLibraryInfo" class="text-truncate">
                                        <span class="text-muted">Not configured</span>
                                    </div>
                                    <small class="text-muted">Path: <code>*/survey/*.json</code></small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-2">
                                <div class="card-body py-2">
                                    <small class="text-muted">Project Survey Templates (Editable)</small>
                                    <div id="projectLibraryInfo" class="text-truncate">
                                        <span class="text-muted">Select a project</span>
                                    </div>
                                    <small class="text-muted">Path: <code>project/library/survey/*.json</code> (Root level)</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <small class="text-muted">
                        <i class="fas fa-lightbulb me-1"></i>
                        Survey templates from both locations are merged. Project templates take priority over global templates with the same name.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/neurobagel.js') }}"></script>
<script>
    // Template variables - must be rendered server-side
    window.currentProjectPath = "{{ current_project.path or '' }}";
    window.currentProjectName = "{{ current_project.name or '' }}";
</script>
<!-- External JavaScript modules -->
<script src="{{ url_for('static', filename='js/projects-helpers.js') }}"></script>
<script src="{{ url_for('static', filename='js/projects-core.js') }}"></script>
<script src="{{ url_for('static', filename='js/projects-metadata.js') }}"></script>
<script src="{{ url_for('static', filename='js/projects-export.js') }}"></script>
<script src="{{ url_for('static', filename='js/project-validation.js') }}"></script>
{% endblock %}
