{% extends "base.html" %}

{% block title %}PRISM Studio - Projects{% endblock %}

{% block styles %}
<style>
    .project-card {
        border: 2px solid #dee2e6;
        border-radius: 12px;
        padding: 30px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        height: 100%;
    }
    .project-card:hover {
        border-color: #0d6efd;
        box-shadow: 0 4px 15px rgba(13, 110, 253, 0.15);
        transform: translateY(-2px);
    }
    .project-card.active {
        border-color: #0d6efd;
        background-color: #f8f9ff;
    }
    .project-card i {
        font-size: 3rem;
        margin-bottom: 15px;
    }
    .project-card h5 {
        margin-bottom: 10px;
    }
    .project-card p {
        color: #6c757d;
        font-size: 0.9rem;
        margin-bottom: 0;
    }
    .form-section {
        display: none;
        animation: fadeIn 0.3s ease;
    }
    .form-section.active {
        display: block;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .validation-result {
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
    }
    .validation-result.valid {
        background-color: #d1e7dd;
        border: 1px solid #badbcc;
    }
    .validation-result.invalid {
        background-color: #f8d7da;
        border: 1px solid #f5c2c7;
    }
    .validation-result.warning {
        background-color: #fff3cd;
        border: 1px solid #ffecb5;
    }
    .issue-item {
        padding: 10px 15px;
        margin-bottom: 8px;
        border-radius: 6px;
        background-color: #fff;
        border-left: 4px solid;
    }
    .issue-item.fixable {
        border-left-color: #ffc107;
    }
    .issue-item.not-fixable {
        border-left-color: #dc3545;
    }
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }
    .stat-item {
        text-align: center;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 8px;
    }
    .stat-item .stat-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #0d6efd;
    }
    .stat-item .stat-label {
        font-size: 0.85rem;
        color: #6c757d;
    }
    /* Study Metadata completeness */
    .completeness-dots { display: flex; flex-wrap: wrap; gap: 6px; align-items: center; }
    .completeness-dot {
        width: 12px; height: 12px; border-radius: 50%; display: inline-block;
    }
    .completeness-dot.full { background-color: #198754; }
    .completeness-dot.partial { background-color: #ffc107; }
    .completeness-dot.empty { background-color: #dee2e6; }
    .section-completeness-row {
        display: flex; align-items: center; gap: 8px; padding: 4px 0;
    }
    .section-completeness-row .section-label {
        min-width: 140px; font-size: 0.85rem; font-weight: 500;
    }
    .section-completeness-row .section-badge {
        font-size: 0.75rem;
    }
    .sm-hint-badge { transition: opacity 0.2s; }
    .sm-hint-badge:hover { opacity: 0.8; }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="fas fa-folder-open text-primary me-2"></i>Project Manager</h2>
            <p class="text-muted">Create new PRISM/BIDS projects or validate existing ones.</p>
        </div>
    </div>

    {% if current_project.path %}
    <!-- Current Project Banner -->
    <div class="alert alert-success d-flex align-items-center mb-4" role="alert" id="currentProjectBanner">
        <i class="fas fa-check-circle me-3 fa-lg"></i>
        <div class="flex-grow-1">
            <strong>Current Working Project:</strong> {{ current_project.name }}
            <br><code class="small">{{ current_project.path }}</code>
        </div>
        <a href="{{ url_for('validation.validate_dataset') }}" class="btn btn-sm btn-outline-success me-2">
            <i class="fas fa-check-circle me-1"></i>Validate
        </a>
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearCurrentProject()">
            <i class="fas fa-times"></i>
        </button>
    </div>
    {% endif %}

    <!-- Project Type Selection -->
    <div class="row mb-4">
        <div class="col-md-6 mb-3">
            <div class="project-card" id="card-create" onclick="selectProjectType('create')">
                <i class="fas fa-plus-circle text-success"></i>
                <h5>Create New Project</h5>
                <p>Set up a new PRISM/BIDS-compatible folder structure</p>
            </div>
        </div>
        <div class="col-md-6 mb-3">
            <div class="project-card" id="card-open" onclick="selectProjectType('open')">
                <i class="fas fa-folder-open text-primary"></i>
                <h5>Open Existing Project</h5>
                <p>Validate and repair an existing project structure</p>
            </div>
        </div>
    </div>

    <!-- Create New Project Form -->
    <div class="form-section" id="section-create">
        <div class="card shadow-sm">
            <div class="card-header bg-success bg-opacity-10">
                <h5 class="mb-0"><i class="fas fa-plus-circle text-success me-2"></i>Create New Project</h5>
            </div>
            <div class="card-body">
                <form id="createProjectForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="projectName" class="form-label fw-bold">Project Name</label>
                            <input type="text" class="form-control" id="projectName" placeholder="my_study" required
                                   pattern="[a-zA-Z0-9_-]+" title="Only letters, numbers, underscores and hyphens allowed">
                            <small class="text-muted">No spaces allowed. A folder with this name will be created.</small>
                            <div class="invalid-feedback" id="projectNameError"></div>
                        </div>
                        <div class="col-md-6">
                            <label for="projectPath" class="form-label fw-bold">Project Location</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="projectPath" placeholder="" required>
                                <button class="btn btn-outline-secondary" type="button" id="browseProjectPath">
                                    <i class="fas fa-folder-open"></i> Browse
                                </button>
                            </div>
                            <small class="text-muted">Parent folder where the project will be created</small>
                        </div>
                        
                        <div class="col-12">
                            <div class="alert alert-info border-0 bg-info bg-opacity-10 mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>YODA Layout:</strong> This will create a project following 
                                <a href="https://handbook.datalad.org/en/latest/basics/101-127-yoda.html" target="_blank">YODA principles</a>.
                                Raw data goes into the project dataset root, code into <code>code/</code>, and results into <code>analysis/</code>.
                                <div class="mt-2 small text-muted">
                                    Includes <code>project.json</code>, <code>contributors.json</code>, <code>CITATION.cff</code>, and <code>derivatives/qc/</code> for scientific project governance.
                                </div>
                            </div>
                        </div>

                        <div class="col-12 mt-3">
                            <div class="alert alert-info border-0 bg-info bg-opacity-10 mb-0">
                                <i class="fas fa-lightbulb me-2"></i>
                                <strong>Recommended Before Creating:</strong> Fill in the fields below (marked <span class="badge bg-danger">REQUIRED</span> or <span class="badge bg-warning text-dark">RECOMMENDED</span>) to ensure your dataset is BIDS-compliant and well-documented. <strong>You can create without them</strong>, but your dataset will be incomplete.
                                <div class="row mt-2">
                                    <div class="col-md-6">
                                        <strong class="small">BIDS Basics:</strong>
                                        <ul class="mb-1 small">
                                            <li><span class="badge bg-danger">REQUIRED</span> Dataset Name</li>
                                            <li><span class="badge bg-secondary">OPTIONAL</span> Authors</li>
                                            <li><span class="badge bg-warning text-dark">RECOMMENDED</span> License</li>
                                        </ul>
                                        <strong class="small">Study Design:</strong>
                                        <ul class="mb-1 small">
                                            <li>Study Design Type</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <strong class="small">Methods Context:</strong>
                                        <ul class="mb-1 small">
                                            <li>Dataset Overview</li>
                                            <li>Recruitment Method & Locations</li>
                                            <li>Inclusion/Exclusion Criteria</li>
                                        </ul>
                                    </div>
                                </div>
                                <small class="text-muted mt-2 d-block"><i class="fas fa-info-circle me-1"></i>See badges in each field for details. Only <span class="badge bg-danger">REQUIRED</span> fields must be filled for BIDS compliance.</small>
                            </div>
                        </div>

                        <div class="col-12 mt-4">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-folder-plus me-2"></i>Create Project
                            </button>
                        </div>
                    </div>
                </form>

                <!-- Create Result -->
                <div id="createResult" class="mt-4" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Open Existing Project Form -->
    <div class="form-section" id="section-open">
        <div class="card shadow-sm">
            <div class="card-header bg-primary bg-opacity-10" data-bs-toggle="collapse" data-bs-target="#openProjectSection"
                 role="button" aria-expanded="true" aria-controls="openProjectSection">
                <h5 class="mb-0 d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-folder-open text-primary me-2"></i>Project</span>
                    <i class="fas fa-chevron-down text-muted" id="openProjectChevron"></i>
                </h5>
            </div>
            <div class="collapse show" id="openProjectSection">
            <div class="card-body">
                <form id="openProjectForm">
                    <div class="row g-3">
                        <div class="col-md-7">
                            <label for="existingPath" class="form-label fw-bold">Select project.json</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="existingPath"
                                       placeholder="/Users/YourName/MyProject/project.json" required>
                                <button class="btn btn-outline-secondary" type="button" id="browseExistingPath" title="Open file picker (or type path manually)">
                                    <i class="fas fa-file-code"></i> Browse
                                </button>
                            </div>
                            <small class="text-muted" id="pathHelp">Type the full path to your <code>project.json</code> file, or click Browse to select it.</small>
                        </div>
                        <div class="col-md-5">
                            <label class="form-label fw-bold d-none d-md-block">&nbsp;</label>
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-search me-2"></i>Load Project
                            </button>
                        </div>
                    </div>

                    <div class="mt-3" id="recentProjectsBlock" style="display: none;">
                        <label class="form-label fw-bold">Recent Projects</label>
                        <div id="recentProjectsList" class="d-flex flex-wrap gap-2"></div>
                    </div>
                </form>

                <!-- Validation Result -->
                <div id="validationResult" style="display: none;"></div>
            </div>
            </div>
        </div>
    </div>

    <!-- Study Metadata Card -->
    <div class="card shadow-sm mt-4" id="studyMetadataCard" style="display: none;">
        <div class="card-header bg-info bg-opacity-10" data-bs-toggle="collapse" data-bs-target="#studyMetadataSection"
             role="button" aria-expanded="false" aria-controls="studyMetadataSection">
            <h5 class="mb-0 d-flex justify-content-between align-items-center">
                <span><i class="fas fa-flask text-info me-2"></i>Study Metadata</span>
                <div class="d-flex align-items-center gap-2">
                    <div class="progress" style="width: 120px; height: 8px;" id="smHeaderProgress">
                        <div class="progress-bar" role="progressbar" id="smHeaderProgressBar" style="width: 0%"></div>
                    </div>
                    <span class="badge bg-secondary" id="smHeaderBadge">0%</span>
                    <i class="fas fa-chevron-down text-muted" id="studyMetadataChevron"></i>
                </div>
            </h5>
        </div>
        <div class="collapse" id="studyMetadataSection">
        <div class="card-body">
            <!-- Completeness Panel -->
            <div class="mb-3 p-3 bg-light rounded" id="smCompletenessPanel">
                <div class="d-flex align-items-center gap-3 mb-2">
                    <strong class="small text-uppercase text-muted">Methods Readiness</strong>
                    <div class="progress flex-grow-1" style="height: 12px;">
                        <div class="progress-bar" role="progressbar" id="smMainProgressBar" style="width: 0%"></div>
                    </div>
                    <span class="fw-bold" id="smMainScore">0%</span>
                </div>
                <div id="smSectionDots"></div>
            </div>

            <div class="alert alert-info border-0 bg-info bg-opacity-10 py-2 mb-3">
                <i class="fas fa-info-circle me-2"></i>
                This edits study methodology in <code>project.json</code> and dataset description in <code>dataset_description.json</code> at project root. 
                Saving this form auto-generates an ANC-compliant README from this metadata.
            </div>

            <form id="studyMetadataForm">
                <!-- Basics (BIDS) Section -->
                <div class="mb-3">
                    <button class="btn btn-sm btn-outline-secondary w-100 text-start" type="button"
                            data-bs-toggle="collapse" data-bs-target="#smBasics">
                        <i class="fas fa-tags me-1"></i> Basics (BIDS)
                        <span class="float-end" id="smBasicsBadge"></span>
                    </button>
                    <div class="collapse show" id="smBasics">
                        <div class="card card-body border-0 bg-light mt-1">
                            <!-- Metadata Validation Feedback -->
                            <div id="metadataValidationFeedback" class="mb-3" style="display: none;"></div>
                            <div class="alert alert-info border-0 bg-info bg-opacity-10">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>BIDS Compliance:</strong> This edits <code>dataset_description.json</code> (BIDS standard).
                                Syncs to <code>CITATION.cff</code>. Legend:
                                <span class="badge bg-danger">REQUIRED</span>
                                <span class="badge bg-warning text-dark">RECOMMENDED</span>
                                <span class="badge bg-secondary">OPTIONAL</span>
                            </div>
                            <div class="row g-3">
                                <div class="col-md-12">
                                    <label class="form-label fw-bold small text-muted text-uppercase mb-1">
                                        <span class="badge bg-danger">REQUIRED</span> Dataset Name
                                    </label>
                                    <input type="text" class="form-control form-control-sm" id="metadataName" required>
                                    <small class="text-muted">BIDS: Name field. Also used in CITATION.cff.</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small text-muted text-uppercase mb-1">
                                        <span class="badge bg-secondary">OPTIONAL</span> Authors
                                    </label>
                                    <div id="metadataAuthorsList" class="d-flex flex-column gap-2"></div>
                                    <button type="button" class="btn btn-outline-secondary btn-sm mt-2" id="addAuthorRow">
                                        <i class="fas fa-user-plus me-1"></i>Add Author
                                    </button>
                                    <small class="text-muted d-block">If CITATION.cff exists, omitted per BIDS spec (use CITATION.cff authors instead).</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small text-muted text-uppercase mb-1">
                                        <span class="badge bg-warning text-dark">RECOMMENDED</span> License
                                    </label>
                                    <select class="form-select form-select-sm" id="metadataLicense">
                                        <option value="">Select a license...</option>
                                        <option value="CC0">CC0 (Public Domain)</option>
                                        <option value="CC BY 4.0">CC BY 4.0</option>
                                        <option value="CC BY-SA 4.0">CC BY-SA 4.0</option>
                                        <option value="CC BY-NC 4.0">CC BY-NC 4.0</option>
                                        <option value="CC BY-NC-SA 4.0">CC BY-NC-SA 4.0</option>
                                        <option value="ODbL 1.0">Open Database License (ODbL)</option>
                                        <option value="PDDL 1.0">Public Domain Dedication and License (PDDL)</option>
                                        <option value="Other">Other/Proprietary</option>
                                    </select>
                                    <small class="text-muted">If CITATION.cff exists, omitted from dataset_description.json.</small>
                                </div>
                                <div class="col-md-12">
                                    <label class="form-label fw-bold small text-muted text-uppercase mb-1">
                                        <span class="badge bg-secondary">OPTIONAL</span> Acknowledgements
                                    </label>
                                    <textarea class="form-control form-control-sm" id="metadataAcknowledgements" rows="2" placeholder="Funding, grants, people to thank..."></textarea>
                                </div>
                                <div class="col-md-12">
                                    <div class="mt-3 pt-3 border-top">
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label class="form-label fw-bold small text-muted text-uppercase mb-1">
                                                    <span class="badge bg-secondary">OPTIONAL</span> Dataset DOI
                                                </label>
                                                <input type="text" class="form-control form-control-sm" id="metadataDOI" placeholder="Example: 10.5281/zenodo.1234567">
                                                <small class="text-muted">Example only (placeholder). Enter your DOI only if available; syncs to CITATION.cff.</small>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label fw-bold small text-muted text-uppercase mb-1">
                                                    <span class="badge bg-warning text-dark">RECOMMENDED</span> Dataset Type
                                                </label>
                                                <select class="form-select form-select-sm" id="metadataType">
                                                    <option value="raw" selected>raw</option>
                                                    <option value="derivative">derivative</option>
                                                    <option value="study">study</option>
                                                </select>
                                            </div>
                                            <div class="col-md-12">
                                                <label class="form-label fw-bold small text-muted text-uppercase mb-1">
                                                    <span class="badge bg-secondary">OPTIONAL</span> Ethics Approvals
                                                </label>
                                                <div class="mb-2">
                                                    <input type="hidden" id="metadataEthicsApproved" value="no">
                                                    <div class="btn-group btn-group-sm" role="group" aria-label="Ethics approvals">
                                                        <button type="button" class="btn btn-outline-primary" id="metadataEthicsYes" onclick="setEthicsChoice('yes')">Yes</button>
                                                        <button type="button" class="btn btn-primary" id="metadataEthicsNo" onclick="setEthicsChoice('no')">No</button>
                                                    </div>
                                                </div>
                                                <div id="ethicsDetailsSection" style="display: none; margin-top: 12px;">
                                                    <div class="row g-2">
                                                        <div class="col-md-6">
                                                            <input type="text" class="form-control form-control-sm" id="metadataEthicsCommittee" placeholder="Example: Ethics Committee Name" required>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <input type="text" class="form-control form-control-sm" id="metadataEthicsVotum" placeholder="Example: EK-2026-014" required>
                                                        </div>
                                                    </div>
                                                </div>
                                                <small class="text-muted">Example format: Committee name, Reference number. Placeholder text is not saved.</small>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label fw-bold small text-muted text-uppercase mb-1">
                                                    <span class="badge bg-warning text-dark">RECOMMENDED</span> HED Version
                                                </label>
                                                <input type="text" class="form-control form-control-sm" id="metadataHED" placeholder="Example: 8.2.0">
                                                <small class="text-muted">Example only (placeholder). Leave empty if HED is not used in your data.</small>
                                            </div>
                                            <div class="col-md-12">
                                                <label class="form-label fw-bold small text-muted text-uppercase mb-1">
                                                    <span class="badge bg-warning text-dark">RECOMMENDED</span> Keywords (comma-separated)
                                                </label>
                                                <input type="text" class="form-control form-control-sm" id="metadataKeywords" placeholder="psychology, experiment, PRISM">
                                                <small class="text-muted">PRISM recommends at least 3 keywords for FAIR compliance and discoverability.</small>
                                            </div>
                                            <div class="col-md-12">
                                                <label class="form-label fw-bold small text-muted text-uppercase mb-1">
                                                    <span class="badge bg-secondary">OPTIONAL</span> Funding
                                                </label>
                                                <input type="text" class="form-control form-control-sm" id="metadataFunding" placeholder="National Science Foundation (NSF) Grant #1234567, Other funding sources">
                                                <small class="text-muted">Grant agency and numbers separated by commas.</small>
                                            </div>
                                            <div class="col-md-12">
                                                <label class="form-label fw-bold small text-muted text-uppercase mb-1">
                                                    <span class="badge bg-secondary">OPTIONAL</span> How to Acknowledge
                                                </label>
                                                <textarea class="form-control form-control-sm" id="metadataHowToAcknowledge" rows="2" placeholder="Please cite the following paper..."></textarea>
                                                <small class="text-muted">Stored in CITATION.cff. Omitted from dataset_description.json if CITATION.cff exists (per BIDS spec).</small>
                                            </div>
                                            <div class="col-md-12">
                                                <label class="form-label fw-bold small text-muted text-uppercase mb-1">
                                                    <span class="badge bg-secondary">OPTIONAL</span> References &amp; Links
                                                </label>
                                                <textarea class="form-control form-control-sm" id="metadataReferences" rows="2" placeholder="https://doi.org/..., https://example.com/..."></textarea>
                                                <small class="text-muted">URLs or citations separated by commas. Stored in CITATION.cff. Omitted from dataset_description.json if CITATION.cff exists (per BIDS spec).</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Overview Section -->
                <div class="mb-3">
                    <button class="btn btn-sm btn-outline-secondary w-100 text-start" type="button"
                            data-bs-toggle="collapse" data-bs-target="#smOverview">
                        <i class="fas fa-file-alt me-1"></i> Overview
                        <span class="float-end" id="smOverviewBadge"></span>
                    </button>
                    <div class="collapse show" id="smOverview">
                        <div class="card card-body border-0 bg-light mt-1">
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label fw-bold small">
                                        <span class="badge bg-danger">REQUIRED</span> Dataset Overview
                                    </label>
                                    <textarea class="form-control form-control-sm" id="smOverviewMain" rows="4"
                                              placeholder="A brief paragraph describing the goals, purpose, and unique value of this dataset..."></textarea>
                                    <small class="text-muted">Include: Why was this dataset created? What makes it unique and valuable?</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">Independent Variables</label>
                                    <textarea class="form-control form-control-sm" id="smOverviewIV" rows="3"
                                              placeholder="One per line (e.g., pleasant vs. unpleasant images)"></textarea>
                                    <small class="text-muted">Condition variables that were manipulated</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">Dependent Variables</label>
                                    <textarea class="form-control form-control-sm" id="smOverviewDV" rows="3"
                                              placeholder="One per line (e.g., reaction times, BOLD signal)"></textarea>
                                    <small class="text-muted">Response variables that were measured</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">Control Variables</label>
                                    <textarea class="form-control form-control-sm" id="smOverviewCV" rows="3"
                                              placeholder="One per line (e.g., age, sex, reading performance)"></textarea>
                                    <small class="text-muted">Aspects that were explicitly controlled</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">Quality Assessment</label>
                                    <textarea class="form-control form-control-sm" id="smOverviewQA" rows="3"
                                              placeholder="Link to quality report or brief quality notes"></textarea>
                                    <small class="text-muted">Reference to quality control measures</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Study Design -->
                <div class="mb-3">
                    <button class="btn btn-sm btn-outline-secondary w-100 text-start" type="button"
                            data-bs-toggle="collapse" data-bs-target="#smStudyDesign">
                        <i class="fas fa-drafting-compass me-1"></i> Study Design
                        <span class="float-end" id="smStudyDesignBadge"></span>
                    </button>
                    <div class="collapse show" id="smStudyDesign">
                        <div class="card card-body border-0 bg-light mt-1">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label fw-bold small">
                                        <span class="badge bg-danger">REQUIRED</span> Study Design Type
                                    </label>
                                    <select class="form-select form-select-sm" id="smSDType" onchange="toggleExperimentalFields()">
                                        <option value="">-- Select --</option>
                                        <option value="cross-sectional">Cross-sectional</option>
                                        <option value="longitudinal">Longitudinal</option>
                                        <option value="randomized-controlled-trial">Randomized Controlled Trial</option>
                                        <option value="quasi-experimental">Quasi-experimental</option>
                                        <option value="case-control">Case-control</option>
                                        <option value="cohort">Cohort</option>
                                        <option value="single-case">Single-case</option>
                                        <option value="mixed-methods">Mixed methods</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold small">Condition Type</label>
                                    <select class="form-select form-select-sm" id="smSDConditionType">
                                        <option value="">-- N/A --</option>
                                        <option value="between-subjects">Between-subjects</option>
                                        <option value="within-subjects">Within-subjects</option>
                                        <option value="mixed">Mixed</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold small">Type Description</label>
                                    <input type="text" class="form-control form-control-sm" id="smSDTypeDesc"
                                           placeholder="e.g. 2x2 factorial design">
                                </div>
                                <div class="col-12" id="smExperimentalFields" style="display: none;">
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label class="form-label fw-bold small">Blinding</label>
                                            <select class="form-select form-select-sm" id="smSDBlinding">
                                                <option value="">-- None --</option>
                                                <option value="none">None</option>
                                                <option value="single-blind">Single-blind</option>
                                                <option value="double-blind">Double-blind</option>
                                                <option value="triple-blind">Triple-blind</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label fw-bold small">Randomization</label>
                                            <input type="text" class="form-control form-control-sm" id="smSDRandomization"
                                                   placeholder="Randomization procedure">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label fw-bold small">Control Condition</label>
                                            <input type="text" class="form-control form-control-sm" id="smSDControl"
                                                   placeholder="Control condition">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recruitment -->
                <div class="mb-3">
                    <button class="btn btn-sm btn-outline-secondary w-100 text-start" type="button"
                            data-bs-toggle="collapse" data-bs-target="#smRecruitment">
                        <i class="fas fa-users me-1"></i> Recruitment
                        <span class="float-end" id="smRecruitmentBadge"></span>
                    </button>
                    <div class="collapse" id="smRecruitment">
                        <div class="card card-body border-0 bg-light mt-1">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">
                                        <span class="badge bg-danger">REQUIRED</span> Method
                                    </label>
                                    <select class="form-select form-select-sm" id="smRecMethod" multiple>
                                        <option value="">-- Select --</option>
                                        <option value="online-ads">Online ads</option>
                                        <option value="email-lists">University mailing lists</option>
                                        <option value="participant-pool">Participant pool</option>
                                        <option value="clinical-referral">Clinical referral</option>
                                        <option value="community-outreach">Community outreach</option>
                                        <option value="school-recruitment">School recruitment</option>
                                        <option value="social-media">Social media</option>
                                        <option value="flyers-posters">Flyers/posters</option>
                                        <option value="snowball">Snowball sampling</option>
                                        <option value="other">Other</option>
                                    </select>
                                    <small class="text-muted">Hold Cmd/Ctrl to select multiple.</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">
                                        <span class="badge bg-danger">REQUIRED</span> Location
                                    </label>
                                    <div id="smRecLocationList" class="d-flex flex-column gap-2"></div>
                                    <button type="button" class="btn btn-outline-secondary btn-sm mt-2" id="addRecLocationRow">
                                        <i class="fas fa-plus me-1"></i>Add Location
                                    </button>
                                    <small class="text-muted d-block">Add one or more locations.</small>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold small">
                                        <span class="badge bg-danger">REQUIRED</span> Period Start
                                    </label>
                                    <div class="d-flex gap-2">
                                        <select class="form-select form-select-sm" id="smRecPeriodStartYear" required></select>
                                        <select class="form-select form-select-sm" id="smRecPeriodStartMonth" required></select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold small">
                                        <span class="badge bg-danger">REQUIRED</span> Period End
                                    </label>
                                    <div class="d-flex gap-2">
                                        <select class="form-select form-select-sm" id="smRecPeriodEndYear" required></select>
                                        <select class="form-select form-select-sm" id="smRecPeriodEndMonth" required></select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold small">
                                        <span class="badge bg-danger">REQUIRED</span> Financial Compensation
                                    </label>
                                    <select class="form-select form-select-sm" id="smRecCompensation" required>
                                        <option value="">-- Select --</option>
                                        <option value="Financial compensation">Yes</option>
                                        <option value="No financial compensation">No</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Eligibility -->
                <div class="mb-3">
                    <button class="btn btn-sm btn-outline-secondary w-100 text-start" type="button"
                            data-bs-toggle="collapse" data-bs-target="#smEligibility">
                        <i class="fas fa-user-check me-1"></i> Eligibility
                        <span class="float-end" id="smEligibilityBadge"></span>
                    </button>
                    <div class="collapse" id="smEligibility">
                        <div class="card card-body border-0 bg-light mt-1">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">
                                        <span class="badge bg-danger">REQUIRED</span> Inclusion Criteria
                                    </label>
                                    <textarea class="form-control form-control-sm" id="smEligInclusion" rows="3"
                                              placeholder="One criterion per line"></textarea>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small">
                                        <span class="badge bg-danger">REQUIRED</span> Exclusion Criteria
                                    </label>
                                    <textarea class="form-control form-control-sm" id="smEligExclusion" rows="3"
                                              placeholder="One criterion per line"></textarea>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold small">Target Sample Size</label>
                                    <input type="number" class="form-control form-control-sm" id="smEligSampleSize"
                                           min="1" placeholder="N">
                                </div>
                                <div class="col-md-8">
                                    <label class="form-label fw-bold small">Power Analysis</label>
                                    <input type="text" class="form-control form-control-sm" id="smEligPower"
                                           placeholder="e.g. G*Power, medium effect size d=0.5, alpha=.05, power=.80">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Procedure -->
                <div class="mb-3">
                    <button class="btn btn-sm btn-outline-secondary w-100 text-start" type="button"
                            data-bs-toggle="collapse" data-bs-target="#smProcedure">
                        <i class="fas fa-list-ol me-1"></i> Procedure
                        <span class="float-end" id="smProcedureBadge"></span>
                    </button>
                    <div class="collapse" id="smProcedure">
                        <div class="card card-body border-0 bg-light mt-1">
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label fw-bold small">
                                        <span class="badge bg-danger">REQUIRED</span> Overview
                                    </label>
                                    <textarea class="form-control form-control-sm" id="smProcOverview" rows="3"
                                              placeholder="Narrative overview of the study procedure..."></textarea>
                                </div>
                                <div class="col-12">
                                    <button class="btn btn-link btn-sm p-0 text-decoration-none" type="button"
                                            data-bs-toggle="collapse" data-bs-target="#smProcMore">
                                        <i class="fas fa-chevron-down me-1"></i>More Fields
                                    </button>
                                    <div class="collapse mt-2" id="smProcMore">
                                        <div class="row g-3">
                                            <div class="col-md-12">
                                                <label class="form-label fw-bold small">Informed Consent</label>
                                                <textarea class="form-control form-control-sm" id="smProcConsent" rows="2"
                                                          placeholder="How was informed consent obtained?"></textarea>
                                            </div>
                                            <div class="col-md-12">
                                                <label class="form-label fw-bold small">Quality Control</label>
                                                <textarea class="form-control form-control-sm" id="smProcQC" rows="2"
                                                          placeholder="One measure per line (e.g. Attention checks)"></textarea>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label fw-bold small">Missing Data Handling</label>
                                                <input type="text" class="form-control form-control-sm" id="smProcMissing"
                                                       placeholder="How was missing data handled?">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label fw-bold small">Debriefing</label>
                                                <textarea class="form-control form-control-sm" id="smProcDebriefing" rows="2"
                                                          placeholder="Debriefing procedure"></textarea>
                                            </div>
                                            <div class="col-12">
                                                <label class="form-label fw-bold small">Additional Data Acquired</label>
                                                <textarea class="form-control form-control-sm" id="smProcAdditionalData" rows="2"
                                                          placeholder="Other data collected (questionnaires, swabs, clinical info, etc.)"></textarea>
                                                <small class="text-muted">Especially relevant if not included in dataset</small>
                                            </div>
                                            <div class="col-12">
                                                <label class="form-label fw-bold small">Notes</label>
                                                <textarea class="form-control form-control-sm" id="smProcNotes" rows="2"
                                                          placeholder="Additional information about the procedure..."></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Missing Data & Issues -->
                <div class="mb-3">
                    <button class="btn btn-sm btn-outline-secondary w-100 text-start" type="button"
                            data-bs-toggle="collapse" data-bs-target="#smMissingData">
                        <i class="fas fa-exclamation-triangle me-1"></i> Missing Data & Known Issues
                        <span class="float-end" id="smMissingDataBadge"></span>
                    </button>
                    <div class="collapse" id="smMissingData">
                        <div class="card card-body border-0 bg-light mt-1">
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="alert alert-info py-2 mb-0">
                                        <i class="fas fa-info-circle me-2"></i>
                                        Fill this section after data acquisition. Leave empty when starting a study.
                                    </div>
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-bold small">Missing Data Description</label>
                                    <textarea class="form-control form-control-sm" id="smMissingDesc" rows="3"
                                              placeholder="General description of missing or problematic data..."></textarea>
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-bold small">Missing Files (Table)</label>
                                    <textarea class="form-control form-control-sm" id="smMissingFiles" rows="3"
                                              placeholder="Format: sub-001 | T1w, task-rest&#10;sub-002 | ses-2 functional scans"></textarea>
                                    <small class="text-muted">One entry per line: SubjectID | What's missing</small>
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-bold small">Known Issues (Table)</label>
                                    <textarea class="form-control form-control-sm" id="smKnownIssues" rows="3"
                                              placeholder="Format: sub-001_task-nback_bold.nii | Shorter scan&#10;sub-002_T1w.nii | Resolution differs"></textarea>
                                    <small class="text-muted">One entry per line: Filename | Issue description</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- References -->
                <div class="mb-3">
                    <button class="btn btn-sm btn-outline-secondary w-100 text-start" type="button"
                            data-bs-toggle="collapse" data-bs-target="#smReferences">
                        <i class="fas fa-book me-1"></i> References
                        <span class="float-end" id="smReferencesBadge"></span>
                    </button>
                    <div class="collapse" id="smReferences">
                        <div class="card card-body border-0 bg-light mt-1">
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label fw-bold small">References</label>
                                    <textarea class="form-control form-control-sm" id="smReferences" rows="4"
                                              placeholder="One reference per line or formatted citations..."></textarea>
                                    <small class="text-muted">References used within the README</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-end">
                    <button type="submit" class="btn btn-info">
                        <i class="fas fa-save me-1"></i>Save Study Metadata
                    </button>
                    <small class="text-muted d-block mt-2">
                        <i class="fas fa-info-circle me-1"></i>Saving will auto-generate README.md
                    </small>
                </div>
            </form>
        </div>
        </div>
    </div>

    <!-- Generate Methods Section Card -->
    <div class="card shadow-sm mt-4" id="methodsSectionCard" style="display: none;">
        <div class="card-header bg-success bg-opacity-10" data-bs-toggle="collapse" data-bs-target="#methodsSectionBody"
             role="button" aria-expanded="false" aria-controls="methodsSectionBody">
            <h5 class="mb-0 d-flex justify-content-between align-items-center">
                <span><i class="fas fa-file-alt text-success me-2"></i>Generate Methods Section</span>
                <i class="fas fa-chevron-down text-muted" id="methodsSectionChevron"></i>
            </h5>
        </div>
        <div class="collapse" id="methodsSectionBody">
            <div class="card-body">
                <p class="text-muted mb-3">
                    Create a publication-ready methods section from your project metadata.
                    Uses data from <code>project.json</code>, <code>dataset_description.json</code>, and linked templates.
                </p>
                <div class="row align-items-end mb-3 g-2">
                    <div class="col-auto">
                        <label for="methodsLanguage" class="form-label fw-bold mb-1">Language</label>
                        <select class="form-select form-select-sm" id="methodsLanguage" style="width: 140px;">
                            <option value="en" selected>English</option>
                            <option value="de">German</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <label for="methodsDetailLevel" class="form-label fw-bold mb-1">Detail Level</label>
                        <select class="form-select form-select-sm" id="methodsDetailLevel" style="width: 150px;">
                            <option value="brief">Brief</option>
                            <option value="standard" selected>Standard</option>
                            <option value="detailed">Detailed</option>
                        </select>
                    </div>
                    <div class="col-auto d-flex align-items-end">
                        <div class="form-check mb-1">
                            <input class="form-check-input" type="checkbox" id="methodsContinuous">
                            <label class="form-check-label" for="methodsContinuous">Continuous text</label>
                        </div>
                    </div>
                    <div class="col-auto">
                        <button type="button" class="btn btn-success" id="generateMethodsBtn" onclick="generateMethodsSection()">
                            <i class="fas fa-magic me-1"></i>Generate
                        </button>
                    </div>
                </div>

                <div id="methodsResult" style="display: none;">
                    <div id="methodsSectionsBadges" class="mb-2"></div>
                    <div id="methodsPreview" class="border rounded p-3 bg-white mb-3" style="max-height: 500px; overflow-y: auto;"></div>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="downloadMethods('md')">
                            <i class="fas fa-download me-1"></i>Download .md
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="downloadMethods('html')">
                            <i class="fas fa-download me-1"></i>Download .html
                        </button>
                    </div>
                </div>

                <div id="methodsError" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Data Export/Share Card -->
    <div class="card shadow-sm mt-4" id="exportProjectCard" style="display: none;">
        <div class="card-header bg-warning bg-opacity-10" data-bs-toggle="collapse" data-bs-target="#exportSection"
             role="button" aria-expanded="false" aria-controls="exportSection">
            <h5 class="mb-0 d-flex justify-content-between align-items-center">
                <span><i class="fas fa-share-alt text-warning me-2"></i>Data Export / Share</span>
                <i class="fas fa-chevron-down text-muted" id="exportChevron"></i>
            </h5>
        </div>
        <div class="collapse" id="exportSection">
            <div class="card-body">
                <div class="alert alert-warning border-warning mb-4">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Important:</strong> Before sharing data publicly, consider copyright (survey questions) and anonymity (participant IDs).
                    This tool helps you create a shareable, anonymized version of your dataset.
                </div>

                <form id="exportProjectForm">
                    <div class="row g-3">
                        <!-- Anonymization Options -->
                        <div class="col-12">
                            <h6 class="mb-3"><i class="fas fa-user-secret me-2"></i>Anonymization</h6>
                        </div>

                        <div class="col-md-6">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="exportAnonymize" checked>
                                <label class="form-check-label fw-bold" for="exportAnonymize">
                                    Randomize Participant IDs
                                </label>
                            </div>
                            <div class="form-text ms-4">
                                Transform subject codes (e.g., sub-001  sub-R7X2K9) throughout the entire dataset.
                                A secure mapping file will be included in the export for re-identification if needed.
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label for="exportIdLength" class="form-label">Random ID Length</label>
                            <select class="form-select form-select-sm" id="exportIdLength">
                                <option value="6">6 characters (64K combinations)</option>
                                <option value="8" selected>8 characters (2.8M combinations)</option>
                                <option value="10">10 characters (100M combinations)</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="exportMaskQuestions">
                                <label class="form-check-label fw-bold" for="exportMaskQuestions">
                                    Mask Copyrighted Question Text
                                </label>
                            </div>
                            <div class="form-text ms-4">
                                Strip original question descriptions from JSON sidecars (survey/biometrics).
                                Replaces with generic labels like "Question 1", "Question 2", etc.
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="exportDeterministic" checked>
                                <label class="form-check-label" for="exportDeterministic">
                                    Deterministic Mapping
                                </label>
                            </div>
                            <div class="form-text ms-4">
                                Same input always generates same random IDs (useful for reproducibility).
                            </div>
                        </div>

                        <!-- Content Options -->
                        <div class="col-12 mt-4">
                            <hr>
                            <h6 class="mb-3"><i class="fas fa-archive me-2"></i>Export Content</h6>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold">Include in Export:</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="exportRawdata" checked disabled>
                                <label class="form-check-label" for="exportRawdata">
                                    Dataset root files and <code>sub-*/</code> folders - Raw experimental data
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="exportDerivatives" checked>
                                <label class="form-check-label" for="exportDerivatives">
                                    <code>derivatives/</code> - Processed data
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="exportCode" checked>
                                <label class="form-check-label" for="exportCode">
                                    <code>code/</code> - Analysis scripts and recipes
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="exportAnalysis">
                                <label class="form-check-label" for="exportAnalysis">
                                    <code>analysis/</code> - Results and reports
                                </label>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold">Metadata:</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="exportMetadata" checked disabled>
                                <label class="form-check-label" for="exportMetadata">
                                    Project metadata files (dataset_description.json, README, etc.)
                                </label>
                            </div>
                            <div class="form-text small text-muted ms-4">
                                Mapping file will always be included if anonymization is enabled.
                            </div>
                        </div>

                        <!-- AND Export Section -->
                        <div class="col-12 mt-4">
                            <hr>
                            <h6 class="mb-3">
                                <i class="fas fa-cloud-upload-alt me-2"></i>AND (Austrian NeuroCloud) Export
                                <span class="badge bg-info ms-2">New</span>
                            </h6>
                        </div>

                        <div class="col-12">
                            <div class="alert alert-info border-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>AND Export:</strong> Converts your PRISM dataset to AND-compatible format with required files 
                                (README, CITATION.cff, .bids-validator-config.json) for submission to Austrian NeuroCloud.
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="ancEnableExport">
                                <label class="form-check-label fw-bold" for="ancEnableExport">
                                    Enable AND Export
                                </label>
                            </div>
                            <div class="form-text ms-4">
                                Prepare dataset for AND submission with all required metadata files.
                            </div>
                        </div>

                        <div class="col-md-6" id="ancOptionsGroup" style="display: none;">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="ancConvertGitLfs">
                                <label class="form-check-label" for="ancConvertGitLfs">
                                    Convert to Git LFS
                                </label>
                            </div>
                            <div class="form-text ms-4">
                                Create .gitattributes for Git LFS (if required by AND). Default: DataLad-compatible.
                            </div>
                        </div>

                        <div class="col-md-6" id="ancOptionsGroup2" style="display: none;">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="ancIncludeCiExamples">
                                <label class="form-check-label" for="ancIncludeCiExamples">
                                    Include CI/CD Examples
                                </label>
                            </div>
                            <div class="form-text ms-4">
                                Add example GitLab CI and GitHub Actions workflows for dataset validation.
                            </div>
                        </div>

                        <div class="col-12" id="ancMetadataSection" style="display: none;">
                            <button type="button" class="btn btn-sm btn-outline-info mb-3" data-bs-toggle="collapse" 
                                    data-bs-target="#ancMetadataForm" aria-expanded="false">
                                <i class="fas fa-edit me-1"></i>Edit AND Metadata (Optional)
                            </button>
                            <div class="collapse" id="ancMetadataForm">
                                <div class="card border-info">
                                    <div class="card-body">
                                        <div class="row g-2">
                                            <div class="col-md-6">
                                                <label class="form-label small fw-bold">Dataset Title</label>
                                                <input type="text" class="form-control form-control-sm" id="ancDatasetTitle" 
                                                       placeholder="Filled from dataset_description.json">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small fw-bold">Contact Email</label>
                                                <input type="email" class="form-control form-control-sm" id="ancContactEmail" 
                                                       placeholder="contact@university.edu">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small fw-bold">Author First Name</label>
                                                <input type="text" class="form-control form-control-sm" id="ancAuthorGiven" 
                                                       placeholder="John">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small fw-bold">Author Last Name</label>
                                                <input type="text" class="form-control form-control-sm" id="ancAuthorFamily" 
                                                       placeholder="Doe">
                                            </div>
                                            <div class="col-12">
                                                <label class="form-label small fw-bold">Dataset Description</label>
                                                <textarea class="form-control form-control-sm" id="ancDatasetDescription" 
                                                          rows="2" placeholder="Brief description of your dataset..."></textarea>
                                            </div>
                                            <div class="col-12">
                                                <div class="form-text small">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    Leave fields empty to use values from dataset_description.json. 
                                                    Full metadata can be edited after export.
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Export Buttons -->
                        <div class="col-12 mt-4">
                            <button type="submit" class="btn btn-warning btn-lg me-2">
                                <i class="fas fa-download me-2"></i>Standard Export & Download
                            </button>
                            <button type="button" class="btn btn-info btn-lg" id="ancExportButton" style="display: none;">
                                <i class="fas fa-cloud-upload-alt me-2"></i>Export for AND
                            </button>
                            <div class="form-text mt-2">
                                <i class="fas fa-info-circle me-1"></i>
                                Standard export creates a shareable ZIP. AND export creates a submission-ready dataset folder.
                            </div>
                        </div>
                    </div>
                </form>

                <!-- Export Progress -->
                <div id="exportProgress" class="mt-4" style="display: none;">
                    <div class="alert alert-info">
                        <i class="fas fa-spinner fa-spin me-2"></i>
                        <span id="exportStatusText">Preparing export...</span>
                    </div>
                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" id="exportProgressBar" style="width: 0%">
                            <span id="exportProgressText">0%</span>
                        </div>
                    </div>
                </div>

                <!-- Export Result -->
                <div id="exportResult" class="mt-4" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Global Settings Card (Last Section) -->
    <div class="card shadow-sm mt-4">
        <div class="card-header bg-secondary bg-opacity-10" data-bs-toggle="collapse" data-bs-target="#settingsSection"
             role="button" aria-expanded="false" aria-controls="settingsSection">
            <h5 class="mb-0 d-flex justify-content-between align-items-center">
                <span><i class="fas fa-cog text-secondary me-2"></i>Global Settings</span>
                <i class="fas fa-chevron-down text-muted" id="settingsChevron"></i>
            </h5>
        </div>
        <div class="collapse" id="settingsSection">
            <div class="card-body">
                <form id="globalSettingsForm">
                    <div class="row g-3">
                        <div class="col-12">
                            <label for="globalLibraryPath" class="form-label fw-bold">
                                <i class="fas fa-database me-1"></i>Global Survey Template Library
                            </label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="globalLibraryPath"
                                       placeholder="Path to folder containing survey/ subfolder">
                                <button class="btn btn-outline-secondary" type="button" id="browseGlobalLibrary">
                                    <i class="fas fa-folder-open"></i> Browse
                                </button>
                            </div>
                            <small class="text-muted">
                                Root folder for survey templates. Must contain a <code>survey/</code> subfolder with JSON templates.
                                <br>Default: App's built-in <code>survey_library/</code> folder. Can be changed to a shared location (Nextcloud, GitLab, etc.).
                                <br>Projects can override this with <code>templateLibraryPath</code> in <code>.prismrc.json</code>.
                            </small>
                        </div>
                        <div class="col-12">
                            <label for="globalRecipesPath" class="form-label fw-bold">
                                <i class="fas fa-utensils me-1"></i>Global Recipe Library
                            </label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="globalRecipesPath"
                                       placeholder="Path to folder containing recipe/ subfolder">
                                <button class="btn btn-outline-secondary" type="button" id="browseGlobalRecipes">
                                    <i class="fas fa-folder-open"></i> Browse
                                </button>
                            </div>
                            <small class="text-muted">
                                Root folder for survey recipes. Must contain a <code>recipe/</code> subfolder with recipe JSON files.
                                <br>Default: <code>official/recipe/</code> folder. Can be changed to a shared location.
                                <br>Recipes are automatically used in the "Dataset Recipes & Scoring" tool.
                            </small>
                        </div>
                        <div class="col-12">
                            <div id="libraryStatusMessage"></div>
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-secondary">
                                <i class="fas fa-save me-2"></i>Save Settings
                            </button>
                            <button type="button" class="btn btn-outline-info ms-2" onclick="useDefaultLibrary()">
                                <i class="fas fa-undo me-1"></i>Use Default
                            </button>
                            <button type="button" class="btn btn-outline-danger ms-2" onclick="clearGlobalLibrary()">
                                <i class="fas fa-times me-1"></i>Clear
                            </button>
                        </div>
                    </div>
                </form>

                <!-- Library Info Panel -->
                <div id="libraryInfoPanel" class="mt-4 p-3 bg-light rounded" style="display: none;">
                    <h6 class="mb-3"><i class="fas fa-info-circle me-2"></i>Survey Template Locations</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-2">
                                <div class="card-body py-2">
                                    <small class="text-muted">Global Survey Templates (Read-only)</small>
                                    <div id="globalLibraryInfo" class="text-truncate">
                                        <span class="text-muted">Not configured</span>
                                    </div>
                                    <small class="text-muted">Path: <code>*/survey/*.json</code></small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-2">
                                <div class="card-body py-2">
                                    <small class="text-muted">Project Survey Templates (Editable)</small>
                                    <div id="projectLibraryInfo" class="text-truncate">
                                        <span class="text-muted">Select a project</span>
                                    </div>
                                    <small class="text-muted">Path: <code>project/library/survey/*.json</code> (Root level)</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <small class="text-muted">
                        <i class="fas fa-lightbulb me-1"></i>
                        Survey templates from both locations are merged. Project templates take priority over global templates with the same name.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/neurobagel.js') }}"></script>
<script>
    let currentProjectPath = "{{ current_project.path or '' }}";
    let currentProjectName = "{{ current_project.name or '' }}";
    const recentProjectsKey = 'prism_recent_projects';

    // Also expose globally for navbar and other pages to access
    window.currentProjectPath = currentProjectPath;
    window.currentProjectName = currentProjectName;

    function getRecentProjects() {
        try {
            const raw = localStorage.getItem(recentProjectsKey);
            if (!raw) return [];
            const parsed = JSON.parse(raw);
            return Array.isArray(parsed) ? parsed : [];
        } catch (err) {
            console.warn('Could not read recent projects', err);
            return [];
        }
    }

    function saveRecentProjects(list) {
        try {
            localStorage.setItem(recentProjectsKey, JSON.stringify(list.slice(0, 6)));
        } catch (err) {
            console.warn('Could not save recent projects', err);
        }
    }

    function addRecentProject(name, path) {
        if (!path) return;
        const safeName = name && name.trim() ? name.trim() : path.split(/[/\\]/).pop();
        const list = getRecentProjects().filter(p => p.path !== path);
        list.unshift({ name: safeName, path: path });
        saveRecentProjects(list);
        renderRecentProjects();
    }

    function renderRecentProjects() {
        const block = document.getElementById('recentProjectsBlock');
        const listEl = document.getElementById('recentProjectsList');
        if (!block || !listEl) return;

        const list = getRecentProjects();
        if (!list.length) {
            block.style.display = 'none';
            listEl.innerHTML = '';
            return;
        }

        block.style.display = 'block';
        listEl.innerHTML = list.map(p => {
            const label = p.name || p.path;
            return `
                <button type="button" class="btn btn-outline-secondary btn-sm recent-project-btn" data-path="${p.path}" data-name="${label}">
                    <i class="fas fa-clock me-1"></i>${label}
                </button>`;
        }).join('');
    }

    // Load global settings on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Set OS-specific path format and help text
        const isWindows = navigator.platform.toUpperCase().indexOf('WIN') > -1;
        const isMac = navigator.platform.toUpperCase().indexOf('MAC') > -1;
        const existingPathInput = document.getElementById('existingPath');
        const projectPathInput = document.getElementById('projectPath');
        const pathHelpText = document.getElementById('pathHelp');
        
        if (existingPathInput) {
            if (isWindows) {
                existingPathInput.placeholder = "C:\\Users\\YourName\\MyProject\\project.json";
            } else if (isMac) {
                existingPathInput.placeholder = "/Users/YourName/MyProject/project.json";
            } else {
                // Linux
                existingPathInput.placeholder = "/home/username/MyProject/project.json";
            }
        }
        
        // Set OS-specific placeholder for new project location
        if (projectPathInput) {
            if (isWindows) {
                projectPathInput.placeholder = "C:\\Users\\YourName\\Documents";
            } else if (isMac) {
                projectPathInput.placeholder = "/Users/YourName/Documents";
            } else {
                // Linux
                projectPathInput.placeholder = "/home/username/Documents";
            }
        }
        
        if (pathHelpText) {
            let osExample = isWindows ? "C:\\\\Users\\\\YourName\\\\Documents\\\\MyProject\\\\project.json" :
                           isMac ? "/Users/YourName/Documents/MyProject/project.json" :
                           "/home/username/Documents/MyProject/project.json";
            pathHelpText.innerHTML = `Type the full path to your <code>project.json</code> file (e.g., <code>${osExample}</code>), or click Browse to select it. <strong>Only project.json files are supported.</strong>`;
        }
        
        loadGlobalSettings();
        loadLibraryInfo();
        showStudyMetadataCard();
        showExportCard();
        showMethodsCard();
        renderRecentProjects();

        // Seed recent list with current project if available
        if (currentProjectPath) {
            addRecentProject(currentProjectName, currentProjectPath);
        }

        // Update chevron icons on collapse toggle
        const sections = [
            { element: 'openProjectSection', chevron: 'openProjectChevron' },
            { element: 'studyMetadataSection', chevron: 'studyMetadataChevron' },
            { element: 'methodsSectionBody', chevron: 'methodsSectionChevron' },
            { element: 'participantsSection', chevron: 'participantsChevron' },
            { element: 'settingsSection', chevron: 'settingsChevron' }
        ];
        
        sections.forEach(section => {
            const el = document.getElementById(section.element);
            const chevron = document.getElementById(section.chevron);
            if (el && chevron) {
                el.addEventListener('shown.bs.collapse', function() {
                    chevron.classList.replace('fa-chevron-down', 'fa-chevron-up');
                });
                el.addEventListener('hidden.bs.collapse', function() {
                    chevron.classList.replace('fa-chevron-up', 'fa-chevron-down');
                });
            }
        });

        const recentList = document.getElementById('recentProjectsList');
        if (recentList) {
            recentList.addEventListener('click', (event) => {
                const btn = event.target.closest('.recent-project-btn');
                if (!btn) return;
                const path = btn.getAttribute('data-path');
                if (path) {
                    document.getElementById('existingPath').value = path;
                    selectProjectType('open');
                    // Automatically trigger the load
                    document.getElementById('openProjectForm').dispatchEvent(new Event('submit'));
                }
            });
        }
    });

    // Load global library settings
    async function loadGlobalSettings() {
        try {
            const response = await fetch('/api/settings/global-library');
            const data = await response.json();
            if (data.success) {
                const libraryInput = document.getElementById('globalLibraryPath');
                libraryInput.value = data.global_template_library_path || '';
                // Show default path as placeholder
                if (data.default_library_path) {
                    libraryInput.placeholder = `Default: ${data.default_library_path}`;
                }
                
                const recipesInput = document.getElementById('globalRecipesPath');
                recipesInput.value = data.global_recipes_path || '';
                
                updateLibraryInfoPanel(data.global_template_library_path || data.default_library_path, null);
            }
        } catch (error) {
            console.error('Error loading settings:', error);
        }
    }

    // ===== HELPER FUNCTIONS =====
    
    /**
     * Manage button loading state
     * @param {HTMLElement} btn - Button element
     * @param {boolean} isLoading - True to show loading, false to restore
     * @param {string} loadingText - Text to show when loading
     * @param {string} originalText - Text to restore (pass when isLoading=false)
     * @returns {string} Current innerHTML (for saving before setting loading)
     */
    function setButtonLoading(btn, isLoading, loadingText = 'Loading...', originalText = null) {
        if (isLoading) {
            const current = btn.innerHTML;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>${loadingText}`;
            btn.disabled = true;
            return current;
        } else {
            btn.innerHTML = originalText || btn.innerHTML.replace(/<i[^>]*spinner[^>]*>.*?<\/i>\s*/, '');
            btn.disabled = false;
            return null;
        }
    }

    /**
     * Show an alert message in a container
     * @param {string} containerId - ID of container element
     * @param {string} type - Alert type: 'success', 'danger', 'warning', 'info'
     * @param {string} title - Alert title (can include HTML)
     * @param {string} message - Alert message (can include HTML)
     */
    function showAlert(containerId, type, title, message) {
        const container = document.getElementById(containerId);
        if (!container) return;
        
        const iconMap = {
            'success': 'check-circle',
            'danger': 'exclamation-circle',
            'warning': 'exclamation-triangle',
            'info': 'info-circle'
        };
        
        const icon = iconMap[type] || 'info-circle';
        const titleHtml = title ? `<h5><i class="fas fa-${icon} me-2"></i>${title}</h5>` : '';
        
        container.innerHTML = `
            <div class="alert alert-${type}">
                ${titleHtml}
                ${message ? `<p class="mb-0">${message}</p>` : ''}
            </div>
        `;
        container.style.display = 'block';
    }

    // Load library info (both global and project)
    async function loadLibraryInfo() {
        try {
            const response = await fetch('/api/projects/library-path');
            const data = await response.json();

            const infoPanel = document.getElementById('libraryInfoPanel');
            infoPanel.style.display = 'block';

            // Update global library info
            const globalInfo = document.getElementById('globalLibraryInfo');
            if (data.global_library_path) {
                globalInfo.innerHTML = `<code class="small">${data.global_library_path}</code>`;
            } else {
                globalInfo.innerHTML = '<span class="text-muted">Not configured</span>';
            }

            // Update project library info
            const projectInfo = document.getElementById('projectLibraryInfo');
            if (data.success && data.project_library_path) {
                projectInfo.innerHTML = `<code class="small">${data.project_library_path}</code>`;
            } else if (data.project_path) {
                projectInfo.innerHTML = `<span class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i>No library folder</span>`;
            } else {
                projectInfo.innerHTML = '<span class="text-muted">Select a project</span>';
            }
        } catch (error) {
            console.error('Error loading library info:', error);
        }
    }

    // Update library info panel
    function updateLibraryInfoPanel(globalPath, projectPath) {
        const infoPanel = document.getElementById('libraryInfoPanel');
        infoPanel.style.display = 'block';

        const globalInfo = document.getElementById('globalLibraryInfo');
        if (globalPath) {
            globalInfo.innerHTML = `<code class="small">${globalPath}</code>`;
        } else {
            globalInfo.innerHTML = '<span class="text-muted">Not configured</span>';
        }
    }

    // Browse button for global library
    document.getElementById('browseGlobalLibrary').addEventListener('click', async function() {
        try {
            const response = await fetch('/api/browse-folder');
            const data = await response.json();
            if (data.path) {
                document.getElementById('globalLibraryPath').value = data.path;
            } else if (data.error) {
                alert('Folder picker unavailable: ' + data.error);
            }
        } catch (error) {
            console.error('Browse error:', error);
            alert('Failed to open folder picker. Please enter path manually.');
        }
    });

    // Browse button for global recipes
    document.getElementById('browseGlobalRecipes').addEventListener('click', async function() {
        try {
            const response = await fetch('/api/browse-folder');
            const data = await response.json();
            if (data.path) {
                document.getElementById('globalRecipesPath').value = data.path;
            } else if (data.error) {
                alert('Folder picker unavailable: ' + data.error);
            }
        } catch (error) {
            console.error('Browse error:', error);
            alert('Failed to open folder picker. Please enter path manually.');
        }
    });

    // Save global settings
    document.getElementById('globalSettingsForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const btn = this.querySelector('button[type="submit"]');
        const originalText = setButtonLoading(btn, true, 'Saving...');

        const libraryPath = document.getElementById('globalLibraryPath').value.trim();
        const recipesPath = document.getElementById('globalRecipesPath').value.trim();

        try {
            const response = await fetch('/api/settings/global-library', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    global_template_library_path: libraryPath,
                    global_recipes_path: recipesPath
                })
            });
            const result = await response.json();

            const statusDiv = document.getElementById('libraryStatusMessage');
            if (result.success) {
                statusDiv.innerHTML = `
                    <div class="alert alert-success py-2">
                        <i class="fas fa-check-circle me-2"></i>Settings saved successfully!
                    </div>
                `;
                updateLibraryInfoPanel(result.global_template_library_path, null);
            } else {
                statusDiv.innerHTML = `
                    <div class="alert alert-danger py-2">
                        <i class="fas fa-exclamation-circle me-2"></i>${result.error}
                    </div>
                `;
            }

            // Broadcast event so other pages can refresh
            if (result.success) {
                window.dispatchEvent(new CustomEvent('prism-library-settings-changed', {
                    detail: { global_library_path: document.getElementById('globalLibraryPath').value }
                }));
            }

            // Auto-hide success message after 3 seconds
            setTimeout(() => {
                if (result.success) {
                    statusDiv.innerHTML = '';
                }
            }, 3000);

        } catch (error) {
            document.getElementById('libraryStatusMessage').innerHTML = `
                <div class="alert alert-danger py-2">
                    <i class="fas fa-exclamation-circle me-2"></i>${error.message}
                </div>
            `;
        } finally {
            setButtonLoading(btn, false, null, originalText);
        }
    });

    // Use default library path (app's survey_library folder)
    async function useDefaultLibrary() {
        document.getElementById('globalRecipesPath').value = '';
        try {
            const response = await fetch('/api/settings/global-library');
            const data = await response.json();
            if (data.default_library_path) {
                document.getElementById('globalLibraryPath').value = data.default_library_path;
                document.getElementById('libraryStatusMessage').innerHTML = `
                    <div class="alert alert-info py-2">
                        <i class="fas fa-info-circle me-2"></i>Default path set. Click "Save Settings" to apply.
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error getting default path:', error);
        }
    }

    // Clear global library setting
    async function clearGlobalLibrary() {
        if (!confirm('Clear the global template and recipe library paths?')) {
            return;
        }
        document.getElementById('globalRecipesPath').value = '';

        try {
            const response = await fetch('/api/settings/global-library', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ global_template_library_path: '' })
            });
            const result = await response.json();

            if (result.success) {
                document.getElementById('globalLibraryPath').value = '';
                document.getElementById('libraryStatusMessage').innerHTML = `
                    <div class="alert alert-info py-2">
                        <i class="fas fa-info-circle me-2"></i>Global library path cleared.
                    </div>
                `;
                updateLibraryInfoPanel(null, null);

                // Broadcast event so other pages can refresh
                window.dispatchEvent(new CustomEvent('prism-library-settings-changed', {
                    detail: { global_library_path: null }
                }));

                setTimeout(() => {
                    document.getElementById('libraryStatusMessage').innerHTML = '';
                }, 3000);
            }
        } catch (error) {
            console.error('Error clearing library:', error);
        }
    }

    // Project type selection
    function selectProjectType(type) {
        // Update card styles
        document.querySelectorAll('.project-card').forEach(card => {
            card.classList.remove('active');
        });
        document.getElementById('card-' + type).classList.add('active');

        // Show corresponding form
        document.querySelectorAll('.form-section').forEach(section => {
            section.classList.remove('active');
        });
        document.getElementById('section-' + type).classList.add('active');

        // Starting a new project should always begin with a clean draft UI
        if (type === 'create') {
            const createResult = document.getElementById('createResult');
            if (createResult) {
                createResult.style.display = 'none';
                createResult.innerHTML = '';
            }
            const projectNameInput = document.getElementById('projectName');
            if (projectNameInput) {
                projectNameInput.value = '';
                projectNameInput.classList.remove('is-invalid');
            }
            const projectNameError = document.getElementById('projectNameError');
            if (projectNameError) projectNameError.textContent = '';
            resetStudyMetadataForm();
        }

        // Keep Study Metadata visible for create flow
        showStudyMetadataCard();
    }

    // Browse button for project location
    document.getElementById('browseProjectPath').addEventListener('click', async function() {
        try {
            const response = await fetch('/api/browse-folder');
            const data = await response.json();
            if (data.path) {
                document.getElementById('projectPath').value = data.path;
            } else if (data.error) {
                alert('Folder picker unavailable: ' + data.error);
            }
        } catch (error) {
            console.error('Browse error:', error);
            alert('Failed to open folder picker. Please enter path manually.');
        }
    });

    // Browse button for existing project
    document.getElementById('browseExistingPath').addEventListener('click', async function() {
        try {
            const response = await fetch('/api/browse-file');
            
            // Check if response is HTML instead of JSON (indicates error page)
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const isWindows = navigator.platform.toUpperCase().indexOf('WIN') > -1;
                let example = isWindows ? "C:\\Users\\YourName\\MyProject\\project.json" : "/Users/YourName/MyProject/project.json";
                alert('File picker is not available.\\n\\nPlease manually type the full path to your project.json file in the field above.\\n\\nExample: ' + example);
                return;
            }

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                alert('File picker error: ' + (errorData.error || 'Please enter the path manually.'));
                return;
            }

            const data = await response.json();
            if (data.path) {
                document.getElementById('existingPath').value = data.path;
            } else if (data.error) {
                alert('File picker unavailable: ' + data.error + '\\n\\nPlease select only project.json files.');
            }
        } catch (error) {
            console.error('Browse error:', error);
            const isWindows = navigator.platform.toUpperCase().indexOf('WIN') > -1;
            let example = isWindows ? "C:\\Users\\YourName\\MyProject\\project.json" : "/Users/YourName/MyProject/project.json";
            alert('File picker unavailable.\\n\\nPlease manually type the full path to your project.json file.\\n\\nExample: ' + example);
        }
    });

    // Validate project name (no spaces, valid folder name)
    document.getElementById('projectName').addEventListener('input', function(e) {
        const value = e.target.value;
        const isValid = /^[a-zA-Z0-9_-]*$/.test(value);
        const errorDiv = document.getElementById('projectNameError');

        if (!isValid) {
            e.target.classList.add('is-invalid');
            errorDiv.textContent = 'Only letters, numbers, underscores (-) and hyphens (_) allowed. No spaces!';
        } else {
            e.target.classList.remove('is-invalid');
            errorDiv.textContent = '';
        }
    });

    // ===== AUTHORS =====

    function _formatAuthor(firstName, lastName) {
        const first = (firstName || '').trim();
        const last = (lastName || '').trim();
        if (first && last) return `${last}, ${first}`;
        return last || first || '';
    }

    function _parseAuthor(author) {
        if (!author) return { first: '', last: '' };
        if (author.includes(',')) {
            const parts = author.split(',');
            return { last: parts[0].trim(), first: (parts[1] || '').trim() };
        }
        const tokens = author.trim().split(/\s+/).filter(Boolean);
        if (tokens.length <= 1) return { first: tokens[0] || '', last: '' };
        return { first: tokens[0], last: tokens.slice(1).join(' ') };
    }

    function addAuthorRow(firstName = '', lastName = '') {
        const list = document.getElementById('metadataAuthorsList');
        if (!list) return;

        const row = document.createElement('div');
        row.className = 'd-flex gap-2 align-items-center author-row';
        row.innerHTML = `
            <input type="text" class="form-control form-control-sm author-first" placeholder="First" value="${firstName}">
            <input type="text" class="form-control form-control-sm author-last" placeholder="Last" value="${lastName}">
            <button type="button" class="btn btn-outline-danger btn-sm remove-author">
                <i class="fas fa-times"></i>
            </button>
        `;

        row.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', () => {
                updateCreateProjectButton();
            });
        });

        row.querySelector('.remove-author').addEventListener('click', () => {
            row.remove();
            if (!document.querySelector('#metadataAuthorsList .author-row')) {
                addAuthorRow();
            }
            updateCreateProjectButton();
        });

        list.appendChild(row);
    }

    function getAuthorsList() {
        const rows = document.querySelectorAll('#metadataAuthorsList .author-row');
        const authors = [];
        rows.forEach(row => {
            const first = row.querySelector('.author-first')?.value || '';
            const last = row.querySelector('.author-last')?.value || '';
            const formatted = _formatAuthor(first, last);
            if (formatted) authors.push(formatted);
        });
        return authors;
    }

    function hasAtLeastOneAuthor() {
        return getAuthorsList().length > 0;
    }

    function setAuthorsList(authors) {
        const list = document.getElementById('metadataAuthorsList');
        if (!list) return;
        list.innerHTML = '';
        if (!Array.isArray(authors) || authors.length === 0) {
            addAuthorRow();
            return;
        }
        authors.forEach(author => {
            const parsed = _parseAuthor(author);
            addAuthorRow(parsed.first, parsed.last);
        });
    }

    // ===== RECRUITMENT LOCATIONS =====

    function addRecLocationRow(value = '') {
        const list = document.getElementById('smRecLocationList');
        if (!list) return;

        const row = document.createElement('div');
        row.className = 'd-flex gap-2 align-items-center rec-location-row';
        row.innerHTML = `
            <input type="text" class="form-control form-control-sm rec-location" placeholder="e.g. Graz, Austria" value="${value}">
            <button type="button" class="btn btn-outline-danger btn-sm remove-location">
                <i class="fas fa-times"></i>
            </button>
        `;

        row.querySelector('.rec-location').addEventListener('input', () => {
            updateCreateProjectButton();
        });

        row.querySelector('.remove-location').addEventListener('click', () => {
            row.remove();
            if (!document.querySelector('#smRecLocationList .rec-location-row')) {
                addRecLocationRow();
            }
            updateCreateProjectButton();
        });

        list.appendChild(row);
    }

    function getRecLocationList() {
        const rows = document.querySelectorAll('#smRecLocationList .rec-location-row');
        const locations = [];
        rows.forEach(row => {
            const value = row.querySelector('.rec-location')?.value || '';
            const trimmed = value.trim();
            if (trimmed) locations.push(trimmed);
        });
        return locations;
    }

    function hasAtLeastOneRecLocation() {
        return getRecLocationList().length > 0;
    }

    function setRecLocationList(locations) {
        const list = document.getElementById('smRecLocationList');
        if (!list) return;
        list.innerHTML = '';
        if (!Array.isArray(locations) || locations.length === 0) {
            addRecLocationRow();
            return;
        }
        locations.forEach(loc => addRecLocationRow(loc));
    }

    function getRecMethodList() {
        const select = document.getElementById('smRecMethod');
        if (!select) return [];
        return Array.from(select.selectedOptions)
            .map(opt => opt.value)
            .filter(v => v && v.trim());
    }

    function hasAtLeastOneRecMethod() {
        return getRecMethodList().length > 0;
    }

    function setRecMethodList(methods) {
        const select = document.getElementById('smRecMethod');
        if (!select) return;
        const values = Array.isArray(methods) ? methods : [];
        Array.from(select.options).forEach(opt => {
            opt.selected = values.includes(opt.value);
        });
    }

    function initYearMonthSelect(yearSelectId, monthSelectId) {
        const yearSelect = document.getElementById(yearSelectId);
        const monthSelect = document.getElementById(monthSelectId);
        if (!yearSelect || !monthSelect) return;

        const now = new Date();
        const currentYear = now.getFullYear();
        const startYear = currentYear - 20;
        const endYear = currentYear;

        yearSelect.innerHTML = '<option value="">Year</option>';
        for (let y = endYear; y >= startYear; y -= 1) {
            const opt = document.createElement('option');
            opt.value = String(y);
            opt.textContent = String(y);
            yearSelect.appendChild(opt);
        }

        monthSelect.innerHTML = '<option value="">Month</option>';
        const currentMonth = now.getMonth() + 1;
        const orderedMonths = [];
        for (let m = currentMonth; m <= 12; m += 1) orderedMonths.push(m);
        for (let m = 1; m < currentMonth; m += 1) orderedMonths.push(m);
        orderedMonths.forEach(m => {
            const value = String(m).padStart(2, '0');
            const opt = document.createElement('option');
            opt.value = value;
            opt.textContent = value;
            monthSelect.appendChild(opt);
        });
    }

    function getYearMonthValue(yearSelectId, monthSelectId) {
        const year = document.getElementById(yearSelectId)?.value || '';
        const month = document.getElementById(monthSelectId)?.value || '';
        if (!year || !month) return '';
        return `${year}-${month}`;
    }

    function setYearMonthValue(yearSelectId, monthSelectId, value) {
        const yearSelect = document.getElementById(yearSelectId);
        const monthSelect = document.getElementById(monthSelectId);
        if (!value) {
            if (yearSelect) yearSelect.value = '';
            if (monthSelect) monthSelect.value = '';
            return;
        }
        const parts = value.split('-');
        if (parts.length < 2) return;
        const year = parts[0];
        const month = parts[1];
        if (yearSelect) yearSelect.value = year;
        if (monthSelect) monthSelect.value = month;
    }

    function hasRecPeriodStart() {
        return Boolean(getYearMonthValue('smRecPeriodStartYear', 'smRecPeriodStartMonth'));
    }

    function hasRecPeriodEnd() {
        return Boolean(getYearMonthValue('smRecPeriodEndYear', 'smRecPeriodEndMonth'));
    }

    // ===== MANDATORY METADATA VALIDATION =====
    
    // Function to check if all mandatory fields across all tabs are filled
    function validateAllMandatoryFields() {
        const completeness = computeLocalCompleteness();
        const emptyFields = [];

        const labels = {
            Basics: {
                Name: 'Dataset Name'
            },
            Overview: {
                Main: 'Dataset Overview'
            },
            StudyDesign: {
                Type: 'Study Design Type'
            },
            Recruitment: {
                Method: 'Recruitment Method',
                Location: 'Recruitment Location',
                'Period.Start': 'Recruitment Period Start',
                'Period.End': 'Recruitment Period End',
                Compensation: 'Financial Compensation'
            },
            Eligibility: {
                InclusionCriteria: 'Inclusion Criteria',
                ExclusionCriteria: 'Exclusion Criteria'
            },
            Procedure: {
                Overview: 'Procedure Overview'
            }
        };

        Object.entries(completeness.sections || {}).forEach(([sectionName, section]) => {
            (section.fields || []).forEach(field => {
                if (!field.required || field.filled) return;
                const friendlyLabel = labels[sectionName]?.[field.name] || `${sectionName}: ${field.name}`;
                emptyFields.push(friendlyLabel);
            });
        });
        
        return {
            isValid: emptyFields.length === 0,
            emptyFields: emptyFields
        };
    }
    
    // Function to update Create Project button state
    function updateCreateProjectButton() {
        const createBtn = document.querySelector('#createProjectForm button[type="submit"]');
        const validation = validateAllMandatoryFields();
        
        if (validation.isValid) {
            createBtn.disabled = false;
            createBtn.classList.remove('btn-secondary');
            createBtn.classList.add('btn-success');
            createBtn.innerHTML = '<i class="fas fa-folder-plus me-2"></i>Create Project';
        } else {
            createBtn.disabled = true;
            createBtn.classList.remove('btn-success');
            createBtn.classList.add('btn-secondary');
            const count = validation.emptyFields.length;
            createBtn.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>Complete Study Metadata (${count} field${count > 1 ? 's' : ''} missing)`;
        }
    }
    
    // Add event listeners to all mandatory fields
    const mandatoryFieldIds = [
        'metadataName',
        'smOverviewMain', 'smSDType', 'smRecMethod',
        'smRecPeriodStartYear', 'smRecPeriodStartMonth',
        'smRecPeriodEndYear', 'smRecPeriodEndMonth',
        'smRecCompensation',
        'smEligInclusion', 'smEligExclusion',
        'smProcOverview'
    ];
    
    mandatoryFieldIds.forEach(fieldId => {
        const element = document.getElementById(fieldId);
        if (element) {
            const eventType = element.tagName === 'SELECT' ? 'change' : 'input';
            element.addEventListener(eventType, function() {
                updateCreateProjectButton();
            });
        }
    });
    
    // Authors row add button
    document.getElementById('addAuthorRow').addEventListener('click', () => addAuthorRow());

    // Recruitment location add button
    document.getElementById('addRecLocationRow').addEventListener('click', () => addRecLocationRow());

    // Special handler for Dataset Name with auto-population
    document.getElementById('metadataName').addEventListener('input', function() {
        updateCreateProjectButton();
        
        // Auto-populate project name from dataset name (sanitized)
        const datasetName = this.value.trim();
        const projectNameField = document.getElementById('projectName');
        
        // Only auto-populate if the project name field is empty
        if (projectNameField.value === '') {
            // Convert dataset name to valid project name: lowercase, replace spaces/special chars with underscores
            const sanitizedName = datasetName
                .toLowerCase()
                .replace(/[^a-z0-9_-]/g, '_')  // Replace invalid chars with underscore
                .replace(/_+/g, '_')  // Replace multiple underscores with single
                .replace(/^_|_$/g, '');  // Remove leading/trailing underscores
            
            if (sanitizedName) {
                projectNameField.value = sanitizedName;
            }
        }
    });
    
    // Initialize button state on page load
    document.addEventListener('DOMContentLoaded', function() {
        if (!document.querySelector('#metadataAuthorsList .author-row')) {
            addAuthorRow();
        }
        if (!document.querySelector('#smRecLocationList .rec-location-row')) {
            addRecLocationRow();
        }
        initYearMonthSelect('smRecPeriodStartYear', 'smRecPeriodStartMonth');
        initYearMonthSelect('smRecPeriodEndYear', 'smRecPeriodEndMonth');
        updateCreateProjectButton();
        
        // Set Dataset Type to raw by default
        const datasetTypeSelect = document.getElementById('metadataType');
        if (datasetTypeSelect) {
            datasetTypeSelect.value = 'raw';
        }
        
        // Initialize ethics fields visibility
        setEthicsChoice(document.getElementById('metadataEthicsApproved')?.value || 'no');
    });
    
    // ===== END MANDATORY METADATA VALIDATION =====

    // Helper to convert textarea newlines to array
    function _textToArray(val) {
        if (!val) return undefined;
        return val.split('\n').map(s => s.trim()).filter(s => s);
    }

    function buildDraftDatasetDescriptionForValidation() {
        const overviewMain = document.getElementById('smOverviewMain')?.value?.trim() || '';
        return {
            Name: document.getElementById('metadataName')?.value?.trim() || '',
            Authors: getAuthorsList(),
            License: document.getElementById('metadataLicense')?.value || '',
            Acknowledgements: document.getElementById('metadataAcknowledgements')?.value?.trim() || '',
            DatasetDOI: document.getElementById('metadataDOI')?.value?.trim() || '',
            EthicsApprovals: getEthicsApprovals(),
            Keywords: (document.getElementById('metadataKeywords')?.value || '')
                .split(',').map(s => s.trim()).filter(s => s),
            BIDSVersion: '1.10.1',
            DatasetType: document.getElementById('metadataType')?.value || 'raw',
            HowToAcknowledge: document.getElementById('metadataHowToAcknowledge')?.value?.trim() || '',
            Funding: (document.getElementById('metadataFunding')?.value || '')
                .split(',').map(s => s.trim()).filter(s => s),
            ReferencesAndLinks: (document.getElementById('metadataReferences')?.value || '')
                .split(',').map(s => s.trim()).filter(s => s),
            HEDVersion: document.getElementById('metadataHED')?.value?.trim() || '',
            Description: overviewMain || undefined
        };
    }

    let descriptionValidationTimer = null;
    async function validateDatasetDescriptionDraftLive() {
        const payload = { description: buildDraftDatasetDescriptionForValidation() };
        try {
            const response = await fetch('/api/projects/description/validate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            if (result.success) {
                displayMetadataIssues(result.issues || []);
            }
        } catch (error) {
            // Keep UX quiet for transient validation failures
            console.debug('Live description validation failed:', error);
        }
    }

    function scheduleLiveDescriptionValidation() {
        if (descriptionValidationTimer) {
            clearTimeout(descriptionValidationTimer);
        }
        descriptionValidationTimer = setTimeout(() => {
            validateDatasetDescriptionDraftLive();
        }, 250);
    }

    // Create Project Form
    document.getElementById('createProjectForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const projectName = document.getElementById('projectName').value.trim();
        const projectPath = document.getElementById('projectPath').value.trim();

        // Validate all mandatory metadata fields
        const validation = validateAllMandatoryFields();
        if (!validation.isValid) {
            const fieldList = validation.emptyFields.map(f => `- ${f}`).join('\\n');
            alert(`Please complete all mandatory fields in Study Metadata:\\n\\n${fieldList}`);
            return;
        }

        // Validate dataset_description draft before creation so issues are surfaced early
        await validateDatasetDescriptionDraftLive();

        // Validate project name
        if (!/^[a-zA-Z0-9_-]+$/.test(projectName)) {
            alert('Invalid project name. Only letters, numbers, underscores and hyphens allowed.');
            return;
        }

        const btn = this.querySelector('button[type="submit"]');
        const originalText = setButtonLoading(btn, true, 'Creating...');

        // Combine path and project name
        const separator = projectPath.includes('/') ? '/' : '\\';
        const fullPath = projectPath + separator + projectName;

        const data = {
            path: fullPath,
            name: projectName,
            // Modern BIDS metadata from Basics tab
            authors: getAuthorsList(),
            license: document.getElementById('metadataLicense').value,
            doi: document.getElementById('metadataDOI').value.trim(),
            keywords: document.getElementById('metadataKeywords').value.split(',').map(s => s.trim()).filter(s => s),
            acknowledgements: document.getElementById('metadataAcknowledgements').value.trim(),
            ethics_approvals: getEthicsApprovals(),
            how_to_acknowledge: document.getElementById('metadataHowToAcknowledge').value.trim(),
            funding: document.getElementById('metadataFunding').value.split(',').map(s => s.trim()).filter(s => s),
            references_and_links: document.getElementById('metadataReferences').value.split(',').map(s => s.trim()).filter(s => s),
            hed_version: document.getElementById('metadataHED').value.trim(),
            dataset_type: document.getElementById('metadataType').value,
            // Study metadata sections (persist directly into project.json at creation time)
            Overview: {
                Main: document.getElementById('smOverviewMain').value || undefined,
                IndependentVariables: document.getElementById('smOverviewIV').value || undefined,
                DependentVariables: document.getElementById('smOverviewDV').value || undefined,
                ControlVariables: document.getElementById('smOverviewCV').value || undefined,
                QualityAssessment: document.getElementById('smOverviewQA').value || undefined,
            },
            StudyDesign: {
                Type: document.getElementById('smSDType').value || undefined,
                TypeDescription: document.getElementById('smSDTypeDesc').value || undefined,
                Blinding: document.getElementById('smSDBlinding').value || undefined,
                Randomization: document.getElementById('smSDRandomization').value || undefined,
                ControlCondition: document.getElementById('smSDControl').value || undefined,
            },
            Conditions: {
                Type: document.getElementById('smSDConditionType').value || undefined,
            },
            Recruitment: {
                Method: (function() {
                    const list = getRecMethodList();
                    return list.length ? list : undefined;
                })(),
                Location: (function() {
                    const list = getRecLocationList();
                    return list.length ? list : undefined;
                })(),
                Period: {
                    Start: getYearMonthValue('smRecPeriodStartYear', 'smRecPeriodStartMonth') || undefined,
                    End: getYearMonthValue('smRecPeriodEndYear', 'smRecPeriodEndMonth') || undefined,
                },
                Compensation: document.getElementById('smRecCompensation').value || undefined,
            },
            Eligibility: {
                InclusionCriteria: _textToArray(document.getElementById('smEligInclusion').value) || undefined,
                ExclusionCriteria: _textToArray(document.getElementById('smEligExclusion').value) || undefined,
                TargetSampleSize: parseInt(document.getElementById('smEligSampleSize').value) || undefined,
                PowerAnalysis: document.getElementById('smEligPower').value || undefined,
            },
            Procedure: {
                Overview: document.getElementById('smProcOverview').value || undefined,
                InformedConsent: document.getElementById('smProcConsent').value || undefined,
                QualityControl: _textToArray(document.getElementById('smProcQC').value) || undefined,
                MissingDataHandling: document.getElementById('smProcMissing').value || undefined,
                Debriefing: document.getElementById('smProcDebriefing').value || undefined,
                AdditionalData: document.getElementById('smProcAdditionalData').value || undefined,
                Notes: document.getElementById('smProcNotes').value || undefined,
            },
            MissingData: {
                Description: document.getElementById('smMissingDesc').value || undefined,
                MissingFiles: document.getElementById('smMissingFiles').value || undefined,
                KnownIssues: document.getElementById('smKnownIssues').value || undefined,
            },
            References: document.getElementById('smReferences').value || undefined
        };

        try {
            const response = await fetch('/api/projects/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();

            const resultDiv = document.getElementById('createResult');
            resultDiv.style.display = 'block';

            if (result.success) {
                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h5><i class="fas fa-check-circle me-2"></i>Project Created Successfully!</h5>
                        <p class="mb-2">${result.message}</p>
                        <p class="mb-2"><strong>Location:</strong> <code>${result.path}</code></p>
                        <p class="mb-0 text-success"><i class="fas fa-folder-open me-1"></i>This project is now your current working project.</p>
                        <hr>
                        <p class="mb-1"><strong>Created files:</strong></p>
                        <ul class="mb-2">
                            ${result.created_files.map(f => `<li><code>${f}</code></li>`).join('')}
                        </ul>
                        <div class="mt-3 pt-3 border-top">
                            <h6 class="text-muted mb-2">Next Steps:</h6>
                            <div class="btn-group" role="group">
                                <a href="/converter" class="btn btn-sm btn-outline-success">
                                    <i class="fas fa-magic me-1"></i>Open Converter Tool
                                </a>
                            </div>
                            <small class="text-muted d-block mt-2">
                                Add subject folders and metadata before validating to avoid missing data errors.
                            </small>
                        </div>
                    </div>
                `;

                // Update local state and refresh dependent UI components
                currentProjectPath = result.current_project.path;
                currentProjectName = result.current_project.name;
                window.currentProjectPath = currentProjectPath;
                window.currentProjectName = currentProjectName;
                addRecentProject(currentProjectName, currentProjectPath);
                if (window.updateNavbarProject) {
                    window.updateNavbarProject(currentProjectName, currentProjectPath);
                }
                showStudyMetadataCard();
                showExportCard();
                showMethodsCard();
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h5><i class="fas fa-exclamation-circle me-2"></i>Error</h5>
                        <p class="mb-0">${result.error}</p>
                    </div>
                `;
            }
        } catch (error) {
            document.getElementById('createResult').innerHTML = `
                <div class="alert alert-danger">
                    <h5><i class="fas fa-exclamation-circle me-2"></i>Error</h5>
                    <p class="mb-0">${error.message}</p>
                </div>
            `;
            document.getElementById('createResult').style.display = 'block';
        } finally {
            setButtonLoading(btn, false, null, originalText);
        }
    });

    // Open Project Form
    document.getElementById('openProjectForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const btn = this.querySelector('button[type="submit"]');
        const originalText = setButtonLoading(btn, true, 'Validating...');

        const path = document.getElementById('existingPath').value;

        // Strict validation: must be a project.json file
        if (!path.toLowerCase().endsWith('project.json')) {
            const resultDiv = document.getElementById('validationResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <div class="validation-result invalid">
                    <h5><i class="fas fa-exclamation-circle me-2"></i>Selection Error</h5>
                    <p class="mb-0">You must select the <strong>project.json</strong> file. Folder selection is no longer supported for project loading.</p>
                </div>
            `;
            setButtonLoading(btn, false, null, originalText);
            return;
        }

        try {
            const response = await fetch('/api/projects/validate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: path })
            });
            const result = await response.json();

            const resultDiv = document.getElementById('validationResult');
            resultDiv.style.display = 'block';

            if (!result.success) {
                resultDiv.innerHTML = `
                    <div class="validation-result invalid">
                        <h5><i class="fas fa-exclamation-circle me-2"></i>Error</h5>
                        <p class="mb-0">${result.error}</p>
                    </div>
                `;
                return;
            }

            const stats = result.stats;
            const issues = result.issues;
            const fixableIssues = result.fixable_issues;

            let statusClass = 'valid';
            let statusIcon = 'check-circle';
            let statusText = 'Valid PRISM Structure';

            if (issues.length > 0) {
                const hasNonFixable = issues.some(i => !i.fixable);
                if (hasNonFixable) {
                    statusClass = 'invalid';
                    statusIcon = 'exclamation-circle';
                    statusText = `${issues.length} Issue(s) Found`;
                } else {
                    statusClass = 'warning';
                    statusIcon = 'exclamation-triangle';
                    statusText = `${issues.length} Fixable Issue(s) Found`;
                }
            }

            let html = `
                <div class="validation-result ${statusClass}">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="mb-0"><i class="fas fa-${statusIcon} me-2"></i>${statusText}</h5>
                        ${stats.is_yoda ? '<span class="badge bg-info"><i class="fas fa-microchip me-1"></i>YODA Layout</span>' : ''}
                    </div>
                    <p class="text-success mb-3"><i class="fas fa-folder-open me-1"></i>This project is now your current working project and is shown in the navbar.</p>

                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value">${stats.subjects}</div>
                            <div class="stat-label">Subjects</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${stats.sessions.length || 0}</div>
                            <div class="stat-label">Sessions</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${stats.modalities.length}</div>
                            <div class="stat-label">Modalities</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${stats.has_dataset_description ? '' : ''}</div>
                            <div class="stat-label">dataset_description</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${stats.has_participants_tsv ? '' : ''}</div>
                            <div class="stat-label">participants.tsv</div>
                        </div>
                    </div>
            `;

            if (issues.length > 0) {
                html += `
                    <hr>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">Issues</h6>
                        ${fixableIssues.length > 0 ? `
                            <button class="btn btn-warning btn-sm" onclick="fixAllIssues('${path}')">
                                <i class="fas fa-wrench me-1"></i>Fix All (${fixableIssues.length})
                            </button>
                        ` : ''}
                    </div>
                    <div id="issuesList">
                `;

                issues.forEach(issue => {
                    html += `
                        <div class="issue-item ${issue.fixable ? 'fixable' : 'not-fixable'}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${issue.code}</strong>: ${issue.message}
                                    ${issue.file_path ? `<br><small class="text-muted">${issue.file_path}</small>` : ''}
                                    ${issue.fix_hint ? `
                                        <div class="alert alert-info py-1 px-2 mt-2 mb-0 smaller d-flex align-items-center">
                                            <i class="fas fa-lightbulb me-2 text-warning"></i>
                                            <div><strong>Hint:</strong> ${issue.fix_hint}</div>
                                        </div>
                                    ` : ''}
                                </div>
                                ${issue.fixable ? `
                                    <button class="btn btn-sm btn-outline-warning" onclick="fixIssue('${path}', '${issue.code}')">
                                        <i class="fas fa-wrench"></i>
                                    </button>
                                ` : `
                                    <span class="badge bg-secondary">Manual fix required</span>
                                `}
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
            }

            // Add workflow links
            html += `
                <hr>
                <div class="mt-3">
                    <h6 class="text-muted mb-2">Next Steps:</h6>
                    <div class="btn-group" role="group">
                        <a href="/template-editor" class="btn btn-sm btn-outline-success">
                            <i class="fas fa-file-import me-1"></i>Import Templates
                        </a>
                        <a href="/survey-generator" class="btn btn-sm btn-outline-info">
                            <i class="fas fa-poll-h me-1"></i>Survey & Boilerplate
                        </a>
                        <a href="/validate" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-check-circle me-1"></i>Validate Dataset
                        </a>
                    </div>
                </div>
            `;

            html += '</div>';
            resultDiv.innerHTML = html;

            // Update local state and refresh dependent UI components
            currentProjectPath = result.current_project.path;
            currentProjectName = result.current_project.name;
            window.currentProjectPath = currentProjectPath;
            window.currentProjectName = currentProjectName;
            addRecentProject(currentProjectName, currentProjectPath);
            if (window.updateNavbarProject) {
                window.updateNavbarProject(currentProjectName, currentProjectPath);
            }
            showStudyMetadataCard();
            showExportCard();
            showMethodsCard();

        } catch (error) {
            document.getElementById('validationResult').innerHTML = `
                <div class="validation-result invalid">
                    <h5><i class="fas fa-exclamation-circle me-2"></i>Error</h5>
                    <p class="mb-0">${error.message}</p>
                </div>
            `;
            document.getElementById('validationResult').style.display = 'block';
        } finally {
            setButtonLoading(btn, false, null, originalText);
        }
    });

    // Fix single issue
    async function fixIssue(path, code) {
        try {
            const response = await fetch('/api/projects/fix', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: path, fix_codes: [code] })
            });
            const result = await response.json();

            if (result.success) {
                // Re-validate to refresh the view
                document.getElementById('openProjectForm').dispatchEvent(new Event('submit'));
            } else {
                alert('Error applying fix: ' + result.error);
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }

    // Fix all issues
    async function fixAllIssues(path) {
        try {
            const response = await fetch('/api/projects/fix', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: path })
            });
            const result = await response.json();

            if (result.success) {
                // Re-validate to refresh the view
                document.getElementById('openProjectForm').dispatchEvent(new Event('submit'));
            } else {
                alert('Error applying fixes: ' + result.error);
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }

    // Clear current project
    async function clearCurrentProject() {
        try {
            const response = await fetch('/api/projects/current', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: null })
            });
            // Refresh the page to update the UI
            window.location.reload();
        } catch (error) {
            console.error('Error clearing project:', error);
        }
    }

    // ===== DATASET DESCRIPTION / METADATA =====

    async function loadDatasetDescriptionFields() {
        if (!currentProjectPath) return;

        try {
            const response = await fetch('/api/projects/description');
            const data = await response.json();

            if (data.success && data.description) {
                const desc = data.description;

                // Fill form fields
                document.getElementById('metadataName').value = desc.Name || '';
                setAuthorsList(Array.isArray(desc.Authors) ? desc.Authors : (desc.Authors ? [desc.Authors] : []));
                document.getElementById('metadataLicense').value = desc.License || 'CC0';
                document.getElementById('metadataAcknowledgements').value = desc.Acknowledgements || '';
                document.getElementById('metadataDOI').value = desc.DatasetDOI || '';
                setEthicsApprovals(desc.EthicsApprovals);
                document.getElementById('metadataKeywords').value = Array.isArray(desc.Keywords) ? desc.Keywords.join(', ') : (desc.Keywords || '');
                document.getElementById('metadataType').value = desc.DatasetType || 'raw';
                document.getElementById('metadataHED').value = Array.isArray(desc.HEDVersion) ? desc.HEDVersion.join(', ') : (desc.HEDVersion || '');
                document.getElementById('metadataFunding').value = Array.isArray(desc.Funding) ? desc.Funding.join(', ') : (desc.Funding || '');
                document.getElementById('metadataHowToAcknowledge').value = desc.HowToAcknowledge || '';
                document.getElementById('metadataReferences').value = Array.isArray(desc.ReferencesAndLinks) ? desc.ReferencesAndLinks.join(', ') : (desc.ReferencesAndLinks || '');
                
                // Show issues if any
                displayMetadataIssues(data.issues || []);
            }
        } catch (error) {
            console.error('Error loading dataset description:', error);
        }
    }

    // Display validation issues for dataset_description
    function displayMetadataIssues(issues) {
        const feedbackDiv = document.getElementById('metadataValidationFeedback');
        if (!feedbackDiv) return;

        if (!issues || issues.length === 0) {
            feedbackDiv.style.display = 'none';
            feedbackDiv.innerHTML = '';
            return;
        }

        feedbackDiv.style.display = 'block';
        let html = `
            <div class="alert alert-warning py-2 mb-0">
                <div class="fw-bold mb-1 small text-uppercase">
                    <i class="fas fa-exclamation-triangle me-2"></i>Dataset Description Issues (${issues.length})
                </div>
                <ul class="mb-0 ps-3 small">
        `;

        issues.forEach(issue => {
            html += `
                <li class="mb-1">
                    <strong>${issue.message}</strong>
                    ${issue.fix_hint ? `<div class="text-muted smaller"><i class="fas fa-lightbulb me-1"></i>${issue.fix_hint}</div>` : ''}
                </li>
            `;
        });

        html += `
                </ul>
            </div>
        `;
        feedbackDiv.innerHTML = html;
    }

    // Save dataset_description fields
    async function saveDatasetDescription() {
        try {
            // BIDS Validation: Check REQUIRED fields
            const nameField = document.getElementById('metadataName');
            if (!nameField || !nameField.value.trim()) {
                throw new Error(' REQUIRED FIELD: Dataset Name is mandatory per BIDS specification');
            }

            const overviewMain = document.getElementById('smOverviewMain');
            const overviewText = overviewMain ? overviewMain.value.trim() : '';

            // Reconstruct the JSON object
            const description = {
                Name: nameField.value.trim(),
                Authors: getAuthorsList(),
                License: document.getElementById('metadataLicense').value,
                Acknowledgements: document.getElementById('metadataAcknowledgements').value,
                DatasetDOI: document.getElementById('metadataDOI').value,
                EthicsApprovals: getEthicsApprovals(),
                Keywords: document.getElementById('metadataKeywords').value.split(',').map(s => s.trim()).filter(s => s),
                BIDSVersion: "1.10.1",
                DatasetType: document.getElementById('metadataType').value || 'raw',
                HowToAcknowledge: document.getElementById('metadataHowToAcknowledge').value,
                Funding: document.getElementById('metadataFunding').value.split(',').map(s => s.trim()).filter(s => s),
                ReferencesAndLinks: document.getElementById('metadataReferences').value.split(',').map(s => s.trim()).filter(s => s),
                HEDVersion: document.getElementById('metadataHED').value.trim(),
                Description: overviewText || undefined
            };

            // Keep existing fields not in form (like GeneratedBy, SourceDatasets)
            try {
                const currentResp = await fetch('/api/projects/description');
                const currentData = await currentResp.json();
                if (currentData.success && currentData.description) {
                    description.GeneratedBy = currentData.description.GeneratedBy;
                    description.SourceDatasets = currentData.description.SourceDatasets;
                    description.DatasetLinks = currentData.description.DatasetLinks;
                }
            } catch (e) {
                console.warn('Could not merge with existing description', e);
            }

            const response = await fetch('/api/projects/description', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ description })
            });

            const result = await response.json();
            if (result.success) {
                // Show any remaining validation issues
                displayMetadataIssues(result.issues || []);

                // Sync navbar badge if the project label changed
                if (description.Name && description.Name !== currentProjectName) {
                    currentProjectName = description.Name;
                    if (window.updateNavbarProject && currentProjectPath) {
                        window.updateNavbarProject(currentProjectName, currentProjectPath);
                    }
                }
            } else {
                throw new Error(result.error || 'Failed to save metadata');
            }
        } catch (error) {
            console.error('Error saving dataset description:', error);
            throw error;
        }
    }

    // Toast helper if not defined elsewhere
    function showToast(message, type = 'success') {
        const toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            const container = document.createElement('div');
            container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(container);
        }
        
        // Simple alert for now if Bootstrap toast is not set up
        console.log(`[${type}] ${message}`);
    }

    // ===== DATA EXPORT / SHARE =====
    function showExportCard() {
        const card = document.getElementById('exportProjectCard');
        if (!card) return;
        
        if (currentProjectPath) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    }

    // ===== STUDY METADATA =====

    function showStudyMetadataCard() {
        const card = document.getElementById('studyMetadataCard');
        if (!card) return;
        const createSection = document.getElementById('section-create');
        const createActive = createSection && createSection.classList.contains('active');
        if (currentProjectPath || createActive) {
            card.style.display = 'block';
            if (createActive) {
                resetStudyMetadataForm();
            } else if (currentProjectPath) {
                loadStudyMetadata();
            }
            return;
        }
        card.style.display = 'none';
    }

    function resetStudyMetadataForm() {
        const form = document.getElementById('studyMetadataForm');
        if (!form) return;

        form.querySelectorAll('input, textarea, select').forEach(el => {
            if (el.tagName === 'SELECT') {
                if (el.id === 'metadataType') {
                    el.value = 'raw';
                } else {
                    el.value = '';
                }
            } else {
                el.value = '';
            }
        });

        setAuthorsList([]);
        setRecLocationList([]);
        setRecMethodList([]);
        setYearMonthValue('smRecPeriodStartYear', 'smRecPeriodStartMonth', '');
        setYearMonthValue('smRecPeriodEndYear', 'smRecPeriodEndMonth', '');
        const condType = document.getElementById('smSDConditionType');
        if (condType) condType.value = '';
        _clearAllHintBadges();
        displayMetadataIssues([]);

        const badgeIds = [
            'smBasicsBadge', 'smOverviewBadge', 'smStudyDesignBadge',
            'smRecruitmentBadge', 'smEligibilityBadge',
            'smProcedureBadge', 'smMissingDataBadge', 'smReferencesBadge'
        ];
        badgeIds.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.innerHTML = '';
        });

        updateCompletenessUI({ score: 0, sections: {} });
        updateCreateProjectButton();
    }

    /**
     * Map of hint key  { elementId, type ('input'|'select'|'textarea'|'special') }
     * Used to apply auto-detected values and show hint badges.
     */
    const _smHintFieldMap = {
        'Recruitment.Period.Start':       { el: null, type: 'period-start' },
        'Recruitment.Period.End':         { el: null, type: 'period-end' },
        'StudyDesign.Type':               { el: 'smSDType', type: 'select' },
        'Conditions.Type':                { el: 'smSDConditionType', type: 'select' },
        'Eligibility.ActualSampleSize':   { el: 'smEligSampleSize', type: 'input' },
    };

    function _clearAllHintBadges() {
        document.querySelectorAll('.sm-hint-badge').forEach(b => b.remove());
    }

    function _applyHintBadge(elementId, hint, type) {
        const el = document.getElementById(elementId);
        if (!el) return;
        // Only show hint if the field is currently empty
        const currentVal = type === 'select' ? el.value : el.value.trim();
        if (currentVal) return;

        // Remove existing badge for this field
        const existingBadge = el.parentElement.querySelector('.sm-hint-badge');
        if (existingBadge) existingBadge.remove();

        const displayVal = typeof hint.value === 'number' ? hint.value : hint.value;
        const badge = document.createElement('span');
        badge.className = 'sm-hint-badge badge bg-info bg-opacity-75 ms-1 mt-1';
        badge.style.cssText = 'cursor:pointer; font-size:0.7rem; display:inline-block;';
        badge.title = `Detected from ${hint.source}  click to apply`;
        badge.innerHTML = `<i class="fas fa-magic me-1"></i>${displayVal}`;
        badge.addEventListener('click', () => {
            el.value = hint.value;
            badge.remove();
            // Trigger change for selects
            if (type === 'select') el.dispatchEvent(new Event('change'));
        });

        // Insert after the input element
        el.parentElement.appendChild(badge);
    }

    function _applyHints(hints) {
        _clearAllHintBadges();
        if (!hints || typeof hints !== 'object') return;

        for (const [key, hint] of Object.entries(hints)) {
            const mapping = _smHintFieldMap[key];
            if (!mapping) continue;
            if (mapping.type === 'period-start') {
                setYearMonthValue('smRecPeriodStartYear', 'smRecPeriodStartMonth', hint.value);
                continue;
            }
            if (mapping.type === 'period-end') {
                setYearMonthValue('smRecPeriodEndYear', 'smRecPeriodEndMonth', hint.value);
                continue;
            }
            if (mapping.type === 'special') continue;
            _applyHintBadge(mapping.el, hint, mapping.type);
        }
    }

    async function loadStudyMetadata() {
        try {
            if (!currentProjectPath) return;
            // Load dataset description fields (Basics section)
            await loadDatasetDescriptionFields();
            
            const response = await fetch('/api/projects/study-metadata');
            const data = await response.json();
            if (!data.success) return;

            const sm = data.study_metadata;

            // Overview
            const overview = sm.Overview || {};
            document.getElementById('smOverviewMain').value = overview.Main || '';
            document.getElementById('smOverviewIV').value = overview.IndependentVariables || '';
            document.getElementById('smOverviewDV').value = overview.DependentVariables || '';
            document.getElementById('smOverviewCV').value = overview.ControlVariables || '';
            document.getElementById('smOverviewQA').value = overview.QualityAssessment || '';

            // Study Design
            const sd = sm.StudyDesign || {};
            document.getElementById('smSDType').value = sd.Type || '';
            document.getElementById('smSDConditionType').value = sm.Conditions?.Type || '';
            document.getElementById('smSDTypeDesc').value = sd.TypeDescription || '';
            document.getElementById('smSDBlinding').value = sd.Blinding || '';
            document.getElementById('smSDRandomization').value = sd.Randomization || '';
            document.getElementById('smSDControl').value = sd.ControlCondition || '';
            toggleExperimentalFields();

            // Recruitment
            const rec = sm.Recruitment || {};
            if (Array.isArray(rec.Method)) {
                setRecMethodList(rec.Method);
            } else if (typeof rec.Method === 'string') {
                setRecMethodList(rec.Method.split(';').map(s => s.trim()).filter(s => s));
            } else {
                setRecMethodList([]);
            }
            if (Array.isArray(rec.Location)) {
                setRecLocationList(rec.Location);
            } else if (typeof rec.Location === 'string') {
                setRecLocationList(rec.Location.split(';').map(s => s.trim()).filter(s => s));
            } else {
                setRecLocationList([]);
            }
            const period = rec.Period || {};
            setYearMonthValue('smRecPeriodStartYear', 'smRecPeriodStartMonth', period.Start || '');
            setYearMonthValue('smRecPeriodEndYear', 'smRecPeriodEndMonth', period.End || '');
            if (rec.Compensation) {
                const comp = String(rec.Compensation).toLowerCase();
                if (comp.includes('no')) {
                    document.getElementById('smRecCompensation').value = 'No financial compensation';
                } else if (comp.includes('financial')) {
                    document.getElementById('smRecCompensation').value = 'Financial compensation';
                } else {
                    document.getElementById('smRecCompensation').value = rec.Compensation;
                }
            } else {
                document.getElementById('smRecCompensation').value = '';
            }

            // Eligibility
            const elig = sm.Eligibility || {};
            document.getElementById('smEligInclusion').value = Array.isArray(elig.InclusionCriteria) ? elig.InclusionCriteria.join('\n') : '';
            document.getElementById('smEligExclusion').value = Array.isArray(elig.ExclusionCriteria) ? elig.ExclusionCriteria.join('\n') : '';
            document.getElementById('smEligSampleSize').value = elig.TargetSampleSize || '';
            document.getElementById('smEligPower').value = elig.PowerAnalysis || '';

            // Procedure
            const proc = sm.Procedure || {};
            document.getElementById('smProcOverview').value = proc.Overview || '';
            document.getElementById('smProcConsent').value = proc.InformedConsent || '';
            document.getElementById('smProcQC').value = Array.isArray(proc.QualityControl) ? proc.QualityControl.join('\n') : '';
            document.getElementById('smProcMissing').value = proc.MissingDataHandling || '';
            document.getElementById('smProcDebriefing').value = proc.Debriefing || '';

            // Apply auto-detected hints for empty fields
            _applyHints(data.hints || {});

            // Completeness
            if (data.completeness) {
                updateCompletenessUI(data.completeness);
            }
            
            // Update Create Project button state after loading metadata
            updateCreateProjectButton();
        } catch (error) {
            console.error('Error loading study metadata:', error);
        }
    }

    function toggleExperimentalFields() {
        const sdType = document.getElementById('smSDType').value;
        const experimentalTypes = ['randomized-controlled-trial', 'quasi-experimental', 'case-control'];
        const block = document.getElementById('smExperimentalFields');
        if (block) {
            block.style.display = experimentalTypes.includes(sdType) ? 'block' : 'none';
        }
    }

    function toggleEthicsFields() {
        const approvedInput = document.getElementById('metadataEthicsApproved');
        const detailsSection = document.getElementById('ethicsDetailsSection');
        
        if (!detailsSection) {
            console.error('ethicsDetailsSection not found');
            return;
        }
        
        if (!approvedInput) {
            console.warn('Ethics approval input not found, hiding details');
            detailsSection.style.display = 'none';
            detailsSection.classList.add('d-none');
            return;
        }

        const approved = approvedInput.value === 'yes';
        console.log('Ethics approved state:', approved ? 'yes' : 'no');
        
        detailsSection.hidden = !approved;
        detailsSection.style.display = approved ? 'block' : 'none';
        detailsSection.classList.toggle('d-none', !approved);
    }

    function setEthicsChoice(choice) {
        const yesBtn = document.getElementById('metadataEthicsYes');
        const noBtn = document.getElementById('metadataEthicsNo');
        const approvedInput = document.getElementById('metadataEthicsApproved');
        if (!yesBtn || !noBtn || !approvedInput) {
            console.warn('Ethics approval inputs not found');
            return;
        }

        const isYes = choice === 'yes';
        approvedInput.value = isYes ? 'yes' : 'no';
        yesBtn.classList.toggle('btn-primary', isYes);
        yesBtn.classList.toggle('btn-outline-primary', !isYes);
        noBtn.classList.toggle('btn-primary', !isYes);
        noBtn.classList.toggle('btn-outline-primary', isYes);

        toggleEthicsFields();
    }

    function getEthicsApprovals() {
        const approvedInput = document.getElementById('metadataEthicsApproved');
        if (!approvedInput) {
            console.warn('Ethics approval input not found, defaulting to "no"');
            return [];
        }
        if (approvedInput.value === 'no') {
            return [];
        }
        const committee = document.getElementById('metadataEthicsCommittee');
        const votum = document.getElementById('metadataEthicsVotum');
        if (!committee || !votum) {
            console.warn('Ethics committee or votum fields not found');
            return [];
        }
        const committeeValue = committee.value.trim();
        const votumValue = votum.value.trim();
        const approval = [];
        if (committeeValue) {
            approval.push(committeeValue + (votumValue ? ', ' + votumValue : ''));
        }
        return approval;
    }

    function setEthicsApprovals(ethicsArray) {
        const committeeField = document.getElementById('metadataEthicsCommittee');
        const votumField = document.getElementById('metadataEthicsVotum');
        
        if (!committeeField || !votumField) {
            console.warn('Ethics approval form elements not found');
            return;
        }
        
        if (!ethicsArray || ethicsArray.length === 0) {
            committeeField.value = '';
            votumField.value = '';
            setEthicsChoice('no');
            return;
        }

        // Parse the first ethics approval entry
        const ethicsStr = Array.isArray(ethicsArray) ? ethicsArray[0] : ethicsArray;
        const parts = ethicsStr.split(',').map(s => s.trim());
        
        committeeField.value = parts[0] || '';
        votumField.value = parts[1] || '';
        setEthicsChoice('yes');
    }


    let lastCompleteness = null;

    function computeLocalCompleteness() {
        const experimentalTypes = ['randomized-controlled-trial', 'quasi-experimental', 'case-control'];
        const sdType = document.getElementById('smSDType')?.value || '';
        const isExperimental = experimentalTypes.includes(sdType);

        const sections = {};
        let filledFields = 0;
        let totalFields = 0;

        const requiredFields = {
            Basics: new Set(['Name']),
            Overview: new Set(['Main']),
            StudyDesign: new Set(['Type']),
            Recruitment: new Set(['Method', 'Location', 'Period.Start', 'Period.End', 'Compensation']),
            Eligibility: new Set(['InclusionCriteria', 'ExclusionCriteria']),
            Procedure: new Set(['Overview'])
        };

        const addField = (section, name, isFilled) => {
            const isRequired = requiredFields[section]?.has(name) || false;
            if (!sections[section]) {
                sections[section] = {
                    fields: [],
                    filled: 0,
                    total: 0,
                    weight_filled: 0,
                    weight_total: 0,
                    required_filled: 0,
                    required_total: 0,
                    optional_filled: 0,
                    optional_total: 0,
                    read_only: section === 'SessionsTasks'
                };
            }
            sections[section].fields.push({ name, filled: isFilled, priority: 1, hint: '', required: isRequired });
            sections[section].total += 1;
            sections[section].weight_total += 1;
            if (isRequired) {
                sections[section].required_total += 1;
            } else {
                sections[section].optional_total += 1;
            }
            totalFields += 1;
            if (isFilled) {
                sections[section].filled += 1;
                sections[section].weight_filled += 1;
                if (isRequired) {
                    sections[section].required_filled += 1;
                } else {
                    sections[section].optional_filled += 1;
                }
                filledFields += 1;
            }
        };

        const textFilled = (value) => Boolean((value || '').trim());

        const keywordList = document.getElementById('metadataKeywords')?.value
            .split(',').map(s => s.trim()).filter(s => s) || [];

        addField('Basics', 'Name', textFilled(document.getElementById('metadataName')?.value));
        addField('Basics', 'Authors', getAuthorsList().length > 0);
        addField('Basics', 'Description', textFilled(document.getElementById('smOverviewMain')?.value));
        addField('Basics', 'EthicsApprovals', getEthicsApprovals().length > 0);
        addField('Basics', 'License', textFilled(document.getElementById('metadataLicense')?.value));
        addField('Basics', 'Keywords', keywordList.length > 0);
        addField('Basics', 'Acknowledgements', textFilled(document.getElementById('metadataAcknowledgements')?.value));
        addField('Basics', 'DatasetDOI', textFilled(document.getElementById('metadataDOI')?.value));
        addField('Basics', 'DatasetType', textFilled(document.getElementById('metadataType')?.value));
        addField('Basics', 'HEDVersion', textFilled(document.getElementById('metadataHED')?.value));
        addField('Basics', 'Funding', textFilled(document.getElementById('metadataFunding')?.value));
        addField('Basics', 'HowToAcknowledge', textFilled(document.getElementById('metadataHowToAcknowledge')?.value));
        addField('Basics', 'ReferencesAndLinks', textFilled(document.getElementById('metadataReferences')?.value));

        addField('Overview', 'Main', textFilled(document.getElementById('smOverviewMain')?.value));
        addField('Overview', 'IndependentVariables', textFilled(document.getElementById('smOverviewIV')?.value));
        addField('Overview', 'DependentVariables', textFilled(document.getElementById('smOverviewDV')?.value));
        addField('Overview', 'ControlVariables', textFilled(document.getElementById('smOverviewCV')?.value));
        addField('Overview', 'QualityAssessment', textFilled(document.getElementById('smOverviewQA')?.value));

        addField('StudyDesign', 'Type', textFilled(sdType));
        addField('StudyDesign', 'ConditionType', textFilled(document.getElementById('smSDConditionType')?.value));
        addField('StudyDesign', 'TypeDescription', textFilled(document.getElementById('smSDTypeDesc')?.value));
        if (isExperimental) {
            addField('StudyDesign', 'Blinding', textFilled(document.getElementById('smSDBlinding')?.value));
            addField('StudyDesign', 'Randomization', textFilled(document.getElementById('smSDRandomization')?.value));
            addField('StudyDesign', 'ControlCondition', textFilled(document.getElementById('smSDControl')?.value));
        }

        addField('Recruitment', 'Method', hasAtLeastOneRecMethod());
        addField('Recruitment', 'Location', hasAtLeastOneRecLocation());
        addField('Recruitment', 'Period.Start', hasRecPeriodStart());
        addField('Recruitment', 'Period.End', hasRecPeriodEnd());
        addField('Recruitment', 'Compensation', textFilled(document.getElementById('smRecCompensation')?.value));

        addField('Eligibility', 'InclusionCriteria', textFilled(document.getElementById('smEligInclusion')?.value));
        addField('Eligibility', 'ExclusionCriteria', textFilled(document.getElementById('smEligExclusion')?.value));

        addField('Procedure', 'Overview', textFilled(document.getElementById('smProcOverview')?.value));

        const score = totalFields > 0 ? Math.round((filledFields / totalFields) * 100) : 0;

        return {
            score,
            filled_fields: filledFields,
            total_fields: totalFields,
            sections
        };
    }

    function updateCompletenessUI(completeness) {
        if (!completeness) return;
        lastCompleteness = completeness;
        const score = completeness.score || 0;

        // Determine color
        let colorClass;
        if (score < 25) colorClass = 'bg-danger';
        else if (score < 50) colorClass = 'bg-primary';
        else if (score < 80) colorClass = 'bg-warning';
        else colorClass = 'bg-success';

        // Header mini progress
        const headerBar = document.getElementById('smHeaderProgressBar');
        if (headerBar) {
            headerBar.style.width = score + '%';
            headerBar.className = 'progress-bar ' + colorClass;
        }
        const headerBadge = document.getElementById('smHeaderBadge');
        if (headerBadge) {
            headerBadge.textContent = score + '%';
            headerBadge.className = 'badge ' + colorClass;
        }

        // Main progress bar
        const mainBar = document.getElementById('smMainProgressBar');
        if (mainBar) {
            mainBar.style.width = score + '%';
            mainBar.className = 'progress-bar ' + colorClass;
        }
        const mainScore = document.getElementById('smMainScore');
        if (mainScore) mainScore.textContent = score + '%';

        // Per-section dots
        const dotsDiv = document.getElementById('smSectionDots');
        if (!dotsDiv) return;

        const sections = completeness.sections || {};
        const sectionOrder = [
            'Basics', 'Overview', 'StudyDesign', 'Recruitment', 'Eligibility',
            'Procedure', 'SessionsTasks'
        ];
        const sectionLabels = {
            Basics: 'Basics (BIDS)',
            Overview: 'Overview',
            StudyDesign: 'Study Design',
            Recruitment: 'Recruitment',
            Eligibility: 'Eligibility',
            Procedure: 'Procedure',
            SessionsTasks: 'Sessions & Tasks'
        };

        let html = '';
        for (const key of sectionOrder) {
            const sec = sections[key];
            if (!sec) continue;
            const reqTotal = sec.required_total || 0;
            const reqFilled = sec.required_filled || 0;
            const optTotal = sec.optional_total || 0;
            const optFilled = sec.optional_filled || 0;
            const baseTotal = reqTotal > 0 ? reqTotal : sec.total;
            const baseFilled = reqTotal > 0 ? reqFilled : sec.filled;
            const pct = baseTotal > 0 ? Math.round(baseFilled / baseTotal * 100) : 0;
            let dotClass = 'empty';
            if (pct === 100) dotClass = 'full';
            else if (pct > 0) dotClass = 'partial';

            const autoLabel = sec.read_only ? ' <span class="text-muted small">(auto)</span>' : '';
            html += `<div class="section-completeness-row">
                <span class="section-label">${sectionLabels[key] || key}${autoLabel}</span>
                <span class="completeness-dot ${dotClass}" title="${pct}%"></span>
                <span class="section-badge text-muted">Required ${reqFilled}/${reqTotal}  FAIR ${optFilled}/${optTotal}</span>
            </div>`;

            // Update per-section badges in the form
            const badgeEl = document.getElementById('sm' + key + 'Badge');
            if (badgeEl) {
                const reqDone = reqTotal > 0 && reqFilled === reqTotal;
                const optDone = optTotal > 0 && optFilled === optTotal;
                const reqClass = reqDone ? 'bg-success' : 'bg-danger';
                const optClass = optDone ? 'bg-primary' : 'bg-secondary';
                badgeEl.innerHTML = `
                    <span class="badge ${reqClass} bg-opacity-75">Required ${reqFilled}/${reqTotal}</span>
                    <span class="badge ${optClass} bg-opacity-50">FAIR ${optFilled}/${optTotal}</span>
                `;
            }
        }
        dotsDiv.innerHTML = html;
    }

    function _textToArray(val) {
        return val.split('\n').map(s => s.trim()).filter(s => s);
    }

    // Study Metadata Form Submission
    const studyMetadataForm = document.getElementById('studyMetadataForm');
    if (studyMetadataForm) {
        const refreshCompleteness = () => {
            updateCompletenessUI(computeLocalCompleteness());
            updateCreateProjectButton();
            scheduleLiveDescriptionValidation();
        };
        studyMetadataForm.addEventListener('input', refreshCompleteness);
        studyMetadataForm.addEventListener('change', refreshCompleteness);
    }

    const createProjectForm = document.getElementById('createProjectForm');
    if (createProjectForm) {
        createProjectForm.addEventListener('input', scheduleLiveDescriptionValidation);
        createProjectForm.addEventListener('change', scheduleLiveDescriptionValidation);
    }

    studyMetadataForm?.addEventListener('submit', async function(e) {
        e.preventDefault();
        const btn = this.querySelector('button[type="submit"]');
        const originalText = setButtonLoading(btn, true, 'Saving...');

        try {
            const payload = {
               Overview: {
                    Main: document.getElementById('smOverviewMain').value || undefined,
                    IndependentVariables: document.getElementById('smOverviewIV').value || undefined,
                    DependentVariables: document.getElementById('smOverviewDV').value || undefined,
                    ControlVariables: document.getElementById('smOverviewCV').value || undefined,
                    QualityAssessment: document.getElementById('smOverviewQA').value || undefined,
                },
                StudyDesign: {
                    Type: document.getElementById('smSDType').value || undefined,
                    TypeDescription: document.getElementById('smSDTypeDesc').value || undefined,
                    Blinding: document.getElementById('smSDBlinding').value || undefined,
                    Randomization: document.getElementById('smSDRandomization').value || undefined,
                    ControlCondition: document.getElementById('smSDControl').value || undefined,
                },
                Conditions: {
                    Type: document.getElementById('smSDConditionType').value || undefined,
                },
                Recruitment: {
                    Method: (function() {
                        const list = getRecMethodList();
                        if (!list.length) return undefined;
                        return list.join('; ');
                    })(),
                    Location: (function() {
                        const list = getRecLocationList();
                        if (!list.length) return undefined;
                        return list.join('; ');
                    })(),
                    Period: {
                        Start: getYearMonthValue('smRecPeriodStartYear', 'smRecPeriodStartMonth') || undefined,
                        End: getYearMonthValue('smRecPeriodEndYear', 'smRecPeriodEndMonth') || undefined,
                    },
                    Compensation: document.getElementById('smRecCompensation').value || undefined,
                },
                Eligibility: {
                    InclusionCriteria: _textToArray(document.getElementById('smEligInclusion').value) || undefined,
                    ExclusionCriteria: _textToArray(document.getElementById('smEligExclusion').value) || undefined,
                    TargetSampleSize: parseInt(document.getElementById('smEligSampleSize').value) || undefined,
                    PowerAnalysis: document.getElementById('smEligPower').value || undefined,
                },
                Procedure: {
                    Overview: document.getElementById('smProcOverview').value || undefined,
                    InformedConsent: document.getElementById('smProcConsent').value || undefined,
                    QualityControl: _textToArray(document.getElementById('smProcQC').value) || undefined,
                    MissingDataHandling: document.getElementById('smProcMissing').value || undefined,
                    Debriefing: document.getElementById('smProcDebriefing').value || undefined,
                    AdditionalData: document.getElementById('smProcAdditionalData').value || undefined,
                    Notes: document.getElementById('smProcNotes').value || undefined,
                },
                MissingData: {
                    Description: document.getElementById('smMissingDesc').value || undefined,
                    MissingFiles: document.getElementById('smMissingFiles').value || undefined,
                    KnownIssues: document.getElementById('smKnownIssues').value || undefined,
                },
                References: document.getElementById('smReferences').value || undefined,
            };

            // Clean undefined values from nested objects
            function cleanUndefined(obj) {
                if (Array.isArray(obj)) return obj.length > 0 ? obj : undefined;
                if (obj && typeof obj === 'object') {
                    const cleaned = {};
                    for (const [k, v] of Object.entries(obj)) {
                        const cv = cleanUndefined(v);
                        if (cv !== undefined) cleaned[k] = cv;
                    }
                    return Object.keys(cleaned).length > 0 ? cleaned : undefined;
                }
                return obj;
            }

            const cleanPayload = {};
            for (const [k, v] of Object.entries(payload)) {
                const cv = cleanUndefined(v);
                cleanPayload[k] = cv || {};
            }

            const response = await fetch('/api/projects/study-metadata', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(cleanPayload)
            });

            const result = await response.json();
            if (result.success) {
                showToast('Study metadata saved', 'success');
                if (result.completeness) {
                    updateCompletenessUI(result.completeness);
                }
                // Save dataset_description
                await saveDatasetDescription();
                showToast('Dataset description saved', 'success');
                // Auto-generate README
                await generateReadme();
            } else {
                showToast('Failed to save: ' + result.error, 'danger');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'danger');
        } finally {
            setButtonLoading(btn, false, null, originalText);
        }
    });

    // ===== GENERATE METHODS SECTION =====
    function showMethodsCard() {
        const card = document.getElementById('methodsSectionCard');
        if (!card) return;
        card.style.display = currentProjectPath ? 'block' : 'none';
    }

    let _methodsMd = '';
    let _methodsHtml = '';
    let _methodsFilenameBase = 'methods_section_en';

    async function generateMethodsSection() {
        const btn = document.getElementById('generateMethodsBtn');
        const originalText = setButtonLoading(btn, true, 'Generating...');

        const resultDiv = document.getElementById('methodsResult');
        const errorDiv = document.getElementById('methodsError');
        resultDiv.style.display = 'none';
        errorDiv.style.display = 'none';

        const lang = document.getElementById('methodsLanguage').value;
        const detailLevel = document.getElementById('methodsDetailLevel').value;
        const continuous = document.getElementById('methodsContinuous').checked;

        try {
            const response = await fetch('/api/projects/generate-methods', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ language: lang, detail_level: detailLevel, continuous: continuous })
            });
            const data = await response.json();

            if (!data.success) {
                errorDiv.style.display = 'block';
                errorDiv.innerHTML = `
                    <div class="alert alert-warning py-2">
                        <i class="fas fa-info-circle me-2"></i>${data.error}
                    </div>`;
                return;
            }

            _methodsMd = data.md;
            _methodsHtml = data.html;
            _methodsFilenameBase = data.filename_base;

            // Show section badges
            const badgesDiv = document.getElementById('methodsSectionsBadges');
            badgesDiv.innerHTML = (data.sections_used || []).map(
                s => `<span class="badge bg-success bg-opacity-75 me-1">${s}</span>`
            ).join('');

            // Show HTML preview (extract body content from full HTML)
            const parser = new DOMParser();
            const doc = parser.parseFromString(data.html, 'text/html');
            document.getElementById('methodsPreview').innerHTML = doc.body.innerHTML;
            resultDiv.style.display = 'block';
        } catch (error) {
            errorDiv.style.display = 'block';
            errorDiv.innerHTML = `
                <div class="alert alert-danger py-2">
                    <i class="fas fa-exclamation-circle me-2"></i>${error.message}
                </div>`;
        } finally {
            setButtonLoading(btn, false, null, originalText);
        }
    }

    function downloadMethods(format) {
        const content = format === 'md' ? _methodsMd : _methodsHtml;
        const mimeType = format === 'md' ? 'text/markdown' : 'text/html';
        const ext = format === 'md' ? '.md' : '.html';
        const blob = new Blob([content], { type: mimeType + ';charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = _methodsFilenameBase + ext;
        document.body.appendChild(a);
        a.click();
        URL.revokeObjectURL(url);
        document.body.removeChild(a);
    }

    // Handle Export Form Submission
    document.getElementById('exportProjectForm')?.addEventListener('submit', async function(e) {
        e.preventDefault();

        if (!currentProjectPath) {
            alert('No project is currently loaded');
            return;
        }

        const btn = this.querySelector('button[type="submit"]');
        const originalText = setButtonLoading(btn, true, 'Preparing Export...');

        // Show progress UI
        const progressDiv = document.getElementById('exportProgress');
        const resultDiv = document.getElementById('exportResult');
        progressDiv.style.display = 'block';
        resultDiv.style.display = 'none';

        const data = {
            project_path: currentProjectPath,
            anonymize: document.getElementById('exportAnonymize').checked,
            mask_questions: document.getElementById('exportMaskQuestions').checked,
            id_length: parseInt(document.getElementById('exportIdLength').value),
            deterministic: document.getElementById('exportDeterministic').checked,
            include_derivatives: document.getElementById('exportDerivatives').checked,
            include_code: document.getElementById('exportCode').checked,
            include_analysis: document.getElementById('exportAnalysis').checked
        };

        try {
            const response = await fetch('/api/projects/export', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Export failed');
            }

            // Get the filename from response headers
            const contentDisposition = response.headers.get('Content-Disposition');
            let filename = 'project-export.zip';
            if (contentDisposition) {
                const matches = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/.exec(contentDisposition);
                if (matches && matches[1]) {
                    filename = matches[1].replace(/['"]/g, '');
                }
            }

            // Download the file
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            progressDiv.style.display = 'none';
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <h5><i class="fas fa-check-circle me-2"></i>Export Successful!</h5>
                    <p class="mb-2">Your project has been exported to: <strong>${filename}</strong></p>
                    ${data.anonymize ? `
                        <div class="alert alert-warning py-2 mt-2 mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Security Notice:</strong> The export includes a <code>participants_mapping.json</code> file 
                            that can be used to re-identify participants. Keep this file secure!
                        </div>
                    ` : ''}
                </div>
            `;
        } catch (error) {
            progressDiv.style.display = 'none';
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <h5><i class="fas fa-exclamation-circle me-2"></i>Export Failed</h5>
                    <p class="mb-0">${error.message}</p>
                </div>
            `;
        } finally {
            setButtonLoading(btn, false, null, originalText);
        }
    });

    // ===== README GENERATION =====
    async function generateReadme() {
        if (!currentProjectPath) {
            showToast('No project selected', 'warning');
            return;
        }

        if (!confirm('Generate README.md from study metadata?\n\nThis will overwrite any existing README.md file.')) {
            return;
        }

        try {
            const response = await fetch('/api/projects/generate-readme', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            });
            
            const data = await response.json();
            
            if (data.success) {
                showToast('README.md generated successfully! Check your project folder.', 'success');
            } else {
                showToast(`Failed to generate README: ${data.error}`, 'danger');
            }
        } catch (error) {
            showToast(`Error: ${error.message}`, 'danger');
        }
    }

    // ===== AND EXPORT =====
    document.getElementById('ancEnableExport')?.addEventListener('change', function() {
        const isEnabled = this.checked;
        document.getElementById('ancOptionsGroup').style.display = isEnabled ? 'block' : 'none';
        document.getElementById('ancOptionsGroup2').style.display = isEnabled ? 'block' : 'none';
        document.getElementById('ancMetadataSection').style.display = isEnabled ? 'block' : 'none';
        document.getElementById('ancExportButton').style.display = isEnabled ? 'inline-block' : 'none';
    });

    document.getElementById('ancExportButton')?.addEventListener('click', async function(e) {
        e.preventDefault();

        if (!currentProjectPath) {
            alert('No project is currently loaded');
            return;
        }

        const btn = this;
        const originalText = setButtonLoading(btn, true, 'Exporting for AND...');

        const progressDiv = document.getElementById('exportProgress');
        const resultDiv = document.getElementById('exportResult');
        const statusText = document.getElementById('exportStatusText');
        progressDiv.style.display = 'block';
        resultDiv.style.display = 'none';
        statusText.textContent = 'Preparing AND export...';

        // Gather ANC-specific metadata
        const metadata = {};
        const title = document.getElementById('ancDatasetTitle').value.trim();
        const email = document.getElementById('ancContactEmail').value.trim();
        const givenName = document.getElementById('ancAuthorGiven').value.trim();
        const familyName = document.getElementById('ancAuthorFamily').value.trim();
        const description = document.getElementById('ancDatasetDescription').value.trim();

        if (title) metadata.DATASET_NAME = title;
        if (email) metadata.CONTACT_EMAIL = email;
        if (givenName) metadata.AUTHOR_GIVEN_NAME = givenName;
        if (familyName) metadata.AUTHOR_FAMILY_NAME = familyName;
        if (description) metadata.DATASET_ABSTRACT = description;

        const data = {
            project_path: currentProjectPath,
            convert_to_git_lfs: document.getElementById('ancConvertGitLfs').checked,
            include_ci_examples: document.getElementById('ancIncludeCiExamples').checked,
            metadata: metadata
        };

        try {
            const response = await fetch('/api/projects/anc-export', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            progressDiv.style.display = 'none';
            resultDiv.style.display = 'block';

            if (result.success) {
                let infoHtml = '';
                if (data.convert_to_git_lfs) {
                    infoHtml += `
                        <div class="alert alert-info py-2 mt-2 mb-2">
                            <i class="fas fa-info-circle me-2"></i>
                            Git LFS configuration added. See <code>GIT_LFS_SETUP.md</code> in the export folder for setup instructions.
                        </div>
                    `;
                } else {
                    infoHtml += `
                        <div class="alert alert-info py-2 mt-2 mb-2">
                            <i class="fas fa-info-circle me-2"></i>
                            Export is DataLad-compatible. See <code>DATALAD_NOTE.md</code> for more information.
                        </div>
                    `;
                }

                if (data.include_ci_examples) {
                    infoHtml += `
                        <div class="alert alert-info py-2 mt-2 mb-2">
                            <i class="fas fa-info-circle me-2"></i>
                            CI/CD example files included. See <code>CI_SETUP.md</code> for instructions.
                        </div>
                    `;
                }

                const filesList = result.generated_files ? 
                    Object.entries(result.generated_files).map(([key, path]) => 
                        `<li><code>${path.split('/').pop()}</code></li>`
                    ).join('') : '';

                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h5><i class="fas fa-check-circle me-2"></i>AND Export Successful!</h5>
                        <p class="mb-2">Dataset exported to: <strong><code>${result.output_path}</code></strong></p>
                        ${filesList ? `
                            <div class="mt-2">
                                <strong>Generated files:</strong>
                                <ul class="mb-0 mt-1">${filesList}</ul>
                            </div>
                        ` : ''}
                        ${infoHtml}
                        <div class="mt-3">
                            <strong>Next steps:</strong>
                            <ol class="mb-0 mt-1">
                                <li>Review and edit <code>README.md</code> and <code>CITATION.cff</code> in the export folder</li>
                                <li>Run BIDS validator to verify compliance</li>
                                <li>Submit to AND</li>
                            </ol>
                        </div>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h5><i class="fas fa-exclamation-circle me-2"></i>AND Export Failed</h5>
                        <p class="mb-0">${result.error || 'Unknown error occurred'}</p>
                    </div>
                `;
            }
        } catch (error) {
            progressDiv.style.display = 'none';
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <h5><i class="fas fa-exclamation-circle me-2"></i>AND Export Failed</h5>
                    <p class="mb-0">${error.message}</p>
                </div>
            `;
        } finally {
            setButtonLoading(btn, false, null, originalText);
        }
    });
</script>
{% endblock %}
