<!-- Participants Panel -->
<div class="tab-pane fade show active" id="participants-panel" role="tabpanel" aria-labelledby="participants-tab">
    <div class="card border-0">
        <div class="card-body">
            <div class="d-flex align-items-center mb-3">
                <div>
                    <h5 class="mb-1">Participant Data Management</h5>
                    <p class="text-muted mb-0">Extract and convert participant demographics from various data sources</p>
                </div>
            </div>

            <!-- Structure Warning -->
            <div id="participantsStructureWarning" class="alert alert-danger d-none mb-3">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Missing Structure:</strong> <span id="participantsStructureMessage">The selected folder is missing required items.</span>
            </div>

            <!-- File Input -->
            <div class="mb-4">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="participantsDataFile" class="form-label">Participant Data File</label>
                        <input class="form-control" type="file" id="participantsDataFile" accept=".xlsx,.csv,.tsv,.lsa">
                        <small class="form-text text-muted">
                            Supports: Excel (.xlsx), CSV (.csv), TSV (.tsv), LimeSurvey (.lsa)
                        </small>
                    </div>
                    <div class="col-md-3" id="participantsSheetGroup">
                        <label for="participantsSheet" class="form-label">Sheet Name/Index (Excel only)</label>
                        <input type="text" class="form-control" id="participantsSheet" placeholder="0">
                        <small class="form-text text-muted">Leave empty for first sheet</small>
                    </div>
                    <div class="col-md-3 d-none" id="participantsIdColumnGroup">
                        <label for="participantsIdColumn" class="form-label">ID Column (optional)</label>
                        <input type="text" class="form-control" id="participantsIdColumn" placeholder="participant_id">
                        <small class="form-text text-muted" id="participantsIdColumnHint">Shown only when ID could not be auto-detected</small>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="row g-3 mt-4">
                <div class="col-md-4">
                    <button class="btn btn-info text-white w-100" type="button" id="participantsPreviewBtn" disabled>
                        <i class="fas fa-eye me-2"></i><strong>1. Preview Data</strong>
                    </button>
                    <small class="form-text text-muted">Review & annotate before converting</small>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-outline-success text-dark w-100" type="button" id="createParticipantMappingBtn">
                        <i class="fas fa-list-check me-2"></i>Add Additional Variables (Optional)
                    </button>
                    <small class="form-text text-muted">Non-core columns are excluded by default and must be selected here</small>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-outline-secondary text-dark w-100" type="button" id="participantsConvertBtn" disabled>
                        <i class="fas fa-play me-2"></i><strong>2. Extract & Convert</strong>
                    </button>
                    <small class="form-text text-muted" id="convertBtnHint">Preview first to enable</small>
                </div>
            </div>

            <!-- Existing Files Warning - shown right after convert button -->
            <div id="participantsExistingFilesWarning" class="alert alert-warning d-none mt-3">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Existing Files Detected:</strong>
                <span id="participantsExistingFilesMessage"></span>
                <div class="mt-2">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="participantsForceOverwrite">
                        <label class="form-check-label" for="participantsForceOverwrite">
                            I understand that existing <code>participants.tsv</code> and <code>participants.json</code> will be overwritten
                        </label>
                    </div>
                </div>
            </div>

            <!-- Messages -->
            <div id="participantsError" class="alert alert-danger d-none mt-3"></div>
            <div id="participantsInfo" class="alert alert-info d-none mt-3"></div>
            <div id="participantsSuccess" class="alert alert-success d-none mt-3"></div>

            <!-- Preview Results -->
            <div id="participantsPreviewResults" class="d-none mt-4">
                <h6 class="mb-3">
                    <i class="fas fa-table me-2 text-info"></i>Data Preview
                    <span class="badge bg-info ms-2" id="participantsPreviewCount">0 participants</span>
                </h6>

                <div id="participantsPreviewAvailabilityInfo" class="alert alert-light border d-none py-2 mb-3">
                    <i class="fas fa-circle-info me-2 text-info"></i>
                    <span id="participantsPreviewAvailabilityText"></span>
                </div>
                
                <!-- TSV Preview -->
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-sm table-hover" id="participantsPreviewTable">
                        <thead class="table-light sticky-top">
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
                
                <!-- NeuroBagel Schema Preview (collapsed by default) -->
                <div id="neurobagelSchemaPreview" class="mt-4 d-none">
                    <h6 class="mb-3">
                        <i class="fas fa-code me-2 text-secondary"></i>
                        Full participants.json Preview
                        <button class="btn btn-sm btn-outline-secondary ms-2" type="button" 
                                data-bs-toggle="collapse" data-bs-target="#schemaDetails">
                            <i class="fas fa-code me-1"></i>View JSON
                        </button>
                    </h6>
                    
                    <!-- Collapsible JSON view -->
                    <div class="collapse" id="schemaDetails">
                        <pre class="bg-light p-3 rounded border" style="max-height: 400px; overflow: auto;"><code id="schemaJsonCode"></code></pre>
                    </div>
                </div>
            </div>

            <!-- Conversion Progress -->
            <div id="participantsConversionProgress" class="d-none mt-4">
                <h6><i class="fas fa-spinner fa-spin me-2 text-info"></i>Converting Participant Data...</h6>
                <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" 
                         role="progressbar" 
                         style="width: 100%"
                         id="participantsProgressBar">
                    </div>
                </div>
                <div id="participantsConversionLog" class="mt-3 p-3 bg-light border rounded" style="max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.85rem;">
                </div>
            </div>

            <!-- Participants Annotation Section -->
            <div class="mt-5 pt-4 border-top">
                <h5 class="mb-3">
                    <i class="fas fa-brain text-success me-2"></i>Participant Annotation & Harmonization
                </h5>
                <p class="text-muted">
                    Add descriptions, semantic annotations, and controlled vocabulary mappings to your participants data using NeuroBagel standards.
                </p>
                
                <!-- Quick Actions -->
                <div class="mb-3">
                    <button class="btn btn-outline-success" id="openNeurobagelBtn">
                        <i class="fas fa-brain me-1"></i>Annotate Participants
                    </button>
                </div>
                
                <!-- NeuroBagel Widget (hidden by default) -->
                <div id="neurobagelSection" style="display: none;">
                    <div class="card border-success mb-3">
                        <div class="card-header bg-success bg-opacity-10 d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="fas fa-brain text-success me-2"></i>
                                Participant Annotation
                            </h6>
                            <button class="btn btn-sm btn-outline-secondary" id="closeNeurobagelBtn">
                                <i class="fas fa-arrow-left me-1"></i>Back
                            </button>
                        </div>
                        <div class="card-body">
                            <!-- Embedded NeuroBagel widget placeholder -->
                            <div id="neurobagelWidgetContainer"></div>
                            
                            <div class="mt-3 d-flex gap-2">
                                <button class="btn btn-success" id="saveNeurobagelBtn">
                                    <i class="fas fa-save me-1"></i>Save to participants.json
                                </button>
                                <button class="btn btn-outline-secondary" id="cancelNeurobagelBtn">
                                    <i class="fas fa-times me-1"></i>Cancel
                                </button>
                            </div>
                            
                            <hr class="my-3">
                            
                            <!-- Full NeuroBagel Tool Link (for controlled vocabularies) -->
                            <div class="alert alert-info mb-0 beginner-help-block">
                                <i class="fas fa-lightbulb me-2"></i>
                                <strong>Need SNOMED-CT, NIDM or other controlled vocabularies?</strong><br>
                                <small class="text-muted">Use the official NeuroBagel tool for full semantic harmonization with ontology lookups:</small>
                                <div class="mt-2">
                                    <a href="https://annotate.neurobagel.org/" target="_blank" class="btn btn-sm btn-info">
                                        <i class="fas fa-external-link-alt me-1"></i>Open Full NeuroBagel Annotation Tool
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-light border mb-0 beginner-help-block" id="participantsHelp">
                    <i class="fas fa-info-circle text-success me-2"></i>
                    <strong>How participant annotation works:</strong>
                    <ol class="mb-0 mt-2 small">
                        <li>First, extract participant data using the form above (creates <code>participants.tsv</code>)</li>
                        <li>Click <strong>Annotate Participants</strong> to add semantic descriptions and controlled vocabulary terms</li>
                        <li>The annotation saves to <code>participants.json</code> following BIDS and NeuroBagel standards</li>
                        <li>For advanced ontology lookups (SNOMED-CT, NIDM), use the full external tool linked above</li>
                    </ol>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
// Track whether preview has been completed
let participantsPreviewCompleted = false;

function isExcelParticipantsFile(file) {
    if (!file || !file.name) return false;
    return file.name.toLowerCase().endsWith('.xlsx') || file.name.toLowerCase().endsWith('.xls');
}

function updateParticipantsInputVisibility() {
    const fileInput = document.getElementById('participantsDataFile');
    const sheetGroup = document.getElementById('participantsSheetGroup');
    const idGroup = document.getElementById('participantsIdColumnGroup');

    const file = fileInput && fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;
    const isExcel = isExcelParticipantsFile(file);

    if (sheetGroup) {
        sheetGroup.classList.toggle('d-none', !isExcel);
    }

    if (!file && idGroup) {
        idGroup.classList.add('d-none');
    }
}

async function autoDetectParticipantsIdColumn() {
    const fileInput = document.getElementById('participantsDataFile');
    const idGroup = document.getElementById('participantsIdColumnGroup');
    const idInput = document.getElementById('participantsIdColumn');
    const idHint = document.getElementById('participantsIdColumnHint');
    const sheetInput = document.getElementById('participantsSheet');

    const file = fileInput && fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;
    if (!file) {
        if (idGroup) idGroup.classList.add('d-none');
        return;
    }

    try {
        const formData = new FormData();
        formData.append('file', file);
        if (isExcelParticipantsFile(file) && sheetInput && sheetInput.value) {
            formData.append('sheet', sheetInput.value);
        }

        const response = await fetch('/api/participants-detect-id', {
            method: 'POST',
            body: formData
        });
        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error || 'ID detection failed');
        }

        if (data.id_found && data.id_column) {
            if (idInput) idInput.value = data.id_column;
            if (idGroup) idGroup.classList.add('d-none');
        } else {
            if (idInput && !idInput.value) idInput.placeholder = 'participant_id';
            if (idHint) idHint.textContent = 'ID column could not be auto-detected. Please select it manually.';
            if (idGroup) idGroup.classList.remove('d-none');
        }
    } catch (error) {
        console.warn('Participants ID auto-detection failed:', error);
        if (idHint) idHint.textContent = 'Automatic detection unavailable. Please select the ID column manually.';
        if (idGroup) idGroup.classList.remove('d-none');
    }
}

// Enable/disable buttons based on file selection and preview state
function updateParticipantsButtonState() {
    const fileInput = document.getElementById('participantsDataFile');
    const hasFile = fileInput && fileInput.files.length > 0;
    
    const previewBtn = document.getElementById('participantsPreviewBtn');
    const convertBtn = document.getElementById('participantsConvertBtn');
    
    if (hasFile) {
        if (previewBtn) previewBtn.disabled = false;
        // Convert is only enabled if preview has been completed
        if (convertBtn) convertBtn.disabled = !participantsPreviewCompleted;
        const warningDiv = document.getElementById('participantsExistingFilesWarning');
        if (warningDiv) warningDiv.classList.add('d-none');
        updateParticipantsInputVisibility();
        autoDetectParticipantsIdColumn();
    } else {
        if (previewBtn) previewBtn.disabled = true;
        if (convertBtn) convertBtn.disabled = true;
        participantsPreviewCompleted = false;
        updateParticipantsInputVisibility();
    }
}

// Attach event listener
const fileInput = document.getElementById('participantsDataFile');
if (fileInput) {
    fileInput.addEventListener('change', updateParticipantsButtonState);
}

const sheetInput = document.getElementById('participantsSheet');
if (sheetInput) {
    sheetInput.addEventListener('change', function() {
        const fileEl = document.getElementById('participantsDataFile');
        const file = fileEl && fileEl.files && fileEl.files[0] ? fileEl.files[0] : null;
        if (isExcelParticipantsFile(file)) {
            autoDetectParticipantsIdColumn();
        }
    });
}

// Run immediately
updateParticipantsInputVisibility();
updateParticipantsButtonState();

// Check for existing participant files
async function checkExistingParticipantFiles() {
    try {
        const response = await fetch('/api/participants-check');
        const data = await response.json();
        
        const warningDiv = document.getElementById('participantsExistingFilesWarning');
        const messageSpan = document.getElementById('participantsExistingFilesMessage');
        
        if (data.exists) {
            const files = Object.values(data.files).filter(f => f !== null);
            messageSpan.textContent = `Found existing files: ${files.map(f => f.split('/').pop()).join(', ')}`;
            warningDiv.classList.remove('d-none');
        } else {
            warningDiv.classList.add('d-none');
        }
        return data;
    } catch (error) {
        console.error('Error checking existing files:', error);
        return { exists: false, files: {} };
    }
}

// Preview button handler
document.getElementById('participantsPreviewBtn')?.addEventListener('click', async function() {
    const previewResults = document.getElementById('participantsPreviewResults');
    const errorDiv = document.getElementById('participantsError');
    
    errorDiv.classList.add('d-none');
    previewResults.classList.add('d-none');
    
    try {
        const fileInput = document.getElementById('participantsDataFile');
        if (!fileInput.files[0]) {
            throw new Error('Please select a file');
        }
        
        const formData = new FormData();
        formData.append('mode', 'file');
        formData.append('file', fileInput.files[0]);
        
        const sheet = document.getElementById('participantsSheet').value;
        const idColumn = document.getElementById('participantsIdColumn').value;
        if (sheet) formData.append('sheet', sheet);
        if (idColumn) formData.append('id_column', idColumn);
        
        const response = await fetch('/api/participants-preview', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            if (response.status === 409 && data.error === 'id_column_required') {
                const idGroup = document.getElementById('participantsIdColumnGroup');
                const idHint = document.getElementById('participantsIdColumnHint');
                if (idHint) idHint.textContent = 'ID column could not be auto-detected. Please select it manually.';
                if (idGroup) idGroup.classList.remove('d-none');
            }
            throw new Error(data.error || 'Preview failed');
        }

        if (data.id_column) {
            const idInput = document.getElementById('participantsIdColumn');
            const idGroup = document.getElementById('participantsIdColumnGroup');
            if (idInput) idInput.value = data.id_column;
            if (idGroup) idGroup.classList.add('d-none');
        }

        // Make participants preview available to shared mapping modal logic
        window.lastParticipantsPreviewData = data;
        // Keep NeuroBagel editor in sync with the latest preview schema/types
        if (data.neurobagel_schema) {
            window.existingParticipantsData = data.neurobagel_schema;
        }
        
        // Display preview
        const countBadge = document.getElementById('participantsPreviewCount');
        countBadge.textContent = `${data.participant_count} participants`;

        const availabilityInfo = document.getElementById('participantsPreviewAvailabilityInfo');
        const availabilityText = document.getElementById('participantsPreviewAvailabilityText');
        const totalSourceColumns = Number(data.total_source_columns || 0);
        const extractedColumns = Number(data.extracted_columns || 0);
        const hiddenColumns = Math.max(0, totalSourceColumns - extractedColumns);

        if (hiddenColumns > 0 && availabilityInfo && availabilityText) {
            availabilityText.textContent = `${hiddenColumns} additional variable(s) are available in the source file but not shown in this preview. Use "Add Additional Variables" to select and include them.`;
            availabilityInfo.classList.remove('d-none');
        } else if (availabilityInfo) {
            availabilityInfo.classList.add('d-none');
        }
        
        const infoDiv = document.getElementById('participantsInfo');
        infoDiv.classList.add('d-none');
        
        const table = document.getElementById('participantsPreviewTable');
        const thead = table.querySelector('thead');
        const tbody = table.querySelector('tbody');
        
        thead.innerHTML = '';
        tbody.innerHTML = '';
        
        // Show table with columns
        const headerRow = document.createElement('tr');
        data.columns.forEach(col => {
            const th = document.createElement('th');
            th.textContent = col;

            const nbField = data.neurobagel_schema?.[col];
            const variableType = nbField?.Annotations?.VariableType;
            const hasNeurobagelMapping = !!nbField?.Annotations?.IsAbout;

            if (col === data.id_column) {
                th.innerHTML += ' <span class="badge bg-primary">ID</span>';
            }
            if (hasNeurobagelMapping) {
                th.innerHTML += ' <span class="badge bg-info">NB</span>';
            }
            if (variableType) {
                const typeLabel = variableType.toLowerCase() === 'continuous'
                    ? 'CONT'
                    : (variableType.toLowerCase() === 'categorical' ? 'CAT' : variableType.toUpperCase());
                const typeClass = variableType.toLowerCase() === 'continuous'
                    ? 'bg-success'
                    : (variableType.toLowerCase() === 'categorical' ? 'bg-warning text-dark' : 'bg-secondary');
                th.innerHTML += ` <span class="badge ${typeClass}">${typeLabel}</span>`;
            }
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        
        data.preview_rows.forEach(row => {
            const tr = document.createElement('tr');
            data.columns.forEach(col => {
                const td = document.createElement('td');
                td.textContent = row[col] || '';
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });

        // Make preview columns immediately available to the NeuroBagel quick editor
        // so users can map uploaded TSV fields before conversion.
        const previewColumnValues = {};
        data.columns.forEach(col => {
            const values = [];
            data.preview_rows.forEach(row => {
                const raw = row[col];
                if (raw !== null && raw !== undefined && String(raw).trim() !== '') {
                    values.push(String(raw));
                }
            });
            previewColumnValues[col] = [...new Set(values)].slice(0, 50);
        });
        window.participantsTsvData = previewColumnValues;
        console.log('âœ… Set window.participantsTsvData from preview:', Object.keys(window.participantsTsvData));
        
        previewResults.classList.remove('d-none');
        
        // Display NeuroBagel schema if available
        if (data.neurobagel_schema) {
            displayNeurobagelSchema(data.neurobagel_schema);
        }
        
    } catch (error) {
        errorDiv.textContent = error.message;
        errorDiv.classList.remove('d-none');

        const availabilityInfo = document.getElementById('participantsPreviewAvailabilityInfo');
        if (availabilityInfo) availabilityInfo.classList.add('d-none');
    }
});

function displayNeurobagelSchema(schema) {
    const schemaPreview = document.getElementById('neurobagelSchemaPreview');
    const schemaJsonCode = document.getElementById('schemaJsonCode');
    
    // Store schema globally for use during conversion
    window.neurobagelSchema = schema;
    
    // Show JSON preview
    schemaJsonCode.textContent = JSON.stringify(schema, null, 2);
    schemaPreview.classList.remove('d-none');
    
    // Mark preview as complete and enable Convert button
    participantsPreviewCompleted = true;
    const convertBtn = document.getElementById('participantsConvertBtn');
    const convertHint = document.getElementById('convertBtnHint');
    if (convertBtn) {
        convertBtn.disabled = false;
        convertBtn.classList.remove('btn-outline-secondary');
        convertBtn.classList.add('btn-success');
        convertHint.textContent = 'Ready to create files in project';
    }
}

// Convert button handler
document.getElementById('participantsConvertBtn')?.addEventListener('click', async function() {
    const errorDiv = document.getElementById('participantsError');
    const successDiv = document.getElementById('participantsSuccess');
    const progressDiv = document.getElementById('participantsConversionProgress');
    const logDiv = document.getElementById('participantsConversionLog');
    const warningDiv = document.getElementById('participantsExistingFilesWarning');
    
    errorDiv.classList.add('d-none');
    successDiv.classList.add('d-none');
    
    // Check existing files only when starting real conversion
    const existingCheck = await checkExistingParticipantFiles();
    if (existingCheck && existingCheck.exists) {
        const checkbox = document.getElementById('participantsForceOverwrite');
        if (!checkbox.checked) {
            errorDiv.textContent = 'Existing participants files detected. Confirm overwrite to continue conversion.';
            errorDiv.classList.remove('d-none');
            return;
        }
    }
    
    progressDiv.classList.remove('d-none');
    logDiv.innerHTML = '';
    
    try {
        const fileInput = document.getElementById('participantsDataFile');
        if (!fileInput.files[0]) {
            throw new Error('Please select a file');
        }
        
        const formData = new FormData();
        formData.append('mode', 'file');
        formData.append('file', fileInput.files[0]);
        formData.append('force_overwrite', document.getElementById('participantsForceOverwrite')?.checked || false);
        
        const sheet = document.getElementById('participantsSheet').value;
        const idColumn = document.getElementById('participantsIdColumn').value;
        if (sheet) formData.append('sheet', sheet);
        if (idColumn) formData.append('id_column', idColumn);
        
        // Include the modified neurobagel_schema if available
        if (window.neurobagelSchema) {
            formData.append('neurobagel_schema', JSON.stringify(window.neurobagelSchema));
        }
        
        const response = await fetch('/api/participants-convert', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        // Display log
        if (data.log) {
            data.log.forEach(entry => {
                const line = document.createElement('div');
                line.textContent = `[${entry.level}] ${entry.message}`;
                line.className = entry.level === 'ERROR' ? 'text-danger' : (entry.level === 'WARNING' ? 'text-warning' : 'text-success');
                logDiv.appendChild(line);
            });
        }
        
        if (!response.ok) {
            throw new Error(data.error || 'Conversion failed');
        }
        
        // Show success
        successDiv.innerHTML = `
            <i class="fas fa-check-circle me-2"></i>
            <strong>Success!</strong> Created ${data.files_created.length} file(s):
            <ul class="mb-0 mt-2">
                ${data.files_created.map(f => `<li><code>${f.split('/').pop()}</code></li>`).join('')}
            </ul>
            <div class="mt-2 small text-muted">Refreshing previewâ€¦</div>
        `;
        successDiv.classList.remove('d-none');

        // Conversion created/updated participants files. Clear stale preview schema
        // so Annotate Participants loads from the saved project participants.json.
        window.lastParticipantsPreviewData = null;

        // Refresh local participants.tsv columns cache used by the annotation widget.
        const projectPath = "{{ current_project.path or '' }}";
        if (projectPath) {
            try {
                const tsvResponse = await fetch(`/api/neurobagel/local-participants?project_path=${encodeURIComponent(projectPath)}`);
                const tsvData = await tsvResponse.json();
                if (tsvData.columns) {
                    window.participantsTsvData = tsvData.columns;
                }
            } catch (error) {
                console.warn('Could not refresh participants TSV columns after conversion:', error);
            }
        }
        
        // Hide warning
        warningDiv.classList.add('d-none');

        // Auto-refresh preview so users immediately see updated participant columns.
        const previewBtn = document.getElementById('participantsPreviewBtn');
        if (previewBtn && fileInput && fileInput.files && fileInput.files[0]) {
            setTimeout(() => {
                try {
                    previewBtn.click();
                } catch (e) {
                    console.warn('Could not auto-refresh participants preview:', e);
                }
            }, 100);
        }
        
    } catch (error) {
        errorDiv.textContent = error.message;
        errorDiv.classList.remove('d-none');
    } finally {
        progressDiv.classList.add('d-none');
    }
});

// ===== NEUROBAGEL ANNOTATION HANDLERS =====

// Function to open participants.json editor
function openParticipantsEditor() {
    const currentProjectPath = "{{ current_project.path or '' }}";
    if (!currentProjectPath) {
        const errorDiv = document.getElementById('participantsError');
        errorDiv.textContent = 'Please select a project first from the top of the page';
        errorDiv.classList.remove('d-none');
        return;
    }
    
    // Navigate to JSON editor with autoload flag and file type
    window.location.href = `{{ url_for('json_editor.editor_index') }}?autoload=participants&from=converter`;
}

document.getElementById('openNeurobagelBtn')?.addEventListener('click', function() {
    document.getElementById('neurobagelSection').style.display = 'block';
    document.getElementById('participantsHelp').style.display = 'none';
    loadNeurobagelWidget();
});

document.getElementById('closeNeurobagelBtn')?.addEventListener('click', function() {
    document.getElementById('neurobagelSection').style.display = 'none';
    document.getElementById('participantsHelp').style.display = 'block';
});

document.getElementById('cancelNeurobagelBtn')?.addEventListener('click', function() {
    document.getElementById('neurobagelSection').style.display = 'none';
    document.getElementById('participantsHelp').style.display = 'block';
});

document.getElementById('saveNeurobagelBtn')?.addEventListener('click', async function() {
    // Get the current state of the NeuroBagel widget if it has state
    const widgetState = window.neurobagelWidgetState || {};
    const allColumns = widgetState.allColumns || {};
    
    // Build the annotated participants.json (BIDS + NeuroBagel Enrichment)
    const annotatedData = {};
    
    // Get TSV columns to filter out suggestions
    const tsvColumns = window.participantsTsvData ? Object.keys(window.participantsTsvData) : [];
    console.log('ðŸ’¾ Saving only columns present in TSV:', tsvColumns);
    
    for (const [colName, colData] of Object.entries(allColumns)) {
        // Only save columns that exist in the actual TSV file
        const colNameLower = colName.toLowerCase().replace(/_/g, '');
        const isInTsv = tsvColumns.some(c => {
            const cLower = c.toLowerCase().replace(/_/g, '');
            return cLower === colNameLower || cLower === colName.toLowerCase();
        });
        
        if (!isInTsv) {
            console.log(`â­ï¸ Skipping "${colName}" - not in TSV`);
            continue;
        }
        
        annotatedData[colName] = {
            Description: colData.description || colData.Description || ""
        };
        
        // BIDS Standard: Unit
        if (colData.unit) {
            annotatedData[colName].Unit = colData.unit;
        }
        
        // BIDS Standard: Levels
        if (colData.levels && Object.keys(colData.levels).length > 0) {
            annotatedData[colName].Levels = {};
            for (const [levelKey, levelData] of Object.entries(colData.levels)) {
                annotatedData[colName].Levels[levelKey] = levelData.label || levelKey;
            }
        }
        
        // NEUROBAGEL ENRICHMENT: Annotations Block
        if (colData.standardized_variable || colData.data_type) {
            annotatedData[colName].Annotations = {
                "IsAbout": {
                    "TermURL": colData.term_url || (colData.standardized_variable ? `nb:${colData.standardized_variable}` : null),
                    "Label": colData.label || colData.standardized_variable || null
                },
                "VariableType": colData.data_type ? colData.data_type.charAt(0).toUpperCase() + colData.data_type.slice(1) : "Unknown"
            };
            
            // Add units to annotations if continuous
            if (colData.data_type === 'continuous' && colData.unit) {
                annotatedData[colName].Annotations.Format = {
                    "TermURL": "nb:FromFloat",
                    "Label": "Float"
                };
            }
            
            // Add levels to annotations if categorical
            if (colData.data_type === 'categorical' && colData.levels) {
                annotatedData[colName].Annotations.Levels = {};
                for (const [levelKey, levelData] of Object.entries(colData.levels)) {
                    if (levelData.uri) {
                        annotatedData[colName].Annotations.Levels[levelKey] = {
                            "TermURL": levelData.uri,
                            "Label": levelData.label || levelKey
                        };
                    }
                }
            }
            
            // Remove null/undefined from annotations
            if (!annotatedData[colName].Annotations.IsAbout.TermURL) delete annotatedData[colName].Annotations.IsAbout;
        }
    }
    
    // Save to the project
    try {
        const response = await fetch('/api/projects/participants', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ schema: annotatedData })
        });
        
        const result = await response.json();
        if (result.success) {
            const successDiv = document.getElementById('participantsSuccess');
            successDiv.innerHTML = '<i class="fas fa-check-circle me-2"></i><strong>Success!</strong> Participants schema saved to participants.json';
            successDiv.classList.remove('d-none');
            
            // Keep the editor open so user can continue annotating
            // document.getElementById('neurobagelSection').style.display = 'none';
            // document.getElementById('participantsHelp').style.display = 'block';
        } else {
            alert('Failed to save: ' + result.error);
        }
    } catch (error) {
        alert('Error saving participants schema: ' + error.message);
    }
});

async function loadNeurobagelWidget() {
    const container = document.getElementById('neurobagelWidgetContainer');
    if (!container) return;

    const hasPreviewSchema = !!(window.lastParticipantsPreviewData && window.lastParticipantsPreviewData.neurobagel_schema);

    // Prefer currently saved project participants.json (important after conversion).
    let loadedProjectSchema = false;
    try {
        const schemaResponse = await fetch('/api/projects/participants');
        const schemaData = await schemaResponse.json();
        if (schemaData.success && schemaData.exists && schemaData.schema) {
            window.existingParticipantsData = schemaData.schema;
            loadedProjectSchema = true;
        }
    } catch (error) {
        console.warn('Could not load existing participants schema:', error);
    }

    // Fallback to current preview schema only if no saved project schema exists yet.
    if (!loadedProjectSchema && hasPreviewSchema) {
        window.existingParticipantsData = window.lastParticipantsPreviewData.neurobagel_schema;
    }

    // Always refresh local participants.tsv columns.
    const projectPath = "{{ current_project.path or '' }}";
    console.log('ðŸ”„ Fetching participants TSV columns...');
    try {
        const tsvResponse = await fetch(`/api/neurobagel/local-participants?project_path=${encodeURIComponent(projectPath)}`);
        console.log('ðŸ“¡ TSV columns response status:', tsvResponse.status);
        const tsvData = await tsvResponse.json();
        console.log('ðŸ“Š TSV columns data:', tsvData);
        if (tsvData.columns) {
            window.participantsTsvData = tsvData.columns;
            console.log('âœ… Set window.participantsTsvData:', Object.keys(window.participantsTsvData));
        } else if (tsvData.error) {
            console.error('âŒ API returned error:', tsvData.error);
        }
    } catch (error) {
        console.error('âŒ Could not load participants TSV columns:', error);
    }
    
    // Check if widget is already loaded
    if (container.querySelector('#neurobagelAnnotationWidget')) {
        // Just re-render to update with latest TSV data if needed
        if (window.renderNeurobagelWidget) {
            await window.renderNeurobagelWidget();
        }
        return;
    }
    
    try {
        // Load the neurobagel widget HTML
        const response = await fetch("{{ url_for('static', filename='neurobagel_widget.html') }}");
        if (response.ok) {
            const html = await response.text();
            
            // Parse HTML to separate markup from scripts
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // Find and remove scripts
            const scripts = doc.querySelectorAll('script');
            const scriptTexts = [];
            scripts.forEach(script => {
                scriptTexts.push(script.textContent);
                script.remove();
            });
            
            // Insert the HTML without scripts
            container.innerHTML = doc.body.innerHTML;
            
            // Execute scripts in order
            scriptTexts.forEach(scriptText => {
                try {
                    new Function(scriptText)();
                } catch (err) {
                    console.error('Error executing widget script:', err);
                }
            });
            
            // Initialize widget after a short delay
            await new Promise(resolve => setTimeout(resolve, 100));
            if (window.renderNeurobagelWidget) {
                await window.renderNeurobagelWidget();
            }
        } else {
            container.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Use the <a href="https://annotate.neurobagel.org/" target="_blank">NeuroBagel Annotation Tool</a> 
                    to annotate your participants.json file, then import it back here.
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading NeuroBagel widget:', error);
        container.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Could not load embedded widget (${error.message}). Use the external 
                <a href="https://annotate.neurobagel.org/" target="_blank">NeuroBagel Annotation Tool</a>.
            </div>
        `;
    }
}

</script>
