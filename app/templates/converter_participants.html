<!-- Participants Panel -->
<div class="tab-pane fade show active" id="participants-panel" role="tabpanel" aria-labelledby="participants-tab">
    <div class="card border-0">
        <div class="card-body">
            <div class="d-flex align-items-center mb-3">
                <div>
                    <h5 class="mb-1">Participant Data Management</h5>
                    <p class="text-muted mb-0">Extract and convert participant demographics from various data sources</p>
                </div>
            </div>

            <!-- Structure Warning -->
            <div id="participantsStructureWarning" class="alert alert-danger d-none mb-3">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Missing Structure:</strong> <span id="participantsStructureMessage">The selected folder is missing required items.</span>
            </div>

            <!-- File Input -->
            <div class="mb-4">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="participantsDataFile" class="form-label">Participant Data File</label>
                        <input class="form-control" type="file" id="participantsDataFile" accept=".xlsx,.csv,.tsv,.lsa">
                        <small class="form-text text-muted">
                            Supports: Excel (.xlsx), CSV (.csv), TSV (.tsv), LimeSurvey (.lsa)
                        </small>
                    </div>
                    <div class="col-md-3">
                        <label for="participantsSheet" class="form-label">Sheet Name/Index (Excel only)</label>
                        <input type="text" class="form-control" id="participantsSheet" placeholder="0">
                        <small class="form-text text-muted">Leave empty for first sheet</small>
                    </div>
                    <div class="col-md-3">
                        <label for="participantsIdColumn" class="form-label">ID Column (optional)</label>
                        <input type="text" class="form-control" id="participantsIdColumn" placeholder="participant_id">
                        <small class="form-text text-muted">Auto-detected if empty</small>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="row g-3 mt-4">
                <div class="col-md-4">
                    <button class="btn btn-outline-success text-dark w-100" type="button" id="createParticipantMappingBtn">
                        <i class="fas fa-list-check me-2"></i>Create Participant Mapping
                    </button>
                    <small class="form-text text-muted">Define column mappings to participants.json schema</small>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-info text-white w-100" type="button" id="participantsPreviewBtn" disabled>
                        <i class="fas fa-eye me-2"></i><strong>1. Preview Data</strong>
                    </button>
                    <small class="form-text text-muted">Review & annotate before converting</small>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-outline-secondary text-dark w-100" type="button" id="participantsConvertBtn" disabled>
                        <i class="fas fa-play me-2"></i><strong>2. Extract & Convert</strong>
                    </button>
                    <small class="form-text text-muted" id="convertBtnHint">Preview first to enable</small>
                </div>
            </div>

            <!-- Messages -->
            <div id="participantsError" class="alert alert-danger d-none mt-3"></div>
            <div id="participantsInfo" class="alert alert-info d-none mt-3"></div>
            <div id="participantsSuccess" class="alert alert-success d-none mt-3"></div>

            <!-- Existing Files Warning -->
            <div id="participantsExistingFilesWarning" class="alert alert-warning d-none mt-3">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Existing Files Detected:</strong>
                <span id="participantsExistingFilesMessage"></span>
                <div class="mt-2">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="participantsForceOverwrite">
                        <label class="form-check-label" for="participantsForceOverwrite">
                            I understand that existing <code>participants.tsv</code> and <code>participants.json</code> will be overwritten
                        </label>
                    </div>
                </div>
            </div>

            <!-- Preview Results -->
            <div id="participantsPreviewResults" class="d-none mt-4">
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Preview mode:</strong> Review the data below and edit any annotations if needed. 
                    Once satisfied, click <strong>"2. Extract & Convert"</strong> to create files in your project.
                </div>
                
                <h6 class="mb-3">
                    <i class="fas fa-table me-2 text-info"></i>Data Preview
                    <span class="badge bg-info ms-2" id="participantsPreviewCount">0 participants</span>
                </h6>
                
                <!-- TSV Preview -->
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-sm table-hover" id="participantsPreviewTable">
                        <thead class="table-light sticky-top">
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
                
                <!-- NeuroBagel Annotation Preview -->
                <div id="neurobagelAnnotationPreview" class="mt-4 d-none">
                    <h6 class="mb-3">
                        <i class="fas fa-brain me-2 text-success"></i>
                        Annotate Categorical Fields
                        <small class="text-muted">(Click to edit level mappings)</small>
                    </h6>
                    <div id="annotationCards" class="row g-3"></div>
                </div>
                
                <!-- NeuroBagel Schema Preview (collapsed by default) -->
                <div id="neurobagelSchemaPreview" class="mt-4 d-none">
                    <h6 class="mb-3">
                        <i class="fas fa-code me-2 text-secondary"></i>
                        Full participants.json Preview
                        <button class="btn btn-sm btn-outline-secondary ms-2" type="button" 
                                data-bs-toggle="collapse" data-bs-target="#schemaDetails">
                            <i class="fas fa-code me-1"></i>View JSON
                        </button>
                    </h6>
                    
                    <!-- Collapsible JSON view -->
                    <div class="collapse" id="schemaDetails">
                        <pre class="bg-light p-3 rounded border" style="max-height: 400px; overflow: auto;"><code id="schemaJsonCode"></code></pre>
                    </div>
                </div>
            </div>

            <!-- Conversion Progress -->
            <div id="participantsConversionProgress" class="d-none mt-4">
                <h6><i class="fas fa-spinner fa-spin me-2 text-info"></i>Converting Participant Data...</h6>
                <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" 
                         role="progressbar" 
                         style="width: 100%"
                         id="participantsProgressBar">
                    </div>
                </div>
                <div id="participantsConversionLog" class="mt-3 p-3 bg-light border rounded" style="max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.85rem;">
                </div>
            </div>

            <!-- Participants Annotation Section -->
            <div class="mt-5 pt-4 border-top">
                <h5 class="mb-3">
                    <i class="fas fa-brain text-success me-2"></i>Participant Annotation & Harmonization
                </h5>
                <p class="text-muted">
                    Add descriptions, semantic annotations, and controlled vocabulary mappings to your participants data using NeuroBagel standards.
                </p>
                
                <!-- Quick Actions -->
                <div class="d-flex flex-wrap gap-2 mb-3">
                    <button class="btn btn-sm btn-outline-primary" id="editParticipantsBtn" onclick="openParticipantsEditor()">
                        <i class="fas fa-edit me-1"></i>Edit participants.json
                    </button>
                    <button class="btn btn-sm btn-outline-success" id="openNeurobagelBtn">
                        <i class="fas fa-brain me-1"></i>Annotate Participants
                    </button>
                </div>
                
                <!-- NeuroBagel Widget (hidden by default) -->
                <div id="neurobagelSection" style="display: none;">
                    <div class="card border-success mb-3">
                        <div class="card-header bg-success bg-opacity-10 d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="fas fa-brain text-success me-2"></i>
                                Participant Annotation
                            </h6>
                            <button class="btn btn-sm btn-outline-secondary" id="closeNeurobagelBtn">
                                <i class="fas fa-arrow-left me-1"></i>Back
                            </button>
                        </div>
                        <div class="card-body">
                            <!-- Full NeuroBagel Tool Link (for controlled vocabularies) -->
                            <div class="alert alert-info mb-3">
                                <i class="fas fa-lightbulb me-2"></i>
                                <strong>Need SNOMED-CT, NIDM or other controlled vocabularies?</strong><br>
                                <small class="text-muted">Use the official NeuroBagel tool for full semantic harmonization with ontology lookups:</small>
                                <div class="mt-2">
                                    <a href="https://annotate.neurobagel.org/" target="_blank" class="btn btn-sm btn-info">
                                        <i class="fas fa-external-link-alt me-1"></i>Open Full NeuroBagel Annotation Tool
                                    </a>
                                </div>
                            </div>
                            
                            <hr>
                            
                            <p class="text-muted small mb-3">
                                <strong>Quick Editor:</strong> Add descriptions and level labels to your participants.json. 
                                This simplified editor auto-detects columns from your participants.tsv file.
                            </p>
                            
                            <!-- Embedded NeuroBagel widget placeholder -->
                            <div id="neurobagelWidgetContainer"></div>
                            
                            <div class="mt-3 d-flex gap-2">
                                <button class="btn btn-success" id="saveNeurobagelBtn">
                                    <i class="fas fa-save me-1"></i>Save to participants.json
                                </button>
                                <button class="btn btn-outline-secondary" id="cancelNeurobagelBtn">
                                    <i class="fas fa-times me-1"></i>Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-light border mb-0" id="participantsHelp">
                    <i class="fas fa-info-circle text-success me-2"></i>
                    <strong>How participant annotation works:</strong>
                    <ol class="mb-0 mt-2 small">
                        <li>First, extract participant data using the form above (creates <code>participants.tsv</code>)</li>
                        <li>Click <strong>Annotate Participants</strong> to add semantic descriptions and controlled vocabulary terms</li>
                        <li>The annotation saves to <code>participants.json</code> following BIDS and NeuroBagel standards</li>
                        <li>For advanced ontology lookups (SNOMED-CT, NIDM), use the full external tool linked above</li>
                    </ol>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
// Track whether preview has been completed
let participantsPreviewCompleted = false;

// Enable/disable buttons based on file selection and preview state
function updateParticipantsButtonState() {
    const fileInput = document.getElementById('participantsDataFile');
    const hasFile = fileInput && fileInput.files.length > 0;
    
    const previewBtn = document.getElementById('participantsPreviewBtn');
    const convertBtn = document.getElementById('participantsConvertBtn');
    
    if (hasFile) {
        if (previewBtn) previewBtn.disabled = false;
        // Convert is only enabled if preview has been completed
        if (convertBtn) convertBtn.disabled = !participantsPreviewCompleted;
        checkExistingParticipantFiles();
    } else {
        if (previewBtn) previewBtn.disabled = true;
        if (convertBtn) convertBtn.disabled = true;
        participantsPreviewCompleted = false;
    }
}

// Attach event listener
const fileInput = document.getElementById('participantsDataFile');
if (fileInput) {
    fileInput.addEventListener('change', updateParticipantsButtonState);
}

// Run immediately
updateParticipantsButtonState();

// Check for existing participant files
async function checkExistingParticipantFiles() {
    try {
        const response = await fetch('/api/participants-check');
        const data = await response.json();
        
        const warningDiv = document.getElementById('participantsExistingFilesWarning');
        const messageSpan = document.getElementById('participantsExistingFilesMessage');
        
        if (data.exists) {
            const files = Object.values(data.files).filter(f => f !== null);
            messageSpan.textContent = `Found existing files: ${files.map(f => f.split('/').pop()).join(', ')}`;
            warningDiv.classList.remove('d-none');
        } else {
            warningDiv.classList.add('d-none');
        }
    } catch (error) {
        console.error('Error checking existing files:', error);
    }
}

// Preview button handler
document.getElementById('participantsPreviewBtn')?.addEventListener('click', async function() {
    const previewResults = document.getElementById('participantsPreviewResults');
    const errorDiv = document.getElementById('participantsError');
    
    errorDiv.classList.add('d-none');
    previewResults.classList.add('d-none');
    
    try {
        const fileInput = document.getElementById('participantsDataFile');
        if (!fileInput.files[0]) {
            throw new Error('Please select a file');
        }
        
        const formData = new FormData();
        formData.append('mode', 'file');
        formData.append('file', fileInput.files[0]);
        
        const sheet = document.getElementById('participantsSheet').value;
        const idColumn = document.getElementById('participantsIdColumn').value;
        if (sheet) formData.append('sheet', sheet);
        if (idColumn) formData.append('id_column', idColumn);
        
        const response = await fetch('/api/participants-preview', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || 'Preview failed');
        }
        
        // Display preview
        const countBadge = document.getElementById('participantsPreviewCount');
        countBadge.textContent = `${data.participant_count} participants`;
        
        // Show simulation note if available
        const infoDiv = document.getElementById('participantsInfo');
        if (data.simulation_note) {
            infoDiv.innerHTML = `
                <i class="fas fa-info-circle me-2"></i>
                <strong>Preview: Simulated Output</strong><br>
                ${data.simulation_note}
                ${data.total_source_columns && data.extracted_columns ? 
                    `<br>Extracting ${data.extracted_columns} of ${data.total_source_columns} columns from source file.` : ''}
            `;
            infoDiv.classList.remove('d-none');
        } else {
            infoDiv.classList.add('d-none');
        }
        
        const table = document.getElementById('participantsPreviewTable');
        const thead = table.querySelector('thead');
        const tbody = table.querySelector('tbody');
        
        thead.innerHTML = '';
        tbody.innerHTML = '';
        
        // Show table with columns
        const headerRow = document.createElement('tr');
        data.columns.forEach(col => {
            const th = document.createElement('th');
            th.textContent = col;

            const nbField = data.neurobagel_schema?.[col];
            const variableType = nbField?.Annotations?.VariableType;
            const hasNeurobagelMapping = !!nbField?.Annotations?.IsAbout;

            if (col === data.id_column) {
                th.innerHTML += ' <span class="badge bg-primary">ID</span>';
            }
            if (hasNeurobagelMapping) {
                th.innerHTML += ' <span class="badge bg-info">NB</span>';
            }
            if (variableType) {
                const typeLabel = variableType.toLowerCase() === 'continuous'
                    ? 'CONT'
                    : (variableType.toLowerCase() === 'categorical' ? 'CAT' : variableType.toUpperCase());
                const typeClass = variableType.toLowerCase() === 'continuous'
                    ? 'bg-success'
                    : (variableType.toLowerCase() === 'categorical' ? 'bg-warning text-dark' : 'bg-secondary');
                th.innerHTML += ` <span class="badge ${typeClass}">${typeLabel}</span>`;
            }
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        
        data.preview_rows.forEach(row => {
            const tr = document.createElement('tr');
            data.columns.forEach(col => {
                const td = document.createElement('td');
                td.textContent = row[col] || '';
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });

        // Make preview columns immediately available to the NeuroBagel quick editor
        // so users can map uploaded TSV fields before conversion.
        const previewColumnValues = {};
        data.columns.forEach(col => {
            const values = [];
            data.preview_rows.forEach(row => {
                const raw = row[col];
                if (raw !== null && raw !== undefined && String(raw).trim() !== '') {
                    values.push(String(raw));
                }
            });
            previewColumnValues[col] = [...new Set(values)].slice(0, 50);
        });
        window.participantsTsvData = previewColumnValues;
        console.log('âœ… Set window.participantsTsvData from preview:', Object.keys(window.participantsTsvData));
        
        previewResults.classList.remove('d-none');
        
        // Display NeuroBagel schema if available
        if (data.neurobagel_schema) {
            displayNeurobagelSchema(data.neurobagel_schema);
        }
        
    } catch (error) {
        errorDiv.textContent = error.message;
        errorDiv.classList.remove('d-none');
    }
});

function displayNeurobagelSchema(schema) {
    const annotationPreview = document.getElementById('neurobagelAnnotationPreview');
    const annotationCards = document.getElementById('annotationCards');
    const schemaPreview = document.getElementById('neurobagelSchemaPreview');
    const schemaJsonCode = document.getElementById('schemaJsonCode');
    
    // Store schema globally for use during conversion
    window.neurobagelSchema = schema;
    
    // Clear previous content
    annotationCards.innerHTML = '';
    
    // Build annotation cards for categorical fields
    let categoricalCount = 0;
    for (const [col, def] of Object.entries(schema)) {
        if (def.Levels && Object.keys(def.Levels).length > 0) {
            categoricalCount++;
            createAnnotationCard(col, def, annotationCards);
        }
    }
    
    // Show annotation section only if there are categorical fields
    if (categoricalCount > 0) {
        annotationPreview.classList.remove('d-none');
    }
    
    // Show JSON preview
    schemaJsonCode.textContent = JSON.stringify(schema, null, 2);
    schemaPreview.classList.remove('d-none');
    
    // Mark preview as complete and enable Convert button
    participantsPreviewCompleted = true;
    const convertBtn = document.getElementById('participantsConvertBtn');
    const convertHint = document.getElementById('convertBtnHint');
    if (convertBtn) {
        convertBtn.disabled = false;
        convertBtn.classList.remove('btn-outline-secondary');
        convertBtn.classList.add('btn-success');
        convertHint.textContent = 'Ready to create files in project';
    }
}

function createAnnotationCard(colName, colDef, container) {
    const col = document.createElement('div');
    col.className = 'col-md-6 col-lg-4';
    
    // Get levels
    const levels = colDef.Levels || {};
    const annotations = colDef.Annotations?.Levels || {};
    
    // Count how many have annotations
    const annotatedCount = Object.keys(annotations).length;
    const totalLevels = Object.keys(levels).length;
    const isFullyAnnotated = annotatedCount === totalLevels;
    
    const cardColor = isFullyAnnotated ? 'success' : 'warning';
    const badge = `<span class="badge bg-${cardColor}">${annotatedCount}/${totalLevels}</span>`;
    
    col.innerHTML = `
        <div class="card border-${cardColor} h-100">
            <div class="card-header bg-${cardColor} bg-opacity-10">
                <h6 class="mb-0">
                    <i class="fas fa-tag me-2"></i>${colName}
                    ${badge}
                </h6>
            </div>
            <div class="card-body p-2">
                <div class="list-group list-group-sm" id="levels-${colName}"></div>
            </div>
        </div>
    `;
    
    container.appendChild(col);
    
    // Populate levels
    const levelsList = col.querySelector(`#levels-${colName}`);
    for (const [levelValue, levelLabel] of Object.entries(levels)) {
        const annotation = annotations[levelValue] || {};
        const hasUri = !!annotation.TermURL;
        
        const item = document.createElement('div');
        item.className = `list-group-item list-group-item-sm ${hasUri ? 'list-group-item-success' : 'list-group-item-light'} cursor-pointer p-2`;
        item.style.cursor = 'pointer';
        item.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong>${levelValue}</strong>
                    <small class="text-muted d-block">${levelLabel}</small>
                    ${hasUri ? `<code class="small text-success">${annotation.TermURL}</code>` : '<span class="small text-muted">Click to add URI</span>'}
                </div>
                <i class="fas fa-edit text-muted"></i>
            </div>
        `;
        
        // Click to edit
        item.addEventListener('click', () => {
            showAnnotationEditor(colName, levelValue, levelLabel, annotation);
        });
        
        levelsList.appendChild(item);
    }
}

function showAnnotationEditor(colName, levelValue, levelLabel, currentAnnotation) {
    // Create modal for editing
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h6 class="modal-title">
                        <i class="fas fa-brain me-2"></i>Annotate: ${colName} = "${levelValue}"
                    </h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Label</label>
                        <input type="text" class="form-control" id="annotation-label" 
                               value="${currentAnnotation.Label || levelLabel}">
                        <small class="form-text text-muted">Human-readable label for this value</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">NeuroBagel URI</label>
                        <input type="text" class="form-control" id="annotation-uri" 
                               value="${currentAnnotation.TermURL || ''}"
                               placeholder="e.g., nb:Handedness/Right">
                        <small class="form-text text-muted">NeuroBagel standard vocabulary URI</small>
                    </div>
                    <div class="alert alert-info small">
                        <strong>Common URIs:</strong>
                        <ul class="mb-0 mt-2">
                            <li><code>nb:Handedness/Right</code>, <code>nb:Handedness/Left</code></li>
                            <li><code>nb:BiologicalSex/Male</code>, <code>nb:BiologicalSex/Female</code></li>
                            <li><code>nb:Gender/Male</code>, <code>nb:Gender/Female</code>, <code>nb:Gender/NonBinary</code></li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="save-annotation">Save Annotation</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bsModal = new bootstrap.Modal(modal);
    
    // Save button handler
    modal.querySelector('#save-annotation').addEventListener('click', () => {
        const newLabel = modal.querySelector('#annotation-label').value;
        const newUri = modal.querySelector('#annotation-uri').value;
        
        // Update schema
        if (window.neurobagelSchema[colName].Annotations.Levels === undefined) {
            window.neurobagelSchema[colName].Annotations.Levels = {};
        }
        
        window.neurobagelSchema[colName].Annotations.Levels[levelValue] = {
            TermURL: newUri,
            Label: newLabel
        };
        
        // Update JSON display
        document.getElementById('schemaJsonCode').textContent = 
            JSON.stringify(window.neurobagelSchema, null, 2);
        
        // Refresh card
        const annotationCards = document.getElementById('annotationCards');
        annotationCards.innerHTML = '';
        for (const [col, def] of Object.entries(window.neurobagelSchema)) {
            if (def.Levels && Object.keys(def.Levels).length > 0) {
                createAnnotationCard(col, def, annotationCards);
            }
        }
        
        bsModal.hide();
        document.body.removeChild(modal);
    });
    
    bsModal.show();
}

// Convert button handler
document.getElementById('participantsConvertBtn')?.addEventListener('click', async function() {
    const errorDiv = document.getElementById('participantsError');
    const successDiv = document.getElementById('participantsSuccess');
    const progressDiv = document.getElementById('participantsConversionProgress');
    const logDiv = document.getElementById('participantsConversionLog');
    const warningDiv = document.getElementById('participantsExistingFilesWarning');
    
    errorDiv.classList.add('d-none');
    successDiv.classList.add('d-none');
    
    // Check if user confirmed overwrite
    if (!warningDiv.classList.contains('d-none')) {
        const checkbox = document.getElementById('participantsForceOverwrite');
        if (!checkbox.checked) {
            errorDiv.textContent = 'Please confirm that you want to overwrite existing files';
            errorDiv.classList.remove('d-none');
            return;
        }
    }
    
    progressDiv.classList.remove('d-none');
    logDiv.innerHTML = '';
    
    try {
        const fileInput = document.getElementById('participantsDataFile');
        if (!fileInput.files[0]) {
            throw new Error('Please select a file');
        }
        
        const formData = new FormData();
        formData.append('mode', 'file');
        formData.append('file', fileInput.files[0]);
        formData.append('force_overwrite', document.getElementById('participantsForceOverwrite')?.checked || false);
        
        const sheet = document.getElementById('participantsSheet').value;
        const idColumn = document.getElementById('participantsIdColumn').value;
        if (sheet) formData.append('sheet', sheet);
        if (idColumn) formData.append('id_column', idColumn);
        
        // Include the modified neurobagel_schema if available
        if (window.neurobagelSchema) {
            formData.append('neurobagel_schema', JSON.stringify(window.neurobagelSchema));
        }
        
        const response = await fetch('/api/participants-convert', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        // Display log
        if (data.log) {
            data.log.forEach(entry => {
                const line = document.createElement('div');
                line.textContent = `[${entry.level}] ${entry.message}`;
                line.className = entry.level === 'ERROR' ? 'text-danger' : (entry.level === 'WARNING' ? 'text-warning' : 'text-success');
                logDiv.appendChild(line);
            });
        }
        
        if (!response.ok) {
            throw new Error(data.error || 'Conversion failed');
        }
        
        // Show success
        successDiv.innerHTML = `
            <i class="fas fa-check-circle me-2"></i>
            <strong>Success!</strong> Created ${data.files_created.length} file(s):
            <ul class="mb-0 mt-2">
                ${data.files_created.map(f => `<li><code>${f.split('/').pop()}</code></li>`).join('')}
            </ul>
        `;
        successDiv.classList.remove('d-none');
        
        // Hide warning
        warningDiv.classList.add('d-none');
        
    } catch (error) {
        errorDiv.textContent = error.message;
        errorDiv.classList.remove('d-none');
    } finally {
        progressDiv.classList.add('d-none');
    }
});

// ===== NEUROBAGEL ANNOTATION HANDLERS =====

// Function to open participants.json editor
function openParticipantsEditor() {
    const currentProjectPath = "{{ current_project.path or '' }}";
    if (!currentProjectPath) {
        const errorDiv = document.getElementById('participantsError');
        errorDiv.textContent = 'Please select a project first from the top of the page';
        errorDiv.classList.remove('d-none');
        return;
    }
    
    // Navigate to JSON editor with autoload flag and file type
    window.location.href = `{{ url_for('json_editor.editor_index') }}?autoload=participants&from=converter`;
}

document.getElementById('openNeurobagelBtn')?.addEventListener('click', function() {
    document.getElementById('neurobagelSection').style.display = 'block';
    document.getElementById('participantsHelp').style.display = 'none';
    loadNeurobagelWidget();
});

document.getElementById('closeNeurobagelBtn')?.addEventListener('click', function() {
    document.getElementById('neurobagelSection').style.display = 'none';
    document.getElementById('participantsHelp').style.display = 'block';
});

document.getElementById('cancelNeurobagelBtn')?.addEventListener('click', function() {
    document.getElementById('neurobagelSection').style.display = 'none';
    document.getElementById('participantsHelp').style.display = 'block';
});

document.getElementById('saveNeurobagelBtn')?.addEventListener('click', async function() {
    // Get the current state of the NeuroBagel widget if it has state
    const widgetState = window.neurobagelWidgetState || {};
    const allColumns = widgetState.allColumns || {};
    
    // Build the annotated participants.json (BIDS + NeuroBagel Enrichment)
    const annotatedData = {};
    
    for (const [colName, colData] of Object.entries(allColumns)) {
        annotatedData[colName] = {
            Description: colData.description || colData.Description || ""
        };
        
        // BIDS Standard: Unit
        if (colData.unit) {
            annotatedData[colName].Unit = colData.unit;
        }
        
        // BIDS Standard: Levels
        if (colData.levels && Object.keys(colData.levels).length > 0) {
            annotatedData[colName].Levels = {};
            for (const [levelKey, levelData] of Object.entries(colData.levels)) {
                annotatedData[colName].Levels[levelKey] = levelData.label || levelKey;
            }
        }
        
        // NEUROBAGEL ENRICHMENT: Annotations Block
        if (colData.standardized_variable || colData.data_type) {
            annotatedData[colName].Annotations = {
                "IsAbout": {
                    "TermURL": colData.term_url || (colData.standardized_variable ? `nb:${colData.standardized_variable}` : null),
                    "Label": colData.label || colData.standardized_variable || null
                },
                "VariableType": colData.data_type ? colData.data_type.charAt(0).toUpperCase() + colData.data_type.slice(1) : "Unknown"
            };
            
            // Add units to annotations if continuous
            if (colData.data_type === 'continuous' && colData.unit) {
                annotatedData[colName].Annotations.Format = {
                    "TermURL": "nb:FromFloat",
                    "Label": "Float"
                };
            }
            
            // Add levels to annotations if categorical
            if (colData.data_type === 'categorical' && colData.levels) {
                annotatedData[colName].Annotations.Levels = {};
                for (const [levelKey, levelData] of Object.entries(colData.levels)) {
                    if (levelData.uri) {
                        annotatedData[colName].Annotations.Levels[levelKey] = {
                            "TermURL": levelData.uri,
                            "Label": levelData.label || levelKey
                        };
                    }
                }
            }
            
            // Remove null/undefined from annotations
            if (!annotatedData[colName].Annotations.IsAbout.TermURL) delete annotatedData[colName].Annotations.IsAbout;
        }
    }
    
    // Save to the project
    try {
        const response = await fetch('/api/projects/participants', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ schema: annotatedData })
        });
        
        const result = await response.json();
        if (result.success) {
            const successDiv = document.getElementById('participantsSuccess');
            successDiv.innerHTML = '<i class="fas fa-check-circle me-2"></i><strong>Success!</strong> Participants schema saved to participants.json';
            successDiv.classList.remove('d-none');
            
            document.getElementById('neurobagelSection').style.display = 'none';
            document.getElementById('participantsHelp').style.display = 'block';
        } else {
            alert('Failed to save: ' + result.error);
        }
    } catch (error) {
        alert('Error saving participants schema: ' + error.message);
    }
});

async function loadNeurobagelWidget() {
    const container = document.getElementById('neurobagelWidgetContainer');
    if (!container) return;
    
    // Load existing participants.json if any to avoid data loss
    try {
        const schemaResponse = await fetch('/api/projects/participants');
        const schemaData = await schemaResponse.json();
        if (schemaData.success && schemaData.exists) {
            window.existingParticipantsData = schemaData.schema;
        }
    } catch (error) {
        console.warn('Could not load existing participants schema:', error);
    }
    
    // Load local participants.tsv columns first for mapping
    const projectPath = "{{ current_project.path or '' }}";
    console.log('ðŸ”„ Fetching participants TSV columns...');
    try {
        const tsvResponse = await fetch(`/api/neurobagel/local-participants?project_path=${encodeURIComponent(projectPath)}`);
        console.log('ðŸ“¡ TSV columns response status:', tsvResponse.status);
        const tsvData = await tsvResponse.json();
        console.log('ðŸ“Š TSV columns data:', tsvData);
        if (tsvData.columns) {
            window.participantsTsvData = tsvData.columns;
            console.log('âœ… Set window.participantsTsvData:', Object.keys(window.participantsTsvData));
        } else if (tsvData.error) {
            console.error('âŒ API returned error:', tsvData.error);
        }
    } catch (error) {
        console.error('âŒ Could not load participants TSV columns:', error);
    }
    
    // Check if widget is already loaded
    if (container.querySelector('#neurobagelAnnotationWidget')) {
        // Just re-render to update with latest TSV data if needed
        if (window.renderNeurobagelWidget) {
            await window.renderNeurobagelWidget();
        }
        return;
    }
    
    try {
        // Load the neurobagel widget HTML
        const response = await fetch("{{ url_for('static', filename='neurobagel_widget.html') }}");
        if (response.ok) {
            const html = await response.text();
            
            // Parse HTML to separate markup from scripts
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // Find and remove scripts
            const scripts = doc.querySelectorAll('script');
            const scriptTexts = [];
            scripts.forEach(script => {
                scriptTexts.push(script.textContent);
                script.remove();
            });
            
            // Insert the HTML without scripts
            container.innerHTML = doc.body.innerHTML;
            
            // Execute scripts in order
            scriptTexts.forEach(scriptText => {
                try {
                    new Function(scriptText)();
                } catch (err) {
                    console.error('Error executing widget script:', err);
                }
            });
            
            // Initialize widget after a short delay
            await new Promise(resolve => setTimeout(resolve, 100));
            if (window.renderNeurobagelWidget) {
                await window.renderNeurobagelWidget();
            }
        } else {
            container.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Use the <a href="https://annotate.neurobagel.org/" target="_blank">NeuroBagel Annotation Tool</a> 
                    to annotate your participants.json file, then import it back here.
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading NeuroBagel widget:', error);
        container.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Could not load embedded widget (${error.message}). Use the external 
                <a href="https://annotate.neurobagel.org/" target="_blank">NeuroBagel Annotation Tool</a>.
            </div>
        `;
    }
}

</script>
