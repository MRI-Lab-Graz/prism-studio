<html><head>
<title>prism-validator-web.py</title>
<meta name="Generator" content="htmlizer/[Twisted, version 23.10.0]" />
<link rel="alternate" href="prism-validator-web.py" type="text/x-python" />

</head>
<body>
<pre><span class="py-src-comment">#!/usr/bin/env python3</span>
<span class="py-src-string">&quot;&quot;&quot;
Web interface for prism-validator
A simple Flask web app that provides a user-friendly interface for dataset validation
&quot;&quot;&quot;</span>

<span class="py-src-variable">import</span> <span class="py-src-variable">os</span>
<span class="py-src-variable">import</span> <span class="py-src-variable">sys</span>
<span class="py-src-variable">import</span> <span class="py-src-variable">json</span>
<span class="py-src-variable">import</span> <span class="py-src-variable">tempfile</span>
<span class="py-src-variable">import</span> <span class="py-src-variable">shutil</span>
<span class="py-src-variable">import</span> <span class="py-src-variable">webbrowser</span>
<span class="py-src-variable">import</span> <span class="py-src-variable">threading</span>
<span class="py-src-variable">from</span> <span class="py-src-variable">pathlib</span> <span class="py-src-variable">import</span> <span class="py-src-variable">Path</span>
<span class="py-src-variable">from</span> <span class="py-src-variable">datetime</span> <span class="py-src-variable">import</span> <span class="py-src-variable">datetime</span>
<span class="py-src-variable">from</span> <span class="py-src-variable">flask</span> <span class="py-src-variable">import</span> (
    <span class="py-src-variable">Flask</span>,
    <span class="py-src-variable">render_template</span>,
    <span class="py-src-variable">request</span>,
    <span class="py-src-variable">jsonify</span>,
    <span class="py-src-variable">send_file</span>,
    <span class="py-src-variable">flash</span>,
    <span class="py-src-variable">redirect</span>,
    <span class="py-src-variable">url_for</span>,
)
<span class="py-src-variable">from</span> <span class="py-src-variable">werkzeug</span>.<span class="py-src-variable">utils</span> <span class="py-src-variable">import</span> <span class="py-src-variable">secure_filename</span>
<span class="py-src-variable">import</span> <span class="py-src-variable">zipfile</span>
<span class="py-src-variable">import</span> <span class="py-src-variable">io</span>
<span class="py-src-variable">import</span> <span class="py-src-variable">requests</span>
<span class="py-src-variable">from</span> <span class="py-src-variable">functools</span> <span class="py-src-variable">import</span> <span class="py-src-variable">lru_cache</span>

<span class="py-src-comment"># Ensure we can import core validator logic from src</span>
<span class="py-src-variable">BASE_DIR</span> = <span class="py-src-variable">Path</span>(<span class="py-src-variable">__file__</span>).<span class="py-src-variable">resolve</span>().<span class="py-src-variable">parent</span>
<span class="py-src-variable">SRC_DIR</span> = <span class="py-src-variable">BASE_DIR</span> / <span class="py-src-string">&quot;src&quot;</span>
<span class="py-src-variable">if</span> <span class="py-src-variable">str</span>(<span class="py-src-variable">SRC_DIR</span>) <span class="py-src-variable">not</span> <span class="py-src-variable">in</span> <span class="py-src-variable">sys</span>.<span class="py-src-variable">path</span>:
    <span class="py-src-variable">sys</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">insert</span>(<span class="py-src-number">0</span>, <span class="py-src-variable">str</span>(<span class="py-src-variable">SRC_DIR</span>))

<span class="py-src-variable">try</span>:
    <span class="py-src-variable">from</span> <span class="py-src-variable">runner</span> <span class="py-src-variable">import</span> <span class="py-src-variable">validate_dataset</span> <span class="py-src-variable">as</span> <span class="py-src-variable">core_validate_dataset</span>
<span class="py-src-variable">except</span> <span class="py-src-variable">Exception</span> <span class="py-src-variable">as</span> <span class="py-src-variable">import_error</span>:
    <span class="py-src-variable">core_validate_dataset</span> = <span class="py-src-variable">None</span>
    <span class="py-src-variable">print</span>(<span class="py-src-string">f&quot;‚ö†Ô∏è  Could not import core validator: {import_error}&quot;</span>)

<span class="py-src-variable">try</span>:
    <span class="py-src-variable">from</span> <span class="py-src-variable">limesurvey_exporter</span> <span class="py-src-variable">import</span> <span class="py-src-variable">generate_lss</span>
<span class="py-src-variable">except</span> <span class="py-src-variable">Exception</span> <span class="py-src-variable">as</span> <span class="py-src-variable">import_error</span>:
    <span class="py-src-variable">generate_lss</span> = <span class="py-src-variable">None</span>
    <span class="py-src-variable">print</span>(<span class="py-src-string">f&quot;‚ö†Ô∏è  Could not import limesurvey_exporter: {import_error}&quot;</span>)


<span class="py-src-comment"># Use subprocess to run the main validator script - single source of truth</span>
<span class="py-src-variable">def</span> <span class="py-src-identifier">run_main_validator</span>(<span class="py-src-parameter">dataset_path</span>, <span class="py-src-parameter">verbose</span>=<span class="py-src-parameter">False</span>, <span class="py-src-parameter">schema_version</span>=<span class="py-src-parameter">None</span>):
    <span class="py-src-string">&quot;&quot;&quot;
    Run the main prism-validator.py script via subprocess.
    This ensures the web interface uses exactly the same logic as the terminal version.

    Args:
        dataset_path: Path to the dataset to validate
        verbose: Enable verbose output
        schema_version: Schema version to use (e.g., &#x27;stable&#x27;, &#x27;v0.1&#x27;, &#x27;0.1&#x27;)
    &quot;&quot;&quot;</span>
    <span class="py-src-variable">import</span> <span class="py-src-variable">subprocess</span>
    <span class="py-src-variable">import</span> <span class="py-src-variable">re</span>

    <span class="py-src-variable">try</span>:
        <span class="py-src-comment"># Run the main validator script</span>
        <span class="py-src-variable">cmd</span> = [<span class="py-src-variable">sys</span>.<span class="py-src-variable">executable</span>, <span class="py-src-string">&quot;prism-validator.py&quot;</span>, <span class="py-src-variable">dataset_path</span>]
        <span class="py-src-variable">if</span> <span class="py-src-variable">verbose</span>:
            <span class="py-src-variable">cmd</span>.<span class="py-src-variable">append</span>(<span class="py-src-string">&quot;--verbose&quot;</span>)
        <span class="py-src-variable">if</span> <span class="py-src-variable">schema_version</span>:
            <span class="py-src-variable">cmd</span>.<span class="py-src-variable">extend</span>([<span class="py-src-string">&quot;--schema-version&quot;</span>, <span class="py-src-variable">schema_version</span>])

        <span class="py-src-variable">result</span> = <span class="py-src-variable">subprocess</span>.<span class="py-src-variable">run</span>(
            <span class="py-src-variable">cmd</span>, <span class="py-src-variable">capture_output</span>=<span class="py-src-variable">True</span>, <span class="py-src-variable">text</span>=<span class="py-src-variable">True</span>, <span class="py-src-variable">cwd</span>=<span class="py-src-variable">os</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">dirname</span>(<span class="py-src-variable">__file__</span>)
        )

        <span class="py-src-comment"># Helper to strip ANSI codes</span>
        <span class="py-src-variable">def</span> <span class="py-src-identifier">strip_ansi</span>(<span class="py-src-parameter">text</span>):
            <span class="py-src-variable">ansi_escape</span> = <span class="py-src-variable">re</span>.<span class="py-src-variable">compile</span>(<span class="py-src-string">r&quot;\x1B(?:[@-Z\\-_]|\[[0-?]*[ -/]*[@-~])&quot;</span>)
            <span class="py-src-variable">return</span> <span class="py-src-variable">ansi_escape</span>.<span class="py-src-variable">sub</span>(<span class="py-src-string">&quot;&quot;</span>, <span class="py-src-variable">text</span>)

        <span class="py-src-comment"># The validator script exits with 0 for success, 1 for validation errors.</span>
        <span class="py-src-comment"># We need to parse the output in both cases.</span>
        <span class="py-src-variable">if</span> <span class="py-src-variable">result</span>.<span class="py-src-variable">returncode</span> <span class="py-src-variable">in</span> [<span class="py-src-number">0</span>, <span class="py-src-number">1</span>]:
            <span class="py-src-comment"># Parse the terminal output to extract validation results</span>
            <span class="py-src-variable">stdout</span> = <span class="py-src-variable">result</span>.<span class="py-src-variable">stdout</span>
            <span class="py-src-variable">stderr</span> = <span class="py-src-variable">result</span>.<span class="py-src-variable">stderr</span>

            <span class="py-src-comment"># Extract statistics from output</span>
            <span class="py-src-variable">stats</span> = <span class="py-src-variable">SimpleStats</span>()
            <span class="py-src-variable">issues</span> = []

            <span class="py-src-comment"># Parse output for file counts and issues</span>
            <span class="py-src-variable">for</span> <span class="py-src-variable">line</span> <span class="py-src-variable">in</span> <span class="py-src-variable">stdout</span>.<span class="py-src-variable">split</span>(<span class="py-src-string">&quot;\n&quot;</span>) + <span class="py-src-variable">stderr</span>.<span class="py-src-variable">split</span>(<span class="py-src-string">&quot;\n&quot;</span>):
                <span class="py-src-variable">clean_line</span> = <span class="py-src-variable">strip_ansi</span>(<span class="py-src-variable">line</span>).<span class="py-src-variable">strip</span>()

                <span class="py-src-comment"># Parse file count from the new output format</span>
                <span class="py-src-variable">if</span> <span class="py-src-string">&quot;Total files:&quot;</span> <span class="py-src-variable">in</span> <span class="py-src-variable">clean_line</span>:
                    <span class="py-src-variable">match</span> = <span class="py-src-variable">re</span>.<span class="py-src-variable">search</span>(<span class="py-src-string">r&quot;Total files:\s*(\d+)&quot;</span>, <span class="py-src-variable">clean_line</span>)
                    <span class="py-src-variable">if</span> <span class="py-src-variable">match</span>:
                        <span class="py-src-variable">stats</span>.<span class="py-src-variable">total_files</span> = <span class="py-src-variable">int</span>(<span class="py-src-variable">match</span>.<span class="py-src-variable">group</span>(<span class="py-src-number">1</span>))
                <span class="py-src-variable">elif</span> <span class="py-src-string">&quot;üìä Found&quot;</span> <span class="py-src-variable">in</span> <span class="py-src-variable">clean_line</span> <span class="py-src-variable">and</span> <span class="py-src-string">&quot;files&quot;</span> <span class="py-src-variable">in</span> <span class="py-src-variable">clean_line</span>:
                    <span class="py-src-variable">match</span> = <span class="py-src-variable">re</span>.<span class="py-src-variable">search</span>(<span class="py-src-string">r&quot;Found (\d+) files&quot;</span>, <span class="py-src-variable">clean_line</span>)
                    <span class="py-src-variable">if</span> <span class="py-src-variable">match</span>:
                        <span class="py-src-variable">stats</span>.<span class="py-src-variable">total_files</span> = <span class="py-src-variable">int</span>(<span class="py-src-variable">match</span>.<span class="py-src-variable">group</span>(<span class="py-src-number">1</span>))
                <span class="py-src-comment"># Parse error and warning counts</span>
                <span class="py-src-variable">elif</span> <span class="py-src-string">&quot;Errors:&quot;</span> <span class="py-src-variable">in</span> <span class="py-src-variable">clean_line</span>:
                    <span class="py-src-variable">match</span> = <span class="py-src-variable">re</span>.<span class="py-src-variable">search</span>(<span class="py-src-string">r&quot;Errors:\s*(\d+)&quot;</span>, <span class="py-src-variable">clean_line</span>)
                    <span class="py-src-variable">if</span> <span class="py-src-variable">match</span> <span class="py-src-variable">and</span> <span class="py-src-variable">int</span>(<span class="py-src-variable">match</span>.<span class="py-src-variable">group</span>(<span class="py-src-number">1</span>)) &gt; <span class="py-src-number">0</span>:
                        <span class="py-src-comment"># Add a generic error - we&#x27;ll get the specific errors from other lines</span>
                        <span class="py-src-variable">pass</span>
                <span class="py-src-variable">elif</span> <span class="py-src-string">&quot;Warnings:&quot;</span> <span class="py-src-variable">in</span> <span class="py-src-variable">clean_line</span>:
                    <span class="py-src-variable">match</span> = <span class="py-src-variable">re</span>.<span class="py-src-variable">search</span>(<span class="py-src-string">r&quot;Warnings:\s*(\d+)&quot;</span>, <span class="py-src-variable">clean_line</span>)
                    <span class="py-src-variable">if</span> <span class="py-src-variable">match</span> <span class="py-src-variable">and</span> <span class="py-src-variable">int</span>(<span class="py-src-variable">match</span>.<span class="py-src-variable">group</span>(<span class="py-src-number">1</span>)) &gt; <span class="py-src-number">0</span>:
                        <span class="py-src-comment"># Add a generic warning - we&#x27;ll get the specific warnings from other lines</span>
                        <span class="py-src-variable">pass</span>
                <span class="py-src-comment"># Parse specific error messages (bullet style)</span>
                <span class="py-src-variable">elif</span> <span class="py-src-variable">clean_line</span>.<span class="py-src-variable">startswith</span>(<span class="py-src-string">&quot;‚Ä¢&quot;</span>) <span class="py-src-variable">and</span> (
                    <span class="py-src-string">&quot;‚ùå&quot;</span> <span class="py-src-variable">in</span> <span class="py-src-variable">stdout</span> <span class="py-src-variable">or</span> <span class="py-src-string">&quot;ERROR&quot;</span> <span class="py-src-variable">in</span> <span class="py-src-variable">stdout</span>
                ):
                    <span class="py-src-comment"># This is a specific error message</span>
                    <span class="py-src-variable">issues</span>.<span class="py-src-variable">append</span>(
                        (<span class="py-src-string">&quot;ERROR&quot;</span>, <span class="py-src-variable">clean_line</span>.<span class="py-src-variable">replace</span>(<span class="py-src-string">&quot;‚Ä¢&quot;</span>, <span class="py-src-string">&quot;&quot;</span>).<span class="py-src-variable">strip</span>(), <span class="py-src-variable">dataset_path</span>)
                    )
                <span class="py-src-comment"># Parse numbered error messages (reporting.py style)</span>
                <span class="py-src-variable">elif</span> <span class="py-src-variable">re</span>.<span class="py-src-variable">search</span>(<span class="py-src-string">r&quot;^\d+\.\s+&quot;</span>, <span class="py-src-variable">clean_line</span>) <span class="py-src-variable">and</span> (
                    <span class="py-src-string">&quot;‚ùå&quot;</span> <span class="py-src-variable">in</span> <span class="py-src-variable">stdout</span> <span class="py-src-variable">or</span> <span class="py-src-string">&quot;ERROR&quot;</span> <span class="py-src-variable">in</span> <span class="py-src-variable">stdout</span>
                ):
                    <span class="py-src-comment"># Remove the number and dot</span>
                    <span class="py-src-variable">msg</span> = <span class="py-src-variable">re</span>.<span class="py-src-variable">sub</span>(<span class="py-src-string">r&quot;^\d+\.\s+&quot;</span>, <span class="py-src-string">&quot;&quot;</span>, <span class="py-src-variable">clean_line</span>).<span class="py-src-variable">strip</span>()
                    <span class="py-src-variable">issues</span>.<span class="py-src-variable">append</span>((<span class="py-src-string">&quot;ERROR&quot;</span>, <span class="py-src-variable">msg</span>, <span class="py-src-variable">dataset_path</span>))

                <span class="py-src-variable">elif</span> <span class="py-src-variable">clean_line</span>.<span class="py-src-variable">startswith</span>(<span class="py-src-string">&quot;‚Ä¢&quot;</span>) <span class="py-src-variable">and</span> (
                    <span class="py-src-string">&quot;‚ö†Ô∏è&quot;</span> <span class="py-src-variable">in</span> <span class="py-src-variable">stdout</span> <span class="py-src-variable">or</span> <span class="py-src-string">&quot;WARNING&quot;</span> <span class="py-src-variable">in</span> <span class="py-src-variable">stdout</span>
                ):
                    <span class="py-src-comment"># This is a specific warning message</span>
                    <span class="py-src-variable">issues</span>.<span class="py-src-variable">append</span>(
                        (<span class="py-src-string">&quot;WARNING&quot;</span>, <span class="py-src-variable">clean_line</span>.<span class="py-src-variable">replace</span>(<span class="py-src-string">&quot;‚Ä¢&quot;</span>, <span class="py-src-string">&quot;&quot;</span>).<span class="py-src-variable">strip</span>(), <span class="py-src-variable">dataset_path</span>)
                    )
                <span class="py-src-comment"># Parse numbered warning messages</span>
                <span class="py-src-variable">elif</span> <span class="py-src-variable">re</span>.<span class="py-src-variable">search</span>(<span class="py-src-string">r&quot;^\d+\.\s+&quot;</span>, <span class="py-src-variable">clean_line</span>) <span class="py-src-variable">and</span> (
                    <span class="py-src-string">&quot;‚ö†Ô∏è&quot;</span> <span class="py-src-variable">in</span> <span class="py-src-variable">stdout</span> <span class="py-src-variable">or</span> <span class="py-src-string">&quot;WARNING&quot;</span> <span class="py-src-variable">in</span> <span class="py-src-variable">stdout</span>
                ):
                    <span class="py-src-variable">msg</span> = <span class="py-src-variable">re</span>.<span class="py-src-variable">sub</span>(<span class="py-src-string">r&quot;^\d+\.\s+&quot;</span>, <span class="py-src-string">&quot;&quot;</span>, <span class="py-src-variable">clean_line</span>).<span class="py-src-variable">strip</span>()
                    <span class="py-src-variable">issues</span>.<span class="py-src-variable">append</span>((<span class="py-src-string">&quot;WARNING&quot;</span>, <span class="py-src-variable">msg</span>, <span class="py-src-variable">dataset_path</span>))

            <span class="py-src-comment"># If we got valid output, extract more detailed info</span>
            <span class="py-src-variable">if</span> <span class="py-src-string">&quot;‚úÖ Dataset is valid!&quot;</span> <span class="py-src-variable">in</span> <span class="py-src-variable">stdout</span>:
                <span class="py-src-variable">pass</span>  <span class="py-src-comment"># No issues to add</span>
            <span class="py-src-variable">elif</span> <span class="py-src-string">&quot;‚ùå Dataset has validation errors&quot;</span> <span class="py-src-variable">in</span> <span class="py-src-variable">stdout</span>:
                <span class="py-src-variable">if</span> <span class="py-src-variable">not</span> <span class="py-src-variable">issues</span>:  <span class="py-src-comment"># Add generic error if no specific issues found</span>
                    <span class="py-src-variable">issues</span>.<span class="py-src-variable">append</span>(
                        (
                            <span class="py-src-string">&quot;ERROR&quot;</span>,
                            <span class="py-src-string">&quot;Dataset validation failed - see terminal output for details&quot;</span>,
                            <span class="py-src-variable">dataset_path</span>,
                        )
                    )
            <span class="py-src-variable">elif</span> <span class="py-src-variable">result</span>.<span class="py-src-variable">returncode</span> != <span class="py-src-number">0</span> <span class="py-src-variable">and</span> <span class="py-src-variable">not</span> <span class="py-src-variable">issues</span>:
                <span class="py-src-comment"># Add error for non-zero exit code if we didn&#x27;t parse any specific errors</span>
                <span class="py-src-variable">issues</span>.<span class="py-src-variable">append</span>((<span class="py-src-string">&quot;ERROR&quot;</span>, <span class="py-src-string">&quot;Dataset validation failed&quot;</span>, <span class="py-src-variable">dataset_path</span>))

            <span class="py-src-variable">return</span> <span class="py-src-variable">issues</span>, <span class="py-src-variable">stats</span>

        <span class="py-src-variable">else</span>:
            <span class="py-src-comment"># Handle validation failures</span>
            <span class="py-src-variable">error_msg</span> = <span class="py-src-variable">result</span>.<span class="py-src-variable">stderr</span> <span class="py-src-variable">or</span> <span class="py-src-string">&quot;Validation failed&quot;</span>
            <span class="py-src-variable">print</span>(
                <span class="py-src-string">f&quot;‚ùå Validator subprocess failed (code {result.returncode}): {error_msg}&quot;</span>
            )

            <span class="py-src-comment"># Create minimal stats and error</span>
            <span class="py-src-variable">stats</span> = <span class="py-src-variable">SimpleStats</span>()
            <span class="py-src-variable">issues</span> = [
                (<span class="py-src-string">&quot;ERROR&quot;</span>, <span class="py-src-string">f&quot;Validation process failed: {error_msg}&quot;</span>, <span class="py-src-variable">dataset_path</span>)
            ]
            <span class="py-src-variable">return</span> <span class="py-src-variable">issues</span>, <span class="py-src-variable">stats</span>

    <span class="py-src-variable">except</span> <span class="py-src-variable">FileNotFoundError</span>:
        <span class="py-src-variable">error_msg</span> = <span class="py-src-string">&quot;prism-validator.py script not found&quot;</span>
        <span class="py-src-variable">print</span>(<span class="py-src-string">f&quot;‚ùå {error_msg}&quot;</span>)
        <span class="py-src-variable">stats</span> = <span class="py-src-variable">SimpleStats</span>()
        <span class="py-src-variable">issues</span> = [(<span class="py-src-string">&quot;ERROR&quot;</span>, <span class="py-src-variable">error_msg</span>, <span class="py-src-variable">dataset_path</span>)]
        <span class="py-src-variable">return</span> <span class="py-src-variable">issues</span>, <span class="py-src-variable">stats</span>

    <span class="py-src-variable">except</span> <span class="py-src-variable">Exception</span> <span class="py-src-variable">as</span> <span class="py-src-variable">e</span>:
        <span class="py-src-variable">error_msg</span> = <span class="py-src-string">f&quot;Failed to run validator: {str(e)}&quot;</span>
        <span class="py-src-variable">print</span>(<span class="py-src-string">f&quot;‚ùå {error_msg}&quot;</span>)
        <span class="py-src-variable">stats</span> = <span class="py-src-variable">SimpleStats</span>()
        <span class="py-src-variable">issues</span> = [(<span class="py-src-string">&quot;ERROR&quot;</span>, <span class="py-src-variable">error_msg</span>, <span class="py-src-variable">dataset_path</span>)]
        <span class="py-src-variable">return</span> <span class="py-src-variable">issues</span>, <span class="py-src-variable">stats</span>


<span class="py-src-variable">class</span> <span class="py-src-identifier">SimpleStats</span>:
    <span class="py-src-string">&quot;&quot;&quot;Simple stats class to hold validation statistics&quot;&quot;&quot;</span>

    <span class="py-src-variable">def</span> <span class="py-src-identifier">__init__</span>(<span class="py-src-parameter">self</span>, *<span class="py-src-parameter">args</span>):
        <span class="py-src-variable">self</span>.<span class="py-src-variable">total_files</span> = <span class="py-src-number">0</span>
        <span class="py-src-variable">self</span>.<span class="py-src-variable">subjects</span> = <span class="py-src-variable">set</span>()
        <span class="py-src-variable">self</span>.<span class="py-src-variable">sessions</span> = <span class="py-src-variable">set</span>()
        <span class="py-src-variable">self</span>.<span class="py-src-variable">tasks</span> = <span class="py-src-variable">set</span>()
        <span class="py-src-variable">self</span>.<span class="py-src-variable">modalities</span> = <span class="py-src-variable">set</span>()

    <span class="py-src-variable">def</span> <span class="py-src-identifier">add_file</span>(<span class="py-src-parameter">self</span>, <span class="py-src-parameter">subject</span>, <span class="py-src-parameter">session</span>, <span class="py-src-parameter">modality</span>, <span class="py-src-parameter">task</span>, <span class="py-src-parameter">filename</span>):
        <span class="py-src-variable">self</span>.<span class="py-src-variable">total_files</span> += <span class="py-src-number">1</span>
        <span class="py-src-variable">if</span> <span class="py-src-variable">subject</span>:
            <span class="py-src-variable">self</span>.<span class="py-src-variable">subjects</span>.<span class="py-src-variable">add</span>(<span class="py-src-variable">subject</span>)
        <span class="py-src-variable">if</span> <span class="py-src-variable">session</span>:
            <span class="py-src-variable">self</span>.<span class="py-src-variable">sessions</span>.<span class="py-src-variable">add</span>(<span class="py-src-variable">session</span>)
        <span class="py-src-variable">if</span> <span class="py-src-variable">modality</span>:
            <span class="py-src-variable">self</span>.<span class="py-src-variable">modalities</span>.<span class="py-src-variable">add</span>(<span class="py-src-variable">modality</span>)
        <span class="py-src-variable">if</span> <span class="py-src-variable">task</span>:
            <span class="py-src-variable">self</span>.<span class="py-src-variable">tasks</span>.<span class="py-src-variable">add</span>(<span class="py-src-variable">task</span>)

    <span class="py-src-variable">def</span> <span class="py-src-identifier">check_consistency</span>(<span class="py-src-parameter">self</span>):
        <span class="py-src-variable">return</span> []


<span class="py-src-variable">def</span> <span class="py-src-identifier">simple_is_system_file</span>(<span class="py-src-parameter">filename</span>):
    <span class="py-src-string">&quot;&quot;&quot;Simple system file detection&quot;&quot;&quot;</span>
    <span class="py-src-variable">if</span> <span class="py-src-variable">not</span> <span class="py-src-variable">filename</span>:
        <span class="py-src-variable">return</span> <span class="py-src-variable">True</span>
    <span class="py-src-variable">system_files</span> = [
        <span class="py-src-string">&quot;.DS_Store&quot;</span>,
        <span class="py-src-string">&quot;._.DS_Store&quot;</span>,
        <span class="py-src-string">&quot;Thumbs.db&quot;</span>,
        <span class="py-src-string">&quot;ehthumbs.db&quot;</span>,
        <span class="py-src-string">&quot;Desktop.ini&quot;</span>,
    ]
    <span class="py-src-variable">if</span> <span class="py-src-variable">filename</span> <span class="py-src-variable">in</span> <span class="py-src-variable">system_files</span>:
        <span class="py-src-variable">return</span> <span class="py-src-variable">True</span>
    <span class="py-src-variable">if</span> <span class="py-src-variable">filename</span>.<span class="py-src-variable">startswith</span>(<span class="py-src-string">&quot;._&quot;</span>) <span class="py-src-variable">or</span> <span class="py-src-variable">filename</span>.<span class="py-src-variable">startswith</span>(<span class="py-src-string">&quot;.#&quot;</span>):
        <span class="py-src-variable">return</span> <span class="py-src-variable">True</span>
    <span class="py-src-variable">return</span> <span class="py-src-variable">False</span>


<span class="py-src-comment"># Use simple system file detection</span>
<span class="py-src-variable">is_system_file</span> = <span class="py-src-variable">simple_is_system_file</span>

<span class="py-src-variable">app</span> = <span class="py-src-variable">Flask</span>(<span class="py-src-variable">__name__</span>)
<span class="py-src-variable">app</span>.<span class="py-src-variable">secret_key</span> = <span class="py-src-string">&quot;prism-validator-secret-key&quot;</span>  <span class="py-src-comment"># Change this in production</span>
<span class="py-src-variable">app</span>.<span class="py-src-variable">config</span>[<span class="py-src-string">&quot;MAX_CONTENT_LENGTH&quot;</span>] = (
    <span class="py-src-number">100</span> * <span class="py-src-number">1024</span> * <span class="py-src-number">1024</span>
)  <span class="py-src-comment"># 100MB max file size (metadata only)</span>

<span class="py-src-comment"># Register JSON Editor blueprint if available</span>
<span class="py-src-variable">try</span>:
    <span class="py-src-variable">from</span> <span class="py-src-variable">src</span>.<span class="py-src-variable">json_editor_blueprint</span> <span class="py-src-variable">import</span> <span class="py-src-variable">create_json_editor_blueprint</span>

    <span class="py-src-variable">json_editor_bp</span> = <span class="py-src-variable">create_json_editor_blueprint</span>(<span class="py-src-variable">bids_folder</span>=<span class="py-src-variable">None</span>)
    <span class="py-src-variable">app</span>.<span class="py-src-variable">register_blueprint</span>(<span class="py-src-variable">json_editor_bp</span>)
    <span class="py-src-variable">print</span>(<span class="py-src-string">&quot;‚úì JSON Editor blueprint registered at /editor&quot;</span>)
<span class="py-src-variable">except</span> <span class="py-src-variable">ImportError</span> <span class="py-src-variable">as</span> <span class="py-src-variable">e</span>:
    <span class="py-src-variable">print</span>(<span class="py-src-string">f&quot;‚ÑπÔ∏è  JSON Editor not available: {e}&quot;</span>)
<span class="py-src-variable">except</span> <span class="py-src-variable">Exception</span> <span class="py-src-variable">as</span> <span class="py-src-variable">e</span>:
    <span class="py-src-variable">print</span>(<span class="py-src-string">f&quot;‚ö†Ô∏è  Error registering JSON Editor blueprint: {e}&quot;</span>)

<span class="py-src-comment"># File extensions to process (metadata and small data files only)</span>
<span class="py-src-comment"># We skip large neuroimaging data files - we only validate their JSON sidecars</span>
<span class="py-src-variable">METADATA_EXTENSIONS</span> = {
    <span class="py-src-string">&quot;.json&quot;</span>,  <span class="py-src-comment"># Sidecar metadata</span>
    <span class="py-src-string">&quot;.tsv&quot;</span>,  <span class="py-src-comment"># Behavioral/events data</span>
    <span class="py-src-string">&quot;.csv&quot;</span>,  <span class="py-src-comment"># Alternative tabular format</span>
    <span class="py-src-string">&quot;.txt&quot;</span>,  <span class="py-src-comment"># Text data/logs</span>
    <span class="py-src-string">&quot;.edf&quot;</span>,  <span class="py-src-comment"># EEG/eye-tracking (relatively small)</span>
    <span class="py-src-string">&quot;.bdf&quot;</span>,  <span class="py-src-comment"># BioSemi EEG format</span>
    <span class="py-src-string">&quot;.png&quot;</span>,
    <span class="py-src-string">&quot;.jpg&quot;</span>,
    <span class="py-src-string">&quot;.jpeg&quot;</span>,  <span class="py-src-comment"># Stimulus images (psychology experiments)</span>
}

<span class="py-src-comment"># Extensions to SKIP (large data files we don&#x27;t need)</span>
<span class="py-src-variable">SKIP_EXTENSIONS</span> = {
    <span class="py-src-string">&quot;.nii&quot;</span>,
    <span class="py-src-string">&quot;.nii.gz&quot;</span>,  <span class="py-src-comment"># NIfTI neuroimaging (can be GB)</span>
    <span class="py-src-string">&quot;.mp4&quot;</span>,
    <span class="py-src-string">&quot;.avi&quot;</span>,
    <span class="py-src-string">&quot;.mov&quot;</span>,  <span class="py-src-comment"># Video files</span>
    <span class="py-src-string">&quot;.tiff&quot;</span>,  <span class="py-src-comment"># Large TIFF images</span>
    <span class="py-src-string">&quot;.eeg&quot;</span>,
    <span class="py-src-string">&quot;.dat&quot;</span>,
    <span class="py-src-string">&quot;.fif&quot;</span>,  <span class="py-src-comment"># Large electrophysiology raw data</span>
    <span class="py-src-string">&quot;.mat&quot;</span>,  <span class="py-src-comment"># MATLAB files (can be large)</span>
}


<span class="py-src-variable">def</span> <span class="py-src-identifier">format_validation_results</span>(<span class="py-src-parameter">issues</span>, <span class="py-src-parameter">dataset_stats</span>, <span class="py-src-parameter">dataset_path</span>):
    <span class="py-src-string">&quot;&quot;&quot;Format validation results in BIDS-validator style with grouped errors&quot;&quot;&quot;</span>
    <span class="py-src-comment"># Group issues by error code and type</span>
    <span class="py-src-variable">error_groups</span> = {}
    <span class="py-src-variable">warning_groups</span> = {}

    <span class="py-src-variable">valid_files</span> = []
    <span class="py-src-variable">invalid_files</span> = []
    <span class="py-src-variable">file_paths</span> = <span class="py-src-variable">set</span>()

    <span class="py-src-variable">def</span> <span class="py-src-identifier">strip_temp_path</span>(<span class="py-src-parameter">file_path</span>):
        <span class="py-src-string">&quot;&quot;&quot;Strip temporary folder path prefix and keep only relative path from dataset root&quot;&quot;&quot;</span>
        <span class="py-src-variable">if</span> <span class="py-src-variable">not</span> <span class="py-src-variable">file_path</span>:
            <span class="py-src-variable">return</span> <span class="py-src-variable">None</span>

        <span class="py-src-comment"># If it&#x27;s a temp path, try to extract the relative path</span>
        <span class="py-src-variable">if</span> (
            <span class="py-src-string">&quot;/tmp/&quot;</span> <span class="py-src-variable">in</span> <span class="py-src-variable">file_path</span>
            <span class="py-src-variable">or</span> <span class="py-src-string">&quot;/T/prism_validator_&quot;</span> <span class="py-src-variable">in</span> <span class="py-src-variable">file_path</span>
            <span class="py-src-variable">or</span> <span class="py-src-string">&quot;/var/folders/&quot;</span> <span class="py-src-variable">in</span> <span class="py-src-variable">file_path</span>
            <span class="py-src-variable">or</span> <span class="py-src-string">&quot;prism_validator_&quot;</span> <span class="py-src-variable">in</span> <span class="py-src-variable">file_path</span>
        ):
            <span class="py-src-comment"># Find the dataset root marker - typically after &#x27;dataset/&#x27;</span>
            <span class="py-src-variable">if</span> <span class="py-src-string">&quot;/dataset/&quot;</span> <span class="py-src-variable">in</span> <span class="py-src-variable">file_path</span>:
                <span class="py-src-variable">parts</span> = <span class="py-src-variable">file_path</span>.<span class="py-src-variable">split</span>(<span class="py-src-string">&quot;/dataset/&quot;</span>, <span class="py-src-number">1</span>)
                <span class="py-src-variable">if</span> <span class="py-src-variable">len</span>(<span class="py-src-variable">parts</span>) &gt; <span class="py-src-number">1</span>:
                    <span class="py-src-variable">return</span> <span class="py-src-variable">parts</span>[<span class="py-src-number">1</span>]

            <span class="py-src-comment"># Alternative: look for BIDS structure markers (sub-, dataset_description.json)</span>
            <span class="py-src-variable">import</span> <span class="py-src-variable">re</span>

            <span class="py-src-variable">match</span> = <span class="py-src-variable">re</span>.<span class="py-src-variable">search</span>(<span class="py-src-string">r&quot;((?:sub-|ses-|dataset_description\.json).*)&quot;</span>, <span class="py-src-variable">file_path</span>)
            <span class="py-src-variable">if</span> <span class="py-src-variable">match</span>:
                <span class="py-src-variable">return</span> <span class="py-src-variable">match</span>.<span class="py-src-variable">group</span>(<span class="py-src-number">1</span>)

        <span class="py-src-comment"># If dataset_path is a temp directory, strip it</span>
        <span class="py-src-variable">if</span> <span class="py-src-variable">dataset_path</span> <span class="py-src-variable">and</span> <span class="py-src-variable">file_path</span>.<span class="py-src-variable">startswith</span>(<span class="py-src-variable">dataset_path</span>):
            <span class="py-src-variable">relative</span> = <span class="py-src-variable">file_path</span>[<span class="py-src-variable">len</span>(<span class="py-src-variable">dataset_path</span>) :].<span class="py-src-variable">lstrip</span>(<span class="py-src-string">&quot;/&quot;</span>)
            <span class="py-src-variable">return</span> <span class="py-src-variable">relative</span> <span class="py-src-variable">if</span> <span class="py-src-variable">relative</span> <span class="py-src-variable">else</span> <span class="py-src-variable">file_path</span>

        <span class="py-src-variable">return</span> <span class="py-src-variable">file_path</span>

    <span class="py-src-variable">def</span> <span class="py-src-identifier">extract_path_from_message</span>(<span class="py-src-parameter">msg</span>):
        <span class="py-src-string">&quot;&quot;&quot;Try to heuristically extract a file path or filename from a validator message.&quot;&quot;&quot;</span>
        <span class="py-src-variable">if</span> <span class="py-src-variable">not</span> <span class="py-src-variable">msg</span>:
            <span class="py-src-variable">return</span> <span class="py-src-variable">None</span>
        <span class="py-src-comment"># If message explicitly contains an absolute path</span>
        <span class="py-src-variable">import</span> <span class="py-src-variable">re</span>

        <span class="py-src-variable">abs_path_match</span> = <span class="py-src-variable">re</span>.<span class="py-src-variable">search</span>(<span class="py-src-string">r&quot;(/[^\s:,]+\.[A-Za-z0-9]+(?:\.gz)?)&quot;</span>, <span class="py-src-variable">msg</span>)
        <span class="py-src-variable">if</span> <span class="py-src-variable">abs_path_match</span>:
            <span class="py-src-variable">extracted</span> = <span class="py-src-variable">abs_path_match</span>.<span class="py-src-variable">group</span>(<span class="py-src-number">1</span>)
            <span class="py-src-variable">return</span> <span class="py-src-variable">strip_temp_path</span>(<span class="py-src-variable">extracted</span>)
        <span class="py-src-comment"># dataset_description.json special case</span>
        <span class="py-src-variable">if</span> <span class="py-src-string">&quot;dataset_description.json&quot;</span> <span class="py-src-variable">in</span> <span class="py-src-variable">msg</span>:
            <span class="py-src-variable">return</span> <span class="py-src-string">&quot;dataset_description.json&quot;</span>
        <span class="py-src-comment"># Look for sub-... filenames like sub-01_task-foo_blah.ext</span>
        <span class="py-src-variable">name_match</span> = <span class="py-src-variable">re</span>.<span class="py-src-variable">search</span>(<span class="py-src-string">r&quot;(sub-[A-Za-z0-9._-]+\.[A-Za-z0-9]+(?:\.gz)?)&quot;</span>, <span class="py-src-variable">msg</span>)
        <span class="py-src-variable">if</span> <span class="py-src-variable">name_match</span>:
            <span class="py-src-variable">return</span> <span class="py-src-variable">name_match</span>.<span class="py-src-variable">group</span>(<span class="py-src-number">1</span>)
        <span class="py-src-comment"># Generic filename with extension (e.g., task-recognition_stim.json)</span>
        <span class="py-src-variable">generic_match</span> = <span class="py-src-variable">re</span>.<span class="py-src-variable">search</span>(
            <span class="py-src-string">r&quot;([A-Za-z0-9._\-]+\.(?:json|tsv|edf|nii|nii\.gz|txt|csv|mp4|png|jpg|jpeg))&quot;</span>,
            <span class="py-src-variable">msg</span>,
        )
        <span class="py-src-variable">if</span> <span class="py-src-variable">generic_match</span>:
            <span class="py-src-variable">return</span> <span class="py-src-variable">generic_match</span>.<span class="py-src-variable">group</span>(<span class="py-src-number">1</span>)
        <span class="py-src-variable">return</span> <span class="py-src-variable">None</span>

    <span class="py-src-variable">for</span> <span class="py-src-variable">issue</span> <span class="py-src-variable">in</span> <span class="py-src-variable">issues</span>:
        <span class="py-src-comment"># Support tuples like (level, message) or (level, message, path)</span>
        <span class="py-src-variable">if</span> <span class="py-src-variable">isinstance</span>(<span class="py-src-variable">issue</span>, <span class="py-src-variable">dict</span>):
            <span class="py-src-variable">level</span> = (
                <span class="py-src-variable">issue</span>.<span class="py-src-variable">get</span>(<span class="py-src-string">&quot;type&quot;</span>)
                <span class="py-src-variable">or</span> <span class="py-src-variable">issue</span>.<span class="py-src-variable">get</span>(<span class="py-src-string">&quot;level&quot;</span>)
                <span class="py-src-variable">or</span> <span class="py-src-variable">issue</span>.<span class="py-src-variable">get</span>(<span class="py-src-string">&quot;severity&quot;</span>)
                <span class="py-src-variable">or</span> <span class="py-src-string">&quot;ERROR&quot;</span>
            )
            <span class="py-src-variable">message</span> = <span class="py-src-variable">issue</span>.<span class="py-src-variable">get</span>(<span class="py-src-string">&quot;message&quot;</span>, <span class="py-src-string">&quot;&quot;</span>)
            <span class="py-src-variable">file_path</span> = <span class="py-src-variable">issue</span>.<span class="py-src-variable">get</span>(<span class="py-src-string">&quot;file&quot;</span>)
        <span class="py-src-variable">elif</span> <span class="py-src-variable">isinstance</span>(<span class="py-src-variable">issue</span>, (<span class="py-src-variable">list</span>, <span class="py-src-variable">tuple</span>)):
            <span class="py-src-variable">if</span> <span class="py-src-variable">len</span>(<span class="py-src-variable">issue</span>) &gt;= <span class="py-src-number">2</span>:
                <span class="py-src-variable">level</span>, <span class="py-src-variable">message</span> = <span class="py-src-variable">issue</span>[<span class="py-src-number">0</span>], <span class="py-src-variable">issue</span>[<span class="py-src-number">1</span>]
                <span class="py-src-variable">file_path</span> = <span class="py-src-variable">issue</span>[<span class="py-src-number">2</span>] <span class="py-src-variable">if</span> <span class="py-src-variable">len</span>(<span class="py-src-variable">issue</span>) &gt; <span class="py-src-number">2</span> <span class="py-src-variable">else</span> <span class="py-src-variable">None</span>
            <span class="py-src-variable">else</span>:
                <span class="py-src-variable">continue</span>
        <span class="py-src-variable">else</span>:
            <span class="py-src-comment"># Unknown shape: stringify</span>
            <span class="py-src-variable">level</span> = <span class="py-src-string">&quot;ERROR&quot;</span>
            <span class="py-src-variable">message</span> = <span class="py-src-variable">str</span>(<span class="py-src-variable">issue</span>)
            <span class="py-src-variable">file_path</span> = <span class="py-src-variable">None</span>

        <span class="py-src-comment"># Always strip temp path from file_path</span>
        <span class="py-src-variable">if</span> <span class="py-src-variable">not</span> <span class="py-src-variable">file_path</span>:
            <span class="py-src-variable">file_path</span> = <span class="py-src-variable">extract_path_from_message</span>(<span class="py-src-variable">message</span>)
        <span class="py-src-variable">file_path</span> = <span class="py-src-variable">strip_temp_path</span>(<span class="py-src-variable">file_path</span>) <span class="py-src-variable">if</span> <span class="py-src-variable">file_path</span> <span class="py-src-variable">else</span> <span class="py-src-variable">None</span>

        <span class="py-src-variable">if</span> <span class="py-src-variable">file_path</span>:
            <span class="py-src-variable">file_paths</span>.<span class="py-src-variable">add</span>(<span class="py-src-variable">file_path</span>)

        <span class="py-src-comment"># Also strip temp path from message text itself</span>
        <span class="py-src-variable">def</span> <span class="py-src-identifier">strip_temp_path_from_message</span>(<span class="py-src-parameter">msg</span>):
            <span class="py-src-variable">if</span> <span class="py-src-variable">not</span> <span class="py-src-variable">msg</span>:
                <span class="py-src-variable">return</span> <span class="py-src-variable">msg</span>
            <span class="py-src-variable">import</span> <span class="py-src-variable">re</span>

            <span class="py-src-comment"># Replace temp folder paths in the message with just the relative path</span>
            <span class="py-src-comment"># Match various temp folder patterns: /tmp/, /T/, /var/folders/, prism_validator_</span>
            <span class="py-src-variable">msg</span> = <span class="py-src-variable">re</span>.<span class="py-src-variable">sub</span>(
                <span class="py-src-string">r&quot;(/tmp/[^\s,:]+/dataset/|/T/prism_validator_[^\s,:]+/dataset/|/var/folders/[^\s,:]+/dataset/|prism_validator_[^\s,:]+/dataset/)([^\s,:]+)&quot;</span>,
                <span class="py-src-string">r&quot;\2&quot;</span>,
                <span class="py-src-variable">msg</span>,
            )
            <span class="py-src-comment"># Also replace standalone temp paths that lead to sub- or ses- files</span>
            <span class="py-src-variable">msg</span> = <span class="py-src-variable">re</span>.<span class="py-src-variable">sub</span>(
                <span class="py-src-string">r&quot;(/tmp/[^\s,:]+/|/var/folders/[^\s,:]+/)(sub-[^\s,:/]+)&quot;</span>, <span class="py-src-string">r&quot;\2&quot;</span>, <span class="py-src-variable">msg</span>
            )
            <span class="py-src-variable">return</span> <span class="py-src-variable">msg</span>

        <span class="py-src-variable">message</span> = <span class="py-src-variable">strip_temp_path_from_message</span>(<span class="py-src-variable">message</span>)

        <span class="py-src-comment"># Extract error code from message if possible</span>
        <span class="py-src-variable">error_code</span> = <span class="py-src-string">&quot;GENERAL_ERROR&quot;</span>
        <span class="py-src-variable">if</span> (
            <span class="py-src-string">&quot;Invalid BIDS filename&quot;</span> <span class="py-src-variable">in</span> <span class="py-src-variable">message</span>
            <span class="py-src-variable">or</span> <span class="py-src-string">&quot;Invalid BIDS filename format&quot;</span> <span class="py-src-variable">in</span> <span class="py-src-variable">message</span>
        ):
            <span class="py-src-variable">error_code</span> = <span class="py-src-string">&quot;INVALID_BIDS_FILENAME&quot;</span>
        <span class="py-src-variable">elif</span> <span class="py-src-string">&quot;Missing sidecar&quot;</span> <span class="py-src-variable">in</span> <span class="py-src-variable">message</span> <span class="py-src-variable">or</span> <span class="py-src-string">&quot;Missing sidecar for&quot;</span> <span class="py-src-variable">in</span> <span class="py-src-variable">message</span>:
            <span class="py-src-variable">error_code</span> = <span class="py-src-string">&quot;MISSING_SIDECAR&quot;</span>
        <span class="py-src-variable">elif</span> <span class="py-src-string">&quot;schema error&quot;</span> <span class="py-src-variable">in</span> <span class="py-src-variable">message</span>:
            <span class="py-src-variable">error_code</span> = <span class="py-src-string">&quot;SCHEMA_VALIDATION_ERROR&quot;</span>
        <span class="py-src-variable">elif</span> <span class="py-src-string">&quot;not valid JSON&quot;</span> <span class="py-src-variable">in</span> <span class="py-src-variable">message</span> <span class="py-src-variable">or</span> <span class="py-src-string">&quot;is not valid JSON&quot;</span> <span class="py-src-variable">in</span> <span class="py-src-variable">message</span>:
            <span class="py-src-variable">error_code</span> = <span class="py-src-string">&quot;INVALID_JSON&quot;</span>
        <span class="py-src-variable">elif</span> (
            <span class="py-src-string">&quot;doesn&#x27;t match expected pattern&quot;</span> <span class="py-src-variable">in</span> <span class="py-src-variable">message</span>
            <span class="py-src-variable">or</span> <span class="py-src-string">&quot;doesn&#x27;t match expected pattern&quot;</span> <span class="py-src-variable">in</span> <span class="py-src-variable">message</span>
        ):
            <span class="py-src-variable">error_code</span> = <span class="py-src-string">&quot;FILENAME_PATTERN_MISMATCH&quot;</span>

        <span class="py-src-variable">formatted_issue</span> = {
            <span class="py-src-string">&quot;code&quot;</span>: <span class="py-src-variable">error_code</span>,
            <span class="py-src-string">&quot;message&quot;</span>: <span class="py-src-variable">message</span>,
            <span class="py-src-string">&quot;file&quot;</span>: <span class="py-src-variable">file_path</span>,
            <span class="py-src-string">&quot;level&quot;</span>: <span class="py-src-variable">level</span>,
        }

        <span class="py-src-variable">if</span> <span class="py-src-variable">level</span> == <span class="py-src-string">&quot;ERROR&quot;</span>:
            <span class="py-src-variable">if</span> <span class="py-src-variable">error_code</span> <span class="py-src-variable">not</span> <span class="py-src-variable">in</span> <span class="py-src-variable">error_groups</span>:
                <span class="py-src-variable">error_groups</span>[<span class="py-src-variable">error_code</span>] = {
                    <span class="py-src-string">&quot;code&quot;</span>: <span class="py-src-variable">error_code</span>,
                    <span class="py-src-string">&quot;description&quot;</span>: <span class="py-src-variable">get_error_description</span>(<span class="py-src-variable">error_code</span>),
                    <span class="py-src-string">&quot;files&quot;</span>: [],
                    <span class="py-src-string">&quot;count&quot;</span>: <span class="py-src-number">0</span>,
                }
            <span class="py-src-variable">error_groups</span>[<span class="py-src-variable">error_code</span>][<span class="py-src-string">&quot;files&quot;</span>].<span class="py-src-variable">append</span>(<span class="py-src-variable">formatted_issue</span>)
            <span class="py-src-variable">error_groups</span>[<span class="py-src-variable">error_code</span>][<span class="py-src-string">&quot;count&quot;</span>] += <span class="py-src-number">1</span>

            <span class="py-src-variable">if</span> <span class="py-src-variable">file_path</span>:
                <span class="py-src-variable">invalid_files</span>.<span class="py-src-variable">append</span>({<span class="py-src-string">&quot;path&quot;</span>: <span class="py-src-variable">file_path</span>, <span class="py-src-string">&quot;errors&quot;</span>: [<span class="py-src-variable">message</span>]})

        <span class="py-src-variable">elif</span> <span class="py-src-variable">level</span> == <span class="py-src-string">&quot;WARNING&quot;</span>:
            <span class="py-src-variable">if</span> <span class="py-src-variable">error_code</span> <span class="py-src-variable">not</span> <span class="py-src-variable">in</span> <span class="py-src-variable">warning_groups</span>:
                <span class="py-src-variable">warning_groups</span>[<span class="py-src-variable">error_code</span>] = {
                    <span class="py-src-string">&quot;code&quot;</span>: <span class="py-src-variable">error_code</span>,
                    <span class="py-src-string">&quot;description&quot;</span>: <span class="py-src-variable">get_error_description</span>(<span class="py-src-variable">error_code</span>),
                    <span class="py-src-string">&quot;files&quot;</span>: [],
                    <span class="py-src-string">&quot;count&quot;</span>: <span class="py-src-number">0</span>,
                }
            <span class="py-src-variable">warning_groups</span>[<span class="py-src-variable">error_code</span>][<span class="py-src-string">&quot;files&quot;</span>].<span class="py-src-variable">append</span>(<span class="py-src-variable">formatted_issue</span>)
            <span class="py-src-variable">warning_groups</span>[<span class="py-src-variable">error_code</span>][<span class="py-src-string">&quot;count&quot;</span>] += <span class="py-src-number">1</span>

            <span class="py-src-variable">if</span> <span class="py-src-variable">file_path</span>:
                <span class="py-src-variable">valid_files</span>.<span class="py-src-variable">append</span>(
                    {<span class="py-src-string">&quot;path&quot;</span>: <span class="py-src-variable">file_path</span>}
                )  <span class="py-src-comment"># Warnings don&#x27;t make files invalid</span>
        <span class="py-src-variable">else</span>:
            <span class="py-src-comment"># Treat other levels as info/valid</span>
            <span class="py-src-variable">if</span> <span class="py-src-variable">file_path</span>:
                <span class="py-src-variable">valid_files</span>.<span class="py-src-variable">append</span>({<span class="py-src-string">&quot;path&quot;</span>: <span class="py-src-variable">file_path</span>})

    <span class="py-src-comment"># If we don&#x27;t have file paths from issues, prefer dataset_stats total</span>
    <span class="py-src-variable">try</span>:
        <span class="py-src-variable">stats_total</span> = <span class="py-src-variable">getattr</span>(<span class="py-src-variable">dataset_stats</span>, <span class="py-src-string">&quot;total_files&quot;</span>, <span class="py-src-number">0</span>)
    <span class="py-src-variable">except</span> <span class="py-src-variable">Exception</span>:
        <span class="py-src-variable">stats_total</span> = <span class="py-src-number">0</span>

    <span class="py-src-comment"># Prefer authoritative dataset_stats.total_files when available so counts align</span>
    <span class="py-src-variable">if</span> <span class="py-src-variable">stats_total</span>:
        <span class="py-src-variable">total_files</span> = <span class="py-src-variable">stats_total</span>
    <span class="py-src-variable">else</span>:
        <span class="py-src-variable">total_files</span> = (
            <span class="py-src-variable">len</span>(<span class="py-src-variable">file_paths</span>) <span class="py-src-variable">if</span> <span class="py-src-variable">file_paths</span> <span class="py-src-variable">else</span> <span class="py-src-variable">len</span>(<span class="py-src-variable">valid_files</span>) + <span class="py-src-variable">len</span>(<span class="py-src-variable">invalid_files</span>)
        )

    <span class="py-src-comment"># Add error if no files found</span>
    <span class="py-src-variable">if</span> <span class="py-src-variable">stats_total</span> == <span class="py-src-number">0</span> <span class="py-src-variable">and</span> <span class="py-src-variable">len</span>(<span class="py-src-variable">file_paths</span>) == <span class="py-src-number">0</span>:
        <span class="py-src-comment"># Add a specific error for empty dataset</span>
        <span class="py-src-variable">error_code</span> = <span class="py-src-string">&quot;EMPTY_DATASET&quot;</span>
        <span class="py-src-variable">if</span> <span class="py-src-variable">error_code</span> <span class="py-src-variable">not</span> <span class="py-src-variable">in</span> <span class="py-src-variable">error_groups</span>:
            <span class="py-src-variable">error_groups</span>[<span class="py-src-variable">error_code</span>] = {
                <span class="py-src-string">&quot;code&quot;</span>: <span class="py-src-variable">error_code</span>,
                <span class="py-src-string">&quot;description&quot;</span>: <span class="py-src-string">&quot;Dataset contains no data files&quot;</span>,
                <span class="py-src-string">&quot;files&quot;</span>: [],
                <span class="py-src-string">&quot;count&quot;</span>: <span class="py-src-number">0</span>,
            }

        <span class="py-src-variable">empty_dataset_issue</span> = {
            <span class="py-src-string">&quot;code&quot;</span>: <span class="py-src-variable">error_code</span>,
            <span class="py-src-string">&quot;message&quot;</span>: <span class="py-src-string">&quot;No data files found in dataset. Dataset may be empty or all files were filtered out as system files.&quot;</span>,
            <span class="py-src-string">&quot;file&quot;</span>: <span class="py-src-variable">dataset_path</span>,
            <span class="py-src-string">&quot;level&quot;</span>: <span class="py-src-string">&quot;ERROR&quot;</span>,
        }
        <span class="py-src-variable">error_groups</span>[<span class="py-src-variable">error_code</span>][<span class="py-src-string">&quot;files&quot;</span>].<span class="py-src-variable">append</span>(<span class="py-src-variable">empty_dataset_issue</span>)
        <span class="py-src-variable">error_groups</span>[<span class="py-src-variable">error_code</span>][<span class="py-src-string">&quot;count&quot;</span>] += <span class="py-src-number">1</span>

    <span class="py-src-comment"># Calculate summary</span>
    <span class="py-src-variable">total_errors</span> = <span class="py-src-variable">sum</span>(<span class="py-src-variable">group</span>[<span class="py-src-string">&quot;count&quot;</span>] <span class="py-src-variable">for</span> <span class="py-src-variable">group</span> <span class="py-src-variable">in</span> <span class="py-src-variable">error_groups</span>.<span class="py-src-variable">values</span>())
    <span class="py-src-variable">total_warnings</span> = <span class="py-src-variable">sum</span>(<span class="py-src-variable">group</span>[<span class="py-src-string">&quot;count&quot;</span>] <span class="py-src-variable">for</span> <span class="py-src-variable">group</span> <span class="py-src-variable">in</span> <span class="py-src-variable">warning_groups</span>.<span class="py-src-variable">values</span>())

    <span class="py-src-comment"># Count valid vs invalid files</span>
    <span class="py-src-variable">invalid_file_paths</span> = {<span class="py-src-variable">f</span>[<span class="py-src-string">&quot;path&quot;</span>] <span class="py-src-variable">for</span> <span class="py-src-variable">f</span> <span class="py-src-variable">in</span> <span class="py-src-variable">invalid_files</span> <span class="py-src-variable">if</span> <span class="py-src-variable">f</span>.<span class="py-src-variable">get</span>(<span class="py-src-string">&quot;path&quot;</span>)}
    <span class="py-src-variable">invalid_count</span> = <span class="py-src-variable">len</span>(<span class="py-src-variable">invalid_file_paths</span>)
    <span class="py-src-comment"># If we have dataset total, infer valid_count</span>
    <span class="py-src-variable">if</span> <span class="py-src-variable">stats_total</span>:
        <span class="py-src-variable">valid_count</span> = <span class="py-src-variable">max</span>(<span class="py-src-number">0</span>, <span class="py-src-variable">stats_total</span> - <span class="py-src-variable">invalid_count</span>)
    <span class="py-src-variable">else</span>:
        <span class="py-src-variable">valid_count</span> = <span class="py-src-variable">total_files</span> - <span class="py-src-variable">invalid_count</span>

    <span class="py-src-comment"># A dataset is valid only if it has no errors AND has at least some files</span>
    <span class="py-src-variable">is_valid</span> = <span class="py-src-variable">total_errors</span> == <span class="py-src-number">0</span> <span class="py-src-variable">and</span> <span class="py-src-variable">total_files</span> &gt; <span class="py-src-number">0</span>

    <span class="py-src-variable">return</span> {
        <span class="py-src-string">&quot;valid&quot;</span>: <span class="py-src-variable">is_valid</span>,
        <span class="py-src-string">&quot;summary&quot;</span>: {
            <span class="py-src-string">&quot;total_files&quot;</span>: <span class="py-src-variable">total_files</span>,
            <span class="py-src-string">&quot;valid_files&quot;</span>: <span class="py-src-variable">valid_count</span>,
            <span class="py-src-string">&quot;invalid_files&quot;</span>: <span class="py-src-variable">invalid_count</span>,
            <span class="py-src-string">&quot;total_errors&quot;</span>: <span class="py-src-variable">total_errors</span>,
            <span class="py-src-string">&quot;total_warnings&quot;</span>: <span class="py-src-variable">total_warnings</span>,
        },
        <span class="py-src-string">&quot;error_groups&quot;</span>: <span class="py-src-variable">error_groups</span>,
        <span class="py-src-string">&quot;warning_groups&quot;</span>: <span class="py-src-variable">warning_groups</span>,
        <span class="py-src-string">&quot;valid_files&quot;</span>: <span class="py-src-variable">valid_files</span>,
        <span class="py-src-string">&quot;invalid_files&quot;</span>: <span class="py-src-variable">invalid_files</span>,
        <span class="py-src-string">&quot;errors&quot;</span>: [<span class="py-src-variable">item</span> <span class="py-src-variable">for</span> <span class="py-src-variable">group</span> <span class="py-src-variable">in</span> <span class="py-src-variable">error_groups</span>.<span class="py-src-variable">values</span>() <span class="py-src-variable">for</span> <span class="py-src-variable">item</span> <span class="py-src-variable">in</span> <span class="py-src-variable">group</span>[<span class="py-src-string">&quot;files&quot;</span>]],
        <span class="py-src-string">&quot;warnings&quot;</span>: [
            <span class="py-src-variable">item</span> <span class="py-src-variable">for</span> <span class="py-src-variable">group</span> <span class="py-src-variable">in</span> <span class="py-src-variable">warning_groups</span>.<span class="py-src-variable">values</span>() <span class="py-src-variable">for</span> <span class="py-src-variable">item</span> <span class="py-src-variable">in</span> <span class="py-src-variable">group</span>[<span class="py-src-string">&quot;files&quot;</span>]
        ],
        <span class="py-src-string">&quot;dataset_path&quot;</span>: <span class="py-src-variable">dataset_path</span>,
        <span class="py-src-string">&quot;dataset_stats&quot;</span>: <span class="py-src-variable">dataset_stats</span>,
    }


<span class="py-src-variable">def</span> <span class="py-src-identifier">get_error_description</span>(<span class="py-src-parameter">error_code</span>):
    <span class="py-src-string">&quot;&quot;&quot;Get user-friendly descriptions for error codes&quot;&quot;&quot;</span>
    <span class="py-src-variable">descriptions</span> = {
        <span class="py-src-string">&quot;INVALID_BIDS_FILENAME&quot;</span>: <span class="py-src-string">&quot;Filenames must follow BIDS naming convention (sub-&lt;label&gt;_[ses-&lt;label&gt;_]...)&quot;</span>,
        <span class="py-src-string">&quot;MISSING_SIDECAR&quot;</span>: <span class="py-src-string">&quot;Required JSON sidecar files are missing for data files&quot;</span>,
        <span class="py-src-string">&quot;SCHEMA_VALIDATION_ERROR&quot;</span>: <span class="py-src-string">&quot;JSON sidecar content does not match required schema&quot;</span>,
        <span class="py-src-string">&quot;INVALID_JSON&quot;</span>: <span class="py-src-string">&quot;JSON files contain syntax errors or are not valid JSON&quot;</span>,
        <span class="py-src-string">&quot;FILENAME_PATTERN_MISMATCH&quot;</span>: <span class="py-src-string">&quot;Filenames do not match expected patterns for their modality&quot;</span>,
        <span class="py-src-string">&quot;EMPTY_DATASET&quot;</span>: <span class="py-src-string">&quot;Dataset contains no data files or all files were filtered as system files&quot;</span>,
        <span class="py-src-string">&quot;GENERAL_ERROR&quot;</span>: <span class="py-src-string">&quot;General validation error&quot;</span>,
    }
    <span class="py-src-variable">return</span> <span class="py-src-variable">descriptions</span>.<span class="py-src-variable">get</span>(<span class="py-src-variable">error_code</span>, <span class="py-src-string">&quot;Validation error&quot;</span>)


<span class="py-src-variable">def</span> <span class="py-src-identifier">get_error_documentation_url</span>(<span class="py-src-parameter">error_code</span>):
    <span class="py-src-string">&quot;&quot;&quot;Get documentation URL for an error code&quot;&quot;&quot;</span>
    <span class="py-src-comment"># Map error codes to documentation anchors</span>
    <span class="py-src-variable">base_url</span> = (
        <span class="py-src-string">&quot;https://github.com/MRI-Lab-Graz/prism-validator/blob/main/docs/ERROR_CODES.md&quot;</span>
    )

    <span class="py-src-variable">doc_anchors</span> = {
        <span class="py-src-string">&quot;INVALID_BIDS_FILENAME&quot;</span>: <span class="py-src-string">f&quot;{base_url}#invalid_bids_filename&quot;</span>,
        <span class="py-src-string">&quot;MISSING_SIDECAR&quot;</span>: <span class="py-src-string">f&quot;{base_url}#missing_sidecar&quot;</span>,
        <span class="py-src-string">&quot;SCHEMA_VALIDATION_ERROR&quot;</span>: <span class="py-src-string">f&quot;{base_url}#schema_validation_error&quot;</span>,
        <span class="py-src-string">&quot;INVALID_JSON&quot;</span>: <span class="py-src-string">f&quot;{base_url}#invalid_json&quot;</span>,
        <span class="py-src-string">&quot;FILENAME_PATTERN_MISMATCH&quot;</span>: <span class="py-src-string">f&quot;{base_url}#filename_pattern_mismatch&quot;</span>,
        <span class="py-src-string">&quot;GENERAL_ERROR&quot;</span>: <span class="py-src-variable">base_url</span>,
    }
    <span class="py-src-variable">return</span> <span class="py-src-variable">doc_anchors</span>.<span class="py-src-variable">get</span>(<span class="py-src-variable">error_code</span>, <span class="py-src-variable">base_url</span>)


@<span class="py-src-variable">lru_cache</span>(<span class="py-src-variable">maxsize</span>=<span class="py-src-number">8</span>)
<span class="py-src-variable">def</span> <span class="py-src-identifier">fetch_neurobagel_participants</span>():
    <span class="py-src-string">&quot;&quot;&quot;Fetch NeuroBagel participants dictionary and cache it.&quot;&quot;&quot;</span>
    <span class="py-src-variable">url</span> = <span class="py-src-string">&quot;https://neurobagel.org/data_models/dictionaries/participants.json&quot;</span>
    <span class="py-src-variable">try</span>:
        <span class="py-src-variable">resp</span> = <span class="py-src-variable">requests</span>.<span class="py-src-variable">get</span>(<span class="py-src-variable">url</span>, <span class="py-src-variable">timeout</span>=<span class="py-src-number">10</span>)
        <span class="py-src-variable">resp</span>.<span class="py-src-variable">raise_for_status</span>()
        <span class="py-src-variable">return</span> <span class="py-src-variable">resp</span>.<span class="py-src-variable">json</span>()
    <span class="py-src-variable">except</span> <span class="py-src-variable">Exception</span>:
        <span class="py-src-variable">return</span> <span class="py-src-variable">None</span>


<span class="py-src-variable">def</span> <span class="py-src-identifier">augment_neurobagel_data</span>(<span class="py-src-parameter">raw_data</span>):
    <span class="py-src-string">&quot;&quot;&quot;Augment raw NeuroBagel data with standardized variable mappings and categorical details.

    Transforms flat NeuroBagel data into a hierarchical structure with:
    - Standardized variable mappings (e.g., sex -&gt; biological_sex)
    - Data type classification (categorical vs continuous)
    - Categorical level details with URIs and descriptions
    - Column-level metadata
    &quot;&quot;&quot;</span>
    <span class="py-src-variable">if</span> <span class="py-src-variable">not</span> <span class="py-src-variable">raw_data</span> <span class="py-src-variable">or</span> <span class="py-src-variable">not</span> <span class="py-src-variable">raw_data</span>.<span class="py-src-variable">get</span>(<span class="py-src-string">&quot;properties&quot;</span>):
        <span class="py-src-variable">return</span> <span class="py-src-variable">raw_data</span>

    <span class="py-src-comment"># Mapping of column names to standardized variables</span>
    <span class="py-src-variable">standardized_mappings</span> = {
        <span class="py-src-string">&quot;participant_id&quot;</span>: <span class="py-src-string">&quot;participant_id&quot;</span>,
        <span class="py-src-string">&quot;age&quot;</span>: <span class="py-src-string">&quot;age&quot;</span>,
        <span class="py-src-string">&quot;sex&quot;</span>: <span class="py-src-string">&quot;biological_sex&quot;</span>,
        <span class="py-src-string">&quot;group&quot;</span>: <span class="py-src-string">&quot;participant_group&quot;</span>,
        <span class="py-src-string">&quot;handedness&quot;</span>: <span class="py-src-string">&quot;handedness&quot;</span>,
    }

    <span class="py-src-comment"># Categorical value mappings with controlled vocabulary URIs (SNOMED CT and PATO)</span>
    <span class="py-src-comment"># URIs are stored in shortened form for export (e.g., &#x27;snomed:248153007&#x27;)</span>
    <span class="py-src-variable">categorical_vocabularies</span> = {
        <span class="py-src-string">&quot;sex&quot;</span>: {
            <span class="py-src-string">&quot;M&quot;</span>: {
                <span class="py-src-string">&quot;label&quot;</span>: <span class="py-src-string">&quot;Male&quot;</span>,
                <span class="py-src-string">&quot;description&quot;</span>: <span class="py-src-string">&quot;Male biological sex&quot;</span>,
                <span class="py-src-string">&quot;uri&quot;</span>: <span class="py-src-string">&quot;snomed:248153007&quot;</span>,
            },
            <span class="py-src-string">&quot;F&quot;</span>: {
                <span class="py-src-string">&quot;label&quot;</span>: <span class="py-src-string">&quot;Female&quot;</span>,
                <span class="py-src-string">&quot;description&quot;</span>: <span class="py-src-string">&quot;Female biological sex&quot;</span>,
                <span class="py-src-string">&quot;uri&quot;</span>: <span class="py-src-string">&quot;snomed:248152002&quot;</span>,
            },
            <span class="py-src-string">&quot;O&quot;</span>: {
                <span class="py-src-string">&quot;label&quot;</span>: <span class="py-src-string">&quot;Other&quot;</span>,
                <span class="py-src-string">&quot;description&quot;</span>: <span class="py-src-string">&quot;Other biological sex&quot;</span>,
                <span class="py-src-string">&quot;uri&quot;</span>: <span class="py-src-string">&quot;snomed:447964000&quot;</span>,
            },
        },
        <span class="py-src-string">&quot;handedness&quot;</span>: {
            <span class="py-src-string">&quot;L&quot;</span>: {
                <span class="py-src-string">&quot;label&quot;</span>: <span class="py-src-string">&quot;Left&quot;</span>,
                <span class="py-src-string">&quot;description&quot;</span>: <span class="py-src-string">&quot;Left-handed&quot;</span>,
                <span class="py-src-string">&quot;uri&quot;</span>: <span class="py-src-string">&quot;snomed:87622008&quot;</span>,
            },
            <span class="py-src-string">&quot;R&quot;</span>: {
                <span class="py-src-string">&quot;label&quot;</span>: <span class="py-src-string">&quot;Right&quot;</span>,
                <span class="py-src-string">&quot;description&quot;</span>: <span class="py-src-string">&quot;Right-handed&quot;</span>,
                <span class="py-src-string">&quot;uri&quot;</span>: <span class="py-src-string">&quot;snomed:78791000&quot;</span>,
            },
            <span class="py-src-string">&quot;A&quot;</span>: {
                <span class="py-src-string">&quot;label&quot;</span>: <span class="py-src-string">&quot;Ambidextrous&quot;</span>,
                <span class="py-src-string">&quot;description&quot;</span>: <span class="py-src-string">&quot;Ambidextrous&quot;</span>,
                <span class="py-src-string">&quot;uri&quot;</span>: <span class="py-src-string">&quot;snomed:16022009&quot;</span>,
            },
        },
    }

    <span class="py-src-comment"># Augmented structure</span>
    <span class="py-src-variable">augmented</span> = {<span class="py-src-string">&quot;properties&quot;</span>: {}}

    <span class="py-src-variable">for</span> <span class="py-src-variable">col_name</span>, <span class="py-src-variable">col_data</span> <span class="py-src-variable">in</span> <span class="py-src-variable">raw_data</span>.<span class="py-src-variable">get</span>(<span class="py-src-string">&quot;properties&quot;</span>, {}).<span class="py-src-variable">items</span>():
        <span class="py-src-variable">aug_col</span> = {
            <span class="py-src-string">&quot;description&quot;</span>: <span class="py-src-variable">col_data</span>.<span class="py-src-variable">get</span>(<span class="py-src-string">&quot;description&quot;</span>, <span class="py-src-string">&quot;&quot;</span>),
            <span class="py-src-string">&quot;original_data&quot;</span>: <span class="py-src-variable">col_data</span>,
        }

        <span class="py-src-comment"># Add standardized variable mapping</span>
        <span class="py-src-variable">if</span> <span class="py-src-variable">col_name</span> <span class="py-src-variable">in</span> <span class="py-src-variable">standardized_mappings</span>:
            <span class="py-src-variable">aug_col</span>[<span class="py-src-string">&quot;standardized_variable&quot;</span>] = <span class="py-src-variable">standardized_mappings</span>[<span class="py-src-variable">col_name</span>]

        <span class="py-src-comment"># Infer data type from Levels (if present, it&#x27;s categorical)</span>
        <span class="py-src-variable">if</span> <span class="py-src-string">&quot;Levels&quot;</span> <span class="py-src-variable">in</span> <span class="py-src-variable">col_data</span> <span class="py-src-variable">and</span> <span class="py-src-variable">isinstance</span>(<span class="py-src-variable">col_data</span>[<span class="py-src-string">&quot;Levels&quot;</span>], <span class="py-src-variable">dict</span>):
            <span class="py-src-variable">aug_col</span>[<span class="py-src-string">&quot;data_type&quot;</span>] = <span class="py-src-string">&quot;categorical&quot;</span>

            <span class="py-src-comment"># Augment with vocabulary if available</span>
            <span class="py-src-variable">if</span> <span class="py-src-variable">col_name</span> <span class="py-src-variable">in</span> <span class="py-src-variable">categorical_vocabularies</span>:
                <span class="py-src-variable">aug_col</span>[<span class="py-src-string">&quot;levels&quot;</span>] = {}
                <span class="py-src-variable">for</span> <span class="py-src-variable">level_key</span>, <span class="py-src-variable">level_label</span> <span class="py-src-variable">in</span> <span class="py-src-variable">col_data</span>[<span class="py-src-string">&quot;Levels&quot;</span>].<span class="py-src-variable">items</span>():
                    <span class="py-src-variable">if</span> <span class="py-src-variable">level_key</span> <span class="py-src-variable">in</span> <span class="py-src-variable">categorical_vocabularies</span>[<span class="py-src-variable">col_name</span>]:
                        <span class="py-src-variable">aug_col</span>[<span class="py-src-string">&quot;levels&quot;</span>][<span class="py-src-variable">level_key</span>] = <span class="py-src-variable">categorical_vocabularies</span>[
                            <span class="py-src-variable">col_name</span>
                        ][<span class="py-src-variable">level_key</span>]
                    <span class="py-src-variable">else</span>:
                        <span class="py-src-comment"># Fallback: use provided label (no URI)</span>
                        <span class="py-src-variable">aug_col</span>[<span class="py-src-string">&quot;levels&quot;</span>][<span class="py-src-variable">level_key</span>] = {
                            <span class="py-src-string">&quot;label&quot;</span>: (
                                <span class="py-src-variable">level_label</span>
                                <span class="py-src-variable">if</span> <span class="py-src-variable">isinstance</span>(<span class="py-src-variable">level_label</span>, <span class="py-src-variable">str</span>)
                                <span class="py-src-variable">else</span> <span class="py-src-variable">str</span>(<span class="py-src-variable">level_key</span>)
                            ),
                            <span class="py-src-string">&quot;description&quot;</span>: <span class="py-src-string">f&quot;Value: {level_key}&quot;</span>,
                            <span class="py-src-string">&quot;uri&quot;</span>: <span class="py-src-variable">None</span>,
                        }
            <span class="py-src-variable">else</span>:
                <span class="py-src-comment"># No vocabulary available, use raw levels (no URIs)</span>
                <span class="py-src-variable">aug_col</span>[<span class="py-src-string">&quot;levels&quot;</span>] = {
                    <span class="py-src-variable">k</span>: {<span class="py-src-string">&quot;label&quot;</span>: <span class="py-src-variable">v</span>, <span class="py-src-string">&quot;description&quot;</span>: <span class="py-src-string">f&quot;Value: {k}&quot;</span>, <span class="py-src-string">&quot;uri&quot;</span>: <span class="py-src-variable">None</span>}
                    <span class="py-src-variable">for</span> <span class="py-src-variable">k</span>, <span class="py-src-variable">v</span> <span class="py-src-variable">in</span> <span class="py-src-variable">col_data</span>[<span class="py-src-string">&quot;Levels&quot;</span>].<span class="py-src-variable">items</span>()
                }
        <span class="py-src-variable">elif</span> <span class="py-src-variable">col_name</span> <span class="py-src-variable">in</span> [<span class="py-src-string">&quot;age&quot;</span>]:
            <span class="py-src-variable">aug_col</span>[<span class="py-src-string">&quot;data_type&quot;</span>] = <span class="py-src-string">&quot;continuous&quot;</span>
            <span class="py-src-variable">if</span> <span class="py-src-string">&quot;Units&quot;</span> <span class="py-src-variable">in</span> <span class="py-src-variable">col_data</span>:
                <span class="py-src-variable">aug_col</span>[<span class="py-src-string">&quot;unit&quot;</span>] = <span class="py-src-variable">col_data</span>[<span class="py-src-string">&quot;Units&quot;</span>]
        <span class="py-src-variable">else</span>:
            <span class="py-src-variable">aug_col</span>[<span class="py-src-string">&quot;data_type&quot;</span>] = <span class="py-src-string">&quot;text&quot;</span>

        <span class="py-src-variable">augmented</span>[<span class="py-src-string">&quot;properties&quot;</span>][<span class="py-src-variable">col_name</span>] = <span class="py-src-variable">aug_col</span>

    <span class="py-src-variable">return</span> <span class="py-src-variable">augmented</span>


@<span class="py-src-variable">app</span>.<span class="py-src-variable">route</span>(<span class="py-src-string">&quot;/api/neurobagel/participants&quot;</span>)
<span class="py-src-variable">def</span> <span class="py-src-identifier">neurobagel_participants</span>():
    <span class="py-src-string">&quot;&quot;&quot;Return NeuroBagel participants dictionary (cached) with augmented annotations.

    The frontend can call this to populate hierarchical suggestions for participants.json fields.
    Returns augmented data with:
    - Standardized variable mappings
    - Data type classifications
    - Categorical value vocabularies with URIs
    &quot;&quot;&quot;</span>
    <span class="py-src-variable">data</span> = <span class="py-src-variable">fetch_neurobagel_participants</span>()

    <span class="py-src-comment"># If external fetch fails, use built-in dictionary</span>
    <span class="py-src-variable">if</span> <span class="py-src-variable">not</span> <span class="py-src-variable">data</span>:
        <span class="py-src-comment"># Use built-in NeuroBagel-compatible dictionary for common phenotypic variables</span>
        <span class="py-src-variable">data</span> = {
            <span class="py-src-string">&quot;properties&quot;</span>: {
                <span class="py-src-string">&quot;participant_id&quot;</span>: {<span class="py-src-string">&quot;Description&quot;</span>: <span class="py-src-string">&quot;A participant ID&quot;</span>},
                <span class="py-src-string">&quot;age&quot;</span>: {<span class="py-src-string">&quot;Description&quot;</span>: <span class="py-src-string">&quot;Age of the participant&quot;</span>, <span class="py-src-string">&quot;Units&quot;</span>: <span class="py-src-string">&quot;years&quot;</span>},
                <span class="py-src-string">&quot;sex&quot;</span>: {
                    <span class="py-src-string">&quot;Description&quot;</span>: <span class="py-src-string">&quot;Biological sex of the participant&quot;</span>,
                    <span class="py-src-string">&quot;Levels&quot;</span>: {<span class="py-src-string">&quot;M&quot;</span>: <span class="py-src-string">&quot;Male&quot;</span>, <span class="py-src-string">&quot;F&quot;</span>: <span class="py-src-string">&quot;Female&quot;</span>, <span class="py-src-string">&quot;O&quot;</span>: <span class="py-src-string">&quot;Other&quot;</span>},
                },
                <span class="py-src-string">&quot;group&quot;</span>: {
                    <span class="py-src-string">&quot;Description&quot;</span>: <span class="py-src-string">&quot;Participant group or experimental condition&quot;</span>,
                    <span class="py-src-string">&quot;Levels&quot;</span>: {},
                },
                <span class="py-src-string">&quot;handedness&quot;</span>: {
                    <span class="py-src-string">&quot;Description&quot;</span>: <span class="py-src-string">&quot;Participant handedness&quot;</span>,
                    <span class="py-src-string">&quot;Levels&quot;</span>: {<span class="py-src-string">&quot;L&quot;</span>: <span class="py-src-string">&quot;Left&quot;</span>, <span class="py-src-string">&quot;R&quot;</span>: <span class="py-src-string">&quot;Right&quot;</span>, <span class="py-src-string">&quot;A&quot;</span>: <span class="py-src-string">&quot;Ambidextrous&quot;</span>},
                },
            }
        }

    <span class="py-src-comment"># Augment raw data with standardized mappings and vocabularies</span>
    <span class="py-src-variable">augmented</span> = <span class="py-src-variable">augment_neurobagel_data</span>(<span class="py-src-variable">data</span>)

    <span class="py-src-variable">return</span> <span class="py-src-variable">jsonify</span>(
        {
            <span class="py-src-string">&quot;source&quot;</span>: <span class="py-src-string">&quot;neurobagel&quot;</span>,
            <span class="py-src-string">&quot;raw&quot;</span>: <span class="py-src-variable">data</span>,
            <span class="py-src-string">&quot;augmented&quot;</span>: <span class="py-src-variable">augmented</span>,
            <span class="py-src-string">&quot;note&quot;</span>: (
                <span class="py-src-string">&quot;Using built-in dictionary (external fetch failed)&quot;</span>
                <span class="py-src-variable">if</span> <span class="py-src-variable">not</span> <span class="py-src-variable">fetch_neurobagel_participants</span>()
                <span class="py-src-variable">else</span> <span class="py-src-string">&quot;Using remote NeuroBagel dictionary&quot;</span>
            ),
        }
    )


<span class="py-src-variable">def</span> <span class="py-src-identifier">shorten_path</span>(<span class="py-src-parameter">file_path</span>, <span class="py-src-parameter">max_parts</span>=<span class="py-src-number">3</span>):
    <span class="py-src-string">&quot;&quot;&quot;Shorten a file path to show only the last N parts with ellipsis&quot;&quot;&quot;</span>
    <span class="py-src-variable">if</span> <span class="py-src-variable">not</span> <span class="py-src-variable">file_path</span>:
        <span class="py-src-variable">return</span> <span class="py-src-string">&quot;General&quot;</span>

    <span class="py-src-variable">parts</span> = <span class="py-src-variable">file_path</span>.<span class="py-src-variable">replace</span>(<span class="py-src-string">&quot;\\&quot;</span>, <span class="py-src-string">&quot;/&quot;</span>).<span class="py-src-variable">split</span>(<span class="py-src-string">&quot;/&quot;</span>)
    <span class="py-src-variable">if</span> <span class="py-src-variable">len</span>(<span class="py-src-variable">parts</span>) &lt;= <span class="py-src-variable">max_parts</span>:
        <span class="py-src-variable">return</span> <span class="py-src-string">&quot;/&quot;</span>.<span class="py-src-variable">join</span>(<span class="py-src-variable">parts</span>)

    <span class="py-src-variable">return</span> <span class="py-src-string">&quot;.../&quot;</span> + <span class="py-src-string">&quot;/&quot;</span>.<span class="py-src-variable">join</span>(<span class="py-src-variable">parts</span>[-<span class="py-src-variable">max_parts</span>:])


<span class="py-src-variable">def</span> <span class="py-src-identifier">get_filename_from_path</span>(<span class="py-src-parameter">file_path</span>):
    <span class="py-src-string">&quot;&quot;&quot;Extract just the filename from a path&quot;&quot;&quot;</span>
    <span class="py-src-variable">if</span> <span class="py-src-variable">not</span> <span class="py-src-variable">file_path</span>:
        <span class="py-src-variable">return</span> <span class="py-src-string">&quot;General&quot;</span>
    <span class="py-src-variable">return</span> <span class="py-src-variable">os</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">basename</span>(<span class="py-src-variable">file_path</span>)


<span class="py-src-comment"># Global storage for validation results</span>
<span class="py-src-variable">validation_results</span> = {}


@<span class="py-src-variable">app</span>.<span class="py-src-variable">route</span>(<span class="py-src-string">&quot;/&quot;</span>)
<span class="py-src-variable">def</span> <span class="py-src-identifier">index</span>():
    <span class="py-src-string">&quot;&quot;&quot;Home page with tool selection&quot;&quot;&quot;</span>
    <span class="py-src-variable">return</span> <span class="py-src-variable">render_template</span>(<span class="py-src-string">&quot;home.html&quot;</span>)


@<span class="py-src-variable">app</span>.<span class="py-src-variable">route</span>(<span class="py-src-string">&quot;/validate&quot;</span>)
<span class="py-src-variable">def</span> <span class="py-src-identifier">validate_dataset</span>():
    <span class="py-src-string">&quot;&quot;&quot;Dataset validation page with upload form&quot;&quot;&quot;</span>
    <span class="py-src-comment"># Get available schema versions</span>
    <span class="py-src-variable">schema_dir</span> = <span class="py-src-variable">os</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">join</span>(<span class="py-src-variable">os</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">dirname</span>(<span class="py-src-variable">__file__</span>), <span class="py-src-string">&quot;schemas&quot;</span>)
    <span class="py-src-variable">sys</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">insert</span>(<span class="py-src-number">0</span>, <span class="py-src-variable">os</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">join</span>(<span class="py-src-variable">os</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">dirname</span>(<span class="py-src-variable">__file__</span>), <span class="py-src-string">&quot;src&quot;</span>))
    <span class="py-src-variable">try</span>:
        <span class="py-src-variable">from</span> <span class="py-src-variable">schema_manager</span> <span class="py-src-variable">import</span> <span class="py-src-variable">get_available_schema_versions</span>

        <span class="py-src-variable">available_versions</span> = <span class="py-src-variable">get_available_schema_versions</span>(<span class="py-src-variable">schema_dir</span>)
    <span class="py-src-variable">except</span> <span class="py-src-variable">Exception</span> <span class="py-src-variable">as</span> <span class="py-src-variable">e</span>:
        <span class="py-src-variable">print</span>(<span class="py-src-string">f&quot;Warning: Could not load schema versions: {e}&quot;</span>)
        <span class="py-src-variable">available_versions</span> = [<span class="py-src-string">&quot;stable&quot;</span>]

    <span class="py-src-variable">return</span> <span class="py-src-variable">render_template</span>(<span class="py-src-string">&quot;index.html&quot;</span>, <span class="py-src-variable">schema_versions</span>=<span class="py-src-variable">available_versions</span>)


@<span class="py-src-variable">app</span>.<span class="py-src-variable">route</span>(<span class="py-src-string">&quot;/upload&quot;</span>, <span class="py-src-variable">methods</span>=[<span class="py-src-string">&quot;POST&quot;</span>])
<span class="py-src-variable">def</span> <span class="py-src-identifier">upload_dataset</span>():
    <span class="py-src-string">&quot;&quot;&quot;Handle dataset upload and validation&quot;&quot;&quot;</span>
    <span class="py-src-variable">if</span> <span class="py-src-string">&quot;dataset&quot;</span> <span class="py-src-variable">not</span> <span class="py-src-variable">in</span> <span class="py-src-variable">request</span>.<span class="py-src-variable">files</span>:
        <span class="py-src-variable">flash</span>(<span class="py-src-string">&quot;No dataset uploaded&quot;</span>, <span class="py-src-string">&quot;error&quot;</span>)
        <span class="py-src-variable">return</span> <span class="py-src-variable">redirect</span>(<span class="py-src-variable">url_for</span>(<span class="py-src-string">&quot;index&quot;</span>))

    <span class="py-src-variable">files</span> = <span class="py-src-variable">request</span>.<span class="py-src-variable">files</span>.<span class="py-src-variable">getlist</span>(<span class="py-src-string">&quot;dataset&quot;</span>)
    <span class="py-src-variable">if</span> <span class="py-src-variable">not</span> <span class="py-src-variable">files</span> <span class="py-src-variable">or</span> (<span class="py-src-variable">len</span>(<span class="py-src-variable">files</span>) == <span class="py-src-number">1</span> <span class="py-src-variable">and</span> <span class="py-src-variable">files</span>[<span class="py-src-number">0</span>].<span class="py-src-variable">filename</span> == <span class="py-src-string">&quot;&quot;</span>):
        <span class="py-src-variable">flash</span>(<span class="py-src-string">&quot;No files selected&quot;</span>, <span class="py-src-string">&quot;error&quot;</span>)
        <span class="py-src-variable">return</span> <span class="py-src-variable">redirect</span>(<span class="py-src-variable">url_for</span>(<span class="py-src-string">&quot;index&quot;</span>))

    <span class="py-src-comment"># Get schema version from form</span>
    <span class="py-src-variable">schema_version</span> = <span class="py-src-variable">request</span>.<span class="py-src-variable">form</span>.<span class="py-src-variable">get</span>(<span class="py-src-string">&quot;schema_version&quot;</span>, <span class="py-src-string">&quot;stable&quot;</span>)

    <span class="py-src-comment"># Create temporary directory for processing</span>
    <span class="py-src-variable">temp_dir</span> = <span class="py-src-variable">tempfile</span>.<span class="py-src-variable">mkdtemp</span>(<span class="py-src-variable">prefix</span>=<span class="py-src-string">&quot;prism_validator_&quot;</span>)

    <span class="py-src-variable">metadata_paths</span> = <span class="py-src-variable">request</span>.<span class="py-src-variable">form</span>.<span class="py-src-variable">getlist</span>(<span class="py-src-string">&quot;metadata_paths[]&quot;</span>)

    <span class="py-src-variable">try</span>:
        <span class="py-src-comment"># Check if this is a folder upload (multiple files) or ZIP upload (single file)</span>
        <span class="py-src-variable">if</span> <span class="py-src-variable">len</span>(<span class="py-src-variable">files</span>) &gt; <span class="py-src-number">1</span> <span class="py-src-variable">or</span> (
            <span class="py-src-variable">len</span>(<span class="py-src-variable">files</span>) == <span class="py-src-number">1</span> <span class="py-src-variable">and</span> <span class="py-src-variable">not</span> <span class="py-src-variable">files</span>[<span class="py-src-number">0</span>].<span class="py-src-variable">filename</span>.<span class="py-src-variable">lower</span>().<span class="py-src-variable">endswith</span>(<span class="py-src-string">&quot;.zip&quot;</span>)
        ):
            <span class="py-src-comment"># Handle folder upload</span>
            <span class="py-src-variable">dataset_path</span> = <span class="py-src-variable">process_folder_upload</span>(<span class="py-src-variable">files</span>, <span class="py-src-variable">temp_dir</span>, <span class="py-src-variable">metadata_paths</span>)
            <span class="py-src-variable">filename</span> = <span class="py-src-string">f&quot;folder_upload_{len(files)}_files&quot;</span>
        <span class="py-src-variable">else</span>:
            <span class="py-src-comment"># Handle ZIP upload</span>
            <span class="py-src-variable">file</span> = <span class="py-src-variable">files</span>[<span class="py-src-number">0</span>]
            <span class="py-src-variable">filename</span> = <span class="py-src-variable">secure_filename</span>(<span class="py-src-variable">file</span>.<span class="py-src-variable">filename</span>)
            <span class="py-src-variable">if</span> <span class="py-src-variable">not</span> <span class="py-src-variable">filename</span>.<span class="py-src-variable">lower</span>().<span class="py-src-variable">endswith</span>(<span class="py-src-string">&quot;.zip&quot;</span>):
                <span class="py-src-variable">flash</span>(<span class="py-src-string">&quot;Please upload a ZIP file or select a folder&quot;</span>, <span class="py-src-string">&quot;error&quot;</span>)
                <span class="py-src-variable">shutil</span>.<span class="py-src-variable">rmtree</span>(<span class="py-src-variable">temp_dir</span>, <span class="py-src-variable">ignore_errors</span>=<span class="py-src-variable">True</span>)
                <span class="py-src-variable">return</span> <span class="py-src-variable">redirect</span>(<span class="py-src-variable">url_for</span>(<span class="py-src-string">&quot;index&quot;</span>))

            <span class="py-src-variable">dataset_path</span> = <span class="py-src-variable">process_zip_upload</span>(<span class="py-src-variable">file</span>, <span class="py-src-variable">temp_dir</span>, <span class="py-src-variable">filename</span>)

        <span class="py-src-comment"># DEBUG: Print dataset_path and sample files (excluding system files)</span>
        <span class="py-src-variable">print</span>(<span class="py-src-string">f&quot;üìÅ [UPLOAD] Validating dataset at: {dataset_path}&quot;</span>)
        <span class="py-src-variable">for</span> <span class="py-src-variable">root</span>, <span class="py-src-variable">dirs</span>, <span class="py-src-variable">files</span> <span class="py-src-variable">in</span> <span class="py-src-variable">os</span>.<span class="py-src-variable">walk</span>(<span class="py-src-variable">dataset_path</span>):
            <span class="py-src-comment"># Filter out system files from debug output</span>
            <span class="py-src-variable">try</span>:
                <span class="py-src-variable">filtered_files</span> = [<span class="py-src-variable">f</span> <span class="py-src-variable">for</span> <span class="py-src-variable">f</span> <span class="py-src-variable">in</span> <span class="py-src-variable">files</span> <span class="py-src-variable">if</span> <span class="py-src-variable">not</span> <span class="py-src-variable">is_system_file</span>(<span class="py-src-variable">f</span>)]
            <span class="py-src-variable">except</span> <span class="py-src-variable">NameError</span>:
                <span class="py-src-comment"># Fallback filtering</span>
                <span class="py-src-variable">filtered_files</span> = [
                    <span class="py-src-variable">f</span>
                    <span class="py-src-variable">for</span> <span class="py-src-variable">f</span> <span class="py-src-variable">in</span> <span class="py-src-variable">files</span>
                    <span class="py-src-variable">if</span> <span class="py-src-variable">not</span> (
                        <span class="py-src-variable">f</span>.<span class="py-src-variable">startswith</span>(<span class="py-src-string">&quot;.&quot;</span>)
                        <span class="py-src-variable">or</span> <span class="py-src-variable">f</span> <span class="py-src-variable">in</span> [<span class="py-src-string">&quot;Thumbs.db&quot;</span>, <span class="py-src-string">&quot;ehthumbs.db&quot;</span>, <span class="py-src-string">&quot;Desktop.ini&quot;</span>]
                    )
                ]

            <span class="py-src-variable">for</span> <span class="py-src-variable">file</span> <span class="py-src-variable">in</span> <span class="py-src-variable">filtered_files</span>[:<span class="py-src-number">10</span>]:
                <span class="py-src-variable">print</span>(<span class="py-src-string">f&quot;   {os.path.relpath(os.path.join(root, file), dataset_path)}&quot;</span>)
            <span class="py-src-variable">if</span> <span class="py-src-variable">len</span>(<span class="py-src-variable">files</span>) != <span class="py-src-variable">len</span>(<span class="py-src-variable">filtered_files</span>):
                <span class="py-src-variable">print</span>(<span class="py-src-string">f&quot;   (+ {len(files) - len(filtered_files)} system files ignored)&quot;</span>)
            <span class="py-src-variable">break</span>
        <span class="py-src-comment"># Validate the dataset using core validator when available</span>
        <span class="py-src-variable">if</span> <span class="py-src-variable">callable</span>(<span class="py-src-variable">core_validate_dataset</span>):
            <span class="py-src-variable">issues</span>, <span class="py-src-variable">dataset_stats</span> = <span class="py-src-variable">core_validate_dataset</span>(
                <span class="py-src-variable">dataset_path</span>, <span class="py-src-variable">verbose</span>=<span class="py-src-variable">True</span>, <span class="py-src-variable">schema_version</span>=<span class="py-src-variable">schema_version</span>
            )
        <span class="py-src-variable">else</span>:
            <span class="py-src-variable">issues</span>, <span class="py-src-variable">dataset_stats</span> = <span class="py-src-variable">run_main_validator</span>(
                <span class="py-src-variable">dataset_path</span>, <span class="py-src-variable">verbose</span>=<span class="py-src-variable">True</span>, <span class="py-src-variable">schema_version</span>=<span class="py-src-variable">schema_version</span>
            )
        <span class="py-src-variable">results</span> = <span class="py-src-variable">format_validation_results</span>(<span class="py-src-variable">issues</span>, <span class="py-src-variable">dataset_stats</span>, <span class="py-src-variable">dataset_path</span>)

        <span class="py-src-comment"># Add timestamp, upload type info, and schema version</span>
        <span class="py-src-variable">from</span> <span class="py-src-variable">datetime</span> <span class="py-src-variable">import</span> <span class="py-src-variable">datetime</span>

        <span class="py-src-variable">results</span>[<span class="py-src-string">&quot;timestamp&quot;</span>] = <span class="py-src-variable">datetime</span>.<span class="py-src-variable">now</span>().<span class="py-src-variable">isoformat</span>()
        <span class="py-src-variable">results</span>[<span class="py-src-string">&quot;upload_type&quot;</span>] = <span class="py-src-string">&quot;structure_only&quot;</span>
        <span class="py-src-variable">results</span>[<span class="py-src-string">&quot;schema_version&quot;</span>] = <span class="py-src-variable">schema_version</span>

        <span class="py-src-comment"># Check if manifest exists and add details</span>
        <span class="py-src-variable">manifest_path</span> = <span class="py-src-variable">os</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">join</span>(<span class="py-src-variable">dataset_path</span>, <span class="py-src-string">&quot;.upload_manifest.json&quot;</span>)
        <span class="py-src-variable">if</span> <span class="py-src-variable">os</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">exists</span>(<span class="py-src-variable">manifest_path</span>):
            <span class="py-src-variable">with</span> <span class="py-src-variable">open</span>(<span class="py-src-variable">manifest_path</span>, <span class="py-src-string">&quot;r&quot;</span>) <span class="py-src-variable">as</span> <span class="py-src-variable">f</span>:
                <span class="py-src-variable">manifest</span> = <span class="py-src-variable">json</span>.<span class="py-src-variable">load</span>(<span class="py-src-variable">f</span>)
            <span class="py-src-variable">results</span>[<span class="py-src-string">&quot;upload_manifest&quot;</span>] = {
                <span class="py-src-string">&quot;metadata_files&quot;</span>: <span class="py-src-variable">len</span>(<span class="py-src-variable">manifest</span>.<span class="py-src-variable">get</span>(<span class="py-src-string">&quot;uploaded_files&quot;</span>, [])),
                <span class="py-src-string">&quot;placeholder_files&quot;</span>: <span class="py-src-variable">len</span>(<span class="py-src-variable">manifest</span>.<span class="py-src-variable">get</span>(<span class="py-src-string">&quot;placeholder_files&quot;</span>, [])),
                <span class="py-src-string">&quot;upload_mode&quot;</span>: <span class="py-src-string">&quot;DataLad-style (structure + metadata only)&quot;</span>,
            }

        <span class="py-src-comment"># DEBUG: Print summary to console</span>
        <span class="py-src-variable">print</span>(<span class="py-src-string">&quot;üìä Validation complete:&quot;</span>)
        <span class="py-src-variable">print</span>(<span class="py-src-string">f&quot;   Total files: {results[&#x27;summary&#x27;][&#x27;total_files&#x27;]}&quot;</span>)
        <span class="py-src-variable">print</span>(<span class="py-src-string">f&quot;   Valid files: {results[&#x27;summary&#x27;][&#x27;valid_files&#x27;]}&quot;</span>)
        <span class="py-src-variable">print</span>(<span class="py-src-string">f&quot;   Invalid files: {results[&#x27;summary&#x27;][&#x27;invalid_files&#x27;]}&quot;</span>)
        <span class="py-src-variable">print</span>(<span class="py-src-string">f&quot;   Total errors: {results[&#x27;summary&#x27;][&#x27;total_errors&#x27;]}&quot;</span>)

        <span class="py-src-comment"># Store results globally (in production, use a database)</span>
        <span class="py-src-variable">result_id</span> = <span class="py-src-string">f&quot;result_{len(validation_results)}&quot;</span>
        <span class="py-src-variable">validation_results</span>[<span class="py-src-variable">result_id</span>] = {
            <span class="py-src-string">&quot;results&quot;</span>: <span class="py-src-variable">results</span>,
            <span class="py-src-string">&quot;dataset_path&quot;</span>: <span class="py-src-variable">dataset_path</span>,
            <span class="py-src-string">&quot;temp_dir&quot;</span>: <span class="py-src-variable">temp_dir</span>,
            <span class="py-src-string">&quot;filename&quot;</span>: <span class="py-src-variable">filename</span>,
        }

        <span class="py-src-variable">return</span> <span class="py-src-variable">redirect</span>(<span class="py-src-variable">url_for</span>(<span class="py-src-string">&quot;show_results&quot;</span>, <span class="py-src-variable">result_id</span>=<span class="py-src-variable">result_id</span>))

    <span class="py-src-variable">except</span> <span class="py-src-variable">Exception</span> <span class="py-src-variable">as</span> <span class="py-src-variable">e</span>:
        <span class="py-src-comment"># Clean up on error</span>
        <span class="py-src-variable">print</span>(<span class="py-src-string">f&quot;‚ùå [UPLOAD ERROR] {type(e).__name__}: {str(e)}&quot;</span>)
        <span class="py-src-variable">import</span> <span class="py-src-variable">traceback</span>

        <span class="py-src-variable">traceback</span>.<span class="py-src-variable">print_exc</span>()
        <span class="py-src-variable">if</span> <span class="py-src-variable">os</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">exists</span>(<span class="py-src-variable">temp_dir</span>):
            <span class="py-src-variable">shutil</span>.<span class="py-src-variable">rmtree</span>(<span class="py-src-variable">temp_dir</span>, <span class="py-src-variable">ignore_errors</span>=<span class="py-src-variable">True</span>)
        <span class="py-src-variable">flash</span>(<span class="py-src-string">f&quot;Error processing dataset: {str(e)}&quot;</span>, <span class="py-src-string">&quot;error&quot;</span>)
        <span class="py-src-variable">return</span> <span class="py-src-variable">redirect</span>(<span class="py-src-variable">url_for</span>(<span class="py-src-string">&quot;index&quot;</span>))


<span class="py-src-variable">def</span> <span class="py-src-identifier">create_placeholder_content</span>(<span class="py-src-parameter">file_path</span>, <span class="py-src-parameter">extension</span>):
    <span class="py-src-string">&quot;&quot;&quot;Create informative placeholder content for data files (DataLad-style)&quot;&quot;&quot;</span>
    <span class="py-src-variable">filename</span> = <span class="py-src-variable">os</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">basename</span>(<span class="py-src-variable">file_path</span>)

    <span class="py-src-comment"># For JSON files, create valid JSON placeholders</span>
    <span class="py-src-variable">if</span> <span class="py-src-variable">extension</span>.<span class="py-src-variable">lower</span>() == <span class="py-src-string">&quot;.json&quot;</span>:
        <span class="py-src-variable">return</span> <span class="py-src-variable">json</span>.<span class="py-src-variable">dumps</span>(
            {
                <span class="py-src-string">&quot;_placeholder&quot;</span>: <span class="py-src-variable">True</span>,
                <span class="py-src-string">&quot;_upload_mode&quot;</span>: <span class="py-src-string">&quot;DataLad-style (structure + metadata only)&quot;</span>,
                <span class="py-src-string">&quot;_original_filename&quot;</span>: <span class="py-src-variable">filename</span>,
                <span class="py-src-string">&quot;_created&quot;</span>: <span class="py-src-variable">datetime</span>.<span class="py-src-variable">now</span>().<span class="py-src-variable">isoformat</span>(),
                <span class="py-src-string">&quot;_note&quot;</span>: <span class="py-src-string">&quot;This is a placeholder file. Original JSON was not uploaded to reduce transfer size.&quot;</span>,
            },
            <span class="py-src-variable">indent</span>=<span class="py-src-number">2</span>,
        )

    <span class="py-src-comment"># For TSV files, create valid TSV placeholders</span>
    <span class="py-src-variable">elif</span> <span class="py-src-variable">extension</span>.<span class="py-src-variable">lower</span>() == <span class="py-src-string">&quot;.tsv&quot;</span>:
        <span class="py-src-variable">return</span> <span class="py-src-string">f&quot;# PLACEHOLDER TSV - DataLad-style Upload\n# Original filename: {filename}\n# Created: {datetime.now().isoformat()}\n_placeholder\ttrue\n&quot;</span>

    <span class="py-src-comment"># For other file types, use text placeholder</span>
    <span class="py-src-variable">else</span>:
        <span class="py-src-comment"># Determine file type from extension</span>
        <span class="py-src-variable">file_type_map</span> = {
            <span class="py-src-string">&quot;.nii&quot;</span>: <span class="py-src-string">&quot;NIfTI neuroimaging data&quot;</span>,
            <span class="py-src-string">&quot;.nii.gz&quot;</span>: <span class="py-src-string">&quot;Compressed NIfTI neuroimaging data&quot;</span>,
            <span class="py-src-string">&quot;.png&quot;</span>: <span class="py-src-string">&quot;PNG image stimulus&quot;</span>,
            <span class="py-src-string">&quot;.jpg&quot;</span>: <span class="py-src-string">&quot;JPEG image stimulus&quot;</span>,
            <span class="py-src-string">&quot;.jpeg&quot;</span>: <span class="py-src-string">&quot;JPEG image stimulus&quot;</span>,
            <span class="py-src-string">&quot;.tiff&quot;</span>: <span class="py-src-string">&quot;TIFF image data&quot;</span>,
            <span class="py-src-string">&quot;.mp4&quot;</span>: <span class="py-src-string">&quot;MP4 video stimulus&quot;</span>,
            <span class="py-src-string">&quot;.avi&quot;</span>: <span class="py-src-string">&quot;AVI video data&quot;</span>,
            <span class="py-src-string">&quot;.mov&quot;</span>: <span class="py-src-string">&quot;QuickTime video&quot;</span>,
            <span class="py-src-string">&quot;.eeg&quot;</span>: <span class="py-src-string">&quot;EEG raw data&quot;</span>,
            <span class="py-src-string">&quot;.dat&quot;</span>: <span class="py-src-string">&quot;Binary data file&quot;</span>,
            <span class="py-src-string">&quot;.fif&quot;</span>: <span class="py-src-string">&quot;Neuromag/MNE data&quot;</span>,
            <span class="py-src-string">&quot;.mat&quot;</span>: <span class="py-src-string">&quot;MATLAB data file&quot;</span>,
        }

        <span class="py-src-variable">file_type</span> = <span class="py-src-variable">file_type_map</span>.<span class="py-src-variable">get</span>(<span class="py-src-variable">extension</span>, <span class="py-src-string">f&quot;{extension} data file&quot;</span>)

        <span class="py-src-variable">placeholder</span> = <span class="py-src-string">f&quot;&quot;&quot;# PLACEHOLDER FILE - DataLad-style Upload
# This is a placeholder for the original data file that was not uploaded
# to reduce transfer size and processing time.

Original filename: {filename}
File type: {file_type}
Upload mode: Structure-only validation
Created: {datetime.now().isoformat()}

# The validator can still check:
# - File naming conventions
# - Directory structure
# - Metadata completeness (via JSON sidecars)
# - BIDS compliance

# Note: Full content validation requires the complete dataset.
&quot;&quot;&quot;</span>
        <span class="py-src-variable">return</span> <span class="py-src-variable">placeholder</span>


<span class="py-src-variable">def</span> <span class="py-src-identifier">detect_dataset_prefix</span>(<span class="py-src-parameter">all_paths</span>):
    <span class="py-src-string">&quot;&quot;&quot;Detect a common leading folder that should be stripped from uploaded paths.&quot;&quot;&quot;</span>
    <span class="py-src-variable">sanitized_parts</span> = []
    <span class="py-src-variable">has_root_level_files</span> = <span class="py-src-variable">False</span>
    <span class="py-src-variable">for</span> <span class="py-src-variable">path</span> <span class="py-src-variable">in</span> <span class="py-src-variable">all_paths</span> <span class="py-src-variable">or</span> []:
        <span class="py-src-variable">if</span> <span class="py-src-variable">not</span> <span class="py-src-variable">path</span>:
            <span class="py-src-variable">continue</span>
        <span class="py-src-variable">parts</span> = [<span class="py-src-variable">part</span> <span class="py-src-variable">for</span> <span class="py-src-variable">part</span> <span class="py-src-variable">in</span> <span class="py-src-variable">path</span>.<span class="py-src-variable">replace</span>(<span class="py-src-string">&quot;\\&quot;</span>, <span class="py-src-string">&quot;/&quot;</span>).<span class="py-src-variable">split</span>(<span class="py-src-string">&quot;/&quot;</span>) <span class="py-src-variable">if</span> <span class="py-src-variable">part</span>]
        <span class="py-src-variable">if</span> <span class="py-src-variable">not</span> <span class="py-src-variable">parts</span>:
            <span class="py-src-variable">continue</span>
        <span class="py-src-variable">if</span> <span class="py-src-variable">len</span>(<span class="py-src-variable">parts</span>) == <span class="py-src-number">1</span>:
            <span class="py-src-variable">has_root_level_files</span> = <span class="py-src-variable">True</span>
        <span class="py-src-variable">sanitized_parts</span>.<span class="py-src-variable">append</span>(<span class="py-src-variable">parts</span>)
    <span class="py-src-variable">if</span> <span class="py-src-variable">has_root_level_files</span> <span class="py-src-variable">or</span> <span class="py-src-variable">not</span> <span class="py-src-variable">sanitized_parts</span>:
        <span class="py-src-variable">return</span> <span class="py-src-variable">None</span>
    <span class="py-src-variable">first_components</span> = {<span class="py-src-variable">parts</span>[<span class="py-src-number">0</span>] <span class="py-src-variable">for</span> <span class="py-src-variable">parts</span> <span class="py-src-variable">in</span> <span class="py-src-variable">sanitized_parts</span>}
    <span class="py-src-variable">if</span> <span class="py-src-variable">len</span>(<span class="py-src-variable">first_components</span>) != <span class="py-src-number">1</span>:
        <span class="py-src-variable">return</span> <span class="py-src-variable">None</span>
    <span class="py-src-variable">candidate</span> = <span class="py-src-variable">first_components</span>.<span class="py-src-variable">pop</span>()
    <span class="py-src-variable">restricted_names</span> = {
        <span class="py-src-string">&quot;image&quot;</span>,
        <span class="py-src-string">&quot;audio&quot;</span>,
        <span class="py-src-string">&quot;movie&quot;</span>,
        <span class="py-src-string">&quot;survey&quot;</span>,
        <span class="py-src-string">&quot;eyetracking&quot;</span>,
        <span class="py-src-string">&quot;physiological&quot;</span>,
        <span class="py-src-string">&quot;dataset&quot;</span>,
    }
    <span class="py-src-variable">if</span> <span class="py-src-variable">candidate</span>.<span class="py-src-variable">startswith</span>((<span class="py-src-string">&quot;sub-&quot;</span>, <span class="py-src-string">&quot;ses-&quot;</span>)) <span class="py-src-variable">or</span> <span class="py-src-variable">candidate</span> <span class="py-src-variable">in</span> <span class="py-src-variable">restricted_names</span>:
        <span class="py-src-variable">return</span> <span class="py-src-variable">None</span>
    <span class="py-src-variable">has_dataset_description</span> = <span class="py-src-variable">any</span>(
        <span class="py-src-variable">len</span>(<span class="py-src-variable">parts</span>) &gt;= <span class="py-src-number">2</span>
        <span class="py-src-variable">and</span> <span class="py-src-variable">parts</span>[<span class="py-src-number">0</span>] == <span class="py-src-variable">candidate</span>
        <span class="py-src-variable">and</span> <span class="py-src-variable">parts</span>[<span class="py-src-number">1</span>] == <span class="py-src-string">&quot;dataset_description.json&quot;</span>
        <span class="py-src-variable">for</span> <span class="py-src-variable">parts</span> <span class="py-src-variable">in</span> <span class="py-src-variable">sanitized_parts</span>
    )
    <span class="py-src-variable">has_subject_dirs</span> = <span class="py-src-variable">any</span>(
        <span class="py-src-variable">len</span>(<span class="py-src-variable">parts</span>) &gt;= <span class="py-src-number">2</span> <span class="py-src-variable">and</span> <span class="py-src-variable">parts</span>[<span class="py-src-number">0</span>] == <span class="py-src-variable">candidate</span> <span class="py-src-variable">and</span> <span class="py-src-variable">parts</span>[<span class="py-src-number">1</span>].<span class="py-src-variable">startswith</span>(<span class="py-src-string">&quot;sub-&quot;</span>)
        <span class="py-src-variable">for</span> <span class="py-src-variable">parts</span> <span class="py-src-variable">in</span> <span class="py-src-variable">sanitized_parts</span>
    )
    <span class="py-src-variable">if</span> <span class="py-src-variable">not</span> (<span class="py-src-variable">has_dataset_description</span> <span class="py-src-variable">or</span> <span class="py-src-variable">has_subject_dirs</span>):
        <span class="py-src-variable">return</span> <span class="py-src-variable">None</span>
    <span class="py-src-variable">return</span> <span class="py-src-variable">candidate</span>


<span class="py-src-variable">def</span> <span class="py-src-identifier">normalize_relative_path</span>(<span class="py-src-parameter">path</span>, <span class="py-src-parameter">prefix_to_strip</span>):
    <span class="py-src-string">&quot;&quot;&quot;Normalise an uploaded path so it is safe and relative to the dataset root.&quot;&quot;&quot;</span>
    <span class="py-src-variable">if</span> <span class="py-src-variable">not</span> <span class="py-src-variable">path</span>:
        <span class="py-src-variable">return</span> <span class="py-src-variable">None</span>
    <span class="py-src-variable">cleaned</span> = <span class="py-src-variable">path</span>.<span class="py-src-variable">replace</span>(<span class="py-src-string">&quot;\\&quot;</span>, <span class="py-src-string">&quot;/&quot;</span>).<span class="py-src-variable">lstrip</span>(<span class="py-src-string">&quot;/&quot;</span>)
    <span class="py-src-variable">if</span> <span class="py-src-variable">prefix_to_strip</span>:
        <span class="py-src-variable">prefix</span> = <span class="py-src-variable">prefix_to_strip</span>.<span class="py-src-variable">strip</span>(<span class="py-src-string">&quot;/&quot;</span>)
        <span class="py-src-variable">if</span> <span class="py-src-variable">cleaned</span>.<span class="py-src-variable">startswith</span>(<span class="py-src-variable">prefix</span> + <span class="py-src-string">&quot;/&quot;</span>):
            <span class="py-src-variable">cleaned</span> = <span class="py-src-variable">cleaned</span>[<span class="py-src-variable">len</span>(<span class="py-src-variable">prefix</span>) + <span class="py-src-number">1</span> :]
    <span class="py-src-variable">normalized</span> = <span class="py-src-variable">os</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">normpath</span>(<span class="py-src-variable">cleaned</span>)
    <span class="py-src-variable">normalized</span> = <span class="py-src-variable">normalized</span>.<span class="py-src-variable">replace</span>(<span class="py-src-string">&quot;\\&quot;</span>, <span class="py-src-string">&quot;/&quot;</span>)
    <span class="py-src-variable">if</span> <span class="py-src-variable">normalized</span> <span class="py-src-variable">in</span> (<span class="py-src-string">&quot;&quot;</span>, <span class="py-src-string">&quot;.&quot;</span>):  <span class="py-src-comment"># Directory only</span>
        <span class="py-src-variable">return</span> <span class="py-src-variable">None</span>
    <span class="py-src-variable">if</span> <span class="py-src-variable">normalized</span>.<span class="py-src-variable">startswith</span>(<span class="py-src-string">&quot;..&quot;</span>):
        <span class="py-src-variable">return</span> <span class="py-src-variable">None</span>
    <span class="py-src-variable">return</span> <span class="py-src-variable">normalized</span>


<span class="py-src-variable">def</span> <span class="py-src-identifier">process_folder_upload</span>(<span class="py-src-parameter">files</span>, <span class="py-src-parameter">temp_dir</span>, <span class="py-src-parameter">metadata_paths</span>=<span class="py-src-parameter">None</span>):
    <span class="py-src-string">&quot;&quot;&quot;Process uploaded folder files and recreate directory structure (DataLad-style)

    DataLad-inspired approach: Upload only structure and metadata, create placeholders
    for large data files. This allows full dataset validation without transferring GB of data.
    &quot;&quot;&quot;</span>
    <span class="py-src-variable">dataset_root</span> = <span class="py-src-variable">os</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">join</span>(<span class="py-src-variable">temp_dir</span>, <span class="py-src-string">&quot;dataset&quot;</span>)
    <span class="py-src-variable">os</span>.<span class="py-src-variable">makedirs</span>(<span class="py-src-variable">dataset_root</span>, <span class="py-src-variable">exist_ok</span>=<span class="py-src-variable">True</span>)

    <span class="py-src-variable">processed_count</span> = <span class="py-src-number">0</span>
    <span class="py-src-variable">skipped_count</span> = <span class="py-src-number">0</span>
    <span class="py-src-variable">manifest</span> = {
        <span class="py-src-string">&quot;uploaded_files&quot;</span>: [],
        <span class="py-src-string">&quot;placeholder_files&quot;</span>: [],
        <span class="py-src-string">&quot;upload_type&quot;</span>: <span class="py-src-string">&quot;structure_only&quot;</span>,
        <span class="py-src-string">&quot;timestamp&quot;</span>: <span class="py-src-variable">datetime</span>.<span class="py-src-variable">now</span>().<span class="py-src-variable">isoformat</span>(),
    }

    <span class="py-src-comment"># Get the list of all files (including skipped ones) from form data</span>
    <span class="py-src-variable">all_files_json</span> = <span class="py-src-variable">request</span>.<span class="py-src-variable">form</span>.<span class="py-src-variable">get</span>(<span class="py-src-string">&quot;all_files&quot;</span>)
    <span class="py-src-variable">all_files_list</span> = <span class="py-src-variable">json</span>.<span class="py-src-variable">loads</span>(<span class="py-src-variable">all_files_json</span>) <span class="py-src-variable">if</span> <span class="py-src-variable">all_files_json</span> <span class="py-src-variable">else</span> []
    <span class="py-src-variable">metadata_paths</span> = <span class="py-src-variable">metadata_paths</span> <span class="py-src-variable">or</span> []

    <span class="py-src-variable">candidate_paths</span> = <span class="py-src-variable">list</span>(<span class="py-src-variable">all_files_list</span> <span class="py-src-variable">or</span> [])
    <span class="py-src-variable">if</span> <span class="py-src-variable">metadata_paths</span>:
        <span class="py-src-variable">candidate_paths</span>.<span class="py-src-variable">extend</span>(<span class="py-src-variable">metadata_paths</span>)
    <span class="py-src-variable">else</span>:
        <span class="py-src-variable">candidate_paths</span>.<span class="py-src-variable">extend</span>(
            [<span class="py-src-variable">f</span>.<span class="py-src-variable">filename</span> <span class="py-src-variable">for</span> <span class="py-src-variable">f</span> <span class="py-src-variable">in</span> <span class="py-src-variable">files</span> <span class="py-src-variable">if</span> <span class="py-src-variable">getattr</span>(<span class="py-src-variable">f</span>, <span class="py-src-string">&quot;filename&quot;</span>, <span class="py-src-variable">None</span>)]
        )

    <span class="py-src-variable">prefix_to_strip</span> = <span class="py-src-variable">detect_dataset_prefix</span>(<span class="py-src-variable">candidate_paths</span>)
    <span class="py-src-variable">if</span> <span class="py-src-variable">prefix_to_strip</span>:
        <span class="py-src-variable">print</span>(<span class="py-src-string">f&quot;üìÅ [UPLOAD] Stripping leading folder: {prefix_to_strip}&quot;</span>)

    <span class="py-src-comment"># Create a set of uploaded file paths for quick lookup</span>
    <span class="py-src-variable">uploaded_paths</span> = <span class="py-src-variable">set</span>()

    <span class="py-src-variable">if</span> <span class="py-src-variable">metadata_paths</span> <span class="py-src-variable">and</span> <span class="py-src-variable">len</span>(<span class="py-src-variable">metadata_paths</span>) != <span class="py-src-variable">len</span>(<span class="py-src-variable">files</span>):
        <span class="py-src-variable">print</span>(
            <span class="py-src-string">f&quot;‚ö†Ô∏è  Metadata path count ({len(metadata_paths)}) does not match uploaded files ({len(files)}).&quot;</span>
        )

    <span class="py-src-variable">for</span> <span class="py-src-variable">index</span>, <span class="py-src-variable">file</span> <span class="py-src-variable">in</span> <span class="py-src-variable">enumerate</span>(<span class="py-src-variable">files</span>):
        <span class="py-src-variable">original_path</span> = (
            <span class="py-src-variable">metadata_paths</span>[<span class="py-src-variable">index</span>]
            <span class="py-src-variable">if</span> <span class="py-src-variable">index</span> &lt; <span class="py-src-variable">len</span>(<span class="py-src-variable">metadata_paths</span>)
            <span class="py-src-variable">else</span> <span class="py-src-variable">getattr</span>(<span class="py-src-variable">file</span>, <span class="py-src-string">&quot;filename&quot;</span>, <span class="py-src-string">&quot;&quot;</span>)
        )
        <span class="py-src-variable">if</span> <span class="py-src-variable">not</span> <span class="py-src-variable">original_path</span>:
            <span class="py-src-variable">continue</span>
        <span class="py-src-variable">normalized_path</span> = <span class="py-src-variable">normalize_relative_path</span>(<span class="py-src-variable">original_path</span>, <span class="py-src-variable">prefix_to_strip</span>)
        <span class="py-src-variable">if</span> <span class="py-src-variable">not</span> <span class="py-src-variable">normalized_path</span>:
            <span class="py-src-variable">continue</span>

        <span class="py-src-comment"># Skip system files (like .DS_Store, Thumbs.db, etc.)</span>
        <span class="py-src-variable">filename</span> = <span class="py-src-variable">os</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">basename</span>(<span class="py-src-variable">normalized_path</span>)
        <span class="py-src-variable">try</span>:
            <span class="py-src-variable">if</span> <span class="py-src-variable">is_system_file</span>(<span class="py-src-variable">filename</span>):
                <span class="py-src-variable">continue</span>
        <span class="py-src-variable">except</span> <span class="py-src-variable">NameError</span>:
            <span class="py-src-variable">if</span> <span class="py-src-variable">filename</span>.<span class="py-src-variable">startswith</span>(<span class="py-src-string">&quot;.&quot;</span>) <span class="py-src-variable">and</span> <span class="py-src-variable">filename</span> <span class="py-src-variable">in</span> [
                <span class="py-src-string">&quot;.DS_Store&quot;</span>,
                <span class="py-src-string">&quot;._.DS_Store&quot;</span>,
                <span class="py-src-string">&quot;.Spotlight-V100&quot;</span>,
                <span class="py-src-string">&quot;.Trashes&quot;</span>,
            ]:
                <span class="py-src-variable">continue</span>
            <span class="py-src-variable">if</span> <span class="py-src-variable">filename</span> <span class="py-src-variable">in</span> [<span class="py-src-string">&quot;Thumbs.db&quot;</span>, <span class="py-src-string">&quot;ehthumbs.db&quot;</span>, <span class="py-src-string">&quot;Desktop.ini&quot;</span>]:
                <span class="py-src-variable">continue</span>

        <span class="py-src-variable">uploaded_paths</span>.<span class="py-src-variable">add</span>(<span class="py-src-variable">normalized_path</span>)
        <span class="py-src-variable">file_path</span> = <span class="py-src-variable">os</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">join</span>(<span class="py-src-variable">dataset_root</span>, *<span class="py-src-variable">normalized_path</span>.<span class="py-src-variable">split</span>(<span class="py-src-string">&quot;/&quot;</span>))
        <span class="py-src-variable">target_dir</span> = <span class="py-src-variable">os</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">dirname</span>(<span class="py-src-variable">file_path</span>)
        <span class="py-src-variable">if</span> <span class="py-src-variable">target_dir</span>:
            <span class="py-src-variable">os</span>.<span class="py-src-variable">makedirs</span>(<span class="py-src-variable">target_dir</span>, <span class="py-src-variable">exist_ok</span>=<span class="py-src-variable">True</span>)
        <span class="py-src-variable">file</span>.<span class="py-src-variable">save</span>(<span class="py-src-variable">file_path</span>)
        <span class="py-src-variable">processed_count</span> += <span class="py-src-number">1</span>

        <span class="py-src-variable">manifest</span>[<span class="py-src-string">&quot;uploaded_files&quot;</span>].<span class="py-src-variable">append</span>(
            {
                <span class="py-src-string">&quot;path&quot;</span>: <span class="py-src-variable">normalized_path</span>,
                <span class="py-src-string">&quot;size&quot;</span>: <span class="py-src-variable">file</span>.<span class="py-src-variable">content_length</span> <span class="py-src-variable">or</span> <span class="py-src-number">0</span>,
                <span class="py-src-string">&quot;type&quot;</span>: <span class="py-src-string">&quot;metadata&quot;</span>,
            }
        )

    <span class="py-src-comment"># Create smart placeholders for all files that weren&#x27;t uploaded</span>
    <span class="py-src-variable">for</span> <span class="py-src-variable">relative_path</span> <span class="py-src-variable">in</span> <span class="py-src-variable">all_files_list</span>:
        <span class="py-src-variable">normalized_path</span> = <span class="py-src-variable">normalize_relative_path</span>(<span class="py-src-variable">relative_path</span>, <span class="py-src-variable">prefix_to_strip</span>)
        <span class="py-src-variable">if</span> <span class="py-src-variable">not</span> <span class="py-src-variable">normalized_path</span> <span class="py-src-variable">or</span> <span class="py-src-variable">normalized_path</span> <span class="py-src-variable">in</span> <span class="py-src-variable">uploaded_paths</span>:
            <span class="py-src-variable">continue</span>

        <span class="py-src-variable">filename</span> = <span class="py-src-variable">os</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">basename</span>(<span class="py-src-variable">normalized_path</span>)
        <span class="py-src-variable">try</span>:
            <span class="py-src-variable">if</span> <span class="py-src-variable">is_system_file</span>(<span class="py-src-variable">filename</span>):
                <span class="py-src-variable">continue</span>
        <span class="py-src-variable">except</span> <span class="py-src-variable">NameError</span>:
            <span class="py-src-variable">if</span> <span class="py-src-variable">filename</span>.<span class="py-src-variable">startswith</span>(<span class="py-src-string">&quot;.&quot;</span>) <span class="py-src-variable">and</span> <span class="py-src-variable">filename</span> <span class="py-src-variable">in</span> [
                <span class="py-src-string">&quot;.DS_Store&quot;</span>,
                <span class="py-src-string">&quot;._.DS_Store&quot;</span>,
                <span class="py-src-string">&quot;.Spotlight-V100&quot;</span>,
                <span class="py-src-string">&quot;.Trashes&quot;</span>,
            ]:
                <span class="py-src-variable">continue</span>
            <span class="py-src-variable">if</span> <span class="py-src-variable">filename</span> <span class="py-src-variable">in</span> [<span class="py-src-string">&quot;Thumbs.db&quot;</span>, <span class="py-src-string">&quot;ehthumbs.db&quot;</span>, <span class="py-src-string">&quot;Desktop.ini&quot;</span>]:
                <span class="py-src-variable">continue</span>

        <span class="py-src-variable">file_path</span> = <span class="py-src-variable">os</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">join</span>(<span class="py-src-variable">dataset_root</span>, *<span class="py-src-variable">normalized_path</span>.<span class="py-src-variable">split</span>(<span class="py-src-string">&quot;/&quot;</span>))
        <span class="py-src-variable">target_dir</span> = <span class="py-src-variable">os</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">dirname</span>(<span class="py-src-variable">file_path</span>)
        <span class="py-src-variable">if</span> <span class="py-src-variable">target_dir</span>:
            <span class="py-src-variable">os</span>.<span class="py-src-variable">makedirs</span>(<span class="py-src-variable">target_dir</span>, <span class="py-src-variable">exist_ok</span>=<span class="py-src-variable">True</span>)

        <span class="py-src-variable">lower_path</span> = <span class="py-src-variable">normalized_path</span>.<span class="py-src-variable">lower</span>()
        <span class="py-src-variable">if</span> <span class="py-src-variable">lower_path</span>.<span class="py-src-variable">endswith</span>(<span class="py-src-string">&quot;.nii.gz&quot;</span>):
            <span class="py-src-variable">ext</span> = <span class="py-src-string">&quot;.nii.gz&quot;</span>
        <span class="py-src-variable">else</span>:
            <span class="py-src-variable">_</span>, <span class="py-src-variable">ext</span> = <span class="py-src-variable">os</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">splitext</span>(<span class="py-src-variable">lower_path</span>)
        <span class="py-src-variable">placeholder_content</span> = <span class="py-src-variable">create_placeholder_content</span>(<span class="py-src-variable">normalized_path</span>, <span class="py-src-variable">ext</span>)
        <span class="py-src-variable">with</span> <span class="py-src-variable">open</span>(<span class="py-src-variable">file_path</span>, <span class="py-src-string">&quot;w&quot;</span>) <span class="py-src-variable">as</span> <span class="py-src-variable">f</span>:
            <span class="py-src-variable">f</span>.<span class="py-src-variable">write</span>(<span class="py-src-variable">placeholder_content</span>)
        <span class="py-src-variable">skipped_count</span> += <span class="py-src-number">1</span>

        <span class="py-src-variable">manifest</span>[<span class="py-src-string">&quot;placeholder_files&quot;</span>].<span class="py-src-variable">append</span>(
            {<span class="py-src-string">&quot;path&quot;</span>: <span class="py-src-variable">normalized_path</span>, <span class="py-src-string">&quot;extension&quot;</span>: <span class="py-src-variable">ext</span>, <span class="py-src-string">&quot;type&quot;</span>: <span class="py-src-string">&quot;placeholder&quot;</span>}
        )

    <span class="py-src-comment"># Save manifest file for debugging and transparency</span>
    <span class="py-src-variable">manifest_path</span> = <span class="py-src-variable">os</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">join</span>(<span class="py-src-variable">dataset_root</span>, <span class="py-src-string">&quot;.upload_manifest.json&quot;</span>)
    <span class="py-src-variable">with</span> <span class="py-src-variable">open</span>(<span class="py-src-variable">manifest_path</span>, <span class="py-src-string">&quot;w&quot;</span>) <span class="py-src-variable">as</span> <span class="py-src-variable">f</span>:
        <span class="py-src-variable">json</span>.<span class="py-src-variable">dump</span>(<span class="py-src-variable">manifest</span>, <span class="py-src-variable">f</span>, <span class="py-src-variable">indent</span>=<span class="py-src-number">2</span>)

    <span class="py-src-variable">print</span>(
        <span class="py-src-string">f&quot;üìÅ Processed {processed_count} metadata files, created {skipped_count} placeholders for data files&quot;</span>
    )
    <span class="py-src-variable">print</span>(<span class="py-src-string">&quot;üìÅ [UPLOAD] File tree in temp_dir after upload:&quot;</span>)
    <span class="py-src-variable">for</span> <span class="py-src-variable">root</span>, <span class="py-src-variable">dirs</span>, <span class="py-src-variable">files</span> <span class="py-src-variable">in</span> <span class="py-src-variable">os</span>.<span class="py-src-variable">walk</span>(<span class="py-src-variable">dataset_root</span>):
        <span class="py-src-variable">for</span> <span class="py-src-variable">file</span> <span class="py-src-variable">in</span> <span class="py-src-variable">files</span>:
            <span class="py-src-variable">rel_path</span> = <span class="py-src-variable">os</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">relpath</span>(<span class="py-src-variable">os</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">join</span>(<span class="py-src-variable">root</span>, <span class="py-src-variable">file</span>), <span class="py-src-variable">dataset_root</span>)
            <span class="py-src-variable">print</span>(<span class="py-src-string">f&quot;   {rel_path}&quot;</span>)
    <span class="py-src-variable">return</span> <span class="py-src-variable">dataset_root</span>


<span class="py-src-variable">def</span> <span class="py-src-identifier">process_zip_upload</span>(<span class="py-src-parameter">file</span>, <span class="py-src-parameter">temp_dir</span>, <span class="py-src-parameter">filename</span>):
    <span class="py-src-string">&quot;&quot;&quot;Process uploaded ZIP file

    Extracts only metadata files from ZIP to reduce processing time and storage.
    &quot;&quot;&quot;</span>
    <span class="py-src-variable">file_path</span> = <span class="py-src-variable">os</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">join</span>(<span class="py-src-variable">temp_dir</span>, <span class="py-src-variable">filename</span>)
    <span class="py-src-variable">file</span>.<span class="py-src-variable">save</span>(<span class="py-src-variable">file_path</span>)

    <span class="py-src-variable">processed_count</span> = <span class="py-src-number">0</span>
    <span class="py-src-variable">skipped_count</span> = <span class="py-src-number">0</span>

    <span class="py-src-comment"># Extract ZIP file selectively</span>
    <span class="py-src-variable">with</span> <span class="py-src-variable">zipfile</span>.<span class="py-src-variable">ZipFile</span>(<span class="py-src-variable">file_path</span>, <span class="py-src-string">&quot;r&quot;</span>) <span class="py-src-variable">as</span> <span class="py-src-variable">zip_ref</span>:
        <span class="py-src-variable">for</span> <span class="py-src-variable">zip_info</span> <span class="py-src-variable">in</span> <span class="py-src-variable">zip_ref</span>.<span class="py-src-variable">namelist</span>():
            <span class="py-src-comment"># Skip directories</span>
            <span class="py-src-variable">if</span> <span class="py-src-variable">zip_info</span>.<span class="py-src-variable">endswith</span>(<span class="py-src-string">&quot;/&quot;</span>):
                <span class="py-src-variable">continue</span>

            <span class="py-src-comment"># Check file extension</span>
            <span class="py-src-variable">_</span>, <span class="py-src-variable">ext</span> = <span class="py-src-variable">os</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">splitext</span>(<span class="py-src-variable">zip_info</span>.<span class="py-src-variable">lower</span>())
            <span class="py-src-variable">if</span> <span class="py-src-variable">ext</span> == <span class="py-src-string">&quot;.gz&quot;</span> <span class="py-src-variable">and</span> <span class="py-src-variable">zip_info</span>.<span class="py-src-variable">lower</span>().<span class="py-src-variable">endswith</span>(<span class="py-src-string">&quot;.nii.gz&quot;</span>):
                <span class="py-src-variable">ext</span> = <span class="py-src-string">&quot;.nii.gz&quot;</span>

            <span class="py-src-comment"># Extract metadata files, skip large data files</span>
            <span class="py-src-variable">if</span> <span class="py-src-variable">ext</span> <span class="py-src-variable">in</span> <span class="py-src-variable">METADATA_EXTENSIONS</span> <span class="py-src-variable">or</span> <span class="py-src-variable">ext</span> == <span class="py-src-string">&quot;&quot;</span>:
                <span class="py-src-variable">zip_ref</span>.<span class="py-src-variable">extract</span>(<span class="py-src-variable">zip_info</span>, <span class="py-src-variable">temp_dir</span>)
                <span class="py-src-variable">processed_count</span> += <span class="py-src-number">1</span>
            <span class="py-src-variable">elif</span> <span class="py-src-variable">ext</span> <span class="py-src-variable">in</span> <span class="py-src-variable">SKIP_EXTENSIONS</span>:
                <span class="py-src-comment"># Create empty placeholder</span>
                <span class="py-src-variable">extract_path</span> = <span class="py-src-variable">os</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">join</span>(<span class="py-src-variable">temp_dir</span>, <span class="py-src-variable">zip_info</span>)
                <span class="py-src-variable">os</span>.<span class="py-src-variable">makedirs</span>(<span class="py-src-variable">os</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">dirname</span>(<span class="py-src-variable">extract_path</span>), <span class="py-src-variable">exist_ok</span>=<span class="py-src-variable">True</span>)
                <span class="py-src-variable">with</span> <span class="py-src-variable">open</span>(<span class="py-src-variable">extract_path</span>, <span class="py-src-string">&quot;w&quot;</span>) <span class="py-src-variable">as</span> <span class="py-src-variable">f</span>:
                    <span class="py-src-variable">f</span>.<span class="py-src-variable">write</span>(<span class="py-src-string">&quot;&quot;</span>)
                <span class="py-src-variable">skipped_count</span> += <span class="py-src-number">1</span>

    <span class="py-src-variable">print</span>(
        <span class="py-src-string">f&quot;üì¶ Extracted {processed_count} metadata files, skipped {skipped_count} data files from ZIP&quot;</span>
    )

    <span class="py-src-comment"># Find the actual dataset directory (might be nested)</span>
    <span class="py-src-variable">return</span> <span class="py-src-variable">find_dataset_root</span>(<span class="py-src-variable">temp_dir</span>)


@<span class="py-src-variable">app</span>.<span class="py-src-variable">route</span>(<span class="py-src-string">&quot;/validate_folder&quot;</span>, <span class="py-src-variable">methods</span>=[<span class="py-src-string">&quot;POST&quot;</span>])
<span class="py-src-variable">def</span> <span class="py-src-identifier">validate_folder</span>():
    <span class="py-src-string">&quot;&quot;&quot;Handle local folder validation&quot;&quot;&quot;</span>
    <span class="py-src-variable">folder_path</span> = <span class="py-src-variable">request</span>.<span class="py-src-variable">form</span>.<span class="py-src-variable">get</span>(<span class="py-src-string">&quot;folder_path&quot;</span>, <span class="py-src-string">&quot;&quot;</span>).<span class="py-src-variable">strip</span>()

    <span class="py-src-variable">if</span> <span class="py-src-variable">not</span> <span class="py-src-variable">folder_path</span>:
        <span class="py-src-variable">flash</span>(<span class="py-src-string">&quot;Please provide a folder path&quot;</span>, <span class="py-src-string">&quot;error&quot;</span>)
        <span class="py-src-variable">return</span> <span class="py-src-variable">redirect</span>(<span class="py-src-variable">url_for</span>(<span class="py-src-string">&quot;index&quot;</span>))

    <span class="py-src-variable">if</span> <span class="py-src-variable">not</span> <span class="py-src-variable">os</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">exists</span>(<span class="py-src-variable">folder_path</span>):
        <span class="py-src-variable">flash</span>(<span class="py-src-string">&quot;Folder does not exist&quot;</span>, <span class="py-src-string">&quot;error&quot;</span>)
        <span class="py-src-variable">return</span> <span class="py-src-variable">redirect</span>(<span class="py-src-variable">url_for</span>(<span class="py-src-string">&quot;index&quot;</span>))

    <span class="py-src-variable">if</span> <span class="py-src-variable">not</span> <span class="py-src-variable">os</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">isdir</span>(<span class="py-src-variable">folder_path</span>):
        <span class="py-src-variable">flash</span>(<span class="py-src-string">&quot;Path is not a directory&quot;</span>, <span class="py-src-string">&quot;error&quot;</span>)
        <span class="py-src-variable">return</span> <span class="py-src-variable">redirect</span>(<span class="py-src-variable">url_for</span>(<span class="py-src-string">&quot;index&quot;</span>))

    <span class="py-src-comment"># Get schema version from form</span>
    <span class="py-src-variable">schema_version</span> = <span class="py-src-variable">request</span>.<span class="py-src-variable">form</span>.<span class="py-src-variable">get</span>(<span class="py-src-string">&quot;schema_version&quot;</span>, <span class="py-src-string">&quot;stable&quot;</span>)

    <span class="py-src-variable">try</span>:
        <span class="py-src-comment"># Print validation start info to terminal</span>
        <span class="py-src-variable">print</span>(<span class="py-src-string">f&quot;\nüìÅ [VALIDATE_FOLDER] Validating local directory: {folder_path}&quot;</span>)

        <span class="py-src-comment"># Count files for debug output</span>
        <span class="py-src-variable">file_count</span> = <span class="py-src-number">0</span>
        <span class="py-src-variable">for</span> <span class="py-src-variable">root</span>, <span class="py-src-variable">dirs</span>, <span class="py-src-variable">files</span> <span class="py-src-variable">in</span> <span class="py-src-variable">os</span>.<span class="py-src-variable">walk</span>(<span class="py-src-variable">folder_path</span>):
            <span class="py-src-variable">file_count</span> += <span class="py-src-variable">len</span>([<span class="py-src-variable">f</span> <span class="py-src-variable">for</span> <span class="py-src-variable">f</span> <span class="py-src-variable">in</span> <span class="py-src-variable">files</span> <span class="py-src-variable">if</span> <span class="py-src-variable">not</span> <span class="py-src-variable">is_system_file</span>(<span class="py-src-variable">f</span>)])
        <span class="py-src-variable">print</span>(<span class="py-src-string">f&quot;   Found {file_count} non-system files in directory&quot;</span>)

        <span class="py-src-comment"># Use the core validator when available for direct integration</span>
        <span class="py-src-variable">if</span> <span class="py-src-variable">callable</span>(<span class="py-src-variable">core_validate_dataset</span>):
            <span class="py-src-variable">issues</span>, <span class="py-src-variable">stats</span> = <span class="py-src-variable">core_validate_dataset</span>(
                <span class="py-src-variable">folder_path</span>, <span class="py-src-variable">verbose</span>=<span class="py-src-variable">True</span>, <span class="py-src-variable">schema_version</span>=<span class="py-src-variable">schema_version</span>
            )
        <span class="py-src-variable">else</span>:
            <span class="py-src-variable">issues</span>, <span class="py-src-variable">stats</span> = <span class="py-src-variable">run_main_validator</span>(
                <span class="py-src-variable">folder_path</span>, <span class="py-src-variable">verbose</span>=<span class="py-src-variable">True</span>, <span class="py-src-variable">schema_version</span>=<span class="py-src-variable">schema_version</span>
            )

        <span class="py-src-comment"># Format results for web display</span>
        <span class="py-src-variable">formatted_results</span> = <span class="py-src-variable">format_validation_results</span>(<span class="py-src-variable">issues</span>, <span class="py-src-variable">stats</span>, <span class="py-src-variable">folder_path</span>)
        <span class="py-src-variable">formatted_results</span>[<span class="py-src-string">&quot;schema_version&quot;</span>] = <span class="py-src-variable">schema_version</span>

        <span class="py-src-comment"># Print validation results to terminal</span>
        <span class="py-src-variable">print</span>(<span class="py-src-string">&quot;üìä [VALIDATE_FOLDER] Validation complete:&quot;</span>)
        <span class="py-src-variable">print</span>(<span class="py-src-string">f&quot;   Total files: {formatted_results[&#x27;summary&#x27;][&#x27;total_files&#x27;]}&quot;</span>)
        <span class="py-src-variable">print</span>(<span class="py-src-string">f&quot;   Valid files: {formatted_results[&#x27;summary&#x27;][&#x27;valid_files&#x27;]}&quot;</span>)
        <span class="py-src-variable">print</span>(<span class="py-src-string">f&quot;   Invalid files: {formatted_results[&#x27;summary&#x27;][&#x27;invalid_files&#x27;]}&quot;</span>)
        <span class="py-src-variable">print</span>(<span class="py-src-string">f&quot;   Errors: {formatted_results[&#x27;summary&#x27;][&#x27;total_errors&#x27;]}&quot;</span>)
        <span class="py-src-variable">print</span>(<span class="py-src-string">f&quot;   Warnings: {formatted_results[&#x27;summary&#x27;][&#x27;total_warnings&#x27;]}&quot;</span>)

        <span class="py-src-comment"># Store results</span>
        <span class="py-src-variable">result_id</span> = <span class="py-src-string">f&quot;result_{len(validation_results)}&quot;</span>
        <span class="py-src-variable">validation_results</span>[<span class="py-src-variable">result_id</span>] = {
            <span class="py-src-string">&quot;results&quot;</span>: <span class="py-src-variable">formatted_results</span>,
            <span class="py-src-string">&quot;dataset_path&quot;</span>: <span class="py-src-variable">folder_path</span>,
            <span class="py-src-string">&quot;temp_dir&quot;</span>: <span class="py-src-variable">None</span>,  <span class="py-src-comment"># No temp dir for local folders</span>
            <span class="py-src-string">&quot;filename&quot;</span>: <span class="py-src-variable">os</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">basename</span>(<span class="py-src-variable">folder_path</span>),
        }

        <span class="py-src-variable">return</span> <span class="py-src-variable">redirect</span>(<span class="py-src-variable">url_for</span>(<span class="py-src-string">&quot;show_results&quot;</span>, <span class="py-src-variable">result_id</span>=<span class="py-src-variable">result_id</span>))

    <span class="py-src-variable">except</span> <span class="py-src-variable">Exception</span> <span class="py-src-variable">as</span> <span class="py-src-variable">e</span>:
        <span class="py-src-variable">flash</span>(<span class="py-src-string">f&quot;Error validating dataset: {str(e)}&quot;</span>, <span class="py-src-string">&quot;error&quot;</span>)
        <span class="py-src-variable">return</span> <span class="py-src-variable">redirect</span>(<span class="py-src-variable">url_for</span>(<span class="py-src-string">&quot;index&quot;</span>))


@<span class="py-src-variable">app</span>.<span class="py-src-variable">route</span>(<span class="py-src-string">&quot;/results/&lt;result_id&gt;&quot;</span>)
<span class="py-src-variable">def</span> <span class="py-src-identifier">show_results</span>(<span class="py-src-parameter">result_id</span>):
    <span class="py-src-string">&quot;&quot;&quot;Display validation results&quot;&quot;&quot;</span>
    <span class="py-src-variable">if</span> <span class="py-src-variable">result_id</span> <span class="py-src-variable">not</span> <span class="py-src-variable">in</span> <span class="py-src-variable">validation_results</span>:
        <span class="py-src-variable">flash</span>(<span class="py-src-string">&quot;Results not found&quot;</span>, <span class="py-src-string">&quot;error&quot;</span>)
        <span class="py-src-variable">return</span> <span class="py-src-variable">redirect</span>(<span class="py-src-variable">url_for</span>(<span class="py-src-string">&quot;index&quot;</span>))

    <span class="py-src-variable">data</span> = <span class="py-src-variable">validation_results</span>[<span class="py-src-variable">result_id</span>]
    <span class="py-src-variable">results</span> = <span class="py-src-variable">data</span>[<span class="py-src-string">&quot;results&quot;</span>]

    <span class="py-src-comment"># Get dataset stats if available</span>
    <span class="py-src-variable">dataset_stats</span> = <span class="py-src-variable">None</span>
    <span class="py-src-variable">stats_obj</span> = <span class="py-src-variable">results</span>.<span class="py-src-variable">get</span>(<span class="py-src-string">&quot;dataset_stats&quot;</span>)
    <span class="py-src-variable">if</span> <span class="py-src-variable">stats_obj</span>:
        <span class="py-src-variable">try</span>:
            <span class="py-src-variable">session_entries</span> = <span class="py-src-variable">getattr</span>(<span class="py-src-variable">stats_obj</span>, <span class="py-src-string">&quot;sessions&quot;</span>, <span class="py-src-variable">set</span>()) <span class="py-src-variable">or</span> <span class="py-src-variable">set</span>()
            <span class="py-src-variable">unique_sessions</span> = <span class="py-src-variable">set</span>()
            <span class="py-src-variable">for</span> <span class="py-src-variable">entry</span> <span class="py-src-variable">in</span> <span class="py-src-variable">session_entries</span>:
                <span class="py-src-variable">if</span> <span class="py-src-variable">isinstance</span>(<span class="py-src-variable">entry</span>, <span class="py-src-variable">str</span>) <span class="py-src-variable">and</span> <span class="py-src-string">&quot;/&quot;</span> <span class="py-src-variable">in</span> <span class="py-src-variable">entry</span>:
                    <span class="py-src-variable">unique_sessions</span>.<span class="py-src-variable">add</span>(<span class="py-src-variable">entry</span>.<span class="py-src-variable">split</span>(<span class="py-src-string">&quot;/&quot;</span>, <span class="py-src-number">1</span>)[<span class="py-src-number">1</span>])
                <span class="py-src-variable">elif</span> <span class="py-src-variable">entry</span>:
                    <span class="py-src-variable">unique_sessions</span>.<span class="py-src-variable">add</span>(<span class="py-src-variable">entry</span>)

            <span class="py-src-variable">dataset_stats</span> = {
                <span class="py-src-string">&quot;total_subjects&quot;</span>: <span class="py-src-variable">len</span>(<span class="py-src-variable">getattr</span>(<span class="py-src-variable">stats_obj</span>, <span class="py-src-string">&quot;subjects&quot;</span>, [])),
                <span class="py-src-string">&quot;total_sessions&quot;</span>: <span class="py-src-variable">len</span>(<span class="py-src-variable">unique_sessions</span>),
                <span class="py-src-string">&quot;modalities&quot;</span>: <span class="py-src-variable">getattr</span>(<span class="py-src-variable">stats_obj</span>, <span class="py-src-string">&quot;modalities&quot;</span>, {}),
                <span class="py-src-string">&quot;tasks&quot;</span>: <span class="py-src-variable">sorted</span>(<span class="py-src-variable">getattr</span>(<span class="py-src-variable">stats_obj</span>, <span class="py-src-string">&quot;tasks&quot;</span>, [])),
                <span class="py-src-string">&quot;total_files&quot;</span>: <span class="py-src-variable">getattr</span>(<span class="py-src-variable">stats_obj</span>, <span class="py-src-string">&quot;total_files&quot;</span>, <span class="py-src-number">0</span>),
                <span class="py-src-string">&quot;sidecar_files&quot;</span>: <span class="py-src-variable">getattr</span>(<span class="py-src-variable">stats_obj</span>, <span class="py-src-string">&quot;sidecar_files&quot;</span>, <span class="py-src-number">0</span>),
            }
        <span class="py-src-variable">except</span> <span class="py-src-variable">Exception</span> <span class="py-src-variable">as</span> <span class="py-src-variable">stats_error</span>:
            <span class="py-src-variable">print</span>(<span class="py-src-string">f&quot;‚ö†Ô∏è  Failed to prepare dataset stats for display: {stats_error}&quot;</span>)

    <span class="py-src-variable">return</span> <span class="py-src-variable">render_template</span>(
        <span class="py-src-string">&quot;results.html&quot;</span>,
        <span class="py-src-variable">results</span>=<span class="py-src-variable">results</span>,
        <span class="py-src-variable">result_id</span>=<span class="py-src-variable">result_id</span>,
        <span class="py-src-variable">filename</span>=<span class="py-src-variable">data</span>[<span class="py-src-string">&quot;filename&quot;</span>],
        <span class="py-src-variable">dataset_stats</span>=<span class="py-src-variable">dataset_stats</span>,
        <span class="py-src-variable">shorten_path</span>=<span class="py-src-variable">shorten_path</span>,
        <span class="py-src-variable">get_filename_from_path</span>=<span class="py-src-variable">get_filename_from_path</span>,
        <span class="py-src-variable">get_error_documentation_url</span>=<span class="py-src-variable">get_error_documentation_url</span>,
    )


@<span class="py-src-variable">app</span>.<span class="py-src-variable">route</span>(<span class="py-src-string">&quot;/download_report/&lt;result_id&gt;&quot;</span>)
<span class="py-src-variable">def</span> <span class="py-src-identifier">download_report</span>(<span class="py-src-parameter">result_id</span>):
    <span class="py-src-string">&quot;&quot;&quot;Download validation report as JSON&quot;&quot;&quot;</span>
    <span class="py-src-variable">if</span> <span class="py-src-variable">result_id</span> <span class="py-src-variable">not</span> <span class="py-src-variable">in</span> <span class="py-src-variable">validation_results</span>:
        <span class="py-src-variable">flash</span>(<span class="py-src-string">&quot;Results not found&quot;</span>, <span class="py-src-string">&quot;error&quot;</span>)
        <span class="py-src-variable">return</span> <span class="py-src-variable">redirect</span>(<span class="py-src-variable">url_for</span>(<span class="py-src-string">&quot;index&quot;</span>))

    <span class="py-src-variable">data</span> = <span class="py-src-variable">validation_results</span>[<span class="py-src-variable">result_id</span>]
    <span class="py-src-variable">results</span> = <span class="py-src-variable">data</span>[<span class="py-src-string">&quot;results&quot;</span>]

    <span class="py-src-comment"># Create JSON report</span>
    <span class="py-src-variable">report</span> = {
        <span class="py-src-string">&quot;dataset&quot;</span>: <span class="py-src-variable">data</span>[<span class="py-src-string">&quot;filename&quot;</span>],
        <span class="py-src-string">&quot;validation_timestamp&quot;</span>: <span class="py-src-variable">results</span>.<span class="py-src-variable">get</span>(<span class="py-src-string">&quot;timestamp&quot;</span>, <span class="py-src-string">&quot;&quot;</span>),
        <span class="py-src-string">&quot;summary&quot;</span>: {
            <span class="py-src-string">&quot;total_files&quot;</span>: <span class="py-src-variable">len</span>(<span class="py-src-variable">results</span>.<span class="py-src-variable">get</span>(<span class="py-src-string">&quot;valid_files&quot;</span>, []))
            + <span class="py-src-variable">len</span>(<span class="py-src-variable">results</span>.<span class="py-src-variable">get</span>(<span class="py-src-string">&quot;invalid_files&quot;</span>, [])),
            <span class="py-src-string">&quot;valid_files&quot;</span>: <span class="py-src-variable">len</span>(<span class="py-src-variable">results</span>.<span class="py-src-variable">get</span>(<span class="py-src-string">&quot;valid_files&quot;</span>, [])),
            <span class="py-src-string">&quot;invalid_files&quot;</span>: <span class="py-src-variable">len</span>(<span class="py-src-variable">results</span>.<span class="py-src-variable">get</span>(<span class="py-src-string">&quot;invalid_files&quot;</span>, [])),
            <span class="py-src-string">&quot;total_errors&quot;</span>: <span class="py-src-variable">len</span>(<span class="py-src-variable">results</span>.<span class="py-src-variable">get</span>(<span class="py-src-string">&quot;errors&quot;</span>, [])),
            <span class="py-src-string">&quot;total_warnings&quot;</span>: <span class="py-src-variable">len</span>(<span class="py-src-variable">results</span>.<span class="py-src-variable">get</span>(<span class="py-src-string">&quot;warnings&quot;</span>, [])),
        },
        <span class="py-src-string">&quot;results&quot;</span>: <span class="py-src-variable">results</span>,
    }

    <span class="py-src-comment"># Create in-memory file</span>
    <span class="py-src-variable">output</span> = <span class="py-src-variable">io</span>.<span class="py-src-variable">BytesIO</span>()
    <span class="py-src-variable">output</span>.<span class="py-src-variable">write</span>(<span class="py-src-variable">json</span>.<span class="py-src-variable">dumps</span>(<span class="py-src-variable">report</span>, <span class="py-src-variable">indent</span>=<span class="py-src-number">2</span>).<span class="py-src-variable">encode</span>(<span class="py-src-string">&quot;utf-8&quot;</span>))
    <span class="py-src-variable">output</span>.<span class="py-src-variable">seek</span>(<span class="py-src-number">0</span>)

    <span class="py-src-variable">return</span> <span class="py-src-variable">send_file</span>(
        <span class="py-src-variable">output</span>,
        <span class="py-src-variable">mimetype</span>=<span class="py-src-string">&quot;application/json&quot;</span>,
        <span class="py-src-variable">as_attachment</span>=<span class="py-src-variable">True</span>,
        <span class="py-src-variable">download_name</span>=<span class="py-src-string">f&#x27;validation_report_{data[&quot;filename&quot;]}.json&#x27;</span>,
    )


@<span class="py-src-variable">app</span>.<span class="py-src-variable">route</span>(<span class="py-src-string">&quot;/cleanup/&lt;result_id&gt;&quot;</span>)
<span class="py-src-variable">def</span> <span class="py-src-identifier">cleanup</span>(<span class="py-src-parameter">result_id</span>):
    <span class="py-src-string">&quot;&quot;&quot;Clean up temporary files&quot;&quot;&quot;</span>
    <span class="py-src-variable">if</span> <span class="py-src-variable">result_id</span> <span class="py-src-variable">in</span> <span class="py-src-variable">validation_results</span>:
        <span class="py-src-variable">data</span> = <span class="py-src-variable">validation_results</span>[<span class="py-src-variable">result_id</span>]
        <span class="py-src-variable">if</span> <span class="py-src-variable">data</span>[<span class="py-src-string">&quot;temp_dir&quot;</span>] <span class="py-src-variable">and</span> <span class="py-src-variable">os</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">exists</span>(<span class="py-src-variable">data</span>[<span class="py-src-string">&quot;temp_dir&quot;</span>]):
            <span class="py-src-variable">shutil</span>.<span class="py-src-variable">rmtree</span>(<span class="py-src-variable">data</span>[<span class="py-src-string">&quot;temp_dir&quot;</span>], <span class="py-src-variable">ignore_errors</span>=<span class="py-src-variable">True</span>)
        <span class="py-src-variable">del</span> <span class="py-src-variable">validation_results</span>[<span class="py-src-variable">result_id</span>]

    <span class="py-src-variable">flash</span>(<span class="py-src-string">&quot;Results cleaned up&quot;</span>, <span class="py-src-string">&quot;success&quot;</span>)
    <span class="py-src-variable">return</span> <span class="py-src-variable">redirect</span>(<span class="py-src-variable">url_for</span>(<span class="py-src-string">&quot;index&quot;</span>))


@<span class="py-src-variable">app</span>.<span class="py-src-variable">route</span>(<span class="py-src-string">&quot;/api/validate&quot;</span>, <span class="py-src-variable">methods</span>=[<span class="py-src-string">&quot;POST&quot;</span>])
<span class="py-src-variable">def</span> <span class="py-src-identifier">api_validate</span>():
    <span class="py-src-string">&quot;&quot;&quot;API endpoint for validation (for programmatic access)&quot;&quot;&quot;</span>
    <span class="py-src-variable">try</span>:
        <span class="py-src-variable">data</span> = <span class="py-src-variable">request</span>.<span class="py-src-variable">get_json</span>()
        <span class="py-src-variable">if</span> <span class="py-src-variable">not</span> <span class="py-src-variable">data</span> <span class="py-src-variable">or</span> <span class="py-src-string">&quot;dataset_path&quot;</span> <span class="py-src-variable">not</span> <span class="py-src-variable">in</span> <span class="py-src-variable">data</span>:
            <span class="py-src-variable">return</span> <span class="py-src-variable">jsonify</span>({<span class="py-src-string">&quot;error&quot;</span>: <span class="py-src-string">&quot;Missing dataset_path parameter&quot;</span>}), <span class="py-src-number">400</span>

        <span class="py-src-variable">dataset_path</span> = <span class="py-src-variable">data</span>[<span class="py-src-string">&quot;dataset_path&quot;</span>]
        <span class="py-src-variable">if</span> <span class="py-src-variable">not</span> <span class="py-src-variable">os</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">exists</span>(<span class="py-src-variable">dataset_path</span>):
            <span class="py-src-variable">return</span> <span class="py-src-variable">jsonify</span>({<span class="py-src-string">&quot;error&quot;</span>: <span class="py-src-string">&quot;Dataset path does not exist&quot;</span>}), <span class="py-src-number">400</span>

        <span class="py-src-comment"># Use main validator script</span>
        <span class="py-src-variable">issues</span>, <span class="py-src-variable">stats</span> = <span class="py-src-variable">run_main_validator</span>(<span class="py-src-variable">dataset_path</span>, <span class="py-src-variable">verbose</span>=<span class="py-src-variable">False</span>)
        <span class="py-src-variable">results</span> = <span class="py-src-variable">format_validation_results</span>(<span class="py-src-variable">issues</span>, <span class="py-src-variable">stats</span>, <span class="py-src-variable">dataset_path</span>)

        <span class="py-src-variable">return</span> <span class="py-src-variable">jsonify</span>(<span class="py-src-variable">results</span>)

    <span class="py-src-variable">except</span> <span class="py-src-variable">Exception</span> <span class="py-src-variable">as</span> <span class="py-src-variable">e</span>:
        <span class="py-src-variable">return</span> <span class="py-src-variable">jsonify</span>({<span class="py-src-string">&quot;error&quot;</span>: <span class="py-src-variable">str</span>(<span class="py-src-variable">e</span>)}), <span class="py-src-number">500</span>


<span class="py-src-variable">def</span> <span class="py-src-identifier">find_dataset_root</span>(<span class="py-src-parameter">extract_dir</span>):
    <span class="py-src-string">&quot;&quot;&quot;Find the actual dataset root directory after extraction&quot;&quot;&quot;</span>
    <span class="py-src-comment"># Look for dataset_description.json or typical BIDS structure</span>
    <span class="py-src-variable">for</span> <span class="py-src-variable">root</span>, <span class="py-src-variable">dirs</span>, <span class="py-src-variable">files</span> <span class="py-src-variable">in</span> <span class="py-src-variable">os</span>.<span class="py-src-variable">walk</span>(<span class="py-src-variable">extract_dir</span>):
        <span class="py-src-variable">if</span> <span class="py-src-string">&quot;dataset_description.json&quot;</span> <span class="py-src-variable">in</span> <span class="py-src-variable">files</span>:
            <span class="py-src-variable">return</span> <span class="py-src-variable">root</span>
        <span class="py-src-comment"># Look for subject directories</span>
        <span class="py-src-variable">if</span> <span class="py-src-variable">any</span>(<span class="py-src-variable">d</span>.<span class="py-src-variable">startswith</span>(<span class="py-src-string">&quot;sub-&quot;</span>) <span class="py-src-variable">for</span> <span class="py-src-variable">d</span> <span class="py-src-variable">in</span> <span class="py-src-variable">dirs</span>):
            <span class="py-src-variable">return</span> <span class="py-src-variable">root</span>

    <span class="py-src-comment"># If no clear dataset structure, return the extraction directory</span>
    <span class="py-src-variable">return</span> <span class="py-src-variable">extract_dir</span>


<span class="py-src-variable">def</span> <span class="py-src-identifier">main</span>():
    <span class="py-src-string">&quot;&quot;&quot;Run the web application&quot;&quot;&quot;</span>
    <span class="py-src-variable">import</span> <span class="py-src-variable">argparse</span>

    <span class="py-src-variable">parser</span> = <span class="py-src-variable">argparse</span>.<span class="py-src-variable">ArgumentParser</span>(<span class="py-src-variable">description</span>=<span class="py-src-string">&quot;Prism-Validator Web Interface&quot;</span>)
    <span class="py-src-variable">parser</span>.<span class="py-src-variable">add_argument</span>(
        <span class="py-src-string">&quot;--host&quot;</span>, <span class="py-src-variable">default</span>=<span class="py-src-string">&quot;127.0.0.1&quot;</span>, <span class="py-src-variable">help</span>=<span class="py-src-string">&quot;Host to bind to (default: 127.0.0.1)&quot;</span>
    )
    <span class="py-src-variable">parser</span>.<span class="py-src-variable">add_argument</span>(
        <span class="py-src-string">&quot;--port&quot;</span>,
        <span class="py-src-variable">type</span>=<span class="py-src-variable">int</span>,
        <span class="py-src-variable">default</span>=<span class="py-src-number">5001</span>,
        <span class="py-src-variable">help</span>=<span class="py-src-string">&quot;Port to bind to (default: 5001, avoiding macOS Control Center on port 5000)&quot;</span>,
    )
    <span class="py-src-variable">parser</span>.<span class="py-src-variable">add_argument</span>(<span class="py-src-string">&quot;--debug&quot;</span>, <span class="py-src-variable">action</span>=<span class="py-src-string">&quot;store_true&quot;</span>, <span class="py-src-variable">help</span>=<span class="py-src-string">&quot;Run in debug mode&quot;</span>)
    <span class="py-src-variable">parser</span>.<span class="py-src-variable">add_argument</span>(
        <span class="py-src-string">&quot;--public&quot;</span>,
        <span class="py-src-variable">action</span>=<span class="py-src-string">&quot;store_true&quot;</span>,
        <span class="py-src-variable">help</span>=<span class="py-src-string">&quot;Allow external connections (sets host to 0.0.0.0)&quot;</span>,
    )
    <span class="py-src-variable">parser</span>.<span class="py-src-variable">add_argument</span>(
        <span class="py-src-string">&quot;--no-browser&quot;</span>,
        <span class="py-src-variable">action</span>=<span class="py-src-string">&quot;store_true&quot;</span>,
        <span class="py-src-variable">help</span>=<span class="py-src-string">&quot;Do not automatically open browser&quot;</span>,
    )

    <span class="py-src-variable">args</span> = <span class="py-src-variable">parser</span>.<span class="py-src-variable">parse_args</span>()

    <span class="py-src-variable">host</span> = <span class="py-src-string">&quot;0.0.0.0&quot;</span> <span class="py-src-variable">if</span> <span class="py-src-variable">args</span>.<span class="py-src-variable">public</span> <span class="py-src-variable">else</span> <span class="py-src-variable">args</span>.<span class="py-src-variable">host</span>
    <span class="py-src-variable">display_host</span> = <span class="py-src-string">&quot;localhost&quot;</span> <span class="py-src-variable">if</span> <span class="py-src-variable">host</span> == <span class="py-src-string">&quot;127.0.0.1&quot;</span> <span class="py-src-variable">else</span> <span class="py-src-variable">host</span>
    <span class="py-src-variable">url</span> = <span class="py-src-string">f&quot;http://{display_host}:{args.port}&quot;</span>

    <span class="py-src-variable">print</span>(<span class="py-src-string">&quot;üåê Starting Prism-Validator Web Interface&quot;</span>)
    <span class="py-src-variable">print</span>(<span class="py-src-string">f&quot;üîó URL: {url}&quot;</span>)
    <span class="py-src-variable">if</span> <span class="py-src-variable">args</span>.<span class="py-src-variable">public</span>:
        <span class="py-src-variable">print</span>(<span class="py-src-string">&quot;‚ö†Ô∏è  Warning: Running in public mode - accessible from other computers&quot;</span>)
    <span class="py-src-variable">print</span>(<span class="py-src-string">&quot;üí° Press Ctrl+C to stop the server&quot;</span>)
    <span class="py-src-variable">print</span>()

    <span class="py-src-comment"># Open browser in a separate thread to avoid blocking the Flask server</span>
    <span class="py-src-variable">if</span> <span class="py-src-variable">not</span> <span class="py-src-variable">args</span>.<span class="py-src-variable">no_browser</span>:

        <span class="py-src-variable">def</span> <span class="py-src-identifier">open_browser</span>():
            <span class="py-src-variable">import</span> <span class="py-src-variable">time</span>

            <span class="py-src-variable">time</span>.<span class="py-src-variable">sleep</span>(<span class="py-src-number">1</span>)  <span class="py-src-comment"># Wait for server to start</span>
            <span class="py-src-variable">try</span>:
                <span class="py-src-variable">webbrowser</span>.<span class="py-src-variable">open</span>(<span class="py-src-variable">url</span>)
                <span class="py-src-variable">print</span>(<span class="py-src-string">&quot;‚úÖ Browser opened automatically&quot;</span>)
            <span class="py-src-variable">except</span> <span class="py-src-variable">Exception</span> <span class="py-src-variable">as</span> <span class="py-src-variable">e</span>:
                <span class="py-src-variable">print</span>(<span class="py-src-string">f&quot;‚ÑπÔ∏è  Could not open browser automatically: {e}&quot;</span>)
                <span class="py-src-variable">print</span>(<span class="py-src-string">f&quot;   Please visit {url} manually&quot;</span>)

        <span class="py-src-variable">browser_thread</span> = <span class="py-src-variable">threading</span>.<span class="py-src-variable">Thread</span>(<span class="py-src-variable">target</span>=<span class="py-src-variable">open_browser</span>, <span class="py-src-variable">daemon</span>=<span class="py-src-variable">True</span>)
        <span class="py-src-variable">browser_thread</span>.<span class="py-src-variable">start</span>()

    <span class="py-src-variable">app</span>.<span class="py-src-variable">run</span>(<span class="py-src-variable">host</span>=<span class="py-src-variable">host</span>, <span class="py-src-variable">port</span>=<span class="py-src-variable">args</span>.<span class="py-src-variable">port</span>, <span class="py-src-variable">debug</span>=<span class="py-src-variable">args</span>.<span class="py-src-variable">debug</span>)


@<span class="py-src-variable">app</span>.<span class="py-src-variable">route</span>(<span class="py-src-string">&quot;/survey-generator&quot;</span>)
<span class="py-src-variable">def</span> <span class="py-src-identifier">survey_generator</span>():
    <span class="py-src-string">&quot;&quot;&quot;Survey generator page&quot;&quot;&quot;</span>
    <span class="py-src-variable">return</span> <span class="py-src-variable">render_template</span>(<span class="py-src-string">&quot;survey_generator.html&quot;</span>)


@<span class="py-src-variable">app</span>.<span class="py-src-variable">route</span>(<span class="py-src-string">&quot;/api/save-survey-template&quot;</span>, <span class="py-src-variable">methods</span>=[<span class="py-src-string">&quot;POST&quot;</span>])
<span class="py-src-variable">def</span> <span class="py-src-identifier">save_survey_template</span>():
    <span class="py-src-string">&quot;&quot;&quot;Save a survey template to the templates/surveys directory&quot;&quot;&quot;</span>
    <span class="py-src-variable">try</span>:
        <span class="py-src-variable">data</span> = <span class="py-src-variable">request</span>.<span class="py-src-variable">get_json</span>()
        <span class="py-src-variable">if</span> <span class="py-src-variable">not</span> <span class="py-src-variable">data</span> <span class="py-src-variable">or</span> <span class="py-src-string">&quot;name&quot;</span> <span class="py-src-variable">not</span> <span class="py-src-variable">in</span> <span class="py-src-variable">data</span> <span class="py-src-variable">or</span> <span class="py-src-string">&quot;data&quot;</span> <span class="py-src-variable">not</span> <span class="py-src-variable">in</span> <span class="py-src-variable">data</span>:
            <span class="py-src-variable">return</span> <span class="py-src-variable">jsonify</span>({<span class="py-src-string">&quot;success&quot;</span>: <span class="py-src-variable">False</span>, <span class="py-src-string">&quot;error&quot;</span>: <span class="py-src-string">&quot;Invalid data&quot;</span>}), <span class="py-src-number">400</span>

        <span class="py-src-variable">name</span> = <span class="py-src-variable">secure_filename</span>(<span class="py-src-variable">data</span>[<span class="py-src-string">&quot;name&quot;</span>])
        <span class="py-src-variable">if</span> <span class="py-src-variable">not</span> <span class="py-src-variable">name</span>.<span class="py-src-variable">endswith</span>(<span class="py-src-string">&quot;.json&quot;</span>):
            <span class="py-src-variable">name</span> += <span class="py-src-string">&quot;.json&quot;</span>

        <span class="py-src-comment"># Ensure templates/surveys directory exists</span>
        <span class="py-src-variable">template_dir</span> = <span class="py-src-variable">os</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">join</span>(<span class="py-src-variable">os</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">dirname</span>(<span class="py-src-variable">__file__</span>), <span class="py-src-string">&quot;templates&quot;</span>, <span class="py-src-string">&quot;surveys&quot;</span>)
        <span class="py-src-variable">os</span>.<span class="py-src-variable">makedirs</span>(<span class="py-src-variable">template_dir</span>, <span class="py-src-variable">exist_ok</span>=<span class="py-src-variable">True</span>)

        <span class="py-src-variable">file_path</span> = <span class="py-src-variable">os</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">join</span>(<span class="py-src-variable">template_dir</span>, <span class="py-src-variable">name</span>)

        <span class="py-src-variable">with</span> <span class="py-src-variable">open</span>(<span class="py-src-variable">file_path</span>, <span class="py-src-string">&quot;w&quot;</span>) <span class="py-src-variable">as</span> <span class="py-src-variable">f</span>:
            <span class="py-src-variable">json</span>.<span class="py-src-variable">dump</span>(<span class="py-src-variable">data</span>[<span class="py-src-string">&quot;data&quot;</span>], <span class="py-src-variable">f</span>, <span class="py-src-variable">indent</span>=<span class="py-src-number">2</span>)

        <span class="py-src-variable">return</span> <span class="py-src-variable">jsonify</span>({<span class="py-src-string">&quot;success&quot;</span>: <span class="py-src-variable">True</span>, <span class="py-src-string">&quot;filename&quot;</span>: <span class="py-src-variable">name</span>})

    <span class="py-src-variable">except</span> <span class="py-src-variable">Exception</span> <span class="py-src-variable">as</span> <span class="py-src-variable">e</span>:
        <span class="py-src-variable">return</span> <span class="py-src-variable">jsonify</span>({<span class="py-src-string">&quot;success&quot;</span>: <span class="py-src-variable">False</span>, <span class="py-src-string">&quot;error&quot;</span>: <span class="py-src-variable">str</span>(<span class="py-src-variable">e</span>)}), <span class="py-src-number">500</span>


@<span class="py-src-variable">app</span>.<span class="py-src-variable">route</span>(<span class="py-src-string">&quot;/api/list-survey-templates&quot;</span>)
<span class="py-src-variable">def</span> <span class="py-src-identifier">list_survey_templates</span>():
    <span class="py-src-string">&quot;&quot;&quot;List available survey templates&quot;&quot;&quot;</span>
    <span class="py-src-variable">try</span>:
        <span class="py-src-variable">template_dir</span> = <span class="py-src-variable">os</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">join</span>(<span class="py-src-variable">os</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">dirname</span>(<span class="py-src-variable">__file__</span>), <span class="py-src-string">&quot;templates&quot;</span>, <span class="py-src-string">&quot;surveys&quot;</span>)
        <span class="py-src-variable">if</span> <span class="py-src-variable">not</span> <span class="py-src-variable">os</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">exists</span>(<span class="py-src-variable">template_dir</span>):
            <span class="py-src-variable">return</span> <span class="py-src-variable">jsonify</span>({<span class="py-src-string">&quot;templates&quot;</span>: []})

        <span class="py-src-variable">templates</span> = [<span class="py-src-variable">f</span> <span class="py-src-variable">for</span> <span class="py-src-variable">f</span> <span class="py-src-variable">in</span> <span class="py-src-variable">os</span>.<span class="py-src-variable">listdir</span>(<span class="py-src-variable">template_dir</span>) <span class="py-src-variable">if</span> <span class="py-src-variable">f</span>.<span class="py-src-variable">endswith</span>(<span class="py-src-string">&quot;.json&quot;</span>)]
        <span class="py-src-variable">return</span> <span class="py-src-variable">jsonify</span>({<span class="py-src-string">&quot;templates&quot;</span>: <span class="py-src-variable">sorted</span>(<span class="py-src-variable">templates</span>)})
    <span class="py-src-variable">except</span> <span class="py-src-variable">Exception</span> <span class="py-src-variable">as</span> <span class="py-src-variable">e</span>:
        <span class="py-src-variable">return</span> <span class="py-src-variable">jsonify</span>({<span class="py-src-string">&quot;error&quot;</span>: <span class="py-src-variable">str</span>(<span class="py-src-variable">e</span>)}), <span class="py-src-number">500</span>


@<span class="py-src-variable">app</span>.<span class="py-src-variable">route</span>(<span class="py-src-string">&quot;/api/load-survey-template/&lt;filename&gt;&quot;</span>)
<span class="py-src-variable">def</span> <span class="py-src-identifier">load_survey_template</span>(<span class="py-src-parameter">filename</span>):
    <span class="py-src-string">&quot;&quot;&quot;Load a specific survey template&quot;&quot;&quot;</span>
    <span class="py-src-variable">try</span>:
        <span class="py-src-variable">template_dir</span> = <span class="py-src-variable">os</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">join</span>(<span class="py-src-variable">os</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">dirname</span>(<span class="py-src-variable">__file__</span>), <span class="py-src-string">&quot;templates&quot;</span>, <span class="py-src-string">&quot;surveys&quot;</span>)
        <span class="py-src-variable">filename</span> = <span class="py-src-variable">secure_filename</span>(<span class="py-src-variable">filename</span>)
        <span class="py-src-variable">file_path</span> = <span class="py-src-variable">os</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">join</span>(<span class="py-src-variable">template_dir</span>, <span class="py-src-variable">filename</span>)

        <span class="py-src-variable">if</span> <span class="py-src-variable">not</span> <span class="py-src-variable">os</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">exists</span>(<span class="py-src-variable">file_path</span>):
            <span class="py-src-variable">return</span> <span class="py-src-variable">jsonify</span>({<span class="py-src-string">&quot;error&quot;</span>: <span class="py-src-string">&quot;Template not found&quot;</span>}), <span class="py-src-number">404</span>

        <span class="py-src-variable">with</span> <span class="py-src-variable">open</span>(<span class="py-src-variable">file_path</span>, <span class="py-src-string">&quot;r&quot;</span>) <span class="py-src-variable">as</span> <span class="py-src-variable">f</span>:
            <span class="py-src-variable">data</span> = <span class="py-src-variable">json</span>.<span class="py-src-variable">load</span>(<span class="py-src-variable">f</span>)

        <span class="py-src-variable">return</span> <span class="py-src-variable">jsonify</span>({<span class="py-src-string">&quot;data&quot;</span>: <span class="py-src-variable">data</span>})
    <span class="py-src-variable">except</span> <span class="py-src-variable">Exception</span> <span class="py-src-variable">as</span> <span class="py-src-variable">e</span>:
        <span class="py-src-variable">return</span> <span class="py-src-variable">jsonify</span>({<span class="py-src-string">&quot;error&quot;</span>: <span class="py-src-variable">str</span>(<span class="py-src-variable">e</span>)}), <span class="py-src-number">500</span>


@<span class="py-src-variable">app</span>.<span class="py-src-variable">route</span>(<span class="py-src-string">&quot;/api/browse-folder&quot;</span>)
<span class="py-src-variable">def</span> <span class="py-src-identifier">browse_folder</span>():
    <span class="py-src-string">&quot;&quot;&quot;Open a system dialog to select a folder&quot;&quot;&quot;</span>
    <span class="py-src-variable">try</span>:
        <span class="py-src-variable">import</span> <span class="py-src-variable">tkinter</span> <span class="py-src-variable">as</span> <span class="py-src-variable">tk</span>
        <span class="py-src-variable">from</span> <span class="py-src-variable">tkinter</span> <span class="py-src-variable">import</span> <span class="py-src-variable">filedialog</span>
        
        <span class="py-src-comment"># Create a root window and hide it</span>
        <span class="py-src-variable">root</span> = <span class="py-src-variable">tk</span>.<span class="py-src-variable">Tk</span>()
        <span class="py-src-variable">root</span>.<span class="py-src-variable">withdraw</span>()
        
        <span class="py-src-comment"># Make it appear on top</span>
        <span class="py-src-variable">root</span>.<span class="py-src-variable">attributes</span>(<span class="py-src-string">&#x27;-topmost&#x27;</span>, <span class="py-src-variable">True</span>)
        
        <span class="py-src-variable">folder_path</span> = <span class="py-src-variable">filedialog</span>.<span class="py-src-variable">askdirectory</span>()
        
        <span class="py-src-variable">root</span>.<span class="py-src-variable">destroy</span>()
        
        <span class="py-src-variable">if</span> <span class="py-src-variable">folder_path</span>:
            <span class="py-src-variable">return</span> <span class="py-src-variable">jsonify</span>({<span class="py-src-string">&quot;path&quot;</span>: <span class="py-src-variable">folder_path</span>})
        <span class="py-src-variable">else</span>:
            <span class="py-src-variable">return</span> <span class="py-src-variable">jsonify</span>({<span class="py-src-string">&quot;path&quot;</span>: <span class="py-src-string">&quot;&quot;</span>}) <span class="py-src-comment"># User cancelled</span>
            
    <span class="py-src-variable">except</span> <span class="py-src-variable">Exception</span> <span class="py-src-variable">as</span> <span class="py-src-variable">e</span>:
        <span class="py-src-variable">print</span>(<span class="py-src-string">f&quot;Error opening file dialog: {e}&quot;</span>)
        <span class="py-src-variable">return</span> <span class="py-src-variable">jsonify</span>({<span class="py-src-string">&quot;error&quot;</span>: <span class="py-src-string">&quot;Could not open file dialog. Please enter path manually.&quot;</span>}), <span class="py-src-number">500</span>


@<span class="py-src-variable">app</span>.<span class="py-src-variable">route</span>(<span class="py-src-string">&quot;/api/list-library-files&quot;</span>)
<span class="py-src-variable">def</span> <span class="py-src-identifier">list_library_files</span>():
    <span class="py-src-string">&quot;&quot;&quot;List JSON files in a user-specified library path&quot;&quot;&quot;</span>
    <span class="py-src-variable">library_path</span> = <span class="py-src-variable">request</span>.<span class="py-src-variable">args</span>.<span class="py-src-variable">get</span>(<span class="py-src-string">&quot;path&quot;</span>)
    <span class="py-src-variable">if</span> <span class="py-src-variable">not</span> <span class="py-src-variable">library_path</span>:
        <span class="py-src-variable">return</span> <span class="py-src-variable">jsonify</span>({<span class="py-src-string">&quot;error&quot;</span>: <span class="py-src-string">&quot;Path parameter is required&quot;</span>}), <span class="py-src-number">400</span>
    
    <span class="py-src-variable">if</span> <span class="py-src-variable">not</span> <span class="py-src-variable">os</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">exists</span>(<span class="py-src-variable">library_path</span>):
        <span class="py-src-variable">return</span> <span class="py-src-variable">jsonify</span>({<span class="py-src-string">&quot;error&quot;</span>: <span class="py-src-string">&quot;Path does not exist&quot;</span>}), <span class="py-src-number">404</span>
        
    <span class="py-src-variable">if</span> <span class="py-src-variable">not</span> <span class="py-src-variable">os</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">isdir</span>(<span class="py-src-variable">library_path</span>):
        <span class="py-src-variable">return</span> <span class="py-src-variable">jsonify</span>({<span class="py-src-string">&quot;error&quot;</span>: <span class="py-src-string">&quot;Path is not a directory&quot;</span>}), <span class="py-src-number">400</span>
        
    <span class="py-src-variable">try</span>:
        <span class="py-src-variable">files</span> = []
        <span class="py-src-variable">for</span> <span class="py-src-variable">f</span> <span class="py-src-variable">in</span> <span class="py-src-variable">os</span>.<span class="py-src-variable">listdir</span>(<span class="py-src-variable">library_path</span>):
            <span class="py-src-variable">if</span> <span class="py-src-variable">f</span>.<span class="py-src-variable">endswith</span>(<span class="py-src-string">&quot;.json&quot;</span>) <span class="py-src-variable">and</span> <span class="py-src-variable">not</span> <span class="py-src-variable">f</span>.<span class="py-src-variable">startswith</span>(<span class="py-src-string">&quot;.&quot;</span>):
                <span class="py-src-variable">full_path</span> = <span class="py-src-variable">os</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">join</span>(<span class="py-src-variable">library_path</span>, <span class="py-src-variable">f</span>)
                <span class="py-src-comment"># Try to read description</span>
                <span class="py-src-variable">desc</span> = <span class="py-src-string">&quot;&quot;</span>
                <span class="py-src-variable">try</span>:
                    <span class="py-src-variable">with</span> <span class="py-src-variable">open</span>(<span class="py-src-variable">full_path</span>, <span class="py-src-string">&#x27;r&#x27;</span>) <span class="py-src-variable">as</span> <span class="py-src-variable">jf</span>:
                        <span class="py-src-variable">data</span> = <span class="py-src-variable">json</span>.<span class="py-src-variable">load</span>(<span class="py-src-variable">jf</span>)
                        <span class="py-src-variable">desc</span> = <span class="py-src-variable">data</span>.<span class="py-src-variable">get</span>(<span class="py-src-string">&quot;Study&quot;</span>, {}).<span class="py-src-variable">get</span>(<span class="py-src-string">&quot;Description&quot;</span>, <span class="py-src-string">&quot;&quot;</span>)
                        <span class="py-src-variable">if</span> <span class="py-src-variable">not</span> <span class="py-src-variable">desc</span>:
                            <span class="py-src-variable">desc</span> = <span class="py-src-variable">data</span>.<span class="py-src-variable">get</span>(<span class="py-src-string">&quot;TaskName&quot;</span>, <span class="py-src-string">&quot;&quot;</span>)
                <span class="py-src-variable">except</span>:
                    <span class="py-src-variable">pass</span>
                    
                <span class="py-src-variable">files</span>.<span class="py-src-variable">append</span>({
                    <span class="py-src-string">&quot;filename&quot;</span>: <span class="py-src-variable">f</span>,
                    <span class="py-src-string">&quot;path&quot;</span>: <span class="py-src-variable">full_path</span>,
                    <span class="py-src-string">&quot;description&quot;</span>: <span class="py-src-variable">desc</span>
                })
        
        <span class="py-src-variable">return</span> <span class="py-src-variable">jsonify</span>({<span class="py-src-string">&quot;files&quot;</span>: <span class="py-src-variable">sorted</span>(<span class="py-src-variable">files</span>, <span class="py-src-variable">key</span>=<span class="py-src-variable">lambda</span> <span class="py-src-variable">x</span>: <span class="py-src-variable">x</span>[<span class="py-src-string">&#x27;filename&#x27;</span>])})
    <span class="py-src-variable">except</span> <span class="py-src-variable">Exception</span> <span class="py-src-variable">as</span> <span class="py-src-variable">e</span>:
        <span class="py-src-variable">return</span> <span class="py-src-variable">jsonify</span>({<span class="py-src-string">&quot;error&quot;</span>: <span class="py-src-variable">str</span>(<span class="py-src-variable">e</span>)}), <span class="py-src-number">500</span>


@<span class="py-src-variable">app</span>.<span class="py-src-variable">route</span>(<span class="py-src-string">&quot;/api/generate-lss&quot;</span>, <span class="py-src-variable">methods</span>=[<span class="py-src-string">&quot;POST&quot;</span>])
<span class="py-src-variable">def</span> <span class="py-src-identifier">generate_lss_endpoint</span>():
    <span class="py-src-string">&quot;&quot;&quot;Generate LSS from selected JSON files&quot;&quot;&quot;</span>
    <span class="py-src-variable">if</span> <span class="py-src-variable">not</span> <span class="py-src-variable">generate_lss</span>:
        <span class="py-src-variable">return</span> <span class="py-src-variable">jsonify</span>({<span class="py-src-string">&quot;error&quot;</span>: <span class="py-src-string">&quot;LSS exporter not available&quot;</span>}), <span class="py-src-number">500</span>
        
    <span class="py-src-variable">try</span>:
        <span class="py-src-variable">data</span> = <span class="py-src-variable">request</span>.<span class="py-src-variable">get_json</span>()
        <span class="py-src-variable">if</span> <span class="py-src-variable">not</span> <span class="py-src-variable">data</span> <span class="py-src-variable">or</span> <span class="py-src-string">&quot;files&quot;</span> <span class="py-src-variable">not</span> <span class="py-src-variable">in</span> <span class="py-src-variable">data</span>:
            <span class="py-src-variable">return</span> <span class="py-src-variable">jsonify</span>({<span class="py-src-string">&quot;error&quot;</span>: <span class="py-src-string">&quot;No files selected&quot;</span>}), <span class="py-src-number">400</span>
            
        <span class="py-src-variable">files</span> = <span class="py-src-variable">data</span>[<span class="py-src-string">&quot;files&quot;</span>]
        <span class="py-src-variable">if</span> <span class="py-src-variable">not</span> <span class="py-src-variable">files</span>:
            <span class="py-src-variable">return</span> <span class="py-src-variable">jsonify</span>({<span class="py-src-string">&quot;error&quot;</span>: <span class="py-src-string">&quot;File list is empty&quot;</span>}), <span class="py-src-number">400</span>
            
        <span class="py-src-comment"># Verify files exist</span>
        <span class="py-src-variable">valid_files</span> = []
        <span class="py-src-variable">for</span> <span class="py-src-variable">f</span> <span class="py-src-variable">in</span> <span class="py-src-variable">files</span>:
            <span class="py-src-variable">if</span> <span class="py-src-variable">os</span>.<span class="py-src-variable">path</span>.<span class="py-src-variable">exists</span>(<span class="py-src-variable">f</span>):
                <span class="py-src-variable">valid_files</span>.<span class="py-src-variable">append</span>(<span class="py-src-variable">f</span>)
            <span class="py-src-variable">else</span>:
                <span class="py-src-variable">print</span>(<span class="py-src-string">f&quot;Warning: File not found: {f}&quot;</span>)
                
        <span class="py-src-variable">if</span> <span class="py-src-variable">not</span> <span class="py-src-variable">valid_files</span>:
            <span class="py-src-variable">return</span> <span class="py-src-variable">jsonify</span>({<span class="py-src-string">&quot;error&quot;</span>: <span class="py-src-string">&quot;No valid files found&quot;</span>}), <span class="py-src-number">404</span>
            
        <span class="py-src-comment"># Generate LSS content</span>
        <span class="py-src-comment"># We return it as a downloadable file</span>
        
        <span class="py-src-comment"># Create a temporary file</span>
        <span class="py-src-variable">fd</span>, <span class="py-src-variable">temp_path</span> = <span class="py-src-variable">tempfile</span>.<span class="py-src-variable">mkstemp</span>(<span class="py-src-variable">suffix</span>=<span class="py-src-string">&quot;.lss&quot;</span>)
        <span class="py-src-variable">os</span>.<span class="py-src-variable">close</span>(<span class="py-src-variable">fd</span>)
        
        <span class="py-src-variable">generate_lss</span>(<span class="py-src-variable">valid_files</span>, <span class="py-src-variable">temp_path</span>)
        
        <span class="py-src-variable">return</span> <span class="py-src-variable">send_file</span>(
            <span class="py-src-variable">temp_path</span>,
            <span class="py-src-variable">as_attachment</span>=<span class="py-src-variable">True</span>,
            <span class="py-src-variable">download_name</span>=<span class="py-src-string">&quot;survey_export.lss&quot;</span>,
            <span class="py-src-variable">mimetype</span>=<span class="py-src-string">&quot;application/xml&quot;</span>
        )
        
    <span class="py-src-variable">except</span> <span class="py-src-variable">Exception</span> <span class="py-src-variable">as</span> <span class="py-src-variable">e</span>:
        <span class="py-src-variable">return</span> <span class="py-src-variable">jsonify</span>({<span class="py-src-string">&quot;error&quot;</span>: <span class="py-src-variable">str</span>(<span class="py-src-variable">e</span>)}), <span class="py-src-number">500</span>


<span class="py-src-variable">if</span> <span class="py-src-variable">__name__</span> == <span class="py-src-string">&quot;__main__&quot;</span>:
    <span class="py-src-variable">main</span>()
</pre>
</body>