{% extends "base.html" %}

{% block title %}PRISM Studio - Converter{% endblock %}

{% block styles %}
<style>
    /* Converter Tabs Styling */
    #converterTabs {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 4px;
        background-color: #f8f9fa;
    }
    
    #converterTabs .nav-item {
        border-right: 1px solid #dee2e6;
    }
    
    #converterTabs .nav-item:last-child {
        border-right: none;
    }
    
    #converterTabs .nav-link {
        border-radius: 6px;
        margin: 2px;
        color: #495057;
        transition: all 0.2s ease;
    }
    
    #converterTabs .nav-link:hover:not(.active) {
        background-color: #e9ecef;
    }
    
    #converterTabs .nav-link.active {
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    /* Survey tab - Yellow */
    #survey-tab.active {
        background-color: #ffc107;
        color: #212529;
    }
    #survey-tab.active small {
        color: rgba(0,0,0,0.6) !important;
    }
    
    /* Biometrics tab - Yellow */
    #biometrics-tab.active {
        background-color: #ffc107;
        color: #212529;
    }
    #biometrics-tab.active small {
        color: rgba(0,0,0,0.6) !important;
    }
    
    /* Physio tab - Yellow */
    #physio-tab.active {
        background-color: #ffc107;
        color: #212529;
    }
    #physio-tab.active small {
        color: rgba(0,0,0,0.6) !important;
    }
    
    /* Eyetracking tab - Yellow */
    #eyetracking-tab.active {
        background-color: #ffc107;
        color: #212529;
    }
    #eyetracking-tab.active small {
        color: rgba(0,0,0,0.6) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="fas fa-exchange-alt text-warning me-2"></i>Prism Converter</h2>
            <p class="text-muted">Convert Survey, Biometrics, Physio, and Eyetracking inputs to PRISM/BIDS-style outputs.</p>
        </div>
    </div>

    <!-- Project Context Banner -->
    {% include 'includes/project_banner.html' %}

    <!-- LimeSurvey Quick Import Card (Legacy - now integrated into Survey tab) -->
    <div class="card border-success mb-4 shadow-sm d-none" id="legacyLimeSurveyCard">
        <div class="card-header bg-success bg-opacity-10 d-flex align-items-center">
            <i class="fas fa-file-import fa-lg text-success me-2"></i>
            <h5 class="mb-0">LimeSurvey → PRISM JSON</h5>
            <span class="badge bg-success ms-2">Quick Import</span>
            <span class="badge bg-secondary ms-2">Moved to Survey Tab</span>
        </div>
        <div class="card-body">
            <p class="text-muted mb-3">
                Convert a LimeSurvey structure file (.lss or .lsa) into PRISM-compatible JSON template(s).
            </p>
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label for="lssFile" class="form-label">LimeSurvey File</label>
                    <input class="form-control" type="file" id="lssFile" accept=".lss,.lsa">
                </div>
                <div class="col-md-3">
                    <label for="lssTaskName" class="form-label">Survey Name (optional)</label>
                    <input type="text" class="form-control" id="lssTaskName" placeholder="e.g. phq9">
                    <div class="form-text">For combined mode</div>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Export Mode</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="lssMode" id="lssModeQuestions" value="questions" checked>
                        <label class="form-check-label" for="lssModeQuestions">Individual questions <small class="text-muted">(recommended)</small></label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="lssMode" id="lssModeGroups" value="groups">
                        <label class="form-check-label" for="lssModeGroups">By questionnaire group</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="lssMode" id="lssModeCombined" value="combined">
                        <label class="form-check-label" for="lssModeCombined">Combined (single file)</label>
                    </div>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-success w-100" type="button" id="lssConvertBtn" disabled>
                        <i class="fas fa-wand-magic-sparkles me-2"></i>Convert
                    </button>
                </div>
            </div>
            <div id="lssError" class="alert alert-danger d-none mt-3"></div>

            <!-- Single file result (combined mode) -->
            <div id="lssResultSingle" class="mt-3 d-none">
                <div class="alert alert-success">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Conversion successful!</strong>
                            <span id="lssQuestionCount" class="ms-2 badge bg-secondary"></span>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-success me-2" id="lssPreviewBtn">
                                <i class="fas fa-eye me-1"></i>Preview
                            </button>
                            <button class="btn btn-sm btn-success" id="lssDownloadBtn">
                                <i class="fas fa-download me-1"></i>Download JSON
                            </button>
                        </div>
                    </div>
                </div>
                <div id="lssPreview" class="d-none mt-2">
                    <pre class="bg-light p-3 rounded border" style="max-height: 400px; overflow-y: auto;"><code id="lssPreviewContent"></code></pre>
                </div>
            </div>

            <!-- Multiple files result (groups mode) -->
            <div id="lssResultMultiple" class="mt-3 d-none">
                <div class="alert alert-success mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Conversion successful!</strong>
                            <span id="lssGroupCount" class="ms-2 badge bg-primary"></span>
                            <span id="lssTotalQuestions" class="ms-1 badge bg-secondary"></span>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-success" id="lssDownloadAllBtn">
                                <i class="fas fa-download me-1"></i>Download ZIP
                            </button>
                            {% if current_project.path %}
                            <button class="btn btn-sm btn-primary" id="lssSaveGroupsToProjectBtn">
                                <i class="fas fa-folder-plus me-1"></i>Save to Project
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div id="lssQuestionnaireList" class="row g-2"></div>
            </div>

            <!-- Individual questions result (questions mode) -->
            <div id="lssResultQuestions" class="mt-3 d-none">
                <div class="alert alert-success mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Question templates extracted!</strong>
                            <span id="lssIndividualCount" class="ms-2 badge bg-info"></span>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-success" id="lssDownloadAllQuestionsBtn">
                                <i class="fas fa-download me-1"></i>Download ZIP
                            </button>
                            {% if current_project.path %}
                            <button class="btn btn-sm btn-primary" id="lssSaveQuestionsToProjectBtn">
                                <i class="fas fa-folder-plus me-1"></i>Save to Project
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <p class="text-muted small mb-2">
                    <i class="fas fa-info-circle me-1"></i>
                    Each question is a reusable template. Array questions include all their subquestions.
                </p>
                <div id="lssQuestionsList" class="row g-2"></div>
            </div>

            <!-- Save to Project Success Message -->
            <div id="lssSaveSuccess" class="alert alert-success d-none mt-3">
                <i class="fas fa-check-circle me-2"></i>
                <span id="lssSaveSuccessMessage"></span>
                <div class="mt-2">
                    <a href="{{ url_for('tools.survey_generator') }}" class="btn btn-sm btn-info">
                        <i class="fas fa-arrow-right me-1"></i>Go to Survey & Boilerplate
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <!-- Global Renamer Helper -->
            <div class="card border-warning mb-4 shadow-sm">
                <div class="card-header bg-warning bg-opacity-10 d-flex justify-content-between align-items-center" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#globalRenamerCollapse">
                    <h5 class="mb-0 text-dark">
                        <i class="fas fa-wand-magic-sparkles me-2 text-warning"></i>Renamer Helper <small class="text-muted ms-2 fw-normal">(Optional tool to fix filenames before conversion)</small>
                    </h5>
                    <button class="btn btn-sm btn-outline-warning border-0" type="button">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
                <div id="globalRenamerCollapse" class="collapse">
                    <div class="card-body">
                        <div class="alert alert-light border mb-4">
                            <div class="d-flex">
                                <i class="fas fa-info-circle me-3 text-info fa-2x"></i>
                                <div>
                                    <strong>Renamer by Example:</strong> Quickly rename your files to match the PRISM/BIDS format (<code>sub-XXX_ses-YYY_task-ZZZ</code>).
                                    <br><small class="text-muted">Examples: <code>004-t2.edf</code> → <code>sub-004_ses-2_task-rest_physio.edf</code> or <code>survey_01.csv</code> → <code>sub-01_survey-phq9_survey.csv</code></small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-md-12">
                                <label for="renamerFiles" class="form-label fw-bold">1. Select Files or Folder to Rename</label>
                                <input class="form-control" type="file" id="renamerFiles" multiple webkitdirectory directory>
                                <small class="text-muted">Upload files or an entire directory. We will pick one file as an example to define the rule.</small>
                            </div>
                            
                            <div id="renamerExampleContainer" class="col-md-12 d-none">
                                <div class="card border-warning shadow-sm">
                                    <div class="card-header bg-warning bg-opacity-10 fw-bold">
                                        <i class="fas fa-magic me-2 text-warning"></i>2. Define Renaming Rule by Example
                                    </div>
                                    <div class="card-body">
                                        <div class="row align-items-center">
                                            <div class="col-md-5">
                                                <label class="form-label small text-muted mb-1">Original Filename</label>
                                                <div id="renamerOriginalExample" class="form-control bg-light font-monospace"></div>
                                            </div>
                                            <div class="col-md-1 text-center mt-3">
                                                <i class="fas fa-arrow-right fa-lg text-muted"></i>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="row g-2">
                                                    <div class="col-md-3">
                                                        <label for="renamerModality" class="form-label small text-muted mb-1">Modality</label>
                                                        <select class="form-select form-select-sm" id="renamerModality">
                                                            <option value="physio" selected>Physio</option>
                                                            <option value="biometrics">Biometrics</option>
                                                            <option value="events">Events</option>
                                                            <option value="survey">Survey</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-3" id="renamerRecordingContainer">
                                                        <label for="renamerRecording" class="form-label small text-muted mb-1">Recording</label>
                                                        <select class="form-select form-select-sm" id="renamerRecording">
                                                            <option value="">None</option>
                                                            <option value="ecg">ecg</option>
                                                            <option value="cardiac">cardiac</option>
                                                            <option value="puls">puls</option>
                                                            <option value="ppg">ppg</option>
                                                            <option value="resp">resp</option>
                                                            <option value="eda">eda</option>
                                                            <option value="emg">emg</option>
                                                            <option value="temp">temp</option>
                                                            <option value="trigger">trigger</option>
                                                        </select>
                                                        <small class="text-muted x-small">Optional</small>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label for="renamerNewExample" class="form-label small text-muted mb-1">New PRISM Filename</label>
                                                        <div class="text-muted mb-1" style="font-size: 0.75rem;">
                                                            <i class="fas fa-info-circle me-1"></i> <span id="renamerExampleHint">Example: <code>sub-001_task-rest_physio.edf</code></span>
                                                        </div>
                                                        <input type="text" class="form-control font-monospace border-primary" id="renamerNewExample" placeholder="e.g. sub-001_task-rest_physio.edf">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mt-3 pt-3 border-top">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="renamerOrganize" checked>
                                                <label class="form-check-label fw-bold" for="renamerOrganize">
                                                    Organize into PRISM structure
                                                </label>
                                                <div class="text-muted small">
                                                    If enabled, files will be placed in <code>sub-XX/ses-YY/modality/</code> folders. 
                                                    Otherwise, they will be saved in a flat structure.
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mt-2">
                                            <small class="text-muted">
                                                <i class="fas fa-info-circle me-1"></i> 
                                                Type how the filename above should look. We'll automatically apply this pattern to all other files.
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Hidden fields for the actual regex/replacement used by the backend -->
                            <input type="hidden" id="renamerPattern">
                            <input type="hidden" id="renamerReplacement">

                            <div class="col-md-12">
                                <div class="card bg-light border-0">
                                    <div class="card-body py-2">
                                        <div class="row align-items-center">
                                            <div class="col-md-8">
                                                <span class="small text-muted"><i class="fas fa-lightbulb me-1"></i> Tip: The tool detects numbers in your example and maps them to subject/session IDs.</span>
                                            </div>
                                            <div class="col-md-4 text-end">
                                                <button class="btn btn-sm btn-outline-secondary" type="button" id="renamerResetBtn">
                                                    <i class="fas fa-random me-1"></i>Pick Another Example
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-12">
                                <button class="btn btn-warning text-white w-100 py-2 fw-bold" type="button" id="renamerDownloadBtn" disabled>
                                    <i class="fas fa-file-zipper me-2"></i>Rename All & Download ZIP
                                </button>
                            </div>
                        </div>

                        <div id="renamerPreview" class="mt-4 d-none">
                            <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-3">
                                <h6 class="mb-0"><i class="fas fa-list-check me-2"></i>Renaming Preview</h6>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-secondary active" id="renamerFilterAll">All Files</button>
                                    <button type="button" class="btn btn-outline-warning" id="renamerFilterUnmatched">
                                        <i class="fas fa-exclamation-triangle me-1"></i>Only Unmatched
                                    </button>
                                </div>
                            </div>
                            <div class="table-responsive" style="max-height: 300px;">
                                <table class="table table-sm table-hover align-middle">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th>Original Filename</th>
                                            <th style="width: 40px;"><i class="fas fa-arrow-right text-muted"></i></th>
                                            <th>New PRISM Filename</th>
                                            <th class="text-center">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="renamerPreviewBody"></tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div id="renamerError" class="alert alert-danger d-none mt-3"></div>
                        <div id="renamerInfo" class="alert alert-success d-none mt-3"></div>
                    </div>
                </div>
            </div>

            <!-- Ribbon Navigation -->
            <ul class="nav nav-pills nav-fill mb-4" id="converterTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="survey-tab" data-bs-toggle="pill" data-bs-target="#survey-panel" type="button" role="tab" aria-controls="survey-panel" aria-selected="true">
                        <i class="fas fa-clipboard-list fa-lg mb-1 d-block"></i>
                        <span class="fw-bold">Survey</span>
                        <small class="d-block text-muted" style="font-size: 0.7rem;">Questionnaires</small>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="biometrics-tab" data-bs-toggle="pill" data-bs-target="#biometrics-panel" type="button" role="tab" aria-controls="biometrics-panel" aria-selected="false">
                        <i class="fas fa-weight fa-lg mb-1 d-block"></i>
                        <span class="fw-bold">Biometrics</span>
                        <small class="d-block text-muted" style="font-size: 0.7rem;">Physical measures</small>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="physio-tab" data-bs-toggle="pill" data-bs-target="#physio-panel" type="button" role="tab" aria-controls="physio-panel" aria-selected="false">
                        <i class="fas fa-heartbeat fa-lg mb-1 d-block"></i>
                        <span class="fw-bold">Physio</span>
                        <small class="d-block text-muted" style="font-size: 0.7rem;">ECG, Respiration</small>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="eyetracking-tab" data-bs-toggle="pill" data-bs-target="#eyetracking-panel" type="button" role="tab" aria-controls="eyetracking-panel" aria-selected="false">
                        <i class="fas fa-eye fa-lg mb-1 d-block"></i>
                        <span class="fw-bold">Eyetracking</span>
                        <small class="d-block text-muted" style="font-size: 0.7rem;">Gaze data</small>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="organize-tab" data-bs-toggle="pill" data-bs-target="#organize-panel" type="button" role="tab" aria-controls="organize-panel" aria-selected="false">
                        <i class="fas fa-folder-tree fa-lg mb-1 d-block"></i>
                        <span class="fw-bold">Organize</span>
                        <small class="d-block text-muted" style="font-size: 0.7rem;">Batch organize files</small>
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="converterTabContent">
                
                <!-- Survey Panel -->
                <div class="tab-pane fade show active" id="survey-panel" role="tabpanel" aria-labelledby="survey-tab">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <div class="bg-warning bg-opacity-10 rounded-circle p-3 me-3">
                                    <i class="fas fa-clipboard-list fa-2x text-warning"></i>
                                </div>
                                <div>
                                    <h5 class="mb-1">Survey Data Conversion</h5>
                                    <p class="text-muted mb-0">Convert questionnaire responses from Excel or LimeSurvey archives</p>
                                </div>
                            </div>

                            <!-- Template Library Path -->
                            <div class="row g-3 mb-3">
                                <div class="col-12">
                                    <label for="convertLibraryPath" class="form-label">Template Library Root <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="convertLibraryPath" placeholder="/path/to/library" value="">
                                        <button class="btn btn-outline-secondary" type="button" id="convertBrowseLibraryBtn" title="Browse Folder">
                                            <i class="fas fa-folder-open"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">Library folder containing <code>survey/</code> and <code>biometrics/</code>. (<code>participants.json</code> can be here or in parent folder)</div>
                                    <!-- Quick switch buttons for library paths -->
                                    <div class="mt-2" id="convertLibraryQuickSwitch">
                                        <small class="text-muted me-2">Quick switch:</small>
                                        <button type="button" class="btn btn-sm btn-outline-success me-1" id="convertUseProjectLibraryBtn" disabled title="No project selected">
                                            <i class="fas fa-folder me-1"></i>Project Library
                                        </button>
                                        <span class="badge bg-secondary ms-2" id="convertLibrarySourceBadge" style="display: none;">
                                            <i class="fas fa-info-circle me-1"></i><span id="convertLibrarySourceText">-</span>
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- Structure Warning (missing folders/files) -->
                            <div id="surveyStructureWarning" class="alert alert-danger d-none mb-3">
                                <i class="fas fa-folder-minus me-2"></i>
                                <strong>Missing Structure:</strong> <span id="surveyStructureMessage">The selected folder is missing required items.</span>
                            </div>

                            <!-- I18n Warning -->
                            <div id="surveyI18nWarning" class="alert alert-warning d-none mb-3">
                                <i class="fas fa-language me-2"></i>
                                <strong>Multilanguage Notice:</strong> <span id="surveyI18nMessage">Some templates do not have multilanguage (I18n) configuration.</span>
                            </div>

                            <!-- Conversion Mode Toggle -->
                            <div class="row g-3 mb-3">
                                <div class="col-12">
                                    <label class="form-label fw-bold">Conversion Mode</label>
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="convertMode" id="convertModeData" value="data" checked>
                                        <label class="btn btn-outline-warning" for="convertModeData">
                                            <i class="fas fa-table me-1"></i>Data Conversion
                                            <small class="d-block text-muted">Convert responses to BIDS format</small>
                                        </label>
                                        <input type="radio" class="btn-check" name="convertMode" id="convertModeTemplate" value="template">
                                        <label class="btn btn-outline-success" for="convertModeTemplate">
                                            <i class="fas fa-file-code me-1"></i>Template Generation
                                            <small class="d-block text-muted">Extract structure only (no data)</small>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="row g-3 align-items-end">
                                <div class="col-md-4">
                                    <label for="convertFileDisplay" class="form-label">Survey File (.xlsx, .csv, .tsv, .lsa, .lss)</label>
                                    <!-- Display selected file with browse button -->
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="convertFileDisplay" readonly placeholder="Click to select file..." style="cursor: pointer;">
                                        <button class="btn btn-outline-success" type="button" id="convertBrowseFileBtn" title="Browse for file (starts in sourcedata)">
                                            <i class="fas fa-folder-open"></i>
                                        </button>
                                        <button class="btn btn-outline-danger d-none" type="button" id="convertClearFileBtn" title="Clear selection">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    <!-- Hidden inputs -->
                                    <input class="d-none" type="file" id="convertExcelFile" accept=".xlsx,.lsa,.csv,.tsv,.lss">
                                    <input type="hidden" id="convertSelectedFilePath" value="">
                                    <input type="hidden" id="convertFileSource" value="">
                                    <div class="form-text" id="convertFileHint">
                                        <span class="text-muted"><i class="fas fa-folder-open me-1"></i>Opens in project's sourcedata folder</span>
                                    </div>
                                </div>
                                <div class="col-md-4" id="convertDatasetNameGroup">
                                    <label for="convertDatasetName" class="form-label">Dataset/Survey Name (optional)</label>
                                    <input type="text" class="form-control" id="convertDatasetName" placeholder="e.g. phq9">
                                </div>
                                <div class="col-md-4" id="convertLanguageGroup">
                                    <label for="convertLanguage" class="form-label">Language</label>
                                    <select class="form-select" id="convertLanguage">
                                        <option value="auto" selected>Auto (template default)</option>
                                    </select>
                                </div>

                                <!-- Participant ID selector (for data conversion) -->
                                <div class="col-md-4" id="convertIdColumnGroup">
                                    <label for="convertIdColumn" class="form-label">
                                        Participant ID Column <span class="text-danger">*</span>
                                        <span id="idColumnStatus" class="ms-2 small"></span>
                                    </label>
                                    <select class="form-select" id="convertIdColumn">
                                        <option value="">-- Select ID column --</option>
                                    </select>
                                    <div class="form-text" id="idColumnHelp">
                                        <i class="fas fa-info-circle me-1"></i>Upload a file to detect available columns. Values will be used for folder names (sub-{value}).
                                    </div>
                                </div>

                                <!-- Template export mode (for template generation) -->
                                <div class="col-md-4 d-none" id="convertTemplateExportGroup">
                                    <label class="form-label">Template Export</label>
                                    <select class="form-select" id="convertTemplateExport">
                                        <option value="groups">By questionnaire group</option>
                                        <option value="questions" selected>Individual questions</option>
                                        <option value="combined">Combined (single file)</option>
                                    </select>
                                </div>

                                <div class="col-md-4">
                                    <button class="btn btn-warning text-white w-100" type="button" id="convertBtn" disabled>
                                        <i class="fas fa-wand-magic-sparkles me-2"></i>Convert
                                    </button>
                                </div>

                                <div class="col-12">
                                    <a class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" href="#surveyAdvancedOptions" role="button" aria-expanded="false">
                                        <i class="fas fa-cog me-1"></i>Advanced options
                                    </a>
                                </div>

                                <div class="col-12 collapse" id="surveyAdvancedOptions">
                                    <div class="row g-3 align-items-end mt-1 p-3 bg-light rounded">
                                        <div class="col-md-6">
                                            <label for="convertAliasFile" class="form-label">ID Mapping File (optional)</label>
                                            <input class="form-control" type="file" id="convertAliasFile" accept=".tsv,.txt">
                                            <div class="form-text">Only needed if item IDs changed over time.</div>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="convertSession" class="form-label">Session ID (optional)</label>
                                            <input type="text" class="form-control" id="convertSession" placeholder="e.g. 01">
                                            <div class="form-text">Force a specific session ID (e.g. '01' becomes 'ses-01'). Default: ses-01</div>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="convertDuplicateHandling" class="form-label">Duplicate IDs</label>
                                            <select class="form-select" id="convertDuplicateHandling">
                                                <option value="ask" selected>Ask for each duplicate</option>
                                                <option value="error">Stop and report</option>
                                                <option value="keep_first">Keep first occurrence</option>
                                                <option value="keep_last">Keep last occurrence</option>
                                                <option value="sessions">Treat as multiple sessions</option>
                                            </select>
                                            <div class="form-text">How to handle participants with duplicate IDs in the data.</div>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="convertUnknown" class="form-label">Unknown Items</label>
                                            <select class="form-select" id="convertUnknown">
                                                <option value="warn" selected>Show warnings</option>
                                                <option value="ignore">Skip silently</option>
                                                <option value="error">Stop on unknown</option>
                                            </select>
                                        </div>
                                        <div class="col-md-12">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="convertStrictLevels">
                                                <label class="form-check-label" for="convertStrictLevels">Strict Levels Validation</label>
                                            </div>
                                            <div class="form-text">If enabled, values must exactly match the Levels defined in the template. For LimeSurvey (.lsa) files, keep this OFF to allow numeric scale values (1, 2, 3...) to be mapped correctly.</div>
                                        </div>
                                        {% if current_project.path %}
                                        <div class="col-md-12 mt-3">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="convertSaveToProject" checked>
                                                <label class="form-check-label" for="convertSaveToProject">
                                                    <i class="fas fa-folder-plus me-1"></i>Save to Project
                                                </label>
                                            </div>
                                            <div class="form-text">Save converted BIDS data directly to: <code>{{ current_project.path }}</code></div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <div id="convertError" class="alert alert-danger d-none mt-3"></div>
                            <div id="convertInfo" class="alert alert-info d-none mt-3"></div>

                            <!-- Duplicate Resolution Panel -->
                            <div id="duplicateResolutionPanel" class="d-none mt-3">
                                <div class="card border-warning">
                                    <div class="card-header bg-warning text-dark">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <strong>Duplicate Participant IDs Found</strong>
                                    </div>
                                    <div class="card-body">
                                        <p class="text-muted mb-3" id="duplicateDescription">
                                            The following participant IDs appear multiple times in your data.
                                        </p>

                                        <!-- Global action for all duplicates -->
                                        <div class="mb-3 p-3 bg-light rounded border">
                                            <label class="form-label fw-bold">
                                                <i class="fas fa-cog text-primary me-1"></i>
                                                Apply to all duplicates:
                                            </label>
                                            <div class="row g-2">
                                                <div class="col-auto">
                                                    <button class="btn btn-outline-primary btn-sm duplicate-global-action" data-action="keep_first">
                                                        <i class="fas fa-arrow-up me-1"></i>Keep First
                                                    </button>
                                                </div>
                                                <div class="col-auto">
                                                    <button class="btn btn-outline-primary btn-sm duplicate-global-action" data-action="keep_last">
                                                        <i class="fas fa-arrow-down me-1"></i>Keep Last
                                                    </button>
                                                </div>
                                                <div class="col-auto">
                                                    <button class="btn btn-outline-primary btn-sm duplicate-global-action" data-action="sessions">
                                                        <i class="fas fa-layer-group me-1"></i>Multiple Sessions
                                                    </button>
                                                </div>
                                                <div class="col-auto">
                                                    <button class="btn btn-outline-danger btn-sm duplicate-global-action" data-action="skip">
                                                        <i class="fas fa-ban me-1"></i>Skip All Duplicates
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- List of duplicates with per-item actions -->
                                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                            <table class="table table-sm table-hover mb-0">
                                                <thead class="table-light sticky-top">
                                                    <tr>
                                                        <th>Participant ID</th>
                                                        <th>Occurrences</th>
                                                        <th>Action</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="duplicateList">
                                                    <!-- Dynamically populated -->
                                                </tbody>
                                            </table>
                                        </div>

                                        <div class="mt-3 d-flex justify-content-between">
                                            <button class="btn btn-outline-secondary" id="cancelDuplicateResolution">
                                                <i class="fas fa-times me-1"></i>Cancel
                                            </button>
                                            <button class="btn btn-warning text-white" id="proceedWithDuplicates">
                                                <i class="fas fa-check me-1"></i>Proceed with Selected Actions
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Conversion Progress Steps -->
                            <div id="surveyConversionProgress" class="d-none mt-3">
                                <div class="card border-warning">
                                    <div class="card-body py-3">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <!-- Step 1: Upload -->
                                            <div class="text-center flex-fill">
                                                <div id="step1Icon" class="rounded-circle bg-warning text-white d-inline-flex align-items-center justify-content-center" style="width: 36px; height: 36px;">
                                                    <i class="fas fa-upload"></i>
                                                </div>
                                                <div class="small mt-1 text-muted">Upload</div>
                                            </div>
                                            <div class="flex-fill"><hr class="border-warning step-line" id="line1"></div>
                                            <!-- Step 2: Process -->
                                            <div class="text-center flex-fill">
                                                <div id="step2Icon" class="rounded-circle bg-secondary text-white d-inline-flex align-items-center justify-content-center" style="width: 36px; height: 36px;">
                                                    <i class="fas fa-cogs"></i>
                                                </div>
                                                <div class="small mt-1 text-muted">Process</div>
                                            </div>
                                            <div class="flex-fill"><hr class="border-secondary step-line" id="line2"></div>
                                            <!-- Step 3: Convert -->
                                            <div class="text-center flex-fill">
                                                <div id="step3Icon" class="rounded-circle bg-secondary text-white d-inline-flex align-items-center justify-content-center" style="width: 36px; height: 36px;">
                                                    <i class="fas fa-exchange-alt"></i>
                                                </div>
                                                <div class="small mt-1 text-muted">Convert</div>
                                            </div>
                                            <div class="flex-fill"><hr class="border-secondary step-line" id="line3"></div>
                                            <!-- Step 4: Validate -->
                                            <div class="text-center flex-fill">
                                                <div id="step4Icon" class="rounded-circle bg-secondary text-white d-inline-flex align-items-center justify-content-center" style="width: 36px; height: 36px;">
                                                    <i class="fas fa-check-double"></i>
                                                </div>
                                                <div class="small mt-1 text-muted">Validate</div>
                                            </div>
                                        </div>
                                        <div class="text-center">
                                            <span id="surveyProgressText" class="text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Starting conversion...</span>
                                        </div>
                                        <!-- Progress bar -->
                                        <div class="progress mt-3" style="height: 6px;">
                                            <div id="surveyProgressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-warning" role="progressbar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Conversion Summary (shows after completion) -->
                            <div id="conversionSummaryContainer" class="d-none mt-3">
                                <div class="card border-success">
                                    <div class="card-header bg-success bg-opacity-10 py-2">
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        <span class="fw-bold">Conversion Complete</span>
                                    </div>
                                    <div class="card-body py-3">
                                        <div class="row g-3 text-center" id="conversionStats">
                                            <div class="col-4">
                                                <div class="border rounded p-2">
                                                    <div class="fs-4 fw-bold text-primary" id="statParticipants">-</div>
                                                    <small class="text-muted">Participants</small>
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <div class="border rounded p-2">
                                                    <div class="fs-4 fw-bold text-success" id="statQuestionnaires">-</div>
                                                    <small class="text-muted">Questionnaires</small>
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <div class="border rounded p-2">
                                                    <div class="fs-4 fw-bold text-info" id="statFiles">-</div>
                                                    <small class="text-muted">Files Created</small>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Questionnaire breakdown -->
                                        <div id="questionnaireBreakdown" class="mt-3 d-none">
                                            <hr class="my-2">
                                            <small class="text-muted d-block mb-2">Questionnaires converted:</small>
                                            <div id="questionnaireList" class="d-flex flex-wrap gap-1"></div>
                                        </div>
                                        <!-- Warnings summary -->
                                        <div id="conversionWarningsSummary" class="mt-3 d-none">
                                            <hr class="my-2">
                                            <div class="alert alert-warning py-2 mb-0">
                                                <i class="fas fa-exclamation-triangle me-2"></i>
                                                <span id="conversionWarningsText"></span>
                                            </div>
                                        </div>
                                        <!-- Download log button -->
                                        <div class="mt-3 text-center">
                                            <button type="button" class="btn btn-sm btn-outline-secondary" id="downloadLogBtn">
                                                <i class="fas fa-file-alt me-1"></i>Download Conversion Log
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Conversion Log (hidden, for download only) -->
                            <div id="conversionLogContainer" class="d-none">
                                <pre id="conversionLog" class="d-none"></pre>
                            </div>

                            <!-- Validation Results -->
                            <div id="validationResultsContainer" class="d-none mt-3">
                                <div class="card" id="validationResultsCard">
                                    <div class="card-header py-2 d-flex justify-content-between align-items-center" id="validationResultsHeader">
                                        <span><i class="fas fa-clipboard-check me-2"></i>Validation Results</span>
                                        <span id="validationBadge" class="badge"></span>
                                    </div>
                                    <div class="card-body">
                                        <div id="validationSummary" class="mb-3"></div>
                                        <div id="validationDetails"></div>
                                        <div id="downloadSection" class="d-none mt-3 text-center">
                                            <button class="btn btn-warning btn-lg text-white" id="downloadZipBtn">
                                                <i class="fas fa-download me-2"></i>Download Validated Dataset
                                            </button>
                                            <p class="text-muted small mt-2">
                                                <i class="fas fa-check-circle me-1"></i>Dataset passed validation
                                            </p>
                                        </div>
                                        <div id="downloadWarningSection" class="d-none mt-3 text-center">
                                            <button class="btn btn-warning btn-lg" id="downloadZipWarningBtn">
                                                <i class="fas fa-download me-2"></i>Download Dataset (with warnings)
                                            </button>
                                            <p class="text-muted small mt-2">
                                                <i class="fas fa-exclamation-triangle me-1"></i>Dataset has warnings but can still be used
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Template Generation Results -->
                            <div id="templateResultsContainer" class="d-none mt-3">
                                <!-- Single template result -->
                                <div id="templateResultSingle" class="d-none">
                                    <div class="alert alert-success">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <i class="fas fa-check-circle me-2"></i>
                                                <strong>Template generated!</strong>
                                                <span id="templateQuestionCount" class="ms-2 badge bg-secondary"></span>
                                            </div>
                                            <div>
                                                <button class="btn btn-sm btn-outline-success me-2" id="templatePreviewBtn">
                                                    <i class="fas fa-eye me-1"></i>Preview
                                                </button>
                                                <button class="btn btn-sm btn-success" id="templateDownloadBtn">
                                                    <i class="fas fa-download me-1"></i>Download JSON
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="templatePreview" class="d-none mt-2">
                                        <pre class="bg-light p-3 rounded border" style="max-height: 400px; overflow-y: auto;"><code id="templatePreviewContent"></code></pre>
                                    </div>
                                </div>

                                <!-- Multiple templates result (groups mode) -->
                                <div id="templateResultGroups" class="d-none">
                                    <div class="alert alert-success mb-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <i class="fas fa-check-circle me-2"></i>
                                                <strong>Templates generated!</strong>
                                                <span id="templateGroupCount" class="ms-2 badge bg-primary"></span>
                                                <span id="templateTotalQuestions" class="ms-1 badge bg-secondary"></span>
                                            </div>
                                            <div class="btn-group">
                                                <button class="btn btn-sm btn-success" id="templateDownloadAllBtn">
                                                    <i class="fas fa-download me-1"></i>Download ZIP
                                                </button>
                                                {% if current_project.path %}
                                                <button class="btn btn-sm btn-primary" id="templateSaveToProjectBtn">
                                                    <i class="fas fa-folder-plus me-1"></i>Save to Project
                                                </button>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    <div id="templateGroupList" class="row g-2"></div>
                                </div>

                                <!-- Individual questions result -->
                                <div id="templateResultQuestions" class="d-none">
                                    <div class="alert alert-success mb-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <i class="fas fa-check-circle me-2"></i>
                                                <strong>Question templates extracted!</strong>
                                                <span id="templateIndividualCount" class="ms-2 badge bg-info"></span>
                                            </div>
                                            <div class="btn-group">
                                                <button class="btn btn-sm btn-success" id="templateDownloadQuestionsBtn">
                                                    <i class="fas fa-download me-1"></i>Download ZIP
                                                </button>
                                                {% if current_project.path %}
                                                <button class="btn btn-sm btn-primary" id="templateSaveQuestionsToProjectBtn">
                                                    <i class="fas fa-folder-plus me-1"></i>Save to Project
                                                </button>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    <div id="templateQuestionsList" class="row g-2"></div>
                                </div>

                                <!-- Save to Project Success -->
                                <div id="templateSaveSuccess" class="alert alert-success d-none mt-3">
                                    <i class="fas fa-check-circle me-2"></i>
                                    <span id="templateSaveSuccessMessage"></span>
                                </div>

                                <!-- Participant Metadata Section -->
                                <div id="participantMetadataSection" class="d-none mt-4 border-top pt-3">
                                    <h6 class="mb-3">
                                        <i class="fas fa-users text-info me-2"></i>
                                        Mark Participant Metadata Fields
                                        <small class="text-muted ms-2">(fields that go into participants.tsv)</small>
                                    </h6>

                                    <div class="alert alert-warning py-2 mb-3">
                                        <small>
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                            <strong>Required:</strong> You must select which field contains the <strong>Participant ID</strong>.
                                            This value will be used for subject folder naming (e.g., sub-{id}).
                                        </small>
                                    </div>

                                    <!-- Participant ID selector (mandatory) -->
                                    <div class="mb-3 p-3 bg-light rounded border">
                                        <label class="form-label fw-bold">
                                            <i class="fas fa-id-card text-primary me-1"></i>
                                            Participant ID Column <span class="text-danger">*</span>
                                        </label>
                                        <select id="participantIdColumn" class="form-select">
                                            <option value="">-- Select the ID field --</option>
                                        </select>
                                        <div class="form-text">This field's value will be used for subject folder names (sub-{value})</div>
                                    </div>

                                    <div class="alert alert-info py-2 mb-3">
                                        <small>
                                            <i class="fas fa-lightbulb me-1"></i>
                                            <strong>Optional:</strong> Mark additional demographic questions (age, sex) as participant metadata.
                                            These will be saved to <code>participants.json</code> instead of per-subject survey files.
                                        </small>
                                    </div>

                                    <!-- Question list with checkboxes -->
                                    <div id="participantFieldsList" class="mb-3" style="max-height: 300px; overflow-y: auto;">
                                        <div class="text-muted">Loading extracted fields...</div>
                                    </div>

                                    <!-- BIDS field mapping suggestions -->
                                    <div id="bidsFieldSuggestions" class="mb-3 d-none">
                                        <h6 class="small text-muted mb-2">Suggested BIDS Mappings</h6>
                                        <div id="bidsFieldSuggestionsList" class="d-flex flex-wrap gap-2"></div>
                                    </div>

                                    <!-- Actions -->
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <span class="text-muted me-2">
                                                <span id="selectedParticipantFieldsCount">0</span> fields selected
                                            </span>
                                        </div>
                                        <div>
                                            {% if current_project.path %}
                                            <button type="button" class="btn btn-primary btn-sm" id="saveParticipantsJsonBtn" disabled>
                                                <i class="fas fa-save me-1"></i>Save to participants.json
                                            </button>
                                            {% else %}
                                            <button type="button" class="btn btn-outline-secondary btn-sm" id="downloadParticipantsJsonBtn" disabled>
                                                <i class="fas fa-download me-1"></i>Download participants.json
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <!-- Save status -->
                                    <div id="participantsSaveStatus" class="mt-2"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Biometrics Panel -->
                <div class="tab-pane fade" id="biometrics-panel" role="tabpanel" aria-labelledby="biometrics-tab">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <div class="bg-warning bg-opacity-10 rounded-circle p-3 me-3">
                                    <i class="fas fa-weight fa-2x text-warning"></i>
                                </div>
                                <div>
                                    <h5 class="mb-1">Biometrics Data Conversion</h5>
                                    <p class="text-muted mb-0">Convert physical measurements like grip strength, balance tests</p>
                                </div>
                            </div>

                            <!-- Template Library Path -->
                            <div class="row g-3 mb-3">
                                <div class="col-12">
                                    <label for="biometricsLibraryPath" class="form-label">Template Library Root <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="biometricsLibraryPath" placeholder="/path/to/library" value="">
                                        <button class="btn btn-outline-secondary" type="button" id="biometricsBrowseLibraryBtn" title="Browse Folder">
                                            <i class="fas fa-folder-open"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">Library folder containing <code>survey/</code> and <code>biometrics/</code>. (<code>participants.json</code> can be here or in parent folder)</div>
                                </div>
                            </div>

                            <!-- Structure Warning (missing folders/files) -->
                            <div id="biometricsStructureWarning" class="alert alert-danger d-none mb-3">
                                <i class="fas fa-folder-minus me-2"></i>
                                <strong>Missing Structure:</strong> <span id="biometricsStructureMessage">The selected folder is missing required items.</span>
                            </div>

                            <div class="row g-3 align-items-end">
                                <div class="col-md-4">
                                    <label for="biometricsDataFile" class="form-label">Biometrics File (.xlsx, .csv, .tsv)</label>
                                    <input class="form-control" type="file" id="biometricsDataFile" accept=".xlsx,.csv,.tsv">
                                </div>
                                <div class="col-md-4">
                                    <label for="biometricsDatasetName" class="form-label">Dataset Name (optional)</label>
                                    <input type="text" class="form-control" id="biometricsDatasetName" placeholder="PRISM Biometrics Dataset">
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-warning text-white w-100" type="button" id="biometricsConvertBtn" disabled>
                                        <i class="fas fa-wand-magic-sparkles me-2"></i>Convert
                                    </button>
                                </div>

                                <div class="col-12">
                                    <a class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" href="#biometricsAdvancedOptions" role="button" aria-expanded="false">
                                        <i class="fas fa-cog me-1"></i>Advanced options
                                    </a>
                                </div>

                                <div class="col-12 collapse" id="biometricsAdvancedOptions">
                                    <div class="row g-3 align-items-end mt-1 p-3 bg-light rounded">
                                        <div class="col-md-6">
                                            <label for="biometricsSheet" class="form-label">Excel Sheet (name or index)</label>
                                            <input type="text" class="form-control" id="biometricsSheet" placeholder="0" value="0">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="biometricsSession" class="form-label">Session ID (optional)</label>
                                            <input type="text" class="form-control" id="biometricsSession" placeholder="e.g. 1">
                                            <div class="form-text">Force a specific session ID (e.g. '1' becomes 'ses-1').</div>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="biometricsUnknown" class="form-label">Unknown Items</label>
                                            <select class="form-select" id="biometricsUnknown">
                                                <option value="warn" selected>Show warnings</option>
                                                <option value="ignore">Skip silently</option>
                                                <option value="error">Stop on unknown</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="biometricsError" class="alert alert-danger d-none mt-3"></div>
                            <div id="biometricsInfo" class="alert alert-info d-none mt-3"></div>

                            <!-- Detected Biometrics List -->
                            <div id="biometricsDetectedContainer" class="d-none mt-3">
                                <div class="card border-warning">
                                    <div class="card-header bg-warning bg-opacity-10 fw-bold">
                                        <i class="fas fa-search me-2 text-warning"></i>Detected Biometrics
                                    </div>
                                    <div class="card-body">
                                        <p class="small text-muted mb-2">The following biometrics tasks were detected in your file. Select which ones to export:</p>
                                        <div id="biometricsDetectedList" class="row g-2">
                                            <!-- Dynamic checkboxes here -->
                                        </div>
                                        <div class="mt-3 pt-2 border-top d-flex justify-content-between align-items-center">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="biometricsSelectAll" checked>
                                                <label class="form-check-label small" for="biometricsSelectAll">Select All</label>
                                            </div>
                                            <button class="btn btn-sm btn-warning text-white" id="biometricsConfirmBtn">
                                                <i class="fas fa-check me-1"></i>Confirm & Convert
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Conversion Log Output -->
                            <div id="biometricsLogContainer" class="d-none mt-3">
                                <div class="card border-secondary">
                                    <div class="card-header bg-dark text-white py-2 d-flex justify-content-between align-items-center">
                                        <span><i class="fas fa-terminal me-2"></i>Conversion Log</span>
                                        <button type="button" class="btn btn-sm btn-outline-light" id="toggleBiometricsLogBtn" title="Toggle log">
                                            <i class="fas fa-chevron-down"></i>
                                        </button>
                                    </div>
                                    <div class="card-body p-0" id="biometricsLogBody">
                                        <pre id="biometricsLog" class="m-0 p-3 bg-dark text-light" style="max-height: 300px; overflow-y: auto; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; font-size: 12px; white-space: pre-wrap;"></pre>
                                    </div>
                                </div>
                            </div>

                            <!-- Validation Results -->
                            <div id="biometricsValidationResultsContainer" class="d-none mt-3">
                                <div class="card" id="biometricsValidationResultsCard">
                                    <div class="card-header py-2 d-flex justify-content-between align-items-center" id="biometricsValidationResultsHeader">
                                        <span><i class="fas fa-clipboard-check me-2"></i>Validation Results</span>
                                        <span id="biometricsValidationBadge" class="badge"></span>
                                    </div>
                                    <div class="card-body">
                                        <div id="biometricsValidationSummary" class="mb-3"></div>
                                        <div id="biometricsValidationDetails"></div>
                                        <div id="biometricsDownloadSection" class="d-none mt-3 text-center">
                                            <button class="btn btn-warning btn-lg text-white" id="biometricsDownloadZipBtn">
                                                <i class="fas fa-download me-2"></i>Download Validated Dataset
                                            </button>
                                            <p class="text-muted small mt-2">
                                                <i class="fas fa-check-circle me-1"></i>Dataset passed validation
                                            </p>
                                        </div>
                                        <div id="biometricsDownloadWarningSection" class="d-none mt-3 text-center">
                                            <button class="btn btn-warning btn-lg" id="biometricsDownloadZipWarningBtn">
                                                <i class="fas fa-download me-2"></i>Download Dataset (with warnings)
                                            </button>
                                            <p class="text-muted small mt-2">
                                                <i class="fas fa-exclamation-triangle me-1"></i>Dataset has warnings but can still be used
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Physio Panel -->
                <div class="tab-pane fade" id="physio-panel" role="tabpanel" aria-labelledby="physio-tab">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <div class="bg-warning bg-opacity-10 rounded-circle p-3 me-3">
                                    <i class="fas fa-heartbeat fa-2x text-warning"></i>
                                </div>
                                <div>
                                    <h5 class="mb-1">Physiological Data Conversion</h5>
                                    <p class="text-muted mb-0">Convert Varioport recordings (ECG, respiration) to PRISM format</p>
                                </div>
                            </div>

                            <!-- Sub-tabs for single vs batch -->
                            <ul class="nav nav-tabs nav-sm mb-3" id="physioSubTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="physio-single-tab" data-bs-toggle="tab" data-bs-target="#physio-single" type="button" role="tab">
                                        <i class="fas fa-file me-1"></i>Single File
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="physio-batch-tab" data-bs-toggle="tab" data-bs-target="#physio-batch" type="button" role="tab">
                                        <i class="fas fa-folder-open me-1"></i>Batch (Multiple Files)
                                    </button>
                                </li>
                            </ul>

                            <div class="tab-content" id="physioSubTabContent">
                                <!-- Single File -->
                                <div class="tab-pane fade show active" id="physio-single" role="tabpanel">
                                    <div class="row g-3 align-items-end">
                                        <div class="col-md-4">
                                            <label for="physioRawFile" class="form-label">Varioport Recording (.raw or .vpd)</label>
                                            <input class="form-control" type="file" id="physioRawFile" accept=".raw,.vpd">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="physioTask" class="form-label">Task Name</label>
                                            <input type="text" class="form-control" id="physioTask" value="rest">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="physioSamplingRate" class="form-label">Sampling Rate (optional)</label>
                                            <input type="number" class="form-control" id="physioSamplingRate" placeholder="e.g. 256" step="any">
                                        </div>
                                        <div class="col-md-4">
                                            <button class="btn btn-warning text-white w-100" type="button" id="physioConvertBtn" disabled>
                                                <i class="fas fa-wand-magic-sparkles me-2"></i>Convert
                                            </button>
                                        </div>
                                    </div>
                                    <div id="physioError" class="alert alert-danger d-none mt-3"></div>
                                    <div id="physioInfo" class="alert alert-info d-none mt-3"></div>
                                </div>

                                <!-- Batch -->
                                <div class="tab-pane fade" id="physio-batch" role="tabpanel">
                                    <div class="alert alert-light border mb-3">
                                        <i class="fas fa-info-circle me-2 text-info"></i>
                                        <strong>File naming required:</strong> <code>sub-XXX_ses-YYY_task-ZZZ.raw</code> or <code>.vpd</code>
                                        <br><small class="text-muted">Example: <code>sub-003_ses-1_task-rest.raw</code> · Session is optional</small>
                                    </div>
                                    <div class="row g-3 align-items-end">
                                        <div class="col-md-6">
                                            <label for="physioBatchFiles" class="form-label">Select Physio Files</label>
                                            <input class="form-control" type="file" id="physioBatchFiles" accept=".raw,.vpd" multiple>
                                            <small class="text-muted">Select all files (Ctrl+A / Cmd+A)</small>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="physioBatchDatasetName" class="form-label">Dataset Name</label>
                                            <input type="text" class="form-control" id="physioBatchDatasetName" value="Physio Dataset">
                                        </div>
                                        <div class="col-md-3">
                                            <label for="physioBatchSamplingRate" class="form-label">Sampling Rate (optional)</label>
                                            <input type="number" class="form-control" id="physioBatchSamplingRate" placeholder="e.g. 256" step="any">
                                        </div>
                                        <div class="col-md-4">
                                            <button class="btn btn-warning text-white w-100" type="button" id="physioBatchConvertBtn" disabled>
                                                <i class="fas fa-wand-magic-sparkles me-2"></i>Convert All & Download
                                            </button>
                                        </div>
                                    </div>
                                    <div id="physioBatchError" class="alert alert-danger d-none mt-3"></div>
                                    <div id="physioBatchInfo" class="alert alert-info d-none mt-3"></div>
                                    <div id="physioBatchProgress" class="progress d-none mt-3" style="height: 25px;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-warning text-dark" style="width: 100%">Converting...</div>
                                    </div>
                                    <!-- Log Window -->
                                    <div id="physioBatchLogContainer" class="d-none mt-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <label class="form-label mb-0"><i class="fas fa-terminal me-2"></i>Conversion Log</label>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" id="physioBatchLogClearBtn">
                                                <i class="fas fa-trash-alt me-1"></i>Clear
                                            </button>
                                        </div>
                                        <div id="physioBatchLog" class="bg-dark text-light p-3 rounded font-monospace" 
                                             style="height: 200px; overflow-y: auto; font-size: 0.85rem; white-space: pre-wrap;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Eyetracking Panel -->
                <div class="tab-pane fade" id="eyetracking-panel" role="tabpanel" aria-labelledby="eyetracking-tab">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <div class="bg-warning bg-opacity-10 rounded-circle p-3 me-3">
                                    <i class="fas fa-eye fa-2x text-warning"></i>
                                </div>
                                <div>
                                    <h5 class="mb-1">Eyetracking Data Conversion</h5>
                                    <p class="text-muted mb-0">Convert SR Research EyeLink recordings (.edf) to PRISM format</p>
                                </div>
                            </div>

                            <!-- Sub-tabs for single vs batch -->
                            <ul class="nav nav-tabs nav-sm mb-3" id="eyetrackingSubTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="eyetracking-single-tab" data-bs-toggle="tab" data-bs-target="#eyetracking-single" type="button" role="tab">
                                        <i class="fas fa-file me-1"></i>Single File
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="eyetracking-batch-tab" data-bs-toggle="tab" data-bs-target="#eyetracking-batch" type="button" role="tab">
                                        <i class="fas fa-folder-open me-1"></i>Batch (Multiple Files)
                                    </button>
                                </li>
                            </ul>

                            <div class="tab-content" id="eyetrackingSubTabContent">
                                <!-- Single File -->
                                <div class="tab-pane fade show active" id="eyetracking-single" role="tabpanel">
                                    <div class="row g-3 align-items-end">
                                        <div class="col-md-4">
                                            <label for="eyetrackingSingleFile" class="form-label">EyeLink Recording (.edf)</label>
                                            <input class="form-control" type="file" id="eyetrackingSingleFile" accept=".edf">
                                        </div>
                                        <div class="col-md-2">
                                            <label for="eyetrackingSubject" class="form-label">Subject ID</label>
                                            <input type="text" class="form-control" id="eyetrackingSubject" placeholder="e.g. 001">
                                        </div>
                                        <div class="col-md-2">
                                            <label for="eyetrackingSession" class="form-label">Session (optional)</label>
                                            <input type="text" class="form-control" id="eyetrackingSession" placeholder="e.g. 1">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="eyetrackingTask" class="form-label">Task Name</label>
                                            <input type="text" class="form-control" id="eyetrackingTask" value="gaze" placeholder="e.g. antisaccade">
                                        </div>
                                        <div class="col-md-4">
                                            <button class="btn btn-warning w-100" type="button" id="eyetrackingSingleConvertBtn" disabled>
                                                <i class="fas fa-wand-magic-sparkles me-2"></i>Convert
                                            </button>
                                        </div>
                                    </div>
                                    <div id="eyetrackingSingleError" class="alert alert-danger d-none mt-3"></div>
                                    <div id="eyetrackingSingleInfo" class="alert alert-info d-none mt-3"></div>
                                </div>

                                <!-- Batch -->
                                <div class="tab-pane fade" id="eyetracking-batch" role="tabpanel">
                                    <div class="alert alert-light border mb-3">
                                        <i class="fas fa-info-circle me-2 text-info"></i>
                                        <strong>File naming required:</strong> <code>sub-XXX_ses-YYY_task-ZZZ.edf</code>
                                        <br><small class="text-muted">Example: <code>sub-003_ses-1_task-antisaccade.edf</code> · Session is optional</small>
                                    </div>
                                    <div class="row g-3 align-items-end">
                                        <div class="col-md-6">
                                            <label for="eyetrackingBatchFiles" class="form-label">Select EDF Files</label>
                                            <input class="form-control" type="file" id="eyetrackingBatchFiles" accept=".edf" multiple>
                                            <small class="text-muted">Select all files (Ctrl+A / Cmd+A)</small>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="eyetrackingBatchDatasetName" class="form-label">Dataset Name</label>
                                            <input type="text" class="form-control" id="eyetrackingBatchDatasetName" value="Eyetracking Dataset">
                                        </div>
                                        <div class="col-md-3">
                                            <button class="btn btn-warning w-100" type="button" id="eyetrackingBatchConvertBtn" disabled>
                                                <i class="fas fa-wand-magic-sparkles me-2"></i>Convert All & Download
                                            </button>
                                        </div>
                                    </div>
                                    <div id="eyetrackingBatchError" class="alert alert-danger d-none mt-3"></div>
                                    <div id="eyetrackingBatchInfo" class="alert alert-info d-none mt-3"></div>
                                    <div id="eyetrackingBatchProgress" class="progress d-none mt-3" style="height: 25px;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-warning" style="width: 100%">Converting...</div>
                                    </div>
                                    <!-- Log Window -->
                                    <div id="eyetrackingBatchLogContainer" class="d-none mt-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <label class="form-label mb-0"><i class="fas fa-terminal me-2"></i>Conversion Log</label>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" id="eyetrackingBatchLogClearBtn">
                                                <i class="fas fa-trash-alt me-1"></i>Clear
                                            </button>
                                        </div>
                                        <div id="eyetrackingBatchLog" class="bg-dark text-light p-3 rounded font-monospace" 
                                             style="height: 200px; overflow-y: auto; font-size: 0.85rem; white-space: pre-wrap;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Organize Panel -->
                <div class="tab-pane fade" id="organize-panel" role="tabpanel" aria-labelledby="organize-tab">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <div class="bg-warning bg-opacity-10 rounded-circle p-3 me-3">
                                    <i class="fas fa-folder-tree fa-2x text-warning"></i>
                                </div>
                                <div>
                                    <h5 class="mb-1">Batch File Organizer</h5>
                                    <p class="text-muted mb-0">Organize pre-formatted files into a PRISM/BIDS structure without conversion</p>
                                </div>
                            </div>

                            <div class="alert alert-light border mb-4">
                                <h6 class="fw-bold"><i class="fas fa-info-circle me-2 text-info"></i>How it works:</h6>
                                <p class="small mb-2">This tool takes a flat list of files and organizes them into <code>sub-XXX/ses-YYY/modality/</code> folders.</p>
                                <p class="small mb-0"><strong>Required naming:</strong> <code>sub-XXX_ses-YYY_task-ZZZ.ext</code> (Session is optional)</p>
                            </div>

                            <div class="row g-3 align-items-end">
                                <div class="col-md-6">
                                    <label for="organizeFiles" class="form-label">Select Files to Organize</label>
                                    <input class="form-control" type="file" id="organizeFiles" multiple>
                                    <div class="form-text">Supports .edf, .tsv, .nii.gz, .json, .png, etc.</div>
                                </div>
                                <div class="col-md-3">
                                    <label for="organizeModality" class="form-label">Target Modality</label>
                                    <select class="form-select" id="organizeModality">
                                        <option value="physio" selected>Physio (ECG, EDA, etc.)</option>
                                        <option value="eyetracking">Eyetracking</option>
                                        <option value="survey">Survey (TSV/JSON)</option>
                                        <option value="biometrics">Biometrics</option>
                                        <option value="anat">Anatomy (T1w)</option>
                                        <option value="func">Functional (BOLD)</option>
                                        <option value="extra">Extra / Other</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="organizeDatasetName" class="form-label">Dataset Name</label>
                                    <input type="text" class="form-control" id="organizeDatasetName" value="Organized Dataset">
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-warning text-white w-100" type="button" id="organizeBtn" disabled>
                                        <i class="fas fa-folder-plus me-2"></i>Organize & Download
                                    </button>
                                </div>
                            </div>

                            <div id="organizeError" class="alert alert-danger d-none mt-3"></div>
                            <div id="organizeInfo" class="alert alert-info d-none mt-3"></div>
                            <div id="organizeProgress" class="progress d-none mt-3" style="height: 25px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-warning text-dark" style="width: 100%">Organizing...</div>
                            </div>

                            <!-- Log Window -->
                            <div id="organizeLogContainer" class="d-none mt-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label class="form-label mb-0"><i class="fas fa-terminal me-2"></i>Organization Log</label>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="organizeLogClearBtn">
                                        <i class="fas fa-trash-alt me-1"></i>Clear
                                    </button>
                                </div>
                                <div id="organizeLog" class="bg-dark text-light p-3 rounded font-monospace" 
                                     style="height: 200px; overflow-y: auto; font-size: 0.85rem; white-space: pre-wrap;"></div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- LimeSurvey Quick Import ---
    const lssFile = document.getElementById('lssFile');
    const lssTaskName = document.getElementById('lssTaskName');
    const lssConvertBtn = document.getElementById('lssConvertBtn');
    const lssError = document.getElementById('lssError');

    // Single mode elements (combined)
    const lssResultSingle = document.getElementById('lssResultSingle');
    const lssQuestionCount = document.getElementById('lssQuestionCount');
    const lssPreviewBtn = document.getElementById('lssPreviewBtn');
    const lssDownloadBtn = document.getElementById('lssDownloadBtn');
    const lssPreview = document.getElementById('lssPreview');
    const lssPreviewContent = document.getElementById('lssPreviewContent');

    // Groups mode elements
    const lssResultMultiple = document.getElementById('lssResultMultiple');
    const lssGroupCount = document.getElementById('lssGroupCount');
    const lssTotalQuestions = document.getElementById('lssTotalQuestions');
    const lssDownloadAllBtn = document.getElementById('lssDownloadAllBtn');
    const lssQuestionnaireList = document.getElementById('lssQuestionnaireList');

    // Questions mode elements
    const lssResultQuestions = document.getElementById('lssResultQuestions');
    const lssIndividualCount = document.getElementById('lssIndividualCount');
    const lssDownloadAllQuestionsBtn = document.getElementById('lssDownloadAllQuestionsBtn');
    const lssQuestionsList = document.getElementById('lssQuestionsList');

    // Save to project elements
    const lssSaveGroupsToProjectBtn = document.getElementById('lssSaveGroupsToProjectBtn');
    const lssSaveQuestionsToProjectBtn = document.getElementById('lssSaveQuestionsToProjectBtn');
    const lssSaveSuccess = document.getElementById('lssSaveSuccess');
    const lssSaveSuccessMessage = document.getElementById('lssSaveSuccessMessage');

    let lssConvertedData = null;
    let lssSuggestedFilename = 'survey.json';
    let lssQuestionnaires = null; // For groups mode
    let lssIndividualQuestions = null; // For questions mode

    function getSelectedLssMode() {
        const checked = document.querySelector('input[name="lssMode"]:checked');
        return checked ? checked.value : 'groups';
    }

    lssFile.addEventListener('change', function() {
        lssConvertBtn.disabled = !lssFile.files.length;
        // Reset all results
        lssResultSingle.classList.add('d-none');
        lssResultMultiple.classList.add('d-none');
        lssResultQuestions.classList.add('d-none');
        lssError.classList.add('d-none');
        lssPreview.classList.add('d-none');
    });

    lssConvertBtn.addEventListener('click', async function() {
        if (!lssFile.files.length) return;

        const originalText = lssConvertBtn.innerHTML;
        lssConvertBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Converting...';
        lssConvertBtn.disabled = true;
        lssError.classList.add('d-none');
        lssResultSingle.classList.add('d-none');
        lssResultMultiple.classList.add('d-none');
        lssResultQuestions.classList.add('d-none');

        const formData = new FormData();
        formData.append('file', lssFile.files[0]);
        formData.append('task_name', lssTaskName.value || '');
        formData.append('mode', getSelectedLssMode());

        try {
            const response = await fetch('/api/limesurvey-to-prism', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.success) {
                if (data.mode === 'questions') {
                    // Individual questions mode
                    lssIndividualQuestions = data.questions;
                    lssIndividualCount.textContent = `${data.question_count} question templates`;

                    // Build question cards grouped by questionnaire
                    lssQuestionsList.innerHTML = '';

                    // Group questions by their group_name
                    const grouped = {};
                    for (const [code, qData] of Object.entries(data.questions)) {
                        const groupName = qData.group_name || 'Ungrouped';
                        if (!grouped[groupName]) grouped[groupName] = [];
                        grouped[groupName].push({code, ...qData});
                    }

                    // Sort groups by group_order
                    const sortedGroups = Object.entries(grouped).sort((a, b) => {
                        const orderA = a[1][0]?.group_order || 0;
                        const orderB = b[1][0]?.group_order || 0;
                        return orderA - orderB;
                    });

                    for (const [groupName, questions] of sortedGroups) {
                        // Group header
                        const groupHeader = document.createElement('div');
                        groupHeader.className = 'col-12 mt-2';
                        groupHeader.innerHTML = `<h6 class="text-muted border-bottom pb-1"><i class="fas fa-folder me-1"></i>${groupName}</h6>`;
                        lssQuestionsList.appendChild(groupHeader);

                        // Sort questions by question_order
                        questions.sort((a, b) => (a.question_order || 0) - (b.question_order || 0));

                        for (const q of questions) {
                            const card = document.createElement('div');
                            card.className = 'col-md-3';
                            const questionType = q.question_type || '';
                            const itemCount = q.item_count || 1;
                            const itemBadge = itemCount > 1 ? `<span class="badge bg-secondary ms-1">${itemCount} items</span>` : '';
                            // Get description from prism_json if available
                            const questionText = q.prism_json?.Study?.Description || '';
                            card.innerHTML = `
                                <div class="card h-100 card-hover">
                                    <div class="card-body py-2">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="small fw-bold text-truncate" title="${q.code}">${q.code}</div>
                                            <span class="badge bg-info small">${questionType}</span>
                                        </div>
                                        <div class="text-muted x-small text-truncate" title="${questionText}">${questionText}</div>
                                        ${itemBadge}
                                        <div class="mt-1">
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-secondary btn-sm lss-preview-question" data-code="${q.code}" title="Preview">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-outline-success btn-sm lss-download-question" data-code="${q.code}" data-filename="${q.suggested_filename}" title="Download">
                                                    <i class="fas fa-download"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                            lssQuestionsList.appendChild(card);
                        }
                    }
                    lssResultQuestions.classList.remove('d-none');

                } else if (data.mode === 'groups') {
                    // Multiple questionnaires (groups mode)
                    lssQuestionnaires = data.questionnaires;
                    lssGroupCount.textContent = `${data.questionnaire_count} questionnaires`;
                    lssTotalQuestions.textContent = `${data.total_questions} total questions`;

                    // Build questionnaire cards
                    lssQuestionnaireList.innerHTML = '';
                    for (const [name, qData] of Object.entries(data.questionnaires)) {
                        const card = document.createElement('div');
                        card.className = 'col-md-4';
                        card.innerHTML = `
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title"><i class="fas fa-file-alt me-1 text-success"></i>${name}</h6>
                                    <p class="card-text small text-muted">${qData.question_count} questions</p>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-secondary lss-preview-single" data-name="${name}">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-success lss-download-single" data-name="${name}" data-filename="${qData.suggested_filename}">
                                            <i class="fas fa-download"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        lssQuestionnaireList.appendChild(card);
                    }
                    lssResultMultiple.classList.remove('d-none');
                } else {
                    // Single combined JSON
                    lssConvertedData = data.prism_json;
                    lssSuggestedFilename = data.suggested_filename;
                    lssQuestionCount.textContent = `${data.question_count} questions`;
                    lssPreviewContent.textContent = JSON.stringify(lssConvertedData, null, 2);
                    lssResultSingle.classList.remove('d-none');
                }
            } else {
                lssError.textContent = data.error || 'Conversion failed';
                lssError.classList.remove('d-none');
            }
        } catch (err) {
            lssError.textContent = 'Error: ' + err.message;
            lssError.classList.remove('d-none');
        } finally {
            lssConvertBtn.innerHTML = originalText;
            lssConvertBtn.disabled = false;
        }
    });

    // Event delegation for dynamic questionnaire buttons
    lssQuestionnaireList.addEventListener('click', function(e) {
        const previewBtn = e.target.closest('.lss-preview-single');
        const downloadBtn = e.target.closest('.lss-download-single');

        if (previewBtn) {
            const name = previewBtn.dataset.name;
            if (lssQuestionnaires && lssQuestionnaires[name]) {
                alert(JSON.stringify(lssQuestionnaires[name].prism_json, null, 2).substring(0, 2000) + '...');
            }
        }

        if (downloadBtn) {
            const name = downloadBtn.dataset.name;
            const filename = downloadBtn.dataset.filename;
            if (lssQuestionnaires && lssQuestionnaires[name]) {
                downloadJson(lssQuestionnaires[name].prism_json, filename);
            }
        }
    });

    lssPreviewBtn.addEventListener('click', function() {
        lssPreview.classList.toggle('d-none');
        const icon = lssPreviewBtn.querySelector('i');
        icon.className = lssPreview.classList.contains('d-none') ? 'fas fa-eye me-1' : 'fas fa-eye-slash me-1';
    });

    lssDownloadBtn.addEventListener('click', function() {
        if (lssConvertedData) downloadJson(lssConvertedData, lssSuggestedFilename);
    });

    lssDownloadAllBtn.addEventListener('click', function() {
        if (!lssQuestionnaires) return;
        downloadAllAsZip(lssQuestionnaires);
    });

    // Event delegation for individual question buttons
    lssQuestionsList.addEventListener('click', function(e) {
        const previewBtn = e.target.closest('.lss-preview-question');
        const downloadBtn = e.target.closest('.lss-download-question');

        if (previewBtn) {
            const code = previewBtn.dataset.code;
            if (lssIndividualQuestions && lssIndividualQuestions[code]) {
                const json = JSON.stringify(lssIndividualQuestions[code].prism_json, null, 2);
                // Use a modal or better preview in the future
                alert(json.substring(0, 3000) + (json.length > 3000 ? '\n...(truncated)' : ''));
            }
        }

        if (downloadBtn) {
            const code = downloadBtn.dataset.code;
            const filename = downloadBtn.dataset.filename;
            if (lssIndividualQuestions && lssIndividualQuestions[code]) {
                downloadJson(lssIndividualQuestions[code].prism_json, filename);
            }
        }
    });

    lssDownloadAllQuestionsBtn.addEventListener('click', function() {
        if (!lssIndividualQuestions) return;
        downloadAllQuestionsAsZip(lssIndividualQuestions);
    });

    function downloadJson(data, filename) {
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    async function downloadAllAsZip(questionnaires) {
        // Use JSZip if available, otherwise download individually
        if (typeof JSZip !== 'undefined') {
            const zip = new JSZip();
            for (const [name, qData] of Object.entries(questionnaires)) {
                zip.file(qData.suggested_filename, JSON.stringify(qData.prism_json, null, 2));
            }
            const blob = await zip.generateAsync({type: 'blob'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'limesurvey_questionnaires.zip';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        } else {
            // Fallback: download each file individually
            for (const [name, qData] of Object.entries(questionnaires)) {
                downloadJson(qData.prism_json, qData.suggested_filename);
                await new Promise(r => setTimeout(r, 300)); // Small delay between downloads
            }
        }
    }

    async function downloadAllQuestionsAsZip(questions) {
        // Use JSZip if available, otherwise download individually
        if (typeof JSZip !== 'undefined') {
            const zip = new JSZip();
            for (const [code, qData] of Object.entries(questions)) {
                zip.file(qData.suggested_filename, JSON.stringify(qData.prism_json, null, 2));
            }
            const blob = await zip.generateAsync({type: 'blob'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'limesurvey_question_templates.zip';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        } else {
            // Fallback: download each file individually
            for (const [code, qData] of Object.entries(questions)) {
                downloadJson(qData.prism_json, qData.suggested_filename);
                await new Promise(r => setTimeout(r, 300)); // Small delay between downloads
            }
        }
    }

    // --- Save to Project handlers ---
    async function saveTemplatesToProject(templates) {
        try {
            const response = await fetch('/api/limesurvey-save-to-project', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ templates })
            });
            const data = await response.json();

            if (data.success) {
                lssSaveSuccessMessage.textContent = `Saved ${data.saved_count} template(s) to ${data.library_path}`;
                lssSaveSuccess.classList.remove('d-none');
                return true;
            } else {
                alert('Error: ' + (data.error || 'Failed to save templates'));
                return false;
            }
        } catch (err) {
            alert('Error saving to project: ' + err.message);
            return false;
        }
    }

    // Save groups to project
    if (lssSaveGroupsToProjectBtn) {
        lssSaveGroupsToProjectBtn.addEventListener('click', async function() {
            if (!lssQuestionnaires) return;

            // Get groups that have fields marked as participant metadata
            const participantGroups = new Set();
            for (const fieldInfo of Object.values(selectedParticipantFields)) {
                if (fieldInfo.fullMetadata?.Position?.Group) {
                    participantGroups.add(fieldInfo.fullMetadata.Position.Group.toLowerCase());
                }
            }

            // Filter out participant metadata groups
            const templates = Object.entries(lssQuestionnaires)
                .filter(([name]) => !participantGroups.has(name.toLowerCase()))
                .map(([name, qData]) => ({
                    filename: qData.suggested_filename,
                    content: qData.prism_json
                }));

            lssSaveGroupsToProjectBtn.disabled = true;
            lssSaveGroupsToProjectBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';

            await saveTemplatesToProject(templates);

            lssSaveGroupsToProjectBtn.disabled = false;
            lssSaveGroupsToProjectBtn.innerHTML = '<i class="fas fa-folder-plus me-1"></i>Save to Project';
        });
    }

    // Save individual questions to project
    if (lssSaveQuestionsToProjectBtn) {
        lssSaveQuestionsToProjectBtn.addEventListener('click', async function() {
            if (!lssIndividualQuestions) return;

            // Get question codes that are marked as participant metadata
            const participantCodes = new Set(Object.keys(selectedParticipantFields).map(c => c.toLowerCase()));

            // Filter out participant metadata questions
            const templates = Object.entries(lssIndividualQuestions)
                .filter(([code]) => !participantCodes.has(code.toLowerCase()))
                .map(([code, qData]) => ({
                    filename: qData.suggested_filename,
                    content: qData.prism_json
                }));

            lssSaveQuestionsToProjectBtn.disabled = true;
            lssSaveQuestionsToProjectBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';

            await saveTemplatesToProject(templates);

            lssSaveQuestionsToProjectBtn.disabled = false;
            lssSaveQuestionsToProjectBtn.innerHTML = '<i class="fas fa-folder-plus me-1"></i>Save to Project';
        });
    }

    // --- Survey Convert ---
    const convertLibraryPathInput = document.getElementById('convertLibraryPath');
    const convertBrowseLibraryBtn = document.getElementById('convertBrowseLibraryBtn');
    const convertBrowseFileBtn = document.getElementById('convertBrowseFileBtn');
    const convertClearFileBtn = document.getElementById('convertClearFileBtn');
    const convertFileDisplay = document.getElementById('convertFileDisplay');
    const convertFileSource = document.getElementById('convertFileSource');
    const convertSelectedFilePath = document.getElementById('convertSelectedFilePath');
    const convertExcelFile = document.getElementById('convertExcelFile');
    const convertAliasFile = document.getElementById('convertAliasFile');
    const convertBtn = document.getElementById('convertBtn');
    const convertDatasetName = document.getElementById('convertDatasetName');
    const convertUnknown = document.getElementById('convertUnknown');
    const convertLanguage = document.getElementById('convertLanguage');
    const convertError = document.getElementById('convertError');
    const convertInfo = document.getElementById('convertInfo');

    // --- Biometrics Convert ---
    const biometricsLibraryPathInput = document.getElementById('biometricsLibraryPath');
    const biometricsBrowseLibraryBtn = document.getElementById('biometricsBrowseLibraryBtn');
    const biometricsDataFile = document.getElementById('biometricsDataFile');
    const biometricsDatasetName = document.getElementById('biometricsDatasetName');
    const biometricsUnknown = document.getElementById('biometricsUnknown');
    const biometricsConvertBtn = document.getElementById('biometricsConvertBtn');
    const biometricsError = document.getElementById('biometricsError');
    const biometricsInfo = document.getElementById('biometricsInfo');

    // --- Physio Convert (Single) ---
    const physioRawFile = document.getElementById('physioRawFile');
    const physioTask = document.getElementById('physioTask');
    const physioSamplingRate = document.getElementById('physioSamplingRate');
    const physioConvertBtn = document.getElementById('physioConvertBtn');
    const physioError = document.getElementById('physioError');
    const physioInfo = document.getElementById('physioInfo');

    // --- Physio Convert (Batch) ---
    const physioBatchFiles = document.getElementById('physioBatchFiles');
    const physioBatchDatasetName = document.getElementById('physioBatchDatasetName');
    const physioBatchSamplingRate = document.getElementById('physioBatchSamplingRate');
    const physioBatchConvertBtn = document.getElementById('physioBatchConvertBtn');
    const physioBatchError = document.getElementById('physioBatchError');
    const physioBatchInfo = document.getElementById('physioBatchInfo');
    const physioBatchProgress = document.getElementById('physioBatchProgress');
    const physioBatchLogContainer = document.getElementById('physioBatchLogContainer');
    const physioBatchLog = document.getElementById('physioBatchLog');
    const physioBatchLogClearBtn = document.getElementById('physioBatchLogClearBtn');

    // --- Eyetracking Convert (Single) ---
    const eyetrackingSingleFile = document.getElementById('eyetrackingSingleFile');
    const eyetrackingSubject = document.getElementById('eyetrackingSubject');
    const eyetrackingSession = document.getElementById('eyetrackingSession');
    const eyetrackingTask = document.getElementById('eyetrackingTask');
    const eyetrackingSingleConvertBtn = document.getElementById('eyetrackingSingleConvertBtn');
    const eyetrackingSingleError = document.getElementById('eyetrackingSingleError');
    const eyetrackingSingleInfo = document.getElementById('eyetrackingSingleInfo');

    // --- Eyetracking Convert (Batch) ---
    const eyetrackingBatchFiles = document.getElementById('eyetrackingBatchFiles');
    const eyetrackingBatchDatasetName = document.getElementById('eyetrackingBatchDatasetName');
    const eyetrackingBatchConvertBtn = document.getElementById('eyetrackingBatchConvertBtn');
    const eyetrackingBatchError = document.getElementById('eyetrackingBatchError');
    const eyetrackingBatchInfo = document.getElementById('eyetrackingBatchInfo');
    const eyetrackingBatchProgress = document.getElementById('eyetrackingBatchProgress');
    const eyetrackingBatchLogContainer = document.getElementById('eyetrackingBatchLogContainer');
    const eyetrackingBatchLog = document.getElementById('eyetrackingBatchLog');
    const eyetrackingBatchLogClearBtn = document.getElementById('eyetrackingBatchLogClearBtn');

    // --- Organize (Batch) ---
    const organizeFiles = document.getElementById('organizeFiles');
    const organizeDatasetName = document.getElementById('organizeDatasetName');
    const organizeModality = document.getElementById('organizeModality');
    const organizeBtn = document.getElementById('organizeBtn');
    const organizeError = document.getElementById('organizeError');
    const organizeInfo = document.getElementById('organizeInfo');
    const organizeProgress = document.getElementById('organizeProgress');
    const organizeLogContainer = document.getElementById('organizeLogContainer');
    const organizeLog = document.getElementById('organizeLog');
    const organizeLogClearBtn = document.getElementById('organizeLogClearBtn');

    // --- Physio Renamer ---
    const renamerFiles = document.getElementById('renamerFiles');
    const renamerPattern = document.getElementById('renamerPattern');
    const renamerReplacement = document.getElementById('renamerReplacement');
    const renamerTask = document.getElementById('renamerTask');
    const renamerDryRunBtn = document.getElementById('renamerDryRunBtn');
    const renamerDownloadBtn = document.getElementById('renamerDownloadBtn');
    const renamerResetBtn = document.getElementById('renamerResetBtn');
    const renamerPreview = document.getElementById('renamerPreview');
    const renamerPreviewBody = document.getElementById('renamerPreviewBody');
    const renamerFilterAll = document.getElementById('renamerFilterAll');
    const renamerFilterUnmatched = document.getElementById('renamerFilterUnmatched');
    const renamerError = document.getElementById('renamerError');
    const renamerInfo = document.getElementById('renamerInfo');

    if (convertBrowseLibraryBtn && convertLibraryPathInput) {
        convertBrowseLibraryBtn.addEventListener('click', function() {
            fetch('/api/browse-folder')
                .then(r => r.json())
                .then(data => {
                    if (data.path) {
                        convertLibraryPathInput.value = data.path;
                        refreshConvertLanguages();
                    }
                });
        });
    }

    if (biometricsBrowseLibraryBtn) {
        biometricsBrowseLibraryBtn.addEventListener('click', function() {
            fetch('/api/browse-folder')
                .then(r => r.json())
                .then(data => {
                    if (data.path && biometricsLibraryPathInput) {
                        biometricsLibraryPathInput.value = data.path;
                    }
                });
        });
    }

    // Helper function to update file display and state
    function updateFileSelection(filename, source, fullPath = null) {
        if (convertFileDisplay) {
            convertFileDisplay.value = filename || '';
            convertFileDisplay.placeholder = filename ? '' : 'No file selected';
        }
        if (convertFileSource) {
            convertFileSource.value = source || '';
        }
        if (convertSelectedFilePath) {
            convertSelectedFilePath.value = fullPath || '';
        }
        if (convertClearFileBtn) {
            if (filename) {
                convertClearFileBtn.classList.remove('d-none');
            } else {
                convertClearFileBtn.classList.add('d-none');
            }
        }
        // Update hint based on source
        const fileHint = document.getElementById('convertFileHint');
        if (fileHint) {
            if (filename && source === 'browse') {
                fileHint.innerHTML = `<span class="text-success"><i class="fas fa-server me-1"></i>Server file: <code>${filename}</code></span>`;
            } else if (filename && source === 'upload') {
                fileHint.innerHTML = `<span class="text-primary"><i class="fas fa-upload me-1"></i>Uploaded: <code>${filename}</code></span>`;
            } else {
                fileHint.innerHTML = `<span class="text-muted"><i class="fas fa-info-circle me-1"></i>.lss/.lsa for LimeSurvey, .xlsx/.csv for other sources</span>`;
            }
        }
        updateConvertBtn();
    }

    // Clear file selection
    function clearFileSelection() {
        if (convertExcelFile) convertExcelFile.value = '';
        updateFileSelection('', '', '');
    }

    // Display field click - trigger browse function (same as browse button)
    if (convertFileDisplay && convertBrowseFileBtn) {
        convertFileDisplay.addEventListener('click', function() {
            convertBrowseFileBtn.click();
        });
    }

    // File input change handler (for uploads)
    if (convertExcelFile) {
        convertExcelFile.addEventListener('change', async function() {
            const file = this.files?.[0];
            if (file) {
                updateFileSelection(file.name, 'upload');

                const filename = file.name.toLowerCase();
                // Auto-switch to template mode for .lss files
                if (filename.endsWith('.lss')) {
                    if (convertModeTemplate) {
                        convertModeTemplate.checked = true;
                        handleModeSwitch();
                    }
                    convertInfo.innerHTML = '<i class="fas fa-info-circle me-1"></i>.lss files contain structure only (no response data). Using Template Generation mode.';
                    convertInfo.classList.remove('d-none');
                } else {
                    convertInfo.classList.add('d-none');
                }
                // Detect columns for ID selection
                await detectFileColumns(file);
            } else {
                clearFileSelection();
            }
        });
    }

    // Clear button
    if (convertClearFileBtn) {
        convertClearFileBtn.addEventListener('click', function() {
            clearFileSelection();
        });
    }

    // Browse for survey file - defaults to project's sourcedata folder
    if (convertBrowseFileBtn) {
        convertBrowseFileBtn.addEventListener('click', async function() {
            // Get the project's sourcedata path from API
            let initialPath = '';
            try {
                const projResponse = await fetch('/api/projects/library-path');
                const projData = await projResponse.json();
                if (projData.sourcedata_path) {
                    // Use the server-provided sourcedata path (correct OS path separators)
                    initialPath = projData.sourcedata_path;
                    console.log('Browse file initial path:', initialPath);
                } else if (projData.project_path) {
                    // Fallback to project root
                    initialPath = projData.project_path;
                    console.log('No sourcedata, using project path:', initialPath);
                } else {
                    console.warn('No project selected - using default browse location');
                    convertInfo.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>No project selected. Select a project first to browse from sourcedata folder.';
                    convertInfo.classList.remove('d-none');
                }
            } catch (e) {
                console.warn('Could not get project path:', e);
            }

            const fileTypes = '*.xlsx,*.lsa,*.csv,*.tsv,*.lss';
            const url = `/api/browse-file?initial_path=${encodeURIComponent(initialPath)}&file_types=${encodeURIComponent(fileTypes)}`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.path) {
                    // Clear any uploaded file first
                    if (convertExcelFile) convertExcelFile.value = '';

                    const fileName = data.path.split(/[\\/]/).pop();
                    updateFileSelection(fileName, 'browse', data.path);

                    // Auto-switch to template mode for .lss files
                    if (fileName.toLowerCase().endsWith('.lss')) {
                        if (convertModeTemplate) {
                            convertModeTemplate.checked = true;
                            handleModeSwitch();
                        }
                        convertInfo.innerHTML = '<i class="fas fa-info-circle me-1"></i>.lss files contain structure only (no response data). Using Template Generation mode.';
                        convertInfo.classList.remove('d-none');
                    }

                    // Detect columns for ID selection (server file path)
                    await detectFileColumns(data.path);
                }
            } catch (err) {
                console.error('Error browsing for file:', err);
            }
        });
    }

    function downloadBase64Zip(base64Data, filename) {
        const binaryString = window.atob(base64Data);
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
        }
        const blob = new Blob([bytes], {type: 'application/zip'});
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
    }

    function refreshConvertLanguages() {
        const libraryPath = convertLibraryPathInput ? convertLibraryPathInput.value.trim() : '';
        const surveyI18nWarning = document.getElementById('surveyI18nWarning');
        const surveyI18nMessage = document.getElementById('surveyI18nMessage');
        const surveyStructureWarning = document.getElementById('surveyStructureWarning');
        const surveyStructureMessage = document.getElementById('surveyStructureMessage');
        
        if (!libraryPath) {
            // Hide warnings and reset languages if no path
            if (surveyI18nWarning) surveyI18nWarning.classList.add('d-none');
            if (surveyStructureWarning) surveyStructureWarning.classList.add('d-none');
            return;
        }
        
        const url = `/api/survey-languages?library_path=${encodeURIComponent(libraryPath)}`;
        fetch(url)
            .then(r => r.json())
            .then(data => {
                if (!convertLanguage) return;
                const current = convertLanguage.value || 'auto';

                // Reset options (keep Auto)
                convertLanguage.innerHTML = '';
                const autoOpt = document.createElement('option');
                autoOpt.value = 'auto';
                autoOpt.textContent = 'Auto (template default)';
                convertLanguage.appendChild(autoOpt);

                const langs = (data && data.languages) ? data.languages : [];
                langs.forEach(lang => {
                    const opt = document.createElement('option');
                    opt.value = lang;
                    opt.textContent = lang;
                    convertLanguage.appendChild(opt);
                });

                const preferred = (data && data.default) ? data.default : null;
                if (preferred && langs.includes(preferred)) {
                    convertLanguage.value = preferred;
                } else if (langs.includes(current)) {
                    convertLanguage.value = current;
                } else {
                    convertLanguage.value = 'auto';
                }
                
                // Show structure warning if missing folders/files
                if (surveyStructureWarning && surveyStructureMessage && data.structure) {
                    const missing = data.structure.missing_items || [];
                    if (missing.length > 0) {
                        surveyStructureMessage.textContent = `The selected folder is missing: ${missing.join(', ')}. Expected library structure: survey/, biometrics/, participants.json`;
                        surveyStructureWarning.classList.remove('d-none');
                    } else {
                        surveyStructureWarning.classList.add('d-none');
                    }
                } else if (surveyStructureWarning) {
                    surveyStructureWarning.classList.add('d-none');
                }
                
                // Show I18n warning if templates don't have multilanguage support
                if (surveyI18nWarning && surveyI18nMessage) {
                    const hasI18n = langs.length > 0;
                    const templateCount = data.template_count || 0;
                    const i18nCount = data.i18n_count || 0;
                    
                    if (!hasI18n || (templateCount > 0 && i18nCount < templateCount)) {
                        const missing = templateCount - i18nCount;
                        if (!hasI18n) {
                            surveyI18nMessage.textContent = 'No templates with multilanguage (I18n) configuration found. Consider adding I18n block with Languages array to your templates.';
                        } else if (missing > 0) {
                            surveyI18nMessage.textContent = `${missing} of ${templateCount} templates lack multilanguage (I18n) configuration. Available languages: ${langs.join(', ')}`;
                        }
                        surveyI18nWarning.classList.remove('d-none');
                    } else {
                        surveyI18nWarning.classList.add('d-none');
                    }
                }
            })
            .catch(() => {
                // If this fails, keep the dropdown as-is (Auto only)
                if (surveyI18nWarning) surveyI18nWarning.classList.add('d-none');
                if (surveyStructureWarning) surveyStructureWarning.classList.add('d-none');
            });
    }

    if (convertLibraryPathInput) {
        convertLibraryPathInput.addEventListener('change', function() {
            refreshConvertLanguages();
            updateConvertBtn();
        });
        convertLibraryPathInput.addEventListener('blur', function() {
            refreshConvertLanguages();
            updateConvertBtn();
        });
    }

    // --- Conversion Mode Elements ---
    const convertModeData = document.getElementById('convertModeData');
    const convertModeTemplate = document.getElementById('convertModeTemplate');
    const convertIdColumnGroup = document.getElementById('convertIdColumnGroup');
    const convertIdColumn = document.getElementById('convertIdColumn');
    const convertTemplateExportGroup = document.getElementById('convertTemplateExportGroup');
    const convertTemplateExport = document.getElementById('convertTemplateExport');
    const convertLanguageGroup = document.getElementById('convertLanguageGroup');
    const templateResultsContainer = document.getElementById('templateResultsContainer');

    // Get current conversion mode
    function getConvertMode() {
        return document.querySelector('input[name="convertMode"]:checked')?.value || 'data';
    }

    // Handle mode switching
    function handleModeSwitch() {
        const mode = getConvertMode();
        const filename = convertExcelFile.files?.[0]?.name?.toLowerCase() || '';
        const isLimeSurvey = filename.endsWith('.lss') || filename.endsWith('.lsa');

        if (mode === 'template') {
            // Template generation mode
            convertIdColumnGroup?.classList.add('d-none');
            convertTemplateExportGroup?.classList.remove('d-none');
            convertLanguageGroup?.classList.add('d-none');

            // Hide library path requirement for template mode (not needed for structure)
            const libPathLabel = convertLibraryPathInput?.closest('.col-12')?.querySelector('.form-label');
            if (libPathLabel) {
                libPathLabel.innerHTML = 'Template Library Root <span class="text-muted">(optional)</span>';
            }
        } else {
            // Data conversion mode
            convertIdColumnGroup?.classList.remove('d-none');
            convertTemplateExportGroup?.classList.add('d-none');
            convertLanguageGroup?.classList.remove('d-none');

            // Show library path as required
            const libPathLabel = convertLibraryPathInput?.closest('.col-12')?.querySelector('.form-label');
            if (libPathLabel) {
                libPathLabel.innerHTML = 'Template Library Root <span class="text-danger">*</span>';
            }
        }

        updateConvertBtn();
    }

    // Mode switch listeners
    if (convertModeData) {
        convertModeData.addEventListener('change', handleModeSwitch);
    }
    if (convertModeTemplate) {
        convertModeTemplate.addEventListener('change', handleModeSwitch);
    }

    // ========================================
    // Participants.json Schema Integration
    // ========================================

    // Cache for participants.json schema
    let cachedParticipantsSchema = null;

    // Fetch participants.json schema from current project
    async function fetchParticipantsSchema() {
        try {
            const response = await fetch('/api/projects/participants');
            if (response.ok) {
                const data = await response.json();
                if (data.success && data.exists && data.schema) {
                    cachedParticipantsSchema = data.schema;
                    console.log('[Participants] Schema loaded:', Object.keys(data.schema));
                    // Pre-populate ID column dropdown from participants.json
                    prefillIdColumnFromSchema();
                    return data.schema;
                }
            }
        } catch (e) {
            console.warn('[Participants] Could not load schema:', e);
        }
        cachedParticipantsSchema = null;
        return null;
    }

    // Pre-fill the ID column dropdown from participants.json _sourceField
    function prefillIdColumnFromSchema() {
        const idColumnSelect = document.getElementById('convertIdColumn');
        const idColumnStatus = document.getElementById('idColumnStatus');
        const idColumnHelp = document.getElementById('idColumnHelp');
        if (!idColumnSelect || !cachedParticipantsSchema) return;

        const schemaParticipantId = cachedParticipantsSchema.participant_id;
        const sourceField = schemaParticipantId?._sourceField;

        if (sourceField) {
            // Add the sourceField as the first option (pre-selected)
            idColumnSelect.innerHTML = `<option value="${sourceField}" selected>${sourceField} (from participants.json)</option>`;
            if (idColumnStatus) {
                idColumnStatus.innerHTML = '<i class="fas fa-file-code text-info" title="From participants.json"></i>';
            }
            if (idColumnHelp) {
                idColumnHelp.innerHTML = `<i class="fas fa-file-code text-info me-1"></i>From participants.json: <strong>${sourceField}</strong> -> participant_id`;
            }
            console.log('[Participants] ID column pre-filled from participants.json:', sourceField);
        }
    }

    // Check if participants.json defines participant_id
    function getParticipantIdFromSchema() {
        if (cachedParticipantsSchema && cachedParticipantsSchema.participant_id) {
            return 'participant_id';
        }
        return null;
    }

    // Load schema on page init
    fetchParticipantsSchema();

    // Detect columns from file for ID column selector
    // Accepts either a File object or a server file path string
    async function detectFileColumns(fileOrPath) {
        const isFilePath = typeof fileOrPath === 'string';
        const filename = isFilePath ? fileOrPath.split(/[\\/]/).pop().toLowerCase() : fileOrPath.name.toLowerCase();
        const idColumnSelect = document.getElementById('convertIdColumn');
        const idColumnStatus = document.getElementById('idColumnStatus');
        const idColumnHelp = document.getElementById('idColumnHelp');
        if (!idColumnSelect) return;

        // Ensure participants.json schema is loaded first
        if (!cachedParticipantsSchema) {
            await fetchParticipantsSchema();
        }

        // Check for participants.json _sourceField before resetting
        const schemaParticipantId = cachedParticipantsSchema?.participant_id;
        const schemaSourceField = schemaParticipantId?._sourceField;

        // Reset dropdown but keep participants.json option if available
        if (schemaSourceField) {
            idColumnSelect.innerHTML = `<option value="">-- Select ID column --</option><option value="${schemaSourceField}" selected>${schemaSourceField} (from participants.json)</option>`;
        } else {
            idColumnSelect.innerHTML = '<option value="">-- Select ID column --</option>';
        }

        // For .lss files, no columns to detect (structure only)
        if (filename.endsWith('.lss')) {
            if (idColumnStatus) idColumnStatus.innerHTML = '<span class="text-muted">(structure only)</span>';
            if (idColumnHelp) idColumnHelp.innerHTML = '<i class="fas fa-info-circle me-1"></i>.lss files have no response data';
            return;
        }

        // Show loading status
        if (idColumnStatus) idColumnStatus.innerHTML = '<span class="text-info"><i class="fas fa-spinner fa-spin me-1"></i>Loading...</span>';

        // For .lsa and other files, try to detect columns
        if (filename.endsWith('.lsa') || filename.endsWith('.xlsx') || filename.endsWith('.csv') || filename.endsWith('.tsv')) {
            try {
                let fetchOptions;
                if (isFilePath) {
                    // Server file path - send as JSON
                    fetchOptions = {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ file_path: fileOrPath })
                    };
                } else {
                    // Uploaded file - send as FormData
                    const formData = new FormData();
                    formData.append('file', fileOrPath);
                    fetchOptions = {
                        method: 'POST',
                        body: formData
                    };
                }

                const response = await fetch('/api/detect-columns', fetchOptions);

                if (response.ok) {
                    const data = await response.json();
                    if (data.columns && data.columns.length > 0) {
                        // Check if participants.json defines participant_id with _sourceField
                        const schemaParticipantId = cachedParticipantsSchema?.participant_id;
                        const schemaSourceField = schemaParticipantId?._sourceField;
                        let autoSelectedId = null;
                        let selectionSource = '';

                        // Priority 1: If participants.json exists with participant_id._sourceField, use that exact column
                        let schemaFieldNotFound = false;
                        if (schemaSourceField) {
                            // Look for the _sourceField column in the data (case-insensitive)
                            const exactMatch = data.columns.find(c => c.toLowerCase() === schemaSourceField.toLowerCase());
                            if (exactMatch) {
                                autoSelectedId = exactMatch;
                                selectionSource = 'from participants.json';
                            } else {
                                // _sourceField not found in columns - will use fallback
                                schemaFieldNotFound = true;
                                console.warn(`[Participants] _sourceField "${schemaSourceField}" not found in data columns`);
                            }
                        }

                        // Priority 2: Backend suggestion
                        if (!autoSelectedId && data.suggested_id_column) {
                            autoSelectedId = data.suggested_id_column;
                            selectionSource = 'suggested';
                        }

                        // Priority 3: Pattern matching fallback
                        if (!autoSelectedId) {
                            const idPatterns = [
                                'participant_id', 'participantid', 'participant',
                                'subject_id', 'subjectid', 'subject',
                                'code', 'id', 'token',
                                'prolific_id', 'prolificid',
                                'respondent_id', 'respondentid'
                            ];
                            for (const pattern of idPatterns) {
                                for (const col of data.columns) {
                                    const colLower = col.toLowerCase().replace(/[_-]/g, '');
                                    if (colLower === pattern || colLower.includes(pattern)) {
                                        autoSelectedId = col;
                                        selectionSource = 'pattern match';
                                        break;
                                    }
                                }
                                if (autoSelectedId) break;
                            }
                        }

                        // Common patterns for highlighting
                        const idPatterns = [
                            'participant_id', 'participantid', 'participant',
                            'subject_id', 'subjectid', 'subject',
                            'code', 'id', 'token',
                            'prolific_id', 'prolificid',
                            'respondent_id', 'respondentid'
                        ];

                        // Clear dropdown and rebuild with proper options
                        idColumnSelect.innerHTML = '<option value="">-- Select ID column --</option>';

                        // Add detected columns (user can always select any)
                        data.columns.forEach(col => {
                            const opt = document.createElement('option');
                            opt.value = col;
                            opt.textContent = col;
                            // Highlight likely ID columns
                            const colLower = col.toLowerCase();
                            if (idPatterns.some(p => colLower.includes(p))) {
                                opt.textContent += ' ★';
                            }
                            // Mark if from participants.json or auto-detected
                            if (col === autoSelectedId) {
                                opt.textContent += ` (${selectionSource})`;
                                opt.selected = true;
                            }
                            idColumnSelect.appendChild(opt);
                        });

                        // Set the auto-selected value
                        if (autoSelectedId) {
                            idColumnSelect.value = autoSelectedId;
                        }

                        // Update status
                        if (idColumnStatus) {
                            const schemaInfo = schemaSourceField ? ` <i class="fas fa-file-code text-info" title="participants.json: ${schemaSourceField} → participant_id"></i>` : '';
                            idColumnStatus.innerHTML = `<span class="text-success"><i class="fas fa-check me-1"></i>${data.columns.length} columns</span>${schemaInfo}`;
                        }
                        if (idColumnHelp) {
                            if (autoSelectedId) {
                                let schemaNote = '';
                                if (schemaSourceField && !schemaFieldNotFound) {
                                    schemaNote = `<br><small class="text-info"><i class="fas fa-file-code me-1"></i>participants.json: <strong>${schemaSourceField}</strong> → participant_id</small>`;
                                } else if (schemaSourceField && schemaFieldNotFound) {
                                    schemaNote = `<br><small class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i>participants.json expects "<strong>${schemaSourceField}</strong>" but column not found in data. Using fallback.</small>`;
                                }
                                idColumnHelp.innerHTML = `<i class="fas fa-lightbulb me-1 text-warning"></i>Auto-selected: <strong>${autoSelectedId}</strong> (★ = likely ID columns)${schemaNote}`;
                            } else {
                                idColumnHelp.innerHTML = '<i class="fas fa-exclamation-triangle me-1 text-warning"></i>No common ID column found. Please select manually.';
                            }
                        }

                        // Update convert button state
                        updateConvertBtn();
                    } else {
                        if (idColumnStatus) idColumnStatus.innerHTML = '<span class="text-warning">No columns found</span>';
                    }
                } else {
                    const err = await response.json();
                    if (idColumnStatus) idColumnStatus.innerHTML = `<span class="text-danger">${err.error || 'Error'}</span>`;
                }
            } catch (e) {
                console.warn('Could not detect columns:', e);
                if (idColumnStatus) idColumnStatus.innerHTML = '<span class="text-danger">Failed to load</span>';
            }
        }
    }

    // Sync participant ID column selection from template generation to data conversion
    function syncParticipantIdToConversion() {
        const templateIdSelect = document.getElementById('participantIdColumn');
        const convertIdSelect = document.getElementById('convertIdColumn');
        if (!templateIdSelect || !convertIdSelect) return;

        const selectedId = templateIdSelect.value;
        if (selectedId) {
            // Check if this option exists in convert dropdown
            const existingOpt = Array.from(convertIdSelect.options).find(o => o.value === selectedId);
            if (existingOpt) {
                convertIdSelect.value = selectedId;
            } else {
                // Add the option if it doesn't exist
                const opt = document.createElement('option');
                opt.value = selectedId;
                opt.textContent = `${selectedId} (from template)`;
                opt.selected = true;
                convertIdSelect.appendChild(opt);
            }
        }
    }

    // Add listener to sync when participant ID is changed in template section
    const participantIdColSelect = document.getElementById('participantIdColumn');
    if (participantIdColSelect) {
        participantIdColSelect.addEventListener('change', syncParticipantIdToConversion);
    }

    function updateConvertBtn() {
        const hasUploadedFile = convertExcelFile.files && convertExcelFile.files.length === 1;
        const hasBrowsedFile = convertSelectedFilePath && convertSelectedFilePath.value.trim() !== '';
        const hasFile = hasUploadedFile || hasBrowsedFile;
        const mode = getConvertMode();

        if (mode === 'template') {
            // Template mode only needs a file
            convertBtn.disabled = !hasFile;
        } else {
            // Data mode needs file + library path + explicit ID column (not auto)
            const hasLibraryPath = convertLibraryPathInput && convertLibraryPathInput.value.trim() !== '';
            const idColumnSelect = document.getElementById('convertIdColumn');
            const hasIdColumn = idColumnSelect && idColumnSelect.value && idColumnSelect.value !== '' && idColumnSelect.value !== 'auto';
            convertBtn.disabled = !(hasFile && hasLibraryPath && hasIdColumn);

            // Show warning if missing ID column
            const idColumnHelp = document.getElementById('idColumnHelp');
            if (hasFile && hasLibraryPath && !hasIdColumn && idColumnHelp) {
                idColumnHelp.innerHTML = '<i class="fas fa-exclamation-triangle text-warning me-1"></i><strong>Required: Select the column containing participant IDs</strong>';
            }
        }

        // Update button text based on mode
        if (convertBtn) {
            if (mode === 'template') {
                convertBtn.innerHTML = '<i class="fas fa-file-code me-2"></i>Generate Template';
                convertBtn.classList.remove('btn-warning');
                convertBtn.classList.add('btn-success');
            } else {
                convertBtn.innerHTML = '<i class="fas fa-wand-magic-sparkles me-2"></i>Convert';
                convertBtn.classList.remove('btn-success');
                convertBtn.classList.add('btn-warning');
            }
        }
    }

    // Add listener for ID column changes to update convert button
    const convertIdColumnSelect = document.getElementById('convertIdColumn');
    if (convertIdColumnSelect) {
        convertIdColumnSelect.addEventListener('change', updateConvertBtn);
    }

    // Initialize mode on page load
    handleModeSwitch();
    updateConvertBtn();

    // Terminal log elements
    const conversionLogContainer = document.getElementById('conversionLogContainer');
    const conversionLog = document.getElementById('conversionLog');
    const conversionLogBody = document.getElementById('conversionLogBody');
    const toggleLogBtn = document.getElementById('toggleLogBtn');
    const validationResultsContainer = document.getElementById('validationResultsContainer');
    const validationResultsCard = document.getElementById('validationResultsCard');
    const validationResultsHeader = document.getElementById('validationResultsHeader');
    const validationBadge = document.getElementById('validationBadge');
    const validationSummary = document.getElementById('validationSummary');
    const validationDetails = document.getElementById('validationDetails');
    const downloadSection = document.getElementById('downloadSection');
    const downloadWarningSection = document.getElementById('downloadWarningSection');
    const downloadZipBtn = document.getElementById('downloadZipBtn');
    const downloadZipWarningBtn = document.getElementById('downloadZipWarningBtn');

    // Biometrics elements
    const biometricsLogContainer = document.getElementById('biometricsLogContainer');
    const biometricsLog = document.getElementById('biometricsLog');
    const biometricsLogBody = document.getElementById('biometricsLogBody');
    const toggleBiometricsLogBtn = document.getElementById('toggleBiometricsLogBtn');
    const biometricsValidationResultsContainer = document.getElementById('biometricsValidationResultsContainer');
    const biometricsValidationResultsCard = document.getElementById('biometricsValidationResultsCard');
    const biometricsValidationResultsHeader = document.getElementById('biometricsValidationResultsHeader');
    const biometricsValidationBadge = document.getElementById('biometricsValidationBadge');
    const biometricsValidationSummary = document.getElementById('biometricsValidationSummary');
    const biometricsValidationDetails = document.getElementById('biometricsValidationDetails');
    const biometricsDownloadSection = document.getElementById('biometricsDownloadSection');
    const biometricsDownloadWarningSection = document.getElementById('biometricsDownloadWarningSection');
    const biometricsDownloadZipBtn = document.getElementById('biometricsDownloadZipBtn');
    const biometricsDownloadZipWarningBtn = document.getElementById('biometricsDownloadZipWarningBtn');
    const biometricsDetectedContainer = document.getElementById('biometricsDetectedContainer');
    const biometricsDetectedList = document.getElementById('biometricsDetectedList');
    const biometricsConfirmBtn = document.getElementById('biometricsConfirmBtn');
    const biometricsSelectAll = document.getElementById('biometricsSelectAll');

    let currentZipBlob = null;
    let currentBiometricsZipBlob = null;
    let conversionLogMessages = []; // Store log messages for download

    // Download log button handler
    const downloadLogBtn = document.getElementById('downloadLogBtn');
    if (downloadLogBtn) {
        downloadLogBtn.addEventListener('click', function() {
            if (conversionLogMessages.length === 0) {
                alert('No conversion log available.');
                return;
            }

            const logText = conversionLogMessages.map(m => `[${m.timestamp}] [${m.type.toUpperCase()}] ${m.message}`).join('\n');
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `conversion_log_${new Date().toISOString().slice(0,10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
    }

    if (toggleBiometricsLogBtn) {
        toggleBiometricsLogBtn.addEventListener('click', function() {
            biometricsLogBody.classList.toggle('d-none');
            const icon = toggleBiometricsLogBtn.querySelector('i');
            if (biometricsLogBody.classList.contains('d-none')) {
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-right');
            } else {
                icon.classList.remove('fa-chevron-right');
                icon.classList.add('fa-chevron-down');
            }
        });
    }

    function appendLog(message, type = 'info', logElement = null) {
        const colors = {
            'info': '#17a2b8',
            'success': '#28a745',
            'warning': '#ffc107',
            'error': '#dc3545',
            'step': '#6c757d'
        };
        const targetLog = logElement || conversionLog;
        const timestamp = new Date().toLocaleTimeString();

        // Store message for download (only for main conversion log)
        if (!logElement) {
            conversionLogMessages.push({ timestamp, type, message });
        }

        if (!targetLog) return;
        const color = colors[type] || colors.info;
        targetLog.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
        targetLog.scrollTop = targetLog.scrollHeight;
    }

    function resetConversionUI() {
        conversionLogContainer.classList.add('d-none');
        validationResultsContainer.classList.add('d-none');
        downloadSection.classList.add('d-none');
        downloadWarningSection.classList.add('d-none');
        if (conversionLog) conversionLog.innerHTML = '';
        validationSummary.innerHTML = '';
        validationDetails.innerHTML = '';
        currentZipBlob = null;
        conversionLogMessages = []; // Clear log messages

        // Reset progress and summary
        const progressContainer = document.getElementById('surveyConversionProgress');
        const summaryContainer = document.getElementById('conversionSummaryContainer');
        if (progressContainer) progressContainer.classList.add('d-none');
        if (summaryContainer) summaryContainer.classList.add('d-none');

        // Reset step icons
        const stepIcons = ['step1Icon', 'step2Icon', 'step3Icon', 'step4Icon'];
        const stepLines = ['line1', 'line2', 'line3'];
        const defaultIcons = ['fa-upload', 'fa-cogs', 'fa-exchange-alt', 'fa-check-double'];

        stepIcons.forEach((id, i) => {
            const el = document.getElementById(id);
            if (el) {
                el.classList.remove('bg-success', 'bg-warning');
                el.classList.add('bg-secondary');
                el.innerHTML = `<i class="fas ${defaultIcons[i]}"></i>`;
            }
        });
        stepLines.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.classList.remove('border-success', 'border-warning');
                el.classList.add('border-secondary');
            }
        });
    }

    function resetBiometricsUI() {
        biometricsLogContainer.classList.add('d-none');
        biometricsValidationResultsContainer.classList.add('d-none');
        biometricsDownloadSection.classList.add('d-none');
        biometricsDownloadWarningSection.classList.add('d-none');
        biometricsDetectedContainer.classList.add('d-none');
        biometricsLog.innerHTML = '';
        biometricsValidationSummary.innerHTML = '';
        biometricsValidationDetails.innerHTML = '';
        biometricsDetectedList.innerHTML = '';
        currentBiometricsZipBlob = null;
    }

    function displayConversionSummary(data) {
        const container = document.getElementById('conversionSummaryContainer');
        const statParticipants = document.getElementById('statParticipants');
        const statQuestionnaires = document.getElementById('statQuestionnaires');
        const statFiles = document.getElementById('statFiles');
        const questionnaireBreakdown = document.getElementById('questionnaireBreakdown');
        const questionnaireList = document.getElementById('questionnaireList');
        const warningsSummary = document.getElementById('conversionWarningsSummary');
        const warningsText = document.getElementById('conversionWarningsText');

        if (!container) return;

        // Extract statistics from response
        let participants = 0;
        let questionnaires = 0;
        let filesCreated = data.saved_file_count || 0;
        let tasks = [];
        let conversionWarnings = [];

        // Get stats from validation summary if available
        if (data.validation) {
            const summary = data.validation.summary || {};
            filesCreated = filesCreated || summary.total_files || summary.files_created || 0;

            // Try to get tasks from validation
            if (summary.tasks_included) {
                tasks = summary.tasks_included;
            }
        }

        // Get stats from conversion_stats if provided by API
        if (data.conversion_stats) {
            participants = data.conversion_stats.participants || 0;
            questionnaires = data.conversion_stats.questionnaires || 0;
            tasks = data.conversion_stats.tasks || tasks;
            filesCreated = filesCreated || data.conversion_stats.files_created || 0;
        }

        // Estimate from file count if not provided
        if (participants === 0 && filesCreated > 0 && tasks.length > 0) {
            // TSV files per task = participants, plus JSON sidecars
            // Rough estimate: (files - tasks) / tasks ≈ participants
            participants = Math.round((filesCreated - tasks.length) / Math.max(tasks.length, 1));
        }

        if (questionnaires === 0) {
            questionnaires = tasks.length;
        }

        // Collect warnings from log messages
        if (data.log && Array.isArray(data.log)) {
            data.log.forEach(entry => {
                if (entry.level === 'warning' || entry.type === 'warning') {
                    conversionWarnings.push(entry.message);
                }
            });
        }

        // Update statistics display
        statParticipants.textContent = participants > 0 ? participants : '-';
        statQuestionnaires.textContent = questionnaires > 0 ? questionnaires : '-';
        statFiles.textContent = filesCreated > 0 ? filesCreated : '-';

        // Show questionnaire breakdown
        if (tasks.length > 0) {
            questionnaireList.innerHTML = '';
            tasks.forEach(task => {
                const badge = document.createElement('span');
                badge.className = 'badge bg-success bg-opacity-75';
                badge.innerHTML = `<i class="fas fa-clipboard-list me-1"></i>${task}`;
                questionnaireList.appendChild(badge);
            });
            questionnaireBreakdown.classList.remove('d-none');
        } else {
            questionnaireBreakdown.classList.add('d-none');
        }

        // Show warnings summary if any
        if (conversionWarnings.length > 0) {
            warningsText.textContent = `${conversionWarnings.length} warning(s) during conversion`;
            warningsSummary.classList.remove('d-none');
        } else {
            warningsSummary.classList.add('d-none');
        }

        // Show the summary container
        container.classList.remove('d-none');
    }

    function displayValidationResults(validation, prefix = '') {
        const getEl = (id) => document.getElementById(prefix ? prefix + id.charAt(0).toUpperCase() + id.slice(1) : id);
        
        const container = getEl('validationResultsContainer');
        const card = getEl('validationResultsCard');
        const header = getEl('validationResultsHeader');
        const badge = getEl('validationBadge');
        const summaryEl = getEl('validationSummary');
        const detailsEl = getEl('validationDetails');
        const dlSection = getEl('downloadSection');
        const dlWarningSection = getEl('downloadWarningSection');

        if (!container) return;
        container.classList.remove('d-none');
        
        const errors = validation.errors || [];
        const warnings = validation.warnings || [];
        const isValid = errors.length === 0;
        
        // Update card styling based on result
        card.classList.remove('border-success', 'border-warning', 'border-danger');
        header.classList.remove('bg-success', 'bg-warning', 'bg-danger', 'text-white', 'text-dark');
        
        if (isValid && warnings.length === 0) {
            card.classList.add('border-success');
            header.classList.add('bg-success', 'text-white');
            badge.className = 'badge bg-light text-success';
            badge.textContent = '✓ Valid';
        } else if (isValid) {
            card.classList.add('border-warning');
            header.classList.add('bg-warning', 'text-dark');
            badge.className = 'badge bg-light text-warning';
            badge.textContent = `⚠ ${warnings.length} Warning(s)`;
        } else {
            card.classList.add('border-danger');
            header.classList.add('bg-danger', 'text-white');
            badge.className = 'badge bg-light text-danger';
            badge.textContent = `✗ ${errors.length} Error(s)`;
        }
        
        // Summary
        const summary = validation.summary || {};
        summaryEl.innerHTML = `
            <div class="row text-center">
                <div class="col-4">
                    <div class="h4 mb-0 ${errors.length > 0 ? 'text-danger' : 'text-success'}">${errors.length}</div>
                    <small class="text-muted">Errors</small>
                </div>
                <div class="col-4">
                    <div class="h4 mb-0 ${warnings.length > 0 ? 'text-warning' : 'text-success'}">${warnings.length}</div>
                    <small class="text-muted">Warnings</small>
                </div>
                <div class="col-4">
                    <div class="h4 mb-0 text-info">${summary.total_files || summary.files_created || 'n/a'}</div>
                    <small class="text-muted">Files</small>
                </div>
            </div>
        `;
        
        // Details
        let detailsHtml = '';
        
        if (validation.formatted) {
            const f = validation.formatted;
            
            if (f.errors && f.errors.length > 0) {
                detailsHtml += '<h6 class="text-danger mt-3"><i class="fas fa-times-circle me-1"></i>Errors</h6>';
                f.errors.forEach(group => {
                    detailsHtml += `
                        <div class="validation-group mb-3 p-3 border rounded bg-light shadow-sm">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="fw-bold text-danger">
                                    <span class="badge bg-danger me-2">${group.code}</span>
                                    ${escapeHtml(group.message)}
                                </div>
                                ${group.documentation_url ? `
                                    <a href="${group.documentation_url}" target="_blank" class="btn btn-sm btn-outline-primary py-0 px-2" style="font-size: 0.75rem;">
                                        <i class="fas fa-book me-1"></i>Docs
                                    </a>
                                ` : ''}
                            </div>
                            
                            ${group.fix_hint ? `
                                <div class="alert alert-info py-2 px-3 mb-2 smaller">
                                    <i class="fas fa-lightbulb me-2 text-warning"></i>
                                    <strong>Fix Hint:</strong> ${escapeHtml(group.fix_hint)}
                                </div>
                            ` : ''}

                            <ul class="list-unstyled ms-2 mb-0 smaller">
                                ${(group.files || []).map(file => `
                                    <li class="mb-1 border-bottom pb-1 last-child-no-border">
                                        <div class="d-flex justify-content-between">
                                            <code class="text-dark fw-bold">${escapeHtml(file.file || 'unknown')}</code>
                                            ${file.line ? `<span class="badge bg-secondary">Line ${file.line}</span>` : ''}
                                        </div>
                                        ${file.message && file.message !== group.message ? `<div class="text-muted mt-1">${escapeHtml(file.message)}</div>` : ''}
                                        ${file.evidence ? `<div class="text-muted italic ms-2 mt-1 p-1 bg-white border rounded" style="font-size: 0.85em; font-family: monospace;">${escapeHtml(file.evidence)}</div>` : ''}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    `;
                });
            }
            
            if (f.warnings && f.warnings.length > 0) {
                detailsHtml += '<h6 class="text-warning mt-3"><i class="fas fa-exclamation-triangle me-1"></i>Warnings</h6>';
                f.warnings.forEach(group => {
                    detailsHtml += `
                        <div class="validation-group mb-3 p-3 border rounded bg-light shadow-sm">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="fw-bold text-warning">
                                    <span class="badge bg-warning text-dark me-2">${group.code}</span>
                                    ${escapeHtml(group.message)}
                                </div>
                                ${group.documentation_url ? `
                                    <a href="${group.documentation_url}" target="_blank" class="btn btn-sm btn-outline-primary py-0 px-2" style="font-size: 0.75rem;">
                                        <i class="fas fa-book me-1"></i>Docs
                                    </a>
                                ` : ''}
                            </div>

                            ${group.fix_hint ? `
                                <div class="alert alert-info py-2 px-3 mb-2 smaller">
                                    <i class="fas fa-lightbulb me-2 text-warning"></i>
                                    <strong>Fix Hint:</strong> ${escapeHtml(group.fix_hint)}
                                </div>
                            ` : ''}

                            <ul class="list-unstyled ms-2 mb-0 smaller">
                                ${(group.files || []).map(file => `
                                    <li class="mb-1 border-bottom pb-1 last-child-no-border">
                                        <div class="d-flex justify-content-between">
                                            <code class="text-dark fw-bold">${escapeHtml(file.file || 'unknown')}</code>
                                            ${file.line ? `<span class="badge bg-secondary">Line ${file.line}</span>` : ''}
                                        </div>
                                        ${file.message && file.message !== group.message ? `<div class="text-muted mt-1">${escapeHtml(file.message)}</div>` : ''}
                                        ${file.evidence ? `<div class="text-muted italic ms-2 mt-1 p-1 bg-white border rounded" style="font-size: 0.85em; font-family: monospace;">${escapeHtml(file.evidence)}</div>` : ''}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    `;
                });
            }
        } else {
            // Fallback to old list
            if (errors.length > 0) {
                detailsHtml += '<h6 class="text-danger mt-3"><i class="fas fa-times-circle me-1"></i>Errors</h6><ul class="list-unstyled">';
                errors.forEach(e => {
                    detailsHtml += `<li class="text-danger small"><i class="fas fa-times me-1"></i>${escapeHtml(e)}</li>`;
                });
                detailsHtml += '</ul>';
            }
            if (warnings.length > 0) {
                detailsHtml += '<h6 class="text-warning mt-3"><i class="fas fa-exclamation-triangle me-1"></i>Warnings</h6><ul class="list-unstyled">';
                warnings.forEach(w => {
                    detailsHtml += `<li class="text-warning small"><i class="fas fa-exclamation me-1"></i>${escapeHtml(w)}</li>`;
                });
                detailsHtml += '</ul>';
            }
        }
        
        detailsEl.innerHTML = detailsHtml;
        
        // Show appropriate download button
        if (isValid && warnings.length === 0) {
            dlSection.classList.remove('d-none');
            dlWarningSection.classList.add('d-none');
        } else if (isValid) {
            dlSection.classList.add('d-none');
            dlWarningSection.classList.remove('d-none');
        } else {
            dlSection.classList.add('d-none');
            dlWarningSection.classList.add('d-none');
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function downloadCurrentZip() {
        if (!currentZipBlob) return;
        const url = window.URL.createObjectURL(currentZipBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'prism_survey_dataset.zip';
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
    }

    if (downloadZipBtn) {
        downloadZipBtn.addEventListener('click', downloadCurrentZip);
    }
    if (downloadZipWarningBtn) {
        downloadZipWarningBtn.addEventListener('click', downloadCurrentZip);
    }

    // Store template results for download
    let currentTemplateData = null;

    // Handle template generation (structure only, no data)
    // Accepts either a File object OR a file path string
    async function handleTemplateGeneration(fileOrPath) {
        const exportMode = document.getElementById('convertTemplateExport')?.value || 'groups';
        const taskName = document.getElementById('convertDatasetName')?.value.trim() || '';

        convertBtn.disabled = true;
        convertError.classList.add('d-none');
        convertInfo.classList.add('d-none');

        try {
            const formData = new FormData();
            // Support both file upload and file path
            if (typeof fileOrPath === 'string') {
                formData.append('file_path', fileOrPath);
            } else {
                formData.append('file', fileOrPath);
            }
            formData.append('mode', exportMode);
            if (taskName) {
                formData.append('task_name', taskName);
            }

            const response = await fetch('/api/limesurvey-to-prism', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (!response.ok || data.error) {
                throw new Error(data.error || 'Template generation failed');
            }

            currentTemplateData = data;

            // Show results container
            if (templateResultsContainer) {
                templateResultsContainer.classList.remove('d-none');
            }

            // Display results based on mode
            if (data.mode === 'combined') {
                displayTemplateSingle(data);
            } else if (data.mode === 'groups') {
                displayTemplateGroups(data);
            } else if (data.mode === 'questions') {
                displayTemplateQuestions(data);
            }

            // Show participant metadata section for marking fields
            displayParticipantMetadataSection(data);

            convertInfo.textContent = 'Template generation complete!';
            convertInfo.classList.remove('d-none');

        } catch (err) {
            convertError.textContent = err.message;
            convertError.classList.remove('d-none');
        } finally {
            updateConvertBtn();
        }
    }

    function displayTemplateSingle(data) {
        const container = document.getElementById('templateResultSingle');
        if (!container) return;

        container.classList.remove('d-none');
        document.getElementById('templateQuestionCount').textContent = `${data.question_count} questions`;

        // Setup preview button
        const previewBtn = document.getElementById('templatePreviewBtn');
        const previewDiv = document.getElementById('templatePreview');
        const previewContent = document.getElementById('templatePreviewContent');

        if (previewBtn && previewDiv && previewContent) {
            previewBtn.onclick = () => {
                previewDiv.classList.toggle('d-none');
                previewContent.textContent = JSON.stringify(data.prism_json, null, 2);
            };
        }

        // Setup download button
        const downloadBtn = document.getElementById('templateDownloadBtn');
        if (downloadBtn) {
            downloadBtn.onclick = () => {
                const blob = new Blob([JSON.stringify(data.prism_json, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = data.suggested_filename || 'survey-template.json';
                a.click();
                URL.revokeObjectURL(url);
            };
        }
    }

    function displayTemplateGroups(data) {
        const container = document.getElementById('templateResultGroups');
        if (!container) return;

        container.classList.remove('d-none');
        document.getElementById('templateGroupCount').textContent = `${data.questionnaire_count} groups`;
        document.getElementById('templateTotalQuestions').textContent = `${data.total_questions} questions`;

        const listEl = document.getElementById('templateGroupList');
        if (listEl) {
            listEl.innerHTML = '';
            for (const [name, info] of Object.entries(data.questionnaires || {})) {
                const card = document.createElement('div');
                card.className = 'col-md-4';
                card.innerHTML = `
                    <div class="card h-100">
                        <div class="card-body py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${name}</strong>
                                    <small class="d-block text-muted">${info.question_count} questions</small>
                                </div>
                                <button class="btn btn-sm btn-outline-success download-template-btn" data-name="${name}">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                listEl.appendChild(card);
            }

            // Add download handlers
            listEl.querySelectorAll('.download-template-btn').forEach(btn => {
                btn.onclick = () => {
                    const name = btn.dataset.name;
                    const info = data.questionnaires[name];
                    if (info) {
                        const blob = new Blob([JSON.stringify(info.prism_json, null, 2)], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = info.suggested_filename || `survey-${name}.json`;
                        a.click();
                        URL.revokeObjectURL(url);
                    }
                };
            });
        }

        // Download all as ZIP
        const downloadAllBtn = document.getElementById('templateDownloadAllBtn');
        if (downloadAllBtn) {
            downloadAllBtn.onclick = async () => {
                const JSZip = window.JSZip;
                if (!JSZip) {
                    alert('JSZip not loaded');
                    return;
                }
                const zip = new JSZip();
                for (const [name, info] of Object.entries(data.questionnaires || {})) {
                    zip.file(info.suggested_filename || `survey-${name}.json`, JSON.stringify(info.prism_json, null, 2));
                }
                const blob = await zip.generateAsync({ type: 'blob' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'survey-templates.zip';
                a.click();
                URL.revokeObjectURL(url);
            };
        }

        // Save to project button
        setupTemplateSaveToProject(data, 'groups');
    }

    function displayTemplateQuestions(data) {
        const container = document.getElementById('templateResultQuestions');
        if (!container) return;

        container.classList.remove('d-none');
        document.getElementById('templateIndividualCount').textContent = `${data.question_count} templates`;

        const listEl = document.getElementById('templateQuestionsList');
        if (listEl) {
            listEl.innerHTML = '';
            // Track which groups are set to "keep as group"
            window.groupedGroups = window.groupedGroups || new Set();

            for (const [groupName, groupInfo] of Object.entries(data.by_group || {})) {
                const safeGroupName = groupName.replace(/[^a-zA-Z0-9]/g, '_');
                const isGrouped = window.groupedGroups.has(groupName);
                const questionCount = (groupInfo.questions || []).length;

                // Group header with toggle
                const groupDiv = document.createElement('div');
                groupDiv.className = 'col-12 mb-2 mt-3';
                groupDiv.innerHTML = `
                    <div class="d-flex align-items-center justify-content-between border-bottom pb-2">
                        <h6 class="text-primary mb-0">
                            <i class="fas fa-folder-open me-2"></i>${groupName}
                            <span class="badge bg-secondary ms-2">${questionCount} questions</span>
                        </h6>
                        <div class="form-check form-switch">
                            <input class="form-check-input group-toggle" type="checkbox"
                                   id="groupToggle_${safeGroupName}" data-group="${groupName}" ${isGrouped ? 'checked' : ''}>
                            <label class="form-check-label small text-muted" for="groupToggle_${safeGroupName}">
                                Save as single template
                            </label>
                        </div>
                    </div>
                `;
                listEl.appendChild(groupDiv);

                // Container for individual question cards
                const questionsContainer = document.createElement('div');
                questionsContainer.className = 'col-12 questions-container';
                questionsContainer.dataset.group = groupName;
                questionsContainer.innerHTML = isGrouped
                    ? `<div class="row g-2"><div class="col-12">
                        <div class="alert alert-info py-2 mb-0">
                            <i class="fas fa-object-group me-2"></i>
                            All ${questionCount} questions will be saved as a single template: <strong>survey-${groupName.toLowerCase().replace(/[^a-z0-9]/g, '-')}.json</strong>
                        </div>
                       </div></div>`
                    : '';

                if (!isGrouped) {
                    let questionsHtml = '<div class="row g-2">';
                    for (const q of groupInfo.questions || []) {
                        const qData = data.questions[q.code];
                        if (!qData) continue;

                        questionsHtml += `
                            <div class="col-md-3">
                                <div class="card h-100 question-card" data-code="${q.code}" data-group="${groupName}">
                                    <div class="card-body py-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>${q.code}</strong>
                                                <small class="d-block text-muted">${q.type} (${q.item_count} items)</small>
                                            </div>
                                            <button class="btn btn-sm btn-outline-success download-q-btn" data-code="${q.code}">
                                                <i class="fas fa-download"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    questionsHtml += '</div>';
                    questionsContainer.innerHTML = questionsHtml;
                }

                listEl.appendChild(questionsContainer);
            }

            // Add group toggle handlers
            listEl.querySelectorAll('.group-toggle').forEach(toggle => {
                toggle.onchange = function() {
                    const groupName = this.dataset.group;
                    if (this.checked) {
                        window.groupedGroups.add(groupName);
                    } else {
                        window.groupedGroups.delete(groupName);
                    }
                    // Re-render the display
                    displayTemplateQuestions(data);
                };
            });

            // Add download handlers
            listEl.querySelectorAll('.download-q-btn').forEach(btn => {
                btn.onclick = () => {
                    const code = btn.dataset.code;
                    const qData = data.questions[code];
                    if (qData && qData.prism_json) {
                        const blob = new Blob([JSON.stringify(qData.prism_json, null, 2)], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = qData.suggested_filename || `survey-${code}.json`;
                        a.click();
                        URL.revokeObjectURL(url);
                    }
                };
            });
        }

        // Download all as ZIP
        const downloadBtn = document.getElementById('templateDownloadQuestionsBtn');
        if (downloadBtn) {
            downloadBtn.onclick = async () => {
                const JSZip = window.JSZip;
                if (!JSZip) {
                    alert('JSZip not loaded');
                    return;
                }
                const zip = new JSZip();
                const groupedGroups = window.groupedGroups || new Set();
                const processedCodes = new Set();

                // First, handle grouped groups
                for (const [groupName, groupInfo] of Object.entries(data.by_group || {})) {
                    if (groupedGroups.has(groupName)) {
                        const combinedItems = [];
                        for (const q of groupInfo.questions || []) {
                            const qData = data.questions[q.code];
                            if (!qData || !qData.prism_json) continue;
                            combinedItems.push(...(qData.prism_json.Items || []));
                            processedCodes.add(q.code);
                        }
                        if (combinedItems.length > 0) {
                            const safeGroupName = groupName.toLowerCase().replace(/[^a-z0-9]/g, '-');
                            const combinedTemplate = {
                                MeasurementToolMetadata: {
                                    ShortName: groupName,
                                    Description: `Combined template for ${groupName} group`
                                },
                                Items: combinedItems
                            };
                            zip.file(`survey-${safeGroupName}.json`, JSON.stringify(combinedTemplate, null, 2));
                        }
                    }
                }

                // Then, handle individual questions
                for (const [code, qData] of Object.entries(data.questions || {})) {
                    if (processedCodes.has(code)) continue;
                    if (qData.prism_json) {
                        zip.file(qData.suggested_filename || `survey-${code}.json`, JSON.stringify(qData.prism_json, null, 2));
                    }
                }
                const blob = await zip.generateAsync({ type: 'blob' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'survey-question-templates.zip';
                a.click();
                URL.revokeObjectURL(url);
            };
        }

        // Save to project button
        setupTemplateSaveToProject(data, 'questions');
    }

    function setupTemplateSaveToProject(data, mode) {
        const saveBtn = mode === 'groups'
            ? document.getElementById('templateSaveToProjectBtn')
            : document.getElementById('templateSaveQuestionsToProjectBtn');

        if (!saveBtn) return;

        saveBtn.onclick = async () => {
            const templates = [];

            // Get groups that have fields marked as participant metadata
            // These should NOT become templates - they go in participants.json instead
            const participantGroups = new Set();
            for (const fieldInfo of Object.values(selectedParticipantFields)) {
                if (fieldInfo.fullMetadata?.Position?.Group) {
                    participantGroups.add(fieldInfo.fullMetadata.Position.Group.toLowerCase());
                }
            }

            // Get question codes that are marked as participant metadata
            const participantCodes = new Set(Object.keys(selectedParticipantFields).map(c => c.toLowerCase()));

            if (mode === 'groups') {
                for (const [name, info] of Object.entries(data.questionnaires || {})) {
                    // Skip groups that contain participant metadata fields
                    const normalizedName = name.toLowerCase();
                    if (participantGroups.has(normalizedName)) {
                        console.log(`Skipping group '${name}' - marked as participant metadata`);
                        continue;
                    }
                    templates.push({
                        filename: info.suggested_filename || `survey-${name}.json`,
                        content: info.prism_json
                    });
                }
            } else {
                // Track which questions are in grouped groups (to avoid double-saving)
                const processedCodes = new Set();

                // First, handle groups that are toggled to "save as single template"
                const groupedGroups = window.groupedGroups || new Set();
                for (const [groupName, groupInfo] of Object.entries(data.by_group || {})) {
                    if (groupedGroups.has(groupName)) {
                        // Combine all questions in this group into one template
                        const combinedItems = [];
                        for (const q of groupInfo.questions || []) {
                            const qData = data.questions[q.code];
                            if (!qData || !qData.prism_json) continue;
                            if (participantCodes.has(q.code.toLowerCase())) continue;

                            // Add items from this question to combined template
                            combinedItems.push(...(qData.prism_json.Items || []));
                            processedCodes.add(q.code);
                        }

                        if (combinedItems.length > 0) {
                            // Create combined template
                            const safeGroupName = groupName.toLowerCase().replace(/[^a-z0-9]/g, '-');
                            templates.push({
                                filename: `survey-${safeGroupName}.json`,
                                content: {
                                    MeasurementToolMetadata: {
                                        ShortName: groupName,
                                        Description: `Combined template for ${groupName} group`
                                    },
                                    Items: combinedItems
                                }
                            });
                        }
                    }
                }

                // Then, handle individual questions (skip those already processed in groups)
                for (const [code, qData] of Object.entries(data.questions || {})) {
                    // Skip if already processed as part of a grouped group
                    if (processedCodes.has(code)) continue;

                    // Skip questions that are marked as participant metadata
                    if (participantCodes.has(code.toLowerCase())) {
                        console.log(`Skipping question '${code}' - marked as participant metadata`);
                        continue;
                    }
                    if (qData.prism_json) {
                        templates.push({
                            filename: qData.suggested_filename || `survey-${code}.json`,
                            content: qData.prism_json
                        });
                    }
                }
            }

            const skippedCount = mode === 'groups'
                ? participantGroups.size
                : Object.keys(selectedParticipantFields).length;

            try {
                const response = await fetch('/api/limesurvey-save-to-project', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ templates })
                });
                const result = await response.json();

                const successDiv = document.getElementById('templateSaveSuccess');
                const msgSpan = document.getElementById('templateSaveSuccessMessage');
                if (result.success) {
                    successDiv?.classList.remove('d-none');
                    let msg = `Saved ${result.saved_files?.length || templates.length} templates to project library!`;
                    if (skippedCount > 0) {
                        msg += ` (${skippedCount} participant field(s) → participants.json)`;
                    }
                    msgSpan.textContent = msg;
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Error saving: ' + e.message);
            }
        };
    }

    // ===== PARTICIPANT METADATA MARKING =====

    // Store selected participant fields
    let selectedParticipantFields = {};
    let selectedParticipantIdColumn = null;

    // BIDS standard field suggestions for auto-mapping
    const bidsFieldMappings = {
        // Common patterns -> BIDS field names
        'participant_id': ['token', 'id', 'participant', 'subject', 'subj', 'respondent', 'code'],
        'age': ['age', 'alter', 'years_old'],
        'sex': ['sex', 'gender', 'geschlecht', 'm_f', 'male_female'],
        'handedness': ['hand', 'handed', 'handedness', 'dominant_hand'],
        'education_years': ['education', 'school', 'study_years', 'ausbildung'],
        'native_language': ['language', 'native', 'mother_tongue', 'muttersprache']
    };

    // Display participant metadata section with extracted fields
    function displayParticipantMetadataSection(data) {
        const section = document.getElementById('participantMetadataSection');
        const fieldsList = document.getElementById('participantFieldsList');
        const idColumnSelect = document.getElementById('participantIdColumn');
        if (!section || !fieldsList) return;

        // Extract all question codes/fields from the template data
        const allFields = extractAllFields(data);

        if (allFields.length === 0) {
            section.classList.add('d-none');
            return;
        }

        section.classList.remove('d-none');
        selectedParticipantFields = {};
        selectedParticipantIdColumn = null;

        // Populate participant ID column selector with auto-detection
        // Check if participants.json defines participant_id
        const schemaHasParticipantId = cachedParticipantsSchema && cachedParticipantsSchema.participant_id;

        // Common patterns for participant ID columns (in priority order)
        const participantIdPatterns = [
            'participant_id', 'participantid', 'participant',
            'subject_id', 'subjectid', 'subject',
            'code', 'id', 'token',
            'prolific_id', 'prolificid',
            'respondent_id', 'respondentid'
        ];

        if (idColumnSelect) {
            let idOptions = '<option value="">-- Select the ID field --</option>';
            let autoSelectedId = null;
            let selectionSource = '';

            // Priority 1: If participants.json exists with participant_id, look for exact match first
            if (schemaHasParticipantId) {
                const exactMatch = allFields.find(f => f.code.toLowerCase() === 'participant_id');
                if (exactMatch) {
                    autoSelectedId = exactMatch.code;
                    selectionSource = 'from participants.json';
                }
            }

            // Priority 2: Pattern matching fallback
            if (!autoSelectedId) {
                for (const pattern of participantIdPatterns) {
                    for (const field of allFields) {
                        if (field.code.toLowerCase() === pattern ||
                            field.code.toLowerCase().includes(pattern) ||
                            field.code.toLowerCase().replace(/[_-]/g, '') === pattern) {
                            autoSelectedId = field.code;
                            selectionSource = 'pattern match';
                            break;
                        }
                    }
                    if (autoSelectedId) break;
                }
            }

            for (const field of allFields) {
                const isAutoSelected = field.code === autoSelectedId;
                idOptions += `<option value="${field.code}" ${isAutoSelected ? 'selected' : ''}>${field.code} ${field.group ? `(${field.group})` : ''}${isAutoSelected ? ' (auto-detected)' : ''}</option>`;
            }
            idColumnSelect.innerHTML = idOptions;

            // Set the auto-selected value
            selectedParticipantIdColumn = autoSelectedId || null;

            // If auto-detected, trigger the change event to set up mappings
            if (autoSelectedId) {
                idColumnSelect.value = autoSelectedId;
                // Dispatch change event to trigger the auto-check logic
                idColumnSelect.dispatchEvent(new Event('change'));
            }

            // Track previous selection to reset it when changed
            let previousIdSelection = autoSelectedId;

            // Add change listener - auto-check and mark the selected ID field
            idColumnSelect.addEventListener('change', function() {
                const selectedCode = this.value;

                // Reset previous selection to its original state
                if (previousIdSelection && previousIdSelection !== selectedCode) {
                    const prevMappingSelect = fieldsList.querySelector(`.bids-mapping-select[data-code="${previousIdSelection}"]`);
                    if (prevMappingSelect) {
                        // Reset to original field name (first option)
                        prevMappingSelect.value = previousIdSelection;
                    }
                    // Uncheck if it was auto-checked (not manually selected by user for other metadata)
                    const prevCheckbox = fieldsList.querySelector(`.participant-field-checkbox[data-code="${previousIdSelection}"]`);
                    if (prevCheckbox && prevCheckbox.dataset.autoCheckedAsId === 'true') {
                        prevCheckbox.checked = false;
                        prevCheckbox.dataset.autoCheckedAsId = '';
                    }
                }

                selectedParticipantIdColumn = selectedCode || null;

                // Find and auto-check the corresponding checkbox in the list
                if (selectedCode) {
                    const checkbox = fieldsList.querySelector(`.participant-field-checkbox[data-code="${selectedCode}"]`);
                    if (checkbox && !checkbox.checked) {
                        checkbox.checked = true;
                        checkbox.dataset.autoCheckedAsId = 'true'; // Mark as auto-checked
                    }
                    // Also set the BIDS mapping to participant_id
                    const mappingSelect = fieldsList.querySelector(`.bids-mapping-select[data-code="${selectedCode}"]`);
                    if (mappingSelect) {
                        // Add participant_id option if not present
                        if (!Array.from(mappingSelect.options).some(o => o.value === 'participant_id')) {
                            const opt = document.createElement('option');
                            opt.value = 'participant_id';
                            opt.textContent = '→ participant_id';
                            mappingSelect.appendChild(opt);
                        }
                        mappingSelect.value = 'participant_id';
                    }
                }

                previousIdSelection = selectedCode;
                updateParticipantFieldSelection();
                // Also sync to conversion ID column
                syncParticipantIdToConversion();
            });
        }

        // Render field checkboxes as a clean table - user selects which fields are participant metadata
        const bidsStandardFields = [
            { value: 'participant_id', label: 'participant_id' },
            { value: 'age', label: 'age' },
            { value: 'sex', label: 'sex' },
            { value: 'handedness', label: 'handedness' },
            { value: 'species', label: 'species' },
            { value: 'strain', label: 'strain' },
            { value: 'education_years', label: 'education' },
            { value: 'native_language', label: 'language' }
        ];

        let html = `
            <table class="table table-sm table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th style="width: 40px;"></th>
                        <th style="width: 140px;">Variable</th>
                        <th>Description</th>
                        <th style="width: 150px;">Map to</th>
                    </tr>
                </thead>
                <tbody>
        `;

        for (const field of allFields) {
            const suggestedMapping = suggestBidsMapping(field.code);

            // Safely encode full metadata for data attribute
            const metadataJson = field.fullMetadata
                ? JSON.stringify(field.fullMetadata).replace(/"/g, '&quot;')
                : '';

            // Escape description for HTML attribute
            const safeDescription = (field.description || '').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

            // Truncate variable name if too long
            const displayCode = field.code.length > 18 ? field.code.substring(0, 16) + '..' : field.code;
            const displayDesc = (field.description || field.type || '').substring(0, 40) + ((field.description || '').length > 40 ? '...' : '');

            html += `
                <tr class="participant-field-row">
                    <td class="text-center align-middle">
                        <input type="checkbox" class="form-check-input participant-field-checkbox"
                               data-code="${field.code}" data-description="${safeDescription}"
                               data-type="${field.type || 'text'}"
                               data-full-metadata="${metadataJson}">
                    </td>
                    <td class="align-middle">
                        <code class="small" title="${field.code}">${displayCode}</code>
                        ${field.group ? `<span class="badge bg-light text-muted ms-1" style="font-size: 0.65em;">${field.group}</span>` : ''}
                    </td>
                    <td class="text-muted small align-middle">${displayDesc}</td>
                    <td class="align-middle">
                        <select class="form-select form-select-sm bids-mapping-select" data-code="${field.code}">
                            <option value="${field.code}">Keep original</option>
                            <optgroup label="BIDS">
                                ${bidsStandardFields.map(opt =>
                                    `<option value="${opt.value}" ${suggestedMapping === opt.value ? 'selected' : ''}>${opt.label}</option>`
                                ).join('')}
                            </optgroup>
                            <option value="_custom_">Custom...</option>
                        </select>
                    </td>
                </tr>
            `;
        }
        html += '</tbody></table>';
        fieldsList.innerHTML = html;

        // Handle custom field name input
        fieldsList.querySelectorAll('.bids-mapping-select').forEach(sel => {
            sel.addEventListener('change', function() {
                if (this.value === '_custom_') {
                    const customName = prompt('Enter custom field name for participants.json:', this.dataset.code);
                    if (customName && customName.trim()) {
                        // Add custom option
                        const opt = document.createElement('option');
                        opt.value = customName.trim();
                        opt.textContent = customName.trim() + ' (custom)';
                        opt.selected = true;
                        this.insertBefore(opt, this.querySelector('optgroup'));
                    } else {
                        // Reset to original
                        this.value = this.dataset.code;
                    }
                }
            });
        });

        // Add checkbox event listeners
        fieldsList.querySelectorAll('.participant-field-checkbox').forEach(cb => {
            cb.addEventListener('change', updateParticipantFieldSelection);
        });

        // Add select event listeners - auto-check when mapping is changed
        fieldsList.querySelectorAll('.bids-mapping-select').forEach(sel => {
            sel.addEventListener('change', function() {
                // Skip if handling custom (already handled above)
                if (this.value === '_custom_') return;

                const code = this.dataset.code;
                const checkbox = fieldsList.querySelector(`.participant-field-checkbox[data-code="${code}"]`);
                // Auto-check the checkbox when a mapping is selected
                if (this.value && this.value !== code && checkbox && !checkbox.checked) {
                    checkbox.checked = true;
                }
                updateParticipantFieldSelection();
            });
        });

        // Setup save/download button
        setupParticipantsSaveButton();
    }

    // Extract all fields from template data (works for all modes)
    function extractAllFields(data) {
        const fields = [];

        if (data.mode === 'combined' || data.mode === 'groups') {
            // Extract from prism_json Items
            const sources = data.mode === 'combined'
                ? [{ json: data.prism_json, group: null }]
                : Object.entries(data.questionnaires || {}).map(([name, info]) => ({ json: info.prism_json, group: name }));

            for (const source of sources) {
                const items = source.json?.Items || [];
                for (const item of items) {
                    if (item.SurveyItemID) {
                        fields.push({
                            code: item.SurveyItemID,
                            description: item.Prompt || item.Description || '',
                            type: item.ResponseType || 'text',
                            group: source.group,
                            fullMetadata: {
                                QuestionType: item.ResponseType || item.QuestionType,
                                LimeSurveyType: item.LimeSurveyType,
                                Mandatory: item.Mandatory,
                                Position: item.Position,
                                Levels: item.Levels,
                                Attributes: item.Attributes,
                                Timing: item.Timing,
                                Relevance: item.Relevance,
                                Dependencies: item.Dependencies,
                                Units: item.Units,
                                HelpText: item.HelpText
                            }
                        });
                    }
                }
            }
        } else if (data.mode === 'questions') {
            // Extract from by_group structure - full template data is in data.questions[code]
            const allQuestions = data.questions || {};

            for (const [groupName, groupInfo] of Object.entries(data.by_group || {})) {
                for (const q of groupInfo.questions || []) {
                    // Get full metadata from data.questions which contains the prism_json
                    const qData = allQuestions[q.code] || {};
                    const prismJson = qData.prism_json || {};

                    // Extract item-level metadata from the prism_json
                    // The prism_json has root-level keys that are the item codes
                    const itemKeys = Object.keys(prismJson).filter(k =>
                        !['Technical', 'Study', 'Metadata', 'I18n', 'Scoring', 'Normative'].includes(k)
                    );
                    // Use first item for representative metadata
                    const firstItemKey = itemKeys[0];
                    const itemMeta = firstItemKey ? prismJson[firstItemKey] : {};

                    fields.push({
                        code: q.code,
                        description: itemMeta.Description || qData.question_text || '',
                        type: q.type || itemMeta.QuestionType || 'text',
                        group: groupName,
                        fullMetadata: {
                            QuestionType: itemMeta.QuestionType || q.type,
                            LimeSurveyType: q.limesurvey_type || itemMeta.LimeSurveyType,
                            Mandatory: q.mandatory !== undefined ? q.mandatory : itemMeta.Mandatory,
                            Position: itemMeta.Position || {
                                Group: groupName,
                                GroupOrder: groupInfo.group_order,
                                QuestionOrder: q.order
                            },
                            Levels: itemMeta.Levels,
                            Attributes: itemMeta.Attributes,
                            Timing: itemMeta.Timing,
                            Relevance: itemMeta.Condition,
                            HelpText: itemMeta.HelpText,
                            ItemCount: q.item_count
                        }
                    });
                }
            }
        }

        return fields;
    }

    // Suggest BIDS field mapping based on field code
    function suggestBidsMapping(code) {
        const lowerCode = code.toLowerCase();
        for (const [bidsField, patterns] of Object.entries(bidsFieldMappings)) {
            for (const pattern of patterns) {
                if (lowerCode.includes(pattern)) {
                    return bidsField;
                }
            }
        }
        return null;
    }

    // Update selection state and count
    function updateParticipantFieldSelection() {
        selectedParticipantFields = {};
        const checkboxes = document.querySelectorAll('.participant-field-checkbox:checked');

        checkboxes.forEach(cb => {
            const code = cb.dataset.code;
            const description = cb.dataset.description;
            const mappingSelect = document.querySelector(`.bids-mapping-select[data-code="${code}"]`);
            const bidsName = mappingSelect?.value || code;

            // Try to get full metadata from stored template data
            let fullMetadata = null;
            try {
                const metaStr = cb.dataset.fullMetadata;
                if (metaStr) {
                    fullMetadata = JSON.parse(metaStr);
                }
            } catch (e) {
                console.warn('Could not parse field metadata:', e);
            }

            selectedParticipantFields[code] = {
                originalCode: code,
                bidsFieldName: bidsName || code,
                description: description,
                fullMetadata: fullMetadata
            };
        });

        // Update count
        const countEl = document.getElementById('selectedParticipantFieldsCount');
        if (countEl) {
            countEl.textContent = Object.keys(selectedParticipantFields).length;
        }

        // Enable/disable save button
        const saveBtn = document.getElementById('saveParticipantsJsonBtn') || document.getElementById('downloadParticipantsJsonBtn');
        if (saveBtn) {
            saveBtn.disabled = Object.keys(selectedParticipantFields).length === 0;
        }
    }

    // Build participants.json schema from selections with FULL metadata from templates
    function buildParticipantsJsonSchema() {
        const schema = {};

        for (const [code, info] of Object.entries(selectedParticipantFields)) {
            const fieldName = info.bidsFieldName || code;

            // Start with description
            schema[fieldName] = {
                Description: info.description || `Extracted from survey field: ${code}`
            };

            // Preserve full metadata from template if available
            if (info.fullMetadata) {
                const meta = info.fullMetadata;

                // Question/Response type info
                if (meta.QuestionType) schema[fieldName].QuestionType = meta.QuestionType;
                if (meta.LimeSurveyType) schema[fieldName].LimeSurveyType = meta.LimeSurveyType;
                if (meta.Mandatory !== undefined) schema[fieldName].Mandatory = meta.Mandatory;

                // Position in survey
                if (meta.Position) schema[fieldName].Position = meta.Position;

                // Levels/response options
                if (meta.Levels && Object.keys(meta.Levels).length > 0) {
                    schema[fieldName].Levels = meta.Levels;
                }

                // Attributes (styling, validation, etc.)
                if (meta.Attributes && Object.keys(meta.Attributes).length > 0) {
                    schema[fieldName].Attributes = meta.Attributes;
                }

                // Timing info
                if (meta.Timing) schema[fieldName].Timing = meta.Timing;

                // Dependencies/relevance equations
                if (meta.Relevance) schema[fieldName].Relevance = meta.Relevance;
                if (meta.Dependencies) schema[fieldName].Dependencies = meta.Dependencies;

                // Units for numeric fields
                if (meta.Units) schema[fieldName].Units = meta.Units;

                // Help text
                if (meta.HelpText) schema[fieldName].HelpText = meta.HelpText;
            }

            // Add standard properties for known BIDS fields (only if not already set)
            if (fieldName === 'age' && !schema[fieldName].Units) {
                schema[fieldName].Units = 'years';
            } else if (fieldName === 'sex' && !schema[fieldName].Levels) {
                schema[fieldName].Levels = {
                    'M': 'Male',
                    'F': 'Female',
                    'O': 'Other'
                };
            } else if (fieldName === 'handedness' && !schema[fieldName].Levels) {
                schema[fieldName].Levels = {
                    'R': 'Right',
                    'L': 'Left',
                    'A': 'Ambidextrous'
                };
            }

            // Store source info for data conversion
            if (code !== fieldName) {
                schema[fieldName]._sourceField = code;
            }
        }

        return schema;
    }

    // Setup save/download button
    function setupParticipantsSaveButton() {
        const saveBtn = document.getElementById('saveParticipantsJsonBtn');
        const downloadBtn = document.getElementById('downloadParticipantsJsonBtn');
        const statusDiv = document.getElementById('participantsSaveStatus');

        if (saveBtn) {
            saveBtn.onclick = async () => {
                const schema = buildParticipantsJsonSchema();
                if (Object.keys(schema).length === 0) {
                    alert('No fields selected');
                    return;
                }

                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';

                try {
                    // First get existing schema to merge
                    const existingRes = await fetch('/api/projects/participants');
                    const existingData = await existingRes.json();
                    const existingSchema = existingData.success ? (existingData.schema || {}) : {};

                    // Merge new fields into existing schema
                    const mergedSchema = { ...existingSchema, ...schema };

                    // Ensure participant_id is present
                    if (!mergedSchema.participant_id) {
                        mergedSchema.participant_id = { Description: 'Unique participant identifier' };
                    }

                    // Save merged schema
                    const response = await fetch('/api/projects/participants', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ schema: mergedSchema })
                    });
                    const result = await response.json();

                    if (result.success) {
                        statusDiv.innerHTML = `<span class="text-success"><i class="fas fa-check-circle me-1"></i>Saved ${Object.keys(schema).length} fields to participants.json!</span>`;
                    } else {
                        statusDiv.innerHTML = `<span class="text-danger"><i class="fas fa-exclamation-circle me-1"></i>${result.error}</span>`;
                    }
                } catch (e) {
                    statusDiv.innerHTML = `<span class="text-danger"><i class="fas fa-exclamation-circle me-1"></i>${e.message}</span>`;
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="fas fa-save me-1"></i>Save to participants.json';
                }
            };
        }

        if (downloadBtn) {
            downloadBtn.onclick = () => {
                const schema = buildParticipantsJsonSchema();
                if (Object.keys(schema).length === 0) {
                    alert('No fields selected');
                    return;
                }

                // Ensure participant_id is present
                if (!schema.participant_id) {
                    schema.participant_id = { Description: 'Unique participant identifier' };
                }

                const blob = new Blob([JSON.stringify(schema, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'participants.json';
                a.click();
                URL.revokeObjectURL(url);
            };
        }
    }

    // ========================================
    // Duplicate Resolution Handling
    // ========================================

    const duplicateResolutionPanel = document.getElementById('duplicateResolutionPanel');
    const duplicateList = document.getElementById('duplicateList');
    const cancelDuplicateBtn = document.getElementById('cancelDuplicateResolution');
    const proceedDuplicateBtn = document.getElementById('proceedWithDuplicates');

    // Store pending conversion data for retry
    let pendingConversionData = null;

    // Parse duplicate error message to extract duplicate IDs
    function parseDuplicateError(errorMsg) {
        // Match: "Duplicate participant IDs found using column 'xxx' (N duplicate rows).\nDuplicated values: id1, id2, ..."
        const match = errorMsg.match(/Duplicate participant IDs found using column '([^']+)' \((\d+) duplicate rows\)[\s\S]*?Duplicated values: ([^\n]+)/);
        if (!match) return null;

        const column = match[1];
        const count = parseInt(match[2]);
        const valuesStr = match[3].trim();

        // Parse the values (may include " and X more..." suffix)
        let values = [];
        const moreMatch = valuesStr.match(/(.+?) and (\d+) more\.\.\.$/);
        if (moreMatch) {
            values = moreMatch[1].split(/,\s*/).map(v => v.trim());
        } else {
            values = valuesStr.split(/,\s*/).map(v => v.trim());
        }

        return { column, count, values };
    }

    // Show duplicate resolution panel
    function showDuplicateResolution(duplicateInfo, conversionFormData) {
        pendingConversionData = conversionFormData;

        // Update description
        document.getElementById('duplicateDescription').innerHTML =
            `Found <strong>${duplicateInfo.count}</strong> duplicate entries using column <code>${duplicateInfo.column}</code>. ` +
            `Choose how to handle each duplicate or apply a global action.`;

        // Populate duplicate list
        duplicateList.innerHTML = '';
        duplicateInfo.values.forEach((id, idx) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><code>${id}</code></td>
                <td><span class="badge bg-warning text-dark">2+</span></td>
                <td>
                    <select class="form-select form-select-sm duplicate-action" data-id="${id}" style="width: auto;">
                        <option value="keep_first">Keep First</option>
                        <option value="keep_last">Keep Last</option>
                        <option value="sessions">Multiple Sessions</option>
                        <option value="skip">Skip All Occurrences</option>
                    </select>
                </td>
            `;
            duplicateList.appendChild(row);
        });

        // Show panel
        duplicateResolutionPanel.classList.remove('d-none');
        convertError.classList.add('d-none');
    }

    // Handle global action buttons
    document.querySelectorAll('.duplicate-global-action').forEach(btn => {
        btn.addEventListener('click', function() {
            const action = this.dataset.action;
            document.querySelectorAll('.duplicate-action').forEach(select => {
                select.value = action;
            });
        });
    });

    // Cancel duplicate resolution
    if (cancelDuplicateBtn) {
        cancelDuplicateBtn.addEventListener('click', function() {
            duplicateResolutionPanel.classList.add('d-none');
            pendingConversionData = null;
        });
    }

    // Proceed with duplicate resolution
    if (proceedDuplicateBtn) {
        proceedDuplicateBtn.addEventListener('click', async function() {
            if (!pendingConversionData) return;

            // Collect all selected actions
            const actions = {};
            let globalAction = null;
            const allSelects = document.querySelectorAll('.duplicate-action');

            // Check if all actions are the same (then use global strategy)
            const firstAction = allSelects[0]?.value;
            const allSame = Array.from(allSelects).every(s => s.value === firstAction);

            if (allSame && firstAction && firstAction !== 'skip') {
                // Use global strategy
                globalAction = firstAction;
            } else {
                // Per-participant actions need backend support
                // For now, use the most common non-skip action
                const counts = {};
                allSelects.forEach(s => {
                    const v = s.value;
                    if (v !== 'skip') {
                        counts[v] = (counts[v] || 0) + 1;
                    }
                });
                globalAction = Object.keys(counts).sort((a, b) => counts[b] - counts[a])[0] || 'keep_first';
            }

            // Update FormData with new duplicate handling strategy
            pendingConversionData.set('duplicate_handling', globalAction);

            // Hide panel and show progress
            duplicateResolutionPanel.classList.add('d-none');
            appendLog(`Retrying conversion with duplicate handling: ${globalAction}`, 'info');

            // Re-trigger conversion with updated FormData
            const progressContainer = document.getElementById('surveyConversionProgress');
            progressContainer.classList.remove('d-none');
            convertBtn.disabled = true;

            try {
                const response = await fetch('/api/survey-convert-validate', {
                    method: 'POST',
                    body: pendingConversionData
                });
                const data = await response.json();

                if (!response.ok || data.error) {
                    throw new Error(data.error || 'Conversion failed');
                }

                // Handle successful conversion (similar to original logic)
                progressContainer.classList.add('d-none');

                // If conversion was successful, show results
                if (data.validation) {
                    displayValidationResults(data.validation, 'survey');
                }
                if (data.log) {
                    data.log.forEach(entry => appendLog(entry.message, entry.level));
                }
                if (data.zip_base64) {
                    const byteCharacters = atob(data.zip_base64);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    currentConvertedZipBlob = new Blob([byteArray], {type: 'application/zip'});
                    appendLog('Dataset ready for download', 'success');
                }
                displayConversionSummary(data);

                if (data.saved_to_project) {
                    convertInfo.innerHTML = `Conversion complete. <strong>${data.saved_file_count || 0} files saved to project.</strong>`;
                } else {
                    convertInfo.textContent = 'Conversion complete. See results below.';
                }
                convertInfo.classList.remove('d-none');

            } catch (err) {
                progressContainer.classList.add('d-none');
                appendLog(`Error: ${err.message}`, 'error');
                convertError.textContent = err.message;
                convertError.classList.remove('d-none');
            } finally {
                updateConvertBtn();
                pendingConversionData = null;
            }
        });
    }

    // ========================================
    // Convert Button Click Handler
    // ========================================

    convertBtn.addEventListener('click', function() {
        convertError.classList.add('d-none');
        convertInfo.classList.add('d-none');
        convertError.textContent = '';
        convertInfo.textContent = '';
        resetConversionUI();

        // Hide template results and participant metadata section
        if (templateResultsContainer) {
            templateResultsContainer.classList.add('d-none');
            document.getElementById('templateResultSingle')?.classList.add('d-none');
            document.getElementById('templateResultGroups')?.classList.add('d-none');
            document.getElementById('templateResultQuestions')?.classList.add('d-none');
            document.getElementById('participantMetadataSection')?.classList.add('d-none');
        }

        // Check for uploaded file OR browsed file path
        const uploadedFile = convertExcelFile.files && convertExcelFile.files[0];
        const browsedFilePath = convertSelectedFilePath ? convertSelectedFilePath.value.trim() : '';

        if (!uploadedFile && !browsedFilePath) {
            return;
        }

        // Get filename from either source
        let filename;
        const usingFilePath = !uploadedFile && browsedFilePath;
        if (usingFilePath) {
            filename = browsedFilePath.split(/[\\/]/).pop().toLowerCase();
        } else {
            filename = uploadedFile.name.toLowerCase();
        }

        const mode = getConvertMode();
        const isLssFile = filename.endsWith('.lss');
        const isLimeSurveyFile = filename.endsWith('.lss') || filename.endsWith('.lsa');

        // TEMPLATE GENERATION MODE
        if (mode === 'template') {
            // Pass file path or file object to template generation
            if (usingFilePath) {
                handleTemplateGeneration(browsedFilePath);
            } else {
                handleTemplateGeneration(uploadedFile);
            }
            return;
        }

        // DATA CONVERSION MODE

        // Prevent .lss files in data mode (they don't contain response data)
        if (isLssFile) {
            convertError.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i><strong>.lss files contain structure only</strong> (no response data). Please use <strong>Template Generation</strong> mode, or upload a <strong>.lsa</strong> file (archive with responses).';
            convertError.classList.remove('d-none');
            return;
        }

        const libraryPath = convertLibraryPathInput ? convertLibraryPathInput.value.trim() : '';
        if (!libraryPath) {
            convertError.textContent = 'Please select a survey template library folder first.';
            convertError.classList.remove('d-none');
            return;
        }

        const displayName = usingFilePath ? browsedFilePath.split(/[\\/]/).pop() : uploadedFile.name;
        appendLog(`Starting conversion of: ${displayName}`, 'info');
        appendLog(`Using library: ${libraryPath}`, 'step');

        const formData = new FormData();
        if (usingFilePath) {
            // Send file path instead of uploading
            formData.append('file_path', browsedFilePath);
        } else {
            formData.append('excel', uploadedFile);
        }

        const alias = convertAliasFile && convertAliasFile.files && convertAliasFile.files[0];
        if (alias) {
            formData.append('alias', alias);
            appendLog(`Using alias file: ${alias.name}`, 'step');
        }

        formData.append('library_path', libraryPath);
        formData.append('dataset_name', convertDatasetName.value.trim());
        formData.append('unknown', convertUnknown.value);

        // Add ID column if selected
        const idColumn = document.getElementById('convertIdColumn')?.value;
        if (idColumn && idColumn !== 'auto') {
            formData.append('id_column', idColumn);
            appendLog(`Using ID column: ${idColumn}`, 'step');
        }

        const sessionVal = document.getElementById('convertSession') ? document.getElementById('convertSession').value.trim() : '';
        if (sessionVal) {
            formData.append('session', sessionVal);
            appendLog(`Forcing session ID: ${sessionVal}`, 'step');
        }

        formData.append('language', convertLanguage ? convertLanguage.value : 'auto');
        formData.append('validate', 'true');  // Request validation

        const strictLevelsEl = document.getElementById('convertStrictLevels');
        if (strictLevelsEl && strictLevelsEl.checked) {
            formData.append('strict_levels', 'true');
            appendLog('Strict Levels Validation: enabled', 'step');
        }

        // Duplicate handling option
        const duplicateHandlingEl = document.getElementById('convertDuplicateHandling');
        const duplicateHandling = duplicateHandlingEl ? duplicateHandlingEl.value : 'error';
        if (duplicateHandling !== 'ask') {
            formData.append('duplicate_handling', duplicateHandling);
            if (duplicateHandling !== 'error') {
                appendLog(`Duplicate handling: ${duplicateHandling}`, 'step');
            }
        }

        // Save to project option
        const saveToProjectEl = document.getElementById('convertSaveToProject');
        if (saveToProjectEl && saveToProjectEl.checked) {
            formData.append('save_to_project', 'true');
            appendLog('Save to Project: enabled', 'step');
        }

        convertBtn.disabled = true;
        appendLog('Uploading file and starting conversion...', 'info');

        // Show progress steps
        const progressContainer = document.getElementById('surveyConversionProgress');
        const progressText = document.getElementById('surveyProgressText');
        const progressBar = document.getElementById('surveyProgressBar');
        const summaryContainer = document.getElementById('conversionSummaryContainer');
        summaryContainer.classList.add('d-none');
        progressContainer.classList.remove('d-none');

        // Step icons and lines
        const step1 = document.getElementById('step1Icon');
        const step2 = document.getElementById('step2Icon');
        const step3 = document.getElementById('step3Icon');
        const step4 = document.getElementById('step4Icon');
        const line1 = document.getElementById('line1');
        const line2 = document.getElementById('line2');
        const line3 = document.getElementById('line3');

        // Reset all steps and progress bar
        [step1, step2, step3, step4].forEach(s => {
            s.classList.remove('bg-success', 'bg-warning');
            s.classList.add('bg-secondary');
        });
        [line1, line2, line3].forEach(l => {
            l.classList.remove('border-success', 'border-warning');
            l.classList.add('border-secondary');
        });
        progressBar.style.width = '0%';
        progressBar.classList.remove('bg-success');
        progressBar.classList.add('bg-warning', 'progress-bar-animated');

        // Activate step 1 (Upload)
        step1.classList.remove('bg-secondary');
        step1.classList.add('bg-warning');
        progressText.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Uploading file...';

        // Generate job ID for SSE progress tracking
        const jobId = crypto.randomUUID ? crypto.randomUUID() : 'job_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        formData.append('job_id', jobId);

        function activateStep(stepNum, progressPct) {
            const steps = [step1, step2, step3, step4];
            const lines = [line1, line2, line3];

            // Mark previous steps as complete
            for (let i = 0; i < stepNum - 1; i++) {
                steps[i].classList.remove('bg-warning', 'bg-secondary');
                steps[i].classList.add('bg-success');
                steps[i].innerHTML = '<i class="fas fa-check"></i>';
                if (lines[i]) {
                    lines[i].classList.remove('border-secondary', 'border-warning');
                    lines[i].classList.add('border-success');
                }
            }

            // Activate current step
            if (steps[stepNum - 1]) {
                steps[stepNum - 1].classList.remove('bg-secondary', 'bg-success');
                steps[stepNum - 1].classList.add('bg-warning');
            }

            // Update progress bar
            if (progressPct !== undefined) {
                progressBar.style.transition = 'width 0.4s ease';
                progressBar.style.width = progressPct + '%';
            }
        }

        // Connect to SSE for real-time progress updates
        let eventSource = null;
        let sseConnected = false;

        function connectSSE() {
            eventSource = new EventSource(`/api/conversion-progress-stream/${jobId}`);

            eventSource.onmessage = function(event) {
                sseConnected = true;
                try {
                    const data = JSON.parse(event.data);
                    if (data.progress !== undefined) {
                        activateStep(data.step || 1, data.progress);
                        progressText.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>${data.message || 'Processing...'}`;
                    }
                    if (data.status === 'complete' || data.status === 'error') {
                        eventSource.close();
                    }
                } catch (e) {
                    // Ignore parse errors (heartbeats)
                }
            };

            eventSource.onerror = function() {
                // SSE connection failed, will fallback to simulated progress
                if (!sseConnected) {
                    eventSource.close();
                    // Use fallback simulated progress
                    const fallbackSteps = [
                        { step: 1, text: 'Uploading file...', delay: 0, progress: 10 },
                        { step: 2, text: 'Processing survey data...', delay: 1000, progress: 35 },
                        { step: 3, text: 'Converting to BIDS format...', delay: 3000, progress: 60 },
                        { step: 4, text: 'Validating output...', delay: 5000, progress: 85 }
                    ];
                    fallbackSteps.forEach(({ step, text, delay, progress }) => {
                        setTimeout(() => {
                            activateStep(step, progress);
                            progressText.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>${text}`;
                        }, delay);
                    });
                }
            };
        }

        // Start SSE connection
        connectSSE();

        fetch('/api/survey-convert-validate', {
            method: 'POST',
            body: formData,
        })
        .then(async response => {
            const contentType = response.headers.get('content-type') || '';
            
            if (contentType.includes('application/json')) {
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Conversion failed');
                }
                return data;
            } else {
                // Fallback: direct ZIP download (old API)
                if (!response.ok) {
                    throw new Error('Conversion failed');
                }
                const blob = await response.blob();
                return { blob, validation: null };
            }
        })
        .then(data => {
            // Close SSE connection
            if (eventSource) {
                eventSource.close();
            }

            // Mark all steps complete with smooth animation
            [step1, step2, step3, step4].forEach(s => {
                s.classList.remove('bg-warning', 'bg-secondary');
                s.classList.add('bg-success');
                s.innerHTML = '<i class="fas fa-check"></i>';
            });
            [line1, line2, line3].forEach(l => {
                l.classList.remove('border-secondary', 'border-warning');
                l.classList.add('border-success');
            });

            // Complete progress bar
            progressBar.style.transition = 'width 0.3s ease';
            progressBar.style.width = '100%';
            progressBar.classList.remove('bg-warning', 'progress-bar-animated');
            progressBar.classList.add('bg-success');
            progressText.innerHTML = '<i class="fas fa-check-circle text-success me-2"></i>Conversion complete!';

            // Hide progress after a longer delay so user can see completion
            setTimeout(() => {
                progressContainer.classList.add('d-none');
            }, 1500);

            if (data.log && Array.isArray(data.log)) {
                data.log.forEach(entry => {
                    appendLog(entry.message, entry.type || 'info');
                });
            }

            if (data.validation) {
                const v = data.validation;
                const errorCount = (v.errors || []).length;
                const warningCount = (v.warnings || []).length;

                if (errorCount === 0 && warningCount === 0) {
                    appendLog('✓ Validation passed - dataset is valid!', 'success');
                } else if (errorCount === 0) {
                    appendLog(`⚠ Validation passed with ${warningCount} warning(s)`, 'warning');
                } else {
                    appendLog(`✗ Validation failed with ${errorCount} error(s)`, 'error');
                }

                displayValidationResults(data.validation);
            }

            if (data.zip_base64) {
                // Decode base64 ZIP
                const byteCharacters = atob(data.zip_base64);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                currentZipBlob = new Blob([byteArray], { type: 'application/zip' });
                appendLog('Dataset ready for download', 'success');
            } else if (data.blob) {
                currentZipBlob = data.blob;
                appendLog('Dataset ready for download', 'success');
            }

            // Display conversion summary with statistics
            displayConversionSummary(data);

            // Show save-to-project success message
            if (data.saved_to_project) {
                appendLog(`Saved ${data.saved_file_count || 0} files to project: ${data.saved_to_project}`, 'success');
                convertInfo.innerHTML = `Conversion complete. <strong>${data.saved_file_count || 0} files saved to project.</strong> See results below.`;
            } else {
                convertInfo.textContent = 'Conversion complete. See results below.';
            }
            convertInfo.classList.remove('d-none');
        })
        .catch(err => {
            // Close SSE connection
            if (eventSource) {
                eventSource.close();
            }

            // Show error state on progress bar
            progressBar.classList.remove('bg-warning', 'progress-bar-animated');
            progressBar.classList.add('bg-danger');
            progressBar.style.width = '100%';
            progressText.innerHTML = '<i class="fas fa-exclamation-circle text-danger me-2"></i>Conversion failed';

            // Hide progress after delay
            setTimeout(() => {
                progressContainer.classList.add('d-none');
            }, 2000);

            // Check if this is a duplicate error and user wants to handle it interactively
            const duplicateHandlingMode = document.getElementById('convertDuplicateHandling')?.value || 'error';
            const duplicateInfo = parseDuplicateError(err.message);

            if (duplicateInfo && duplicateHandlingMode === 'ask') {
                // Show duplicate resolution panel
                appendLog('Duplicate IDs found - awaiting user resolution...', 'warn');
                showDuplicateResolution(duplicateInfo, formData);
            } else if (duplicateInfo) {
                // Show error with helpful message about duplicate options
                appendLog(`Error: ${err.message}`, 'error');
                convertError.innerHTML = `
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Duplicate Participant IDs</strong><br>
                    ${err.message}<br><br>
                    <small class="text-muted">
                        <i class="fas fa-lightbulb me-1"></i>
                        Tip: Use <strong>Advanced options > Duplicate IDs</strong> to configure how duplicates are handled,
                        or select "Ask for each duplicate" for interactive resolution.
                    </small>
                `;
                convertError.classList.remove('d-none');
            } else {
                // Regular error
                appendLog(`Error: ${err.message}`, 'error');
                convertError.textContent = err.message;
                convertError.classList.remove('d-none');
            }
        })
        .finally(() => {
            updateConvertBtn();
        });
    });

    function updateBiometricsBtn() {
        const hasFile = biometricsDataFile && biometricsDataFile.files && biometricsDataFile.files.length === 1;
        const hasLibraryPath = biometricsLibraryPathInput && biometricsLibraryPathInput.value.trim() !== '';
        if (biometricsConvertBtn) biometricsConvertBtn.disabled = !(hasFile && hasLibraryPath);
    }

    function checkBiometricsLibraryStructure() {
        const libraryPath = biometricsLibraryPathInput ? biometricsLibraryPathInput.value.trim() : '';
        const structureWarning = document.getElementById('biometricsStructureWarning');
        const structureMessage = document.getElementById('biometricsStructureMessage');
        
        if (!libraryPath) {
            if (structureWarning) structureWarning.classList.add('d-none');
            return;
        }
        
        const url = `/api/biometrics-check-library?library_path=${encodeURIComponent(libraryPath)}`;
        fetch(url)
            .then(r => r.json())
            .then(data => {
                if (structureWarning && structureMessage && data.structure) {
                    const missing = data.structure.missing_items || [];
                    if (missing.length > 0) {
                        structureMessage.textContent = `The selected folder is missing: ${missing.join(', ')}. Expected library structure: survey/, biometrics/, participants.json`;
                        structureWarning.classList.remove('d-none');
                    } else {
                        structureWarning.classList.add('d-none');
                    }
                } else if (structureWarning) {
                    structureWarning.classList.add('d-none');
                }
            })
            .catch(() => {
                if (structureWarning) structureWarning.classList.add('d-none');
            });
    }

    if (biometricsDataFile) {
        biometricsDataFile.addEventListener('change', updateBiometricsBtn);
        updateBiometricsBtn();
    }

    if (biometricsLibraryPathInput) {
        biometricsLibraryPathInput.addEventListener('change', function() {
            checkBiometricsLibraryStructure();
            updateBiometricsBtn();
        });
        biometricsLibraryPathInput.addEventListener('blur', function() {
            checkBiometricsLibraryStructure();
            updateBiometricsBtn();
        });
    }

    function downloadCurrentBiometricsZip() {
        if (!currentBiometricsZipBlob) return;
        const url = window.URL.createObjectURL(currentBiometricsZipBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'prism_biometrics_dataset.zip';
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
    }

    if (biometricsDownloadZipBtn) {
        biometricsDownloadZipBtn.addEventListener('click', downloadCurrentBiometricsZip);
    }
    if (biometricsDownloadZipWarningBtn) {
        biometricsDownloadZipWarningBtn.addEventListener('click', downloadCurrentBiometricsZip);
    }

    if (biometricsConvertBtn) {
        biometricsConvertBtn.addEventListener('click', function() {
            biometricsError.classList.add('d-none');
            biometricsInfo.classList.add('d-none');
            biometricsError.textContent = '';
            biometricsInfo.textContent = '';
            resetBiometricsUI();

            const libraryPath = biometricsLibraryPathInput ? biometricsLibraryPathInput.value.trim() : '';
            if (!libraryPath) {
                biometricsError.textContent = 'Please select a biometrics template library folder first.';
                biometricsError.classList.remove('d-none');
                return;
            }

            const file = biometricsDataFile.files && biometricsDataFile.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('data', file);
            formData.append('library_path', libraryPath);
            formData.append('sheet', (document.getElementById('biometricsSheet') || {value: '0'}).value);

            biometricsConvertBtn.disabled = true;
            biometricsInfo.textContent = 'Analyzing file...';
            biometricsInfo.classList.remove('d-none');

            fetch('/api/biometrics-detect', {
                method: 'POST',
                body: formData,
            })
            .then(async response => {
                if (!response.ok) {
                    const data = await response.json().catch(() => null);
                    throw new Error(data && data.error ? data.error : 'Detection failed');
                }
                return response.json();
            })
            .then(data => {
                biometricsInfo.classList.add('d-none');
                if (!data.tasks || data.tasks.length === 0) {
                    biometricsError.textContent = 'No biometrics tasks detected in the file. Please check your templates and column names.';
                    biometricsError.classList.remove('d-none');
                    return;
                }

                // Show detected tasks
                biometricsDetectedContainer.classList.remove('d-none');
                biometricsDetectedList.innerHTML = '';
                data.tasks.forEach(task => {
                    const col = document.createElement('div');
                    col.className = 'col-md-4';
                    col.innerHTML = `
                        <div class="form-check">
                            <input class="form-check-input biometrics-task-check" type="checkbox" value="${task}" id="task_${task}" checked>
                            <label class="form-check-label small" for="task_${task}">
                                ${task}
                            </label>
                        </div>
                    `;
                    biometricsDetectedList.appendChild(col);
                });
            })
            .catch(err => {
                biometricsError.textContent = err.message;
                biometricsError.classList.remove('d-none');
            })
            .finally(() => {
                biometricsConvertBtn.disabled = false;
            });
        });
    }

    if (biometricsSelectAll) {
        biometricsSelectAll.addEventListener('change', function() {
            const checks = document.querySelectorAll('.biometrics-task-check');
            checks.forEach(c => c.checked = biometricsSelectAll.checked);
        });
    }

    if (biometricsConfirmBtn) {
        biometricsConfirmBtn.addEventListener('click', function() {
            const selectedTasks = Array.from(document.querySelectorAll('.biometrics-task-check:checked')).map(c => c.value);
            if (selectedTasks.length === 0) {
                alert('Please select at least one task to export.');
                return;
            }

            biometricsError.classList.add('d-none');
            biometricsInfo.classList.add('d-none');
            
            // Show log container
            biometricsLogContainer.classList.remove('d-none');
            biometricsLogBody.classList.remove('d-none');
            const icon = toggleBiometricsLogBtn.querySelector('i');
            icon.classList.remove('fa-chevron-right');
            icon.classList.add('fa-chevron-down');

            const libraryPath = biometricsLibraryPathInput ? biometricsLibraryPathInput.value.trim() : '';
            const file = biometricsDataFile.files && biometricsDataFile.files[0];

            appendLog(`Starting conversion of: ${file.name}`, 'info', biometricsLog);
            appendLog(`Using library: ${libraryPath}`, 'step', biometricsLog);

            const formData = new FormData();
            formData.append('data', file);
            formData.append('library_path', libraryPath);
            formData.append('dataset_name', biometricsDatasetName.value.trim());
            formData.append('unknown', biometricsUnknown.value);

            const sessionVal = document.getElementById('biometricsSession') ? document.getElementById('biometricsSession').value.trim() : '';
            if (sessionVal) {
                formData.append('session', sessionVal);
                appendLog(`Forcing session ID: ${sessionVal}`, 'step', biometricsLog);
            }

            formData.append('validate', 'true');
            selectedTasks.forEach(t => formData.append('tasks[]', t));

            biometricsConfirmBtn.disabled = true;
            appendLog('Uploading file and starting conversion...', 'info', biometricsLog);

            fetch('/api/biometrics-convert', {
                method: 'POST',
                body: formData,
            })
            .then(async response => {
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Conversion failed');
                }
                return data;
            })
            .then(data => {
                if (data.log && Array.isArray(data.log)) {
                    data.log.forEach(entry => {
                        appendLog(entry.message, entry.type || 'info', biometricsLog);
                    });
                }

                if (data.validation) {
                    const v = data.validation;
                    const errorCount = (v.errors || []).length;
                    const warningCount = (v.warnings || []).length;
                    
                    if (errorCount === 0 && warningCount === 0) {
                        appendLog('✓ Validation passed - dataset is valid!', 'success', biometricsLog);
                    } else if (errorCount === 0) {
                        appendLog(`⚠ Validation passed with ${warningCount} warning(s)`, 'warning', biometricsLog);
                    } else {
                        appendLog(`✗ Validation failed with ${errorCount} error(s)`, 'error', biometricsLog);
                    }
                    
                    displayValidationResults(data.validation, 'biometrics');
                }

                if (data.zip_base64) {
                    const byteCharacters = atob(data.zip_base64);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    currentBiometricsZipBlob = new Blob([byteArray], {type: 'application/zip'});
                    
                    appendLog('Conversion complete. Click the download button below.', 'success', biometricsLog);
                }
            })
            .catch(err => {
                appendLog(`Error: ${err.message}`, 'error', biometricsLog);
                biometricsError.textContent = err.message;
                biometricsError.classList.remove('d-none');
            })
            .finally(() => {
                biometricsConfirmBtn.disabled = false;
            });
        });
    }

    function updatePhysioBtn() {
        const hasFile = physioRawFile && physioRawFile.files && physioRawFile.files.length === 1;
        if (physioConvertBtn) physioConvertBtn.disabled = !hasFile;
    }

    if (physioRawFile) {
        physioRawFile.addEventListener('change', updatePhysioBtn);
        updatePhysioBtn();
    }

    if (physioConvertBtn) {
        physioConvertBtn.addEventListener('click', function() {
            physioError.classList.add('d-none');
            physioInfo.classList.add('d-none');
            physioError.textContent = '';
            physioInfo.textContent = '';

            const file = physioRawFile.files && physioRawFile.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('raw', file);
            formData.append('task', physioTask ? physioTask.value.trim() : 'rest');
            if (physioSamplingRate && physioSamplingRate.value) {
                formData.append('sampling_rate', physioSamplingRate.value);
            }

            physioConvertBtn.disabled = true;
            physioInfo.textContent = 'Converting... this may take a moment.';
            physioInfo.classList.remove('d-none');

            fetch('/api/physio-convert', {
                method: 'POST',
                body: formData,
            })
            .then(async response => {
                if (!response.ok) {
                    const data = await response.json().catch(() => null);
                    const msg = data && data.error ? data.error : 'Conversion failed';
                    throw new Error(msg);
                }
                const blob = await response.blob();
                return blob;
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'varioport_edfplus.zip';
                document.body.appendChild(a);
                a.click();
                a.remove();
                physioInfo.textContent = 'Done. Your ZIP download should start automatically.';
                physioInfo.classList.remove('d-none');
            })
            .catch(err => {
                physioError.textContent = err.message;
                physioError.classList.remove('d-none');
            })
            .finally(() => {
                updatePhysioBtn();
            });
        });
    }

    // --- Physio Batch Convert ---
    function updatePhysioBatchBtn() {
        const hasFiles = physioBatchFiles && physioBatchFiles.files && physioBatchFiles.files.length > 0;
        if (physioBatchConvertBtn) physioBatchConvertBtn.disabled = !hasFiles;
    }

    if (physioBatchFiles) {
        physioBatchFiles.addEventListener('change', updatePhysioBatchBtn);
        updatePhysioBatchBtn();
    }

    if (physioBatchLogClearBtn) {
        physioBatchLogClearBtn.addEventListener('click', () => {
            if (physioBatchLog) physioBatchLog.textContent = '';
        });
    }

    if (physioBatchConvertBtn) {
        physioBatchConvertBtn.addEventListener('click', async function() {
            physioBatchError.classList.add('d-none');
            physioBatchInfo.classList.add('d-none');
            physioBatchProgress.classList.remove('d-none');
            physioBatchLogContainer.classList.remove('d-none');
            physioBatchLog.textContent = '';
            physioBatchConvertBtn.disabled = true;

            const files = Array.from(physioBatchFiles.files);
            const datasetName = physioBatchDatasetName ? physioBatchDatasetName.value.trim() : 'Physio Dataset';
            const samplingRate = physioBatchSamplingRate ? physioBatchSamplingRate.value : '';

            const formData = new FormData();
            files.forEach(f => formData.append('files', f));
            formData.append('dataset_name', datasetName);
            formData.append('modality', 'physio');
            if (samplingRate) formData.append('sampling_rate', samplingRate);

            try {
                const response = await fetch('/api/batch-convert', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const data = await response.json().catch(() => null);
                    throw new Error(data && data.error ? data.error : 'Batch conversion failed');
                }

                const result = await response.json();
                
                // Show log
                if (result.log) {
                    physioBatchLog.textContent = result.log;
                }

                // Download the ZIP
                if (result.zip) {
                    downloadBase64Zip(result.zip, `${datasetName}_prism.zip`);
                }

                physioBatchInfo.textContent = `Converted ${result.converted || 0} files. ${result.errors || 0} errors.`;
                physioBatchInfo.classList.remove('d-none');
            } catch (err) {
                physioBatchError.textContent = err.message;
                physioBatchError.classList.remove('d-none');
            } finally {
                physioBatchProgress.classList.add('d-none');
                updatePhysioBatchBtn();
            }
        });
    }

    // --- Eyetracking Single Convert ---
    function updateEyetrackingSingleBtn() {
        const hasFile = eyetrackingSingleFile && eyetrackingSingleFile.files && eyetrackingSingleFile.files.length === 1;
        const hasSubject = eyetrackingSubject && eyetrackingSubject.value.trim().length > 0;
        if (eyetrackingSingleConvertBtn) eyetrackingSingleConvertBtn.disabled = !(hasFile && hasSubject);
    }

    if (eyetrackingSingleFile) {
        eyetrackingSingleFile.addEventListener('change', updateEyetrackingSingleBtn);
    }
    if (eyetrackingSubject) {
        eyetrackingSubject.addEventListener('input', updateEyetrackingSingleBtn);
    }
    updateEyetrackingSingleBtn();

    if (eyetrackingSingleConvertBtn) {
        eyetrackingSingleConvertBtn.addEventListener('click', async function() {
            eyetrackingSingleError.classList.add('d-none');
            eyetrackingSingleInfo.classList.add('d-none');
            eyetrackingSingleConvertBtn.disabled = true;

            const file = eyetrackingSingleFile.files[0];
            const subject = eyetrackingSubject.value.trim();
            const session = eyetrackingSession ? eyetrackingSession.value.trim() : '';
            const task = eyetrackingTask ? eyetrackingTask.value.trim() : 'gaze';

            const formData = new FormData();
            formData.append('edf', file);
            formData.append('subject', subject);
            formData.append('task', task);
            if (session) formData.append('session', session);

            eyetrackingSingleInfo.textContent = 'Converting... this may take a moment.';
            eyetrackingSingleInfo.classList.remove('d-none');

            try {
                const response = await fetch('/api/eyetracking-convert', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const data = await response.json().catch(() => null);
                    throw new Error(data && data.error ? data.error : 'Conversion failed');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'eyetracking_prism.zip';
                document.body.appendChild(a);
                a.click();
                a.remove();
                eyetrackingSingleInfo.textContent = 'Done. Your ZIP download should start automatically.';
            } catch (err) {
                eyetrackingSingleError.textContent = err.message;
                eyetrackingSingleError.classList.remove('d-none');
                eyetrackingSingleInfo.classList.add('d-none');
            } finally {
                updateEyetrackingSingleBtn();
            }
        });
    }

    // --- Eyetracking Batch Convert ---
    function updateEyetrackingBatchBtn() {
        const hasFiles = eyetrackingBatchFiles && eyetrackingBatchFiles.files && eyetrackingBatchFiles.files.length > 0;
        if (eyetrackingBatchConvertBtn) eyetrackingBatchConvertBtn.disabled = !hasFiles;
    }

    if (eyetrackingBatchFiles) {
        eyetrackingBatchFiles.addEventListener('change', updateEyetrackingBatchBtn);
        updateEyetrackingBatchBtn();
    }

    if (eyetrackingBatchLogClearBtn) {
        eyetrackingBatchLogClearBtn.addEventListener('click', () => {
            if (eyetrackingBatchLog) eyetrackingBatchLog.textContent = '';
        });
    }

    if (eyetrackingBatchConvertBtn) {
        eyetrackingBatchConvertBtn.addEventListener('click', async function() {
            eyetrackingBatchError.classList.add('d-none');
            eyetrackingBatchInfo.classList.add('d-none');
            eyetrackingBatchProgress.classList.remove('d-none');
            eyetrackingBatchLogContainer.classList.remove('d-none');
            eyetrackingBatchLog.textContent = '';
            eyetrackingBatchConvertBtn.disabled = true;

            const files = Array.from(eyetrackingBatchFiles.files);
            const datasetName = eyetrackingBatchDatasetName ? eyetrackingBatchDatasetName.value.trim() : 'Eyetracking Dataset';

            const formData = new FormData();
            files.forEach(f => formData.append('files', f));
            formData.append('dataset_name', datasetName);
            formData.append('modality', 'eyetracking');

            try {
                const response = await fetch('/api/batch-convert', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const data = await response.json().catch(() => null);
                    throw new Error(data && data.error ? data.error : 'Batch conversion failed');
                }

                const result = await response.json();
                
                // Show log
                if (result.log) {
                    eyetrackingBatchLog.textContent = result.log;
                }

                // Download the ZIP
                if (result.zip) {
                    downloadBase64Zip(result.zip, `${datasetName}_prism.zip`);
                }

                eyetrackingBatchInfo.textContent = `Converted ${result.converted || 0} files. ${result.errors || 0} errors.`;
                eyetrackingBatchInfo.classList.remove('d-none');
            } catch (err) {
                eyetrackingBatchError.textContent = err.message;
                eyetrackingBatchError.classList.remove('d-none');
            } finally {
                eyetrackingBatchProgress.classList.add('d-none');
                updateEyetrackingBatchBtn();
            }
        });
    }

    // --- Organize Batch ---
    function updateOrganizeBtn() {
        const hasFiles = organizeFiles && organizeFiles.files && organizeFiles.files.length > 0;
        if (organizeBtn) organizeBtn.disabled = !hasFiles;
    }

    if (organizeFiles) {
        organizeFiles.addEventListener('change', updateOrganizeBtn);
        updateOrganizeBtn();
    }

    if (organizeLogClearBtn) {
        organizeLogClearBtn.addEventListener('click', () => {
            if (organizeLog) organizeLog.textContent = '';
        });
    }

    if (organizeBtn) {
        organizeBtn.addEventListener('click', async function() {
            organizeError.classList.add('d-none');
            organizeInfo.classList.add('d-none');
            organizeProgress.classList.remove('d-none');
            organizeLogContainer.classList.remove('d-none');
            organizeLog.textContent = '';
            organizeBtn.disabled = true;

            const files = Array.from(organizeFiles.files);
            const datasetName = organizeDatasetName ? organizeDatasetName.value.trim() : 'Organized Dataset';
            const modality = organizeModality ? organizeModality.value : 'anat';

            const formData = new FormData();
            files.forEach(f => formData.append('files', f));
            formData.append('dataset_name', datasetName);
            formData.append('modality', modality);

            try {
                const response = await fetch('/api/batch-convert', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const data = await response.json().catch(() => null);
                    throw new Error(data && data.error ? data.error : 'Organization failed');
                }

                const result = await response.json();
                
                // Show log
                if (result.log) {
                    organizeLog.textContent = result.log;
                }

                // Download the ZIP
                if (result.zip) {
                    downloadBase64Zip(result.zip, `${datasetName}_prism.zip`);
                }

                organizeInfo.textContent = `Organized ${result.converted || 0} files. ${result.errors || 0} errors.`;
                organizeInfo.classList.remove('d-none');
            } catch (err) {
                organizeError.textContent = err.message;
                organizeError.classList.remove('d-none');
            } finally {
                organizeProgress.classList.add('d-none');
                updateOrganizeBtn();
            }
        });
    }

    // --- Physio Renamer Logic ---
    const renamerExampleContainer = document.getElementById('renamerExampleContainer');
    const renamerOriginalExample = document.getElementById('renamerOriginalExample');
    const renamerNewExample = document.getElementById('renamerNewExample');
    const renamerModality = document.getElementById('renamerModality');
    const renamerExampleHint = document.getElementById('renamerExampleHint');
    let currentExampleFile = null;

    const modalityHints = {
        'physio': 'sub-001_task-rest_physio.edf',
        'biometrics': 'sub-001_biometrics-height_biometrics.tsv',
        'events': 'sub-001_task-rest_events.tsv',
        'survey': 'sub-001_survey-phq9_survey.tsv'
    };

    const renamerRecordingContainer = document.getElementById('renamerRecordingContainer');
    const renamerRecording = document.getElementById('renamerRecording');

    function updateRecordingVisibility() {
        if (renamerModality && renamerRecordingContainer) {
            const showRecording = renamerModality.value === 'physio';
            renamerRecordingContainer.style.display = showRecording ? 'block' : 'none';
        }
    }

    if (renamerModality) {
        renamerModality.addEventListener('change', () => {
            const mod = renamerModality.value;
            let hint = modalityHints[mod] || 'sub-001_task-rest_physio.edf';
            
            // Update hint based on recording selection for physio
            if (mod === 'physio' && renamerRecording && renamerRecording.value) {
                hint = `sub-001_task-rest_recording-${renamerRecording.value}_physio.edf`;
            }
            
            if (renamerExampleHint) renamerExampleHint.innerHTML = `Example: <code>${hint}</code>`;
            if (renamerNewExample) renamerNewExample.placeholder = `e.g. ${hint}`;
            
            updateRecordingVisibility();
            inferPattern();
        });
    }

    if (renamerRecording) {
        renamerRecording.addEventListener('change', () => {
            const mod = renamerModality ? renamerModality.value : 'physio';
            let hint = modalityHints[mod] || 'sub-001_task-rest_physio.edf';
            
            if (renamerRecording.value) {
                hint = `sub-001_task-rest_recording-${renamerRecording.value}_physio.edf`;
            }
            
            if (renamerExampleHint) renamerExampleHint.innerHTML = `Example: <code>${hint}</code>`;
            if (renamerNewExample) renamerNewExample.placeholder = `e.g. ${hint}`;
            inferPattern();
        });
    }

    // Initialize visibility
    updateRecordingVisibility();

    function updateRenamerBtn() {
        const hasFiles = renamerFiles && renamerFiles.files && renamerFiles.files.length > 0;
        const hasNewName = renamerNewExample && renamerNewExample.value.trim().length > 0;
        if (renamerDownloadBtn) renamerDownloadBtn.disabled = !hasFiles || !hasNewName;
    }

    function pickExampleFile() {
        if (!renamerFiles || !renamerFiles.files || renamerFiles.files.length === 0) return;
        const files = Array.from(renamerFiles.files);
        currentExampleFile = files[Math.floor(Math.random() * files.length)];
        if (renamerOriginalExample) renamerOriginalExample.textContent = currentExampleFile.name;
        if (renamerExampleContainer) renamerExampleContainer.classList.remove('d-none');
        if (renamerNewExample) {
            renamerNewExample.value = '';
            renamerNewExample.focus();
        }
        updateRenamerBtn();
        if (renamerPreview) renamerPreview.classList.add('d-none');
    }

    if (renamerFiles) {
        renamerFiles.addEventListener('change', () => {
            pickExampleFile();
            updateRenamerBtn();
        });
    }

    if (renamerResetBtn) {
        renamerResetBtn.addEventListener('click', pickExampleFile);
    }

    function inferPattern() {
        if (!currentExampleFile || !renamerNewExample) return;
        const oldName = currentExampleFile.name;
        const newName = renamerNewExample.value.trim();
        if (!newName) {
            if (renamerPreview) renamerPreview.classList.add('d-none');
            return;
        }

        // Find all digit sequences in oldName
        const digitRegex = /\d+/g;
        const matches = [];
        let match;
        while ((match = digitRegex.exec(oldName)) !== null) {
            matches.push({ value: match[0], index: match.index });
        }

        // Create regex pattern from oldName by replacing digit sequences with (\d+)
        // and escaping other characters
        let finalPattern = "";
        let lastIndex = 0;
        matches.forEach(m => {
            finalPattern += oldName.substring(lastIndex, m.index).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            finalPattern += '(\\d+)';
            lastIndex = m.index + m.value.length;
        });
        finalPattern += oldName.substring(lastIndex).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        
        // Now create the replacement string
        let replacement = newName;
        
        if (matches.length > 0) {
            // Sort matches by length descending to avoid partial matches (e.g. matching '1' inside '014')
            const uniqueValues = [...new Set(matches.map(m => m.value))].sort((a, b) => b.length - a.length);
            
            // Create a map from value to its first group index
            const valueToGroup = {};
            matches.forEach((m, i) => {
                if (!(m.value in valueToGroup)) {
                    valueToGroup[m.value] = i + 1;
                }
            });

            const combinedRegex = new RegExp(uniqueValues.map(v => v.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('|'), 'g');
            replacement = replacement.replace(combinedRegex, (matched) => {
                return `\\${valueToGroup[matched]}`;
            });
        }

        if (renamerPattern) renamerPattern.value = finalPattern;
        if (renamerReplacement) renamerReplacement.value = replacement;
        
        // Run dry run automatically
        runRenamer(true);
    }

    if (renamerNewExample) {
        renamerNewExample.addEventListener('input', () => {
            inferPattern();
            updateRenamerBtn();
        });
    }

    const renamerOrganize = document.getElementById('renamerOrganize');
    if (renamerOrganize) {
        renamerOrganize.addEventListener('change', () => {
            runRenamer(true);
        });
    }

    function filterRenamerTable(showOnlyUnmatched) {
        if (!renamerPreviewBody) return;
        const rows = renamerPreviewBody.querySelectorAll('tr');
        rows.forEach(row => {
            const isMatch = row.getAttribute('data-match') === 'true';
            if (showOnlyUnmatched) {
                row.classList.toggle('d-none', isMatch);
            } else {
                row.classList.remove('d-none');
            }
        });
        
        if (renamerFilterAll) renamerFilterAll.classList.toggle('active', !showOnlyUnmatched);
        if (renamerFilterUnmatched) renamerFilterUnmatched.classList.toggle('active', showOnlyUnmatched);
    }

    if (renamerFilterAll) {
        renamerFilterAll.addEventListener('click', () => filterRenamerTable(false));
    }
    if (renamerFilterUnmatched) {
        renamerFilterUnmatched.addEventListener('click', () => filterRenamerTable(true));
    }

    async function runRenamer(isDryRun) {
        if (!renamerPattern || !renamerReplacement || !renamerPattern.value) return;
        
        renamerError.classList.add('d-none');
        renamerInfo.classList.add('d-none');
        
        const formData = new FormData();
        formData.append('pattern', renamerPattern.value);
        formData.append('replacement', renamerReplacement.value);
        formData.append('dry_run', isDryRun);
        
        const renamerOrganize = document.getElementById('renamerOrganize');
        if (renamerOrganize) {
            formData.append('organize', renamerOrganize.checked);
        }

        if (renamerModality) {
            formData.append('modality', renamerModality.value);
        }
        
        const files = Array.from(renamerFiles.files);
        if (files.length === 0 && !isDryRun) return;
        
        // For dry run, we only send filenames to be faster
        if (isDryRun) {
            files.forEach(f => formData.append('filenames', f.name));
        } else {
            files.forEach(f => formData.append('files', f));
        }
        
        try {
            const response = await fetch('/api/physio-rename', {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) {
                const data = await response.json().catch(() => null);
                throw new Error(data && data.error ? data.error : 'Renaming failed');
            }
            
            const result = await response.json();
            
            if (isDryRun) {
                renamerPreviewBody.innerHTML = '';
                let matchCount = 0;
                const unmatchedFiles = [];
                const selectedModality = renamerModality ? renamerModality.value : 'physio';

                result.results.forEach(res => {
                    const isMatch = res.old !== res.new;
                    
                    // Basic BIDS validation for the new name
                    let isValidBids = true;
                    let bidsError = '';
                    
                    if (isMatch) {
                        if (!res.new.startsWith('sub-')) {
                            isValidBids = false;
                            bidsError = 'Missing sub- prefix';
                        } else if (!res.new.includes('_')) {
                            isValidBids = false;
                            bidsError = 'Missing entities/suffix';
                        } else {
                            // Check suffix
                            const stem = res.new.split('.')[0];
                            const suffix = stem.split('_').pop();
                            const expectedSuffixes = {
                                'physio': 'physio',
                                'biometrics': 'biometrics',
                                'events': 'events',
                                'survey': 'survey'
                            };
                            if (expectedSuffixes[selectedModality] && suffix !== expectedSuffixes[selectedModality]) {
                                isValidBids = false;
                                bidsError = `Expected _${expectedSuffixes[selectedModality]} suffix`;
                            }
                        }
                    }

                    if (isMatch && isValidBids) {
                        matchCount++;
                    } else if (!isMatch) {
                        unmatchedFiles.push(res.old);
                    }
                    
                    const tr = document.createElement('tr');
                    tr.setAttribute('data-match', isMatch && isValidBids);
                    
                    let displayNew = res.new;
                    if (res.path && res.path !== res.new) {
                        displayNew = `<span class="text-muted">${res.path.substring(0, res.path.lastIndexOf('/') + 1)}</span>${res.new}`;
                    }

                    tr.innerHTML = `
                        <td class="font-monospace small">${res.old}</td>
                        <td><i class="fas fa-arrow-right text-muted"></i></td>
                        <td class="font-monospace small ${isMatch ? (isValidBids ? 'text-success' : 'text-danger') : 'text-muted'}">
                            ${displayNew}
                            ${!isValidBids && isMatch ? `<br><small class="text-danger"><i class="fas fa-times-circle me-1"></i>${bidsError}</small>` : ''}
                        </td>
                        <td class="text-center">
                            ${(isMatch && isValidBids) ? '<i class="fas fa-check-circle text-success"></i>' : 
                              (!isMatch ? '<i class="fas fa-exclamation-triangle text-warning" title="No match found - file will not be renamed"></i>' : 
                              '<i class="fas fa-times-circle text-danger" title="Invalid BIDS/PRISM format"></i>')}
                        </td>
                    `;
                    renamerPreviewBody.appendChild(tr);
                });
                renamerPreview.classList.remove('d-none');

                if (matchCount < result.results.length && result.results.length > 0) {
                    const unmatchedCount = result.results.length - matchCount;
                    renamerError.innerHTML = `
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-triangle me-3 fa-2x"></i>
                            <div>
                                <strong>Warning: ${unmatchedCount} files are either unmatched or invalid.</strong><br>
                                Only files with a green checkmark will be renamed correctly. Check the "New PRISM Filename" column for errors.
                                <div class="mt-2">
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="document.getElementById('renamerFilterUnmatched').click()">
                                        <i class="fas fa-search me-1"></i>Show Incompatible Files
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    renamerError.classList.remove('d-none');
                }
                
                // Reset filter to "All" on new dry run
                filterRenamerTable(false);
            } else {
                if (result.zip) {
                    downloadBase64Zip(result.zip, 'renamed_files.zip');
                    renamerInfo.textContent = `Successfully renamed ${result.results.length} files. ZIP download started.`;
                    renamerInfo.classList.remove('d-none');
                }
            }
        } catch (err) {
            if (!isDryRun) {
                renamerError.textContent = err.message;
                renamerError.classList.remove('d-none');
            }
        }
    }

    if (renamerDownloadBtn) {
        renamerDownloadBtn.addEventListener('click', () => runRenamer(false));
    }

    // Toggle chevron icon for global renamer
    const globalRenamerCollapse = document.getElementById('globalRenamerCollapse');
    if (globalRenamerCollapse) {
        globalRenamerCollapse.addEventListener('show.bs.collapse', function () {
            const icon = document.querySelector('[data-bs-target="#globalRenamerCollapse"] i.fa-chevron-down');
            if (icon) icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
        });
        globalRenamerCollapse.addEventListener('hide.bs.collapse', function () {
            const icon = document.querySelector('[data-bs-target="#globalRenamerCollapse"] i.fa-chevron-up');
            if (icon) icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
        });
    }

    // --- Auto-fill library paths from current project ---
    // Store available library paths for quick switching
    const availableConvertPaths = {
        global: null,
        project: null
    };

    // Update source badge display
    function updateConvertLibrarySourceBadge(source) {
        const badge = document.getElementById('convertLibrarySourceBadge');
        const text = document.getElementById('convertLibrarySourceText');
        if (!badge || !text) return;

        if (source) {
            badge.style.display = 'inline-block';
            if (source === 'global') {
                badge.className = 'badge bg-info ms-2';
                text.textContent = 'Global Library';
            } else if (source === 'project') {
                badge.className = 'badge bg-success ms-2';
                text.textContent = 'Project Library';
            } else {
                badge.className = 'badge bg-secondary ms-2';
                text.textContent = 'Custom Path';
            }
        } else {
            badge.style.display = 'none';
        }
    }

    // Determine current source based on path
    function detectConvertLibrarySource() {
        if (!convertLibraryPathInput) return null;
        const currentPath = convertLibraryPathInput.value.trim();
        if (!currentPath) return null;

        // Normalize paths for comparison
        const normalize = p => p.replace(/\\/g, '/').replace(/\/$/, '').toLowerCase();
        const normalizedCurrent = normalize(currentPath);

        if (availableConvertPaths.project && normalize(availableConvertPaths.project) === normalizedCurrent) {
            return 'project';
        }
        if (availableConvertPaths.global && normalize(availableConvertPaths.global) === normalizedCurrent) {
            return 'global';
        }
        return 'custom';
    }

    async function initializeLibraryPathsFromProject() {
        const projectBtn = document.getElementById('convertUseProjectLibraryBtn');

        try {
            const response = await fetch('/api/projects/library-path');
            const data = await response.json();

            // Store available paths (project only - global removed)
            availableConvertPaths.project = data.project_library_path || null;

            if (projectBtn) {
                if (availableConvertPaths.project) {
                    projectBtn.disabled = false;
                    projectBtn.title = availableConvertPaths.project;
                } else {
                    projectBtn.disabled = true;
                    projectBtn.title = data.project_path ? 'Project has no library folder' : 'No project selected';
                }
            }

            // Auto-fill with project library path
            if (convertLibraryPathInput && !convertLibraryPathInput.value) {
                let selectedPath = null;
                let selectedSource = null;

                if (availableConvertPaths.project) {
                    selectedPath = availableConvertPaths.project;
                    selectedSource = 'project';
                } else if (data.library_path) {
                    selectedPath = data.library_path;
                    selectedSource = 'custom';
                }

                if (selectedPath) {
                    convertLibraryPathInput.value = selectedPath;
                    updateConvertLibrarySourceBadge(selectedSource);
                    // Trigger language detection
                    refreshConvertLanguages();
                }
            } else {
                // Path already set, detect source
                updateConvertLibrarySourceBadge(detectConvertLibrarySource());
            }

            // Auto-fill Biometrics library path from project
            if (biometricsLibraryPathInput && !biometricsLibraryPathInput.value) {
                if (availableConvertPaths.project) {
                    biometricsLibraryPathInput.value = availableConvertPaths.project;
                } else if (data.library_path) {
                    biometricsLibraryPathInput.value = data.library_path;
                }
            }

            console.log('Library paths initialized:', {
                project: availableConvertPaths.project
            });
        } catch (err) {
            console.warn('Could not load project library path:', err);
        }

        // Set up click handler for project button
        if (projectBtn) {
            projectBtn.addEventListener('click', function() {
                if (availableConvertPaths.project && convertLibraryPathInput) {
                    convertLibraryPathInput.value = availableConvertPaths.project;
                    updateConvertLibrarySourceBadge('project');
                    refreshConvertLanguages();
                }
            });
        }

        // Update source badge when path changes manually
        if (convertLibraryPathInput) {
            convertLibraryPathInput.addEventListener('input', function() {
                updateConvertLibrarySourceBadge(detectConvertLibrarySource());
            });
        }
    }

    // Initial populate
    refreshConvertLanguages();

    // Auto-fill from project (async, doesn't block)
    initializeLibraryPathsFromProject();
});
</script>
{% endblock %}
