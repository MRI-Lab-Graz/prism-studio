{% extends "base.html" %}

{% block title %}Prism-Validator - Survey Export{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="fas fa-file-export text-primary me-2"></i>Survey Export</h2>
            <p class="text-muted">Select questionnaires from the library and export them to LimeSurvey (.lss).</p>
        </div>
    </div>

    <div class="card">
        <div class="card-header bg-light">
            <h5 class="mb-0">Survey Library</h5>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-8">
                    <label for="libraryPath" class="form-label">Library Path</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="libraryPath" placeholder="/path/to/survey_library" value="{{ default_survey_library_path | default('survey_library') }}">
                        <button class="btn btn-outline-secondary" type="button" id="browseBtn" title="Browse Folder">
                            <i class="fas fa-folder-open"></i>
                        </button>
                        <button class="btn btn-primary" type="button" id="loadLibraryBtn">
                            <i class="fas fa-sync-alt me-2"></i>Load Files
                        </button>
                    </div>
                    <div class="form-text">Folder containing Prism JSON sidecars (e.g., generated by excel_to_library.py).</div>
                </div>
            </div>

            <div id="libraryContent" class="d-none">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6>Available Questionnaires</h6>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary" id="selectAllBtn">Select All</button>
                        <button class="btn btn-sm btn-outline-secondary" id="deselectAllBtn">Deselect All</button>
                    </div>
                </div>
                
                <div class="table-responsive mb-4" style="max-height: 600px; overflow-y: auto;">
                    <table class="table table-hover border align-middle">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th style="width: 40px;"></th>
                                <th style="width: 40px;"></th>
                                <th>Filename</th>
                                <th>Original Name</th>
                                <th class="text-center">Matrix</th>
                                <th>Questions</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody id="fileListBody">
                            <!-- Files will be loaded here -->
                        </tbody>
                    </table>
                </div>

                <div class="d-flex justify-content-end">
                    <button class="btn btn-success btn-lg" id="generateLssBtn" disabled>
                        <i class="fas fa-file-export me-2"></i>Export to LimeSurvey (.lss)
                    </button>
                </div>
            </div>

            <div id="libraryEmpty" class="text-center py-5 d-none">
                <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                <p class="text-muted">No JSON files found in this directory.</p>
            </div>
            
            <div id="libraryError" class="alert alert-danger d-none mt-3"></div>
        </div>
    </div>

    <div class="card mt-4" id="landgig-convert">
        <div class="card-header bg-light">
            <h5 class="mb-0">Landgig (Part 4): Convert Excel to PRISM Dataset</h5>
        </div>
        <div class="card-body">
            <p class="text-muted">Upload a wide-format survey Excel file (.xlsx) and download a PRISM/BIDS-style survey dataset (ZIP).</p>

            <div class="row g-3 align-items-end">
                <div class="col-md-8">
                    <label for="convertLibraryPath" class="form-label">Survey Library Folder</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="convertLibraryPath" value="{{ default_survey_library_path | default('survey_library') }}">
                        <button class="btn btn-outline-secondary" type="button" id="convertBrowseLibraryBtn" title="Browse Folder">
                            <i class="fas fa-folder-open"></i>
                        </button>
                    </div>
                    <div class="form-text">Folder containing <code>survey-*.json</code> templates.</div>
                </div>
                <div class="col-md-4">
                    <label for="convertExcelFile" class="form-label">Excel File (.xlsx)</label>
                    <input class="form-control" type="file" id="convertExcelFile" accept=".xlsx">
                </div>
                <div class="col-md-4">
                    <label for="convertDatasetName" class="form-label">Dataset Name (optional)</label>
                    <input type="text" class="form-control" id="convertDatasetName" placeholder="PRISM Survey Dataset">
                </div>
                <div class="col-md-4">
                    <label for="convertUnknown" class="form-label">Unmapped Columns</label>
                    <select class="form-select" id="convertUnknown">
                        <option value="warn" selected>Warn</option>
                        <option value="ignore">Ignore</option>
                        <option value="error">Error</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-success w-100" type="button" id="convertBtn" disabled>
                        <i class="fas fa-wand-magic-sparkles me-2"></i>Convert & Download ZIP
                    </button>
                </div>
            </div>

            <div id="convertError" class="alert alert-danger d-none mt-3"></div>
            <div id="convertInfo" class="alert alert-info d-none mt-3"></div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Library & Export Logic ---
    const libraryPathInput = document.getElementById('libraryPath');
    const loadLibraryBtn = document.getElementById('loadLibraryBtn');
    const browseBtn = document.getElementById('browseBtn');
    const libraryContent = document.getElementById('libraryContent');
    const libraryEmpty = document.getElementById('libraryEmpty');
    const libraryError = document.getElementById('libraryError');
    const fileListBody = document.getElementById('fileListBody');
    const selectAllBtn = document.getElementById('selectAllBtn');
    const deselectAllBtn = document.getElementById('deselectAllBtn');
    const generateLssBtn = document.getElementById('generateLssBtn');

    // --- Landgig: Survey Convert ---
    const convertLibraryPathInput = document.getElementById('convertLibraryPath');
    const convertBrowseLibraryBtn = document.getElementById('convertBrowseLibraryBtn');
    const convertExcelFile = document.getElementById('convertExcelFile');
    const convertBtn = document.getElementById('convertBtn');
    const convertDatasetName = document.getElementById('convertDatasetName');
    const convertUnknown = document.getElementById('convertUnknown');
    const convertError = document.getElementById('convertError');
    const convertInfo = document.getElementById('convertInfo');

    loadLibraryBtn.addEventListener('click', function() {
        const path = libraryPathInput.value.trim();
        if (!path) return;

        // Reset UI
        libraryContent.classList.add('d-none');
        libraryEmpty.classList.add('d-none');
        libraryError.classList.add('d-none');
        fileListBody.innerHTML = '';
        generateLssBtn.disabled = true;

        fetch(`/api/list-library-files?path=${encodeURIComponent(path)}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    libraryError.textContent = data.error;
                    libraryError.classList.remove('d-none');
                    return;
                }

                if (data.files && data.files.length > 0) {
                    data.files.forEach((file, index) => {
                        const fileId = `file-${index}`;
                        const collapseId = `collapse-${index}`;
                        
                        // Main Row
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>
                                <input class="form-check-input file-checkbox" type="checkbox" value="${file.path}" data-target="${collapseId}">
                            </td>
                            <td>
                                <button class="btn btn-sm btn-link text-decoration-none p-0" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </td>
                            <td class="fw-bold">${file.filename}</td>
                            <td>${file.original_name || '-'}</td>
                            <td class="text-center">
                                <div class="form-check form-switch d-flex justify-content-center">
                                    <input class="form-check-input matrix-checkbox" type="checkbox" id="matrix-${index}" title="Group consecutive questions into a Matrix">
                                </div>
                            </td>
                            <td><span class="badge bg-secondary">${file.question_count || 0} items</span></td>
                            <td class="text-muted small">${file.description || '-'}</td>
                        `;
                        fileListBody.appendChild(tr);

                        // Details Row (Questions)
                        const trDetails = document.createElement('tr');
                        trDetails.className = 'collapse-row';
                        trDetails.innerHTML = `
                            <td colspan="7" class="p-0 border-0">
                                <div class="collapse bg-light p-3" id="${collapseId}">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div class="d-flex align-items-center">
                                            <small class="text-muted fw-bold me-3">Questions to include:</small>
                                        </div>
                                        <div>
                                            <button class="btn btn-xs btn-outline-secondary select-all-q" data-target="${collapseId}">All</button>
                                            <button class="btn btn-xs btn-outline-secondary deselect-all-q" data-target="${collapseId}">None</button>
                                        </div>
                                    </div>
                                    <ul class="list-unstyled mb-0">
                                        ${(file.questions || []).map(q => {
                                            let levelsHtml = '';
                                            if (q.levels) {
                                                levelsHtml = '<div class="small text-muted border-start ps-3 ms-3" style="min-width: 250px; max-width: 400px;">' + 
                                                    Object.entries(q.levels).map(([k, v]) => `<div><span class="fw-bold">${k}</span>: ${v}</div>`).join('') + 
                                                    '</div>';
                                            }
                                            
                                            let metaHtml = '';
                                            const metaParts = [];
                                            
                                            // Helper for badges
                                            const badge = (text, color='light', textCol='dark') => 
                                                `<span class="badge bg-${color} text-${textCol} border me-1 mb-1">${text}</span>`;

                                            if (q.units) metaParts.push(badge(`Units: ${q.units}`));
                                            if (q.type) metaParts.push(badge(`Type: ${q.type}`));
                                            
                                            // Range Group
                                            if ((q.min !== null && q.min !== undefined) || (q.max !== null && q.max !== undefined)) {
                                                let rangeText = 'Range: ';
                                                if (q.min !== null) rangeText += `[${q.min}`; else rangeText += '(-∞';
                                                rangeText += ', ';
                                                if (q.max !== null) rangeText += `${q.max}]`; else rangeText += '∞)';
                                                metaParts.push(badge(rangeText, 'info', 'dark'));
                                            }

                                            // Warning Range Group
                                            if ((q.warn_min !== null && q.warn_min !== undefined) || (q.warn_max !== null && q.warn_max !== undefined)) {
                                                let warnText = '⚠️ Normal: ';
                                                if (q.warn_min !== null) warnText += `${q.warn_min}`; else warnText += '?';
                                                warnText += ' - ';
                                                if (q.warn_max !== null) warnText += `${q.warn_max}`; else warnText += '?';
                                                metaParts.push(badge(warnText, 'warning', 'dark'));
                                            }
                                            
                                            if (metaParts.length > 0) {
                                                metaHtml = `<div class="mt-2 d-flex flex-wrap">${metaParts.join('')}</div>`;
                                            }

                                            return `
                                            <li class="mb-3 pb-2 border-bottom">
                                                <div class="form-check w-100">
                                                    <input class="form-check-input question-checkbox" type="checkbox" value="${q.id}" id="${fileId}-${q.id}" checked>
                                                    <label class="form-check-label w-100" for="${fileId}-${q.id}">
                                                        <div class="d-flex justify-content-between align-items-start">
                                                            <div class="me-3">
                                                                <div class="fw-bold">${q.id}</div>
                                                                <div class="text-muted small">${q.description || ''}</div>
                                                                ${metaHtml}
                                                            </div>
                                                            ${levelsHtml}
                                                        </div>
                                                    </label>
                                                </div>
                                            </li>
                                        `}).join('')}
                                    </ul>
                                </div>
                            </td>
                        `;
                        fileListBody.appendChild(trDetails);
                    });
                    libraryContent.classList.remove('d-none');
                } else {
                    libraryEmpty.classList.remove('d-none');
                }
            })
            .catch(err => {
                libraryError.textContent = 'Error loading files: ' + err;
                libraryError.classList.remove('d-none');
            });
    });

    // Browse Button
    browseBtn.addEventListener('click', function() {
        fetch('/api/browse-folder')
            .then(r => r.json())
            .then(data => {
                if(data.path) {
                    libraryPathInput.value = data.path;
                }
            });
    });

    convertBrowseLibraryBtn.addEventListener('click', function() {
        fetch('/api/browse-folder')
            .then(r => r.json())
            .then(data => {
                if (data.path) {
                    convertLibraryPathInput.value = data.path;
                }
            });
    });

    function updateConvertBtn() {
        const hasFile = convertExcelFile.files && convertExcelFile.files.length === 1;
        convertBtn.disabled = !hasFile;
    }

    convertExcelFile.addEventListener('change', updateConvertBtn);
    updateConvertBtn();

    convertBtn.addEventListener('click', function() {
        convertError.classList.add('d-none');
        convertInfo.classList.add('d-none');
        convertError.textContent = '';
        convertInfo.textContent = '';

        const file = convertExcelFile.files && convertExcelFile.files[0];
        if (!file) {
            return;
        }

        const formData = new FormData();
        formData.append('excel', file);
        formData.append('library_path', convertLibraryPathInput.value.trim());
        formData.append('dataset_name', convertDatasetName.value.trim());
        formData.append('unknown', convertUnknown.value);

        convertBtn.disabled = true;
        convertInfo.textContent = 'Converting... this may take a moment.';
        convertInfo.classList.remove('d-none');

        fetch('/api/survey-convert', {
            method: 'POST',
            body: formData,
        })
        .then(async response => {
            if (response.ok) {
                return response.blob();
            }
            const data = await response.json().catch(() => null);
            const msg = data && data.error ? data.error : 'Conversion failed';
            throw new Error(msg);
        })
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'prism_survey_dataset.zip';
            document.body.appendChild(a);
            a.click();
            a.remove();

            convertInfo.textContent = 'Done. Your ZIP download should start automatically.';
            convertInfo.classList.remove('d-none');
        })
        .catch(err => {
            convertError.textContent = err.message;
            convertError.classList.remove('d-none');
        })
        .finally(() => {
            updateConvertBtn();
        });
    });

    // Select/Deselect All Files
    selectAllBtn.addEventListener('click', () => {
        document.querySelectorAll('.file-checkbox').forEach(cb => cb.checked = true);
        updateGenerateBtn();
    });
    deselectAllBtn.addEventListener('click', () => {
        document.querySelectorAll('.file-checkbox').forEach(cb => cb.checked = false);
        updateGenerateBtn();
    });

    // Select/Deselect All Questions (within a file)
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('select-all-q')) {
            const targetId = e.target.dataset.target;
            document.querySelector(`#${targetId}`).querySelectorAll('.question-checkbox').forEach(cb => cb.checked = true);
        }
        if (e.target.classList.contains('deselect-all-q')) {
            const targetId = e.target.dataset.target;
            document.querySelector(`#${targetId}`).querySelectorAll('.question-checkbox').forEach(cb => cb.checked = false);
        }
    });

    // Enable/Disable Generate Button
    fileListBody.addEventListener('change', updateGenerateBtn);

    function updateGenerateBtn() {
        const anyChecked = document.querySelectorAll('.file-checkbox:checked').length > 0;
        generateLssBtn.disabled = !anyChecked;
    }

    // Generate LSS
    generateLssBtn.addEventListener('click', function() {
        const selectedFiles = [];
        document.querySelectorAll('.file-checkbox:checked').forEach(cb => {
            const collapseId = cb.dataset.target;
            const collapseDiv = document.getElementById(collapseId);
            const questionCheckboxes = collapseDiv.querySelectorAll('.question-checkbox:checked');
            
            // Find matrix checkbox in the main row (parent tr of the file checkbox)
            const mainRow = cb.closest('tr');
            const matrixCheckbox = mainRow.querySelector('.matrix-checkbox');
            const isMatrix = matrixCheckbox ? matrixCheckbox.checked : false;
            
            // If no questions selected for this file, skip it? Or include all?
            // Let's assume we only include selected questions.
            const selectedQuestions = Array.from(questionCheckboxes).map(qcb => qcb.value);
            
            if (selectedQuestions.length > 0) {
                selectedFiles.push({
                    path: cb.value,
                    include: selectedQuestions,
                    matrix: isMatrix
                });
            }
        });

        if (selectedFiles.length === 0) {
            alert("Please select at least one file and one question.");
            return;
        }

        // Send to backend
        fetch('/api/generate-lss', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ files: selectedFiles }),
        })
        .then(response => {
            if (response.ok) {
                return response.blob();
            }
            throw new Error('Export failed');
        })
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "survey_export.lss";
            document.body.appendChild(a);
            a.click();
            a.remove();
        })
        .catch(err => {
            alert(err.message);
        });
    });
});
</script>
{% endblock %}
